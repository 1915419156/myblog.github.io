I"jø<blockquote>
  <p>2019-7-21 16:46:53</p>

</blockquote>

<h1 id="stl-æºç å‰–æ-ä¾¯æ·">STL æºç å‰–æ â€“ä¾¯æ·</h1>

<h2 id="stlæ¦‚è®ºä¸ç‰ˆæœ¬ç®€ä»‹">STLæ¦‚è®ºä¸ç‰ˆæœ¬ç®€ä»‹</h2>

<p>STLå…­å¤§ç»„ä»¶</p>

<ul>
  <li>å®¹å™¨(containers):vector.list.deque,set,mapç­‰æ•°æ®å­˜æ”¾çš„ç±»ã€‚</li>
  <li>ç®—æ³•(algorithms):å„ç§æ’åºç®—æ³•;sortã€searchã€copyã€erase..ç­‰</li>
  <li>è¿­ä»£å™¨(iterators)ï¼šæ‰®æ¼”å®¹å™¨ä¸ç®—æ³•ä¹‹é—´çš„èƒ¶åˆå‰‚ï¼Œå³æ³›å‹æŒ‡é’ˆ</li>
  <li>åŠŸèƒ½å‡½æ•°(functors)ï¼šè¡Œä¸ºç±»ä¼¼å‡½æ•°ï¼Œå¯ä»¥è§†ä¸ºç®—æ³•çš„æŸç§ç­–ç•¥</li>
  <li>é…æ¥å™¨(adapters)ï¼šä¸€ç§ç”¨æ¥ä¿®é¥°å®¹å™¨(containers)æˆ–ä»¿å‡½æ•°(functors)æˆ–è¿­ä»£å™¨(iterators)å€Ÿå£çš„ä¸œè¥¿</li>
  <li>é…ç½®å™¨(allocators):è´Ÿè´£ç©ºé—´é…ç½®ä¸ç®¡ç†</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-21-17-10-18.png" alt="STLå…­å¤§ç»„ä»¶ä¹‹é—´çš„å…³ç³»" /></p>

<h2 id="ç¬¬äºŒç« -ç©ºé—´é…ç½®å™¨">ç¬¬äºŒç«  ç©ºé—´é…ç½®å™¨</h2>

<p>allocatoræ˜¯ç©ºé—´é…ç½®å™¨ï¼Œå®šä¹‰äºå¤´æ–‡ä»¶<memory> std::allocatorç±»æ¨¡æ¿æ˜¯æ‰€æœ‰æ ‡å‡†åº“å®¹å™¨æ‰€ç”¨çš„é»˜è®¤åˆ†é…å™¨ (Allocator)ï¼Œè‹¥ä¸æä¾›ç”¨æˆ·æŒ‡å®šçš„åˆ†é…å™¨ã€‚é»˜è®¤åˆ†é…å™¨æ— çŠ¶æ€ï¼Œå³ä»»ä½•ç»™å®šçš„ allocatorå®ä¾‹å¯äº¤æ¢ã€æ¯”è¾ƒç›¸ç­‰ï¼Œä¸”èƒ½è§£åˆ†é…åŒä¸€`allocator`ç±»å‹çš„ä»»ä½•å…¶ä»–å®ä¾‹æ‰€åˆ†é…çš„å†…å­˜ã€‚</memory></p>

<p>æˆå‘˜ç±»å‹</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ç±»å‹</th>
      <th style="text-align: left">å®šä¹‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">value_type</td>
      <td style="text-align: left">T</td>
    </tr>
    <tr>
      <td style="text-align: left">pointer (C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">T*</td>
    </tr>
    <tr>
      <td style="text-align: left">const_pointer (C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">const T*</td>
    </tr>
    <tr>
      <td style="text-align: left">reference (C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">T&amp;</td>
    </tr>
    <tr>
      <td style="text-align: left">const_reference (C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">const T&amp;</td>
    </tr>
    <tr>
      <td style="text-align: left">size_type</td>
      <td style="text-align: left">std::size_t</td>
    </tr>
    <tr>
      <td style="text-align: left">difference_type</td>
      <td style="text-align: left">std::ptrdiff_t</td>
    </tr>
    <tr>
      <td style="text-align: left">propagate_on_container_move_assignment(C++14)</td>
      <td style="text-align: left">std::true_type</td>
    </tr>
    <tr>
      <td style="text-align: left">rebind (C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">template&lt; class U &gt; struct rebind { typedef allocator<u> other; };</u></td>
    </tr>
    <tr>
      <td style="text-align: left">is_always_equal(C++17)</td>
      <td style="text-align: left">std::true_type</td>
    </tr>
  </tbody>
</table>

<p>æˆå‘˜å‡½æ•°</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å‡½æ•°</th>
      <th style="text-align: left">å®šä¹‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">(æ„é€ å‡½æ•°)</td>
      <td style="text-align: left">åˆ›å»ºæ–°çš„ allocator å®ä¾‹(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">(ææ„å‡½æ•°)</td>
      <td style="text-align: left">ææ„ allocator å®ä¾‹(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">address(C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">è·å¾—å¯¹è±¡çš„åœ°å€ï¼Œå³ä½¿é‡è½½äº† operator&amp;(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">allocate</td>
      <td style="text-align: left">åˆ†é…æœªåˆå§‹åŒ–çš„å­˜å‚¨(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">deallocate</td>
      <td style="text-align: left">è§£åˆ†é…å­˜å‚¨(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">max_size(C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">è¿”å›æœ€å¤§çš„å—æ”¯æŒåˆ†é…å¤§å°(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">construct(C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)</td>
      <td style="text-align: left">åœ¨åˆ†é…çš„å­˜å‚¨æ„é€ å¯¹è±¡(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
    <tr>
      <td style="text-align: left">destroy</td>
      <td style="text-align: left">(C++17 ä¸­å¼ƒç”¨)(C++20 ä¸­ç§»é™¤)ææ„åœ¨å·²åˆ†é…å­˜å‚¨ä¸­çš„å¯¹è±¡(å…¬å¼€æˆå‘˜å‡½æ•°)</td>
    </tr>
  </tbody>
</table>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">std::allocator</code>çš„ç®€å•å®ç°
æ³¨æ„è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">size_t</code>ä¸æ“ä½œç³»ç»Ÿç›¸å…³ï¼Œ32ä½æ˜¯4å­—èŠ‚ï¼Œ64ä½æ—¶8å­—èŠ‚ï¼›<code class="language-plaintext highlighter-rouge">ptrdiff_t</code>æ˜¯ä¸¤ä¸ªæŒ‡é’ˆç›¸å‡çš„ç»“æœç±»å‹ï¼Œæ˜¯ä¸€ç§æœ‰ç¬¦å·æ•´æ•°ç±»å‹ã€‚å‡æ³•è¿ç®—çš„å€¼ä¸ºä¸¤ä¸ªæŒ‡é’ˆåœ¨å†…å­˜ä¸­çš„è·ç¦»ã€‚ptrdiff_tæ˜¯signedç±»å‹ï¼Œç”¨äºå­˜æ”¾åŒä¸€æ•°ç»„ä¸­ä¸¤ä¸ªæŒ‡é’ˆä¹‹é—´çš„å·®è·ï¼Œå®ƒå¯ä»¥ä½¿è´Ÿæ•°ï¼Œstd::ptrdiff_t.åŒä¸Šï¼Œä½¿ç”¨ptrdiff_tæ¥å¾—åˆ°ç‹¬ç«‹äºå¹³å°çš„åœ°å€å·®å€¼.</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;new.h&gt;
#include &lt;stddef.h&gt;
#include &lt;limits.h&gt;
#include &lt;iostream.h&gt;
#include &lt;algobase.h&gt;
</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="n">T</span><span class="o">*</span> <span class="nf">allocate</span><span class="p">(</span><span class="kt">ptrdiff_t</span> <span class="n">size</span><span class="p">,</span><span class="n">T</span><span class="o">*</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è®¾ç½®æ–°å¥æŸ„</span>

    <span class="n">set_new_handler</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">tmp</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="p">)(</span><span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">size</span><span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">))));</span>
    <span class="k">if</span><span class="p">(</span><span class="n">tmp</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">cerr</span><span class="o">&lt;&lt;</span><span class="s">"out of memory"</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="nf">void_deallocate</span><span class="p">(</span><span class="n">T</span><span class="o">*</span> <span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T1</span><span class="p">,</span><span class="k">class</span> <span class="nc">T2</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_construct</span><span class="p">(</span><span class="n">T1</span><span class="o">*</span> <span class="n">p</span><span class="p">,</span><span class="k">const</span> <span class="n">T2</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">new</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="n">T1</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_destroy</span><span class="p">(</span><span class="n">T</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">T</span><span class="p">();</span>
<span class="p">}</span>


<span class="c1">//allocatorç±»çš„åŸºæœ¬å®ç°</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">allocator</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">T</span>  <span class="n">value_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="k">const</span> <span class="n">T</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span><span class="o">&amp;</span>      <span class="n">reference</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">size_t</span> <span class="n">size_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">ptrdiff_t</span> <span class="n">size_type</span><span class="p">;</span>
    <span class="c1">//è¿æ¥ allocatorå’ŒU</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">U</span><span class="p">&gt;</span>
    <span class="k">struct</span> <span class="nc">rebind</span>
    <span class="p">{</span>
        <span class="k">typedef</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1">//è·å–å·¦å€¼æŒ‡é’ˆ</span>

    <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">,</span><span class="k">const</span> <span class="kt">void</span><span class="o">*</span> <span class="n">hint</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–ä¸º0</span>

        <span class="k">return</span> <span class="n">_allocate</span><span class="p">((</span><span class="n">difference_type</span><span class="p">)</span><span class="n">n</span><span class="p">,(</span><span class="n">pointer</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">p</span><span class="p">,</span><span class="n">size_type</span> <span class="n">n</span><span class="p">){</span><span class="n">_deallocate</span><span class="p">(</span><span class="n">p</span><span class="p">);}</span>

    <span class="kt">void</span> <span class="n">address</span><span class="p">(</span><span class="n">reference</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="n">pointer</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;}</span>

    <span class="n">const_pointer</span> <span class="n">const_address</span><span class="p">(</span><span class="n">const_reference</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">const_pointer</span><span class="p">)</span><span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">size_type</span> <span class="n">max_size</span><span class="p">()</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">size_type</span><span class="p">(</span><span class="n">UINT_MAX</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
    <span class="p">}</span>


<span class="p">};</span>
</code></pre></div></div>
<p>ä¸Šé¢åªæ˜¯ç®€å•çš„allocatorå®ç°ï¼ŒçœŸå®æƒ…å†µæ¯”è¿™ä¸ªè¦å¤æ‚çš„å¤šã€‚
SGIæ ‡å‡†çš„ç©ºé—´é…ç½®å™¨ï¼Œæ˜¯å¯¹::operator newå’Œ::operator deleteåšäº†ä¸€å±‚è–„è–„çš„å°è£…ã€‚</p>

<p>STL allocatorå°†ä¸¤é˜¶æ®µæ“ä½œåŒºåˆ†å¼€æ¥ã€‚å†…å­˜é…ç½®æ“ä½œç”±alloc:allocate()è´Ÿè´£ï¼›å†…å­˜é‡Šæ”¾æ“ä½œç”±alloc::deallocate()è´Ÿè´£ï¼›å¯¹è±¡æ„é€ æ“ä½œç”±::construct()è´Ÿè´£ï¼Œå¯¹è±¡ææ„æ“ä½œç”±::destroy()è´Ÿè´£ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-13-49-35.png" alt="åˆä½œå…³ç³»å›¾" /></p>

<h4 id="223-æ„é€ å’Œææ„åŸºæœ¬å·¥å…·-constructå’Œdestory">2.2.3 æ„é€ å’Œææ„åŸºæœ¬å·¥å…·ï¼š <code class="language-plaintext highlighter-rouge">construct()</code>å’Œ<code class="language-plaintext highlighter-rouge">destory()</code></h4>

<p>ä¸‹é¢æ˜¯c++1ä¸­ stl_construct.hçš„éƒ¨åˆ†å†…å®¹</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#ifndef _STL_CONSTRUCT_H
#define _STL_CONSTRUCT_H 1
</span>
<span class="cp">#include &lt;new&gt;
#include &lt;bits/move.h&gt;
#include &lt;ext/alloc_traits.h&gt;
</span>
<span class="k">namespace</span> <span class="n">std</span> <span class="nf">_GLIBCXX_VISIBILITY</span><span class="p">(</span><span class="k">default</span><span class="p">)</span>
<span class="p">{</span>
<span class="n">_GLIBCXX_BEGIN_NAMESPACE_VERSION</span>

  <span class="cm">/**
   * Constructs an object in existing memory by invoking an allocated
   * object's constructor with an initializer.
   */</span>
<span class="c1">//c++11 æ–°æ·»åŠ Constructå‡½æ•° </span>

<span class="cp">#if __cplusplus &gt;= 201103L
</span>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_T1</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span> <span class="nc">_Args</span><span class="p">&gt;</span>
    <span class="kr">inline</span> <span class="kt">void</span>
    <span class="n">_Construct</span><span class="p">(</span><span class="n">_T1</span><span class="o">*</span> <span class="n">__p</span><span class="p">,</span> <span class="n">_Args</span><span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">__args</span><span class="p">)</span>
    <span class="p">{</span> <span class="o">::</span><span class="k">new</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">__p</span><span class="p">))</span> <span class="n">_T1</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">_Args</span><span class="o">&gt;</span><span class="p">(</span><span class="n">__args</span><span class="p">)...);</span> <span class="p">}</span>
<span class="cp">#else
</span>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_T1</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">_T2</span><span class="p">&gt;</span>
    <span class="kr">inline</span> <span class="kt">void</span>
    <span class="n">_Construct</span><span class="p">(</span><span class="n">_T1</span><span class="o">*</span> <span class="n">__p</span><span class="p">,</span> <span class="k">const</span> <span class="n">_T2</span><span class="o">&amp;</span> <span class="n">__value</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// _GLIBCXX_RESOLVE_LIB_DEFECTS</span>
      <span class="c1">// 402. wrong new expression in [some_]allocator::construct</span>
      <span class="o">::</span><span class="k">new</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">__p</span><span class="p">))</span> <span class="n">_T1</span><span class="p">(</span><span class="n">__value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif
</span>
  <span class="cm">/**
   * Destroy the object pointed to by a pointer type.
   */</span>
    <span class="c1">//æ¥å—æŒ‡é’ˆï¼Œå¹¶ç›´æ¥è°ƒç”¨æŒ‡é’ˆç±»çš„ææ„å‡½æ•°</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_Tp</span><span class="p">&gt;</span>
    <span class="kr">inline</span> <span class="kt">void</span>
    <span class="n">_Destroy</span><span class="p">(</span><span class="n">_Tp</span><span class="o">*</span> <span class="n">__pointer</span><span class="p">)</span>
    <span class="p">{</span> <span class="n">__pointer</span><span class="o">-&gt;~</span><span class="n">_Tp</span><span class="p">();</span> <span class="p">}</span>
<span class="c1">//æ¨¡æ¿å‡½æ•°</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">&gt;</span>
    <span class="k">struct</span> <span class="nc">_Destroy_aux</span>
    <span class="p">{</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_ForwardIterator</span><span class="p">&gt;</span>
        <span class="k">static</span> <span class="kt">void</span>
        <span class="n">__destroy</span><span class="p">(</span><span class="n">_ForwardIterator</span> <span class="n">__first</span><span class="p">,</span> <span class="n">_ForwardIterator</span> <span class="n">__last</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="n">__first</span> <span class="o">!=</span> <span class="n">__last</span><span class="p">;</span> <span class="o">++</span><span class="n">__first</span><span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">_Destroy</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">__addressof</span><span class="p">(</span><span class="o">*</span><span class="n">__first</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="p">};</span>
<span class="c1">//ç‰¹ä¾‹åŒ–å‡½æ•°åˆ¤æ–­å¯¹è±¡æ˜¯å¦å«æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¦‚æœæ˜¯åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œè¿™æ ·å¯ä»¥æé«˜æ•ˆç‡</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="p">&gt;</span>
    <span class="k">struct</span> <span class="nc">_Destroy_aux</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span>
    <span class="p">{</span>
      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_ForwardIterator</span><span class="p">&gt;</span>
        <span class="k">static</span> <span class="kt">void</span>
        <span class="n">__destroy</span><span class="p">(</span><span class="n">_ForwardIterator</span><span class="p">,</span> <span class="n">_ForwardIterator</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
    <span class="p">};</span>

  <span class="cm">/**
   * Destroy a range of objects.  If the value_type of the object has
   * a trivial destructor, the compiler should optimize all of this
   * away, otherwise the objects' destructors must be invoked.
   */</span>

    <span class="c1">//é”€æ¯ä¸€ç³»åˆ—å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡çš„value_typeæ˜¯ä¸€ä¸ªé»˜è®¤çš„ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨åº”è¯¥ä¼˜åŒ–æ‰€æœ‰è¿™äº›ï¼Œå¦åˆ™å¿…é¡»è°ƒç”¨å¯¹è±¡çš„ææ„å‡½æ•°ã€‚</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_ForwardIterator</span><span class="p">&gt;</span>
    <span class="kr">inline</span> <span class="kt">void</span>
    <span class="n">_Destroy</span><span class="p">(</span><span class="n">_ForwardIterator</span> <span class="n">__first</span><span class="p">,</span> <span class="n">_ForwardIterator</span> <span class="n">__last</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//è¿­ä»£å™¨åˆ«å</span>

      <span class="k">typedef</span> <span class="k">typename</span> <span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">_ForwardIterator</span><span class="o">&gt;::</span><span class="n">value_type</span>
                       <span class="n">_Value_type</span><span class="p">;</span>

      <span class="n">std</span><span class="o">::</span><span class="n">_Destroy_aux</span><span class="o">&lt;</span><span class="n">__has_trivial_destructor</span><span class="p">(</span><span class="n">_Value_type</span><span class="p">)</span><span class="o">&gt;::</span>
    <span class="n">__destroy</span><span class="p">(</span><span class="n">__first</span><span class="p">,</span> <span class="n">__last</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="cm">/**
   * Destroy a range of objects using the supplied allocator.  For
   * nondefault allocators we do not optimize away invocation of 
   * destroy() even if _Tp has a trivial destructor.
   */</span>
    <span class="c1">//ä½¿ç”¨æ”¯æŒçš„allocatoré”€æ¯ä¸€ç³»åˆ—å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰éé»˜è®¤çš„allocatorsä¸ä¼šè¿›è¡Œé”€æ¯å‡½æ•°çš„åˆå§‹åŒ–ï¼Œå³ä¾¿ï¼Œå¯¹è±¡å«æœ‰é»˜è®¤æ„é€ å‡½æ•°</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_ForwardIterator</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">_Allocator</span><span class="p">&gt;</span>
    <span class="kt">void</span>
    <span class="n">_Destroy</span><span class="p">(</span><span class="n">_ForwardIterator</span> <span class="n">__first</span><span class="p">,</span> <span class="n">_ForwardIterator</span> <span class="n">__last</span><span class="p">,</span>
         <span class="n">_Allocator</span><span class="o">&amp;</span> <span class="n">__alloc</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">typedef</span> <span class="n">__gnu_cxx</span><span class="o">::</span><span class="n">__alloc_traits</span><span class="o">&lt;</span><span class="n">_Allocator</span><span class="o">&gt;</span> <span class="n">__traits</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="n">__first</span> <span class="o">!=</span> <span class="n">__last</span><span class="p">;</span> <span class="o">++</span><span class="n">__first</span><span class="p">)</span>
    <span class="n">__traits</span><span class="o">::</span><span class="n">destroy</span><span class="p">(</span><span class="n">__alloc</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">__addressof</span><span class="p">(</span><span class="o">*</span><span class="n">__first</span><span class="p">));</span>
    <span class="p">}</span>

  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">_ForwardIterator</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">_Tp</span><span class="p">&gt;</span>
    <span class="kr">inline</span> <span class="kt">void</span>
    <span class="n">_Destroy</span><span class="p">(</span><span class="n">_ForwardIterator</span> <span class="n">__first</span><span class="p">,</span> <span class="n">_ForwardIterator</span> <span class="n">__last</span><span class="p">,</span>
         <span class="n">allocator</span><span class="o">&lt;</span><span class="n">_Tp</span><span class="o">&gt;&amp;</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">_Destroy</span><span class="p">(</span><span class="n">__first</span><span class="p">,</span> <span class="n">__last</span><span class="p">);</span>
    <span class="p">}</span>

<span class="n">_GLIBCXX_END_NAMESPACE_VERSION</span>
<span class="p">}</span> <span class="c1">// namespace std</span>
<span class="cp">#endif
</span>
</code></pre></div></div>

<p>ä¸Šè¿°ä»£ç ä¸­<code class="language-plaintext highlighter-rouge">_Destroy_aux</code>ä¸»è¦æ˜¯ç”¨æ¥æ£€æµ‹ï¼Œå¯¹è±¡æ˜¯å¦æœ‰è‡ªå®šä¹‰çš„ææ„å‡½æ•°ï¼Œå¦‚æœæœ‰å°±è¿›è¡Œè¿­ä»£è°ƒç”¨ã€‚å¦‚æœæ²¡æœ‰(ä½¿ç”¨é»˜è®¤ææ„å‡½æ•°)ç›´æ¥è·³è¿‡ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-14-45-38.png" alt="constructå’Œdestoryç¤ºæ„" /></p>

<h4 id="224-ç©ºé—´çš„é…ç½®ä¸é‡Šæ”¾stdalloc">2.2.4 ç©ºé—´çš„é…ç½®ä¸é‡Šæ”¾ï¼Œstd::alloc</h4>

<p>æ„é€ ç©ºé—´çš„é…ç½®ä¸é‡Šæ”¾ï¼Œç”±<stl_alloc.h>è´Ÿè´£ï¼›è®¾è®¡æ€è·¯å¦‚ä¸‹ï¼š</stl_alloc.h></p>

<ul>
  <li>å‘<code class="language-plaintext highlighter-rouge">system heap</code> è¯·æ±‚ç©ºé—´</li>
  <li>è€ƒè™‘å¤šçº¿ç¨‹çŠ¶æ€</li>
  <li>è€ƒè™‘å†…å­˜ä¸è¶³æ—¶çš„åº”å˜æªæ–½</li>
  <li>è€ƒè™‘è¿‡å¤šâ€œå°è¡ŒåŒºå—â€å¯èƒ½é€ æˆçš„å†…å­˜ç¢ç‰‡(fragment)é—®é¢˜ã€‚</li>
</ul>

<p>è€ƒè™‘åˆ°å°å‹åŒºå—å¯èƒ½é€ æˆçš„å†…å­˜ç ´ç¢é—®é¢˜ï¼ŒSGIè®¾è®¡äº†åŒå±‚çº§é…ç½®å™¨,ç¬¬ä¸€çº§é…ç½®å™¨ç›´æ¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">malloc()</code>å’Œ<code class="language-plaintext highlighter-rouge">free()</code>ï¼›ç¬¬äºŒçº§é…ç½®å™¨åˆ™è§†æƒ…å†µé‡‡ç”¨ä¸åŒçš„ç­–ç•¥ã€‚å½“é…ç½®åŒºå—è¶…è¿‡128byteæ—¶ï¼Œè§†ä¹‹ä¸ºè¶³å¤Ÿå¤§ï¼Œä½¿ç”¨ç¬¬ä¸€çº§é…ç½®å™¨ï¼Œå½“å°äº128byteæ—¶ï¼Œè§†ä¹‹ä¸ºè¿‡å°ï¼Œé‡‡ç”¨å¤æ‚çš„memory poolæ•´ç†æ–¹å¼ã€‚è€Œä¸å†æ±‚åŠ©äºç¬¬ä¸€çº§é€‚é…å™¨ã€‚ä½¿ç”¨å“ªä¸€çº§é€‚é…å™¨å–å†³äº<code class="language-plaintext highlighter-rouge">__USE_MALLOC</code>æ˜¯å¦è¢«å®šä¹‰ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-15-07-37.png" alt="ç¬¬ä¸€ä¸ç¬¬äºŒçº§é€‚é…å™¨" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-15-10-16.png" alt="åŒ…è£…é“¾æ¥" /></p>

<h4 id="225-ä¸€çº§é€‚é…å™¨__malloc_alloc_templateå‰–æ">2.2.5 ä¸€çº§é€‚é…å™¨__malloc_alloc_templateå‰–æ</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä¸€çº§é€‚é…å™¨</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">inst</span><span class="p">&gt;</span>

<span class="k">class</span> <span class="nc">__malloc_alloc_template</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">//å‡½æ•°æŒ‡é’ˆï¼Œæ‰€ä»£è¡¨çš„å‡½æ•°å°†ç”¨æ¥å¤„ç†å†…å­˜ä¸è¶³çš„æƒ…å†µ</span>
    <span class="c1">//oom: out of memory</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">oom_malloc</span><span class="p">(</span><span class="kt">size_t</span><span class="p">);</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">oom_realloc</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">size_t</span><span class="p">);</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">)();</span>

<span class="nl">public:</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ä¸€çº§é…ç½®å™¨å¿…é¡»ä½¿ç”¨malloc()</span>

        <span class="kt">void</span> <span class="o">*</span><span class="n">result</span><span class="o">=</span><span class="n">malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
        <span class="c1">//å½“æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œæ”¹ç”¨oom_malloc()</span>

        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">result</span><span class="p">)</span> <span class="n">result</span><span class="o">=</span><span class="n">oom_malloc</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">size_t</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ç¬¬ä¸€çº§é…ç½®å™¨ç›´æ¥ä½¿ç”¨free()</span>

        <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//è¾“å…¥æ—§sizeå’Œæ–°size</span>

    <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">reallocate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">size_t</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">new_sz</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">void</span><span class="o">*</span> <span class="n">result</span><span class="o">=</span><span class="n">realloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">new_sz</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">result</span><span class="p">)</span> <span class="n">result</span><span class="o">=</span><span class="n">oom_realloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">new_sz</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span> 
    <span class="p">}</span>
    <span class="c1">//æŒ‡å®šè‡ªå·±çš„out-of-memory handler</span>
    
    <span class="k">static</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">set_malloc_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)()))()</span>
    <span class="p">{</span>
        <span class="c1">//è·å–å‡½æ•°æŒ‡é’ˆ</span>

        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span> <span class="n">old</span><span class="p">)()</span><span class="o">=</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span>
        <span class="n">__malloc_alloc_oom_handler</span><span class="o">=</span><span class="n">f</span><span class="p">;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">old</span><span class="p">);</span> 
    <span class="p">}</span>


<span class="p">};</span>
<span class="c1">//ä¸‹é¢æ˜¯ç”¨æˆ·æä¾›çš„malloc_allocå‡½æ•°</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">inst</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">)()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">inst</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">oom_malloc</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è·å–å†…å­˜åˆ†é…å¥æŸ„å‡½æ•°æŒ‡é’ˆ</span>

    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="c1">//æŒ‡é’ˆæŒ‡å‘åˆ†é…å‡½æ•°</span>

        <span class="n">my_malloc_handler</span><span class="o">=</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span>
        <span class="c1">//åˆ†é…å¤±è´¥æŠ›å‡ºå¼‚å¸¸</span>

        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">my_malloc_handler</span><span class="p">){</span><span class="n">__THROW_BAD_ALLOC</span><span class="p">;}</span>
        <span class="c1">//è°ƒç”¨å¤„ç†ä¾‹ç¨‹ï¼Œä¼å›¾é‡Šæ”¾å†…å­˜</span>

        <span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span>
        <span class="c1">//å†æ¬¡å°è¯•åˆ†é…å†…å­˜</span>

        <span class="n">result</span><span class="o">=</span><span class="n">malloc</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//å†…å­˜è°ƒç”¨åˆ†é…ä¸æˆåŠŸæ—¶ï¼Œè¿›è¡ŒäºŒæ¬¡è°ƒç”¨</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">inst</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="o">*</span> <span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="n">inst</span><span class="o">&gt;::</span><span class="n">oom_realloc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(;;)</span>
    <span class="p">{</span>
        <span class="n">my_malloc_handler</span><span class="o">=</span><span class="n">__malloc_alloc_oom_handler</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="n">my_malloc_handler</span><span class="p">){</span><span class="n">__THROW_BAD_ALLOC</span><span class="p">;}</span>
        <span class="c1">//å°è¯•è°ƒç”¨å¤„ç†ä¾‹ç¨‹</span>

        <span class="p">(</span><span class="o">*</span><span class="n">my_malloc_handler</span><span class="p">)();</span>
        <span class="c1">//å°è¯•åˆ†é…å†…å­˜</span>

        <span class="n">result</span><span class="o">=</span><span class="n">realloc</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//æ³¨æ„,ä»¥ä¸‹å‚æ•°ç›´æ¥å°†instæŒ‡å®šä¸º0</span>

<span class="k">typedef</span> <span class="n">__malloc_alloc_template</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">malloc_alloc</span><span class="p">;</span>

</code></pre></div></div>

<h4 id="226-ç¬¬äºŒçº§é€‚é…å™¨-__default_alloc_template-å‰–æ">2.2.6 ç¬¬äºŒçº§é€‚é…å™¨ __default_alloc_template å‰–æ</h4>

<p>å› ä¸ºå¯¹äºæ“ä½œç³»ç»Ÿè€Œè¨€ï¼Œéœ€è¦å—åˆ†é…ä¸€å®šçš„å†…å­˜æ¥å­˜å‚¨å—çš„ä½ç½®ä¿¡æ¯ï¼Œå› æ­¤å½“å†…å­˜è¿‡å°æ—¶ï¼Œå•ç‹¬å¼€è¾Ÿå—åè€Œæ˜¯å¾—ä¸å¿å¤±çš„ã€‚å› æ­¤åœ¨æ­¤æ—¶ï¼ŒC++ä½¿ç”¨å†…å­˜æ± æœºåˆ¶æ¥å¯¹æ•°æ®è¿›è¡Œç®¡ç†ã€‚ç”±é…ç½®å™¨è´Ÿè´£å†…å­˜çš„ç®¡ç†å’Œå›æ”¶ï¼Œé€šå¸¸SGIé…ç½®å…¶ä¼šå°†å°é¢åŒºå—çš„å†…å­˜éœ€æ±‚é‡ä¸Šè°ƒè‡³8çš„å€æ•°(ä¾‹å¦‚30B-32B),å¹¶å”¯ç‹¬16ä¸ªfree-list,å„è‡ªç®¡ç†å¤§å°åˆ†åˆ«ä¸º8,16,24,3ï¼Œ,40,48,56,64â€¦128 bytesçš„å°é¢åŒºå—ã€‚ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">union</span> <span class="n">obj</span><span class="p">{</span>
    <span class="k">union</span> <span class="n">obj</span><span class="o">*</span> <span class="n">free_list_link</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">client_data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å› ä¸ºä½¿ç”¨äº†unionå› æ­¤ç¬¬ä¸€ä¸ªæŒ‡é’ˆç›´æ¥æŒ‡å‘äº†å†…å­˜åœ°å€(<a href="https://www.cnblogs.com/jeakeven/p/5113508.html">c++ â€“&gt; unionä»‹ç»</a>)ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-16-47-51.png" alt="" /></p>

<h3 id="227-ç©ºé—´é…ç½®å‡½æ•°allocate">2.2.7 ç©ºé—´é…ç½®å‡½æ•°allocate()</h3>

<p>__default_alloc_templateæ‹¥æœ‰é…ç½®å™¨çš„æ ‡å‡†æ¥å£å‡½æ•°allocate()ã€‚æ­¤å‡½æ•°é¦–å…ˆåˆ¤æ–­åŒºå—å¤§å°ï¼Œå¤§äº128byteså°±è°ƒç”¨ç¬¬ä¸€çº§é…ç½®å™¨ï¼Œå°äº128byteså°±æ£€æŸ¥å¯¹åº”çš„free listã€‚å¦‚æœæœ‰å¯ç”¨åŒºå—å°±ç›´æ¥æ‹¿æ¥ç”¨ï¼Œæ²¡æœ‰å°±å°†åŒºå—çš„å¤§å°ä¸Šè°ƒè‡³8å€æ•°è¾¹ç•Œï¼Œç„¶åè°ƒç”¨<code class="language-plaintext highlighter-rouge">refill()</code>å‡†å¤‡ä¸º<code class="language-plaintext highlighter-rouge">free list</code>é‡æ–°å¡«å……ç©ºé—´ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-16-58-32.png" alt="free listè°ƒåº¦" /></p>

<h4 id="228-ç©ºé—´é‡Šæ”¾å‡½æ•°-deallocate">2.2.8 ç©ºé—´é‡Šæ”¾å‡½æ•° deallocate()</h4>

<p>å¯¹äºdeallocate()å‡½æ•°é¦–å…ˆåˆ¤æ–­åŒºå—å¤§å°ï¼Œå¤§äº128byteså°±è°ƒç”¨ç¬¬ä¸€çº§é…ç½®å™¨ï¼Œå°äº128byteså°±æ‰¾å‡ºå¯¹åº”çš„free listï¼Œå°†åŒºå—å›æ”¶ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-16-58-32.png" alt="åŒºå—å›æ”¶" /></p>

<h4 id="229-é‡æ–°å¡«å……-free-list">2.2.9 é‡æ–°å¡«å…… free-list</h4>

<p>å½“å†…å­˜æ± ä¸­æ²¡æœ‰å¯ç”¨åŒºå—çš„æ—¶å€™ï¼Œå°±è°ƒç”¨<code class="language-plaintext highlighter-rouge">refill()</code>å‡†å¤‡ä¸ºfree-listé‡æ–°åˆ†é…ç©ºé—´ã€‚æ–°çš„ç©ºé—´å°†å–è‡ªå†…å­˜æ± ï¼Œç¼ºçœå–å¾—20ä¸ªæ–°èŠ‚ç‚¹(æ–°åŒºå—)ï¼Œä½†ä¸‡ä¸€å†…å­˜æ± ç©ºé—´ä¸è¶³ï¼Œè·å¾—çš„èŠ‚ç‚¹æ•°(åŒºå—æ•°)å¯èƒ½å°äº20ã€‚</p>

<h4 id="2210-å†…å­˜æ± memory-pool">2.2.10 å†…å­˜æ± (memory pool)</h4>
<p><em>å‚è€ƒé“¾æ¥ï¼š</em> <a href="https://blog.csdn.net/u010183728/article/details/81531392">C++å®ç°å†…å­˜æ± </a>;</p>

<p>ä¸Šæ–‡ä¸­æåŠä½¿ç”¨å†…å­˜æ± ä¸­çš„å†…å­˜ï¼Œæä¾›ç»™free-listæ–¹ä¾¿å­˜å–å†…å­˜ã€‚å†…å­˜æ± ä¸»è¦æ˜¯å’Œçº¿ç¨‹æ± ç±»ä¼¼ï¼Œä½¿ç”¨é¢„å…ˆåˆ†é…æ¥å®ç°å†…å­˜çš„é›†ä¸­åˆ†é…å’ŒåŒä¸€ç®¡ç†</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-21-32-29.png" alt="å†…å­˜æ± ç®¡ç†è¿‡ç¨‹" /></p>

<h3 id="23-å†…å­˜åŸºæœ¬å¤„ç†å·¥å…·">2.3 å†…å­˜åŸºæœ¬å¤„ç†å·¥å…·</h3>

<p>STLä¸­å®šä¹‰æœ‰5ä¸ªå…¨å±€å‡½æ•°ï¼Œä½œç”¨äºæœªåˆå§‹åŒ–ç©ºé—´ä¹‹ä¸Šã€‚åˆ†åˆ«æ˜¯<code class="language-plaintext highlighter-rouge">construct()</code>ã€<code class="language-plaintext highlighter-rouge">destroy()</code>ã€uninitailized_copy()ã€uninitailized_fill()ã€uninitialized_fill_n();åˆ†åˆ«å¯¹åº”äºé«˜å±‚æ¬¡å‡½æ•°copy()ã€fill()ã€fill_n();åé¢å‡ ä¸ªå‡½æ•°å®šä¹‰äº<stl_uninitialized></stl_uninitialized></p>

<ul>
  <li>uninitialized_fill_n((_ForwardIterator __first, _Size __n, const _Tp&amp; __x))ï¼šå®ƒæ¥å—ä¸‰ä¸ªå‚æ•°ï¼›å¹¶é€šè¿‡value_typeæ¥åˆ¤æ–­å¯¹è±¡æœ‰æ²¡æœ‰æ„é€ å‡½æ•°ï¼Œæœ‰å°±è¿›è¡Œï¼Œæ²¡æœ‰ç›´æ¥è·³è¿‡ã€‚
    <ul>
      <li>è¿­ä»£å™¨ fristæŒ‡å‘åˆå§‹åŒ–ç©ºé—´çš„èµ·å§‹å¤„</li>
      <li>nè¡¨ç¤ºåˆ†é…å†…å­˜çš„æ•°é‡</li>
      <li>xè¡¨ç¤ºè¿›è¡Œå†…å­˜åˆ†é…æ—¶å€™çš„åˆå€¼</li>
    </ul>
  </li>
  <li>uninitialized_copy(_InputIterator __first, _InputIterator __last,_ForwardIterator __result);è¾“å…¥å‚æ•°åˆ—è¡¨å¦‚ä¸‹ï¼Œå®ƒè°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">__uninitialized_copy()</code>å‡½æ•°ï¼Œå¹¶ä¸”é€šè¿‡value_typeæ¥åˆ¤æ–­æ˜¯å¦ä¸ºPOD(ä¼ ç»ŸåŸºæœ¬æ•°æ®ç±»å‹å«æœ‰æ‹·è´æ„é€ ç­‰å‡½æ•°)ï¼Œæ˜¯åˆ™ç›´æ¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::copy()</code>è¿›è¡Œæ„é€ ã€‚ä¸æ˜¯å°±ä½¿ç”¨éå†å¹¶ä½¿ç”¨<code class="language-plaintext highlighter-rouge">td::_Construct</code>è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°è¿›è¡Œæ„é€ ã€‚
    <ul>
      <li>frist è¿­ä»£å™¨</li>
      <li>last è¿­ä»£å™¨</li>
      <li>è¡¨ç¤ºæœ€ç»ˆç»“æœ</li>
    </ul>
  </li>
  <li>uninitialized_fill(_ForwardIterator __first, _ForwardIterator __last,const _Tp&amp; __x)å’Œä¸Šé¢ä¸€æ ·ä¹Ÿæ˜¯éœ€è¦åˆ¤æ–­PODæ¥å†³å®šä½¿ç”¨æ„é€ æ–¹å¼å’Œç±»å‹ã€‚
    <ul>
      <li>frist è¿­ä»£å™¨</li>
      <li>last è¿­ä»£å™¨</li>
      <li>è¡¨ç¤ºæœ€ç»ˆç»“æœ</li>
    </ul>
  </li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-25-22-13-25.png" alt="ä¸‰ä¸ªå†…å­˜åŸºæœ¬ç‰ˆæœ¬" /></p>

<p>è¿™ä¸€ç« ä¸»è¦è®²è¿°äº†STLä¸­çš„alloctoré€šè¿‡æºç è§£æï¼Œæˆ‘ä»¬å‘ç°å…¶å®STLçš„è¿­ä»£å™¨ä½¿ç”¨äº†structæ¥è¿›è¡Œæ„é€ ï¼Œå†…éƒ¨è¿˜æ˜¯ä½¿ç”¨äº†æŒ‡é’ˆè¿ç®—ç¬¦ï¼Œè€Œæ‰€è°“çš„value_typeä¹Ÿæ˜¯æŒ‡é’ˆç›¸å…³çš„åˆ«åï¼Œæ„Ÿè§‰ç¼–è¯‘å™¨å‚å•†å·æ‡’äº†ï¼Œä¸è¿‡æ ‡å‡†åº“çš„æ³›ç”¨æ€§å¾—åˆ°äº†ä¿è¯ã€‚è€Œä¸”å…³äºå†…å­˜æ± ç¡®å®æ˜¯å¾ˆå¥½çš„äº®ç‚¹ã€‚æ…ç”¨STL;</p>

<h2 id="ç¬¬ä¸‰ç« -è¿­ä»£å™¨iterators-æ¦‚å¿µä¸traitsç¼–ç¨‹æŠ€æ³•">ç¬¬ä¸‰ç«  è¿­ä»£å™¨(iterators) æ¦‚å¿µä¸traitsç¼–ç¨‹æŠ€æ³•</h2>

<p>è¿­ä»£å™¨æ˜¯ä¸€ç¨®æŠ½è±¡è¨­è¨ˆçš„æ¦‚å¿µï¼Œå¯¦ç¾ç¨‹åºèªè¨€ä¸­ä¸¦æ²’æœ‰ç›´æ¥å°æ‡‰çš„æ¦‚å¿µçš„å¯¦ç‰©ã€‚ä½¿ç”¨çš„23ç¨®è¨­è¨ˆæ¨¡å¼ä¸­çš„è¿­ä»£å™¨æ¨¡å¼ï¼šæä¾›ä¸€ç¨®æ–¹æ³•å¯ä»¥ä¾æ¬¡è¨ªå•æŸå€‹èšåˆç‰©æ‰€å«çš„å„å€‹å®¹å™¨çš„å…ƒç´ ã€‚STLçš„ä¸­å¿ƒæ€æƒ³åœ¨æ–¼ï¼šå°‡æ•¸æ“šå®¹å™¨å’Œç®—æ³•åˆ†é–‹ä¾†ã€‚è€Œè¿­ä»£å™¨å°±æ˜¯æ‰®æ¼”ç€å…©è€…ä¹‹é–“çš„è† åˆåŠ‘è§’è‰²ã€‚</p>

<h3 id="32-è¿­ä»£å™¨æ˜¯ä¸€ç¨®-smart-pointer">3.2 è¿­ä»£å™¨æ˜¯ä¸€ç¨® smart pointer</h3>

<p>è¿­ä»£å™¨æ˜¯ä¸€ç¨®è¡Œçˆ²é¡ä¼¼æŒ‡é‡çš„å°è±¡ï¼ŒæŒ‡é’ˆä¸­æœ€å¸¸è§ä¹Ÿæœ€é‡è¦çš„è¡Œä¸ºä¾¿æ˜¯é—´æ¥å¼•ç”¨(dereference)å’Œæˆå‘˜è®¿é—®(member access)ï¼Œå› æ­¤è¿­ä»£å™¨æœ€é‡è¦çš„å°±æ˜¯å¯¹operator*å’Œoperator-&gt;è¿›è¡Œé‡è½½æ“ä½œã€‚c++STLä¸­æœ‰ä¸€ä¸ªauto_ptrï¼ˆ11ä¸­å·²ç»åºŸå¼ƒï¼‰ï¼Œæ˜¯ç”¨æ¥åŒ…è£…ä¸€ä¸ªåŸç”ŸæŒ‡é’ˆ(native pointer)çš„å¯¹è±¡ã€‚å¯ä»¥è§£å†³å„ç§å†…å­˜æ¼æ´ã€‚ä¸‹é¢æ˜¯auto_ptrçš„æºç ç²¾è¦ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">auto_ptr</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">auto_ptr</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="n">pointer</span><span class="p">(</span><span class="n">p</span><span class="p">){}</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">U</span><span class="p">&gt;</span>
    <span class="n">auto_ptr</span><span class="p">(</span><span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span><span class="o">:</span><span class="n">pointee</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">release</span><span class="p">()){}</span>
    <span class="o">~</span><span class="n">auto_ptr</span><span class="p">(){</span><span class="k">delete</span> <span class="n">pointee</span><span class="p">;}</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">U</span><span class="p">&gt;</span>
    <span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">auto_ptr</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;&amp;</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="o">!=&amp;</span><span class="n">rhs</span><span class="p">)</span> <span class="n">reset</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">release</span><span class="p">());</span>
        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">pointee</span><span class="p">;}</span>
    <span class="n">T</span><span class="o">*</span> <span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">pointee</span><span class="p">;}</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">get</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">pointee</span><span class="p">;}</span>  
<span class="nl">private:</span>
    <span class="n">T</span> <span class="o">*</span><span class="n">pointee</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•è¿­ä»£å™¨</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Item</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">LisIter</span>
 <span class="p">{</span>
     <span class="n">Item</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
     <span class="n">ListIter</span><span class="p">(</span><span class="n">Item</span><span class="o">*</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="n">ptr</span><span class="p">(</span><span class="n">p</span><span class="p">){}</span>
     <span class="c1">//å…³é”®æ“ä½œ</span>

     <span class="n">Item</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;}</span>
     <span class="n">Item</span><span class="o">*</span> <span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">ptr</span><span class="p">;}</span>
     <span class="n">ListIter</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span>
     <span class="p">{</span>
        <span class="n">ptr</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">();</span>
        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
     <span class="p">}</span> 
     <span class="n">ListIter</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
     <span class="p">{</span>
        <span class="n">ListIter</span> <span class="n">tmp</span><span class="o">=*</span><span class="k">this</span><span class="p">;</span>
        <span class="o">++*</span><span class="k">this</span><span class="p">;</span>
        <span class="n">retrun</span> <span class="n">tmp</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">ListIter</span><span class="o">&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span>
     <span class="p">{</span>
        <span class="k">return</span> <span class="n">ptr</span><span class="o">!=</span><span class="n">i</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
     <span class="p">}</span>
 <span class="p">};</span> 
</code></pre></div></div>

<p>è¿­ä»£å™¨çš„å¦å¤–ä¸€ä¸ªéå¸¸é‡è¦çš„åŠŸèƒ½å°±æ˜¯éšè—å…¶ä¸­çš„ç»†èŠ‚ï¼›è¿™ä¸€ç‚¹æ ‡å‡†åº“å·²ç»åšçš„å¾ˆå¥½äº†ã€‚</p>

<h3 id="33-è¿­ä»£å™¨ç›¸åº”å‹åˆ«associated-types">3.3 è¿­ä»£å™¨ç›¸åº”å‹åˆ«(associated types)</h3>

<p>è¿­ä»£å™¨ç›¸åº”å‹åˆ«æ˜¯ä¸€ç§ç±»ä¼¼çš„å°è£…è¡Œä¸ºï¼Œå¹¶ä¸åªæ˜¯â€œè¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„å‹åˆ«â€</p>

<h3 id="34-traitsç¼–ç¨‹æŠ€æ³•stlæºç é—¨é’¥">3.4 Traitsç¼–ç¨‹æŠ€æ³•â€“STLæºç é—¨é’¥</h3>

<p>è¿­ä»£å™¨æ‰€æŒ‡çš„å‹åˆ«ï¼Œç§°ä¸ºè¯¥è¿­ä»£å™¨çš„ value typeã€‚valueç”¨äºå‡½æ•°çš„ä¼ å›å€¼å°±æ— æ³•æ­£å¸¸å·¥ä½œäº†ã€‚ä½¿ç”¨å†…åµŒç±»å‹å¯ä»¥å¾ˆå¥½çš„é¿å…è¿™ç§é—®é¢˜ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">MyIter</span>
<span class="p">{</span>
    <span class="c1">//å†…åµŒç±»å‹å£°æ˜</span>

    <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="n">T</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="n">MyIter</span><span class="p">(</span><span class="n">T</span><span class="o">*</span> <span class="n">p</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="n">ptr</span><span class="p">(</span><span class="n">p</span><span class="p">){}</span>
    <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;}</span> 
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">I</span><span class="p">&gt;</span>
<span class="k">typename</span> <span class="n">I</span><span class="o">::</span><span class="n">value_type</span> <span class="nf">func</span><span class="p">(</span><span class="n">I</span> <span class="n">ite</span><span class="p">){</span><span class="k">return</span> <span class="o">*</span><span class="n">ite</span><span class="p">;}</span>

<span class="n">MyIter</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">ite</span><span class="p">(</span><span class="k">new</span> <span class="nf">int</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
<span class="n">cout</span><span class="o">&lt;&lt;</span><span class="n">func</span><span class="p">(</span><span class="n">ite</span><span class="p">);</span>
</code></pre></div></div>
<p>ä¸Šé¢å¯ä»¥å®ç°å¯¹ç±»çš„ç‰¹ä¾‹åŒ–åˆ«åï¼Œä½†æ˜¯å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹å´ä¸å¯ä»¥ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨ç‰¹ä¾‹åŒ–æ¨¡æ¿<code class="language-plaintext highlighter-rouge">template&lt;&gt;</code>æ¥å¯¹åŸºæœ¬çš„æ•°æ®ç±»å‹è¿›è¡Œå°è£…;STLä¸­æä¾›äº†traitsç‰¹æ€§æ¥å¯¹æ•°æ®è¿›è¡Œå°è£…å’Œæ”¹è¿›ã€‚</p>

<p>traitsæ„ä¹‰åœ¨äºï¼Œå¦‚æœIå®šä¹‰æœ‰è‡ªå·±çš„value type,é‚£ä¹ˆé€šè¿‡è¿™ä¸ªtraitsçš„ä½œç”¨ï¼Œèƒå–å‡ºæ¥çš„value_typeå°±æ˜¯I::value_typeã€‚è¿™æ ·traitså°±å¯ä»¥æ‹¥æœ‰ç‰¹ä¾‹åŒ–ç‰ˆæœ¬ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-16-01-10.png" alt="traitsç‰¹æ€§" /></p>

<p>å¸¸ç”¨çš„è¿­ä»£å™¨ç±»å‹æœ‰5ç§ï¼š</p>

<ul>
  <li>value_type: è¿­ä»£å™¨æ‰€æŒ‡å¯¹è±¡çš„å‹åˆ«ã€‚</li>
  <li>difference_type:ä¸¤ä¸ªè¿­ä»£å™¨ä¹‹é—´çš„è·ç¦»ï¼Œå› æ­¤ä¹Ÿå¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå®¹å™¨çš„æœ€å¤§å®¹é‡ã€‚è¡¨ç¤ºå¤´å°¾ä¹‹é—´çš„è·ç¦»å‚æ•°ã€‚å…¶åŸå‹æ˜¯<code class="language-plaintext highlighter-rouge">typedef ptrdiff_t difference_type</code>;ä½¿ç”¨æ—¶å¯ä»¥ç”¨<code class="language-plaintext highlighter-rouge">typename iterator_traits&lt;I&gt;::difference_type</code></li>
  <li>reference_type: <code class="language-plaintext highlighter-rouge">typedef const T&amp; reference type</code>
    <ul>
      <li>è¿­ä»£å™¨åˆ†ä¸ºä¸¤ç§<code class="language-plaintext highlighter-rouge">const</code>å’Œé<code class="language-plaintext highlighter-rouge">const</code>ï¼›ä¸å…è®¸/å…è®¸æ”¹å˜æ‰€æŒ‡å†…å®¹çš„å¯¹è±¡ã€‚</li>
    </ul>
  </li>
  <li>pointer type ä¸»è¦è¿˜æ˜¯å¯¹è±¡çš„æŒ‡é’ˆç±»å‹ã€‚</li>
  <li>iterator_category: ä¸»è¦ç”¨äºå¤§è§„æ¨¡çš„è¿­ä»£å™¨</li>
</ul>

<p>æ ¹æ®ç§»åŠ¨ç‰¹æ€§ä¸æ–½è¡Œæ“ä½œï¼Œè¿­ä»£å™¨è¢«åˆ†ä¸º5ç±»</p>

<ul>
  <li>input iterator:è¿™ç§è¿­ä»£å™¨æ‰€æŒ‡çš„å¯¹è±¡ï¼Œä¸å…è®¸å¤–ç•Œæ”¹å˜ã€‚åªè¯»(read only)</li>
  <li>output Iterator:å”¯å†™(write only)</li>
  <li>Forward Iterator:å…è®¸â€œå†™å…¥å‹â€ç®—æ³•(å¦‚replace())åœ¨æ­¤ç§è¿­ä»£å™¨æ‰€å½¢æˆçš„åŒºé—´ä¸Šè¿›è¡Œè¯»å†™æ“ä½œã€‚</li>
  <li>Bidirectional Iterator:å¯ä»¥åŒå‘ç§»åŠ¨ã€‚æŸäº›ç®—æ³•éœ€è¦é€†å‘èµ°è®¿æŸä¸ªè¿­ä»£å™¨åŒºé—´(ä¾‹å¦‚é€†å‘æ‹·è´æŸèŒƒå›´å†…çš„å…ƒç´ )ï¼Œå¯ä»¥ä½¿ç”¨Bidirectional Iteratorsã€‚</li>
  <li>Random Access Iterator: å‰å››ä¸­è¿­ä»£å™¨éƒ½åªæä¾›ä¸€éƒ¨åˆ†æŒ‡é’ˆç®—æœ¯èƒ½åŠ›ï¼Œç¬¬äº”ç§åˆ™æ¶µç›–æ‰€æœ‰æŒ‡é’ˆå’Œç®—æœ¯èƒ½åŠ›ï¼ŒåŒ…æ‹¬p+n,p-n,p[n],p1-p2,p1å°äºp2ã€‚</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-16-43-29.png" alt="è¿­ä»£å™¨çš„åˆ†ç±»å’Œä»å±å…³ç³»" />;</p>

<h3 id="35-stditeratorçš„ä¿è¯">3.5 std::iteratorçš„ä¿è¯</h3>

<p>STLæä¾›äº†ä¸€ä¸ªiterator class ã€‚æ¯ä¸ªæ–°è®¾è®¡çš„è¿­ä»£å™¨éƒ½ç»§æ‰¿è‡ªå®ƒï¼Œå¯ä»¥ä¿è¯STLæ‰€éœ€ä¹‹è§„èŒƒ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span> <span class="o">&lt;</span>
      <span class="k">class</span> <span class="nc">Category</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">T</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">Distance</span><span class="o">=</span><span class="kt">ptrdiff_t</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">Pointer</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">Reference</span><span class="o">=</span><span class="n">T</span><span class="o">&amp;</span>
          <span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">iterator</span>
<span class="p">{</span>
  <span class="k">typedef</span> <span class="n">Category</span> <span class="n">iterator_category</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">Distance</span> <span class="n">difference_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">Pointer</span> <span class="n">pointer</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">Reference</span> <span class="n">reference</span><span class="p">;</span>
  
<span class="p">};</span>

<span class="c1">//ä½¿ç”¨</span>

<span class="n">std</span><span class="o">::</span><span class="n">iterator</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">forward_iterator_tag</span><span class="p">,</span><span class="n">Item</span><span class="o">&gt;</span> 
</code></pre></div></div>
<p>çº¯ç²¹çš„æ¥å£ç±»å‹ç±»ï¼Œå› æ­¤æ²¡æœ‰é¢å¤–çš„è´Ÿæ‹…ã€‚</p>

<p>æ€»ç»“ï¼štraitsç¼–ç¨‹æŠ€æ³•å¤§é‡ç”¨äºSTLå®ç°å“ä¸­ï¼Œåˆ©ç”¨â€œå†…åµŒå‹åˆ«â€çš„ç¼–ç¨‹æŠ€å·§ä¸ç¼–è¯‘å™¨çš„templateå‚æ•°æ¨å¯¼åŠŸèƒ½,å¢å¼ºäº†c++çš„ç±»å‹æ¨å¯¼èƒ½åŠ›ã€‚</p>

<h3 id="36-iteratoræºç å®Œæ•´é‡åˆ—">3.6 iteratoræºç å®Œæ•´é‡åˆ—</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æºè‡ª &lt;stl_iterator.h&gt;</span>

<span class="k">struct</span> <span class="nc">input_iterator_tag</span><span class="p">{};</span>
<span class="k">struct</span> <span class="nc">output_iterator_tag</span><span class="p">{};</span>
<span class="k">struct</span> <span class="nc">forward_iterator_tag</span><span class="o">:</span><span class="k">public</span> <span class="n">input_iterator_tag</span><span class="p">{};</span>
<span class="k">struct</span> <span class="nc">bidirectional_iterator_tag</span><span class="o">:</span><span class="k">public</span> <span class="n">forward_iterator_tag</span><span class="p">{};</span>
<span class="k">struct</span> <span class="nc">random_access_iterator_tag</span><span class="o">:</span><span class="k">public</span> <span class="n">bidirectional_iterator_tag</span><span class="p">{};</span>
<span class="c1">//è¿­ä»£å™¨å°è£…ç±»</span>

<span class="k">template</span> <span class="o">&lt;</span>
      <span class="k">class</span> <span class="nc">Category</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">T</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">Distance</span><span class="o">=</span><span class="kt">ptrdiff_t</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">Pointer</span><span class="o">=</span><span class="n">T</span><span class="o">*</span><span class="p">,</span>
      <span class="k">class</span> <span class="nc">Reference</span><span class="o">=</span><span class="n">T</span><span class="o">&amp;</span>
          <span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">iterator</span>
<span class="p">{</span>
  <span class="k">typedef</span> <span class="n">Category</span> <span class="n">iterator_category</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">Distance</span> <span class="n">difference_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">Pointer</span> <span class="n">pointer</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="n">Reference</span> <span class="n">reference</span><span class="p">;</span>
  
<span class="p">};</span>
<span class="c1">//traits</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Iterator</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">iterator_traits</span><span class="p">{</span>
  <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">iterator_category</span> <span class="n">iterator_category</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">value_type</span> <span class="n">value_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">difference_type</span> <span class="n">difference_type</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">pointer</span> <span class="n">pointer</span><span class="p">;</span>
  <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">reference</span> <span class="n">reference</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//ä¸ºåŸç”ŸæŒ‡é’ˆè€Œè®¾è®¡çš„traitsåç‰¹åŒ–ç‰ˆ</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">iteraror_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">random_access_iterator_tag</span> <span class="n">iterator_category</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">ptrdiff_t</span> <span class="n">difference_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">reference</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">...</span>

</code></pre></div></div>

<h3 id="sgi-stlçš„ç§æˆ¿èœ-__type_traits">SGI STLçš„ç§æˆ¿èœ __type_traits</h3>

<p>iterator_traitsè´Ÿè´£èƒå–è¿­ä»£å™¨çš„ç‰¹æ€§ï¼Œ__type_traitsåˆ™è´Ÿè´£èƒå–å‹åˆ«(type)çš„ç‰¹æ€§ã€‚å®ƒæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå…è®¸é’ˆå¯¹ä¸åŒçš„å‹åˆ«å±æ€§ï¼Œåœ¨ç¼–è¯‘æ—¶æœŸå®Œæˆå‡½æ•°æ´¾é€å†³å®šã€‚</p>

:ET