I"ğƒ<h1 id="kubernetes-é›†ç¾¤æ­å»º">Kubernetes é›†ç¾¤æ­å»º</h1>

<h2 id="å‚è€ƒé“¾æ¥"><em>å‚è€ƒé“¾æ¥</em></h2>

<ul>
  <li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/">kubernetesç”Ÿäº§ç¯å¢ƒæ­å»º</a></li>
  <li><a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/">kubeadmç¯å¢ƒå¿«é€Ÿæ­å»º</a></li>
  <li><a href="https://blog.csdn.net/zhang19903848257/article/details/125447578">è…¾è®¯äº‘éƒ¨ç½²K8sé›†ç¾¤</a></li>
  <li><a href="https://www.seayee.net/2021/09/16/k8s-install/">CentOS 8å®‰è£…Kubernetesé›†ç¾¤è¯¦ç»†æ•™ç¨‹</a></li>
  <li><a href="https://www.cnbugs.com/post-3190.html">centos7ä½¿ç”¨kubeadmå®‰è£…Kubernetes 1.19ç‰ˆæœ¬</a></li>
  <li><a href="https://www.iamlightsmile.com/articles/CentOS8%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEkubernetes%EF%BC%88K8S%EF%BC%89/">CentOS8å®‰è£…é…ç½®kubernetesï¼ˆK8Sï¼‰</a></li>
  <li><a href="http://victorfengming.gitee.io/kubernetes/2_%E6%90%AD%E5%BB%BAK8S%E9%9B%86%E7%BE%A4%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86/#%E5%A4%9Amaster%E9%9B%86%E7%BE%A4">k8sé›†ç¾¤æ­å»º</a></li>
  <li><a href="https://www.cnblogs.com/hujinzhong/p/14648961.html">äºŒè¿›åˆ¶å®‰è£…éƒ¨ç½²k8sé«˜å¯ç”¨é›†ç¾¤V1.20</a></li>
  <li><a href="https://blog.51cto.com/u_15287666/5269619#_1">Kubernetesç¬¬äºŒç¯‡ï¼šä»é›¶å¼€å§‹æ­å»ºk8sé›†ç¾¤ï¼ˆäº²æµ‹å¯ç”¨ï¼‰</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/462096658">CentOS8ä½¿ç”¨kubeadméƒ¨ç½²kubernetes</a></li>
  <li><a href="https://blog.51cto.com/lwm666/2619470">CentOS8å®‰è£…Kubernetes1.20.2é›†ç¾¤</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/460794489">k8så¢åŠ masterèŠ‚ç‚¹</a></li>
  <li><a href="https://dev-docs.csdn.net/articles/aaf25b1472304763899a88cc75e5152a/kubernetes">å…¬ç½‘æ­å»ºKubernetes 1.20.9ï¼ˆé˜¿é‡Œäº‘+è…¾è®¯äº‘ï¼‰</a></li>
  <li><a href="https://blog.csdn.net/IT_rookie_newbie/article/details/124992940">å…¬ç½‘ç¯å¢ƒæ­å»ºKubernetes (k8s) é›†ç¾¤çš„è¯¦ç»†å›¾è§£</a></li>
</ul>

<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä¸ºäº†è¿›ä¸€æ­¥å­¦ä¹ kubernetes é›†ç¾¤æ­å»ºå°è¯•è‡ªå·±æ­å»ºå¯¹åº”çš„k8sé›†ç¾¤</p>

<h2 id="é›†ç¾¤è®¾è®¡">é›†ç¾¤è®¾è®¡</h2>

<h3 id="å®ä¾‹èŠ‚ç‚¹">å®ä¾‹èŠ‚ç‚¹</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">è§’è‰²</th>
      <th style="text-align: center">ä¸»æœºåç§°</th>
      <th style="text-align: center">IP</th>
      <th style="text-align: center">é…ç½®</th>
      <th style="text-align: center">ç³»ç»Ÿ</th>
      <th style="text-align: center">åœ°åŸŸ</th>
      <th style="text-align: center">äº‘å‚å•†</th>
      <th style="text-align: left">ç›¸å…³ç»„ä»¶</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">k8s-master</td>
      <td style="text-align: center">k8s-master-01</td>
      <td style="text-align: center">xxx.xxx.113.233</td>
      <td style="text-align: center">2C2GB</td>
      <td style="text-align: center">CentOS 8.2 64bit</td>
      <td style="text-align: center">æˆéƒ½</td>
      <td style="text-align: center">è…¾è®¯äº‘</td>
      <td style="text-align: left">TODO</td>
    </tr>
    <tr>
      <td style="text-align: center">k8s-master</td>
      <td style="text-align: center">k8s-master-02</td>
      <td style="text-align: center">xxx.xxx.102.222</td>
      <td style="text-align: center">2C4G</td>
      <td style="text-align: center">CentOS 8.2 64bit</td>
      <td style="text-align: center">åŒ—äº¬</td>
      <td style="text-align: center">ç™¾åº¦äº‘</td>
      <td style="text-align: left">TODO</td>
    </tr>
    <tr>
      <td style="text-align: center">k8s-node01</td>
      <td style="text-align: center">k8s-node-01</td>
      <td style="text-align: center">xxx.xxx.67.59</td>
      <td style="text-align: center">4C16G</td>
      <td style="text-align: center">CentOS 8.2 64bit</td>
      <td style="text-align: center">ä¸Šæµ·</td>
      <td style="text-align: center">è…¾è®¯äº‘</td>
      <td style="text-align: left">TODO</td>
    </tr>
    <tr>
      <td style="text-align: center">k8s-node02</td>
      <td style="text-align: center">k8s-node-02</td>
      <td style="text-align: center">xxx.xxx.42.73</td>
      <td style="text-align: center">4C16G</td>
      <td style="text-align: center">CentOS 8.2 64bit</td>
      <td style="text-align: center">åŒ—äº¬</td>
      <td style="text-align: center">ç™¾åº¦äº‘</td>
      <td style="text-align: left">TODO</td>
    </tr>
  </tbody>
</table>

<h3 id="è½¯ä»¶ç‰ˆæœ¬">è½¯ä»¶ç‰ˆæœ¬</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: center">è½¯ä»¶</th>
      <th style="text-align: center">ç‰ˆæœ¬</th>
      <th style="text-align: left">å¤‡æ³¨</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">k8s</td>
      <td style="text-align: center">v1.23.2</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">kube-apiserver</td>
      <td style="text-align: center">v1.23.2</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">kube-proxy</td>
      <td style="text-align: center">v1.23.2</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">kube-controller-manager</td>
      <td style="text-align: center">v1.23.2</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">kube-scheduler</td>
      <td style="text-align: center">v1.23.2</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">coredns</td>
      <td style="text-align: center">v1.8.0</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">etcd</td>
      <td style="text-align: center">3.4.13-0</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">pause</td>
      <td style="text-align: center">3.4.1</td>
      <td style="text-align: left">Â </td>
    </tr>
  </tbody>
</table>

<p>k8s1.24ç‰ˆæœ¬ä¹‹åä¸å†ä½¿ç”¨dockerä½œä¸ºå®¹å™¨ï¼Œå› æ­¤æˆ‘ä»¬æš‚ä¸ä½¿ç”¨è¯¥ç‰ˆæœ¬ï¼Œä½¿ç”¨1.23.2ç‰ˆæœ¬è¿›è¡Œå®‰è£…</p>

<p>TODO ä½¿ç”¨container è¿›è¡Œå‡çº§æ›¿æ¢</p>

<h2 id="æ“ä½œæ­¥éª¤">æ“ä½œæ­¥éª¤</h2>

<h3 id="1-ä¸»æœºåŸºç¡€é…ç½®">1. ä¸»æœºåŸºç¡€é…ç½®</h3>

<h4 id="11-æ§åˆ¶ç«¯é¢œè‰²">1.1 æ§åˆ¶ç«¯é¢œè‰²</h4>
<p>ç¼–è¾‘ <code class="language-plaintext highlighter-rouge">/etc/bashrc</code> æ·»åŠ å¦‚ä¸‹ä»£ç </p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># vim:ts=4:sw=4</span>
<span class="nb">export </span><span class="nv">HISTSIZE</span><span class="o">=</span>3000
<span class="nb">export </span><span class="nv">HISTTIMEFORMAT</span><span class="o">=</span><span class="s2">"%F %T "</span>
<span class="nb">export </span><span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">"history -a; </span><span class="nv">$PROMPT_COMMAND</span><span class="s2">"</span>
<span class="nb">unset </span>HISTCONTROL


<span class="nv">PS1</span><span class="o">=</span><span class="s2">"</span><span class="se">\[\e</span><span class="s2">[1;33m</span><span class="se">\]\[\e</span><span class="s2">[0;33m</span><span class="se">\]</span><span class="s2">[</span><span class="se">\[\e</span><span class="s2">[1;32m</span><span class="se">\]\u\[\e</span><span class="s2">[m</span><span class="se">\]\[\e</span><span class="s2">[1;33m</span><span class="se">\]</span><span class="s2">@</span><span class="se">\[\e</span><span class="s2">[m</span><span class="se">\]\[\e</span><span class="s2">[1;35m</span><span class="se">\]\h\[\e</span><span class="s2">[m</span><span class="se">\]\[\e</span><span class="s2">[0;33m</span><span class="se">\]</span><span class="s2">] </span><span class="se">\w\$</span><span class="s2"> </span><span class="se">\[\e</span><span class="s2">[m</span><span class="se">\]</span><span class="s2">"</span>
</code></pre></div></div>
<p>å¢åŠ æ§åˆ¶å°é¢œè‰²å’Œå†å²å‘½ä»¤
æ˜¾ç¤ºæœ€ç»ˆè‰²å½©
<img src="http://wangpengcheng.github.io/img/2022-06-26-13-51-38.png" alt="æœ€ç»ˆè‰²å½©" /></p>

<h4 id="12-å¢åŠ dev-ç”¨æˆ·">1.2 å¢åŠ dev ç”¨æˆ·</h4>
<p>æ‰€æœ‰æœºå™¨æ–°å¢devç”¨æˆ·å¹¶ä½œä¸ºk8s é»˜è®¤ç”¨æˆ·ï¼Œå¯å‚è€ƒ<a href="https://blog.csdn.net/happy__yun/article/details/124760781">centos8æ–°å¢ç”¨æˆ·</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æ–°å¢devç”¨æˆ·</span>
adduser dev
<span class="c"># ä¿®æ”¹å¯†ç </span>
passwd dev 

<span class="c"># ä¿®æ”¹ç”¨æˆ·æƒé™</span>
<span class="nb">chmod</span> <span class="nt">-v</span> u+w /etc/sudoers
vim /etc/sudoers
<span class="c"># æ·»åŠ </span>
<span class="c"># dev ALL=(ALL) ALL</span>
<span class="nb">chmod</span> <span class="nt">-v</span> u-w /etc/sudoers
</code></pre></div></div>
<h3 id="2-å‰ç½®æ¡ä»¶">2. å‰ç½®æ¡ä»¶</h3>
<p>æ— è®ºnodeè¿˜æ˜¯masteréƒ½éœ€è¦å¼€å¯çš„å‰ç½®æ¡ä»¶</p>
<h4 id="21-ç«¯å£å¼€æ”¾">2.1 ç«¯å£å¼€æ”¾</h4>
<p>ä¸ºäº†k8s æœºå™¨ä¹‹é—´èƒ½å¤Ÿæ­£å¸¸è®¿é—®ï¼Œäº‘æ§åˆ¶å°å¼€æ”¾å¯¹åº”ç«¯å£å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">ç«¯å£</th>
      <th style="text-align: center">åè®®</th>
      <th style="text-align: center">æœåŠ¡</th>
      <th style="text-align: center">è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">8080ã€6443</td>
      <td style="text-align: center">HTTP/HTTPS</td>
      <td style="text-align: center">kube-apiserver</td>
      <td style="text-align: center">APIä¸“ç”¨ç«¯å£å·</td>
    </tr>
    <tr>
      <td style="text-align: center">10252</td>
      <td style="text-align: center">TCP</td>
      <td style="text-align: center">kube-controller-manager</td>
      <td style="text-align: center">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">10251</td>
      <td style="text-align: center">TCP</td>
      <td style="text-align: center">kube-scheduler</td>
      <td style="text-align: center">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">10250ã€10255</td>
      <td style="text-align: center">TCP</td>
      <td style="text-align: center">kubelet</td>
      <td style="text-align: center">Â </td>
    </tr>
    <tr>
      <td style="text-align: center">2379</td>
      <td style="text-align: center">TCP/UDP</td>
      <td style="text-align: center">etcd</td>
      <td style="text-align: center">å®¢æˆ·ç«¯è®¿é—®</td>
    </tr>
    <tr>
      <td style="text-align: center">2380</td>
      <td style="text-align: center">TCP/UDP</td>
      <td style="text-align: center">etcd</td>
      <td style="text-align: center">é›†ç¾¤å†…éƒ¨è®¿é—®</td>
    </tr>
    <tr>
      <td style="text-align: center">53</td>
      <td style="text-align: center">TCP/UDP</td>
      <td style="text-align: center">DNS</td>
      <td style="text-align: center">é›†ç¾¤DNS</td>
    </tr>
    <tr>
      <td style="text-align: center">8472</td>
      <td style="text-align: center">UDP</td>
      <td style="text-align: center">flannel</td>
      <td style="text-align: center">flannelç½‘ç»œé€šè®¯æ’ä»¶ä½¿ç”¨</td>
    </tr>
    <tr>
      <td style="text-align: center">6443</td>
      <td style="text-align: center">TCP</td>
      <td style="text-align: center">k8s-master</td>
      <td style="text-align: center">k8smaster ç«¯å£</td>
    </tr>
    <tr>
      <td style="text-align: center">30000~32767</td>
      <td style="text-align: center">TCP</td>
      <td style="text-align: center">node service pod</td>
      <td style="text-align: center">èŠ‚ç‚¹ç«¯å£æœåŠ¡ï¼Œå¦‚æœå¸Œæœ›Masterçš„IPä¹Ÿå¯ä»¥è®¿é—®PodæœåŠ¡ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç»™Masterä¸»æœºå¼€æ”¾è¿™äº›ç«¯å£ï¼ˆå»ºè®®ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: center">5000</td>
      <td style="text-align: center">TCP</td>
      <td style="text-align: center">Â </td>
      <td style="text-align: center">é•œåƒæœåŠ¡</td>
    </tr>
  </tbody>
</table>

<h4 id="22-åˆå§‹åŒ–">2.2 åˆå§‹åŒ–</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">## åœ¨K8sä¸­ä¸ºäº†é«˜æ•ˆè¿è¡Œï¼Œæ•´ä¸ªé›†ç¾¤çš„æœºå™¨éœ€è¦å…³é—­é˜²ç«å¢™ã€SWAPåˆ†åŒºä»¥åŠSelinuxif</span>
<span class="c"># 1ã€å…³é—­é˜²ç«å¢™ </span>
systemctl stop firewalld 
systemctl disable firewalld 
 
<span class="c"># 2ã€å…³é—­selinux </span>
<span class="c">## æœåŠ¡å™¨å‡å·²ç»é»˜è®¤å…³é—­æ— éœ€æ“ä½œ</span>
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/enforcing/disabled/'</span> /etc/selinux/config  <span class="c"># æ°¸ä¹… </span>
setenforce 0  <span class="c"># ä¸´æ—¶ </span>
 
<span class="c"># 3ã€å…³é—­swap </span>
<span class="c">## æœåŠ¡å™¨å‡å·²ç»é»˜è®¤å…³é—­æ— éœ€æ“ä½œ</span>
swapoff <span class="nt">-a</span>  <span class="c"># ä¸´æ—¶ </span>
<span class="nb">sed</span> <span class="nt">-ri</span> <span class="s1">'s/.*swap.*/#&amp;/'</span> /etc/fstab    <span class="c"># æ°¸ä¹… </span>
 
<span class="c"># 4ã€æ ¹æ®è§„åˆ’è®¾ç½®ä¸»æœºå </span>
hostnamectl set-hostname &lt;<span class="nb">hostname</span><span class="o">&gt;</span> 
 
<span class="c"># 5ã€åœ¨masteræ·»åŠ hosts </span>
<span class="nb">cat</span> <span class="o">&gt;&gt;</span> /etc/hosts <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh"> 
118.24.113.233 k8s-master-01
124.222.67.59 k8s-node-01 
120.48.42.73 k8s-node-02 
120.48.102.222 k8s-master-02
</span><span class="no">EOF
 
</span><span class="c"># 6ã€å°†æ¡¥æ¥çš„IPv4æµé‡ä¼ é€’åˆ°iptablesçš„é“¾ </span>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
</span><span class="no">EOF
 
</span><span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
</span><span class="no">EOF
</span><span class="nb">sudo </span>sysctl <span class="nt">--system</span>  <span class="c"># ç”Ÿæ•ˆ </span>
 
<span class="c"># 7ã€æ—¶é—´åŒæ­¥ </span>
 yum <span class="nb">install</span> <span class="nt">-y</span> chrony

<span class="c"># å¯ä»¥ä¿®æ”¹é»˜è®¤æ—¶é—´åŒæ­¥æœåŠ¡å™¨ï¼Œhttps://intl.cloud.tencent.com/zh/document/product/213/40227</span>
<span class="c"># å¦‚ </span>
<span class="c"># server time1.tencentyun.com iburst</span>
<span class="c"># pool 2.centos.pool.ntp.org iburst</span>
<span class="c">#vim /etc/chrony.conf</span>
<span class="c">#systemctl restart chronyd</span>
<span class="c">#systemctl enable chronyd</span>

<span class="c"># æŸ¥çœ‹æ—¶é—´åŒæ­¥</span>
chronyc sourcestats <span class="nt">-v</span> 
</code></pre></div></div>

<h4 id="23-å®‰è£…docker">2.3 å®‰è£…docker</h4>

<p>docker k8s ç‰ˆæœ¬å…¼å®¹æƒ…å†µå¦‚ä¸‹
|Kubernetesç‰ˆæœ¬| Docker ç‰ˆæœ¬å…¼å®¹æƒ…å†µ|
|:â€“:|:â€“:|
|1.21.x |v20.10.2 ç‰ˆæœ¬ä»¥ä¸Šä¸å…¼å®¹|
|1.22.x |v20.10.2 ç‰ˆæœ¬ä»¥ä¸Šä¸å…¼å®¹|
|1.23.x |v20.10.7 ç‰ˆæœ¬ä»¥ä¸Šä¸å…¼å®¹|</p>

<p>docker æºæ·»åŠ </p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo <span class="nt">-O</span> /etc/yum.repos.d/docker-ce.repo
</code></pre></div></div>

<p>ä¿®æ”¹docker cgroupé©±åŠ¨
å¦å¤–ï¼ŒKubernetesé»˜è®¤è®¾ç½®cgroupé©±åŠ¨ï¼ˆcgroupdriverï¼‰ä¸ºâ€œsystemdâ€œï¼Œè€ŒDockeræœåŠ¡çš„cgroupé©±åŠ¨é»˜è®¤å€¼ ä¸ºâ€œcgroupfsâ€ï¼Œ å»ºè®®å°†å…¶ä¿®æ”¹ä¸ºâ€œsystemdâ€ï¼Œä¸Kubernetesä¿æŒä¸€è‡´ã€‚ä¿®æ”¹æ–¹æ³•ä¸ºä¿®æ”¹/etc/dockere/daemon.jsonæ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰å°±æ·»åŠ ä¸€ä¸ªï¼‰ï¼š</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/docker/daemon.json
{
 "exec-opts": ["native.cgroupdriver=systemd"]
}
</span><span class="no">EOF
</span></code></pre></div></div>
<p>å¯åŠ¨docker</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl daemon-reload
<span class="nb">sudo </span>systemctl restart docker
<span class="nb">sudo </span>systemctl <span class="nb">enable </span>docker
</code></pre></div></div>

<h4 id="24-åˆ›å»ºå…¬ç½‘ç½‘å¡">2.4 åˆ›å»ºå…¬ç½‘ç½‘å¡</h4>
<p>è™šæ‹Ÿç½‘å¡åˆ›å»º
ç”±äºäº‘ä¸»æœºç½‘å¡ç»‘å®šçš„éƒ½æ˜¯å†…ç½‘ IP, è€Œä¸”å‡ å°äº‘æœåŠ¡å™¨ä½äºä¸åŒçš„å†…ç½‘ä¸­ï¼ˆVPCç½‘ç»œä¸äº’é€šï¼‰, ç›´æ¥æ­å»ºä¼šå°†å†…ç½‘ IP æ³¨å†Œè¿›é›†ç¾¤å¯¼è‡´æ­å»ºä¸æˆåŠŸã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æ‰€æœ‰ä¸»æœºéƒ½è¦åˆ›å»ºè™šæ‹Ÿç½‘å¡ï¼Œå¹¶ç»‘å®šå¯¹åº”çš„å…¬ç½‘ ip</span>
<span class="c"># ä¸´æ—¶ç”Ÿæ•ˆï¼Œé‡å¯ä¼šå¤±æ•ˆ</span>
ifconfig eth0:1 &lt;ä½ çš„å…¬ç½‘IP&gt;
 
<span class="c"># æ°¸ä¹…ç”Ÿæ•ˆ</span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/sysconfig/network-scripts/ifcfg-eth0:1 <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
BOOTPROTO=static
DEVICE=eth0:1
IPADDR=120.48.42.73
PREFIX=32
TYPE=Ethernet
USERCTL=no
ONBOOT=yes
</span><span class="no">EOF

</span><span class="c"># é‡å¯ç½‘å¡</span>
<span class="c"># SSHæŒ‚æ‰ï¼Œä»VNCç™»é™†</span>
ifdown eth0 <span class="o">&amp;&amp;</span> ifup eth0

</code></pre></div></div>

<h4 id="25-å®‰è£…k8s">2.5 å®‰è£…k8s</h4>

<p>k8s æºæ·»åŠ </p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">cat</span> <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh"> &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span><span class="no">EOF

</span>setenforce 0

<span class="c">## ç§»é™¤æ—§ç‰ˆæœ¬</span>
yum remove <span class="nt">-y</span> kubelet kubeadm kubectl

<span class="c">## æŸ¥çœ‹å¯ç”¨k8s ç‰ˆæœ¬</span>
yum list kubelet <span class="nt">--showduplicates</span> | <span class="nb">sort</span> <span class="nt">-r</span>


<span class="c">## å®‰è£…æŒ‡å®šç‰ˆæœ¬ k8s</span>

yum <span class="nb">install</span> <span class="nt">-y</span> kubelet-1.23.2 kubeadm-1.23.2 kubectl-1.23.2
<span class="c">## è®¾ç½®æœåŠ¡å¼€æœºå¯åŠ¨</span>
systemctl <span class="nb">enable </span>kubelet <span class="o">&amp;&amp;</span> systemctl start kubelet
</code></pre></div></div>

<h4 id="26-ä¿®æ”¹k8s-å¯åŠ¨æ–‡ä»¶">2.6 ä¿®æ”¹k8s å¯åŠ¨æ–‡ä»¶</h4>
<p>ä¿®æ”¹kubeletå¯åŠ¨å‚æ•°æ–‡ä»¶ï¼Œè®©å…¶èƒ½å¤Ÿä»å…¬ç½‘è¿›è¡Œå¯åŠ¨</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æ­¤æ–‡ä»¶å®‰è£…kubeadmåå°±å­˜åœ¨äº†</span>
vim /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
 
<span class="c"># æ³¨æ„ï¼Œè¿™æ­¥å¾ˆé‡è¦ï¼Œå¦‚æœä¸åšï¼ŒèŠ‚ç‚¹ä»ç„¶ä¼šä½¿ç”¨å†…ç½‘IPæ³¨å†Œè¿›é›†ç¾¤</span>
<span class="c"># åœ¨æœ«å°¾æ·»åŠ å‚æ•° --node-ip=å…¬ç½‘IP</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/kubelet <span class="nv">$KUBELET_KUBECONFIG_ARGS</span> <span class="nv">$KUBELET_CONFIG_ARGS</span> <span class="nv">$KUBELET_KUBEADM_ARGS</span> <span class="nv">$KUBELET_EXTRA_ARGS</span> <span class="nt">--node-ip</span><span class="o">=</span>&lt;å…¬ç½‘IP&gt;
</code></pre></div></div>

<h4 id="27-åˆå§‹åŒ–èŠ‚ç‚¹">2.7 åˆå§‹åŒ–èŠ‚ç‚¹</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c"># åˆå§‹åŒ–èŠ‚ç‚¹</span>
<span class="nb">sudo </span>kubeadm init <span class="se">\</span>
<span class="nt">--apiserver-advertise-address</span><span class="o">=</span>å…¬ç½‘IP <span class="se">\</span>
<span class="nt">--image-repository</span> registry.aliyuncs.com/google_containers <span class="se">\</span>
<span class="nt">--kubernetes-version</span> v1.23.2 <span class="se">\</span>
<span class="nt">--control-plane-endpoint</span><span class="o">=</span>å…¬ç½‘IP <span class="se">\</span>
<span class="nt">--service-cidr</span><span class="o">=</span>10.96.0.0/12 <span class="se">\</span>
<span class="nt">--pod-network-cidr</span><span class="o">=</span>10.244.0.0/16 <span class="se">\</span>
<span class="nt">--v</span><span class="o">=</span>5


<span class="c"># åˆå§‹åŒ–master</span>
<span class="nb">mkdir</span> <span class="nt">-p</span> <span class="nv">$HOME</span>/.kube
<span class="nb">sudo cp</span> <span class="nt">-i</span> /etc/kubernetes/admin.conf <span class="nv">$HOME</span>/.kube/config
<span class="nb">sudo chown</span> <span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span>:<span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span> <span class="nv">$HOME</span>/.kube/config
<span class="c">#</span>
<span class="nb">sudo chmod </span>u+wr /etc/kubernetes/admin.conf
<span class="c"># åˆå§‹åŒ–ç½‘ç»œ</span>
kubectl apply <span class="nt">-f</span> <span class="s2">"https://docs.projectcalico.org/manifests/calico.yaml"</span>
</code></pre></div></div>

<h2 id="ç»“æœ">ç»“æœ</h2>

<p><img src="http://wangpengcheng.github.io/img/2022-06-26-22-57-52.png" alt="å›¾åƒ" /></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># é…ç½®æ°¸ä¹…ç¯å¢ƒå˜é‡</span>
<span class="nb">cat</span> <span class="o">&gt;</span> /etc/profile.d/kubeconfig.sh <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
export KUBECONFIG=/etc/kubernetes/admin.conf
</span><span class="no">EOF

</span><span class="c"># åŠ è½½ç¯å¢ƒå˜é‡</span>
<span class="nb">source</span> /etc/profile

</code></pre></div></div>

<h3 id="åˆ›å»ºnginxæµ‹è¯•èŠ‚ç‚¹">åˆ›å»ºnginxæµ‹è¯•èŠ‚ç‚¹</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># åˆ›å»ºèŠ‚ç‚¹</span>
kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx deployment.apps/nginx created

<span class="c"># è¿›è¡Œæµ‹è¯•</span>
kubectl expose deployment nginx <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--type</span><span class="o">=</span>NodePort
service/nginx exposed

<span class="c"># æŸ¥çœ‹podçŠ¶æ€</span>
kubectl get pod,svc
</code></pre></div></div>

<h3 id="å¼‚å¸¸æ¸…ç©º">å¼‚å¸¸æ¸…ç©º</h3>
<p>å‡ºç°å¼‚å¸¸æƒ…å†µï¼Œéœ€è¦å¯¹master è¿›è¡Œæ¸…ç©ºé‡è¯•</p>

<p>æ¸…ç©ºç½‘å¡èŠ‚ç‚¹</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#ç¬¬ä¸€æ­¥ï¼Œåœ¨masterèŠ‚ç‚¹åˆ é™¤flannel</span>
kubectl delete <span class="nt">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

<span class="c">#ç¬¬äºŒæ­¥ï¼Œåœ¨nodeèŠ‚ç‚¹æ¸…ç†flannelç½‘ç»œç•™ä¸‹çš„æ–‡ä»¶</span>
<span class="nb">sudo </span>ifconfig cni0 down
<span class="nb">sudo </span>ip <span class="nb">link </span>delete cni0
<span class="nb">sudo </span>ifconfig flannel.1 down
<span class="nb">sudo </span>ip <span class="nb">link </span>delete flannel.1
<span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/lib/cni/
<span class="nb">sudo rm</span> <span class="nt">-f</span> /etc/cni/net.d/<span class="k">*</span>
<span class="nb">sudo </span>systemctl restart kubelet.service

<span class="c">#ç¬¬ä¸‰æ­¥ï¼Œåº”ç”¨calicoç›¸å…³çš„yamlæ–‡ä»¶</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># k8s é‡ç½®è„šæœ¬</span>
kubectl delete pod <span class="nt">--all</span>
kubectl delete node <span class="nt">--all</span>

<span class="nb">sudo </span>kubeadm reset <span class="nt">-f</span> 

<span class="nb">rm</span> <span class="nt">-rf</span> <span class="nv">$HOME</span>/.kube


kubeadm reset
systemctl stop kubelet
systemctl stop docker
<span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/cni/
<span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/kubelet/<span class="k">*</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /etc/cni/
<span class="c">##é‡å¯kubelet</span>
systemctl restart kubelet
<span class="c">##é‡å¯docker</span>
systemctl restart docker


<span class="nb">sudo </span>ifconfig cni0 down
<span class="nb">sudo </span>ip <span class="nb">link </span>delete cni0
<span class="nb">sudo </span>ifconfig flannel.1 down
<span class="nb">sudo </span>ip <span class="nb">link </span>delete flannel.1
<span class="nb">sudo rm</span> <span class="nt">-rf</span> /var/lib/cni/
<span class="nb">sudo rm</span> <span class="nt">-f</span> /etc/cni/net.d/<span class="k">*</span>
<span class="nb">sudo </span>systemctl restart kubelet.service

<span class="k">for </span>service <span class="k">in </span>kube-apiserver kube-controller-manager kubectl kubelet kube-proxy kube-scheduler<span class="p">;</span> 
<span class="k">do
      </span>systemctl stop <span class="nv">$service</span>
<span class="k">done

</span><span class="nb">rm</span> <span class="nt">-rf</span> ~/.kube/

<span class="nb">rm</span> <span class="nt">-rf</span> /etc/kubernetes/
 
<span class="nb">rm</span> <span class="nt">-rf</span> /etc/systemd/system/kubelet.service.d

<span class="nb">rm</span> <span class="nt">-rf</span> /etc/systemd/system/kubelet.service

<span class="nb">rm</span> <span class="nt">-rf</span> /usr/bin/kube<span class="k">*</span>

<span class="nb">rm</span> <span class="nt">-rf</span> /etc/cni

<span class="nb">rm</span> <span class="nt">-rf</span> /opt/cni

<span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/etcd

<span class="nb">rm</span> <span class="nt">-rf</span> /var/etcd

yum clean all

yum remove kube<span class="k">*</span> <span class="nt">-y</span>


</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># é‡æ–°å®‰è£…k8s </span>
systemctl disable docker
systemctl stop docker
<span class="nb">sudo </span>yum remove docker-<span class="k">*</span>
<span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/docker/
<span class="nb">rm</span> <span class="nt">-rf</span> /etc/docker/
<span class="nb">rm</span> <span class="nt">-rf</span> /run/docker
<span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/dockershim
<span class="nb">rm</span> <span class="nt">-rf</span> /usr/libexec/docker/

yum <span class="nb">install</span> <span class="nt">-y</span> yum-utils

yum <span class="nb">install</span> <span class="nt">-y</span> docker-ce-19.03.13 docker-ce-cli-19.03.13 containerd.io

systemctl start docker

<span class="c"># è®¾ç½®å¼€æœºè‡ªå¯åŠ¨</span>
systemctl <span class="nb">enable </span>docker.service
systemctl <span class="nb">enable </span>containerd.service

<span class="nb">sudo </span>yum <span class="nb">install</span> <span class="nt">-y</span> kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 <span class="nt">--disableexcludes</span><span class="o">=</span>kubernetes
 
<span class="nb">sudo </span>systemctl <span class="nb">enable</span> <span class="nt">--now</span> kubelet
</code></pre></div></div>

<h3 id="æ­å»ºdashborad">æ­å»ºdashborad</h3>
<ul>
  <li><a href="https://blog.csdn.net/make_progress/article/details/124566603">k8sï¼ˆv18.6ï¼‰å®‰è£…Dashboard</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/341857389?ivk_sa=1024320u">(è½¬è½½ï¼‰Chrome æ‚¨çš„è¿æ¥ä¸æ˜¯ç§å¯†è¿æ¥è§£å†³åŠæ³•</a></li>
</ul>

<p><a href="https://github.com/kubernetes/dashboard/releases/tag/v2.3.1">å¯¹åº”ç‰ˆæœ¬</a></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> wget <span class="nt">-c</span> https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml
<span class="c"># æ‰§è¡Œæ¨¡æ¿æ–‡ä»¶</span>
kubectl apply <span class="nt">-f</span> recommended.yaml
 
<span class="c"># æŸ¥çœ‹æ‰€æœ‰çš„Podï¼Œå‚æ•°-Aå¯ä»¥æ¢æˆ --all-namespaces</span>
kubectl get pods <span class="nt">-A</span>
 
<span class="c"># å‡ºç°ä»¥ä¸‹ç»“æœè¯´æ˜æˆåŠŸ</span>
NAMESPACE              NAME                                            READY   STATUS    RESTARTS   AGE
..... <span class="c">#çœç•¥</span>
kubernetes-dashboard   dashboard-metrics-scraper-6b4884c9d5-88sct      1/1     Running   0          3m13s
kubernetes-dashboard   kubernetes-dashboard-7b544877d5-6bvfr           1/1     Running   0          3m13s
</code></pre></div></div>

<p>æ–°å»ºâ€œkubernetes-dashboard-service.yamlâ€æ–‡ä»¶</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># kubernetes-dashboard-service.yaml</span>
<span class="c"># ä¸‹é¢çš„é…ç½®æ–‡ä»¶å¯ä»¥ä»recommended.yamlä¸­æ‰¾åˆ°</span>
kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  <span class="nb">type</span>: NodePort
  ports:
    - port: 443
      targetPort: 8443
  selector:
    k8s-app: kubernetes-dashboard
</code></pre></div></div>

<p>åº”ç”¨æ–‡ä»¶</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> kubernetes-dashboard-service.yaml
</code></pre></div></div>

<p>æ­¤æ—¶å¯ä»¥ç”¨å…¬ç½‘IP + port è¿›è¡Œè®¿é—®
å‡ºç°chrome æ— æ³•è®¿é—® å‚è€ƒï¼š<a href="https://zhuanlan.zhihu.com/p/341857389?ivk_sa=1024320u">(è½¬è½½ï¼‰Chrome æ‚¨çš„è¿æ¥ä¸æ˜¯ç§å¯†è¿æ¥è§£å†³åŠæ³•</a></p>

<p>æ–°å»ºâ€œkubernetes-dashboard-account.yamlâ€ 
è®¾ç½®è®¿é—®æƒé™</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># kubernetes-dashboard-account.yaml</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dashboard-admin</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dashboard-admin-bind-cluster-role</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">k8s-app</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">cluster-admin</span>
<span class="na">subjects</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">ServiceAccount</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dashboard-admin</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kubernetes-dashboard</span>
</code></pre></div></div>
<p>æ‰§è¡Œé…ç½®æ–‡ä»¶å¹¶è·å–token</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> kubernetes-dashboard-account.yaml


<span class="c"># æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span>
kubectl <span class="nt">-n</span> kubernetes-dashboard describe secret <span class="si">$(</span>kubectl <span class="nt">-n</span> kubernetes-dashboard get secret | <span class="nb">grep </span>dashboard-admin | <span class="nb">awk</span> <span class="s1">'{print $1}'</span><span class="si">)</span>
 
<span class="c"># è¿”å›ç»“æœ</span>
Name:         dashboard-admin-token-l49vj
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: e1bdcbbc-5d43-479c-be6d-508960413b6a
 
Type:  kubernetes.io/service-account-token
 
Data
<span class="o">====</span>
<span class="c"># æ³¨æ„ï¼ï¼ï¼ Tockenå€¼ï¼Œåœ¨ç™»å½•Dashboardæ—¶ä½¿ç”¨</span>
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IjhNbjY3S1FMRFhHUkNBS2pYMmE3UHpuZmk4NEEzODJqbWxjUHZ4Mk1xMnMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbDQ5dmoiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiZTFiZGNiYmMtNWQ0My00NzljLWJlNmQtNTA4OTYwNDEzYjZhIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXM
ca.crt:     1025 bytes
namespace:  20 bytes

</code></pre></div></div>

<p>ç»§ç»­è¿›è¡Œç™»é™†
å¯ä»¥çœ‹åˆ°ç™»é™†é¢æ¿</p>

<p>å¦‚æœæƒ³çœ‹åˆ°æ‰€æœ‰ï¼Œéœ€è¦åˆ›å»ºadminè´¦å·ï¼Œ è¯¦è§ï¼š<a href="https://blog.csdn.net/LoveyourselfJiuhao/article/details/91044268">K8Så…³äºDashboardæµè§ˆå™¨è®¿é—®å¡«å‘</a></p>

:ET