I"Ûi<blockquote>
  <p>2019-09-23: 16:48:53</p>
</blockquote>

<h1 id="linux-ç¨‹åºè®¾è®¡-é˜…è¯»ç¬”è®°äº”">Linux ç¨‹åºè®¾è®¡ é˜…è¯»ç¬”è®°(äº”)</h1>

<h2 id="å‚è€ƒé“¾æ¥">å‚è€ƒé“¾æ¥ï¼š</h2>

<ul>
  <li><a href="https://www.kernel.org/doc/Documentation/">Linuxå†…æ ¸æ–‡æ¡£é¦–é¡µ</a></li>
  <li><a href="https://linux.die.net/">Linuxæ–‡æ¡£</a></li>
  <li><a href="https://legacy.gitbook.com/book/wizardforcel/linux-c-api-ref/details">Linux c å¼€å‘æ‰‹å†Œ</a></li>
  <li><a href="https://www.kernel.org/doc/htmldocs/kernel-api/index.html">Linux Kernel API</a></li>
  <li><a href="http://www.wrox.com/WileyCDA/WroxTitle/Beginning-Linux-Programming-4th-Edition.productCd-0470147628,descCd-DOWNLOAD.html">ä¹¦ä¸­ä»£ç åœ°å€</a></li>
  <li><a href="https://www.cs.cmu.edu/afs/cs/academic/class/15492-f07/www/pthreads.html">POSIX thread (pthread) libraries</a></li>
</ul>

<h2 id="ç¬¬-15-ç« -å¥—æ¥å­—socket">ç¬¬ 15 ç«  å¥—æ¥å­—(socket)</h2>

<p>socketæ˜¯ç®¡é“æ¦‚å¿µçš„ä¸€ä¸ªå»“é•‡ã€‚ä½¿ç”¨ä¸ç®¡é“ç±»ä¼¼çš„æ–¹æ³•æ¥ä½¿ç”¨å¥—æ¥å­—ï¼Œå¥—æ¥å­—ä¸­è¿˜åŒ…æ‹¬äº†è®¡ç®—æœºç½‘ç»œä¸­çš„é€šä¿¡ã€‚
æœ¬ç« ä¸»è¦å†…å®¹ï¼š</p>

<ul>
  <li>å¥—æ¥å­—é“¾æ¥çš„å·¥ä½œåŸç†</li>
  <li>å¥—æ¥å­—çš„å±æ€§ã€åœ°å€å’Œé€šä¿¡</li>
  <li>ç½‘ç»œä¿¡æ¯å’Œäº’è”ç½‘å®ˆæŠ¤è¿›ç¨‹(inetf/xinetd)</li>
  <li>å®¢æˆ·å’ŒæœåŠ¡å™¨</li>
</ul>

<h3 id="151-ä»€ä¹ˆæ˜¯å¥—æ¥å­—">15.1 ä»€ä¹ˆæ˜¯å¥—æ¥å­—</h3>

<p>å¥—æ¥å­—(socket)æ˜¯ä¸€ç§é€šä¿¡æœºåˆ¶ï¼Œå®¢æˆ·ç«¯/æœåŠ¡å™¨ç³»ç»Ÿçš„å¼€å‘å·¥ä½œæ—¢å¯ä»¥åœ¨æœ¬åœ°è¿›è¡Œï¼Œä¹Ÿå¯ä»¥è·¨ç½‘ç»œè¿›è¡Œã€‚socketæ˜ç¡®çš„å°†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒºåˆ†å¼€æ¥ï¼Œè¿™ä¹Ÿæ˜¯socketåŒºåˆ«äºç®¡é“é€šä¿¡çš„åœ°æ–¹ã€‚</p>

<h3 id="152-socketè¿æ¥">15.2 socketè¿æ¥</h3>

<ol>
  <li>æœåŠ¡å™¨åº”ç”¨ç¨‹åºç”¨ç³»ç»Ÿè°ƒç”¨socketæ¥åˆ›å»ºä¸€ä¸ªsocketå¥—æ¥å­—ã€‚å®ƒæ˜¯ç³»ç»Ÿåˆ†é…ä¸ªè¯¥æœåŠ¡å™¨è¿›ç¨‹çš„ç±»ä¼¼æ–‡ä»¶æè¿°ç¬¦çš„èµ„æºï¼Œä¸èƒ½ä¸å…¶å®ƒè¿›è¡Œå…±äº«ã€‚</li>
  <li>æœåŠ¡å™¨ä¼šç»™socketèµ·ä¸€ä¸ªåå­—ï¼Œæœ¬åœ°socketåç§°æ˜¯Linuxæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶åã€‚ä¸€èˆ¬æ”¾åœ¨/tmpæˆ–è€…/usr/tmpç›®å½•ä¸­ã€‚Linuxå°†è¿›å…¥çš„ç‰¹å®šç«¯å£å·çš„è¿æ¥è½¬æ¥åˆ°æ­£ç¡®çš„æ‹‚å»å…¶è¿›ç¨‹ã€‚æœåŠ¡å™¨ç³»ç»Ÿä½¿ç”¨bindæ¥ç»™å¥—æ¥å­—å‘½åï¼Œç„¶åæœåŠ¡å™¨è¿›ç¨‹å°±å¼€å§‹ç­‰å¾…å®¢æˆ·è¿æ¥åˆ°å‘½åå¥—æ¥å­—ã€‚ç³»ç»Ÿä½¿ç”¨listenåˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—å¹¶å°†å…¶ç”¨äºå­˜æ”¾æ¥è‡ªå®¢æˆ·ç«¯çš„æ¥å…¥è¿æ¥ã€‚æ¡ç”¨acceptæ¥æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ã€‚</li>
  <li>æœåŠ¡å™¨è°ƒç”¨acceptæ—¶ï¼Œæ–°å»ºä¸€ä¸ªä¸ç‰¹å®šå®¢æˆ·ç«¯ç›¸å…³çš„æ–°çš„å¥—æ¥å­—æ¥æ–¹ä¾¿é€šä¿¡ã€‚</li>
</ol>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æœ¬åœ°å®¢æˆ·ç«¯</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*  Make the necessary includes and set up the variables.  */</span>

<span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;sys/un.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//å£°æ˜sockfdæ–‡ä»¶æè¿°ç´¢å¼•</span>

    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
    <span class="c1">//å£°æ˜åœ°å€</span>

    <span class="k">struct</span> <span class="nc">sockaddr_un</span> <span class="n">address</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="sc">'A'</span><span class="p">;</span>
    <span class="c1">//åˆ›å»ºsocket</span>

    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">//è®¾ç½®socketåç§°ï¼Œä½œä¸ºæœåŠ¡å™¨è¯·æ±‚å’Œç­”åº”</span>

    <span class="n">address</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">address</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">"server_socket"</span><span class="p">);</span>
    <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
    <span class="c1">//å°†æˆ‘ä»¬çš„å¥—æ¥å­—è¿æ¥åˆ°æœåŠ¡å™¨çš„å¥—æ¥å­—ä¸Š</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"oops: client1"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//é€šè¿‡sockfdè¿›è¡Œè¯»å†™</span>
    <span class="n">write</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="c1">//è¾“å‡ºè·å–çš„ä¿¡æ¯</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"char from server = %c</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
    <span class="c1">//å…³é—­è¿æ¥</span>

    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>server1.cæœåŠ¡å™¨åˆ›å»º</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*  Make the necessary includes and set up the variables.  */</span>

<span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;sys/un.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">server_sockfd</span><span class="p">,</span> <span class="n">client_sockfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">server_len</span><span class="p">,</span> <span class="n">client_len</span><span class="p">;</span>
    <span class="c1">//æœåŠ¡å™¨address</span>

    <span class="k">struct</span> <span class="nc">sockaddr_un</span> <span class="n">server_address</span><span class="p">;</span>
    <span class="c1">//å®¢æˆ·ç«¯åœ°å€</span>

    <span class="k">struct</span> <span class="nc">sockaddr_un</span> <span class="n">client_address</span><span class="p">;</span>
    <span class="c1">//è¿™é‡Œåˆ é™¤ä»¥å‰çš„å¥—æ¥å­—ï¼Œä¸ºæœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªæœªå‘½åçš„å¥—æ¥å­—</span>

    <span class="n">unlink</span><span class="p">(</span><span class="s">"server_socket"</span><span class="p">);</span>
	<span class="c1">//æ³¨æ„è¿™é‡Œæ˜¯UNIXåŸŸå¥—æ¥å­—</span>
    <span class="n">server_sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_UNIX</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">//å¯¹å¥—æ¥å­—è¿›è¡Œå‘½å</span>

    <span class="n">server_address</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_UNIX</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">server_address</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="s">"server_socket"</span><span class="p">);</span>
    <span class="n">server_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_address</span><span class="p">);</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_address</span><span class="p">,</span> <span class="n">server_len</span><span class="p">);</span>
    <span class="c1">//åˆ›å»ºä¸€ä¸ªè¿æ¥é˜Ÿåˆ—ï¼Œå¼€å§‹ç­‰å¾…å®¢æˆ·è¿›è¡Œè¿æ¥</span>

    <span class="n">listen</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
    <span class="c1">//å¾ªç¯ç­‰å¾…</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"server waiting</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="c1">//è·å–clienté•¿åº¦</span>

        <span class="n">client_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_address</span><span class="p">);</span>
        <span class="c1">//æ¥æ”¶ä¸€ä¸ªclientå®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶äº§ç”Ÿä¸€ä¸ªå¥—æ¥å­—æ–‡ä»¶</span>

        <span class="n">client_sockfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_len</span><span class="p">);</span>
        <span class="c1">//client_sockfdå¥—æ¥å­—ä¸Šçš„å®¢æˆ·ç«¯è¿›è¡Œè¯»å†™æ“ä½œã€‚</span>

        <span class="n">read</span><span class="p">(</span><span class="n">client_sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">ch</span><span class="o">++</span><span class="p">;</span>
        <span class="n">write</span><span class="p">(</span><span class="n">client_sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="c1">//å…³é—­å®¢æˆ·ç«¯è¿æ¥</span>

        <span class="n">close</span><span class="p">(</span><span class="n">client_sockfd</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åœ¨å¯åŠ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨<code class="language-plaintext highlighter-rouge">./server1 &amp;</code> å’Œ<code class="language-plaintext highlighter-rouge">./clinet1</code>ã€‚è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server waiting
char from server <span class="o">=</span> B

</code></pre></div></div>
<p>æ³¨æ„ç”¨å®Œä¸€ä¸ªå¥—æ¥å­—åï¼Œå°±åº”è¯¥æŠŠå®ƒåˆ é™¤æ‰ï¼Œå³ä½¿æ˜¯åœ¨ç¨‹åºå› æ¥å—åˆ°ä¸€ä¸ªä¿¡å·è€Œå¼‚å¸¸ç»ˆæ­¢çš„æƒ…å†µä¸‹ã€‚</p>

<h4 id="1521-å¥—æ¥å­—socketå±æ€§">15.2.1 å¥—æ¥å­—(socket)å±æ€§</h4>

<p>socketçš„ä¸»è¦å±æ€§å¦‚ä¸‹ï¼š</p>

<ol>
  <li>åŸŸ(domain):æŒ‡å®šsocketé€šä¿¡ä¸­ä½¿ç”¨çš„ç½‘ç»œä»‹è´¨ã€‚å¸¸è§çš„å¥—æ¥å­—åŸŸæ˜¯<code class="language-plaintext highlighter-rouge">AF_INET</code>ï¼Œè¡¨ç¤ºInternetç½‘ç»œåè®®ã€‚å…¶åº•å±‚çš„åè®®â€“ç½‘é™…åè®®(IP)åªæœ‰ä¸€ä¸ªåœ°å€æ—ã€‚å¸¸ç”¨æœåŠ¡ç«¯å£å·é€šå¸¸å°äº1024,æœ‰:æ‰“å°æœºç¼“å†²é˜Ÿåˆ—è¿›ç¨‹(515)ã€rlogin(513)ã€ftp(21)å’Œhttpd(80)ç­‰ã€‚å°äº1024çš„ç«¯å£éƒ½æ˜¯ä¸ºç³»ç»ŸæœåŠ¡ä¿ç•™çš„ã€‚å¹¶ä¸”æ‰€æœ‰æœåŠ¡çš„è¿›ç¨‹å¿…é¡»å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™ã€‚åœ¨netdb.hä¸­å®šä¹‰äº†ä¸€ä¸ªå¸¸é‡<code class="language-plaintext highlighter-rouge">IPPORT_RESERVED</code>ï¼Œä»£è¡¨ä¿ç•™ç«¯å£å·çš„æœ€å¤§å€¼ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">AF_UNIX</code>è¡¨ç¤ºUNIXæ–‡ä»¶ç³»ç»ŸåŸŸ</li>
  <li>ç±»å‹(type):å› ä¸ºInternetç½‘ä¸­æä¾›äº†ä¸¤ç§ä¸åŒçš„é€šä¿¡æœºåˆ¶:æµ(stream)å’Œæ•°æ®æŠ¥(datagram)ï¼Œå› æ­¤è¿™é‡Œä¹Ÿæä¾›äº†ä¸¤ç§æˆªç„¶ä¸åŒçš„å¥—æ¥å­—ç±»å‹ã€‚
    <ol>
      <li>æµå¥—æ¥å­—:æä¾›ä¸€ä¸ªæœ‰åºã€å¯é ã€åŒå‘å­—èŠ‚æµçš„è¿æ¥ã€‚å‘é€å‡ºå»çš„æ•°æ®å¯ä»¥ç¡®ä¿ä¸ä¼šä¸¢å¤±ã€å¤åˆ¶æˆ–è€…ä¹±åºåˆ°è¾¾ã€‚é”™è¯¯ä¸ä¼šè¢«æ˜¾ç¤ºã€‚ä¸»è¦ç”±<code class="language-plaintext highlighter-rouge">SOCK_STREAM</code>æŒ‡å®šï¼Œåœ¨AF_INETåŸŸä¸­ï¼Œé€šè¿‡TCP/IPè¿æ¥å®ç°ã€‚</li>
      <li>æ•°æ®æŠ¥å¥—æ¥å­—ï¼šç”±<code class="language-plaintext highlighter-rouge">SOCK_DGRAM</code>æŒ‡å®šï¼Œä¸å»ºç«‹å’Œç»´æŒä¸€ä¸ªè¿æ¥ã€‚æ•°æ®æŠ¥é•¿åº¦æœ‰é™åˆ¶ï¼Œæ•°æ®æŠ¥ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ç½‘ç»œæ¶ˆæ¯è¢«ä¼ è¾“ã€‚å­˜åœ¨é”™è¯¯ã€‚ä¸»è¦ç”±UDP/IPè¿æ¥å®ç°çš„ã€‚ä½†æ˜¯å¼€é”€å°ã€‚ä¸éœ€è¦ç»´æŒç½‘ç»œè¿æ¥ã€‚é€Ÿåº¦è¾ƒå¿«ã€‚</li>
    </ol>
  </li>
  <li>åè®®(protocol):åº•å±‚ä¼ è¾“æœºåˆ¶ï¼Œå…è®¸ä¸æ­¢ä¸€ä¸ªåè®®æ¥æä¾›è¦æ±‚çš„å¥—æ¥å­—ç±»å‹ã€‚</li>
</ol>

<h4 id="1522-åˆ›å»ºå¥—æ¥å­—">15.2.2 åˆ›å»ºå¥—æ¥å­—</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">domain</span><span class="p">,</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span><span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">domain</code>æŒ‡å®šåè®®æ—(INET/UNIX)ï¼Œtypeå‚æ•°æŒ‡å®šé€šä¿¡ç±»å‹(SOCK_STREAM/SOCK_DGRAM);protocolæŒ‡å®šåè®®ç±»å‹</p>

<p>domainå‚æ•°å¯ä»¥æŒ‡å®šçš„åè®®æ—å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-23-20-45-18.png" alt="" /></p>

<h4 id="1523-å¥—æ¥å­—åœ°å€">15.2.3 å¥—æ¥å­—åœ°å€</h4>

<p><code class="language-plaintext highlighter-rouge">AF_UNIX</code>åœ°å€ç»“æ„ç”±<code class="language-plaintext highlighter-rouge">sockaddr_un</code>æ¥æè¿°ï¼Œè¯¥ç»“æ„å®šä¹‰å­å•Šå¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">sys/un.h</code>ä¸­</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">sockaddr_un</span>
  <span class="p">{</span>
    <span class="n">sa_family_t</span> <span class="n">sun_family</span><span class="p">;</span>
    <span class="cm">/* Path name.  */</span>

    <span class="kt">char</span> <span class="n">sun_path</span><span class="p">[];</span>
  <span class="p">};</span>
<span class="c1">//ä¸‹é¢æ˜¯Ubuntu16.04 ä¸­çš„ç›¸å…³å®šä¹‰</span>

<span class="k">struct</span> <span class="n">sockaddr_un</span>
  <span class="p">{</span>
    <span class="n">__SOCKADDR_COMMON</span> <span class="p">(</span><span class="n">sun_</span><span class="p">);</span>
    <span class="cm">/* Path name.  */</span>

    <span class="kt">char</span> <span class="n">sun_path</span><span class="p">[</span><span class="mi">108</span><span class="p">];</span>
  <span class="p">};</span>
</code></pre></div></div>

<p>å¦‚ä¸Šæ‰€ç¤ºLinuxè§„å®šé•¿åº¦æ˜¯108ä¸ªå­—ç¬¦ã€‚</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">AF_INET</code>ä¸­ï¼Œåœ°å€ç»“æ„ç”±<code class="language-plaintext highlighter-rouge">sockaddr_in</code>æ¥æŒ‡å®šï¼Œè¯¥ç»“æ„å®šä¹‰åœ¨å¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">netinet/in.h</code>ä¸­ï¼Œå®ƒè‡³å°‘åŒ…æ‹¬ä»¥ä¸‹å‡ é¡¹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">sockaddr_in</span><span class="p">{</span>
    <span class="kt">short</span> <span class="kt">int</span>           <span class="n">sin_family</span><span class="p">;</span>     <span class="cm">/*AF_INET*/</span>
    <span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span>  <span class="n">sin_port</span><span class="p">;</span>       <span class="cm">/*Port number*/</span>
    <span class="k">struct</span> <span class="n">in_addr</span>      <span class="n">sin_addr</span><span class="p">;</span>       <span class="cm">/*Internet address*/</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ipåœ°å€ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">uint32_t</span> <span class="n">in_addr_t</span><span class="p">;</span><span class="cm">/* ä¸€ä¸ªå››å­—èŠ‚çš„æè¿°ç¬¦ */</span>
<span class="k">struct</span> <span class="n">in_addr</span>
  <span class="p">{</span>
    <span class="n">in_addr_t</span> <span class="n">s_addr</span><span class="p">;</span>
  <span class="p">};</span>
</code></pre></div></div>

<h4 id="1524-å‘½åå¥—æ¥å­—">15.2.4 å‘½åå¥—æ¥å­—</h4>

<p>ä½¿ç”¨bindå‡½æ•°å¯ä»¥è®©åˆ›å»ºçš„å¥—æ¥å­—å¯ä»¥è¢«å…¶å®ƒè¿›ç¨‹ä½¿ç”¨ï¼ŒæœåŠ¡å™¨ç¨‹åºå¿…é¡»ç»™å¥—æ¥å­—å‘½åã€‚è¿™æ ·<code class="language-plaintext highlighter-rouge">AF_UNIX</code>å¥—æ¥å­—å°±ä¼šå…³è”åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„è·¯å¾„åã€‚AF_INETå°±ä¼šå…³è”åˆ°ä¸€ä¸ªIPç«¯å£å·ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="kt">int</span> <span class="nf">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">address_len</span><span class="p">);</span>
</code></pre></div></div>
<p>bindå°†addressä¸­çš„åœ°å€åˆ†é…ç»™ä¸æ–‡ä»¶æè¿°ç¬¦socketå…³è”çš„æœªå‘½åå¥—æ¥å­—ã€‚åœ°å€é•¿åº¦ç”±address_lenä¼ é€’ã€‚</p>

<p><strong>åœ°å€çš„é•¿åº¦å’Œæ ¼å¼å–å†³äºåœ°å€æ—</strong>ï¼Œç„¶åbindè°ƒç”¨ä¸€ä¸ªç‰¹å®šçš„åœ°å€ç»“æ„æŒ‡é’ˆè½¬æ¢ä¸ºæŒ‡å‘é€šç”¨çš„åœ°å€ç±»å‹(struct sockaddr*);è°ƒç”¨æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œå¹¶è®¾ç½®errnoä¸ºè¡¨15-2ä¸­çš„ä¸€ä¸ªå€¼</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-23-21-07-48.png" alt="å¥—æ¥å­—åŸŸå’Œé”™è¯¯ç " /></p>

<h4 id="1525-åˆ›å»ºå¥—æ¥å­—é˜Ÿåˆ—">15.2.5 åˆ›å»ºå¥—æ¥å­—é˜Ÿåˆ—</h4>

<p>æœåŠ¡å™¨ç¨‹åºå¿…é¡»åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜æœªå¤„ç†çš„è¯·æ±‚ã€‚ä½¿ç”¨<code class="language-plaintext highlighter-rouge">listen</code>ç³»ç»Ÿè°ƒç”¨æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span><span class="kt">int</span> <span class="n">backlog</span><span class="p">)</span>
</code></pre></div></div>

<p>backlogè®¾ç½®æ¥æ”¶é˜Ÿåˆ—é•¿åº¦çš„å€¼ã€‚Linuxç³»ç»Ÿä¸­ä¹Ÿå¯¹å¯ä»¥å®¹çº³çš„æœªå¤„ç†è¿æ¥çš„æœ€å¤§æ•°ç›®åšå‡ºé™åˆ¶ã€‚å¤šå‡ºçš„è¿æ¥å°†è¢«æ‹’ç»ã€‚å¸¸ç”¨å‚æ•°å€¼æ˜¯5ã€‚</p>

<h4 id="1526-æ¥å—è¿æ¥">15.2.6 æ¥å—è¿æ¥</h4>

<p>æœåŠ¡å™¨é€šè¿‡acceptæ¥å—æ¥è‡ªå®¢æˆ·çš„ç­‰å¾…é˜Ÿåˆ—çš„äº‹ä»¶å¤„ç†å’Œè¿æ¥:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="kt">size_t</span> <span class="o">*</span><span class="n">address_len</span><span class="p">);</span>
</code></pre></div></div>

<p>acceptåªæœ‰å½“æ’é˜Ÿçš„ç¬¬ä¸€ä¸ªæœªå¤„ç†ç¨‹åºï¼Œè¯•å›¾è¿æ¥åˆ°ç”±socketå‚æ•°æŒ‡å®šçš„å¥—æ¥å­—ä¸Šæ—¶æ‰è¿”å›ã€‚acceptå‡½æ•°å°†åˆ›å»ºä¸€ä¸ªæ–°å¥—æ¥å­—æ¥ä¸è¯¥å®¢æˆ·è¿›è¡Œé€šä¿¡ï¼Œå¹¶è¿”å›æ–°å¥—æ¥å­—çš„æè¿°ç¬¦ã€‚æ–°å¥—æ¥å­—çš„ç±»å‹å’ŒæœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—ç±»å‹æ˜¯ä¸€æ ·çš„ã€‚</p>

<p><strong>æ³¨æ„ï¼šå¥—æ¥å­—å¿…é¡»äº‹å…ˆbindè°ƒç”¨å‘½åï¼Œå¹¶ä¸”ç”±listenè°ƒç”¨åˆ†é…ç»™å®ƒä¸€ä¸ªè¿æ¥é˜Ÿåˆ—ã€‚</strong> è¿æ¥å®¢æˆ·æ®µçš„ä¹‹åœ°å°†è¢«æ”¾å…¥addresså‚æ•°æŒ‡å‘çš„sockaddrç»“æ„ä¸­ã€‚ä¹Ÿå¯ä»¥å°†å…¶æŒ‡å®šä¸ºç©ºã€‚</p>

<p>å‚æ•°address_lenæŒ‡å®šå®¢æˆ·åœ°å€ç»“æ„çš„é•¿åº¦ï¼Œè¶…è¿‡åˆ™ä¼šè¢«æˆªæ–­ã€‚å› æ­¤address_lenå¿…é¡»è¢«è®¾ç½®ä¸ºé¢„æœŸçš„åœ°å€é•¿åº¦ã€‚å½“è°ƒç”¨è¿”å›æ—¶ï¼Œé•¿åº¦ä¼šè¢«è®¾ç½®æˆå®¢æˆ·åœ°å€ç»“æ„çš„å®é™…é•¿åº¦ã€‚</p>

<p>å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œè´¼acceptå°†ä¼šé˜»å¡(ç¨‹åºå°†æš‚åœ)ç›´åˆ°æœ‰å®¢æˆ·å»ºç«‹è¿æ¥ä¸ºæ­¢ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦è®¾ç½®<code class="language-plaintext highlighter-rouge">O_NONBLOCK</code>æ ‡å¿—æ¥æ”¹å˜è¿™ä¸ªè¡Œä¸ºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="n">flags</span><span class="o">=</span><span class="n">fcntl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="n">F_GETFL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fcntl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="n">F_SETFL</span><span class="p">,</span><span class="n">O_NONBLOCK</span><span class="o">|</span><span class="n">flags</span><span class="p">);</span>
</code></pre></div></div>

<p>å½“æœ‰æœªå¤„ç†çš„å®¢æˆ·è¿æ¥æ—¶ï¼Œacceptå‡½æ•°å°†è¿”å›ä¸€ä¸ªæ–°çš„å¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ã€‚å‘ç”Ÿé”™è¯¯æ—¶è¿”å›-1ï¼Œ<code class="language-plaintext highlighter-rouge">O_NONBLOCK</code>å¯¹åº”<code class="language-plaintext highlighter-rouge">EWOULDBLOCK</code>é”™è¯¯ï¼Œåè€…æ˜¯å½“è¿›ç¨‹é˜»å¡åœ¨acceptè°ƒç”¨æ—¶ï¼Œæ‰§è¡Œè¢«ä¸­æ–­è€Œäº§ç”Ÿçš„é”™è¯¯ã€‚</p>

<h4 id="1527-è¯·æ±‚è¿æ¥">15.2.7 è¯·æ±‚è¿æ¥</h4>

<p>å®¢æˆ·ç«¯ä½¿ç”¨æœªå‘½åå¥—æ¥å­—å’ŒæœåŠ¡å™¨ç›‘å¬å¥—æ¥å­—ä¹‹é—´å»ºç«‹è¿æ¥çš„æ–¹æ³•æ¥è¿æ¥åˆ°æœåŠ¡å™¨ã€‚å®ƒä»¬é€šè¿‡connectè°ƒç”¨æ¥å®Œæˆè¿™ä¸ªå·¥ä½œã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="kt">int</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">address_len</span><span class="p">);</span>
</code></pre></div></div>
<p>socketæŒ‡å®šçš„å¥—æ¥å­—æ˜¯é€šè¿‡socketè°ƒç”¨è·å¾—çš„ä¸€ä¸ªæœ‰æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦ã€‚connectè°ƒç”¨æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1.å¯èƒ½çš„é”™è¯¯ä»£ç å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-24-10-14-07.png" alt="å¯èƒ½å­˜åœ¨çš„é”™è¯¯ç " /></p>

<p>å¦‚æœä¸èƒ½ç«‹åˆ»å»ºç«‹è¿æ¥ï¼Œconnectå°†è°ƒç”¨é˜»å¡ä¸€æ®µä¸ç¡®å®šçš„æ—¶é—´ã€‚ä¸€æ—¦è¶…è¿‡è¿™ä¸ªæ—¶é—´åˆ°è¾¾ï¼Œè¿æ¥å°†è¢«æ”¾å¼ƒã€‚connectè°ƒç”¨å¤±è´¥ã€‚ä½†å¦‚æœè¿æ¥è¢«ä¿¡å·ä¸­æ–­ï¼Œè¯¥ä¿¡å·åˆå¾—åˆ°äº†å¤„ç†ï¼Œconnectè°ƒç”¨è¿˜æ˜¯ä¼šå¤±è´¥ï¼Œä½†æ˜¯è¿æ¥å°è¯•å¹¶ä¸ä¼šè¢«æ”¾å¼ƒã€‚è€Œæ˜¯ä»¥å¼‚æ­¥çš„æ–¹å¼ç»§ç»­å»ºç«‹ã€‚</p>

<h4 id="1528-å…³é—­å¥—æ¥å­—">15.2.8 å…³é—­å¥—æ¥å­—</h4>

<p>ä½¿ç”¨closeæ¥å…³é—­å¥—æ¥å­—ã€‚æœåŠ¡å™¨readè¿”å›0æ—¶å…³é—­å¥—æ¥å­—;ä½†å¦‚æœå¥—æ¥å­—æ˜¯ä¸€ä¸ªé¢å‘è¿æ¥ç±»å‹çš„ï¼Œå¹¶ä¸”è®¾ç½®äº†SOCK_LINGERé€‰é¡¹ï¼Œcloseè°ƒç”¨ä¼šåœ¨è¯¥å¥—æ¥å­—è¿˜æœ‰æœªä¼ è¾“æ•°æ®æ—¶é˜»å¡ã€‚</p>

<h4 id="1529-å¥—æ¥å­—é€šä¿¡">15.2.9 å¥—æ¥å­—é€šä¿¡</h4>

<p>åº”è¯¥å°½é‡ä½¿ç”¨ç½‘ç»œsocketï¼Œæ–‡ä»¶ç³»ç»Ÿçš„socketçš„ç¼ºç‚¹æ˜¯ï¼Œæ“ä½œç³»ç»Ÿåˆ›å»ºçš„å¥—æ¥å­—å°†åˆ›å»ºå­å•ŠæœåŠ¡å™¨ç¨‹åºçš„å½“å‰ç›®å½•ä¸‹ã€‚å¯¹äºç½‘è·¯socketåªéœ€è¦é€‰æ‹©ä¸€ä¸ªæœªè¢«ä½¿ç”¨çš„ç«¯å£å·å³å¯ã€‚</p>

<p>ç«¯å£å·ä»¥åŠå®ƒä»¬æä¾›çš„æœåŠ¡é€šå¸¸éƒ½åˆ—åœ¨ç³»ç»Ÿæ–‡ä»¶<code class="language-plaintext highlighter-rouge">/etc/services</code>ä¸­ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¿®æ”¹è¿‡çš„å®¢æˆ·ç«¯ç¨‹åºclient2.cï¼Œå®ƒé€šè¿‡å›è·¯ç½‘ç»œè¿æ¥åˆ°ä¸€ä¸ªç½‘ç»œå¥—æ¥å­—ã€‚è¿™ä¸ªç¨‹åºæœ‰ä¸€ä¸ªç¡¬ä»¶ç›¸å…³çš„ç»†å¾®é”™è¯¯ï¼Œæˆ‘ä»¬å°†åœ¨æœ¬ç« çš„åé¢å†è®¨è®ºå®ƒ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="cp">#include &lt;arpa/inet.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">address</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">ch</span><span class="o">=</span><span class="sc">'A'</span><span class="p">;</span>
  <span class="c1">//ä¸ºå®¢æˆ·åˆ›å»ºä¸€ä¸ªsocket</span>

  <span class="n">sockfd</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="c1">//å‘½åå¥—æ¥å­—ï¼Œä¸æœåŠ¡å™¨ä¿æŒä¸€è‡´</span>

  <span class="n">address</span><span class="p">.</span><span class="n">sin_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>
  <span class="n">address</span><span class="p">.</span><span class="n">sin_port</span><span class="o">=</span><span class="mi">9734</span><span class="p">;</span>
  <span class="n">len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™ä¸ªç¨‹åºä¼šæŸ¥æ‰¾æœ¬åœ°çš„9734ç«¯å£ã€‚</p>

<p>æœåŠ¡å™¨ç«¯(server2.c)éœ€è¦æ·»åŠ çš„è®¾ç½®å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="cp">#include &lt;arpa/inet.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">server_sockfd</span><span class="p">,</span><span class="n">client_sockfd</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">server_len</span><span class="p">,</span><span class="n">client_len</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_address</span><span class="p">;</span>
  <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>
  <span class="c1">//åˆ›å»ºä¸€ä¸ªæœªå‘½åçš„å¥—æ¥å­—</span>

  <span class="n">server_sockfd</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  <span class="c1">//è®¾ç½®å¥—æ¥å­—åå­—</span>

  <span class="n">server_address</span><span class="p">.</span><span class="n">sin_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">;</span>
  <span class="n">server_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>
  <span class="n">server_address</span><span class="p">.</span><span class="n">sin_port</span><span class="o">=</span><span class="mi">9734</span><span class="p">;</span>
  <span class="n">server_len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">server_address</span><span class="p">);</span>
  <span class="n">bind</span><span class="p">(</span><span class="n">server_socked</span><span class="p">,(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_address</span><span class="p">,</span><span class="n">server_len</span><span class="p">);</span>

<span class="p">}</span>

</code></pre></div></div>

<h3 id="15210-ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº">15.2.10 ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº</h3>

<p>å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">netstat</code>å‘½ä»¤æ¥æŸ¥çœ‹ç½‘ç»œè¿æ¥çŠ¶å†µã€‚</p>

<h3 id="153-ç½‘ç»œä¿¡æ¯">15.3 ç½‘ç»œä¿¡æ¯</h3>

<p>ä¸€èˆ¬å¯ä»¥é€šè¿‡ç½‘ç»œä¿¡æ¯å‡½æ•°å†³å®šåº”è¯¥ä½¿ç”¨çš„åœ°å€å’Œç«¯å£å·</p>

<p>å¯ä»¥å°†è‡ªå·±çš„æœåŠ¡æ·»åŠ åˆ°/etc/servicesæ–‡ä»¶ä¸­çš„å·²çŸ¥æœåŠ¡åˆ—è¡¨ä¸­ã€‚å¹¶ä¸”åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¸ºç«¯å£å·åˆ†é…ä¸€ä¸ªåå­—ï¼Œä½¿ç”¨æˆ·å¯ä»¥ä½¿ç”¨ç¬¦å·åŒ–çš„æœåŠ¡åå­—è€Œä¸æ˜¯ç«¯å£å·çš„åå­—ã€‚</p>

<p>ä¸»å¥åœ°å€æ˜ å°„å‡½æ•°å®šä¹‰åœ¨netdb.hä¸­ï¼Œå‡½æ•°æ¥å£å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="cm">/* æŸ¥è¯¢hoståœ°å€ */</span>

<span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="nf">gethostbyaddr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span><span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="nf">gethostbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="cm">/* æŸ¥è¯¢ç«¯å£å·ç›¸å…³ä¿¡æ¯ */</span>

<span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span><span class="nf">getservbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">proto</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span><span class="nf">getservbyport</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">proto</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿”å›çš„hostnetå’Œeventç»“æ„ä¸­è‡³å°‘åŒ…å«ä¸€ä¸‹å‡ ä¸ªæˆå‘˜:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">hostent</span><span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">h_name</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">h_aliases</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">h_addrtype</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">h_length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">servent</span><span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">s_name</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">s_aliases</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">s_port</span><span class="p">;</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">s_proto</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¦æŠŠè¿”å›çš„åœ°å€åˆ—è¡¨è½¬æ¢ä¸ºæ­£ç¡®çš„åœ°å€ç±»å‹ï¼Œå¹¶ç”¨å‡½æ•°<code class="language-plaintext highlighter-rouge">inet_ntoa</code>å°†å®ƒä»¬ä»ç½‘ç»œå­—èŠ‚åºè½¬æ¢ä¸ºå¯æ‰“å°çš„å­—ç¬¦ã€‚å‡½æ•°<code class="language-plaintext highlighter-rouge">inet_ntoa</code>çš„å®šä¹‰å¦‚ä¸‹ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;arpa/inet.h&gt;
</span><span class="c1">//å°†ä¸€ä¸ªintelä¸»æœºåœ°å€è½¬æ¢ä¸ºä¸€ä¸ªç‚¹å››å…ƒç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œå®ƒåœ¨å¤±è´¥æ—¶è¿”å›-1,</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">inet_ntoa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="n">in</span><span class="p">);</span>

<span class="cp">#include &lt;unistd.h&gt;
</span><span class="c1">//å°†å½“å‰ä¸»æœºçš„åå­—å†™å…¥nameæŒ‡å‘çš„å­—ç¬¦ä¸²ä¸­ã€‚ä¸»æœºåä»¥nullç»“å°¾ã€‚å‚æ•°namelengthæŒ‡å®šäº†å­—ç¬¦ä¸²nameçš„é•¿åº¦ã€‚å¦‚æœä¸»æœºåå¤ªé•¿ä¼šè¢«æˆªæ–­</span>

<span class="kt">int</span> <span class="nf">gethostname</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="kt">int</span> <span class="n">namelength</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸‹é¢ä½¿ç”¨getname.cæ¥è·å–ä¸€å°ä¸»æœºçš„ä¿¡æ¯</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*  As usual, make the appropriate includes and declare the variables.  */</span>

<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="cp">#include &lt;arpa/inet.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;netdb.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="o">**</span><span class="n">names</span><span class="p">,</span> <span class="o">**</span><span class="n">addrs</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span><span class="n">hostinfo</span><span class="p">;</span>

<span class="cm">/* å°†hostå˜é‡è®¾ç½®ä¸ºgetnameç¨‹åºæ‰€æä¾›çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œæˆ–é»˜è®¤è®¾ç½®ä¸ºç”¨æˆ·ä¸»æœºçš„ä¸»æœºå */</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">myname</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
        <span class="n">gethostname</span><span class="p">(</span><span class="n">myname</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">myname</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="cm">/* è°ƒç”¨gethostname,å¦‚æœæœªæ‰¾åˆ°ç›¸åº”çš„ä¿¡æ¯å°±æŠ¥å‘Šä¸€æ¡é”™è¯¯ */</span>

    <span class="n">hostinfo</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hostinfo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"cannot get info for host: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cm">/* æ˜¾ç¤ºä¸»æœºåå’Œå®ƒå¯èƒ½æœ‰çš„æ‰€æœ‰åˆ«å */</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"results for host %s:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Name: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hostinfo</span> <span class="o">-&gt;</span> <span class="n">h_name</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Aliases:"</span><span class="p">);</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">hostinfo</span> <span class="o">-&gt;</span> <span class="n">h_aliases</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">names</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">" %s"</span><span class="p">,</span> <span class="o">*</span><span class="n">names</span><span class="p">);</span>
        <span class="n">names</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

<span class="cm">/* å¦‚æœæŸ¥è¯¢çš„ä¸»æœºä¸æ˜¯ä¸€ä¸ªIPä¸»æœºï¼Œå°±å‘å‡ºè­¦å‘Šå¹¶é€€å‡º */</span>

    <span class="k">if</span><span class="p">(</span><span class="n">hostinfo</span> <span class="o">-&gt;</span> <span class="n">h_addrtype</span> <span class="o">!=</span> <span class="n">AF_INET</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"not an IP host!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cm">/* å¦åˆ™ï¼Œæ˜¾ç¤ºå®ƒçš„æ‰€æœ‰IPåœ°å€ */</span>

    <span class="n">addrs</span> <span class="o">=</span> <span class="n">hostinfo</span> <span class="o">-&gt;</span> <span class="n">h_addr_list</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">addrs</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">" %s"</span><span class="p">,</span> <span class="n">inet_ntoa</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">addrs</span><span class="p">));</span>
        <span class="n">addrs</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>



</code></pre></div></div>

<p>ä¸‹é¢æ˜¯è¿æ¥åˆ°æ ‡å‡†æœåŠ¡ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨çš„å½“å‰æ—¥æœŸå’Œæ—¶é—´</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cm">/* å‡†å¤‡å¿…è¦çš„å¤´æ–‡ä»¶ */</span>

<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="cp">#include &lt;netdb.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">address</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span><span class="n">hostinfo</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">servent</span> <span class="o">*</span><span class="n">servinfo</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">host</span> <span class="o">=</span> <span class="s">"localhost"</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

<span class="cm">/* æŸ¥æ‰¾hostå¯¹åº”çš„ä¿¡æ¯ */</span>

    <span class="n">hostinfo</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hostinfo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"no host: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">host</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

<span class="cm">/* æŸ¥æ‰¾ä¸»æœºæ—¶é—´æœåŠ¡ä¿¡æ¯ */</span>

    <span class="n">servinfo</span> <span class="o">=</span> <span class="n">getservbyname</span><span class="p">(</span><span class="s">"daytime"</span><span class="p">,</span> <span class="s">"tcp"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">servinfo</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"no daytime service</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"daytime port is %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">servinfo</span> <span class="o">-&gt;</span> <span class="n">s_port</span><span class="p">));</span>

<span class="cm">/* åˆ›å»ºä¸€ä¸ªsocket */</span>

    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* è®¾ç½®å¯¹åº”çš„è¿æ¥å‚æ•° */</span>

    <span class="n">address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">servinfo</span> <span class="o">-&gt;</span> <span class="n">s_port</span><span class="p">;</span>
    <span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">hostinfo</span> <span class="o">-&gt;</span> <span class="n">h_addr_list</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>

<span class="cm">/* è¿æ¥å¹¶ä¸”è·å–ç›¸å…³ä¿¡æ¯ */</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"oops: getdate"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">result</span><span class="p">]</span> <span class="o">=</span> <span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">4800</span><span class="err">@</span><span class="mi">41</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"read %d bytes: %s"</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="1531-å› ç‰¹ç½‘å®ˆæŠ¤è¿›ç¨‹xinetedinetd">15.3.1 å› ç‰¹ç½‘å®ˆæŠ¤è¿›ç¨‹(xineted/inetd)</h4>

<p>è¶…çº§æœåŠ¡ç¨‹åºåŒæ—¶ç›‘å¬è®¸å¤šç«¯å£åœ°å€ä¸Šçš„è¿æ¥ã€‚å½“æœ‰å®¢æˆ·ç«¯è¿æ¥åˆ°æŸé¡¹æœåŠ¡æ—¶ï¼Œå®ˆæŠ¤è¿›ç¨‹å°±è¿è¡Œç›¸åº”çš„æœåŠ¡å™¨ã€‚è¿™ä½¿å¾—é’ˆå¯¹å„é¡¹ç½‘ç»œæœåŠ¡çš„æœåŠ¡å™¨ä¸éœ€è¦ä¸€ç›´è¿è¡Œç€ã€‚å¯ä»¥åœ¨éœ€è¦æ—¶å¯åŠ¨ã€‚</p>

<p>å› ç‰¹ç½‘å®ˆæŠ¤è¿›ç¨‹åœ¨ç°ä»£linuxç³»ç»Ÿä¸­æ˜¯é€šè¿‡xinetdæ¥å®ç°çš„ã€‚xinetdå®ç°æ–¹å¼å–ä»£äº†åŸæ¥çš„UNIXçš„inetdã€‚å¯ä»¥ç›´æ¥ä¿®æ”¹<code class="language-plaintext highlighter-rouge">/etc/xinetd.conf</code>å’Œ<code class="language-plaintext highlighter-rouge">/etc/xinetd.d</code>ç›®å½•ä¸­çš„æ–‡ä»¶æ¥è¿›è¡Œé…ç½®ã€‚</p>

<h4 id="1532-å¥—æ¥å­—é€‰é¡¹">15.3.2 å¥—æ¥å­—é€‰é¡¹</h4>

<p>å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">setsocket</code>å‡½æ•°ç”¨äºæ§åˆ¶è¿™äº›é€‰é¡¹ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="kt">int</span> <span class="nf">setsocket</span><span class="p">(</span><span class="kt">int</span> <span class="n">socket</span><span class="p">,</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">int</span> <span class="n">option_name</span><span class="p">,</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">option_value</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">option_len</span><span class="p">);</span>
</code></pre></div></div>

<p>levelæ˜¯ç›¸å…³çš„åè®®ç­‰çº§ï¼Œæƒ³è¦æ­£å¸¸ä½¿ç”¨ï¼Œå¿…é¡»è®¾ç½®å¯¹åº”çš„ç¼–å·ã€‚option_nameå’Œoption_valueåˆ†åˆ«æŒ‡å‘éœ€è¦è®¾ç½®å‚æ•°åç§°å’Œå€¼ã€‚levelè®¾ç½®å‚æ•°å¦‚ä¸‹</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-25-22-16-47.png" alt="ç›¸å…³å‚æ•°è®¾ç½®" /></p>

<h4 id="1541-selectç³»ç»Ÿè°ƒç”¨">15.4.1 selectç³»ç»Ÿè°ƒç”¨</h4>

<p>åœ¨ç¼–å†™Linuxç¨‹åºæ—¶ï¼Œç»å¸¸ä¼šé‡åˆ°éœ€è¦æ£€æŸ¥é”®ç›˜ç­‰è®¾å¤‡çš„è¾“å…¥è€Œä¸å¾—ä¸è¿›è¡Œå¿™ç­‰å¾…å¾ªç¯ã€‚è¿™ç§æ¯”è¾ƒæ¶ˆè€—CPUæ—¶é—´ã€‚</p>

<p>selectç³»ç»Ÿè°ƒç”¨å…è®¸ç¨‹åºåŒæ—¶åœ¨å¤šä¸ªåº•å±‚æ–‡ä»¶æè¿°ç¬¦ä¸Šç­‰å¾…è¾“å…¥çš„åˆ°è¾¾ã€‚ä¸»è¦æ˜¯å¯¹æ•°æ®ç»“æ„<code class="language-plaintext highlighter-rouge">fd_set</code>è¿›è¡Œæ“ä½œï¼Œå®ƒæ˜¯ç”±æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ„æˆçš„é›†åˆã€‚æœ‰ä¸€ç»„å®šä¹‰å¥½çš„å®å¯ä»¥æ¥æ§åˆ¶è¿™ä¸ªé›†åˆã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/time.h&gt;
</span>
<span class="cm">/* å°†fd_setåˆå§‹åŒ–ä¸ºç©º */</span>
<span class="kt">void</span> <span class="nf">FD_ZERO</span><span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>
<span class="cm">/* æ¸…é™¤ä¼ é€’çš„æ–‡ä»¶ç¬¦ */</span>
<span class="kt">void</span> <span class="nf">FD_CLR</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>
<span class="cm">/* è®¾ç½®ä¼ é€’çš„æ–‡ä»¶ç¬¦ */</span>
<span class="kt">void</span> <span class="nf">FD_SET</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>
<span class="cm">/* æ£€æŸ¥fdè®¾ç½®çš„æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦æ˜¯fdseté›†åˆä¸­çš„å…ƒç´  */</span>
<span class="kt">void</span> <span class="nf">FD_ISSET</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">fdset</span><span class="p">);</span>
</code></pre></div></div>

<p>selectå‡½æ•°å¯ä»¥è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ¥é˜²æ­¢æ— é™æœŸçš„é˜»å¡ã€‚è¿™ä¸ªè¶…æ—¶å€¼ç”±ä¸€ä¸ªtimevalç»“æ„ç»™å‡ºã€‚è¿™ä¸ªç»“æ„å®šä¹‰åœ¨å¤´æ–‡ä»¶<code class="language-plaintext highlighter-rouge">sys/time.h</code>ä¸­ï¼Œå®ƒç”±ä»¥ä¸‹å‡ ä¸ªæˆå‘˜ç»„æˆ:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">timeval</span><span class="p">{</span>
    <span class="kt">time_t</span> <span class="n">tv_sec</span><span class="p">;</span> <span class="cm">/* seconds */</span>
    <span class="kt">long</span>   <span class="n">tv_usec</span><span class="p">;</span> <span class="cm">/* microseconds */</span>
<span class="p">}</span>
</code></pre></div></div>

<p>selectç³»ç»Ÿè°ƒç”¨çš„åŸå‹å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/time.h&gt;
</span>
<span class="kt">int</span> <span class="nf">select</span><span class="p">(</span><span class="kt">int</span> <span class="n">nfds</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">readfds</span><span class="p">,</span><span class="n">fd_set</span> <span class="o">*</span><span class="n">writefds</span><span class="p">,</span> <span class="n">fd_set</span> <span class="o">*</span><span class="n">errorfds</span><span class="p">,</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
</code></pre></div></div>

<p>nfdsæŒ‡å®šéœ€è¦æµ‹è¯•çš„æ–‡ä»¶æè¿°ç¬¦æ•°ç›®ï¼Œæµ‹è¯•çš„æè¿°ç¬¦èŒƒå›´ä»0åˆ°nfds-1ã€‚3ä¸ªæè¿°ç¬¦é›†åˆéƒ½å¯ä»¥è¢«è®¾ç½®ä¸ºç©ºæŒ‡é’ˆï¼Œè¿™è¡¨ç¤ºä¸æ‰§è¡Œç›¸åº”çš„æµ‹è¯•ã€‚</p>

<p>selectå‡½æ•°ä¼šåœ¨ä»¥ä¸‹æƒ…å†µæ—¶è¿”å›:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">readfds</code>ï¼šé›†åˆä¸­æœ‰æè¿°ç¬¦å¯è¯»</li>
  <li><code class="language-plaintext highlighter-rouge">writefds</code>ï¼šé›†åˆä¸­æœ‰æè¿°ç¬¦å¯å†™</li>
  <li><code class="language-plaintext highlighter-rouge">errorfds</code>ï¼šé›†åˆä¸­æœ‰æè¿°ç¬¦é‡åˆ°é”™è¯¯æ¡ä»¶</li>
</ul>

<p>å¦‚æœä»¥ä¸Šä¸‰ç§æ¡ä»¶éƒ½æ²¡æœ‰å‘ç”Ÿï¼Œselectå°†åœ¨timeoutæŒ‡å®šçš„è¶…æ—¶æ—¶é—´ç»è¿‡åè¿”å›ã€‚å¦‚æœtimeoutå‚æ•°æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆå¹¶ä¸”å¥—æ¥å­—ä¸Šä¹Ÿæ²¡æœ‰ä»»ä½•æ´»åŠ¨ï¼Œè¿™ä¸ªè°ƒç”¨å°†ä¸€ç›´é˜»å¡ä¸‹å»ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„selectè°ƒç”¨å®éªŒï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* å¼€å§‹å’Œå¿…è¦çš„å¤´æ–‡ä»¶ */</span>

<span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/time.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;fcntl.h&gt;
</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="n">nread</span><span class="p">;</span>

    <span class="n">fd_set</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">testfds</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">timeval</span> <span class="n">timeout</span><span class="p">;</span>

    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inputs</span><span class="p">);</span>
    <span class="n">FD_SET</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">inputs</span><span class="p">);</span>

<span class="cm">/*  è®¾ç½®æ ‡å‡†è¾“å…¥æœ€å¤šç­‰å¾…è¾“å…¥2.5s  */</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">testfds</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">;</span>
        <span class="n">timeout</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">timeout</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span>
        <span class="cm">/* è¿›è¡Œé€‰æ‹©ç­‰å¾…è¾“å…¥ */</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">FD_SETSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">testfds</span><span class="p">,</span> <span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>

<span class="cm">/*  ç»è¿‡è¿™æ®µæ—¶é—´ä¹‹åï¼Œå¯¹resultè¿›è¡Œæµ‹è¯•ã€‚å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œç¨‹åºå°†å†æ¬¡å¾ªç¯ï¼Œå‡ºç°ä¸€ä¸ªé”™è¯¯ï¼Œç¨‹åºå°†é€€å‡ºè¿è¡Œ  */</span>

        <span class="k">switch</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"timeout</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"select"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="cm">/* å¦‚æœåœ¨ç­‰å¾…æœŸé—´ï¼Œå¯¹æ–‡ä»¶æè¿°ç¬¦é‡‡å–äº†ä¸€äº›åŠ¨å˜´ï¼Œç¨‹åºå°†è¯»å–æ ‡å‡†è¾“å…¥stdinä¸Šçš„è¾“å…¥ï¼Œå¹¶åœ¨æ¥æ”¶åˆ°è¡Œå°¾å­—ç¬¦ä¹‹åå°†ä»–ä»¬éƒ½å›æ˜¾åˆ°å±å¹•ä¸Šã€‚ctrl+Dï¼Œå°±é€€å‡ºç¨‹åº */</span>

        <span class="nl">default:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">&amp;</span><span class="n">testfds</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">ioctl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">FIONREAD</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nread</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"keyboard done</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">nread</span><span class="p">);</span>
                <span class="n">buffer</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"read %d from keyboard: %s"</span><span class="p">,</span> <span class="n">nread</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="1542-å¤šå®¢æˆ·ç«¯">15.4.2 å¤šå®¢æˆ·ç«¯</h4>

<p>æœåŠ¡å™¨å¯ä»¥è®©selectè°ƒç”¨åŒæ—¶æ£€æŸ¥ç›‘å¬å¥—æ¥å­—å’Œå®¢æˆ·ç«¯çš„è¿æ¥å¥—æ¥å­—ã€‚ä¸€æ—¦selectè°ƒç”¨æŒ‡ç¤ºæœ‰æ´»åŠ¨å‘ç”Ÿï¼Œå°±å¯ä»¥ç”¨FD_ISSETæ¥éå†æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»¥æ£€æŸ¥æ˜¯å“ªä¸ªä¸Šé¢æœ‰æ´»åŠ¨å‘ç”Ÿã€‚ç„¶åè°ƒç”¨acceptè€Œä¸ç”¨æ‹…å¿ƒå‘ç”Ÿé˜»å¡çš„å¯èƒ½ã€‚å¦‚æœæ˜¯ä¸€ä¸ªå®¢æˆ·æè¿°ç¬¦ï¼Œåˆ™è¯¥æè¿°ç¬¦ä¸Šæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯è¯·æ±‚éœ€è¦æˆ‘ä»¬è¯»å–å’Œå¤„ç†ã€‚å¦‚æœè¯»å–è¿”å›0ä¸ªå­—èŠ‚ï¼Œè¿™è¡¨ç¤ºæœ‰ä¸€ä¸ªå®¢æˆ·è¿›ç¨‹å·²ç»ç»“æŸï¼Œä½ å¯ä»¥å…³é—­è¯¥å¥—æ¥å­—å¹¶æŠŠå®ƒä»é›†åˆä¸­åˆ é™¤ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*  For our final example, server5.c, 
    we include the sys/time.h and sys/ioctl.h headers in place of signal.h
    in our last program and declare some extra variables to deal with select.  */</span>

<span class="cp">#include &lt;sys/types.h&gt;
</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="cp">#include &lt;sys/time.h&gt;
</span>
<span class="cp">#include &lt;sys/ioctl.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">server_sockfd</span><span class="p">,</span> <span class="n">client_sockfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">server_len</span><span class="p">,</span> <span class="n">client_len</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_address</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">client_address</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">fd_set</span> <span class="n">readfds</span><span class="p">,</span> <span class="n">testfds</span><span class="p">;</span>

    <span class="cm">/* ä¸ºæœåŠ¡å™¨åˆ›å»ºä¸€ä¸ªTCP socketæè¿°ç¬¦ */</span>

    <span class="n">server_sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="cm">/* è®¾ç½®socketå±æ€§ */</span>
    <span class="n">server_address</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">server_address</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
    <span class="n">server_address</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">9734</span><span class="p">);</span>
    <span class="n">server_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">server_address</span><span class="p">);</span>

    <span class="n">bind</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_address</span><span class="p">,</span> <span class="n">server_len</span><span class="p">);</span>

<span class="cm">/*  åˆ›å»ºä¸€ä¸ªè¿æ¥é˜Ÿåˆ—ï¼Œåˆå§‹åŒ–readfdsä»¥å¤„ç†æ¥è‡ªserver_sockfdçš„è¾“å…¥  */</span>

    <span class="n">listen</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
<span class="cm">/* åˆå§‹åŒ–seté›†åˆ */</span>
    <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>
    <span class="n">FD_SET</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>

<span class="cm">/* åœ¨whileå¾ªç¯ä¸­ç­‰å¾…å®¢æˆ·å’Œè¯·æ±‚çš„åˆ°æ¥ã€‚ */</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">nread</span><span class="p">;</span>

        <span class="n">testfds</span> <span class="o">=</span> <span class="n">readfds</span><span class="p">;</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"server waiting</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="cm">/* æ³¨æ„è¿™é‡Œtimeoutå‚æ•°ä¼ é€’çš„æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œå› æ­¤selectè°ƒç”¨å°†ä¸ä¼šå‘ç”Ÿè¶…æ—¶çŠ¶å†µ */</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">FD_SETSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">testfds</span><span class="p">,</span> <span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">(</span><span class="n">fd_set</span> <span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">timeval</span> <span class="o">*</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">perror</span><span class="p">(</span><span class="s">"server5"</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>

 <span class="cm">/* ä¸€æ—¦æœ‰æ´»åŠ¨å‘ç”Ÿï¼Œå¯ä»¥ä½¿ç”¨FD_ISSETæ¥ä¾æ¬¡æ£€æŸ¥æ¯ä¸ªæè¿°ç¬¦ï¼Œä»¥å‘ç°æ´»åŠ¨å‘ç”Ÿåœ¨é‚£ä¸ªæè¿°ç¬¦ä¸Š */</span>

        <span class="k">for</span><span class="p">(</span><span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fd</span> <span class="o">&lt;</span> <span class="n">FD_SETSIZE</span><span class="p">;</span> <span class="n">fd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">FD_ISSET</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">testfds</span><span class="p">))</span> <span class="p">{</span>

<span class="cm">/* æ´»åŠ¨å‘ç”Ÿåœ¨server_sockfdä¸Šï¼Œå®ƒè‚¯å®šæ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚ï¼Œå°†ç›¸å…³client_sockfdæ·»åŠ åˆ°æè¿°ç¬¦é›†åˆä¸­ */</span>

                <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">server_sockfd</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">client_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_address</span><span class="p">);</span>
                    <span class="n">client_sockfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span>
                        <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client_len</span><span class="p">);</span>
                    <span class="n">FD_SET</span><span class="p">(</span><span class="n">client_sockfd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"adding client on fd %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">client_sockfd</span><span class="p">);</span>
                <span class="p">}</span>

<span class="cm">/*  æ²¡æœ‰å‘ç”Ÿåœ¨æœåŠ¡å™¨socket server_sockfdä¸Š,åˆ™æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚ç”Ÿæˆç›¸å…³çš„client_sockfdæ·»åŠ åˆ°æè¿°ç¬¦é›†åˆä¸­ */</span>

                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">FIONREAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nread</span><span class="p">);</span>
                    <span class="c1">//åˆ¤æ–­æ˜¯å¦æ˜¯ç¦»å¼€çš„è¯·æ±‚ï¼Œå¦‚æœæ˜¯å°±ç›´æ¥å°†å…¶æ–‡ä»¶æè¿°ç¬¦åˆ é™¤</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
                        <span class="n">FD_CLR</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">readfds</span><span class="p">);</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">"removing client on fd %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="c1">//å¦åˆ™ç›´æ¥è¿›è¡Œè¯»å–å’Œè¾“å‡º</span>

                    <span class="k">else</span> <span class="p">{</span>
                        <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                        <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
                        <span class="n">printf</span><span class="p">(</span><span class="s">"serving client on fd %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
                        <span class="n">ch</span><span class="o">++</span><span class="p">;</span>
                        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="155-æ•°æ®æŠ¥udp">15.5 æ•°æ®æŠ¥(UDP)</h3>

<p>UDPä½¿ç”¨çš„æ˜¯ä¸ç¨³å®šé“¾æ¥ï¼Œå› æ­¤ä¸éœ€è¦è¿›è¡Œè¿‡å¤šçš„æ›´æ”¹å’Œè¿æ¥çŠ¶æ€çš„ç¡®å®šã€‚UDPåœ¨å±€åŸŸç½‘ä¸­éå¸¸å¯é ã€‚ä¸€æ ·ä½¿ç”¨å¥—æ¥å­—å’Œcloseç³»ç»Ÿè°ƒç”¨ï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨<strong>sendtoå’Œrecvfrom</strong>æ¥ä»£æ›¿åŸæ¥ä½¿ç”¨åœ¨å¥—æ¥å­—ä¸Šçš„readå’Œwriteè°ƒç”¨ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¿®æ”¹è¿‡çš„getdate.cç‰ˆæœ¬</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="cp">#include &lt;netdb.h&gt;
</span>
<span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="cp">#include &lt;unistd.h&gt;
</span>
<span class="cp">#include &lt;stdlib.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="c1">//hostä¸»æœºåœ°å€</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">result</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">address</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span><span class="n">hostinfo</span><span class="p">;</span>

    <span class="k">struct</span> <span class="nc">servent</span> <span class="o">*</span><span class="n">serinfo</span><span class="p">;</span>
    <span class="c1">//ç¼“å†²bufferé˜Ÿåˆ—</span>

    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">host</span><span class="o">=</span><span class="s">"localhost"</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">host</span><span class="o">=</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="cm">/* é€šè¿‡åå­—åœ¨hostä¸­æŸ¥æ‰¾å¯¹ç”¨çš„ipåœ°å€å’Œä¿¡æ¯ */</span>
    <span class="n">hostinfo</span><span class="o">=</span><span class="n">gethostbyname</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">hostinfo</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"no host: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">host</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* ç¡®è®¤æœåŠ¡å™¨æ—¶é’Ÿ */</span>
    <span class="n">servinfo</span><span class="o">=</span><span class="n">getservbyname</span><span class="p">(</span><span class="s">"daytime"</span><span class="p">,</span><span class="s">"udp"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">servinfo</span><span class="p">){</span>
        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="s">"no daytime service </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"daytime port is %d </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">ntohs</span><span class="p">(</span><span class="n">servinfo</span><span class="o">-&gt;</span><span class="n">s_port</span><span class="p">));</span>
    <span class="cm">/* åˆ›å»ºä¸€ä¸ªudp socket */</span>

    <span class="n">sockfd</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_DGRAM</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="cm">/* è®¾ç½®addressç›¸å…³å‚æ•° */</span>
    <span class="n">address</span><span class="p">.</span><span class="n">sin_family</span><span class="o">=</span><span class="n">AF_INEF</span><span class="p">;</span>
    <span class="n">address</span><span class="p">.</span><span class="n">sin_port</span><span class="o">=</span><span class="n">servinfo</span><span class="o">-&gt;</span><span class="n">s_port</span><span class="p">;</span>
    <span class="n">address</span><span class="p">.</span><span class="n">sin_addr</span><span class="o">=*</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">hostinfo</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">;</span>
    <span class="n">len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
    <span class="cm">/* è¿›è¡Œæ¶ˆæ¯å‘é€ */</span>
    <span class="n">result</span><span class="o">=</span><span class="n">sendto</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="cm">/* è¿”å›æ¥æ”¶çš„æœ€åä½ç½® */</span>
    <span class="n">result</span><span class="o">=</span><span class="n">recvfrom</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="mi">0</span><span class="p">),(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">address</span><span class="p">,</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="n">buffer</span><span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="o">=</span><span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">4800</span><span class="err">@</span><span class="mi">56</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"read %d bytes:% s"</span><span class="p">.</span><span class="n">result</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>UDPå…³é”®å‡½æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* è¿™é‡Œçš„flagså‚æ•°ä¸€èˆ¬è¢«è®¾ç½®ä¸º0 */</span>

<span class="kt">int</span> <span class="nf">sendto</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span><span class="n">socklen_t</span> <span class="n">tolen</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">recvfrom</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span><span class="n">socklent_t</span> <span class="o">*</span><span class="n">fromlen</span><span class="p">);</span>
</code></pre></div></div>

<p>ä¸Šè¿°å¤±è´¥æ—¶ä¼šè¿”å›-1,å¹¶è®¾ç½®errnoï¼Œå¯èƒ½é”™è¯¯è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-27-20-41-54.png" alt="é”™è¯¯ä¿¡æ¯" /></p>

<h2 id="ç¬¬-16-ç« -ä½¿ç”¨gtkè¿›è¡Œgnomeç¼–ç¨‹">ç¬¬ 16 ç«  ä½¿ç”¨GTK+è¿›è¡Œgnomeç¼–ç¨‹</h2>

<h3 id="161-xè§†çª—ç³»ç»Ÿç®€ä»‹">16.1 xè§†çª—ç³»ç»Ÿç®€ä»‹</h3>

<p>XæœåŠ¡ï¼Œè¿è¡Œåœ¨ç”¨æˆ·çš„æœ¬åœ°æœºå™¨ä¸Šï¼Œåœ¨å±å¹•ä¸Šå®Œæˆåº•å±‚çš„ç»˜å›¾å·¥ä½œã€‚XæœåŠ¡é€šè¿‡é¼ æ ‡å’Œé”®ç›˜ç›‘å¬ç”¨æˆ·è¾“å…¥ï¼Œå°†é”®ç›˜æŒ‰é”®å’Œé¼ æ ‡ç‚¹å‡»ä¼ è¾“ç»™Xå®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªè¢«ç§°ä¸º(event)äº‹ä»¶ã€‚</p>

<h4 id="1612-xå®¢æˆ·ç«¯">16.1.2 Xå®¢æˆ·ç«¯</h4>

<p>Xå®¢æˆ·ç«¯å¯ä»¥ä»¥Xè§†çª—ä½œä¸ºGUIçš„ä»»ä½•ç¨‹åºã€‚Xå®¢æˆ·ç«¯ä¸éœ€è¦å’ŒXæœåŠ¡è¿è¡Œåœ¨åŒä¸€å°æœºå™¨ä¸Šã€‚</p>

<h4 id="1613-xåè®®">16.1.3 Xåè®®</h4>

<p>XæœåŠ¡å™¨ä¸Xå®¢æˆ·ç«¯ä¹‹é—´ä½¿ç”¨Xåè®®è¿›è¡Œé€šä¿¡ã€‚è¿™ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯ä»¥é€šè¿‡ç½‘ç»œè¿›è¡Œåˆ†ç¦»ã€‚</p>

<h4 id="1614-xlibåº“">16.1.4 Xlibåº“</h4>

<p>Xlibæ˜¯Xå®¢æˆ·ç«¯é—´ç”¨äºäº§ç”ŸXåè®®æ¶ˆæ¯çš„åº“ã€‚</p>

<h4 id="1615-xå·¥å…·åŒ…">16.1.5 Xå·¥å…·åŒ…</h4>
<p>Xå·¥å…·åŒ…æ˜¯ä¸€ä¸ªGUIåº“ï¼ŒXå®¢æˆ·ç«¯å¯ä»¥åˆ©ç”¨å®ƒæ¥æå¤§åœ°ç®€åŒ–çª—å£ã€èœå•å’ŒæŒ‰é’®ç­‰çš„åˆ›å»ºã€‚</p>

<h4 id="1616-çª—å£ç®¡ç†å™¨">16.1.6 çª—å£ç®¡ç†å™¨</h4>

<p>Xä¸­è´Ÿè´£å®šä½å±å¹•ä¸Šçš„çª—å£ã€‚çª—å£ç®¡ç†å™¨é€šå¸¸æ”¯æŒç‹¬ç«‹çš„â€œå·¥ä½œåŒºåŸŸâ€ï¼Œè¿™äº›å·¥ä½œåŒºå°†æ¡Œé¢åˆ†å‰²ï¼Œå¢å¤§ç”¨æˆ·å¯ä»¥äº’äº¤çš„åŒºåŸŸã€‚å¸¸è§çª—å£ç®¡ç†å™¨æœ‰å¦‚ä¸‹å†…å®¹:</p>

<ul>
  <li>Metacity:GNOMEæ¡Œé¢çš„é»˜è®¤çª—å£ç®¡ç†å™¨</li>
  <li>KWin:KDEæ¡Œé¢çš„é»˜è®¤çª—å£ç®¡ç†å™¨</li>
  <li>Openbox:æ—¨åœ¨èŠ‚çº¦èµ„æºï¼Œç”¨äºè¾ƒè€çš„ã€è¾ƒæ…¢çš„ç³»ç»Ÿä¸­ã€‚</li>
  <li>Enlightenment:ä¸€ä¸ªæœ‰ç€å‡ºè‰²å›¾å½¢å’Œæ•ˆæœçš„çª—å£ç®¡ç†å™¨ã€‚</li>
</ul>

<h3 id="162-gtxç®€ä»‹">16.2 GTX+ç®€ä»‹</h3>

<p>GTK+æ˜¯ä¸€ä¸ªå‡½æ•°åº“ï¼Œæä¾›äº†ä¸€ç»„å·²ç»åˆ¶ä½œå¥½çš„è¢«æˆä¸ºæ„å»ºçš„ç»„ä»¶ã€‚å¯ä»¥ä½¿ç”¨é€»è¾‘ç»„åˆï¼Œæå¤§åœ°ç®€åŒ–äº†GUIçš„åˆ›å»ºã€‚ä¸»è¦å‡½æ•°æ¨¡å—å¦‚ä¸‹ï¼š</p>

<ul>
  <li>GLib:æä¾›åº•å±‚æ•°æ®ç»“æ„ã€ç±»å‹ã€çº¿ç¨‹æ”¯æŒã€äº‹ä»¶å¾ªç¯å’ŒåŠ¨æ€åŠ è½½</li>
  <li>GObject:ä½¿ç”¨cè¯­è¨€è€Œä¸æ˜¯C++è¯­è¨€å®ç°äº†ä¸€ä¸ªé¢å‘å¯¹è±¡ç³»ç»Ÿ</li>
  <li>Pango:æ”¯æŒæ–‡æœ¬æ¸²æŸ“å’Œå¸ƒå±€</li>
  <li>ATK:ç”¨æ¥åˆ›å»ºå¯è®¿é—®å¼•ç”¨ç¨‹åºï¼Œå¹¶å…è®¸ç”¨æˆ·ä½¿ç”¨å±å¹•é˜…è¯»å™¨å’Œå…¶å®ƒååŠ©å·¥å…·æ¥è¿è¡Œä½ çš„ç¨‹åºã€‚</li>
  <li>GDK(GIMPç»˜å›¾å·¥å…·åŒ…)ï¼šåœ¨Xlibä¹‹ä¸Šå¤„ç†åº•å±‚å›¾å½¢æ¸²æŸ“ã€‚</li>
  <li>GdkPixbuf:åœ¨GTK+ç¨‹åºä¸­å¸®åŠ©å¤„ç†å›¾åƒã€‚</li>
  <li>Xlib:åœ¨linuxå’ŒUNIXç³»ç»Ÿä¸Šæä¾›åº•å±‚å›¾å½¢</li>
</ul>

<h3 id="1623-gnomeç®€ä»‹">16.2.3 GNOMEç®€ä»‹</h3>

<p>GTK+ä¹‹ä¸Šçš„ä¸€ä¸ªæ‰©å±•å›¾åƒæ¡Œé¢</p>

<h3 id="163-äº‹ä»¶ä¿¡å·å’Œå›è°ƒå‡½æ•°">16.3 äº‹ä»¶ã€ä¿¡å·å’Œå›è°ƒå‡½æ•°</h3>

<p>è¿™ä¸ªæ˜¯æ‰€æœ‰GUIä¸­éƒ½å­˜åœ¨çš„å¿…ç„¶ç›¸å…³ç¨‹åºã€‚å…·ä½“çš„ä¸å†è¿‡å¤šèµ˜è¿°ã€‚</p>

<h3 id="164-ç»„è£…ç›’æ„å»º">16.4 ç»„è£…ç›’æ„å»º</h3>

<p>ä¸QTGUIå¸ƒå±€ç›¸ä¼¼ï¼Œå­˜åœ¨<code class="language-plaintext highlighter-rouge">gtk_hbox_new</code>å’Œ<code class="language-plaintext highlighter-rouge">gtk_vbox_new</code>ç­‰å‡½æ•°ã€‚</p>

<h3 id="165-gtkä¸­çš„å¯¹åº”æ„ä»¶">16.5 GTK+ä¸­çš„å¯¹åº”æ„ä»¶</h3>

<p><em>å‚è€ƒè¿æ¥ï¼š</em></p>

<ul>
  <li><a href="https://www.cnblogs.com/xchsp/p/4322028.html">GTK+ä¸­çš„æ„ä»¶II(Widgets)</a></li>
  <li><a href="https://www.cnblogs.com/boer-utopia/articles/2261422.html">GTK+ä¸­çš„æ„ä»¶ï¼ˆGTK+ Widgetsï¼‰</a></li>
  <li><a href="https://blog.csdn.net/u012150792/article/details/50607723">GTK+æ„ä»¶</a></li>
</ul>

<p>GTK+ä¸»è¦æ„ä»¶åˆ—è¡¨å’ŒAPIå¦‚ä¸‹è¡¨ï¼š</p>

<ul>
  <li>GtxWindow:çª—å£åŸºæœ¬å…ƒç´ ï¼Œç”¨æ¥æŒæœ‰æ„ä»¶
<img src="https://wangpengcheng.github.io/img/2019-09-27-21-17-17.png" alt="ä¸»è¦çª—å£å±‚çº§" /></li>
  <li>GtkEntry:å•è¡Œæ–‡æœ¬è¾“å…¥æ„ä»¶ï¼Œç”¨äºè¾“å…¥ç®€å•çš„æ–‡æœ¬ä¿¡æ¯ã€‚
<img src="https://wangpengcheng.github.io/img/2019-09-27-21-18-49.png" alt="GtkEntry" /></li>
  <li>GtkSpinButton:å¯é€‰æ•°å­—è¾“å…¥æ¡†
<img src="https://wangpengcheng.github.io/img/2019-09-27-21-20-18.png" alt="GtkSpinButton" /></li>
  <li>GtkButton:æŒ‰é’®é€‰é¡¹
<img src="https://wangpengcheng.github.io/img/2019-09-27-21-22-20.png" alt="GtkButton" />
    <ol>
      <li>GtkToogleButtonï¼š
    <img src="https://wangpengcheng.github.io/img/2019-09-27-21-23-05png" alt="GtkToogleButton" /></li>
      <li>GtkCheckButton:å•é€‰ç¡®è®¤æ¡†
    <img src="https://wangpengcheng.github.io/img/2019-09-27-21-24-32.png" alt="GtkCheckButton" /></li>
      <li>GtkRadioButton:åœ†å½¢æŒ‰é’®
    <img src="https://wangpengcheng.github.io/img/2019-09-27-21-25-38.png" alt="GtkRadioButton" /></li>
    </ol>
  </li>
  <li>GtkTreeView:æ ‘çŠ¶ç»“æ„;
  <img src="https://wangpengcheng.github.io/img/2019-09-27-21-27-15.png" alt="" />
  å…¶ä¸»è¦ç»„æˆéƒ¨åˆ†å¦‚ä¸‹ï¼š
    <ul>
      <li>GtkTreeView:æ ‘å’Œåˆ—è¡¨è§†å›¾</li>
      <li>GtkTreeViewColumn:ä»£è¡¨ä¸€ä¸ªåˆ—è¡¨æˆ–æ ‘çš„åˆ—</li>
      <li>GtkCellRenderer:æ§åˆ¶ç»˜å›¾å•å…ƒ</li>
      <li>GtkTreeModel:ä»£è¡¨æ ‘å’Œåˆ—è¡¨æ•°æ®</li>
    </ul>
  </li>
</ul>

<h3 id="167-gnomeèœå•">16.7 GNOMEèœå•</h3>
<p>å°±æ˜¯Qtä¸­çš„QMenué€‰é¡¹ï¼Œä¸»è¦ç»“æ„å’Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-27-21-31-02.png" alt="ä¸‹æ‹‰èœå•é€‰é¡¹" /></p>

<h3 id="168-å¯¹è¯æ¡†">16.8 å¯¹è¯æ¡†</h3>

<h4 id="1681-gtkdialog">16.8.1 GtkDialog</h4>
<p>GtkDialogæ˜¯GtkWindowçš„ä¸€ä¸ªå­ç±»ï¼Œç»§æ‰¿äº†å…¶æ‰€æœ‰å‡½æ•°å’Œå±æ€§ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-27-21-32-59.png" alt="GtkDialog" /></p>

<h4 id="1682-æ¨¡å¼å¯¹è¯æ¡†">16.8.2 æ¨¡å¼å¯¹è¯æ¡†</h4>

<p>è®¾ç½®GTK_DIALOG_MODEALæ ‡è®°å’Œè°ƒç”¨gtk_widget_showå‡½æ•°ï¼Œå°†ä¸€ä¸ªå¯¹è¯æ¡†è½¬å˜ä¸ºæ¨¡å¼å¯¹è¯æ¡†ã€‚å¯ä»¥ä½¿ç”¨gtk_dialog_runé€šè¿‡é˜»æ­¢ç¨‹åºçš„è¿›ä¸€æ­¥æ‰§è¡Œã€‚è¿”å›å¯¹åº”çš„é€‰æ‹©çš„ç»“æœç±»å‹ã€‚</p>

<h4 id="1683-éæ¨¡å¼å¯¹è¯æ¡†">16.8.3 éæ¨¡å¼å¯¹è¯æ¡†</h4>

<p>ä¸ä½¿ç”¨gtk_dialog_runè€Œæ˜¯ä½¿ç”¨GtkDialogçš„â€œresponseâ€ä¿¡å·(æŒ‰é’®æŒ‰ä¸‹æˆ–çª—å£è¢«å…³é—­æ—¶å‘å‡º)ã€‚å°†å›è°ƒå‡½æ•°è¿æ¥åˆ°ä¿¡å·ï¼Œä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé¢å¤–çš„responseå‚æ•°ã€‚</p>

<h4 id="1684-gtkmessagedialog">16.8.4 GtkMessageDialog</h4>

<p>ä¸€ä¸ªç®€å•å¯¹è¯æ¡†</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-27-21-38-53.png" alt="GtkMessageDialog" /></p>

<p>è¿˜å¯ä»¥é€‰æ‹©ä¸€ä¸ªGTK_MESSAGE_OTHERå€¼å¦‚ä¸‹</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-27-21-40-09.png" alt="GTK_MESSAGE_OTHER" /></p>

<h2 id="ç¬¬-17-ç« -ä½¿ç”¨qtè¿›è¡Œkdeç¼–ç¨‹">ç¬¬ 17 ç«  ä½¿ç”¨Qtè¿›è¡ŒKDEç¼–ç¨‹</h2>

<p>è¿™ä¸ªä¸éœ€è¦å¤šè¯´äº†,çœ‹å‚è€ƒè¿æ¥ã€‚ã€‚ã€‚ã€‚</p>

<p><em>å‚è€ƒè¿æ¥ï¼š</em></p>

<ul>
  <li><a href="https://doc.qt.io/qt-5/reference-overview.html">Qt Documentation</a></li>
</ul>

<h2 id="ç¬¬-18-ç« -linuxæ ‡å‡†">ç¬¬ 18 ç«  Linuxæ ‡å‡†</h2>

<h3 id="181-cè¯­è¨€ç¼–ç¨‹æ ‡å‡†">18.1 Cè¯­è¨€ç¼–ç¨‹æ ‡å‡†</h3>

<p>æ²¡ä»€ä¹ˆå¥½è¯´çš„</p>

<h3 id="182-æ¥å£å’Œlsb">18.2 æ¥å£å’ŒLSB</h3>

<p>cè¯­è¨€ä¹‹ä¸Šï¼Œé«˜ä¸€ä¸ªå±‚æ¬¡ç”±æ“ä½œç³»ç»Ÿæä¾›çš„æ¥å£(ç³»ç»Ÿæ¥å£)ã€‚</p>

<p>æƒå¨æ–‡æ¡£æ˜¯<a href="https://www.linuxbase.org">LSB</a>ã€‚</p>

<p>Linuxä¸­çš„å¸¸è§ç³»ç»Ÿè¿è¡Œçº§åˆ«è¡¨</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-28-10-01-02.png" alt="è¿è¡Œçº§åˆ«" /></p>

<p><code class="language-plaintext highlighter-rouge">/etc/init.d/</code>ç›®å½•ä¸‹å­˜åœ¨ä¸åŒçš„è„šæœ¬ï¼Œæä¾›å…¶æœåŠ¡ç›¸å…³è”çš„åå­—</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-28-10-03-08.png" alt="é…ç½®è„šæœ¬ç›®å½•" /></p>

<h3 id="183-æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„æ ‡å‡†">18.3 æ–‡ä»¶ç³»ç»Ÿå±‚æ¬¡ç»“æ„æ ‡å‡†</h3>

<p><a href="https://www.pathname.com/fhs/">å±‚æ¬¡ç»“æ„æ ‡å‡†</a>,ä¸»è¦ç›®çš„æ˜¯å®šä¹‰Linuxæ–‡ä»¶ç³»ç»Ÿçš„æ ‡å‡†è·¯å¾„ã€‚
ä¸‹é¢æ˜¯ä¸€äº›é¡¶çº§ç›®å½•ç»“æ„å’Œä¸€äº›å¿…é¡»å­˜åœ¨çš„å­ç›®å½•å’Œä¸€å°éƒ¨åˆ†å¯é€‰ç›®å½•</p>

<p><img src="https://wangpengcheng.github.io/img/2019-09-28-10-07-35.png" alt="ç›®å½•ç»“æ„" /></p>

<h3 id="184-æ›´å¤šæ ‡å‡†">18.4 æ›´å¤šæ ‡å‡†</h3>

<p>æŸ¥çœ‹ä¸€ä¸‹å‚è€ƒè¿æ¥è·å–ç›¸å…³èµ„æ–™</p>

<ul>
  <li><a href="http://www.openi18n.org/">äº‹ç‰©æ ‡å‡†åŒ–</a></li>
  <li><a href="http://www.gnu.org">GNUç½‘ç«™</a>s</li>
</ul>
:ET