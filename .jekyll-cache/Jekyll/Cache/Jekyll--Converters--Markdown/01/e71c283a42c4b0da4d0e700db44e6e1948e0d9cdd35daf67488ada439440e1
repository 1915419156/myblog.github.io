I"àü<h1 id="unixç½‘ç»œç¼–ç¨‹-å­¦ä¹ ç¬”è®°">UNIXç½‘ç»œç¼–ç¨‹ å­¦ä¹ ç¬”è®°</h1>
<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<ul>
  <li><a href="https://blog.csdn.net/zzxiaozhao/article/details/102637708">ã€ŠUnixç½‘ç»œç¼–ç¨‹ã€‹å·1 åˆçº§</a></li>
  <li><a href="https://blog.csdn.net/zzxiaozhao/article/details/102662861">ã€ŠUnixç½‘ç»œç¼–ç¨‹ã€‹å·1 ä¸­çº§</a></li>
  <li><a href="https://zevvez.github.io/2017/12/13/unp/#%E7%AC%AC%E4%B8%80%E7%AB%A0-%E7%AE%80%E4%BB%8B">ã€ŠUNIXç½‘ç»œç¼–ç¨‹å·ä¸€ã€‹è¯»ä¹¦ç¬”è®°</a></li>
</ul>

<blockquote>
  <p>2019-12-01 22:10:53</p>
</blockquote>

<h2 id="ç¬¬-9-ç« -åŸºæœ¬sctpå¥—æ¥å­—ç¼–ç¨‹">ç¬¬ 9 ç«  åŸºæœ¬SCTPå¥—æ¥å­—ç¼–ç¨‹</h2>

<p>ç•¥</p>

<h2 id="ç¬¬-10-ç« -sctpå®¢æˆ·æœåŠ¡å™¨ç¨‹åºä¾‹å­">ç¬¬ 10 ç«  SCTPå®¢æˆ·/æœåŠ¡å™¨ç¨‹åºä¾‹å­</h2>

<p>ç•¥</p>

<h3 id="ç¬¬-11-ç« -åå­—ä¸åœ°å€è½¬æ¢dns">ç¬¬ 11 ç«  åå­—ä¸åœ°å€è½¬æ¢(DNS)</h3>

<p>åŸŸåç³»ç»Ÿ(Domain Name System, DNS):ä¸»è¦ç”¨äºä¸»æœºåå­—å’ŒIPåœ°å€ä¹‹é—´çš„æ˜ å°„ã€‚ä¸»è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">gethostbyname</code>å’Œ<code class="language-plaintext highlighter-rouge">gethostbyaddr</code>åœ¨ä¸»å¥åå­—ä¸IPv4åœ°å€ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚<code class="language-plaintext highlighter-rouge">getservbyname</code>å’Œ<code class="language-plaintext highlighter-rouge">getservbyport</code>åœ¨æœåŠ¡å™¨åå­—å’Œç«¯å£å·ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚</p>

<p>DNSä¸­çš„æ¡ç›®ç§°ä¸ºèµ„æºè®°å½•(resource record)ï¼›ç›¸å…³çš„èµ„æºè®°å½•æ–¹å¼å¦‚ä¸‹ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">A</code>è®°å½•: æŠŠä¸€ä¸ªä¸»æœºåæ˜ å°„ä¸ºä¸€ä¸ª32ä½IPv4åœ°å€</li>
  <li><code class="language-plaintext highlighter-rouge">AAAA</code>è®°å½•: æŠŠä¸€ä¸ªä¸»æœºåæ˜ å°„ä¸ºä¸€ä¸ª128ä½IPv6åœ°å€</li>
  <li><code class="language-plaintext highlighter-rouge">PTR</code>è®°å½•: ç§°ä¸ºæŒ‡é’ˆè®°å½•(pointer record)æŠŠIPåœ°å€æ˜ å°„ä¸ºä¸»æœºå
    <ul>
      <li>å¯¹äºIPv4,å°†32ä½åœ°å€çš„4ä¸ªå­—èŠ‚å…ˆåè½¬é¡ºåº,æ¯ä¸ªå­—èŠ‚éƒ½è½¬ä¸ºæ¢å„è‡ªçš„åè¿›åˆ¶ASCIIå€¼å,åœ¨æ·»åŠ in-addr.arpa,ç»“æœå­—ç¬¦ä¸²ç”¨äºPTRæŸ¥è¯¢</li>
      <li>å¯¹äºIPv6, 128ä½åœ°å€çš„32ä¸ªå››ä½ç»„å…ˆåè½¬é¡ºåº,æ¯ä¸ªå››ä½ç»„éƒ½è½¬æ¢æˆç›¸åº”çš„åå…­è¿›åˆ¶çš„ASCIIå€¼ååœ¨æ·»åŠ ip6.arpa</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">MX</code>è®°å½•: æŠŠä¸€ä¸ªä¸»æœºæŒ‡å®šä½œä¸ºç»™å®šä¸»æœºçš„â€œé‚®ä»¶äº¤æ¢å™¨â€</li>
  <li><code class="language-plaintext highlighter-rouge">CNAME</code>: ä»£è¡¨â€canonical nameâ€(è§„èŒƒåå­—),å¸¸è§çš„ç”¨æ³•æ˜¯ä¸ºå¸¸ç”¨çš„æœåŠ¡æŒ‡æ´¾CNAMEè®°å½•</li>
</ul>

<h4 id="1122-è§£æå™¨resolverå’Œåå­—æœåŠ¡å™¨name-server">11.2.2 è§£æå™¨(resolver)å’Œåå­—æœåŠ¡å™¨(name server)</h4>

<ul>
  <li>åº”ç”¨ç¨‹åºé€šè¿‡è°ƒç”¨è§£æå™¨å‡½æ•°åº“ä¸­çš„å‡½æ•°(gethostbyname,gethostbyaddr)æ¥è§¦DNSæœåŠ¡å™¨ã€‚</li>
  <li>è§£æå™¨å‡½æ•°åº“ä¸­çš„ä»£ç é€šè¿‡è¯»å–ç³»ç»Ÿç›¸å…³é…ç½®æ–‡ä»¶(/etc/resolv.conf)ç¡®å®šæœ¬åœ°name serverçš„åœ°å€ã€‚</li>
  <li>è§£æå™¨ä½¿ç”¨UDPå‘æœ¬åœ°name serverå‘å‡ºæŸ¥è¯¢ï¼Œå¦‚æœæœ¬åœ°name serverä¸çŸ¥é“ç­”æ¡ˆï¼Œè§£æå™¨å°±ä¼šä½¿ç”¨UDPå‘æ•´ä¸ªå› ç‰¹ç½‘æŸ¥è¯¢å…¶ä»–çš„åå­—æœåŠ¡å™¨ï¼›å¦‚æœç­”æ¡ˆå¤ªé•¿è¶…è¿‡äº†UDPçš„æ‰¿è½½èƒ½åŠ›ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°TCPã€‚</li>
  <li>resolverå¯ä»¥çœ‹æˆDNSçš„å®¢æˆ·ç«¯ï¼›nameserverå¯ä»¥çœ‹æˆDNSçš„æœåŠ¡å™¨ã€‚</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-12-02-10-03-17.png" alt="å®¢æˆ·ã€è§£æå…¶å’Œåå­—æœåŠ¡å™¨çš„å…¸å‹å…³ç³»" /></p>

<p>è§£æå™¨ä½¿ç”¨UDPå‘æœ¬åœ°åå­—æœåŠ¡å™¨å‘å‡ºæŸ¥è¯¢ï¼Œå¦‚æœæœ¬åœ°æŸ¥æ‰¾ä¸åˆ°ï¼Œå°±ä¼šä½¿ç”¨UDPåœ¨æ•´ä¸ªInternetç½‘ä¸ŠæŸ¥è¯¢å…¶ä»–åŸŸåæœåŠ¡å™¨ã€‚å¦‚æœç­”æ¡ˆå¤ªé•¿ï¼Œè¶…å‡ºäº†UDPçš„æ¶ˆæ¯çš„æ‰¿è½½èƒ½åŠ›ï¼Œæœ¬åœ°åå­—æœåŠ¡å™¨å’Œè§£æå™¨ä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°TCP</p>

<h4 id="1123-dns-æ›¿ä»£æ–¹æ³•">11.2.3 DNS æ›¿ä»£æ–¹æ³•</h4>

<ul>
  <li>é™æ€ä¸»æœºæ–‡ä»¶(/etc/hosts)</li>
  <li>ç½‘ç»œä¿¡æ¯ç³»ç»Ÿ(NIS)</li>
  <li>è½»é‡çº§ç›®å½•è®¿é—®åè®®(LDAP)</li>
</ul>

<h3 id="113-gethostbyname-å‡½æ•°">11.3 gethostbyname å‡½æ•°</h3>

<p>è¿™ä¸ªå‡½æ•°åªèƒ½è¿”å›IPv4åœ°å€ï¼Œåœ¨æ–°çš„ç¨‹åºä¸­åº”è¯¥ä½¿ç”¨getaddrinfoï¼›</p>
<ul>
  <li>å‡½æ•°å®šä¹‰: <code class="language-plaintext highlighter-rouge">struct hostent * gethostbyname(const char * hostname);</code></li>
  <li>è¿”å›ï¼šæˆåŠŸåˆ™è¿”å›éç©ºæŒ‡é’ˆ, å¤±è´¥åˆ™NULLä¸”è®¾ç½®h_errno</li>
  <li>æ³¨æ„æ­¤å‡½æ•°å¤±è´¥ä¹‹åå¹¶ä¸ä¼šè®¾ç½®errnoå˜é‡,è€Œæ˜¯å°†å…¨å±€æ•´æ•°å˜é‡h_errnoè®¾ç½®ä¸ºåœ¨å¤´æ–‡ä»¶<netdb.h>ä¸­å®šä¹‰çš„å¸¸å€¼ä¹‹ä¸€:
</netdb.h>    <ul>
      <li><code class="language-plaintext highlighter-rouge">HOST_NOT_FOUND</code></li>
      <li><code class="language-plaintext highlighter-rouge">TRY_AGAIN</code></li>
      <li><code class="language-plaintext highlighter-rouge">NO_RECOVERY</code></li>
      <li><code class="language-plaintext highlighter-rouge">NO_DATA</code>(ç­‰åŒäº<code class="language-plaintext highlighter-rouge">NO_ADDRESS</code>)
        <ul>
          <li>æ­¤é”™è¯¯è¡¨ç¤ºæ‰€æŒ‡å‘çš„åå­—æœ‰æ•ˆ,ä½†æ˜¯æ²¡æœ‰<code class="language-plaintext highlighter-rouge">A</code>è®°å½•</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>hostnetå…³é”®ç»“æ„ä½“å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">hostent</span><span class="p">{</span>
    <span class="kt">char</span>    <span class="o">*</span><span class="n">h_name</span><span class="p">;</span>        <span class="cm">/* ä¸»æœºçš„å®˜æ–¹åç§° */</span>
    <span class="kt">char</span>    <span class="o">**</span><span class="n">h_aliases</span><span class="p">;</span>    <span class="cm">/* ä¸»æœºåˆ«åçš„æŒ‡é’ˆæ•°ç»„ */</span>
    <span class="kt">int</span>     <span class="n">h_addrtype</span><span class="p">;</span>     <span class="cm">/* ä¸»æœºIPåœ°å€çš„ç±»å‹ */</span>
    <span class="kt">int</span>     <span class="n">h_length</span><span class="p">;</span>       <span class="cm">/* IPv4çš„åœ°å€é•¿åº¦ */</span>
    <span class="kt">char</span><span class="o">**</span>  <span class="n">h_addr_list</span><span class="p">;</span>    <span class="cm">/* æŒ‡å‘IPv4çš„åœ°å€æŒ‡é’ˆ */</span>
<span class="p">}</span>
</code></pre></div></div>
<p><img src="https://img-blog.csdnimg.cn/20191026141722883.png#pic_center" alt="hostnetåŒ…å«çš„ç»“æ„ä½“ä¿¡æ¯" /></p>

<p>ä¾‹å­ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">**</span> <span class="n">pptr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="n">INET_ADDRSTRLEN</span><span class="p">];</span>
    <span class="cm">/* å®šä¹‰è¿”å›çš„ç»“æ„ä½“ */</span>
    <span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span> <span class="n">hptr</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="o">--</span><span class="n">argc</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
        <span class="cm">/* è·å–è¾“å…¥å‚æ•° */</span>
        <span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span> <span class="o">++</span><span class="n">argv</span><span class="p">;</span>
        <span class="cm">/* æŸ¥æ‰¾å¯¹åº”çš„ipåœ°å€ */</span>
        <span class="k">if</span><span class="p">((</span><span class="n">hptr</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">err_msg</span><span class="p">(</span><span class="s">"gethostbyname error for host :%s : %s"</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">hstrerror</span><span class="p">(</span><span class="n">h_errno</span><span class="p">));</span>
                <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"official hostname: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">hptr</span><span class="o">-&gt;</span><span class="n">h_name</span><span class="p">);</span>
        <span class="cm">/* éå†è¾“å‡ºæ‰€æœ‰åˆ«å */</span>
        <span class="k">for</span><span class="p">(</span><span class="n">pptr</span> <span class="o">=</span> <span class="n">hptr</span><span class="o">-&gt;</span><span class="n">h_aliases</span><span class="p">;</span> <span class="o">*</span><span class="n">pptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pptr</span><span class="o">++</span><span class="p">){</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">alias: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="n">pptr</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="cm">/* é€‰æ‹©åœ°å€ç±»å‹å¹¶è¾“å‡º */</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">hptr</span><span class="o">-&gt;</span><span class="n">h_addrtype</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">AF_INET</span><span class="p">:</span>
                <span class="n">pptr</span> <span class="o">=</span> <span class="n">hptr</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">;</span>
                <span class="k">for</span> <span class="p">(;</span> <span class="o">*</span><span class="n">pptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pptr</span><span class="o">++</span><span class="p">){</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"</span><span class="se">\t</span><span class="s">address : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                    <span class="n">Inet_ntop</span><span class="p">(</span><span class="n">hptr</span><span class="o">-&gt;</span><span class="n">h_addrtype</span><span class="p">,</span> <span class="o">*</span> <span class="n">pptr</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">)));</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="nl">default:</span>
                <span class="n">err_ret</span><span class="p">(</span><span class="s">"unknown address type"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/* RUN
./hostent music.163.com
official hostname: music.163.com
        address : 59.111.160.197
        address : 59.111.160.195
        address : 223.252.199.66
*/</span>

</code></pre></div></div>

<h3 id="114-gethostbyaddrå‡½æ•°">11.4 gethostbyaddrå‡½æ•°</h3>

<p>gethostbyaddrå‡½æ•°è¯•å›¾ç”±ä¸€ä¸ªäºŒè¿›åˆ¶çš„IPåœ°å€æ‰¾åˆ°ç›¸åº”çš„ä¸»æœºåï¼Œä¸ gethostbyname çš„è¡Œä¸ºåˆšå¥½ç›¸åã€‚(<strong>æ³¨æ„ï¼šåœ¨æ–°çš„ç¨‹åºä¸­åº”è¯¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">getnameinfo</code></strong>)
æ³¨ï¼šæ­¤å¤„ä¸åŸä¹¦ä¸­çš„ gethostbyaddrå‡½æ•°ä¸åŒï¼ŒåŸä¹¦ä¸­çš„å‡½æ•°åœ¨åº“<netdb.h>ï¼Œä¸”addrå‚æ•°ä¸º const char *</netdb.h></p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span><span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span> <span class="nf">gethostbyaddr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">addr</span><span class="p">,</span><span class="n">socklen_t</span> <span class="n">len</span><span class="p">,</span><span class="kt">int</span> <span class="n">type</span><span class="p">);</span>
<span class="c1">//if success return not NULL pointer,if error return NULL and set h_errno</span>
</code></pre></div></div>

<p>addr å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡å‘IPV4åœ°å€çš„æŸä¸ªin_addrç»“æ„çš„æŒ‡é’ˆï¼›lenå‚æ•°æ˜¯è¿™ä¸ªç»“æ„çš„å¤§å°ï¼›familyå‚æ•°ä¸º<code class="language-plaintext highlighter-rouge">AF_INET</code>æˆ–<code class="language-plaintext highlighter-rouge">AF_INET6</code></p>

<p>æŒ‰ç…§DNSçš„è¯´æ³•ï¼Œ<code class="language-plaintext highlighter-rouge">gethostbyaddr</code>åœ¨<code class="language-plaintext highlighter-rouge">in_addr.arpa</code>åŸŸä¸­å‘ä¸€ä¸ªåå­—æœåŠ¡å™¨æŸ¥è¯¢<code class="language-plaintext highlighter-rouge">PTR</code>è®°å½•ã€‚</p>

<h3 id="115-getservbynameå’Œgetservbyportå‡½æ•°">11.5 getservbynameå’Œgetservbyportå‡½æ•°</h3>
<h4 id="1151-getservbyname">11.5.1 getservbyname</h4>

<p>getservbynameå‡½æ•°ç”¨äºæ ¹æ®ç»™å®šçš„åå­—æŸ¥æ‰¾ç›¸åº”çš„æœåŠ¡ã€‚ä¸€èˆ¬æœåŠ¡å™¨å¯¹åº”çš„IPåœ°å€ä¿å­˜åœ¨<code class="language-plaintext highlighter-rouge">/etc/services</code>ä¸­;å…¸å‹å†…å®¹å¦‚ä¸‹ï¼š</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>breap@breap ~]<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-e</span> ^ftp <span class="nt">-e</span> ^domain /etc/services
ftp-data        20/tcp
ftp-data        20/udp
ftp             21/tcp
ftp             21/udp          fsp fspd
domain          53/tcp                          <span class="c"># name-domain server</span>
domain          53/udp
ftp-data        20/sctp                 <span class="c"># FTP</span>
.......
</code></pre></div></div>

<p>å‡½æ•°çš„å®šä¹‰å’Œå£°æ˜å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span> <span class="nf">getservbyname</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">servname</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">protoname</span><span class="p">);</span>
<span class="c1">//if success return not NULL pointer,if error return NULL</span>
<span class="k">struct</span> <span class="n">servent</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">s_name</span><span class="p">;</span> <span class="c1">//Official services name</span>
    <span class="kt">char</span> <span class="o">**</span> <span class="n">s_aliases</span><span class="p">;</span> <span class="c1">//Alias list</span>
    <span class="kt">int</span> <span class="n">s_port</span><span class="p">;</span> <span class="c1">//Port number,Network byte order</span>
    <span class="kt">char</span> <span class="o">*</span> <span class="n">s_proto</span><span class="p">;</span> <span class="c1">//Protocol to use</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">servname</code>:æœåŠ¡å™¨å‚æ•°åç§°ï¼›å¿…é¡»æŒ‡å®š</li>
  <li><code class="language-plaintext highlighter-rouge">protoname</code>:åè®®åç§°ï¼Œå¯é€‰å‚æ•°ï¼Œéç©ºæ—¶ï¼Œå¿…é¡»æœ‰åŒ¹é…çš„åè®®ï¼›æœ‰äº›å› ç‰¹ç½‘æœåŠ¡æ—¢ç”¨ TCP ä¹Ÿç”¨ UDP æä¾›ï¼Œå…¶ä»–è‹±ç‰¹ç½‘åˆ™ä»…ä»…æ”¯æŒå•ä¸ªåè®®ã€‚
    <ul>
      <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">protoname</code>æœªæŒ‡å®šè€Œ<code class="language-plaintext highlighter-rouge">servname</code>æŒ‡å®šæœåŠ¡æ”¯æŒå¤šä¸ªåè®®ï¼Œé‚£ä¹ˆè¿”å›å“ªä¸ªç«¯å£å·å–å†³äºå®ç°ã€‚
        <ul>
          <li>é€šå¸¸æƒ…å†µä¸‹è¿™ç§é€‰æ‹©æ— å…³ç´§è¦ï¼Œå› ä¸ºæ”¯æŒå¤šä¸ªåè®®çš„æœåŠ¡å¾€å¾€ä½¿ç”¨ç›¸åŒçš„<code class="language-plaintext highlighter-rouge">TCP</code>ç«¯å£å·å’Œ<code class="language-plaintext highlighter-rouge">UDP</code>ç«¯å£å·ï¼Œä¸è¿‡è¿™ç‚¹å¹¶æ— ä¿è¯ã€‚</li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">servent</code>ç»“æ„ä¸­æˆ‘ä»¬å…³å¿ƒçš„ä¸»è¦å­—æ®µæ˜¯ç«¯å£å·(ç½‘ç»œå­—èŠ‚åº)
        <ul>
          <li>æ—¢ç„¶ç«¯å£å·æ˜¯ä»¥ç½‘ç»œå­—èŠ‚åºè¿”å›çš„ï¼ŒæŠŠå®ƒå­˜æ”¾åˆ°å¥—æ¥å­—åœ°å€ç»“æ„æ—¶ç»å¯¹ä¸èƒ½è°ƒç”¨<code class="language-plaintext highlighter-rouge">htons</code>ã€‚</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>å‡½æ•°è°ƒç”¨ç¤ºä¾‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span><span class="n">sptr</span><span class="p">;</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyname</span><span class="p">(</span><span class="s">"domain"</span><span class="p">,</span><span class="s">"udp"</span><span class="p">);</span> <span class="c1">//DNS using UDP</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyname</span><span class="p">(</span><span class="s">"ftp"</span><span class="p">,</span><span class="s">"tcp"</span><span class="p">);</span> <span class="c1">//FTP using TCP</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyname</span><span class="p">(</span><span class="s">"ftp"</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">//FTP using TCP</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyname</span><span class="p">(</span><span class="s">"ftp"</span><span class="p">,</span><span class="s">"udp"</span><span class="p">);</span> <span class="c1">//this call will fail</span>
</code></pre></div></div>
<h4 id="1152-getservbyport">11.5.2 getservbyport</h4>

<p>getservbyport å‡½æ•°ç”¨äºç»™å®šç«¯å£å·å’Œå¯é€‰åè®®æŸ¥è¯¢ç›¸åº”æœåŠ¡.å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span> <span class="nf">getservbyport</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">protoname</span><span class="p">);</span>
<span class="c1">//if success return not NULL pointer,if error return NULL</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">port</code>å‚æ•°çš„å€¼å¿…é¡»ä¸º<strong>ç½‘ç»œå­—èŠ‚åº</strong>ã€‚è¯¥å‡½æ•°çš„å…¸å‹è°ƒç”¨å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">servent</span> <span class="o">*</span><span class="n">sptr</span><span class="p">;</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">htons</span><span class="p">(</span><span class="mi">53</span><span class="p">),</span><span class="s">"udp"</span><span class="p">);</span> <span class="c1">//DNS using UDP</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">htons</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span><span class="s">"tcp"</span><span class="p">);</span> <span class="c1">//FTP using TCP</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">htons</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span><span class="nb">NULL</span><span class="p">);</span> <span class="c1">// FTP using TCP</span>
<span class="n">sptr</span><span class="o">=</span><span class="n">getservbyport</span><span class="p">(</span><span class="n">htons</span><span class="p">(</span><span class="mi">21</span><span class="p">),</span><span class="s">"udp"</span><span class="p">);</span> <span class="c1">//this call will fail</span>
</code></pre></div></div>

<p>æ³¨æ„ï¼š</p>
<ul>
  <li><strong>æŸäº›ç«¯å£å·åœ¨TCPä¸Šæ˜¯ä¸€ç§æœåŠ¡ï¼Œåœ¨UDPä¸Šå´ç”¨äºå®Œå…¨ä¸åŒçš„å¦ä¸€ç§æœåŠ¡ã€‚</strong></li>
  <li><strong>ç«¯å£å¯ä»¥å¤ç”¨,åªè¦åè®®ä¸åŒ</strong>
ä¾‹å¦‚ï¼š
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>breap@breap ~]<span class="nv">$ </span><span class="nb">grep </span>514 /etc/services
shell           514/tcp         cmd             <span class="c"># no passwords used</span>
syslog          514/udp
</code></pre></div>    </div>
  </li>
</ul>

<p>ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">recvline</span><span class="p">[</span><span class="n">MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">**</span> <span class="n">pptr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">*</span> <span class="n">inetaddrp</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">struct</span> <span class="nc">in_addr</span> <span class="n">inetaddr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">hostent</span> <span class="o">*</span> <span class="n">hp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">servent</span> <span class="o">*</span> <span class="n">sp</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span><span class="p">){</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"usage: daytimetcpcli1 &lt;hostname&gt; &lt;services&gt;"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">((</span><span class="n">hp</span> <span class="o">=</span> <span class="n">gethostbyname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* ç¡®å®šæ˜¯å¦ä¸ºæ­£ç¡®çš„ASCIIåœ°å€æ ¼å¼ */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">inetaddr</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
            <span class="n">err_quit</span><span class="p">(</span><span class="s">"hostname error for %s : %s"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hstrerror</span><span class="p">(</span><span class="n">h_errno</span><span class="p">));</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">inetaddrp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">inetaddr</span><span class="p">;</span>
            <span class="n">inetaddrp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="n">pptr</span> <span class="o">=</span> <span class="n">inetaddrp</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">pptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span> <span class="o">**</span> <span class="p">)</span><span class="n">hp</span><span class="o">-&gt;</span><span class="n">h_addr_list</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* è·å–æœåŠ¡ */</span>
    <span class="k">if</span><span class="p">((</span><span class="n">sp</span> <span class="o">=</span> <span class="n">getservbyname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">"tcp"</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"getservbyname error for %s : %s"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(;</span> <span class="o">*</span><span class="n">pptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">pptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* å»ºç«‹TCPè¿æ¥ */</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">Socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
        <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
        <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">s_port</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="o">*</span> <span class="n">pptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">in_addr</span><span class="p">));</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"trying %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Sock_ntop</span><span class="p">((</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">)));</span>
        <span class="cm">/* è¿›è¡Œè¿æ¥ */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">err_ret</span><span class="p">(</span><span class="s">"connect error"</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"unable to connect"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* æ‰§è¡Œread */</span>
    <span class="k">while</span><span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">Read</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">recvline</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">recvline</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// null terminate</span>
        <span class="n">Fputs</span><span class="p">(</span><span class="n">recvline</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*
[breap@breap name_test]$ ./daytimetcpcli1 127.0.0.1 daytime
trying 127.0.0.1:13
Tue Jan 16 20:06:35 2018
*/</span>

</code></pre></div></div>

<h3 id="116-getaddrinfo">11.6 getaddrinfo</h3>

<p>è¿™ä¸ªå‡½æ•°èƒ½å¤Ÿå¤„ç†åå­—åˆ°åœ°å€ä»¥åŠæœåŠ¡å™¨åˆ°ç«¯å£è¿™ä¸¤ç§è½¬æ¢ã€‚è¿”å›ä¸€ä¸ªsockaddrç»“æ„è€Œä¸æ˜¯ä¸€ä¸ªåœ°å€åˆ—è¡¨ã€‚è¯¥å‡½æ•°åœ¨POSIXè§„èŒƒä¸­å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="kt">int</span> <span class="nf">getaddrinfo</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">hostname</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">service</span><span class="p">,</span><span class="k">const</span> <span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">hints</span><span class="p">,</span><span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">**</span><span class="n">result</span><span class="p">);</span>
<span class="c1">//if success return 0,if error return not 0;</span>
</code></pre></div></div>
<p>å‚æ•°è§£æï¼š</p>
<ul>
  <li>hostname:ä¸»å¥åæˆ–è€…åœ°å€ä¸²(IPv4çš„ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²æˆ–IPv6çš„åå…­è¿›åˆ¶æ•°ä¸²)</li>
  <li>service:æœåŠ¡åæˆ–è€…åè¿›åˆ¶ç«¯å£å·æ•°ä¸²</li>
  <li>hints:æœŸæœ›è¿”å›çš„ä¿¡æ¯ç±»å‹çš„æš—ç¤ºï¼Œå¯ä»¥ä¸ºç©ºæŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥æŒ‡å‘æŸä¸ªaddrinfoç»“æ„æŒ‡é’ˆã€‚</li>
  <li>result:è¿”å›ç»“æœï¼›ç”±resultå‚æ•°æŒ‡å‘çš„å˜é‡å·²è¢«å¡«å…¥ä¸€ä¸ªæŒ‡é’ˆï¼Œå®ƒæŒ‡å‘çš„æ˜¯ç”±å…¶ä¸­çš„ai_nextæˆå‘˜ä¸²æ¥èµ·æ¥çš„addrinfoç»“æ„é“¾è¡¨(å¤šä¸ªaddrinfoç»“æ„è¿”å›æ—¶ï¼Œè¿™äº›ç»“æ„çš„å…ˆåé¡ºåºæ²¡æœ‰ä¿è¯ )ã€‚
    <ul>
      <li>å¯å¯¼è‡´è¿”å›å¤šä¸ª<code class="language-plaintext highlighter-rouge">addrinfo</code>ç»“æ„çš„æƒ…å†µæœ‰ä¸¤ä¸ªï¼š
        <ul>
          <li>å¦‚æœä¸<code class="language-plaintext highlighter-rouge">hostname</code>å‚æ•°å…³è”çš„åœ°å€æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆé€‚ç”¨äºæ‰€è¯·æ±‚åœ°å€æ—(å¯é€šè¿‡hintsç»“æ„çš„ ai_familyæˆå‘˜è®¾ç½®)çš„æ¯ä¸ªåœ°å€éƒ½è¿”å›ä¸€ä¸ªå¯¹åº”çš„ç»“æ„</li>
          <li>å¦‚æœ<code class="language-plaintext highlighter-rouge">service</code>å‚æ•°æŒ‡å®šçš„æœåŠ¡æ”¯æŒå¤šä¸ªå¥—æ¥å­—ç±»å‹ï¼Œé‚£ä¹ˆæ¯ä¸ªå¥—æ¥å­—ç±»å‹éƒ½å¯èƒ½è¿”å›ä¸€ä¸ªå¯¹åº”çš„ç»“æ„ï¼Œå…·ä½“å–å†³ä¸ <code class="language-plaintext highlighter-rouge">hints</code>ç»“æ„çš„<code class="language-plaintext highlighter-rouge">ai_socktype</code>æˆå‘˜ã€‚ ï¼ˆæ³¨æ„ï¼Œ<code class="language-plaintext highlighter-rouge">getaddrinfo</code>çš„å¤šæ•°å®ç°è®¤ä¸ºåªèƒ½æŒ‰ç…§ç”±<code class="language-plaintext highlighter-rouge">ai_socktype</code>æˆå‘˜è¯·æ±‚çš„å¥—æ¥å­—ç±»å‹ç«¯å£å·æ•°ä¸²åˆ°ç«¯å£çš„è½¬æ¢ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šè¿™ä¸ªæˆå‘˜ï¼Œé‚£å°±è¿”å›ä¸€ä¸ªé”™è¯¯ï¼‰
addrinfoçš„å®šä¹‰å¦‚ä¸‹ï¼š</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">addrinfo</span><span class="p">{</span>
	<span class="kt">int</span> <span class="n">ai_flags</span><span class="p">;</span> <span class="c1">//AI_PASSIVE,AI_CANONNAME</span>
	<span class="kt">int</span> <span class="n">ai_family</span><span class="p">;</span> <span class="c1">//AF_XXX</span>
	<span class="kt">int</span> <span class="n">ai_socktype</span><span class="p">;</span> <span class="c1">//SOCK_XXX</span>
	<span class="kt">int</span> <span class="n">ai_protocol</span><span class="p">;</span> <span class="c1">//0 or IPPROTO_XXX for IPV4 and IPV6</span>
	<span class="n">socklen_t</span> <span class="n">ai_addrlen</span><span class="p">;</span> <span class="c1">//length of ai_addr</span>
	<span class="kt">char</span> <span class="o">*</span> <span class="n">ai_canonname</span><span class="p">;</span> <span class="c1">//ptr to canonical name for host</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="n">ai_addr</span><span class="p">;</span> <span class="c1">//ptr to socket address structure</span>
	<span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span> <span class="n">ai_next</span><span class="p">;</span> <span class="c1">//ptr to next structure in linked list</span>
<span class="p">}</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">addrinfo</code>ç»“æ„ä¸­è°ƒç”¨è€…(hints)å¯ä»¥è®¾ç½®çš„æˆå‘˜æœ‰, (å¦‚æœhintså‚æ•°æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œè¯¥å‡½æ•°å°±å‡è®¾ ai_flags, ai_socktype, ai_protocol çš„å€¼å‡ä¸º0ï¼Œai_familyçš„å€¼ä¸ºAF_UNSPECã€‚)
è°ƒç”¨è€…hintså¯ä»¥è®¾ç½®çš„æˆå‘˜åŒ…æ‹¬ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">è°ƒç”¨è€…(<code class="language-plaintext highlighter-rouge">hints</code>)</th>
      <th style="text-align: left">å¯ä»¥è®¾ç½®çš„æˆå‘˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ai_flags</code></td>
      <td style="text-align: left">é›¶ä¸ªæˆ–å¤šä¸ªåœ¨ä¸€èµ·çš„AI_XXXå€¼.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ai_family</code></td>
      <td style="text-align: left">æŸä¸ªAF_XXX</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ai_socktype</code></td>
      <td style="text-align: left">æŸä¸ªSOCK_XXXå€¼</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">ai_protocol</code></td>
      <td style="text-align: left">æŸä¸ªå†™æ§åˆ¶åè®®</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ai_flagså¯èƒ½å€¼</th>
      <th style="text-align: left">å«ä¹‰</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_PASSIVE</code></td>
      <td style="text-align: left">å¥—æ¥å­—å°†ç”¨äºè¢«åŠ¨æ‰“å¼€ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_CANONNAME</code></td>
      <td style="text-align: left">å‘ŠçŸ¥ getaddrinfo å‡½æ•°è¿”å›ä¸»æœºçš„è§„èŒƒåå­—ã€‚(canon,è§„èŒƒ)</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_NUMERICHOST</code></td>
      <td style="text-align: left">é˜²æ­¢ä»»ä½•ç±»å‹çš„åå­—åˆ°åœ°å€æ˜ å°„ï¼Œ hostnameå‚æ•°å¿…é¡»ä¸ºä¸€ä¸ªåœ°å€ä¸²</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_NUMERICSERV</code></td>
      <td style="text-align: left">é˜²æ­¢ä»»ä½•ç±»å‹çš„åå­—åˆ°æœåŠ¡çš„æ˜ å°„,service å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªåè¿›åˆ¶ç«¯å£å·æ•°ä¸²ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_V4MAPPED</code></td>
      <td style="text-align: left">å¦‚æœåŒæ—¶æŒ‡å®š ai_family æˆå‘˜çš„å€¼ä¸º AF_INET6,é‚£ä¹ˆå¦‚æœæ²¡æœ‰å¯ç”¨çš„AAAAè®°å½•ï¼Œå°±è¿”å›ä¸Aè®°å½•å¯¹åº”çš„IPV4æ˜ å°„çš„IPV6åœ°å€ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_ALL</code></td>
      <td style="text-align: left">å¦‚æœåŒæ—¶æŒ‡å®š AI_V4MAPPED æ ‡å¿—ï¼Œé‚£ä¹ˆé™¤äº†è¿”å›ä¸AAAAè®°å½•å¯¹åº”çš„IPV6åœ°å€å¤–ï¼Œè¿˜è¿”å›ä¸Aè®°å½•å¯¹åº”çš„IPV4æ˜ å°„çš„IPV6åœ°å€ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AI_ADDRCONFIG</code></td>
      <td style="text-align: left">æŒ‰ç…§æ‰€åœ¨ä¸»æœºçš„é…ç½®é€‰æ‹©è¿”å›åœ°å€ç±»å‹ï¼Œä¹Ÿå°±æ˜¯åªæŸ¥æ‰¾ä¸æ‰€åœ¨ä¸»æœºå›é¦ˆæ¥å£ä»¥å¤–çš„ç½‘ç»œæ¥å£é…ç½®çš„IPåœ°å€ç‰ˆæœ¬ä¸€è‡´çš„åœ°å€ã€‚</td>
    </tr>
  </tbody>
</table>

<p>ä¸€äº›å¸¸è§çš„è¾“å…¥ (<strong>å¦‚æ¸…æ¥šçŸ¥é“è‡ªå·±éœ€è¦çš„å¥—æ¥å­—ç±»å‹ï¼Œåº”è¯¥åœ¨<code class="language-plaintext highlighter-rouge">hints</code>ä¸­è®¾ç½®<code class="language-plaintext highlighter-rouge">ai_socktype</code>æˆå‘˜,é¿å…è¿”å›å¤šä¸ªç»“æ„ï¼Œç”šè‡³å‡ºç°é”™è¯¯çš„<code class="language-plaintext highlighter-rouge">ai_socktype</code>å€¼</strong>):</p>

<ul>
  <li>æŒ‡å®š<code class="language-plaintext highlighter-rouge">hostname</code>å’Œ<code class="language-plaintext highlighter-rouge">service</code>ã€‚è¿™æ˜¯TCPæˆ–UDPå®¢æˆ·è¿›ç¨‹è°ƒç”¨getaddrinfoçš„å¸¸è§„è¾“å…¥ã€‚</li>
  <li>å¯¹äº<code class="language-plaintext highlighter-rouge">TCP</code>å®¢æˆ·åœ¨ä¸€ä¸ªå¾ªç¯ä¸­é’ˆå¯¹æ¯ä¸ªè¿”å›çš„IPåœ°å€ï¼Œè°ƒç”¨<code class="language-plaintext highlighter-rouge">socket</code>å’Œ<code class="language-plaintext highlighter-rouge">connect</code>ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªè¿æ¥æˆåŠŸï¼Œæˆ–è€…æ‰€æœ‰åœ°å€å°è¯•å®Œæ¯•ä¸ºæ­¢ã€‚</li>
  <li>å¯¹äº<code class="language-plaintext highlighter-rouge">UDP</code>å®¢æˆ·ç”±<code class="language-plaintext highlighter-rouge">getaddrinfo</code>å¡«å…¥çš„å¥—æ¥å­—åœ°å€ç»“æ„ç”¨äº<code class="language-plaintext highlighter-rouge"> sendto</code> æˆ– <code class="language-plaintext highlighter-rouge">connect</code>ã€‚</li>
  <li>åªæŒ‡å®š<code class="language-plaintext highlighter-rouge">service</code>è€Œä¸æŒ‡å®š<code class="language-plaintext highlighter-rouge">hostname</code>ï¼ŒåŒæ—¶åœ¨hintsç»“æ„ä¸­æŒ‡å®š <code class="language-plaintext highlighter-rouge">AI_PASSIVE</code>æ ‡å¿—ã€‚è¿™æ˜¯å…¸å‹çš„æœåŠ¡å™¨è¿›ç¨‹.
    <ul>
      <li>è¿”å›çš„å¥—æ¥å­—åœ°å€ç»“æ„ä¸­åº”å«æœ‰ä¸€ä¸ªå€¼ä¸º <code class="language-plaintext highlighter-rouge">INADDR_ANY(IPV4)</code>æˆ–<code class="language-plaintext highlighter-rouge">IN6ADDR_ANY_INIT(IPV6)</code>ã€‚</li>
      <li>TCP æœåŠ¡å™¨éšåè°ƒç”¨ <code class="language-plaintext highlighter-rouge">socket</code>ã€<code class="language-plaintext highlighter-rouge">bind</code>ã€<code class="language-plaintext highlighter-rouge">listen</code>ã€<code class="language-plaintext highlighter-rouge">accept</code>ã€‚</li>
      <li>UDPæœåŠ¡å™¨å°†è°ƒç”¨ <code class="language-plaintext highlighter-rouge">socket</code>ã€<code class="language-plaintext highlighter-rouge">bind</code>ã€<code class="language-plaintext highlighter-rouge">recvfrom</code>ã€‚</li>
    </ul>
  </li>
</ul>

<p>ç®€å•çš„ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">addrinfo</span> <span class="n">hints</span><span class="p">,</span><span class="o">*</span><span class="n">res</span><span class="p">;</span>
<span class="cm">/* é‡ç½®ç»“æ„ */</span>
<span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">));</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span><span class="o">=</span><span class="n">AI_CANONNAME</span><span class="p">;</span>
<span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">;</span>
<span class="cm">/* è·å–hostå’Œserverçš„ipåœ°å€ */</span>
<span class="n">getaddinfo</span><span class="p">(</span><span class="s">"freebad4"</span><span class="p">,</span><span class="s">"domain"</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

</code></pre></div></div>

<p>ä¸Šé¢ä¸»æœºfreebsd4çš„è§„èŒƒåå­—æ˜¯freebad4.unpbook.comï¼›å¹¶ä¸”å®ƒåœ¨DNSä¸­æœ‰2ä¸ªIPv4åœ°å€ï¼›åˆ™è¿”å›ç»“æœå¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-12-03-21-08-52.png" alt="" /></p>

<h3 id="117-gai_strerrorå‡½æ•°">11.7 gai_strerrorå‡½æ•°</h3>

<p><code class="language-plaintext highlighter-rouge">getaddrinfo</code>è¿”å›é0å€¼è¡¨ç¤ºé”™è¯¯,è€Œ<code class="language-plaintext highlighter-rouge">gai_strerror</code>å¯ä»¥é€šè¿‡æ­¤é0å€¼è¿”å›ä¸€ä¸ªæŒ‡å‘å¯¹åº”çš„å‡ºé”™ä¿¡æ¯ä¸²çš„æŒ‡é’ˆã€‚å‡½æ•°çš„åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">gai_strerror</span><span class="p">(</span><span class="kt">int</span> <span class="n">error</span><span class="p">);</span>
<span class="c1">// è¿”å›ï¼šæŒ‡å‘é”™è¯¯æè¿°æ¶ˆæ¯å­—ç¬¦ä¸²çš„æŒ‡é’ˆ</span>
</code></pre></div></div>
<p>getaddrinfoè¿”å›çš„é0é”™è¯¯é•¿å€¼ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å¸¸æ•°</th>
      <th style="text-align: left">è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_AGAIN</code></td>
      <td style="text-align: left">åå­—è§£æä¸­ä¸´æ—¶å¤±è´¥</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_BADFLAGS</code></td>
      <td style="text-align: left">ai_flagsçš„å€¼æ— æ•ˆ</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_FAIL</code></td>
      <td style="text-align: left">åå­—è§£æä¸­ä¸å¯æ¢å¤åœ°å¤±è´¥</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_FAMILY</code></td>
      <td style="text-align: left">ä¸æ”¯æŒ ai_family</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_MEMORY</code></td>
      <td style="text-align: left">å†…å­˜åˆ†é…å¤±è´¥</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_NONAME</code></td>
      <td style="text-align: left">hostnameæˆ–serviceæœªæä¾›ï¼Œæˆ–è€…ä¸å¯çŸ¥</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_OVERFLOW</code></td>
      <td style="text-align: left">ç”¨æˆ·å‚æ•°ç¼“å†²åŒºæº¢å‡ºï¼ˆä»…é™ getnameinfo å‡½æ•°ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_SERVICE</code></td>
      <td style="text-align: left">ä¸æ”¯æŒ ai_socktype ç±»å‹çš„service</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_SOCKTYPE</code></td>
      <td style="text-align: left">ä¸æ”¯æŒ ai_socktype</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">EAI_SYSTEM</code></td>
      <td style="text-align: left">åœ¨errnoå˜é‡ä¸­æœ‰ç³»ç»Ÿé”™è¯¯è¿”å›</td>
    </tr>
  </tbody>
</table>

<h3 id="118-freeaddrinfoå‡½æ•°">11.8 freeaddrinfoå‡½æ•°</h3>

<p>getaddrinfoè¿”å›çš„æ‰€æœ‰å­˜å‚¨ç©ºé—´éƒ½æ˜¯åŠ¨æ€è·å–çš„ã€‚éœ€è¦ä½¿ç”¨freeaddrinfoè¿›è¡Œè°ƒç”¨è¿”è¿˜ç»™ç³»ç»Ÿã€‚å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="kt">void</span> <span class="nf">freeaddrinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">addrinfo</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="c1">// ai å‚æ•°åº”æŒ‡å‘ç”± getaddrinfo è¿”å›çš„ç¬¬ä¸€ä¸ª addrinfo ç»“æ„ã€‚</span>
</code></pre></div></div>

<h3 id="119-getaddrinfoå‡½æ•°ipv6">11.9 getaddrinfoå‡½æ•°IPv6</h3>

<p>POSIX è§„èŒƒå®šä¹‰äº† getaddrinfo å‡½æ•°ä»¥åŠè¯¥å‡½æ•°ä¸ºIPV4æˆ–IPV6è¿”å›çš„ä¿¡æ¯ã€‚</p>

<p>æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">getadrinfo</code>åœ¨å¤„ç†ä¸¤ä¸ªä¸åŒçš„è¾“å…¥ï¼š
    <ul>
      <li>ä¸€ä¸ªæ˜¯å¥—æ¥å­—åœ°å€ç»“æ„ç±»å‹ï¼Œè°ƒç”¨è€…æœŸå¾…è¿”å›çš„åœ°å€ç»“æ„ç¬¦åˆè¿™ä¸ªç±»å‹ï¼›</li>
      <li>å¦ä¸€ä¸ªæ˜¯èµ„æºè®°å½•ç±»å‹ï¼Œåœ¨DNSæˆ–è€…å…¶å®ƒæ•°æ®åº“ä¸­æ‰§è¡Œçš„æŸ¥æ‰¾ç¬¦åˆè¿™ä¸ªç±»å‹.</li>
    </ul>
  </li>
  <li>ç”±è°ƒç”¨è€…åœ¨<code class="language-plaintext highlighter-rouge">hints</code>ç»“æ„ä¸­æä¾›çš„åœ°å€æ—æŒ‡å®šè°ƒç”¨è€…æœŸå¾…è¿”å›çš„å¥—æ¥å­—åœ°å€ç»“æ„çš„ç±»å‹</li>
  <li><code class="language-plaintext highlighter-rouge">POSIX</code>å£°ç§°å¦‚æœè°ƒç”¨è€…æŒ‡å®š<code class="language-plaintext highlighter-rouge">AF_UNSPEC</code>,é‚£ä¹ˆ<code class="language-plaintext highlighter-rouge">getaddrinfo</code>å‡½æ•°è¿”å›çš„æ˜¯é€‚åˆäºæŒ‡å®šä¸»æœºåå’ŒæœåŠ¡åä¸”é€‚åˆä»»æ„åè®®æ—çš„åœ°å€.</li>
  <li><code class="language-plaintext highlighter-rouge">POSIX</code>çš„è¿™ä¸ªå£°æ˜ä¹Ÿæ„å‘³ç€å¦‚æœè®¾ç½®äº†<code class="language-plaintext highlighter-rouge">AI_PASSIVE</code>æ ‡å¿—ä½†æ˜¯æ²¡æœ‰æŒ‡å®šä¸»æœºåï¼Œé‚£ä¹ˆIPV6é€šé…åœ°å€(IN6ADDR_ANY_INITæˆ–0::0)åº”è¯¥ä½œä¸º<code class="language-plaintext highlighter-rouge">sockaddr_in6</code>ç»“æ„è¿”å›ï¼ŒåŒæ ·IPV4é€šé…åœ°å€ (INADDR_ANY æˆ– 0.0.0.0)åº”è¯¥ä½œä¸ºsockaddr_inç»“æ„è¿”å›ã€‚</li>
  <li>åœ¨<code class="language-plaintext highlighter-rouge">hints</code>ç»“æ„çš„<code class="language-plaintext highlighter-rouge">ai_family</code>æˆå‘˜ä¸­æŒ‡å®šçš„åœ°å€æ—ä»¥åŠåœ¨<code class="language-plaintext highlighter-rouge">ai_flag</code>sæˆå‘˜ä¸­æŒ‡å®šçš„<code class="language-plaintext highlighter-rouge">AI_V4MAPPED</code>å’Œ<code class="language-plaintext highlighter-rouge">AI_ALL</code>ç­‰æ ‡å¿—å†³å®šäº†åœ¨DNSä¸­æŸ¥æ‰¾çš„èµ„æºè®°å½•ç±»å‹ã€‚</li>
  <li>ä¸»æœºåå‚æ•°è¿˜å¯ä»¥æ˜¯IPV6çš„åå…­è¿›åˆ¶æ•°ä¸²æˆ–IPV4çš„ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²ã€‚è¿™ä¸ªæ•°ä¸²çš„æœ‰æ•ˆæ€§å–å†³äºè°ƒç”¨è€…æŒ‡å®šçš„åœ°å€æ—</li>
</ul>

<p>POSIX è§„èŒƒå®šä¹‰äº† getaddrinfo å‡½æ•°ä»¥åŠè¯¥å‡½æ•°ä¸ºIPV4æˆ–IPV6è¿”å›çš„ä¿¡æ¯ã€‚åœ¨ä¸‹è¡¨æ±‡æ€»è¿™äº›è¿”å›å€¼ä¹‹å‰ï¼Œæˆ‘ä»¬æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>

<ul>
  <li>getaddrinfo åœ¨å¤„ç†ä¸¤ä¸ªä¸åŒçš„è¾“å…¥ï¼šä¸€ä¸ªæ˜¯å¥—æ¥å­—åœ°å€ç»“æ„ç±»å‹ï¼Œè°ƒç”¨è€…æœŸå¾…è¿”å›çš„åœ°å€ç»“æ„ç¬¦åˆè¿™ä¸ªç±»å‹ï¼›å¦ä¸€ä¸ªæ˜¯èµ„æºè®°å½•ç±»å‹ï¼Œåœ¨DNSæˆ–å…¶ä»–æ•°æ®åº“ä¸­æ‰§è¡Œçš„æŸ¥æ‰¾ç¬¦åˆè¿™ä¸ªç±»å‹ã€‚</li>
  <li>ç”±è°ƒç”¨è€…åœ¨hintsç»“æ„ä¸­æä¾›çš„åœ°å€æ—æŒ‡å®šè°ƒç”¨è€…æœŸå¾…è¿”å›çš„å¥—æ¥å­—åœ°å€ç»“æ„çš„ç±»å‹</li>
  <li>POSIXå£°ç§°å¦‚æœè°ƒç”¨è€…æŒ‡å®šAF_UNSPEC,é‚£ä¹ˆ getaddrinfo å‡½æ•°è¿”å›çš„æ˜¯é€‚åˆäºæŒ‡å®šä¸»æœºåå’ŒæœåŠ¡åä¸”é€‚åˆä»»æ„åè®®æ—çš„åœ°å€</li>
  <li>POSIXçš„è¿™ä¸ªå£°æ˜ä¹Ÿæ„å‘³ç€å¦‚æœè®¾ç½®äº† <code class="language-plaintext highlighter-rouge">AI_PASSIVE</code> æ ‡å¿—ä½†æ˜¯æ²¡æœ‰æŒ‡å®šä¸»æœºåï¼Œé‚£ä¹ˆ IPV6 é€šé…åœ°å€ï¼ˆ<code class="language-plaintext highlighter-rouge">IN6ADDR_ANY_INIT</code>æˆ–0::0ï¼‰åº”è¯¥ä½œä¸º <code class="language-plaintext highlighter-rouge">sockaddr_in6</code> ç»“æ„è¿”å›ï¼ŒåŒæ · IPV4 é€šé…åœ°å€ (<code class="language-plaintext highlighter-rouge">INADDR_ANY</code> æˆ– 0.0.0.0)åº”è¯¥ä½œä¸º <code class="language-plaintext highlighter-rouge">sockaddr_in</code> ç»“æ„è¿”å›</li>
  <li>åœ¨<code class="language-plaintext highlighter-rouge">hints</code>ç»“æ„çš„ <code class="language-plaintext highlighter-rouge">ai_family</code> æˆå‘˜ä¸­æŒ‡å®šçš„åœ°å€æ—ä»¥åŠåœ¨<code class="language-plaintext highlighter-rouge">ai_flags</code>æˆå‘˜ä¸­æŒ‡å®šçš„ <code class="language-plaintext highlighter-rouge">AI_V4MAPPED</code> å’Œ <code class="language-plaintext highlighter-rouge">AI_ALL</code> ç­‰æ ‡å¿—å†³å®šäº†åœ¨ DNSä¸­æŸ¥æ‰¾çš„èµ„æºè®°å½•ç±»å‹</li>
  <li>ä¸»æœºåå‚æ•°è¿˜å¯ä»¥æ˜¯IPV6çš„åå…­è¿›åˆ¶æ•°ä¸²æˆ–IPV4çš„ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²ã€‚è¿™ä¸ªæ•°ä¸²çš„æœ‰æ•ˆæ€§å–å†³äºè°ƒç”¨è€…æŒ‡å®šçš„åœ°å€æ—</li>
</ul>

<hr />

<table>
<tbody>
<tr>
<td>&nbsp;è°ƒç”¨è€…æŒ‡å®šçš„ä¸»æœºå</td>
<td>&nbsp;è°ƒç”¨è€…æŒ‡å®šçš„åœ°å€æ—</td>
<td>&nbsp;ä¸»æœºåå­—ç¬¦ä¸²åŒ…å«</td>
<td>&nbsp;ç»“æœ</td>
<td>è¡Œä¸º&nbsp;</td>
</tr>
<tr>
<td rowspan="11">éç©ºä¸»æœºåå­—ç¬¦ä¸²ï¼šä¸»åŠ¨æˆ–è¢«åŠ¨&nbsp;</td>
<td rowspan="3">AF_UNSPEC&nbsp;</td>
<td>&nbsp;ä¸»æœºå</td>
<td>ä»¥ sockaddr_in6{} è¿”å›æ‰€æœ‰ AAAA è®°å½•ï¼Œä»¥ sockaddr_in{} è¿”å›æ‰€æœ‰Aè®°å½•</td>
<td>AAAAè®°å½•æœç´¢åŠ ä¸ŠAè®°å½•æœç´¢&nbsp;</td>
</tr>
<tr>
<td>&nbsp;åå…­è¿›åˆ¶æ•°ä¸²</td>
<td>&nbsp;ä¸€ä¸ªsockaddr_in6{}</td>
<td>&nbsp;inet_pton(AF_INET6)</td>
</tr>
<tr>
<td>&nbsp;ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²</td>
<td>&nbsp;ä¸€ä¸ªsockaddr_in{}</td>
<td>&nbsp;inet_pton(AF_INET)&nbsp;</td>
</tr>
<tr>
<td rowspan="5">AF_INET6&nbsp;</td>
<td rowspan="3">&nbsp;ä¸»æœºå</td>
<td>ä»¥ sockaddr_in6{} è¿”å›æ‰€æœ‰ AAAA è®°å½•</td>
<td>&nbsp;AAAAè®°å½•æœç´¢</td>
</tr>
<tr>
<td>&nbsp;åœ¨ ai_flags å« AI_V4MAPPEDå‰æä¸‹ï¼šè‹¥å­˜åœ¨AAAAè®°å½•åˆ™ä»¥ sockaddr_in6{} è¿”å›æ‰€æœ‰ AAAA è®°å½•ï¼›å¦åˆ™ä»¥ sockaddr_in6{}ä½œä¸ºIPV4æ˜ å°„çš„IPV6åœ°å€è¿”å›æ‰€æœ‰Aè®°å½•</td>
<td>AAAAè®°å½•æœç´¢ï¼Œè‹¥æ— ç»“æœåˆ™Aè®°å½•æœç´¢&nbsp;&nbsp;</td>
</tr>
<tr>
<td>&nbsp;åœ¨ ai_flags å«&nbsp;AI_V4MAPPEDå’Œ AI_ALLå‰æä¸‹ï¼šä»¥ sockaddr_in6{} è¿”å›æ‰€æœ‰ AAAA è®°å½•ï¼Œå¹¶ä¸”ä»¥ sockaddr_in6{}ä½œä¸ºIPV4æ˜ å°„çš„IPV6åœ°å€è¿”å›æ‰€æœ‰Aè®°å½•</td>
<td>AAAAè®°å½•æœç´¢åŠ ä¸ŠAè®°å½•æœç´¢&nbsp;&nbsp;</td>
</tr>
<tr>
<td>&nbsp;åå…­è¿›åˆ¶æ•°ä¸²</td>
<td>&nbsp;ä¸€ä¸ªsockaddr_in6{}</td>
<td>&nbsp;inet_pton(AF_INET6)</td>
</tr>
<tr>
<td>&nbsp;ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²</td>
<td>&nbsp;ä½œä¸ºä¸»æœºåæŸ¥æ‰¾</td>
<td>&nbsp;</td>
</tr>
<tr>
<td rowspan="3">&nbsp;AF_INET</td>
<td>&nbsp;ä¸»æœºå</td>
<td>&nbsp;ä»¥ sockaddr_in{} è¿”å›æ‰€æœ‰Aè®°å½•</td>
<td>&nbsp;Aè®°å½•æœç´¢</td>
</tr>
<tr>
<td>&nbsp;&nbsp;åå…­è¿›åˆ¶æ•°ä¸²</td>
<td>&nbsp;&nbsp;ä½œä¸ºä¸»æœºåæŸ¥æ‰¾</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>&nbsp;&nbsp;ç‚¹åˆ†åè¿›åˆ¶æ•°ä¸²</td>
<td>&nbsp;ä¸€ä¸ªsockaddr_in{}</td>
<td>&nbsp;inet_pton(AF_INET)&nbsp;</td>
</tr>
<tr>
<td rowspan="3">ç©ºä¸»æœºåå­—ç¬¦ä¸²ï¼šè¢«åŠ¨&nbsp;</td>
<td>&nbsp;AF_UNSPEC</td>
<td>
<p>&nbsp;éšå«0::0</p>
<p>éšå«0.0.0.0</p>
</td>
<td>&nbsp;ä¸€ä¸ªsockaddr_in6{}å’Œ ä¸€ä¸ªsockaddr_in{}</td>
<td>
<p>&nbsp;inet_pton(AF_INET6)</p>
<p>&nbsp;inet_pton(AF_INET)&nbsp;</p>
</td>
</tr>
<tr>
<td>&nbsp;AF_INET6</td>
<td>&nbsp;éšå«0::0</td>
<td>&nbsp;&nbsp;ä¸€ä¸ªsockaddr_in6{}</td>
<td>&nbsp;inet_pton(AF_INET6)</td>
</tr>
<tr>
<td>&nbsp;AF_INET</td>
<td>éšå«0.0.0.0&nbsp;</td>
<td>&nbsp;&nbsp;ä¸€ä¸ªsockaddr_in{}</td>
<td>&nbsp;inet_pton(AF_INET)</td>
</tr>
<tr>
<td rowspan="3">ç©ºä¸»æœºåå­—ç¬¦ä¸²ï¼šä¸»åŠ¨&nbsp;&nbsp;</td>
<td>&nbsp;AF_UNSPEC</td>
<td>
<p>éšå«0::1</p>
<p>éšå«127.0.0.1&nbsp;</p>
</td>
<td>ä¸€ä¸ªsockaddr_in6{}å’Œ ä¸€ä¸ªsockaddr_in{}&nbsp;</td>
<td>
<p>&nbsp;inet_pton(AF_INET6)</p>
<p>&nbsp;inet_pton(AF_INET)&nbsp;</p>
</td>
</tr>
<tr>
<td>&nbsp;AF_INET6</td>
<td>&nbsp;éšå«0::1</td>
<td>&nbsp;&nbsp;ä¸€ä¸ªsockaddr_in6{}</td>
<td>&nbsp;inet_pton(AF_INET6)</td>
</tr>
<tr>
<td>&nbsp;AF_INET</td>
<td>&nbsp;éšå«127.0.0.1</td>
<td>&nbsp;&nbsp;ä¸€ä¸ªsockaddr_in{}</td>
<td>&nbsp;inet_pton(AF_INET)</td>
</tr>
</tbody>
</table>

<hr />

<h3 id="1110-getaddrinfoå‡½æ•°ä¾‹å­">11.10 getaddrinfoå‡½æ•°ï¼Œä¾‹å­</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">do_funccall</span><span class="p">(</span>
                        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span><span class="cm">/* ä¸»æœºå */</span>
                        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span><span class="cm">/* æœåŠ¡å™¨å */</span>
                        <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="cm">/* æ ‡å¿—å‚æ•° */</span>
                        <span class="kt">int</span> <span class="n">family</span><span class="p">,</span><span class="cm">/* å¥—æ¥å­—åè®®æ— */</span>
                        <span class="kt">int</span> <span class="n">sockettype</span><span class="p">,</span> <span class="cm">/* å¥—æ¥å­—ç±»å‹ */</span>
                        <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="cm">/* æ§åˆ¶åè®® */</span>
                        <span class="kt">int</span> <span class="n">exprc</span> <span class="cm">/* æ§åˆ¶åè®®æ— */</span>
                        <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
    <span class="cm">/* å®šä¹‰åœ°å€ç»“æ„ä½“ */</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
    <span class="cm">/* åˆå§‹åŒ–ç»“æ„ä½“ */</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span><span class="o">=</span><span class="n">flags</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span><span class="o">=</span><span class="n">family</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">socktype</span><span class="p">;</span>
	<span class="n">hints</span><span class="p">.</span><span class="n">ai_protocol</span> <span class="o">=</span> <span class="n">protocol</span><span class="p">;</span>
    <span class="cm">/* æ‰§è¡Œå‡½æ•° */</span>
    <span class="n">rc</span><span class="o">=</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">serv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">rc</span><span class="o">!=</span><span class="n">exprc</span><span class="p">){</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"expected return = %d (%s),</span><span class="se">\n</span><span class="s">actual return = %d (%s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">exprc</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">exprc</span><span class="p">),</span> <span class="n">rc</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">rc</span><span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="n">host</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">" host =%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">host</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">serv</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">" serv=%s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">serv</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"  flags = %d, family = %s, socktype = %s, protocol = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
				<span class="n">flags</span><span class="p">,</span> <span class="n">str_fam</span><span class="p">(</span><span class="n">family</span><span class="p">),</span> <span class="n">str_sock</span><span class="p">(</span><span class="n">socktype</span><span class="p">),</span> <span class="n">protocol</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="1111-host_servå‡½æ•°">11.11 host_servå‡½æ•°</h3>

<p>è®¿é—®getaddrinfoçš„ç¬¬ä¸€ä¸ªæ¥å£å‡½æ•°ä¸è¦æ±‚è°ƒç”¨è€…è°ƒç”¨è€…åˆ†é…å¹¶å¡«å†™ä¸€ä¸ª hints ç»“æ„ã€‚è¯¥ç»“æ„ä¸­æˆ‘ä»¬æ„Ÿå…´è¶£çš„ä¸¤ä¸ªå­—æ®µ(<strong>åœ°å€æ—å’Œå¥—æ¥å­—ç±»å‹</strong>)æˆä¸ºè¿™ä¸ªåä¸ºhost_servçš„æ¥å£å‡½æ•°çš„å‚æ•°ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span><span class="c1">//è¿”å›è‹¥æˆåŠŸåˆ™æŒ‡å‘addrinfoç»“æ„çš„æŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸ºNULL</span>

<span class="k">struct</span> <span class="nc">addrinfo</span> <span class="o">*</span><span class="nf">host_serv</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hostname</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span><span class="kt">int</span> <span class="n">socktype</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span><span class="o">*</span><span class="n">res</span><span class="p">;</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="cm">/* always return canonical name */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span><span class="o">=</span><span class="n">AI_CANONNAME</span><span class="p">;</span>
    <span class="cm">/* AF_UNSPEC,AF_INET,AF_INET6,etc */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span><span class="o">=</span><span class="n">family</span><span class="p">;</span>
    <span class="cm">/* 0,SOCK_STREAM,SOCK_DGRAM,etc */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span><span class="o">=</span><span class="n">socktype</span><span class="p">;</span>
    <span class="cm">/* æ‰§è¡Œå‡½æ•°ï¼Œè¿›è¡Œæ£€æŸ¥ */</span>
    <span class="k">if</span><span class="p">((</span><span class="n">n</span><span class="o">=</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span><span class="n">serv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="o">&amp;</span><span class="n">res</span><span class="p">))</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="1112-tcp_connectå‡½æ•°">11.12 tcp_connectå‡½æ•°</h3>

<p>tcp_connectå‡½æ•°æ‰§è¡Œå®¢æˆ·çš„é€šå¸¸æ­¥éª¤ï¼šåˆ›å»ºä¸€ä¸ªTCPå¥—æ¥å­—å¹¶è¿æ¥åˆ°ä¸€ä¸ªæœåŠ¡å™¨ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="c1">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºå·²è¿æ¥çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸è¿”å›</span>
<span class="kt">int</span> <span class="nf">tcp_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">service</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* å®šä¹‰socketå¥—æ¥å­— */</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="cm">/* å®šä¹‰åœ°å€ä¿¡æ¯ç»“æ„ä½“ */</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">ressave</span><span class="p">;</span>
    <span class="cm">/* åˆå§‹åŒ–ç»“æ„ä½“ */</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="cm">/* è¿›è¡Œåˆå§‹åŒ– */</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_STREAM</span><span class="p">;</span>
    <span class="cm">/* æŸ¥è¯¢åœ°å€ */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"tcp_connect error for %s , %s : %s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span><span class="n">gai_strerror</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">ressave</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
    <span class="cm">/* éå†ç»“æœè¿›è¡Œè¿æ¥ */</span>
    <span class="k">do</span><span class="p">{</span>
        <span class="cm">/* åˆ›å»ºå’Œåˆå§‹åŒ–å¥—æ¥å­— */</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="cm">/* å»ºç«‹è¿æ¥ */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// ignore this one</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// success</span>
        <span class="cm">/* å…³é—­è¿æ¥ */</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span> <span class="c1">// ignore this one</span>
    <span class="p">}</span><span class="k">while</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="cm">/* æ£€æŸ¥ç»“æœ */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="c1">// errno set from final connect()</span>
        <span class="n">err_sys</span><span class="p">(</span><span class="s">"tcp_connect error for %s ,%s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">service</span><span class="p">);</span>
    <span class="cm">/* é‡Šæ”¾å†…å­˜ */</span>
    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">ressave</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sockfd</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>ä¾‹å­ï¼šæ—¶é—´è·å–å®¢æˆ·ç¨‹åº</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">socket</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">recvline</span><span class="p">[</span><span class="n">MAXLINE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">socklen_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_storage</span> <span class="n">ss</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">3</span><span class="p">)</span> <span class="n">err_quit</span><span class="p">(</span><span class="s">"usage : daytimetcpcli &lt;hostname/IPaddress&gt; &lt;service/prot#&gt;"</span><span class="p">);</span>
    <span class="cm">/* å»ºç«‹TCPè¿æ¥ */</span>
    <span class="n">sockfd</span><span class="o">=</span><span class="n">tcp_conect</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
    <span class="n">len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
    <span class="cm">/* è·å–å¯¹ç«¯(æœåŠ¡å™¨)çš„åè®®åœ°å€ */</span>
    <span class="n">Getpeername</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
    <span class="cm">/* è¾“å‡ºè§£æåœ°å€ */</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"connected to %s </span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Sock_ntop_host</span><span class="p">((</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>
    <span class="cm">/* å¤„ç†å¥—æ¥å­—è¿æ¥ */</span>
    <span class="k">while</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="n">Read</span><span class="p">(</span><span class="n">sockd</span><span class="p">,</span><span class="n">recvline</span><span class="p">,</span><span class="n">MAXLINE</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">recvline</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">Fputs</span><span class="p">(</span><span class="n">recvline</span><span class="p">,</span><span class="n">stdout</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="1113-tcp_listenå‡½æ•°">11.13 tcp_listenå‡½æ•°</h3>

<p><code class="language-plaintext highlighter-rouge">tcp_listen</code>å‡½æ•°æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">TCP</code>æœåŠ¡å™¨çš„é€šå¸¸æ­¥éª¤ï¼šåˆ›å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">TCP</code>å¥—æ¥å­—ï¼Œç»™å®ƒæ†ç»‘æœåŠ¡å™¨çš„ä¼—æ‰€å‘¨çŸ¥çš„ç«¯å£ï¼Œå¹¶å…è®¸æ¥å—å¤–æ¥çš„è¿æ¥è¯·æ±‚ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span><span class="cm">/* è‹¥æˆåŠŸåˆ™ä¸ºå¥—æ¥å­—æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸è¿”å› */</span>
<span class="kt">int</span> <span class="nf">tcp_listen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span><span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* åˆå§‹åŒ–ç›¸å…³å˜é‡ */</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">on</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span><span class="o">*</span><span class="n">res</span><span class="p">,</span><span class="o">*</span><span class="n">ressave</span><span class="p">;</span>

    <span class="cm">/* åˆå§‹åŒ–ç›¸å…³å˜é‡ */</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span><span class="o">=</span><span class="n">AI_PASSIVE</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span><span class="o">=</span><span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span><span class="o">=</span><span class="n">SOCK_STREAM</span><span class="p">;</span>
    <span class="cm">/* è·å–åœ°å€ä¿¡æ¯ */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"tcp_listen error for %s , %s : %s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">ressave</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
    <span class="cm">/* éå†æŸ¥è¯¢ç»“æœ */</span>
    <span class="k">do</span><span class="p">{</span>
        <span class="cm">/* åˆ›å»ºsocket */</span>
        <span class="n">listenfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="c1">//error next</span>
        <span class="k">if</span><span class="p">(</span><span class="n">listenfd</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="cm">/* è®¾ç½®socketé€‰é¡¹;é˜²æ­¢ç«¯å£å·²ç»æœ‰è¿æ¥å­˜åœ¨ */</span>
        <span class="n">Setsockopt</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="n">SO_REUSEADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">on</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">on</span><span class="p">));</span>
        <span class="cm">/* è¿æ¥åœ°å€å’Œç«¯å£ */</span>
        <span class="k">if</span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="err">ï¼Œ</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">listenfd</span><span class="p">);</span>
    <span class="p">}</span><span class="k">while</span><span class="p">((</span><span class="n">res</span><span class="o">=</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">res</span><span class="o">==</span><span class="nb">NULL</span><span class="p">){</span>
        <span class="n">err_sys</span><span class="p">(</span><span class="s">"tcp listen error for %s,%s "</span><span class="p">,</span><span class="n">host</span><span class="p">,</span><span class="n">serv</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">Listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="n">LISTENQ</span><span class="p">);</span>
    <span class="cm">/* è¿”å›åè®®åœ°å€ */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">addrlenp</span><span class="p">){</span>
        <span class="o">*</span><span class="n">addrlenp</span><span class="o">=</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">ressave</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">listendfd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¾‹å­1ï¼šæ—¶é—´è·å–æœåŠ¡å™¨ç¨‹åº</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
#include &lt;time.h&gt;
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="cm">/* é¢„å®šä¹‰å˜é‡ */</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span><span class="n">connfd</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="kt">time_t</span> <span class="n">ticks</span><span class="p">;</span>
    <span class="cm">/* å®¢æˆ·ç«¯åœ°å€ */</span>
    <span class="k">struct</span> <span class="nc">sockaddr_storage</span> <span class="n">cliaddr</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">argc</span><span class="o">!=</span><span class="mi">2</span><span class="p">){</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"usage:datatime cpsrvl &lt;service or support #&gt;"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">listenfd</span><span class="o">=</span><span class="n">tcp_listen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">){</span>
        <span class="n">len</span><span class="o">=</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
        <span class="n">connfd</span><span class="o">=</span><span class="n">Accpet</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="n">SA</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"connect from %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">Sock_ntop_host</span><span class="p">((</span><span class="n">SA</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span><span class="n">len</span><span class="p">));</span>
        <span class="n">ticks</span><span class="o">=</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span><span class="s">"%.24s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ticks</span><span class="p">));</span>
        <span class="n">Write</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span><span class="n">buff</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æ³¨æ„ï¼šä¸Šè¿°ç¨‹åºä¸­ï¼Œ<code class="language-plaintext highlighter-rouge">tcp_listen</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆï¼Œè€Œä¸”tcp_listenå‡½æ•°å†…éƒ¨æŒ‡å®šçš„åœ°å€ç»„<code class="language-plaintext highlighter-rouge">AF_UNSPEC</code>ï¼Œä¸¤ä¸ªç»“åˆå¯èƒ½å¯¼è‡´<code class="language-plaintext highlighter-rouge">getaddrinfo</code>è¿”å›éæœŸæœ›åœ°å€æ—çš„å¥—æ¥å­—ç»“æ„â€“åŒæ ˆä¸»æœºä¸Šè¿”å›çš„ç¬¬ä¸€ä¸ªå¥—æ¥å­—åœ°å€ç»“æ„å°†æ˜¯IPv6çš„ï¼Œä½†æ˜¯æˆ‘ä»¬æœŸæœ›è¯¥æœåŠ¡å™¨ä»…ä»…å¤„ç†IPv4.</p>

<p>ä¾‹å­2ï¼šå¯æŒ‡å®šåè®®çš„æ—¶é—´è·å–æœåŠ¡å™¨ç¨‹åº:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="cp">#include &lt;time.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span> <span class="n">connfd</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">addrlen</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="kt">time_t</span> <span class="n">ticks</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_storage</span> <span class="n">cliaddr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">listenfd</span> <span class="o">=</span> <span class="n">tcp_listen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addrlen</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">listenfd</span> <span class="o">=</span> <span class="n">tcp_listen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">addrlen</span><span class="p">);</span>
    <span class="k">else</span> <span class="n">err_quit</span><span class="p">(</span><span class="s">"usage : daytimetcpsrv2 [&lt;host&gt;] &lt;sevice or port&gt;"</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
        <span class="n">connfd</span> <span class="o">=</span> <span class="n">Accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"connection from %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Sock_ntop_host</span><span class="p">((</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>

        <span class="n">ticks</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">"%.24s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ticks</span><span class="p">));</span>
        <span class="n">Write</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>

        <span class="n">Close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="1114-udp_clientå‡½æ•°">11.14 udp_clientå‡½æ•°</h3>

<p>udp_clientï¼š ç”¨äºåˆ›å»ºæœªè¿æ¥çš„ UDP å¥—æ¥å­—ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="cm">/* è‹¥æˆåŠŸåˆ™ä¸ºæœªè¿æ¥å¥—æ¥å­—æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸è¿”å› */</span>

<span class="kt">int</span> <span class="nf">udp_client</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="n">SA</span> <span class="o">**</span><span class="n">saptr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">lenp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="o">*</span><span class="n">ressave</span><span class="p">;</span>

    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>
    <span class="cm">/* è¿™é‡Œè·å–çš„èµ·å§‹æ˜¯æœåŠ¡å™¨çš„IPå’Œç«¯å£,è€Œæ¬¡å‡½æ•°çš„åŠŸèƒ½ä¸º,è¿”å›æœåŠ¡å™¨å¥—æ¥å­—ç»“æ„åœ°å€å’Œæœ¬åœ°å¥—æ¥å­—*/</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"udp_client erorr for %s, %s : %s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
    <span class="n">ressave</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="cm">/* å¯¹äºUDPå¥—æ¥å­—æ˜¯å¯ä»¥ä¸ç»‘å®šçš„ç«¯å£çš„,åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨sendtoçš„æ—¶å€™ç”±å†…æ ¸æŒ‡å®šä¸€ä¸ªä¸´æ—¶ç«¯å£ */</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">err_sys</span><span class="p">(</span><span class="s">"udp_client error for %s , %s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="cm">/* åˆ†é…åœ°å€å†…å­˜ */</span>
    <span class="o">*</span><span class="n">saptr</span> <span class="o">=</span> <span class="n">Malloc</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
    <span class="cm">/* å°†ç»“æœå¤åˆ¶åˆ°resä¸­ */</span>
    <span class="n">memecpy</span><span class="p">(</span><span class="o">*</span><span class="n">saptr</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">);</span>
    <span class="cm">/* è¿”å›åœ°å€é•¿åº¦ */</span>
    <span class="o">*</span><span class="n">lenp</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">;</span>
    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">ressave</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>ä¾‹å­ï¼šåè®®æ— å…³æ—¶é—´è·å–å®¢æˆ·ç¨‹åº</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">recvline</span><span class="p">[</span><span class="n">MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="n">socklen_t</span> <span class="n">salen</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span> <span class="n">sa</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="n">err_quit</span><span class="p">(</span><span class="s">"usage : daytimeudpcli1 &lt;hostname/IPaddress&gt; &lt;service/port#&gt;"</span><span class="p">);</span>

    <span class="n">sockfd</span> <span class="o">=</span> <span class="n">Udp_client</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">salen</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"sending to %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Sock_ntop_host</span><span class="p">(</span><span class="n">sa</span><span class="p">,</span> <span class="n">salen</span><span class="p">));</span>
    <span class="cm">/* send 1 byte datagram */</span>
    <span class="n">Sendto</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">salen</span><span class="p">);</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">Recvfrom</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">recvline</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">recvline</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="err">'</span><span class="o">&lt;!</span><span class="n">JEKYLL</span><span class="err">@</span><span class="mi">4800</span><span class="err">@</span><span class="mi">140</span><span class="o">&gt;</span><span class="err">'</span><span class="p">;</span>
    <span class="n">Fputs</span><span class="p">(</span><span class="n">recvline</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="1115-udp_connect">11.15 udp_connect</h3>

<p>è¯¥å‡½æ•°åˆ›å»ºä¸€ä¸ªå·²è¿æ¥UDPå¥—æ¥å­—</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include "unp.h"
</span>
<span class="c1">// è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºä»¥è¿æ¥å¥—æ¥å­—æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸è¿”å›</span>
<span class="kt">int</span> <span class="nf">udp_connect</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">*</span> <span class="n">ressave</span><span class="p">;</span>

    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>

    <span class="k">if</span><span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"udp_connect error for %s, %s : %s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">ressave</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span> 
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">err_sys</span><span class="p">(</span><span class="s">"udp_connect error for %s, %s "</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">ressave</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sockfd</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<h3 id="1116-udp_server">11.16 udp_server</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>

<span class="cm">/* è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºä»¥è¿æ¥å¥—æ¥å­—æè¿°ç¬¦ï¼Œè‹¥å‡ºé”™åˆ™ä¸è¿”å› */</span>
<span class="kt">int</span> <span class="nf">udp_server</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">serv</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlenp</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">addrinfo</span> <span class="n">hints</span><span class="p">,</span> <span class="o">*</span> <span class="n">res</span><span class="p">,</span> <span class="o">*</span> <span class="n">ressave</span><span class="p">;</span>

    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="nc">addrinfo</span><span class="p">));</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_flags</span> <span class="o">=</span> <span class="n">AI_PASSIVE</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span> <span class="o">=</span> <span class="n">AF_UNSPEC</span><span class="p">;</span>
    <span class="n">hints</span><span class="p">.</span><span class="n">ai_socktype</span> <span class="o">=</span> <span class="n">SOCK_DGRAM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span> <span class="n">getaddrinfo</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"udp_server error for %s, %s : %s"</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">,</span> <span class="n">gai_strerror</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
    <span class="n">ressave</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sockfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">addrlen</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">Close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_next</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">err_sys</span><span class="p">(</span><span class="s">"udp_server error for %s, %s "</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">serv</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">addrlenp</span><span class="p">)</span> <span class="o">*</span><span class="n">addrlenp</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">;</span>
    <span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">ressave</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sockfd</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>ä¾‹å­ï¼šåè®®æ— å…³æ—¶é—´è·å–æœåŠ¡å™¨ç¨‹åº</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span>
<span class="cp">#include &lt;time.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
    <span class="kt">int</span>				<span class="n">sockfd</span><span class="p">;</span>
    <span class="kt">ssize_t</span>			<span class="n">n</span><span class="p">;</span>
    <span class="kt">char</span>			<span class="n">buff</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="kt">time_t</span>			<span class="n">ticks</span><span class="p">;</span>
    <span class="n">socklen_t</span>		<span class="n">len</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">sockaddr_storage</span>	<span class="n">cliaddr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">udp_server</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">sockfd</span> <span class="o">=</span> <span class="n">udp_server</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">err_quit</span><span class="p">(</span><span class="s">"usage: daytimeudpsrv [ &lt;host&gt; ] &lt;service or port&gt;"</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Recvfrom</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"datagram from %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Sock_ntop</span><span class="p">((</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">));</span>

        <span class="n">ticks</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">"%.24s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ticks</span><span class="p">));</span>
        <span class="n">Sendto</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="1117-getnameinfo">11.17 getnameinfo</h3>

<p>è¿™ä¸ªæ˜¯getaddrinfoçš„è¡¥å……å«ç³Šï¼Œä½¿ç”¨ä¸€ä¸ªå¥—æ¥å­—åœ°å€ä¸ºå‚æ•°ï¼Œè¿”å›æè¿°ä¸­çš„ä¸»å¥çš„ä¸€ä¸ªå­—ç¬¦ä¸²å’Œæè¿°å…¶ä¸­çš„æœåŠ¡çš„å¦ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥ä¸å…³å¿ƒåœ°å€åè®®çš„ç±»å‹ï¼Œç”±å‡½æ•°è‡ªèº«å¤„ç†ã€‚å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netdb.h&gt;
</span><span class="cm">/* è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸º0ï¼Œè‹¥å‡ºé”™åˆ™ä¸ºé0 */</span>
<span class="kt">int</span> <span class="nf">getnameinfo</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sockaddr</span><span class="p">,</span><span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span><span class="n">socklen_t</span> <span class="n">hostlen</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span> <span class="n">serv</span><span class="p">,</span><span class="n">socklen_t</span> <span class="n">servlen</span><span class="p">,</span><span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</code></pre></div></div>
<p>å‚æ•°è§£æ:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">sockaddr</code>å’Œ<code class="language-plaintext highlighter-rouge">addrlen</code>æŒ‡å®šä¸€ä¸ªå¥—æ¥å­—åœ°å€ç»“æ„ï¼Œæ­¤å¥—æ¥å­—åœ°å€ç»“æ„åŒ…å«è½¬æ¢æˆç›´è§‚å¯è¯»çš„å­—ç¬¦çš„åè®®åœ°å€</li>
  <li><code class="language-plaintext highlighter-rouge">host</code>å’Œ<code class="language-plaintext highlighter-rouge">hostlen</code>æŒ‡å®šä¸»æœºå­—ç¬¦ä¸²(ç”±è°ƒç”¨è€…é¢„å…ˆåˆ†é…å­˜å‚¨ç©ºé—´)(è°ƒç”¨è€…ä¸æƒ³è¿”å›ä¸»æœºå­—ç¬¦ä¸²ï¼›é‚£å°±æŒ‡å®š<code class="language-plaintext highlighter-rouge">hostlen</code>ä¸º0);</li>
  <li><code class="language-plaintext highlighter-rouge">serv</code>å’ŒserlenæŒ‡å®šæœåŠ¡å­—ç¬¦ä¸²(ç”±è°ƒç”¨è€…é¢„å…ˆåˆ†é…å­˜å‚¨ç©ºé—´)(è°ƒç”¨è€…ä¸æƒ³è¿”å›æœåŠ¡å­—ç¬¦ä¸²ï¼Œé‚£å°±æŒ‡å®š<code class="language-plaintext highlighter-rouge">servlen</code>ä¸º0)</li>
</ul>

<p>sock_ntop å’Œ getnameinfo çš„å·®åˆ«åœ¨äºï¼Œå‰è€…ä¸æ¶‰åŠDNSï¼Œåªè¿”å›IP åœ°å€å’Œç«¯å£å·çš„ä¸€ä¸ªå¯æ˜¾ç¤ºç‰ˆæœ¬,åè€…é€šå¸¸å°è¯•è·å–ä¸»æœºå’ŒæœåŠ¡çš„åå­—</p>

<p>getnameinfoå‡½æ•°6ä¸ªå¯æŒ‡å®šçš„æ ‡å¿—ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">**å¸¸å€¼**</th>
      <th style="text-align: left">**è¯´æ˜**</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NI_DGRAM</code></td>
      <td style="text-align: left">æ•°æ®æŠ¥æœåŠ¡</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NI_NAMEREQD</code></td>
      <td style="text-align: left">è‹¥ä¸èƒ½ä»åœ°å€è§£æå‡ºåå­—åˆ™è¿”å›é”™è¯¯</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NI_NOFQDN</code></td>
      <td style="text-align: left">åªè¿”å›<code class="language-plaintext highlighter-rouge">FQDN</code>çš„ä¸»æœºåéƒ¨åˆ†,ä¸€èˆ¬æ˜¯ä¸»æœºåç§°å¦‚<code class="language-plaintext highlighter-rouge">aix</code>è€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">aix.unpbook.com</code></td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NI_NUMERICHOST</code></td>
      <td style="text-align: left">ä»¥æ•°ä¸²æ ¼å¼è¿”å›ä¸»æœºå­—ç¬¦ä¸²ï¼Œè¿™æ ·getnameinfoå°±ä¸ä¼šè°ƒç”¨DNS,è€Œæ˜¯ç›´æ¥è¿”å›IPåœ°å€</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NI_NUMERICSCOPE</code></td>
      <td style="text-align: left">ä»¥æ•°ä¸²æ ¼å¼è¿”å›èŒƒå›´æ ‡è¯†å­—ç¬¦ä¸²</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NI_NUMERICSERV</code></td>
      <td style="text-align: left">ä»¥æ•°ä¸²æ ¼å¼è¿”å›æœåŠ¡å­—ç¬¦ä¸²</td>
    </tr>
  </tbody>
</table>

<p>å½“å¤„ç†çš„æ˜¯æ•°æ®æŠ¥å¥—æ¥å­—æ—¶ï¼Œè°ƒç”¨è€…åº”è¯¥è®¾ç½®<code class="language-plaintext highlighter-rouge">NI_DGRAM</code>æ ‡å¿—ã€‚å¦åˆ™getnameinfoæ— æ³•ç¡®å®šæ‰€ç”¨åè®®(TCPå’ŒUDP)ã€‚</p>

<h3 id="1118-å¯é‡å…¥å‡½æ•°å®‰å…¨çš„å¯è¢«ä¸­æ–­è€Œä¸å‡ºé”™çš„å‡½æ•°">11.18 å¯é‡å…¥å‡½æ•°ï¼ˆå®‰å…¨çš„ï¼Œå¯è¢«ä¸­æ–­è€Œä¸å‡ºé”™çš„å‡½æ•°ï¼‰</h3>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em> <a href="https://blog.csdn.net/u011123091/article/details/81748686">æµ…è°ˆå¯é‡å…¥å‡½æ•°ä¸ä¸å¯é‡å…¥å‡½æ•°</a></p>

<p>æŸ¥çœ‹æœ¬ç« è®²è§£çš„åå­—å’Œåœ°å€è½¬æ¢å‡½æ•°ä»¥åŠç¬¬4ç« ä¸­çš„inet_XXXå‡½æ•°ï¼Œæˆ‘ä»¬å°±é‡å…¥å‡½æ•°æè¯·æ³¨æ„ä»¥ä¸‹å‡ ç‚¹:</p>
<ul>
  <li>é‡ç”¨ç›¸å…³å‡½æ•°
    <ul>
      <li>å› å†å²åŸå› , <code class="language-plaintext highlighter-rouge">gethostbyname</code>, <code class="language-plaintext highlighter-rouge">gethostbyname</code>, <code class="language-plaintext highlighter-rouge">getservbyname</code>, <code class="language-plaintext highlighter-rouge">getservbyport</code> è¿™4ä¸ªå‡½æ•°æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå› ä¸ºä»–ä»¬éƒ½è¿”å›æŒ‡å‘åŒä¸€ä¸ªé™æ€ç»“æ„çš„æŒ‡é’ˆ(å¯èƒ½åœ¨é™æ€ç»“æ„å¯èƒ½è¢«å›è°ƒå‡½æ•°ä¿®æ”¹äº†)</li>
      <li><code class="language-plaintext highlighter-rouge">inet_pton</code>,<code class="language-plaintext highlighter-rouge">inet_ntop</code>æ€»æ˜¯å¯é‡å…¥çš„</li>
      <li>å› å†å²åŸå› ï¼Œ<code class="language-plaintext highlighter-rouge">inet_ntoa</code>æ˜¯ä¸å¯é‡å…¥çš„ï¼Œä¸è¿‡æ”¯æŒçº¿ç¨‹çš„ä¸€äº›å®ç°æä¾›äº†ä½¿ç”¨çº¿ç¨‹ç‰¹å®šæ•°æ®çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">getaddrinfo</code> å¯é‡å…¥çš„å‰ææ˜¯å®ƒè°ƒç”¨çš„å‡½æ•°éƒ½æ˜¯å¯é‡å…¥çš„ï¼Œè¿™å°±æ˜¯è¯´ï¼Œä»–åº”è¯¥è°ƒç”¨å¯é‡å…¥ç‰ˆæœ¬çš„ <code class="language-plaintext highlighter-rouge">gethostbyname</code>å’Œ<code class="language-plaintext highlighter-rouge">getservbyname</code>ã€‚è¯¥å‡½æ•°è¿”å›çš„ç»“æœå…¨éƒ¨å­˜æ”¾åœ¨åŠ¨æ€åˆ†é…å†…å­˜ç©ºé—´çš„åŸå› ä¹‹ä¸€å°±æ˜¯å…è®¸å®ƒå¯é‡å…¥ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">getnameinfo</code>å¯é‡å…¥çš„å‰ææ˜¯å®ƒè°ƒç”¨çš„å‡½æ•°éƒ½æ˜¯å¯é‡å…¥çš„ï¼Œè¿™å°±æ˜¯è¯´ï¼Œä»–åº”è¯¥è°ƒç”¨å¯é‡å…¥ç‰ˆæœ¬çš„ <code class="language-plaintext highlighter-rouge">gethostbyaddr</code>å’Œ<code class="language-plaintext highlighter-rouge">getservbyport</code></li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">errono</code>å˜é‡å­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼š é¦–å…ˆå› è¯¥æ³¨æ„è‹¥æ²¡æœ‰ä»»ä½•é”™è¯¯å‘ç”Ÿåˆ™<code class="language-plaintext highlighter-rouge">errno</code>çš„å€¼ä¸ä¼šæ”¹å˜ã€‚å› æ­¤ï¼Œé™¤éçŸ¥é“å‘ç”Ÿäº†ä¸€ä¸ªé”™è¯¯ï¼Œå¦åˆ™ä¸åº”è¯¥æŸ¥çœ‹<code class="language-plaintext highlighter-rouge">errno</code>çš„å€¼ã€‚</li>
</ul>

<h4 id="1119-gethostbyname_rå’Œgethostbyaddr_rå‡½æ•°">11.19 gethostbyname_rå’Œgethostbyaddr_rå‡½æ•°</h4>

<p>å°†gethostnameä¹‹ç±»çš„ä¸å¯é‡å…¥çš„å‡½æ•°æ›´æ”¹ä¸ºé‡å…¥çš„å‡½æ•°ã€‚ä¸»è¦æ›´æ”¹çš„æ€è·¯å’Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>

<ol>
  <li>gethostname_r:ä¸»è¦å°†ä¸å¯é‡å…¥å‡½æ•°å¡«å†™å¹¶è¿”å›é™æ€ç»“æ„çš„åšæ³•æ”¹ä¸ºç”±è°ƒç”¨è€…åˆ†é…å†ç”±å¯é‡å…¥å‡½æ•°å¡«å†™ç»“æ„ã€‚</li>
  <li>getaddrinfoï¼šç”±å¯é‡å…¥å‡½æ•°è°ƒç”¨mallocä»¥åŠ¨æ€åˆ†é…å†…å­˜ç©ºé—´ã€‚ä½†æ˜¯å¿…é¡»ä½¿ç”¨freeaddrinfoé‡Šæ”¾åŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´ã€‚</li>
</ol>

<p>ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºéç©ºæŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸ºNULL */</span>

<span class="kt">int</span> <span class="nf">gethostbyname_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">ret</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">hostent</span> <span class="o">**</span><span class="n">result</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">h_errnop</span><span class="p">);</span>
<span class="cm">/* è¿”å›ï¼šè‹¥æˆåŠŸåˆ™ä¸ºéç©ºæŒ‡é’ˆï¼Œè‹¥å‡ºé”™åˆ™ä¸ºNULL */</span>

<span class="kt">int</span> <span class="nf">gethostbyaddr_r</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">hostent</span> <span class="o">*</span><span class="n">ret</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buflen</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">hostent</span> <span class="o">**</span><span class="n">result</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">h_errnop</span><span class="p">);</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼šbufå‚æ•°æ˜¯ç”±è°ƒç”¨è€…åˆ†é…ä¸”å¤§å°ä¸ºbuflençš„ç¼“å†²åŒºã€‚ä¸»è¦å­˜æ”¾è§„èŒƒä¸»æœºåï¼Œåˆ«åæŒ‡é’ˆæ•°ç»„ï¼Œå„ä¸ªåˆ«åå­—ç¬¦ä¸²ï¼Œåœ°å€ä¹‹æ©æ•°ç»„ä»¥åŠå„ä¸ªå®é™…åœ°å€ã€‚</p>

<h3 id="1121-å…¶å®ƒç½‘ç»œä¿¡æ¯">11.21 å…¶å®ƒç½‘ç»œä¿¡æ¯</h3>

<p>æˆ‘ä»¬åœ¨æœ¬ç« ä¸­ä¸€ç›´å…³æ³¨<code class="language-plaintext highlighter-rouge">ä¸»æœºå</code>å’Œ<code class="language-plaintext highlighter-rouge">IPåœ°å€</code>ä»¥åŠ<code class="language-plaintext highlighter-rouge">æœåŠ¡å</code>å’Œ<code class="language-plaintext highlighter-rouge">ç«¯å£å·</code>ã€‚ç„¶è€Œæˆ‘ä»¬çš„è§†é‡å¯ä»¥æ›´å¹¿é˜”ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½æƒ³è¦æŸ¥æ‰¾å››ç±»ä¸ç½‘ç»œç›¸å…³çš„ä¿¡æ¯ï¼š<code class="language-plaintext highlighter-rouge">ä¸»æœº</code>ã€<code class="language-plaintext highlighter-rouge">ç½‘ç»œ</code>ã€<code class="language-plaintext highlighter-rouge">åè®®</code>ã€<code class="language-plaintext highlighter-rouge">æœåŠ¡</code>ã€‚</p>

<ul>
  <li>å¤§å¤šæ•°æŸ¥æ‰¾é’ˆå¯¹çš„æ˜¯ä¸»æœº(<code class="language-plaintext highlighter-rouge">gethostbyname</code>å’Œ <code class="language-plaintext highlighter-rouge">bethostbyaddr</code>),</li>
  <li>ä¸€å°éƒ¨åˆ†æŸ¥æ‰¾é’ˆå¯¹çš„æ˜¯æœåŠ¡(<code class="language-plaintext highlighter-rouge">getservbyname</code>å’Œ<code class="language-plaintext highlighter-rouge">getservbyport</code>),</li>
  <li>æ›´å°ä¸€éƒ¨åˆ†æŸ¥æ‰¾é’ˆå¯¹çš„æ˜¯ç½‘ç»œå’Œåè®®</li>
</ul>

<p>æ‰€æœ‰å››ç±»ä¿¡æ¯éƒ½å¯ä»¥å­˜æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œæ¯ç±»ä¿¡æ¯å„å®šä¹‰æœ‰ä¸‰ä¸ªè®¿é—®å‡½æ•°ï¼š</p>
<ul>
  <li>å‡½æ•°<code class="language-plaintext highlighter-rouge">getXXXent</code>è¯»å‡ºæ–‡ä»¶ä¸­çš„ä¸‹ä¸€ä¸ªè¡¨é¡¹ï¼Œå¿…è¦çš„è¯é¦–å…ˆæ‰“å¼€æ–‡ä»¶ã€‚</li>
  <li>å‡½æ•°<code class="language-plaintext highlighter-rouge">setXXXent</code>æ‰“å¼€(å¦‚æœå°šæœªæ‰“å¼€çš„è¯) å¹¶å›ç»•æ–‡ä»¶ã€‚</li>
  <li>å‡½æ•°<code class="language-plaintext highlighter-rouge">endXXXent</code>å…³é—­æ–‡ä»¶ã€‚</li>
</ul>

<p>æ¯ç±»ä¿¡æ¯éƒ½å®šä¹‰äº†å„è‡ªçš„ç»“æ„ï¼ŒåŒ…æ‹¬ <code class="language-plaintext highlighter-rouge">hostent</code>,<code class="language-plaintext highlighter-rouge">netent</code>,<code class="language-plaintext highlighter-rouge">servent</code>. éƒ½ç”± <netdb.h> æä¾›ã€‚</netdb.h></p>

<p>é™¤äº†é¡ºåºå¤„ç†æ–‡ä»¶ <code class="language-plaintext highlighter-rouge">get</code>ã€<code class="language-plaintext highlighter-rouge">set</code>ã€<code class="language-plaintext highlighter-rouge">end</code>è¿™ä¸‰ä¸ªå‡½æ•°å¤–ï¼Œæ¯ç±»ä¿¡æ¯è¿˜æä¾›ä¸€äº›é”®å€¼æŸ¥æ‰¾å‡½æ•°ã€‚è¿™äº›å‡½æ•°é¡ºåºéå†æ•´ä¸ªæ–‡ä»¶(é€šè¿‡è°ƒç”¨ <code class="language-plaintext highlighter-rouge">getXXXent</code>å‡½æ•°è¯»å‡ºæ¯ä¸€è¡Œ)ï¼Œå¹¶å¯»æ‰¾ä¸æŸä¸ªå‚æ•°åŒ¹é…çš„ä¸€ä¸ªè¡¨é¡¹ã€‚è¿™äº›é”®å€¼æŸ¥æ‰¾å‡½æ•°å…·æœ‰å½¢å¦‚ <code class="language-plaintext highlighter-rouge">getXXXbyYYY</code> çš„åå­—ã€‚</p>

<p>å››ç±»ç½‘ç»œç›¸å…³ä¿¡æ¯ï¼š</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ä¿¡æ¯</th>
      <th style="text-align: left">æ•°æ®æ–‡ä»¶</th>
      <th style="text-align: left">ç»“æ„</th>
      <th style="text-align: left">é”®å€¼æŸ¥æ‰¾å‡½æ•°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ä¸»æœº</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/etc/hosts</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">hostent</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">gethostbyaddr</code>,<code class="language-plaintext highlighter-rouge">gethostbyname</code></td>
    </tr>
    <tr>
      <td style="text-align: left">ç½‘ç»œ</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/etc/networks</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">netent</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">getnetbyaddr</code>, <code class="language-plaintext highlighter-rouge">getnetbyname</code></td>
    </tr>
    <tr>
      <td style="text-align: left">åè®®</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/etc/protocols</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">protoent</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">getprotobyname</code>, <code class="language-plaintext highlighter-rouge">getprotobynumber</code></td>
    </tr>
    <tr>
      <td style="text-align: left">æœåŠ¡</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">/etc/services</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">servent</code></td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">getservbyname</code>, <code class="language-plaintext highlighter-rouge">getservbyport</code></td>
    </tr>
  </tbody>
</table>

<p>åœ¨ä½¿ç”¨DNSçš„å‰æä¸‹å¦‚ä½•åº”ç”¨è¿™äº›å‡½æ•°å‘¢ï¼Ÿé¦–å…ˆåªæœ‰ä¸»æœºå’Œç½‘ç»œä¿¡æ¯å¯ä»¥é€šè¿‡DNSè·å–ï¼Œåè®®å’ŒæœåŠ¡ä¿¡æ¯æ€»æ˜¯ä»ç›¸åº”çš„æ–‡ä»¶ä¸­è¯»å–ã€‚æˆ‘ä»¬ä¹‹å‰æœ‰æåˆ°è¿‡ï¼Œä¸åŒçš„å®ç°æœ‰ä¸åŒçš„æ–¹æ³•ä¾›ç³»ç»Ÿç®¡ç†å‘˜æŒ‡å®šæ˜¯ä½¿ç”¨DNSè¿˜æ˜¯ä½¿ç”¨æ–‡ä»¶æ¥æŸ¥æ‰¾ä¸»æœºå’Œç½‘ç»œä¿¡æ¯ã€‚</p>

<p>å…¶æ¬¡ï¼Œå¦‚æœä½¿ç”¨DNSæŸ¥æ‰¾ä¸»æœºå’Œç½‘ç»œä¿¡æ¯ï¼Œé‚£ä¹ˆåªæœ‰é”®å€¼æŸ¥æ‰¾å‡½æ•°æ‰æœ‰æ„ä¹‰ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä½ ä¸èƒ½ä½¿ç”¨gethostentå¹¶æœŸå¾…é¡ºåºéå†DNSä¸­æ‰€æœ‰è¡¨é¡¹ã€‚å¦‚æœè°ƒç”¨gethostent,é‚£ä¹ˆå®ƒä»…ä»…è¯»å–/etc/hostsæ–‡ä»¶å¹¶é¿å…è®¿é—®DNSã€‚</p>

<p>æ³¨ï¼šè™½ç„¶ç½‘ç»œä¿¡æ¯å¯ä»¥åšæˆé€šè¿‡DNSèƒ½å¤Ÿè®¿é—®åˆ°ï¼Œä½†æ˜¯å¾ˆå°‘æœ‰äººè¿™ä¹ˆåšã€‚</p>
:ET