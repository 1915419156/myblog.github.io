I"Ø<h1 id="æ‰€æœ‰å·ç§¯æ–¹å¼å’Œç®—æ³•çš„é›†åˆ">æ‰€æœ‰å·ç§¯æ–¹å¼å’Œç®—æ³•çš„é›†åˆ</h1>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<ul>
  <li><a href="http://bbs.cvmart.net/topics/1086">åµŒå…¥å¼å’Œç§»åŠ¨æ·±åº¦å­¦ä¹ ç ”ç©¶</a></li>
</ul>

<blockquote>
  <p>2019-10-12 12:59:34</p>
</blockquote>

<h1 id="å‡ ç§çŸ©é˜µå­˜å‚¨æ¨¡å¼">å‡ ç§çŸ©é˜µå­˜å‚¨æ¨¡å¼ï¼š</h1>

<h2 id="libsvmæ ¼å¼å®˜ç½‘é“¾æ¥">LibSVMæ ¼å¼(<a href="https://www.csie.ntu.edu.tw/~cjlin/libsvmtools/datasets/binary/australian">å®˜ç½‘é“¾æ¥</a>)</h2>

<p>ä¸€ç§é€šç”¨çš„è®­ç»ƒæ•°æ®æ ¼å¼,ä¸»è¦ç”¨åœ¨xboostç­‰æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ ä¸­</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>label] <span class="o">[</span>index1]:[value1] <span class="o">[</span>index2]:[value2] â€¦
<span class="o">[</span>label] <span class="o">[</span>index1]:[value1] <span class="o">[</span>index2]:[value2] â€¦
</code></pre></div></div>
<p>label  ç›®æ ‡å€¼ï¼Œå°±æ˜¯è¯´classï¼ˆå±äºå“ªä¸€ç±»ï¼‰ï¼Œå°±æ˜¯ä½ è¦åˆ†ç±»çš„ç§ç±»ï¼Œé€šå¸¸æ˜¯ä¸€äº›æ•´æ•°ã€‚</p>

<p>index æ˜¯æœ‰é¡ºåºçš„ç´¢å¼•ï¼Œé€šå¸¸æ˜¯è¿ç»­çš„æ•´æ•°ã€‚å°±æ˜¯æŒ‡ç‰¹å¾ç¼–å·ï¼Œå¿…é¡»æŒ‰ç…§å‡åºæ’åˆ—</p>

<p>value å°±æ˜¯ç‰¹å¾å€¼ï¼Œç”¨æ¥trainçš„æ•°æ®ï¼Œé€šå¸¸æ˜¯ä¸€å †å®æ•°ç»„æˆã€‚
å…·ä½“å®ä¾‹å…¥ä¸‹é¢æ‰€ç¤º:</p>

<p><img src="https://img-blog.csdn.net/20180128113141114?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvY2hlbnhqaGl0/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="libSVMsæ•°æ®æ ¼å¼" /></p>

<h2 id="coocoordinate">COO:Coordinate</h2>

<p>å°†çŸ©é˜µä¸­ä¸ä¸º0çš„æ•°çš„è¡Œå·ã€åˆ—å·å’Œæ•°å€¼å¯¹åº”å­˜å‚¨ä¸‹æ¥ï¼š</p>

<p><img src="https://note.youdao.com/yws/api/personal/file/WEB6c8c714de3adff2802d39c744b16c8e5?method=download&amp;shareKey=ce7945cb810be189a216fb1fd23b205d" alt="Cooæ•°æ®å­˜å‚¨æ ¼å¼" /></p>

<h3 id="ä¼˜ç¼ºç‚¹">ä¼˜ç¼ºç‚¹</h3>

<ul>
  <li>ä¼˜ç‚¹ï¼šæ¯”è¾ƒå®¹æ˜“è½¬æ¢æˆå…¶ä»–çš„ç¨€ç–çŸ©é˜µå­˜å‚¨æ ¼å¼ï¼ˆCSRç­‰ï¼‰ï¼Œå†™ç¨‹åºå°†libsvmæ ¼å¼çš„æ•°æ®è½¬æ¢æˆCOOæ¯”è¾ƒå®¹æ˜“ï¼Œåº”è¯¥æ˜¯å……å½“libsvmä¸å…¶ä»–ç¨€ç–çŸ©é˜µå­˜å‚¨æ ¼å¼è½¬æ¢çš„åª’ä»‹ã€‚</li>
  <li>COOç¼ºç‚¹ï¼šä¸èƒ½è¿›è¡ŒçŸ©é˜µè¿ç®—ã€‚</li>
</ul>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªè¯»å–libSVMæ•°æ®æ ¼å¼å¹¶è½¬æ¢æˆCOOçš„ä»£ç </p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># è¯»å–libsvmæ ¼å¼æ•°æ®æˆç¨€ç–çŸ©é˜µå½¢å¼
# 0 5:1 9:1 140858:1 445908:1 446177:1 446293:1 449140:1 490778:1 491626:1 491634:1 491641:1 491645:1 491648:1 491668:1 491700:1 491708:1
</span><span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="n">file_name</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">D</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">strip</span><span class="p">().</span><span class="n">split</span><span class="p">()</span>
            <span class="n">y_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">X_i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">D_i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span>
            <span class="n">y</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_i</span><span class="p">)</span>
            <span class="n">X</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">X_i</span><span class="p">)</span>
            <span class="n">D</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_i</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">libsvm_2_coo</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">INPUT_DIM</span><span class="p">)).</span><span class="n">tocsr</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span>

<span class="c1"># å°†libSVMè½¬æ¢æˆCOOä»£ç 
</span>
<span class="k">def</span> <span class="nf">libsvm_2_coo</span><span class="p">(</span><span class="n">libsvm_data</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="n">coo_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coo_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coo_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">libsvm_data</span><span class="p">:</span>
        <span class="n">coo_rows</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">coo_cols</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">coo_data</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">coo_rows</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">coo_rows</span><span class="p">)</span>
    <span class="n">coo_cols</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">coo_cols</span><span class="p">)</span>
    <span class="n">coo_data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">coo_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">coo_matrix</span><span class="p">((</span><span class="n">coo_data</span><span class="p">,</span> <span class="p">(</span><span class="n">coo_rows</span><span class="p">,</span> <span class="n">coo_cols</span><span class="p">)),</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>

</code></pre></div></div>

<h2 id="csræŒ‰è¡Œå‹ç¼©å­˜å‚¨">CSRï¼šæŒ‰è¡Œå‹ç¼©å­˜å‚¨</h2>

<p>CSRæ˜¯æ¯”è¾ƒæ ‡å‡†çš„ä¸€ç§ï¼Œä¹Ÿéœ€è¦ä¸‰ç±»æ•°æ®æ¥è¡¨è¾¾ï¼š</p>
<ul>
  <li>æ•°å€¼ï¼Œ</li>
  <li>åˆ—å·ï¼Œ</li>
  <li>ä»¥åŠè¡Œåç§»ã€‚</li>
</ul>

<p>CSRä¸æ˜¯ä¸‰å…ƒç»„ï¼Œè€Œæ˜¯æ•´ä½“çš„ç¼–ç æ–¹å¼ã€‚æ•°å€¼å’Œåˆ—å·ä¸COOä¸€è‡´ï¼Œè¡¨ç¤ºä¸€ä¸ªå…ƒç´ ä»¥åŠå…¶åˆ—å·ï¼Œè¡Œåç§»è¡¨ç¤ºæŸä¸€è¡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ åœ¨valuesé‡Œé¢çš„èµ·å§‹åç§»ä½ç½®ã€‚row offsetSçš„æ•°å€¼ä¸ªæ•°æ˜¯ #row+1,</p>

<p>å¦‚ä¸‹å›¾ä¸­ï¼Œ0,2,4,7åˆ†åˆ«è¡¨ç¤ºç¬¬ä¸€è¡Œã€ç¬¬äºŒè¡Œã€ç¬¬ä¸‰è¡Œã€ç¬¬å››è¡Œçš„ç¬¬ä¸€ä¸ªéé›¶å…ƒç´ åœ¨valuesçš„ä½ç½®ã€‚ç¬¬ä¸€è¡Œå…ƒç´ 1æ˜¯0åç§»ï¼Œç¬¬äºŒè¡Œå…ƒç´ 2æ˜¯2åç§»ï¼Œç¬¬ä¸‰è¡Œå…ƒç´ 5æ˜¯4åç§»ï¼Œç¬¬4è¡Œå…ƒç´ 6æ˜¯7åç§»ã€‚åœ¨è¡Œåç§»çš„æœ€åè¡¥ä¸ŠçŸ©é˜µæ€»çš„å…ƒç´ ä¸ªæ•°ï¼Œæœ¬ä¾‹ä¸­æ˜¯9ã€‚å…¶ä¸­column indicesè®°å½•çš„æ˜¯å¯¹åº”çš„valueæ‰€åœ¨åˆ—çš„indexã€‚æ¯”å¦‚1åœ¨0åˆ—ï¼Œ7åœ¨1åˆ—;4åœ¨ä¸‰åˆ—ã€‚</p>

<p><img src="https://note.youdao.com/yws/api/personal/file/WEB0612f7e67e37427f4e0d791de2e4c447?method=download&amp;shareKey=4b1dab6724d142d2ea69b37b85c221d8" alt="CSR" /></p>

<h3 id="ä¼˜ç¼ºç‚¹-1">ä¼˜ç¼ºç‚¹</h3>

<p>æœ¬è´¨ä¸Šè¿˜æ˜¯å¯¹äºéé›¶å…ƒç´ çš„å»é™¤ï¼Œå¹¶æ²¡æœ‰å»é™¤å…¶ä¸­çš„é‡å¤å…ƒç´ ã€‚</p>
<ul>
  <li>ä¼˜ç‚¹ï¼š
    <ul>
      <li>é«˜æ•ˆçš„CSR + CSR</li>
      <li>CSR*CSRç®—æœ¯è¿ç®—</li>
      <li>é«˜æ•ˆçš„è¡Œåˆ‡ç‰‡æ“ä½œ</li>
      <li>é«˜æ•ˆçš„çŸ©é˜µå†…ç§¯å†…ç§¯æ“ä½œ</li>
      <li>CSRæ ¼å¼åœ¨å­˜å‚¨ç¨€ç–çŸ©é˜µæ—¶éé›¶å…ƒç´ å¹³å‡ä½¿ç”¨çš„å­—èŠ‚æ•°(Bytes per Nonzero Entry)æœ€ä¸ºç¨³å®šï¼ˆfloatç±»å‹çº¦ä¸º8.5ï¼Œdoubleç±»å‹çº¦ä¸º12.5ï¼‰</li>
      <li>CSRæ ¼å¼å¸¸ç”¨äºè¯»å…¥æ•°æ®åè¿›è¡Œç¨€ç–çŸ©é˜µè®¡ç®—ã€‚</li>
    </ul>
  </li>
  <li>ç¼ºç‚¹ï¼š
    <ul>
      <li>åˆ—åˆ‡ç‰‡æ“ä½œæ…¢ï¼ˆç›¸æ¯”CSCï¼‰</li>
      <li>ç¨€ç–ç»“æ„çš„å˜åŒ–ä»£ä»·é«˜ï¼ˆç›¸æ¯”LILæˆ–è€…DOKï¼‰</li>
    </ul>
  </li>
</ul>

<p>å‡è®¾Bä¸ºå¤§çŸ©é˜µï¼ŒSä¸ºå°çŸ©é˜µã€‚
å½“CSRæ ¼å¼æ—¶ï¼ŒSÃ—Bé€Ÿåº¦è¾ƒå¿«ï¼Œä¸BÃ—Sç›¸æ¯”èŠ‚çº¦äº†ä¸€åŠæ—¶é—´ã€‚
å½“CSCæ ¼å¼æ—¶ï¼ŒBÃ—Sé€Ÿåº¦è¾ƒå¿«ï¼Œä¸SÃ—Bç›¸æ¯”èŠ‚çº¦ä¸€åŠæ—¶é—´ã€‚</p>

<h2 id="cscæŒ‰åˆ—å‹ç¼©å­˜å‚¨">CSC:æŒ‰åˆ—å‹ç¼©å­˜å‚¨</h2>

<p>CSCæ˜¯å’ŒCSRç›¸å¯¹åº”çš„ä¸€ç§æ–¹å¼ï¼Œå³æŒ‰åˆ—å‹ç¼©çš„æ„æ€ã€‚
ä»¥ä¸Šå›¾ä¸­çŸ©é˜µä¸ºä¾‹ï¼š
Valuesï¼š[1 5 7 2 6 8 3 9 4]
Row Indicesï¼š[0 2 0 1 3 1 2 2 3]
Column Offsetsï¼š[0 2 5 7 9]</p>

<h1 id="ç›´æ¥ç¨€ç–å·ç§¯direct-sparse-convolution">ç›´æ¥ç¨€ç–å·ç§¯(Direct Sparse Convolution)</h1>

<p><em>å‚è€ƒé“¾æ¥:</em></p>

<ul>
  <li>è®ºæ–‡åŸæ–‡:<a href="https://github.com/wangpengcheng/Learning-Note/blob/master/%E5%89%8D%E6%B2%BF%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/%E8%AE%BA%E6%96%87%E5%8E%9F%E6%96%87/%E8%A3%81%E5%89%AA_%E9%87%8F%E5%8C%96_%E5%8A%A0%E9%80%9F/FASTER%20CNNS%20WITH%20DIRECT%20SPARSE%20CONVOLUTIONS%0AAND%20GUIDED%20PRUNING.pdf">åœ°å€</a></li>
  <li><a href="https://blog.csdn.net/yyl424525/article/details/96327035#Direct_Sparse_Convolution_42">[è®ºæ–‡æ€»ç»“]ï¼šfaster cnns with direct sparse convolutions and guided pruning ç›´æ¥ç¨€ç–å·ç§¯å’Œå¼•å¯¼å‰ªæ</a></li>
  <li><a href="https://blog.csdn.net/niexiangwww2010/article/details/72784310">ICLR2017 paper: FASTER CNNS WITH DIRECT SPARSE CONVOLUTIONS AND GUIDED PRUNING ç¬”è®°</a></li>
  <li><a href="https://www.jianshu.com/p/dd67c2b56a28">ç¨€ç–å·ç§¯ç¥ç»ç½‘ç»œ</a></li>
  <li>é¡¹ç›®åœ°å€:<a href="https://github.com/IntelLabs/SkimCaffe">https://github.com/IntelLabs/SkimCaffe</a></li>
  <li>å…³é”®ä»£ç åœ°å€<a href="https://github.com/IntelLabs/SkimCaffe/blob/intel_scnn/include/caffe/util/sconv.hpp">https://github.com/IntelLabs/SkimCaffe/blob/intel_scnn/include/caffe/util/sconv.hpp</a></li>
</ul>

<p>ä¸‹é¢æ˜¯ç¨€ç–å·ç§¯åˆ†è§£çš„ä¸»è¦æµç¨‹å¯¹æ¯”å›¾:</p>

<p><img src="https://upload-images.jianshu.io/upload_images/5472979-e04163044567c1c7.png" alt="æµç¨‹å¯¹æ¯”å›¾" /></p>

<h2 id="ç®—æ³•ä»‹ç»">ç®—æ³•ä»‹ç»</h2>

<p>ç¨€ç–å·ç§¯å¯ä»¥çœ‹ä½œæŠ½è±¡çš„sparse-matrix-dense-matrix multiplication</p>

<p>å‡è®¾æœ‰Nä¸ªfiltersï¼Œæ¯ä¸ªçš„sizeä¸ºR Ã— S. è¾“å…¥ä¸ºCÃ—HÃ—Wï¼Œäºæ˜¯è¿™å±‚çš„å‚æ•°ä¸ºä¸€ä¸ªN Ã— C Ã— R Ã— Sçš„å¼ é‡ï¼Œinputæ˜¯C Ã— H(in)Ã— W(in)çš„å¼ é‡ï¼Œoutputä¸ºC Ã— H(out)Ã— W(out)çš„å¼ é‡ï¼Œå¦‚ä¸‹ï¼šä¸¤ä¸ªä¸‰ç»´å¼ é‡çš„ç‚¹ç§¯</p>

<p><img src="https://img-blog.csdn.net/20170527160806244?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbmlleGlhbmd3d3cyMDEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="å·ç§¯è®¡ç®—å…¬å¼" /></p>

<p>è¿™ä¸ªæ“ä½œå¯ä»¥è¢«çœ‹æˆé¦–å…ˆæ ¹æ®channnelså‘é‡åŒ–4ç»´çš„blobï¼Œç„¶åå†å‘é‡åŒ–kernelæœ€åå†æŒ‰ç…§äºŒç»´ç‚¹ä¹˜çš„æ–¹å¼è®¡ç®—ã€‚å½“Wç¨€ç–æ—¶ï¼Œå°±å˜æˆäº†ä¸€ä¸ªsparse-vector-dense-vectorç‚¹ä¹˜ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-10-12-15-19-12.png" alt="ä¸­é—´è®¡ç®—å›¾ç‰‡" /></p>

<ol>
  <li>å…ˆå°†æƒé‡çŸ©é˜µWæŒ‰ç¬¬ä¸€ç»´å±•å¹³ï¼Œå¾—ç¨€ç–çŸ©é˜µW(1)ï¼Œå¹¶ä¸”row vectorså’Œvec(I)çš„ç»´æ•°åŒ¹é…ã€‚</li>
  <li>O(n,y,x)æ˜¯W(1)çš„ç¬¬nè¡Œå’Œvec(I)ä¹‹é—´çš„ç‚¹ç§¯ã€‚</li>
  <li>äºæ˜¯æ¯ä¸ªç‚¹(x,y)å¤„çš„å·ç§¯ç»“æœå¯ä»¥è®¡ç®—å¤šä¸ªsparse-matrix-dense-vector multiplication æ¥å¾—åˆ°ã€‚</li>
</ol>

<p><img src="https://img-blog.csdn.net/20170527163952057?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbmlleGlhbmd3d3cyMDEw/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="å…¬å¼è®¡ç®—" /></p>

<ol>
  <li>I y,xä»£è¡¨å¼ é‡Iæ ¹æ®(y,x)å˜åŒ–å¾—åˆ°çš„å‘é‡åŒ–ç»“æœã€‚</li>
  <li>äºæ˜¯å°±å¯ä»¥å®šä¹‰ä¸€ç§è™šæ‹Ÿçš„dense matrixï¼Œæ¯ä¸ªcolumnéƒ½æ˜¯å¿«é€Ÿä¸”ç‹¬ç«‹ç”Ÿæˆçš„ã€‚</li>
</ol>

<p>ä¸‹é¢æ˜¯å®é™…çš„å…³é”®ä»£ç </p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">caffe_cpu_sconv_default</span><span class="p">(</span>
    <span class="c1">// è¾“å…¥çš„ç‰¹å¾å›¾</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="o">*</span><span class="n">input_padded</span><span class="p">,</span><span class="c1">//ç‰¹å¾å›¾æ•°æ®</span>
    <span class="kt">int</span> <span class="n">in_channels</span><span class="p">,</span><span class="c1">//è¾“å…¥é€šé“æ•°é‡</span>
    <span class="kt">int</span> <span class="n">height</span><span class="p">,</span><span class="c1">//è¾“å…¥é«˜åº¦ </span>
    <span class="kt">int</span> <span class="n">width</span><span class="p">,</span><span class="c1">//è¾“å…¥å®½åº¦</span>
    <span class="kt">int</span> <span class="n">pad_h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pad_w</span><span class="p">,</span><span class="c1">//å®½é«˜æ‰©å±•</span>
    <span class="kt">int</span> <span class="n">stride_h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stride_w</span><span class="p">,</span><span class="c1">//é«˜å®½æ­¥é•¿</span>
    <span class="kt">int</span> <span class="n">dilation_h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dilation_w</span><span class="p">,</span><span class="c1">//å®½é«˜ä¸Šçš„ç¼©æ”¾å°ºå¯¸ï¼Œä¹Ÿå°±æ˜¯çº¿æ€§å·®å€¼å°ºå¯¸</span>
    <span class="c1">// weights,æƒé‡æ•°æ®ï¼Œæ³¨æ„æƒé‡æ•°æ®æ˜¯ä»¥CSRæ•°æ®æ ¼å¼ä¿å­˜çš„ã€‚</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rowptr</span><span class="p">,</span><span class="c1">//è¡Œæ•°æ® </span>
    <span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">colidx</span><span class="p">,</span> <span class="c1">//åˆ—indexç´¢å¼•</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="o">*</span><span class="n">values</span><span class="p">,</span><span class="c1">//æœ€ç»ˆå€¼</span>
    <span class="kt">int</span> <span class="n">kernel_h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kernel_w</span><span class="p">,</span><span class="c1">//å·ç§¯æ ¸çš„é«˜å®½</span>
    <span class="k">const</span> <span class="kt">float</span> <span class="o">*</span><span class="n">bias</span><span class="p">,</span><span class="c1">//åŸºç¡€åç§»</span>
    <span class="c1">// output features</span>
    <span class="kt">float</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span><span class="c1">//è¾“å‡ºæ•°æ®</span>
    <span class="kt">int</span> <span class="n">out_channels</span><span class="c1">//è¾“å‡ºé€šé“æ•°ç›®</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è®¡ç®—è¾“å‡ºé«˜å®½</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">output_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad_h</span> <span class="o">-</span>
      <span class="p">(</span><span class="n">dilation_h</span> <span class="o">*</span> <span class="p">(</span><span class="n">kernel_h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">stride_h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">output_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pad_w</span> <span class="o">-</span>
      <span class="p">(</span><span class="n">dilation_w</span> <span class="o">*</span> <span class="p">(</span><span class="n">kernel_w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">stride_w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">//è®¾ç½®å¾ªç¯å·ç§¯batch</span>
  <span class="n">conv_cycles_of_this_batch</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">();</span>
    <span class="c1">//å¦‚æœç¼©æ”¾ä¸ä¸º1</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dilation_h</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">dilation_w</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">output_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">output_row</span> <span class="o">&lt;</span> <span class="n">output_h</span><span class="p">;</span> <span class="o">++</span><span class="n">output_row</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">output_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">output_col</span> <span class="o">&lt;</span> <span class="n">output_w</span><span class="p">;</span> <span class="o">++</span><span class="n">output_col</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">oc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">oc</span> <span class="o">&lt;</span> <span class="n">out_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">oc</span><span class="p">)</span> <span class="p">{</span>
          <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">bias</span><span class="p">[</span><span class="n">oc</span><span class="p">];</span>

          <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowptr</span><span class="p">[</span><span class="n">oc</span><span class="p">];</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rowptr</span><span class="p">[</span><span class="n">oc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">colidx</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

            <span class="kt">int</span> <span class="n">kernel_col</span> <span class="o">=</span> <span class="n">off</span><span class="o">%</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">pad_w</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">kernel_row</span> <span class="o">=</span> <span class="p">(</span><span class="n">off</span><span class="o">/</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">pad_w</span><span class="p">))</span><span class="o">%</span><span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">pad_h</span><span class="p">);</span>
            <span class="kt">int</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">off</span><span class="o">/</span><span class="p">((</span><span class="n">width</span> <span class="o">+</span> <span class="n">pad_w</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">pad_h</span><span class="p">));</span>

            <span class="kt">int</span> <span class="n">input_row</span> <span class="o">=</span> <span class="n">kernel_row</span> <span class="o">*</span> <span class="n">dilation_h</span> <span class="o">+</span> <span class="n">output_row</span> <span class="o">*</span> <span class="n">stride_h</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">input_col</span> <span class="o">=</span> <span class="n">kernel_col</span> <span class="o">*</span> <span class="n">dilation_w</span> <span class="o">+</span> <span class="n">output_col</span> <span class="o">*</span> <span class="n">stride_w</span><span class="p">;</span>

            <span class="n">sum</span> <span class="o">+=</span> <span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">input_padded</span><span class="p">[(</span><span class="n">in_channel</span> <span class="o">*</span> <span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">pad_h</span><span class="p">)</span> <span class="o">+</span> <span class="n">input_row</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">pad_w</span><span class="p">)</span> <span class="o">+</span> <span class="n">input_col</span><span class="p">];</span>
          <span class="p">}</span>

          <span class="n">output</span><span class="p">[(</span><span class="n">oc</span> <span class="o">*</span> <span class="n">output_h</span> <span class="o">+</span> <span class="n">output_row</span><span class="p">)</span> <span class="o">*</span> <span class="n">output_w</span> <span class="o">+</span> <span class="n">output_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">FUSE_RELU</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="n">f</span><span class="p">,</span> <span class="n">sum</span><span class="p">)</span> <span class="o">:</span> <span class="n">sum</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span><span class="c1">//å·ç§¯ç¼©æ”¾ä¸º1ï¼Œæ²¡æœ‰ç¼©æ”¾</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">output_row</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">output_row</span> <span class="o">&lt;</span> <span class="n">output_h</span><span class="p">;</span> <span class="o">++</span><span class="n">output_row</span><span class="p">)</span> <span class="p">{</span><span class="c1">//è¾“å‡ºè¡Œéå†</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">output_col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">output_col</span> <span class="o">&lt;</span> <span class="n">output_w</span><span class="p">;</span> <span class="o">++</span><span class="n">output_col</span><span class="p">)</span> <span class="p">{</span><span class="c1">//è¾“å‡ºåˆ—éå†</span>
        <span class="c1">//è·å–å½“å‰æŒ‡é’ˆæŒ‡å‘æ•°æ®=èµ·ç‚¹æŒ‡é’ˆ+è¾“å‡ºè¡Œ*è¡Œæ­¥é•¿*(è¾“å…¥å®½åº¦+æ‰©å±•å®½åº¦)+è¾“å‡ºåˆ—*åˆ—æ­¥é•¿ï¼›è¿™é‡Œç›¸å½“äºæ˜¯ä½¿ç”¨è¾“å‡ºç‚¹çš„åæ ‡ï¼Œåå‘è®¡ç®—è¾“å…¥ç‚¹åº”è¯¥çš„åæ ‡ï¼Œæ³¨æ„è¿™é‡Œæ²¡æœ‰åŠ é€šé“</span>
        <span class="k">const</span> <span class="kt">float</span> <span class="o">*</span><span class="n">in</span> <span class="o">=</span> <span class="n">input_padded</span> <span class="o">+</span> <span class="n">output_row</span> <span class="o">*</span> <span class="n">stride_h</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">pad_w</span><span class="p">)</span> <span class="o">+</span> <span class="n">output_col</span> <span class="o">*</span> <span class="n">stride_w</span><span class="p">;</span>
        <span class="c1">//æŒ‰ç…§è¾“å‡ºé€šé“æ•°ç›®è¿›è¡Œéå†ï¼Œè¾“å‡ºé€šé“æ•°ç›®=è¾“å…¥é€šé“æ•°ç›®</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">oc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">oc</span> <span class="o">&lt;</span> <span class="n">out_channels</span><span class="p">;</span> <span class="o">++</span><span class="n">oc</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//è·å–æ¯ä¸ªçš„åŸºç¡€åœ°å€</span>
          <span class="kt">float</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">bias</span><span class="p">[</span><span class="n">oc</span><span class="p">];</span>
            <span class="c1">//æŒ‰ç…§è¡Œå¯¹æ¯ä¸ªæƒé‡è¿›è¡Œ</span>
          <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">rowptr</span><span class="p">[</span><span class="n">oc</span><span class="p">];</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rowptr</span><span class="p">[</span><span class="n">oc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span><span class="c1">//jæ˜¯å½“å‰é€šé“æ•°ç›®åˆ°ä¸‹ä¸€ä¸ªé€šé“æ•°ç›®ä¹‹é—´</span>
              <span class="c1">//æ£€æŸ¥æ•°æ®æ˜¯å¦è¶Šç•Œ</span>
            <span class="n">assert</span><span class="p">(</span><span class="n">in</span> <span class="o">+</span> <span class="n">colidx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">input_padded</span> <span class="o">&amp;&amp;</span> <span class="n">in</span> <span class="o">+</span> <span class="n">colidx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">input_padded</span> <span class="o">+</span> <span class="n">in_channels</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="n">pad_w</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">height</span> <span class="o">+</span> <span class="n">pad_h</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad_h</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">pad_w</span><span class="p">));</span>
            <span class="c1">//å’Œ=æƒé‡å€¼*å¯¹åº”æ•°æ®ï¼›æ³¨æ„è¿™é‡Œæ˜¯é€šé“æ•°ç›®çš„ä¹˜æ³•ï¼Œå¯¹åº”çš„æ˜¯(c,x,y)ä¸­cçš„å˜åŒ–</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="n">values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">in</span><span class="p">[</span><span class="n">colidx</span><span class="p">[</span><span class="n">j</span><span class="p">]];</span>
          <span class="p">}</span>
            <span class="c1">//æœ€åè®¡ç®—è¾“å‡ºçš„index</span>
          <span class="n">output</span><span class="p">[(</span><span class="n">oc</span><span class="o">*</span><span class="n">output_h</span> <span class="o">+</span> <span class="n">output_row</span><span class="p">)</span><span class="o">*</span><span class="n">output_w</span> <span class="o">+</span> <span class="n">output_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">FUSE_RELU</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mf">0.</span><span class="n">f</span><span class="p">,</span> <span class="n">sum</span><span class="p">)</span> <span class="o">:</span> <span class="n">sum</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">conv_cycles_of_this_batch</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">__rdtsc</span><span class="p">()</span> <span class="o">-</span> <span class="n">conv_cycles_of_this_batch</span><span class="p">[</span><span class="n">omp_get_thread_num</span><span class="p">()</span><span class="o">*</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="ç®—æ³•é‡è¿°">ç®—æ³•é‡è¿°</h3>

<ol>
  <li>å°†è¾“å…¥(C,W,H)æ•°æ®å‹ç¼©æˆä¸ºä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œå…¶ä¸­(w,h,c),å…¶ä¸­æ¯ä¸ªèµ·ç‚¹ä¹‹åæ˜¯è¿ç»­çš„cä¸ªæ•°æ®ï¼Œä»£è¡¨ä¸åŒé€šé“ä¸Šçš„æ•°æ®</li>
  <li>å°†æƒé‡æ•°æ®æŒ‰ç…§CSRæ–¹å¼è¿›è¡Œå­˜å‚¨ï¼Œæœ€åä¸€ä¸ªç»´åº¦ä¹Ÿæ˜¯cã€‚</li>
  <li>æŒ‰ç…§é€šé“è¿›è¡Œè®¡ç®—å’Œç›¸åŠ </li>
</ol>

<p>ä»æœ¬è´¨ä¸Šæ¥è¯´ç¨€ç–å·ç§¯ï¼Œåªæ˜¯å¯¹äºå·²ç»å‹ç¼©å­˜å‚¨çš„æƒé‡æ•°æ®çš„ä¼˜åŒ–ï¼Œç›¸å¯¹ç›´æ¥å·ç§¯æ¥è¯´ï¼Œä»¥w*hä¸ºä¸»è¦éå†å¯¹è±¡ï¼Œç›´æ¥è¿›è¡Œcä¸Šçš„å¤šä¸ªæ•°æ®è®¡ç®—å’Œç›¸åŠ ï¼Œä¸»è¦é¿å…äº†æ•°æ®çš„å¤šæ¬¡è®¿é—®ï¼Œæé«˜äº†è®¡ç®—æ•ˆç‡ã€‚<strong>ç›¸å¯¹äºåŸæ¥çš„äºŒç»´ç›´æ¥å·ç§¯ï¼Œå…ˆè®¡ç®—æ¯ä¸ªå·ç§¯çŸ©é˜µç‚¹ä¹˜ï¼Œå†å°†cä¸ªçŸ©é˜µç›¸åŠ å‡å°‘äº†m*nçš„æ—¶é—´å¤æ‚åº¦ï¼Œæé«˜äº†åˆ©ç”¨ç‡</strong>ã€‚é¢„è®¡æé«˜é€Ÿåº¦<code class="language-plaintext highlighter-rouge">1.5ï½3</code>ã€‚çŸ©é˜µè¶Šç¨€ç–ï¼Œæ•ˆæœè¶Šæ˜æ˜¾</p>

<p><img src="https://wangpengcheng.github.io/img/2019-10-12-16-45-46.png" alt="è®ºæ–‡æœ€ç»ˆç»“æœæ¯”è¾ƒ" /></p>
:ET