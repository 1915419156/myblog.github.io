I"ç}<blockquote>
  <p>2019-07-17 22:16:53</p>
</blockquote>

<h2 id="ç¬¬å…«ç« -å¹¶å‘ä»£ç è®¾è®¡">ç¬¬å…«ç«  å¹¶å‘ä»£ç è®¾è®¡</h2>

<h3 id="81-çº¿ç¨‹é—´åˆ’åˆ†å·¥ä½œçš„æŠ€æœ¯">8.1 çº¿ç¨‹é—´åˆ’åˆ†å·¥ä½œçš„æŠ€æœ¯</h3>

<p>ä¸€èˆ¬çš„çº¿ç¨‹åˆ’åˆ†ä¼šï¼Œç›´æ¥å°†æ•°æ®åˆ’åˆ†çº¿ç¨‹ï¼›ä½†æ˜¯æœ€åçš„å¤šçº¿ç¨‹ä¹‹é—´çš„ç»“æœæ•°æ®åŒæ­¥ä¼šé€ æˆè¾ƒå¤šçš„éº»çƒ¦ï¼Œæ•°æ®å’Œç®—æ³•ç¬¦åˆ’åˆ†æ–¹å¼ï¼Œåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­è¾ƒä¸ºé‡è¦ã€‚</p>

<h4 id="812-é€’å½’åˆ’åˆ†">8.1.2 é€’å½’åˆ’åˆ†</h4>

<p>ç¬¬å››ç« ä¸­çš„<code class="language-plaintext highlighter-rouge">std::async()</code>æ–¹å¼çš„å¿«é€Ÿæ’åºï¼Œåœ¨å¯¹äºå¤§é‡æ•°æ®è¿›è¡Œæ’åºçš„æ—¶å€™ï¼Œæ¯ä¸€å±‚é€’å½’éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œæœ€ç»ˆä¼šäº§ç”Ÿå¤§é‡çš„çº¿ç¨‹ï¼›çº¿ç¨‹çš„æ€§èƒ½å¼€é”€åè€Œä¼šè®©ç¨‹åºçš„æ‰§è¡Œæ—¶é—´ä¸Šå‡ï¼Œä¸å¦‚å•çº¿ç¨‹çš„å¿«é€Ÿæ’åºã€‚</p>

<p>å¯ä»¥é€šè¿‡å°†æ•°æ®æ‰“åŒ…åï¼Œäº¤ç»™å›ºå®šçº¿ç¨‹å¤„ç†ï¼Œæˆ–è€…ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::thread::hardware_concurrency()</code>å‡½æ•°æ¥ç¡®å®šçº¿ç¨‹çš„æ•°é‡ã€‚</p>

<p>ä½¿ç”¨æ ˆçš„å¹¶è¡Œå¿«é€Ÿæ’åºç®—æ³•â€“ç­‰å¾…æ•°æ®å—æ’åº</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">sorter</span>
<span class="p">{</span>
    <span class="c1">//å‡†å¤‡æ’åºçš„æ•°æ®å—</span>

    <span class="k">struct</span> <span class="nc">chunk_to_sort</span>
    <span class="p">{</span>
        <span class="c1">//æ’åºæ•°æ®</span>

        <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="c1">//é¢„æœŸç»“æœ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">promise</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1">//çº¿ç¨‹å®‰å…¨çš„æ’åºæ ˆ</span>

    <span class="n">thread_safe_stack</span><span class="o">&lt;</span><span class="n">chunk_to_sort</span><span class="o">&gt;</span> <span class="n">chunks</span><span class="p">;</span>
    <span class="c1">//å·¥ä½œçº¿ç¨‹åˆ—è¡¨</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
    <span class="c1">//æœ€å¤§çº¿ç¨‹æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">max_thread_count</span><span class="p">;</span>
    <span class="c1">//åŸå­å˜é‡ï¼Œæ˜¯å¦è¾¾åˆ°æ•°æ®æœ«å°¾</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">end_of_data</span><span class="p">;</span>

    <span class="n">sorter</span><span class="p">()</span><span class="o">:</span><span class="n">max_thread_count</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">end_of_data</span><span class="p">(</span><span class="nb">false</span><span class="p">){}</span>
    <span class="o">~</span><span class="n">sorter</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">end_of_data</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//ç­‰å¾…çº¿ç¨‹ç»“æŸ</span>

            <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">try_sort_chunk</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//è·å–æ’åºçº¿ç¨‹</span>

        <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">chunk_to_sort</span> <span class="o">&gt;</span> <span class="n">chunk</span><span class="o">=</span><span class="n">chunks</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//å¼€å§‹æ’åº</span>

            <span class="n">sort_chunk</span><span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">do_sort</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">chunk_data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">chunk_data</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">chunk_data</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
        <span class="c1">//æ‹·è´æ•°æ®çš„å¤´æŒ‡é’ˆ</span>

        <span class="n">result</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">chunk_data</span><span class="p">,</span><span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
        <span class="c1">//è·å–å¼€å¤´çš„æ•°æ®</span>

        <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">partition_val</span><span class="o">=*</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="c1">//æ ¹æ®partition_valè¿›è¡Œåˆ†ç»„ï¼Œè·å–ä¸­é—´åˆ†ç»„çš„è¿­ä»£å™¨</span>

        <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">divide_point</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">partition</span><span class="p">(</span><span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">chunk_data</span><span class="p">.</span><span class="n">end</span><span class="p">(),[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">val</span><span class="p">){</span><span class="k">return</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">partition_val</span><span class="p">;});</span>
        <span class="n">chunk_to_sort</span> <span class="n">new_lower_chunk</span><span class="p">;</span>
        <span class="c1">//æˆªå–åˆ†ç»„çš„å‰åŠæ®µåˆ°new_lower_chunk</span>

        <span class="n">new_lower_chunk</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">new_lower_chunk</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="n">chunk_data</span><span class="p">,</span>
            <span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
            <span class="n">divide_point</span>
            <span class="p">);</span>
        <span class="c1">//è·å–new_chunkçš„futureå€¼</span>

        <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">new_lower</span><span class="o">=</span><span class="n">new_lower_chunk</span><span class="p">.</span><span class="n">promise</span><span class="p">.</span><span class="n">get_future</span><span class="p">();</span>
        <span class="c1">//å‹å…¥æ’åºæ ˆ</span>

        <span class="n">chunks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_lower_chunk</span><span class="p">));</span>
        <span class="c1">//å¦‚æœçº¿ç¨‹å°äºæœ€å¤§çº¿ç¨‹æ•°</span>

        <span class="k">if</span><span class="p">(</span><span class="n">threads</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="o">&lt;</span><span class="n">max_thread_count</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//åˆ›å»ºæ’åºçº¿ç¨‹</span>

            <span class="n">threads</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sorter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">sort_thread</span><span class="p">,</span><span class="k">this</span><span class="p">));</span>

        <span class="p">}</span>
        <span class="c1">//è·å–å¤§äºçš„ä¸€éƒ¨åˆ†ï¼Œå¹¶è¿”å›æ’åºç»“æœ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">new_higher</span><span class="p">(</span><span class="n">do_sort</span><span class="p">(</span><span class="n">chunk_data</span><span class="p">));</span>
        <span class="c1">//æ¥ä¸Šnew_higher</span>

        <span class="n">result</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">new_higher</span><span class="p">);</span>
        <span class="c1">//å¾ªç¯æ‰§è¡Œæ’åºçº¿ç¨‹ï¼Œç›´åˆ°ç»“æŸ</span>

        <span class="k">while</span><span class="p">(</span><span class="n">new_lower</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">!=</span><span class="n">std</span><span class="o">::</span><span class="n">future_status</span><span class="o">::</span><span class="n">ready</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">try_sort_chunk</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">//å°†å‰é¢æ’åºç»“æœæ”¾åˆ°resultä¸­</span>

        <span class="n">result</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">new_lower</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">sort_thread</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">end_of_data</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//æ²¡æœ‰åˆ°è¾¾æ•°æ®æœ«å°¾ï¼Œå°è¯•å¿«æ’</span>

            <span class="n">try_sort_chunk</span><span class="p">();</span>
            <span class="c1">//çº¿ç¨‹ä¼‘çœ </span>

            <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">};</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">parallel_quick_sort</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">input</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sorter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">do_sort</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h4 id="813-é€šè¿‡äººå»ç±»å‹åˆ’åˆ†å·¥ä½œ">8.1.3 é€šè¿‡äººå»ç±»å‹åˆ’åˆ†å·¥ä½œ</h4>

<p>å½“é€šè¿‡ä»»åŠ¡ç±»å‹å¯¹çº¿ç¨‹é—´çš„ä»»åŠ¡è¿›è¡Œåˆ’åˆ†æ—¶,ä¸åº”è¯¥è®©çº¿ç¨‹å¤„äºå®Œå…¨éš”ç¦»çš„çŠ¶æ€ã€‚å½“å¤šä¸ªè¾“å…¥æ•°æ®é›†éœ€è¦ä½¿ç”¨åŒæ ·çš„æ“ä½œåºåˆ—,å¯ä»¥å°†åºåˆ—ä¸­çš„æ“ä½œåˆ†æˆå¤šä¸ªé˜¶æ®µ,æ¥è®©æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚</p>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨cpuçš„æµæ°´å…ˆå·¥ä½œæ–¹å¼ï¼Œå¯¹äºCPUæ•°æ®çš„å¤„ç†æœ‰åŠ å¥½çš„å¹³å‡æ€§èƒ½</p>

<h3 id="82-å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´ ">8.2 å½±å“å¹¶å‘ä»£ç æ€§èƒ½çš„å› ç´ </h3>

<h4 id="å¤„ç†å™¨æ•°é‡">å¤„ç†å™¨æ•°é‡</h4>

<p>é¦–å…ˆçº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿä¸Šçš„æ¦‚å¿µï¼Œåœ¨CPUä¸­æ˜¯ä¸å­˜åœ¨çº¿ç¨‹è¿™ä¸ªè¯´æ³•çš„ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„çš„æ—¶ï¼Œåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œä¸ç­‰åŒäºå¤šæ ¸ç¼–ç¨‹ï¼Œä¸­é—´æ“ä½œç³»ç»Ÿèµ·åˆ°äº†éå¸¸é‡è¦çš„ä½œç”¨ã€‚ä¹‹é—´çš„è°ƒåº¦å¹¶ä¸æ˜äº†ã€‚éœ€è¦è°¨æ…ä½¿ç”¨ã€‚</p>

<h4 id="822-æ•°æ®äº‰ç”¨ä¸ä¹’ä¹“ç¼“å­˜">8.2.2 æ•°æ®äº‰ç”¨ä¸ä¹’ä¹“ç¼“å­˜</h4>

<p>å½“ä¸¤ä¸ªçº¿ç¨‹å¹¶å‘çš„åœ¨ä¸åŒå¤„ç†å™¨ä¸Šæ‰§è¡Œæ—¶ï¼Œå¯¹åŒæ„æ•°æ®è¿›è¡Œè¯»å–ï¼Œé€šå¸¸ä¸ä¼šå‡ºç°é—®é¢˜ï¼›æ•°æ®å°†ä¼šæ‹·è´åˆ°æ¯ä¸ªçº¿ç¨‹çš„ç¼“å­˜ä¸­ï¼Œå¯ä»¥è®©ä¸¤ä¸ªå¤„ç†å™¨åŒäº‹è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å½“æœ‰çº¿ç¨‹å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œä¿®æ”¹æ•°æ®éœ€è¦æ›´æ–°åˆ°å…¶å®ƒæ ¸èŠ¯çš„ç¼“å­˜ä¸­å–ï¼Œéœ€è¦è€—è´¹ä¸€å®šçš„æ—¶é—´ã€‚é€šå¸¸ä¼šè®©å·¥ä½œä¸­çš„CPUè¿›è¡Œç­‰å¾…ï¼Œç›´åˆ°ç¼“å­˜ä¸­çš„æ•°æ®å¾—åˆ°æ›´æ–°ã€‚</p>

<p><strong>é«˜ç«äº‰(high contention)</strong>:ä¸€ä¸ªå¤„ç†å™¨å‡†å¤‡æ›´æ–°è¿™ä¸ªå€¼,å¦ä¸€ä¸ªå¤„ç†å™¨æ­£åœ¨ä¿®æ”¹è¿™ä¸ªå€¼,æ‰€ä»¥è¯¥å¤„ç†å™¨å°±ä¸å¾—ä¸ç­‰,å¾…ç¬¬äºŒä¸ªå¤„ç†å™¨æ›´æ–°å®Œæˆ,å¹¶ä¸”å®Œæˆæ›´æ–°ä¼ é€’æ—¶,æ‰èƒ½æ‰§è¡Œæ›´æ–°ã€‚
<strong>ä½ç«äº‰(low contention)</strong>: å¦‚æœå¤„ç†å™¨å¾ˆå°‘éœ€è¦ç›¸äº’ç­‰å¾…ã€‚</p>

<p><strong>ä¹’ä¹“ç¼“å­˜(cache ping-pong)</strong>: æ•°æ®åœ¨æ¯ä¸ªç¼“å­˜ä¸­ä¼ é€’è‹¥å¹²æ¬¡ã€‚</p>

<p>åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œäº’æ–¥é‡ï¼Œé€šå¸¸éœ€è¦å¦å¤–ä¸€ä¸ªçº¿ç¨‹å°†æ•°æ®è¿›è¡Œè½¬ç§»ï¼Œä¿è¯å¤„ç†å™¨ä¹‹é—´çš„äº’æ–¥æ€§ã€‚å½“çº¿ç¨‹è¿›è¡Œå®Œä¿®æ”¹åï¼Œå…¶å®ƒçº¿ç¨‹å¯¹äº’æ–¥é‡è¿›è¡Œä¿®æ”¹ï¼Œå¹¶å¯¹çº¿ç¨‹è¿›è¡Œè§£é”ï¼Œå†å°†äº’æ–¥æ•°æ®ä¼ é€’åˆ°ä¸‹ä¸€ä¸ªéœ€è¦äº’æ–¥é‡çš„çº¿ç¨‹ä¸Šå»ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯äº’æ–¥é‡çš„è·å–å’Œé‡Šæ”¾ã€‚</p>

<p><strong>å½“å¤šä¸ªçº¿ç¨‹é«˜ç«äº‰è®¿é—®æ—¶ï¼Œä¼šé€ æˆå¤§é‡çš„èµ„æºæµªè´¹</strong></p>

<p>æ³¨æ„ï¼š</p>

<ul>
  <li>äº’æ–¥é‡çš„ç«äº‰é€šå¸¸ä¸åŒäºåŸå­æ“ä½œçš„ç«äº‰,æœ€ç®€å•çš„åŸå› æ˜¯,äº’æ–¥é‡é€šå¸¸ä½¿ç”¨æ“ä½œç³»ç»Ÿçº§åˆ«çš„åºåˆ—åŒ–çº¿ç¨‹,è€Œéå¤„ç†å™¨çº§åˆ«çš„ã€‚å› æ­¤ä¸ä¼šå½±å“æ“ä½œç³»ç»Ÿä¸­çš„å…¶å®ƒçº¿ç¨‹ï¼Œä½†æ˜¯ä¼šå½±å“æœ¬ç¨‹åºçš„çº¿ç¨‹ã€‚</li>
  <li>å°½é‡é¿å…ä¹’ä¹“ç°è±¡ï¼Œå‡å°‘ä¸¤ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå†…å­˜ä½ç½®çš„ç«äº‰ã€‚</li>
</ul>

<p><strong>ç¼“å­˜è¡Œ</strong>ï¼šç”±å¤„ç†å™¨cacheå¤§å°ï¼Œå†³å®šçš„ä¸€æ¬¡è¯»å–å†…å­˜å—çš„ä¸€è¡Œï¼Œå†…å­˜å—é€šå¸¸å¤§å°ä¸º32æˆ–64å­—èŠ‚ã€‚åœ¨å†…å­˜ä¸­ç§°ä¸ºç¼“å­˜è¡Œ(cache line);</p>

<p><strong>ä¼ªå…±äº«</strong>: å³ä½¿ç»™å®šå†…å­˜ä½ç½®è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€è®¿é—®,å¯èƒ½è¿˜æ˜¯ä¼šæœ‰ä¹’ä¹“ç¼“å­˜çš„å­˜åœ¨,æ˜¯å› ä¸ºå¦ä¸€ç§å«åšä¼ªå…±äº«(false sharing)çš„æ•ˆåº”ã€‚å³ä½¿æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜è¡Œä¸­ï¼Œå¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®ä¸­çš„æˆå‘˜è¿›è¡Œè®¿é—®æ—¶ï¼Œç¡¬ä»¶ç¼“å­˜è¿˜æ˜¯ä¼šäº§ç”Ÿä¹’ä¹“ç¼“å­˜ã€‚ç¼“å­˜è¡Œæ˜¯å¤šä¸ªçº¿ç¨‹å…±äº«çš„ï¼Œä½†å®é™…å¹¶ä¸è¢«å¤šä¸ªCPUå…±äº«ï¼Œå› æ­¤ä½¿ç”¨ä¼ªå…±äº«æ¥å£°æ˜è¿™ç§æ–¹å¼ã€‚</p>

<p><strong>ä¼ªå…±äº«å‘ç”Ÿçš„åŸå› </strong>: æŸä¸ªçº¿ç¨‹æ‰€è¦è®¿é—®çš„æ•°æ®è¿‡äºæ¥è¿‘å¦ä¸€çº¿ç¨‹çš„æ•°æ®,å¦ä¸€ä¸ªæ˜¯ä¸æ•°æ®å¸ƒå±€ç›¸å…³çš„é™·é˜±ä¼šç›´æ¥å½±å“å•çº¿ç¨‹çš„æ€§èƒ½ã€‚
<strong>é¿å…ä¼ªå…±äº«</strong>ï¼šé¿å…ä¼ªå…±äº«çš„æ–¹æ³•æ˜¯ï¼Œå®ç°æ•°æ®åˆ†ç¦»ï¼ŒåŠªåŠ›è®©ä¸åŒçº¿ç¨‹è®¿é—®ä¸åŒç¼“å­˜è¡Œã€‚</p>

<h4 id="824-ç´§å‡‘çš„æ•°æ®">8.2.4 ç´§å‡‘çš„æ•°æ®</h4>

<p>å½“CPUä¸­çº¿ç¨‹çš„å…³é”®æ•°æ®åˆ†æ•£åœ¨å†…å­˜ä¸­æ—¶ï¼Œä¼šå¢åŠ å†…å­˜è®¿é—®çš„æ¬¡æ•°å’Œå†…å­˜çš„å»¶è¿Ÿã€‚å› æ­¤å°½é‡ç´§å‡‘çš„å†…å­˜è®¾è®¡ä¼šé™ä½å»¶è¿Ÿã€‚</p>

<p>å½“å¤„ç†å™¨åˆ‡æ¢çº¿ç¨‹æ—¶ï¼Œå¯¹ä¸åŒå†…å­˜ä¸Šçš„æ•°æ®è¿›è¡Œé‡æ–°åŠ è½½(å½“ä¸åŒçº¿ç¨‹ä½¿ç”¨çš„æ•°æ®è·¨è¶Šäº†å¤šä¸ªç¼“å­˜è¡Œæ—¶)ï¼Œè€Œéå¯¹ç¼“å­˜ä¸­çš„æ•°æ®ä¿æŒåŸæ ·(å½“çº¿ç¨‹ä¸­çš„æ•°æ®éƒ½åœ¨åŒä¸€ç¼“å­˜è¡Œæ—¶)ã€‚</p>

<p>å½“çº¿ç¨‹æ•°é‡å¯¹ä¸€äºŒå†…æ ¸å¤„ç†å™¨æ•°é‡ï¼Œæ“ä½œç³»ç»Ÿå¯èƒ½ä¹Ÿä¼šé€‰æ‹©å°†ä¸€ä¸ªçº¿ç¨‹æ›´æ¢èŠ¯æ ¸ï¼Œç¼“å­˜è¡Œä»ä¸€ä¸ªå†…æ ¸ä¸Šï¼Œè½¬ç§»åˆ°å¦å¤–ä¸€ä¸ªå†…æ ¸ä¸Šï¼›è¿™æ ·å¯¹æ€§èƒ½æŸå®³æ¯”è¾ƒå¤§ã€‚</p>

<h4 id="825--è¶…é¢è®¤è´­å’Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢">8.2.5  è¶…é¢è®¤è´­å’Œé¢‘ç¹çš„ä»»åŠ¡åˆ‡æ¢</h4>

<p>å½“æœ‰è¶…çº§å¤šçš„çº¿ç¨‹å‡†å¤‡è¿è¡Œæ—¶(éç­‰å¾…çŠ¶æ€),ä»»åŠ¡åˆ‡æ¢é—®é¢˜å°±ä¼šé¢‘ç¹å‘ç”Ÿã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä»¬ä¹‹å‰ä¹Ÿæ¥è§¦è¿‡:è¶…é¢è®¤è´­ã€‚</p>

<h3 id="83-ä¸ºå¤šçº¿ç¨‹æ€§èƒ½è®¾è®¡æ•°æ®ç»“æ„">8.3 ä¸ºå¤šçº¿ç¨‹æ€§èƒ½è®¾è®¡æ•°æ®ç»“æ„</h3>

<p>å¤šçº¿ç¨‹æ€§èƒ½è®¾è®¡è€ƒè™‘å› ç´ ï¼š</p>

<ul>
  <li>ç«äº‰</li>
  <li>ä¼ªå…±äº«</li>
  <li>æ•°æ®è·ç¦»</li>
</ul>

<h4 id="831-ä¸ºå¤æ‚æ“ä½œåˆ’åˆ†æ•°ç»„å…ƒç´ ">8.3.1 ä¸ºå¤æ‚æ“ä½œåˆ’åˆ†æ•°ç»„å…ƒç´ </h4>

<p>è¿™é‡Œä¸»è¦æ¢ç©¶çš„æ˜¯çŸ©é˜µçš„ä¹˜æ³•é—®é¢˜ï¼Œæ¯”è¾ƒå»ºè®®çš„æ˜¯å°†çŸ©é˜µè¿›è¡Œåˆ†å—æ¥ï¼Œè¿›è¡Œè®¡ç®—</p>

<h4 id="832-å…¶å®ƒæ•°æ®ç»“æ„ä¸­çš„æ•°æ®è®¿é—®æ¨¡å¼">8.3.2 å…¶å®ƒæ•°æ®ç»“æ„ä¸­çš„æ•°æ®è®¿é—®æ¨¡å¼</h4>

<p>å½“ä½¿ç”¨çš„äº’æ–¥é‡å’Œæ•°æ®é¡¹åœ¨å†…å­˜ä¸­å¾ˆæ¥è¿‘ï¼Œå¯¹äºä¸€ä¸ªéœ€è¦è·å–äº’æ–¥é‡çš„çº¿ç¨‹æ¥è¯´ï¼Œæ¯”è¾ƒç†æƒ³ï¼›æ‰€éœ€è¦çš„æ•°æ®å¯èƒ½æ—©å°±å­˜å…¥å¤„ç†å™¨çš„ç¼“å­˜ä¸­äº†ï¼›ä½†æ˜¯å½“å…¶ä»–çº¿ç¨‹å°è¯•é”ä½äº’æ–¥é‡æ—¶ï¼Œçº¿ç¨‹å°±èƒ½å¯¹å¯¹åº”çš„æ•°æ®è¿›è¡Œè®¿é—®ã€‚å¯¹äºç›¸åŒä½ç½®çš„æ“ä½œéƒ½éœ€è¦å…ˆè·å–äº’æ–¥é‡ï¼Œå¦‚æœäº’æ–¥é‡å·²é”ï¼Œé‚£å°±ä¼šè°ƒç”¨ç³»ç»Ÿå†…æ ¸ã€‚è€ŒåŸå­çš„äº’æ–¥é‡æ“ä½œ(â€œè¯»ï¼Œå†™ï¼Œæ”¹â€)ï¼Œå¯èƒ½ä¼šè®©æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œè®©çº¿ç¨‹è·å–çš„äº’æ–¥é‡å˜å¾—æ¯«æ— ä½œç”¨ã€‚å½“äº’æ–¥é‡å…±äº«åŒä¸€ç¼“å­˜è¡Œæ—¶ï¼Œå…¶ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹å·²ä½¿ç”¨çš„æ•°æ®ï¼Œè¿™æ—¶æ‹¥æœ‰äº’æ–¥é‡çš„çº¿ç¨‹ä¼šé­å—åˆ°æ€§èƒ½æ‰“å‡»ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹ä¹Ÿåœ¨å°è¯•é”ä½äº’æ–¥é‡ã€‚</p>

<h3 id="84-è®¾è®¡å¹¶å‘ä»£ç çš„æ³¨æ„äº‹é¡¹">8.4 è®¾è®¡å¹¶å‘ä»£ç çš„æ³¨æ„äº‹é¡¹</h3>

<p>æ³¨æ„ä»£ç åœ¨ç‰©ç†ç¡¬ä»¶æ”¹å˜æ—¶çš„å¯æ‰©å±•æ€§ï¼Œé¿å…å› ä¸ºç‰©ç†ç¡¬ä»¶çš„æ”¹å˜ï¼Œé€ æˆä»£ç é”™è¯¯ã€‚</p>

<h4 id="841-å¹¶è¡Œç®—æ³•ä¸­çš„å¼‚å¸¸å®‰å…¨">8.4.1 å¹¶è¡Œç®—æ³•ä¸­çš„å¼‚å¸¸å®‰å…¨</h4>

<p>åœ¨ä¸²è¡Œç®—æ³•ä¸­æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œç®—æ³•åªéœ€è¦è€ƒè™‘å…¶æœ¬èº«çš„å¤„ç†ï¼Œå¤šçº¿ç¨‹ä¸­éœ€è¦è€ƒè™‘åˆ°å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„ç›¸äº’å½±å“ã€‚</p>

<p>ä¹‹å‰å®ç°çš„çº¿ç¨‹å®‰å…¨çš„æ±‚å’Œå‡½æ•°åœ¨æ‰§è¡Œçº¿ç¨‹åˆ›å»ºæ—¶å¹¶ä¸å®‰å…¨ã€‚å› æ­¤åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šæ”¹è‰¯çº¿ç¨‹å®‰å…¨å‡½æ•°ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>

<span class="k">class</span> <span class="nc">join_threads</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;&amp;</span> <span class="n">threads</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">join_threads</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;&amp;</span> <span class="n">threads_</span><span class="p">)</span><span class="o">:</span><span class="n">threads</span><span class="p">(</span><span class="n">threads_</span><span class="p">){}</span>
    <span class="o">~</span><span class="n">join_threads</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">threads</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">joinable</span><span class="p">())</span>
                <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>



<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">iterator</span> <span class="p">,</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">accumulate_block</span>
<span class="p">{</span>
    <span class="c1">//æ„é€ æ“ä½œ</span>

    <span class="n">T</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//è¿”å›æ‰€æœ‰æ•°æ®å’Œ</span>

        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">T</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">T</span> <span class="nf">parallel_accumulate</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">T</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">init</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_pre_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">max_thread</span><span class="o">=</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">min_pre_thread</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">min_pre_thread</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">hardware_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">hardware_threads</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span><span class="n">hardware_threads</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="n">max_threads</span><span class="p">);</span>
    <span class="c1">//åˆ†å—çš„å¤§å°</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">block_size</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">num_threads</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">futures</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="c1">//å®‰å…¨çº¿ç¨‹ç±»</span>

    <span class="n">join_threads</span> <span class="n">joiner</span><span class="p">(</span><span class="n">threads</span><span class="p">);</span>


    <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Iterator</span> <span class="n">block_end</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">block_end</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">packaged_tack</span><span class="o">&lt;</span><span class="n">T</span><span class="p">(</span><span class="n">Iterator</span><span class="p">,</span><span class="n">Iterator</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">task</span><span class="p">(</span><span class="n">accumulate_block</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">());</span>
        <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">task</span><span class="p">.</span><span class="n">get_future</span><span class="p">();</span>
        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">),</span><span class="n">block_start</span><span class="p">,</span><span class="n">block_end</span><span class="p">);</span>
        <span class="n">block_start</span><span class="o">=</span><span class="n">block_end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">T</span> <span class="n">last_result</span><span class="o">=</span><span class="n">accumulate_block</span><span class="p">()(</span><span class="n">block_start</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span>
        <span class="kr">thread</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
        <span class="kr">thread</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">mem_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">join</span><span class="p">)</span>
        <span class="p">);</span>

    <span class="n">T</span> <span class="n">result</span><span class="o">=</span><span class="n">init</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">result</span><span class="o">+=</span><span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">result</span><span class="o">+=</span><span class="n">last_result</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>

<h4 id="842-å¯æ‰©å±•æ€§å’Œamdahlå®šå¾‹">8.4.2 å¯æ‰©å±•æ€§å’ŒAmdahlå®šå¾‹</h4>

<p>å°†ç¨‹åºåˆ’åˆ†ä¸ºâ€ä¸²è¡Œâ€å’Œâ€å¹¶è¡Œâ€éƒ¨åˆ†ã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å…¬å¼å¯¹ç¨‹åºæ€§èƒ½çš„å¢ç›Šè¿›è¡Œä¼°è®¡ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-18-20-56-36.png" alt="" /></p>

<p>å…¶ä¸­ï¼š</p>

<ul>
  <li>fsè¡¨ç¤ºä¸²è¡Œæ—¶é—´</li>
  <li>Pè¡¨ç¤ºæ€§èƒ½å¢ç›Š</li>
  <li>Nå¤„ç†å™¨æ•°é‡</li>
</ul>

<h4 id="843--ä½¿ç”¨å¤šçº¿ç¨‹éšè—å»¶è¿Ÿ">8.4.3  ä½¿ç”¨å¤šçº¿ç¨‹éšè—å»¶è¿Ÿ</h4>

<p>æ¯”èµ·æ·»åŠ çº¿ç¨‹æ•°é‡è®©å…¶å¯¹å¤„ç†å™¨è¿›è¡Œå……åˆ†åˆ©ç”¨,æœ‰æ—¶ä¹Ÿè¦åœ¨å¢åŠ çº¿ç¨‹çš„åŒæ—¶,ç¡®ä¿å¤–éƒ¨äº‹ä»¶è¢«åŠæ—¶çš„å¤„ç†,ä»¥æé«˜ç³»ç»Ÿçš„å“åº”èƒ½åŠ›ã€‚</p>

<h4 id="844--ä½¿ç”¨å¹¶å‘æé«˜å“åº”èƒ½åŠ›">8.4.4  ä½¿ç”¨å¹¶å‘æé«˜å“åº”èƒ½åŠ›</h4>

<p>é€šå¸¸ä½¿ç”¨ä¸“ç”¨çš„GUIçº¿ç¨‹æ¥å¤„ç†è¿™äº›äº‹ä»¶ã€‚çº¿ç¨‹å¯ä»¥é€šè¿‡ç®€å•çš„æœºåˆ¶è¿›è¡Œé€šè®¯ï¼Œè€Œä¸æ˜¯å°†æ—¶é—´å¤„ç†ä»£ç å’Œä»»åŠ¡ä»£ç æ··åœ¨ä¸€èµ·ï¼ŒGUIçº¿ç¨‹å¦‚ä¸‹</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">task_thread</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>   <span class="n">task_cancelled</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">gui_thread</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">event_data</span>  <span class="n">event</span><span class="o">=</span><span class="n">get_event</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">type</span><span class="o">==</span><span class="n">quit</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="n">process</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">task</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">task_complete</span><span class="p">()</span><span class="o">&amp;&amp;!</span><span class="n">task_cancelled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">do_next_operation</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">task_cancelled</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perform_cleanup</span><span class="p">();</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">post_gui_event</span><span class="p">(</span><span class="n">task_complete</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">process</span><span class="p">(</span><span class="n">event_data</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">case</span> <span class="n">start_task</span><span class="p">:</span>
                <span class="n">task_cancelled</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
                <span class="n">task_thread</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">stop_task</span><span class="p">:</span>
                <span class="n">task_cancelled</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
                <span class="n">task_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">task_complete</span><span class="p">:</span>
                <span class="n">task_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
                <span class="n">display_results</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="nl">default:</span>
                <span class="c1">//...</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="85-åœ¨å®è·µä¸­è®¾è®¡å¹¶å‘ä»£ç ">8.5 åœ¨å®è·µä¸­è®¾è®¡å¹¶å‘ä»£ç </h3>

<h4 id="851-å¹¶è¡Œå®ç°stdfor_each">8.5.1 å¹¶è¡Œå®ç°:<code class="language-plaintext highlighter-rouge">std::for_each</code></h4>

<p>for_eachä¸»è¦æ˜¯å®¹å™¨ç±»çš„å†…éƒ¨è¿­ä»£ï¼Œå› æ­¤ä¸»è¦æ˜¯è¿›è¡Œæ“ä½œæ—¶å€™çš„å­˜å–é”ï¼›å¯ä»¥é€šè¿‡ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::packaged_task</code>å’Œ<code class="language-plaintext highlighter-rouge">std::future</code>æœºåˆ¶å¯¹çº¿ç¨‹ä¸­çš„å¼‚å¸¸è¿›è¡Œè½¬ç§»ã€‚ä¸‹é¢æ˜¯ä¸¤ç§æ–¹å¼å®ç°çš„<code class="language-plaintext highlighter-rouge">for_each</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨ std::packaged_taskå’Œstd::future</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">Func</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">parallel_for_each</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">Func</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_pre_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">max_threads</span><span class="o">=</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">min_per_thread</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">min_pre_thread</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">hardware_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">hardware_threads</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span><span class="n">hardware_threads</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="n">max_threads</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">block_size</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">num_threads</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">futures</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">join_threads</span> <span class="n">joiner</span><span class="p">(</span><span class="n">threads</span><span class="p">);</span>
    <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Iterator</span> <span class="n">block_end</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">block_end</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">packaged_task</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">task</span><span class="p">(</span>
            <span class="p">[</span><span class="o">=</span><span class="p">](){</span>
                <span class="c1">//æ‰§è¡Œç›¸å…³å‡½æ•°</span>

                <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">block_start</span><span class="p">,</span><span class="n">block_end</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="p">);</span>
        <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">task</span><span class="p">.</span><span class="n">get_future</span><span class="p">();</span>
        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
        <span class="n">block_start</span><span class="o">=</span><span class="n">block_end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">block_start</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>


<span class="c1">//ä½¿ç”¨ std::asyncå®ç°</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span>   <span class="nc">Func</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">parallel_for_each</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">Func</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_per_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&lt;</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">min_per_thread</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">Iterator</span> <span class="k">const</span> <span class="n">mid_point</span><span class="o">=</span><span class="n">first</span><span class="o">+</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">first_half</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span>
            <span class="o">&amp;</span><span class="n">parallel_for_each</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">Func</span><span class="o">&gt;</span><span class="p">,</span>
            <span class="n">first</span><span class="p">,</span><span class="n">mid_point</span><span class="p">,</span>
            <span class="n">f</span>
            <span class="p">);</span>
            <span class="n">parallel_for_each</span><span class="p">(</span><span class="n">mid_point</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">f</span><span class="p">);</span>
            <span class="n">first_half</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
        <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>
<h3 id="852-å¹¶è¡Œå®ç°-stdfind">8.5.2 å¹¶è¡Œå®ç°: std::find</h3>

<p>findéœ€è¦åœ¨æ‰¾åˆ°æ—¶ï¼Œä¸­æ–­å…¶å®ƒçº¿ç¨‹ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªåŸå­å˜é‡ä½œä¸ºæ ‡ç¤ºï¼Œå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">std::packaged_task</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">std::promise</code>å¯¹å¼‚å¸¸å’Œæœ€ç»ˆå€¼è¿›è¡Œè®¾ç½®;ç°åœ¨ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::promise</code>çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">MatchType</span><span class="p">&gt;</span>
<span class="c1">//å¹¶è¡ŒæŸ¥æ‰¾å‡½æ•°</span>

<span class="n">Iterator</span> <span class="nf">parallel_find</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">MatchType</span> <span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">find_element</span>
    <span class="p">{</span>
        <span class="c1">//é‡è½½æ“ä½œç¬¦</span>

        <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span>
            <span class="n">Iterator</span> <span class="n">begin</span><span class="p">,</span>
            <span class="n">Iterator</span> <span class="n">end</span><span class="p">,</span>
            <span class="n">MatchType</span> <span class="n">match</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;*</span> <span class="n">result</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;*</span>  <span class="n">done_flag</span>
            <span class="p">)</span>
        <span class="p">{</span>
            <span class="k">try</span>
            <span class="p">{</span>
                <span class="c1">//å¾ªç¯æŸ¥æ‰¾æ˜¯å¦ç›¸ç­‰</span>

                <span class="k">for</span><span class="p">(;(</span><span class="n">begin</span><span class="o">!=</span><span class="n">end</span><span class="p">)</span><span class="o">&amp;&amp;!</span><span class="n">done_flag</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">();</span><span class="o">++</span><span class="n">begin</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">begin</span><span class="o">==</span><span class="n">match</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">result</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="n">begin</span><span class="p">);</span>
                        <span class="n">done_flag</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span><span class="k">catch</span><span class="p">(...)</span>
            <span class="p">{</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="c1">//è¾“å‡ºé”™è¯¯ä¿¡æ¯</span>

                    <span class="n">result</span><span class="o">-&gt;</span><span class="n">set_exception</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">current_exception</span><span class="p">());</span>
                    <span class="n">done_flag</span><span class="o">-&gt;</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
                <span class="p">}</span><span class="k">catch</span><span class="p">(...){}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span>  <span class="n">last</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_per_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">max_threads</span><span class="o">=</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">min_per_thread</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">min_per_thread</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">hardware_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">hardware_threads</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span><span class="n">hardware_threads</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="n">max_threads</span><span class="p">);</span>
    <span class="c1">//æ¯ä¸ªçº¿ç¨‹æ•°æ®å—çš„å¤§å°</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">block_size</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">num_threads</span><span class="p">;</span>
    <span class="c1">//resultç»“æœ</span>

    <span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
    <span class="c1">//æ˜¯å¦æŸ¥æ‰¾åˆ°çš„æ ‡å¿—ä½</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">done_flag</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
    <span class="c1">//çº¿ç¨‹vector</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">{</span>
        <span class="c1">//æ·»åŠ å’Œå¯åŠ¨çº¿ç¨‹</span>

        <span class="n">join_threads</span> <span class="n">joiner</span><span class="p">(</span><span class="n">threads</span><span class="p">);</span>
        <span class="c1">//è¿­ä»£åˆ›å»ºçº¿ç¨‹</span>

        <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Iterator</span> <span class="n">block_end</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">block_end</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
            <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span>
                <span class="n">find_element</span><span class="p">(),</span>
                <span class="n">block_end</span><span class="p">,</span>
                <span class="n">match</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">result</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">done_flag</span>
                <span class="p">);</span>
            <span class="n">block_start</span><span class="o">=</span><span class="n">block_end</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">done_flag</span><span class="p">.</span><span class="n">load</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">last</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">get_future</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::async</code>å®ç°çš„å¹¶è¡Œfindç®—æ³•</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">MatchType</span><span class="p">&gt;</span>
<span class="n">Iterator</span> <span class="nf">parallel_find_impl</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> 
<span class="n">last</span><span class="p">,</span><span class="n">MatchType</span> <span class="n">match</span><span class="p">,</span><span class="n">ne</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_per_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
        <span class="c1">//å°äºæœ€å°çº¿ç¨‹æ•°é‡çš„ä¸¤å€ç›´æ¥æŸ¥æ‰¾</span>

        <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&lt;</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">min_per_thread</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(;(</span><span class="n">first</span><span class="o">!=</span><span class="n">last</span><span class="p">)</span><span class="o">&amp;&amp;!</span><span class="n">done</span><span class="p">.</span><span class="n">load</span><span class="p">();</span><span class="o">++</span><span class="n">first</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">first</span><span class="o">==</span><span class="n">match</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">done</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
                    <span class="k">return</span>  <span class="n">first</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">last</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//ä¸­é—´éƒ¨åˆ†çš„è¿­ä»£å™¨</span>

            <span class="n">Iterator</span> <span class="k">const</span> <span class="n">mid_point</span><span class="o">=</span><span class="n">first</span><span class="o">+</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
            <span class="c1">//è·å–ä¸­é—´åˆ°æœ€åä½ç½®çš„å¼‚æ­¥æ‰§è¡Œçš„ç»“æœ</span>

            <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="o">&gt;</span> <span class="n">async_result</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">async</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parallel_find_impl</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">MatchType</span><span class="o">&gt;</span><span class="p">,</span><span class="n">mid_point</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">match</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">done</span><span class="p">));</span>
            <span class="c1">//ç›´æ¥è·å–å½“å‰æŸ¥æ‰¾çš„ç»“æœ</span>

            <span class="n">Iterator</span> <span class="k">const</span> <span class="n">direct_result</span><span class="o">=</span><span class="n">parallel_find_impl</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">mid_point</span><span class="p">,</span><span class="n">match</span><span class="p">,</span><span class="n">done</span><span class="p">);</span>
            <span class="c1">//æŸ¥æ‰¾ç»“æœæ˜¯å¦ä¸ºä¸­é—´æŒ‡é’ˆ</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">direct_result</span><span class="o">==</span><span class="n">mid_point</span><span class="p">)</span><span class="o">?</span><span class="n">async_result</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">:</span><span class="n">direct_result</span><span class="p">;</span>
        <span class="p">}</span><span class="k">catch</span><span class="p">(...)</span>
        <span class="p">{</span>
            <span class="n">done</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
            <span class="k">throw</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//æŸ¥æ‰¾å‡½æ•°</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">MatchType</span><span class="p">&gt;</span>
    <span class="n">Iterator</span> <span class="n">parallel_find</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">MatchType</span> <span class="n">match</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">done</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">parallel_find_impl</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">match</span><span class="p">,</span><span class="n">done</span><span class="p">);</span>
    <span class="p">}</span>





</code></pre></div></div>

<h4 id="853-å¹¶è¡Œå®ç°stdpartial_sum">8.5.3 å¹¶è¡Œå®ç°ï¼š<code class="language-plaintext highlighter-rouge">std::partial_sum</code></h4>

<p>ä½¿ç”¨åˆ’åˆ†çš„æ–¹å¼å®ç°å¹¶è¡Œçš„è®¡ç®—éƒ¨åˆ†å’Œ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">Iterator</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">parallel_partial_sum</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è¿­ä»£å™¨ç±»å‹</span>

    <span class="k">typedef</span> <span class="n">tycodepename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">value_type</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="c1">//å®šä¹‰å¤„ç†å•å…ƒç±»</span>

    <span class="k">struct</span>  <span class="nc">process_chunk</span>
        <span class="p">{</span>
            <span class="c1">//()æ“ä½œ,ä¸»è¦ç”¨äºæ„é€ å‡½æ•°</span>
            <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span>
                <span class="n">Iterator</span> <span class="n">begin</span><span class="p">,</span>
                <span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span>
                <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">value_type</span><span class="o">&gt;*</span> <span class="n">previous_end_value</span><span class="p">,</span>
                <span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="n">value_type</span><span class="o">&gt;*</span><span class="n">end_value</span>
                <span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//å°è¯•å·¥ä½œ</span>
                <span class="k">try</span>
                <span class="p">{</span>
                    <span class="c1">//å°†endè¿­ä»£å™¨æŒ‡å‘last</span>

                    <span class="n">Iterator</span> <span class="n">end</span><span class="o">=</span><span class="n">last</span><span class="p">;</span>
                    <span class="c1">//ç§»åŠ¨è¿­ä»£å™¨æŒ‡é’ˆ</span>

                    <span class="o">++</span><span class="n">end</span><span class="p">;</span>
                    <span class="c1">//å¯¹æ•°æ®è¿›è¡Œæ±‚å’Œï¼Œå¹¶å°†ç»“æœå­˜å…¥beginä¸­</span>

                    <span class="n">std</span><span class="o">::</span><span class="n">partial_sum</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">begin</span><span class="p">);</span>
                    <span class="c1">//å¦‚æœé¢„æœŸç»“æœå­˜åœ¨</span>

                    <span class="k">if</span><span class="p">(</span><span class="n">previous_end_value</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">//è·å–ç»“æœ</span>
                        <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">addend</span><span class="o">=</span><span class="n">previous_end_value</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">();</span>
                        <span class="c1">//lastå€¼æ·»åŠ addend </span>

                        <span class="o">*</span><span class="n">last</span><span class="o">+=</span><span class="n">addend</span><span class="p">;</span>
                        <span class="c1">//æ£€æŸ¥end_valueæ˜¯å¦ä¸ºç©º</span>

                        <span class="k">if</span><span class="p">(</span><span class="n">end_value</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="c1">//è®¾ç½®å€¼</span>

                            <span class="n">end_value</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="o">*</span><span class="n">last</span><span class="p">);</span>
                        <span class="p">}</span>
                        <span class="c1">//ä¾¿åˆ©è¿­ä»£å™¨ï¼Œå°†æ¯ä¸ªå€¼æ·»åŠ addend,å³æ¯ä¸ªå€¼æ·»åŠ å‰ä¸€ç»„çš„æœŸæœ›å€¼</span>

                        <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">last</span><span class="p">,[</span><span class="n">addend</span><span class="p">](</span><span class="n">value_type</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">){</span>
                            <span class="n">item</span><span class="o">+=</span><span class="n">addend</span><span class="p">;</span>
                        <span class="p">});</span>
                        <span class="c1">//å¦‚æœé¢„æœŸç»“æœå€¼ä¸å­˜åœ¨ï¼Œæ£€æŸ¥end_valueæ˜¯å¦å­˜åœ¨</span>

                    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">end_value</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="c1">//å­˜åœ¨ç›´æ¥è®¾ç½®ä¸ºæœŸæœ›å€¼</span>

                        <span class="n">end_value</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="o">*</span><span class="n">last</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span><span class="k">catch</span><span class="p">(...)</span>
                <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">end_value</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">end_value</span><span class="o">-&gt;</span><span class="n">set_exception</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">current_exception</span><span class="p">());</span>
                    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                        <span class="k">throw</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">last</span><span class="p">;</span>
        <span class="c1">//æœ€å°åˆ†å—çº¿ç¨‹æ•°</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_per_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
        <span class="c1">//è®¡ç®—æœ€å¤§çº¿ç¨‹æ•°</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">max_threads</span><span class="o">=</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">min_per_thread</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">min_per_thread</span><span class="p">;</span>
        <span class="c1">//å½“å‰çº¿ç¨‹å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ç›®</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">hardware_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
        <span class="c1">//å®é™…çº¿ç¨‹æ•°ç›®</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">hardware_threads</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span>
<span class="nl">hardware_threads:</span><span class="mi">2</span><span class="p">,</span><span class="n">max_threads</span><span class="p">);</span>
        <span class="c1">//æ¯ä¸ªçº¿ç¨‹å—çš„å¤§å°</span>

        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">block_size</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">num_threads</span><span class="p">;</span>
        <span class="c1">//è¿­ä»£å™¨æ•°æ®ç±»å‹</span>

        <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">value_type</span> <span class="n">value_type</span><span class="p">;</span>
        <span class="c1">//åˆ›å»ºçº¿ç¨‹vector</span>

        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">//åˆ›å»ºå¯¹åº”çš„promise,å³æœ€ç»ˆç»“æœ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">promise</span><span class="o">&lt;</span><span class="n">value_type</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">end_values</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">//åˆ›å»ºæœŸæœ›</span>

        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">value_type</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">previous_end_values</span><span class="p">;</span>
        <span class="c1">//è®¾ç½®æœŸæœ›å¤§å°</span>

        <span class="n">previous_end_values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">//åˆ›å»ºæ·»åŠ çº¿ç¨‹</span>

        <span class="n">join_threads</span> <span class="n">joiner</span><span class="p">(</span><span class="n">threads</span><span class="p">);</span>
        <span class="c1">//å°†blockä¸­çš„å¼€å§‹æŒ‡é’ˆæŒ‡å‘first</span>

        <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
        <span class="c1">//å¼€å§‹æ„é€ å¯¹åº”çº¿ç¨‹</span>

        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
            <span class="c1">//å°†å°¾è¿­ä»£å™¨æŒ‡å‘block start</span>

            <span class="n">Iterator</span> <span class="n">block_last</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
            <span class="c1">//å°†block_lastæ›´æ–°è¿­ä»£å™¨æ­¥é•¿ä¸ºblock_size</span>

            <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">block_last</span><span class="p">,</span><span class="n">block_size</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="c1">//åˆ›å»ºçº¿ç¨‹å¹¶ï¼Œè¾“å…¥å¯¹åº”å‚æ•°</span>

            <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span>
                <span class="n">process_chunk</span><span class="p">(),</span>
                <span class="n">block_start</span><span class="p">,</span>
                <span class="n">block_last</span><span class="p">,</span>
                <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="o">?&amp;</span><span class="n">previous_end_values</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="o">&amp;</span><span class="n">end_values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="p">);</span>
            <span class="c1">//ç§»åŠ¨blockæŒ‡é’ˆ</span>

            <span class="n">block_start</span><span class="o">=</span><span class="n">block_last</span><span class="p">;</span>
            <span class="o">++</span><span class="n">block_start</span><span class="p">;</span>
            <span class="c1">//å°†æœ€åçš„é¢„è®¡å€¼æ”¾å…¥end_values</span>

            <span class="n">previous_end_values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">end_values</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get_future</span><span class="p">());</span>
        <span class="p">}</span>
        <span class="c1">//æœ€åå°†æŒ‡é’ˆæŒ‡å‘åˆ†ç»„åçš„æœ€åä¸€ç»„</span>
        
        <span class="n">Iterator</span> <span class="n">final_element</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
        <span class="c1">//ç§»åŠ¨å°¾æŒ‡é’ˆåˆ°æœ«å°¾</span>

        <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">final_element</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">block_start</span><span class="p">,</span><span class="n">last</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">//è®¡ç®—å‰©ä½™çš„å€¼çš„å’Œ</span>

        <span class="n">process_chunk</span><span class="p">()(</span>
            <span class="n">block_start</span><span class="p">,</span>
            <span class="n">final_element</span><span class="p">,</span>
            <span class="p">(</span><span class="n">num_threads</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span><span class="o">?&amp;</span><span class="n">previous_end_values</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>å®ç°ä»¥2çš„å¹‚çº§æ•°ä¸ºè·ç¦»éƒ¨åˆ†å’Œç®—æ³•</strong></p>

<p>å°†æ•°æ®è¿›è¡Œåˆ†ç¦»ï¼Œå¹¶å®ç°SIMDï¼Œå°†ä¸­é—´çš„å¤„ç†ç»“æœä¼ é€’åˆ°ä¸‹ä¸€ä¸ªç»“æœä¸­å»ã€‚</p>

<p>ç®€å•çš„æ …æ ç±»å®ç°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">barrier</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">count</span><span class="p">;</span>
    <span class="c1">//ç©ºå€¼</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">spaces</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">generation</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">barrier</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">count_</span><span class="p">)</span><span class="o">:</span><span class="n">count_</span><span class="p">(</span><span class="n">count_</span><span class="p">),</span><span class="n">spaces</span><span class="p">(</span><span class="n">count</span><span class="p">),</span><span class="n">generation</span><span class="p">(</span><span class="mi">0</span><span class="p">){}</span>
    <span class="kt">void</span> <span class="n">wait</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//æ›´æ–°å½“å‰çº¿ç¨‹çš„generation</span>

        <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">my_generation</span><span class="o">=</span><span class="n">generation</span><span class="p">;</span>
        <span class="c1">//å½“spaceä¸º0dçš„æ—¶å€™ï¼Œé‡ç½®space,æ·»åŠ gengeration</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!--</span><span class="n">spaces</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">spaces</span><span class="o">=</span><span class="n">count</span><span class="p">;</span>
            <span class="o">++</span><span class="n">generation</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//å½“space&gt;0 æ—¶</span>

            <span class="c1">//æ£€æŸ¥æ˜¯å¦ç›¸åŒ</span>
            <span class="k">while</span><span class="p">(</span><span class="n">generation</span><span class="o">==</span><span class="n">my_generation</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">//å½“æ²¡æœ‰æ”¹å˜ï¼Œå³ä¸å­˜åœ¨++generation,ç­‰å¾…ä¸€æ®µæ—¶é—´</span>

                <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//æ€»ä½“è€Œè¨€å®ç°äº†æ …æ çš„æ ¸å¿ƒï¼Œä¸»è¦æ˜¯ä½¿ç”¨æ‰€æœ‰è¿›è¡Œç­‰å¾…ï¼Œå½“æ …æ æ»¡è¶³ä¹‹åï¼Œå†åŒä¸€å¼€å§‹å·¥ä½œï¼Œcountæ˜¯æ …æ ç®¡æ§çš„çº¿ç¨‹æ€»æ•°</span>
</code></pre></div></div>

<p>ä¸Šé¢çš„æ …æ è¿˜æ˜¯ç•¥æ˜¾ç®€é™‹ï¼Œå› æ­¤éœ€è¦è¿›ä¸€æ­¥æ”¹è¿›</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">struct</span> <span class="nc">barrier</span>
<span class="p">{</span>
    <span class="c1">//çº¿ç¨‹æ€»æ•°ç»Ÿè®¡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">count</span><span class="p">;</span>
    <span class="c1">//ç©ºä½™æ€»æ•°ç»Ÿè®¡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">spaces</span><span class="p">;</span>
    <span class="c1">//æ …æ æ‰§è¡Œç›¸å…³æ¬¡æ•°ç»Ÿè®¡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">generation</span><span class="p">;</span>
    <span class="n">barrier</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">count_</span><span class="p">)</span><span class="o">:</span><span class="n">count</span><span class="p">(</span><span class="n">count_</span><span class="p">),</span><span class="n">spaces</span><span class="p">(</span><span class="n">count_</span><span class="p">),</span><span class="n">generation</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{}</span>
    <span class="c1">//waitç›¸å…³å‡½æ•°</span>

    <span class="kt">void</span> <span class="n">wait</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">gen</span><span class="o">=</span><span class="n">generation</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!--</span><span class="n">spaces</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">spaces</span><span class="o">=</span><span class="n">count</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
            <span class="o">++</span><span class="n">generation</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//æ²¡æœ‰åˆ°è¾¾æ¡ä»¶ï¼Œç­‰å¾…ä¸€ä¼šå„¿</span>

            <span class="k">while</span><span class="p">(</span><span class="n">generation</span><span class="p">.</span><span class="n">load</span><span class="p">()</span><span class="o">==</span><span class="n">gen</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//æ‰§è¡Œç­‰å¾…æ“ä½œ</span>

    <span class="kt">void</span> <span class="n">done_waiting</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="o">--</span><span class="n">count</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!--</span><span class="n">spaces</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">spaces</span><span class="o">=</span><span class="n">count</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
            <span class="o">++</span><span class="n">generation</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>


<span class="c1">//ä¸‹é¢æ˜¯æ …æ çš„å¹¶è¡Œè®¡ç®—</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">parallel_partial_sum</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="o">::</span><span class="n">value_type</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="c1">//å¤„ç†å…ƒç´ ç±»ï¼Œä¸»è¦æ˜¯æ¥è¿è¡Œä¸€ç»„çº¿ç¨‹</span>

    <span class="k">struct</span> <span class="nc">process_element</span>
    <span class="p">{</span>
        <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span>
            <span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span>
            <span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span>
            <span class="n">sstd</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">value_type</span><span class="o">&gt;&amp;</span> <span class="n">buffer</span><span class="p">,</span>
            <span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span>
            <span class="n">barrier</span><span class="o">&amp;</span> <span class="n">b</span>
            <span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//è·å–å°¾éƒ¨å…ƒç´ </span>

            <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">ith_element</span><span class="o">=*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
            <span class="c1">//æ˜¯å¦æ›´æ–°æº</span>

            <span class="kt">bool</span> <span class="n">update_source</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">step</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">stride</span><span class="o">&lt;=</span><span class="n">i</span><span class="p">;</span><span class="o">++</span><span class="n">step</span><span class="p">,</span><span class="n">stride</span><span class="o">*=</span><span class="mi">2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//stepä¸ºå¶æ•°åˆ™è¿”å›buffer[i],å¦åˆ™è¿”å›å½“å‰å…ƒç´ </span>
                <span class="c1">//ä¸»è¦æ˜¯ä»åŸå§‹æ•°æ®æˆ–è€…ç¼“å­˜ä¸­æ·»åŠ å…ƒç´ </span>

                <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">source</span><span class="o">=</span><span class="p">(</span><span class="n">step</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">?</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">:</span><span class="n">ith_element</span><span class="p">;</span>

                <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">dest</span><span class="o">=</span><span class="p">(</span><span class="n">step</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">?</span><span class="n">ith_element</span><span class="o">:</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

                <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">addend</span><span class="o">=</span><span class="p">(</span><span class="n">step</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">?</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">stride</span><span class="p">]</span><span class="o">:*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">i</span><span class="o">-</span><span class="n">stride</span><span class="p">);</span>
                <span class="c1">//å°†è®¡ç®—åçš„å€¼ï¼Œæ·»åŠ åˆ°ç¼“å­˜</span>

                <span class="n">dest</span><span class="o">=</span><span class="n">source</span><span class="o">+</span><span class="n">addend</span><span class="p">;</span>
                <span class="n">update_source</span><span class="o">=!</span><span class="p">(</span><span class="n">step</span><span class="o">%</span><span class="mi">2</span><span class="p">);</span>
                <span class="c1">//æ‰§è¡Œæ …æ ç­‰å¾…åŒæ­¥</span>

                <span class="n">b</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">update_source</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ith_element</span><span class="o">=</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="c1">//å¼€å§‹ç­‰å¾…åŒæ­¥ï¼Œç»“æŸæœ¬æ¬¡æ–°åŸ</span>

            <span class="n">b</span><span class="p">.</span><span class="n">done_waiting</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">length</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="c1">//åˆ›å»ºç¼“å†²å‘é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">value_type</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
    <span class="c1">//åˆ›å»ºæ …æ </span>

    <span class="n">barrier</span> <span class="n">b</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
    <span class="c1">//åˆ›å»ºçº¿ç¨‹</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="kr">thread</span><span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">join_threads</span> <span class="n">joiner</span><span class="p">(</span><span class="n">threads</span><span class="p">);</span>
    <span class="c1">//æ›´æ–°çº¿ç¨‹æ•°</span>

    <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
    <span class="c1">//éå†ï¼Œåˆ›å»ºçº¿ç¨‹</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span>
            <span class="n">process_element</span><span class="p">(),</span>
            <span class="n">first</span><span class="p">,</span>
            <span class="n">last</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span>
            <span class="n">i</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//æœ€åå¤„ç†å‰©ä¸‹çš„å…ƒç´ </span>
    <span class="n">process_element</span><span class="p">()(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">buffer</span><span class="p">,</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç¬¬9ç« -é«˜çº§çº¿ç¨‹æ± ">ç¬¬9ç«  é«˜çº§çº¿ç¨‹æ± </h2>
<p>å…³äºçº¿ç¨‹æ± åœ¨ä¹‹å‰çš„æ–‡ç« ä¸­æœ‰è¿‡ä»‹ç»ï¼Œå› æ­¤ä¸å†åšè¿‡å¤šè¯´æ˜</p>

<p>å¯ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹æ± </p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">function_wrapper</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">impl_base</span>
    <span class="p">{</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">call</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">virtual</span> <span class="o">~</span><span class="n">impl_base</span><span class="p">(){}</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">impl_base</span><span class="o">&gt;</span>  <span class="n">impl</span><span class="p">;</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">F</span><span class="p">&gt;</span>
    <span class="k">struct</span> <span class="nc">impl_type</span><span class="o">:</span><span class="n">impl_base</span>
    <span class="p">{</span>
        <span class="n">F</span> <span class="n">f</span><span class="p">;</span>
        <span class="n">impl_type</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">f_</span><span class="p">)</span><span class="o">:</span><span class="n">f</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f_</span><span class="p">)){}</span>
        <span class="kt">void</span> <span class="n">call</span><span class="p">(){</span><span class="n">f</span><span class="p">();}</span>
    <span class="p">};</span>
<span class="nl">public:</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">F</span><span class="p">&gt;</span>
    <span class="n">function_wrapper</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">)</span><span class="o">:</span><span class="n">impl</span><span class="p">(</span><span class="k">new</span> <span class="n">impl_type</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">))){}</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(){</span><span class="n">impl</span><span class="o">-&gt;</span><span class="n">call</span><span class="p">();}</span>
    <span class="n">function_wrapper</span><span class="p">()</span><span class="o">=</span><span class="k">default</span><span class="p">;</span>
    <span class="n">function_wrapper</span><span class="p">(</span><span class="n">function_wrapper</span><span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">:</span><span class="n">impl</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">impl</span><span class="p">)){}</span>
    <span class="n">function_wrapper</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">function_wrapper</span><span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">impl</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">impl</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">function_wrapper</span><span class="p">(</span><span class="k">const</span> <span class="n">function_wrapper</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">function_wrapper</span><span class="p">(</span><span class="n">function_wrapper</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">function_wrapper</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">function_wrapper</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">class</span> <span class="nc">thread_pool</span>
<span class="p">{</span>
    <span class="n">thread_safe_queue</span><span class="o">&lt;</span><span class="n">function_wrapper</span><span class="o">&gt;</span> <span class="n">work_queue</span><span class="p">;</span> <span class="c1">//ä½¿ç”¨function_wrapper,è€Œéä½¿ç”¨std::function</span>
    <span class="kt">void</span> <span class="n">worker_thread</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">function_wrapper</span> <span class="n">task</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">work_queue</span><span class="p">.</span><span class="n">try_pop</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">task</span><span class="p">();</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">FunctionType</span><span class="p">&gt;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">result_of</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="p">()</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span> <span class="n">submit</span><span class="p">(</span><span class="n">FunctionType</span> <span class="n">f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">typedef</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">result_of</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="p">()</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">result_type</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">packaged_task</span><span class="o">&lt;</span><span class="n">result_type</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">task</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">f</span><span class="p">));</span>
        <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">result_type</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">get_future</span><span class="p">());</span>
        <span class="n">work_queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
        <span class="k">return</span>  <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>



</code></pre></div></div>
<p>ä½¿ç”¨çº¿ç¨‹æ± æ±‚å’Œ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">T</span> <span class="nf">parallel_accumulate</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">T</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">init</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">block_size</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">num_blocks</span><span class="o">=</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">block_size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">block_size</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="o">&gt;</span> <span class="n">futures</span><span class="p">(</span><span class="n">num_blocks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">thread_pool</span> <span class="n">pool</span><span class="p">;</span>
    <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_blocks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Iteratorblock_end</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">block_end</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
        <span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">pool</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">accumulate_block</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">());</span>
        <span class="n">block_start</span><span class="o">=</span><span class="n">block_end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">T</span> <span class="n">last_result</span><span class="o">=</span><span class="n">accumulate_block</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()(</span><span class="n">block_start</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="n">T</span> <span class="n">result</span><span class="o">=</span><span class="n">init</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_blocks</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">result</span><span class="o">+=</span><span class="n">futures</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">get</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">result</span><span class="o">+=</span><span class="n">last_result</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>

<p>åŸºäºçº¿ç¨‹æ± çš„å¿«é€Ÿæ’åºå®ç°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">sorter</span>
<span class="p">{</span>
    <span class="n">thread_pool</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">do_sort</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&amp;</span> <span class="n">chunk_data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">chunk_data</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">chunk_data</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
        <span class="c1">//åˆ†å‰²æ•°æ®</span>

        <span class="n">result</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">chunk_data</span><span class="p">,</span><span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">());</span>
        <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">partition_val</span><span class="o">=*</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="c1">//åˆ†å‰²æ•°ç»„ï¼Œå¹¶è¿”å›å…³é”®è¿­ä»£æŒ‡é’ˆ</span>

        <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">divide_point</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">partition</span><span class="p">(</span>
            <span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
            <span class="n">chunk_data</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">val</span><span class="p">){</span><span class="k">return</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">partition_val</span><span class="p">;}</span>
            <span class="p">);</span>
        <span class="c1">//åˆ›å»ºè¾ƒå°éƒ¨åˆ†çš„æ•°æ®å—</span>

        <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">new_lower_chunk</span><span class="p">;</span>
        <span class="c1">//èµ‹å€¼åˆå§‹åŒ–</span>

        <span class="n">new_lower_chunk</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span>
            <span class="n">new_lower_chunk</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
            <span class="n">chunk_data</span><span class="p">,</span>
            <span class="n">chunk_data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
            <span class="n">divide_point</span>
            <span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">new_higher</span><span class="p">(</span><span class="n">do_sort</span><span class="p">(</span><span class="n">chunk_data</span><span class="p">));</span>
        <span class="c1">//å°†é«˜éƒ¨æ•°æ®æ‹·è´åˆ°result</span>

        <span class="n">result</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">new_higher</span><span class="p">);</span>

        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">new_lower</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">==</span><span class="n">std</span><span class="o">::</span><span class="n">future_status</span><span class="o">::</span><span class="n">timeout</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">pool</span><span class="p">.</span><span class="n">run_pending_task</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">result</span><span class="p">.</span><span class="n">splice</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">new_lower</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">parallel_quick_sort</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">input</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">sorter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">do_sort</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>
<h4 id="915--çªƒå–ä»»åŠ¡">9.1.5  çªƒå–ä»»åŠ¡</h4>

<p>ä¸ºäº†è®©æ²¡æœ‰ä»»åŠ¡çš„çº¿ç¨‹èƒ½ä»å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡,å°±éœ€è¦æœ¬åœ°ä»»åŠ¡åˆ—è¡¨å¯ä»¥è¿›è¡Œè®¿é—®,è¿™æ ·æ‰èƒ½è®©run_pending_tasks()çªƒå–ä»»åŠ¡ã€‚éœ€è¦æ¯ä¸ªçº¿ç¨‹åœ¨çº¿ç¨‹æ± é˜Ÿåˆ—ä¸Šè¿›è¡Œæ³¨å†Œ,æˆ–ç”±çº¿ç¨‹æ± æŒ‡å®šä¸€ä¸ªçº¿ç¨‹ã€‚åŒæ ·,è¿˜éœ€è¦ä¿è¯æ•°æ®é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡é€‚å½“çš„è¢«åŒæ­¥å’Œä¿æŠ¤,è¿™æ ·é˜Ÿåˆ—çš„ä¸å˜é‡å°±ä¸ä¼šè¢«ç ´åã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">work_stealing_queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">typedef</span> <span class="n">function_wrapper</span> <span class="n">data_type</span><span class="p">;</span>
    <span class="c1">//æ•°æ®é˜Ÿåˆ—</span>
    
    <span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">data_type</span><span class="o">&gt;</span> <span class="n">the_queue</span><span class="p">;</span>
    <span class="k">mutable</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span>  <span class="n">the_mutex</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">work_stealing_queue</span><span class="p">(){}</span>
    <span class="n">work_stealing_queue</span><span class="p">(</span><span class="k">const</span> <span class="n">work_stealing_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">work_stealing_queue</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">work_stealing_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">data_type</span>  <span class="n">data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">the_mutex</span><span class="p">);</span>
        <span class="n">the_queue</span><span class="p">.</span><span class="n">push_front</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">empty</span><span class="p">()</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">the_mutex</span><span class="p">);</span>
        <span class="k">return</span>  <span class="n">the_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//å®‰å…¨çš„å–å‡ºæ•°æ®</span>

    <span class="kt">bool</span> <span class="n">try_pop</span><span class="p">(</span><span class="n">data_type</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">the_mutex</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">the_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">res</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">the_queue</span><span class="p">.</span><span class="n">front</span><span class="p">());</span>
        <span class="n">the_queue</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
        <span class="k">return</span>  <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//å¯¹é˜Ÿåˆ—åç«¯è¿›è¡Œæ“ä½œ</span>

    <span class="kt">bool</span> <span class="n">try_steal</span><span class="p">(</span><span class="n">data_type</span><span class="o">&amp;</span> <span class="n">res</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">the_mutex</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">the_queue</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">res</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">the_queue</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
        <span class="n">the_queue</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
        <span class="k">return</span>  <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>
<p>ä½¿ç”¨ä»»åŠ¡çªƒå–çš„çº¿ç¨‹æ± </p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">thread_pool</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">function_wrapper</span> <span class="n">task_type</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic_bool</span> <span class="n">done</span><span class="p">;</span>
    <span class="n">thread_safe_queue</span><span class="o">&lt;</span><span class="n">task_type</span><span class="o">&gt;</span> <span class="n">pool_work_queue</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">work_stealing_queue</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">queues</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
    <span class="n">join_threads</span> <span class="n">joiner</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">thread_local</span> <span class="n">work_stealing_queue</span><span class="o">*</span> <span class="n">local_work_queue</span><span class="p">;</span>
    <span class="k">static</span> <span class="k">thread_local</span> <span class="kt">unsigned</span> <span class="n">my_index</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">worker_thread</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">my_index_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">my_index</span><span class="o">=</span><span class="n">my_index_</span><span class="p">;</span>
        <span class="n">local_work_queue</span><span class="o">=</span><span class="n">queues</span><span class="p">[</span><span class="n">my_index</span><span class="p">].</span><span class="n">get</span><span class="p">();</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">run_pending_task</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">pop_task_from_local_queue</span><span class="p">(</span><span class="n">task_type</span><span class="o">&amp;</span> <span class="n">task</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">local_work_queue</span> <span class="o">&amp;&amp;</span> <span class="n">local_work_queue</span><span class="o">-&gt;</span><span class="n">try_pop</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">pop_task_from_pool_queue</span><span class="p">(</span><span class="n">task_type</span><span class="o">&amp;</span> <span class="n">task</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span>  <span class="n">pool_work_queue</span><span class="p">.</span><span class="n">try_pop</span><span class="p">(</span><span class="n">task</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">pop_task_from_other_thread_queue</span><span class="p">(</span><span class="n">task_type</span><span class="o">&amp;</span> <span class="n">task</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span>  <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">queues</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="n">my_index</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">queues</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
            <span class="k">if</span><span class="p">(</span><span class="n">queues</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">try_steal</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="n">thread_pool</span><span class="p">()</span><span class="o">:</span><span class="n">done</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span><span class="n">joiner</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="k">const</span> <span class="n">thread_count</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">thread_count</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">queues</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">work_stealing_queue</span><span class="o">&gt;</span><span class="p">(</span><span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_pool</span><span class="o">::</span><span class="n">worker_thread</span><span class="p">,</span><span class="k">this</span><span class="p">,</span><span class="n">i</span><span class="p">))));</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="k">catch</span><span class="p">(...)</span>
        <span class="p">{</span>
            <span class="n">done</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
            <span class="k">throw</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="o">~</span><span class="n">thread_pool</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">done</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">FunctionType</span><span class="p">&gt;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">result_of</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="p">()</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span> <span class="n">submit</span><span class="p">(</span><span class="n">FunctionType</span> <span class="n">f</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">typedef</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">result_of</span><span class="o">&lt;</span><span class="n">FunctionType</span><span class="p">()</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">result_type</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">packaged_task</span><span class="o">&lt;</span><span class="n">result_type</span><span class="p">()</span><span class="o">&gt;</span> <span class="n">task</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="n">result_type</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">get_future</span><span class="p">());</span>
        <span class="k">if</span><span class="p">(</span><span class="n">local_work_queue</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">local_work_queue</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">pool_work_queue</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">task</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">run_pending_task</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">task_type</span> <span class="n">task</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">pop_task_from_local_queue</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">||</span>
           <span class="n">pop_task_from_pool_queue</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="o">||</span>
           <span class="n">pop_task_from_other_thread_queue</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">task</span><span class="p">();</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h3 id="92-çº¿ç¨‹ä¸­æ–­">9.2 çº¿ç¨‹ä¸­æ–­</h3>

<p>æ“ä½œç³»ç»Ÿä¸­çš„çº¿ç¨‹ä¸­æ–­å’ŒæŒ‚èµ·æœºåˆ¶ï¼Œéœ€è¦ä½¿ç”¨ä¿¡å·æ¥è®©æœªç»“æŸçº¿ç¨‹åœæ­¢è¿è¡Œã€‚è¿™é‡Œéœ€è¦ä¸€ç§åˆé€‚çš„æ–¹å¼è®©çº¿ç¨‹ä¸»åŠ¨çš„åœä¸‹æ¥,è€Œéè®©çº¿ç¨‹æˆ›ç„¶è€Œæ­¢ã€‚</p>

<h4 id="921-å¯åŠ¨å’Œä¸­æ–­çº¿ç¨‹">9.2.1 å¯åŠ¨å’Œä¸­æ–­çº¿ç¨‹</h4>

<p>çº¿ç¨‹çš„ä¸­æ–­å¤šéœ€è¦åœ¨çº¿ç¨‹çš„åŸæœ‰åŸºç¡€ä¹‹ä¸Šï¼Œæ·»åŠ çº¿ç¨‹ä¸­æ–­çš„ç¨‹åºã€‚</p>

<p>std::condition_variable åœ¨interruptible_waitä¸­ä½¿ç”¨è¶…æ—¶</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">interrupt_flag</span>
<span class="p">{</span>
    <span class="c1">//æ˜¯å¦ä¸­æ–­</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">flag</span><span class="p">;</span>
    <span class="c1">//ç¯å¢ƒå˜é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="o">*</span> <span class="n">thread_cond</span><span class="p">;</span>
    <span class="c1">//æ¸…é™¤ä¿¡å·é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">set_clear_mutex</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">interrupt_flag</span><span class="p">()</span><span class="o">:</span><span class="n">thread_cond</span><span class="p">(</span><span class="mi">0</span><span class="p">){}</span>
    <span class="kt">void</span> <span class="n">set</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">flag</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">set_clear_mutex</span><span class="p">);</span>
        <span class="c1">//è®¾è®¡ç¯å¢ƒå˜é‡</span>

        <span class="k">if</span><span class="p">(</span><span class="n">thread_cond</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//å‘å°„ç¯å¢ƒä¿¡å·</span>

            <span class="n">thread_cond</span><span class="o">-&gt;</span><span class="n">notify_all</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//æŸ¥çœ‹æ˜¯å¦è®¾ç½®</span>

    <span class="kt">bool</span> <span class="n">is_set</span><span class="p">()</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">flag</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">set_condition_variable</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="o">&amp;</span> <span class="n">cv</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ä¿¡å·åŠ é”</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">set_clear_mutex</span><span class="p">);</span>
        <span class="c1">//æ›´æ–°æ¡ä»¶å˜é‡</span>

        <span class="n">thread_cond</span><span class="o">=&amp;</span><span class="n">cv</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//æ¸…é™¤ç¯å¢ƒå˜é‡</span>

    <span class="kt">void</span> <span class="n">clear_condition_variable</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">set_clear_mutex</span><span class="p">);</span>
        <span class="n">thread_cond</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">struct</span> <span class="nc">clear_cv_on_destruct</span>
    <span class="p">{</span>
        <span class="o">~</span><span class="n">clear_cv_on_destruct</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">this_thread_interrupt_flag</span><span class="p">.</span><span class="n">clear_condition_variable</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">};</span>
<span class="k">thread_local</span> <span class="n">interrupt_flag</span> <span class="n">this_thread_interrupt_flag</span><span class="p">;</span>
<span class="c1">//æ£€æŸ¥ä¸­æ–­ç‚¹ï¼Œé€šè¿‡æ£€æŸ¥flagå€¼æ¥åˆ¤æ–­ï¼Œå¦‚æœflagä¸ºtrueæŠ›å‡ºä¿¡å·</span>

<span class="kt">void</span> <span class="nf">interruption_point</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">this_thread_interrupt_flag</span><span class="p">.</span><span class="n">is_set</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="n">thread_interrupted</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//ä¸­æ–­ç­‰å¾…</span>

<span class="kt">void</span> <span class="nf">interruptible_wait</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="o">&amp;</span> <span class="n">cv</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;&amp;</span> <span class="n">lk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">interruption_point</span><span class="p">();</span>
    <span class="n">this_thread_interrupt_flag</span><span class="p">.</span><span class="n">set_condition_variable</span><span class="p">(</span><span class="n">cv</span><span class="p">);</span>
    <span class="c1">//ä¸´æ—¶é”</span>

    <span class="n">interrupt_flag</span><span class="o">::</span><span class="n">clear_cv_on_destruct</span> <span class="n">gurad</span><span class="p">;</span>
    <span class="c1">//å†æ¬¡æ£€æŸ¥</span>
    <span class="n">cv</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">interruption_point</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//ä¸­æ–­ç­‰å¾…</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Predicate</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">interruptible_wait</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="o">&amp;</span> <span class="n">cv</span><span class="p">,</span>
                        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;&amp;</span> <span class="n">lk</span><span class="p">,</span>
                        <span class="n">Predicate</span> <span class="n">pred</span>
                        <span class="p">)</span>
<span class="p">{</span>
    <span class="n">interruption_point</span><span class="p">();</span>
    <span class="n">this_thread_interrupt_flag</span><span class="p">.</span><span class="n">set_condition_variable</span><span class="p">(</span><span class="n">cv</span><span class="p">);</span>
    <span class="n">interrupt_flag</span><span class="o">::</span><span class="n">clear_cv_on_destruct</span> <span class="n">gurad</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">this_thread_interrupt_flag</span><span class="p">.</span><span class="n">is_set</span><span class="p">()</span><span class="o">&amp;&amp;!</span><span class="n">pred</span><span class="p">())</span> 
    <span class="p">{</span>
        <span class="n">cv</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">lk</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">interruption_point</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸ºstd::condition_variable_any è®¾è®¡çš„interruptible_wait</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">interrupt_flag</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">flag</span><span class="p">;</span>
    <span class="c1">//ç¯å¢ƒæ¡ä»¶å˜é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="o">*</span> <span class="n">thread_cond</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable_any</span><span class="o">*</span> <span class="n">thread_cond_any</span><span class="p">;</span>
    <span class="c1">//è®¿é—®äº’æ–¥ä¿¡å·é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">set_clear_mutex</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">interrupt_flag</span><span class="p">()</span><span class="o">:</span>   
    <span class="n">thread_cond</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">thread_cond_any</span><span class="p">(</span><span class="mi">0</span><span class="p">){}</span>
    <span class="kt">void</span> <span class="n">set</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//æ›´æ”¹å€¼</span>
        
        <span class="n">flag</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="c1">//åŠ é”</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">set_clear_mutex</span><span class="p">);</span>
        <span class="c1">//ç¯å¢ƒå˜é‡</span>

        <span class="k">if</span><span class="p">(</span><span class="n">thread_cond</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">thread_cond</span><span class="o">-&gt;</span><span class="n">notify_all</span><span class="p">();</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">thread_cond_any</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">thread_cond_any</span><span class="o">-&gt;</span><span class="n">notify_all</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//ç­‰å¾…å‡½æ•°</span>

    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Lockable</span><span class="p">&gt;</span>
    <span class="kt">void</span> <span class="n">wait</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable_any</span><span class="o">&amp;</span> <span class="n">cv</span><span class="p">,</span><span class="n">Lockable</span><span class="o">&amp;</span> <span class="n">lk</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//ä¼ ç»Ÿé»˜è®¤é”</span>

            <span class="k">struct</span>  <span class="nc">custom_lock</span>
            <span class="p">{</span>
                <span class="n">interrupt_flag</span><span class="o">*</span> <span class="n">self</span><span class="p">;</span>
                <span class="n">Lockable</span><span class="o">&amp;</span> <span class="n">lk</span><span class="p">;</span>
                
                <span class="n">custom_lock</span><span class="p">(</span>
                    <span class="n">interrupt_flag</span><span class="o">*</span> <span class="n">self_</span><span class="p">,</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable_any</span><span class="o">&amp;</span> <span class="n">cond</span><span class="p">,</span>
                    <span class="n">Lockable</span><span class="o">&amp;</span> <span class="n">lk_</span><span class="p">)</span><span class="o">:</span>
                <span class="n">self</span><span class="p">(</span><span class="n">self_</span><span class="p">),</span>
                <span class="n">lk</span><span class="p">(</span><span class="n">lk_</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">set_clear_mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">thread_cond_any</span><span class="o">=&amp;</span><span class="n">cond</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="kt">void</span> <span class="n">unlock</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">lk</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">set_clear_mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="p">}</span>

                <span class="kt">void</span> <span class="n">lock</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">lock</span><span class="p">(</span><span class="n">self</span><span class="o">-&gt;</span><span class="n">set_clear_mutex</span><span class="p">,</span><span class="n">lk</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="o">~</span><span class="n">custom_lock</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">thread_cond_any</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
                    <span class="n">self</span><span class="o">-&gt;</span><span class="n">set_clear_mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">};</span>
            <span class="n">custom_lock</span> <span class="n">cl</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="n">cv</span><span class="p">,</span><span class="n">lk</span><span class="p">);</span>
            <span class="n">interruption_point</span><span class="p">();</span>
            <span class="n">cv</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cl</span><span class="p">);</span>
            <span class="n">interruption_point</span><span class="p">();</span>
        <span class="p">}</span>
<span class="p">};</span>
<span class="c1">//ä¸­æ–­ç­‰å¾…</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Lockable</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">interruptible_wait</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable_any</span><span class="o">&amp;</span> <span class="n">cv</span><span class="p">,</span><span class="n">Lockable</span><span class="o">&amp;</span> <span class="n">lk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">this_thread_interrupt_flag</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cv</span><span class="p">,</span><span class="n">lk</span><span class="p">);</span>
<span class="p">}</span>


</code></pre></div></div>
<h3 id="ç¬¬10ç« -å¤šçº¿ç¨‹ç¨‹åºçš„æµ‹è¯•å’Œè°ƒè¯•">ç¬¬10ç«  å¤šçº¿ç¨‹ç¨‹åºçš„æµ‹è¯•å’Œè°ƒè¯•</h3>

<h4 id="101-ä¸å¹¶å‘ç›¸å…³çš„é”™è¯¯ç±»å‹">10.1 ä¸å¹¶å‘ç›¸å…³çš„é”™è¯¯ç±»å‹</h4>

<ul>
  <li>ä¸å¿…è¦é˜»å¡ï¼šä¸€ä¸ªçº¿ç¨‹è¢«é˜»å¡çš„æ—¶å€™,ä¸èƒ½å¤„ç†ä»»ä½•ä»»åŠ¡,å› ä¸ºå®ƒåœ¨ç­‰å¾…å…¶ä»–â€œæ¡ä»¶â€çš„è¾¾æˆã€‚å³é˜»å¡ä¸æ˜¯å¿…è¦çš„
    <ul>
      <li>æ­»é”:ç›¸äº’ç­‰å¾…ç›´åˆ°æ°¸è¿œï¼Œæ— æ³•è‡ªå·±è·³å‡º,ä¸»è¦åŸå› æ˜¯æ— æ³•æ£€æŸ¥å…¶å®ƒç›¸å…³å˜é‡çš„å˜åŒ–</li>
      <li>æ´»é”:ä¸æ­»é”åŸºæœ¬ç›¸åŒä½†ä¸æ˜¯çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œè€Œæ˜¯åœ¨å¾ªç¯ä¸­æŒç»­æ£€æŸ¥ï¼Œå¦‚:è‡ªæ—‹é”ã€‚é—®é¢˜å¯ä»¥è§£å†³ã€‚</li>
      <li>I/Oé˜»å¡æˆ–å¤–éƒ¨è¾“å…¥:å½“çº¿ç¨‹è¢«å¤–éƒ¨è¾“å…¥æ‰€é˜»å¡,çº¿ç¨‹ä¹Ÿå°±ä¸èƒ½åšå…¶ä»–äº‹æƒ…äº†(å³ä½¿,ç­‰å¾…è¾“å…¥çš„æƒ…å†µæ°¸è¿œä¸ä¼šå‘ç”Ÿ)ã€‚</li>
    </ul>
  </li>
  <li>æ¡ä»¶ç«äº‰:
    <ul>
      <li>æ•°æ®ç«äº‰ï¼šå› ä¸ºæœªåŒæ­¥è®¿é—®ä¸€å—å…±äº«å†…å­˜,å°†ä¼šå¯¼è‡´ä»£ç äº§ç”Ÿæœªå®šä¹‰è¡Œä¸º</li>
      <li>ç ´åä¸å˜é‡:ä¸»è¦è¡¨ç°ä¸ºæ‚¬ç©ºæŒ‡é’ˆ(å› ä¸ºå…¶ä»–çº¿ç¨‹å·²ç»å°†è¦è®¿é—®çš„æ•°æ®åˆ é™¤äº†),éšæœºå­˜å‚¨é”™è¯¯(å› ä¸ºå±€éƒ¨æ›´æ–°,å¯¼è‡´çº¿ç¨‹è¯»å–äº†ä¸ä¸€æ ·çš„æ•°æ®),ä»¥åŠåŒé‡é‡Šæ”¾(æ¯”å¦‚:å½“ä¸¤ä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªé˜Ÿåˆ—åŒæ—¶æ‰§è¡Œpopæ“ä½œ,æƒ³è¦åˆ é™¤åŒä¸€ä¸ªå…³è”æ•°æ®),ç­‰ç­‰ã€‚</li>
      <li>ç”Ÿå‘½å‘¨æœŸé—®é¢˜:çº¿ç¨‹è®¿é—®å˜é‡æ—¶ï¼Œå˜é‡çš„å£°æ˜å‘¨æœŸå·²ç»ç»“æŸã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="102-å®šä½å¹¶å‘é”™è¯¯çš„æŠ€æœ¯">10.2 å®šä½å¹¶å‘é”™è¯¯çš„æŠ€æœ¯</h3>

<ul>
  <li>ä»£ç å®¡é˜…â€”â€”å‘ç°æ½œåœ¨çš„é”™è¯¯ï¼Œä¸»è¦è€ƒè™‘çš„é—®é¢˜
    <ul>
      <li>å¹¶å‘è®¿é—®æ—¶,é‚£äº›æ•°æ®éœ€è¦ä¿æŠ¤?</li>
      <li>å¦‚ä½•ç¡®å®šè®¿é—®æ•°æ®å—åˆ°äº†ä¿æŠ¤?</li>
      <li>æ˜¯å¦ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®è¿™æ®µä»£ç ?</li>
      <li>è¿™ä¸ªçº¿ç¨‹è·å–äº†å“ªä¸ªäº’æ–¥é‡?</li>
      <li>å…¶ä»–çº¿ç¨‹å¯èƒ½è·å–å“ªäº›äº’æ–¥é‡?</li>
      <li>ä¸¤ä¸ªçº¿ç¨‹é—´çš„æ“ä½œæ˜¯å¦æœ‰ä¾èµ–å…³ç³»?å¦‚ä½•æ»¡è¶³è¿™ç§å…³ç³»ï¼Ÿ</li>
      <li>è¿™ä¸ªçº¿ç¨‹åŠ è½½çš„æ•°æ®è¿˜æ˜¯åˆæ³•æ•°æ®å—?æ•°æ®æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡?</li>
      <li>å½“å‡è®¾å…¶ä»–çº¿ç¨‹å¯ä»¥å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹,è¿™å°†æ„å‘³ç€ä»€ä¹ˆ?å¹¶ä¸”,æ€ä¹ˆç¡®ä¿è¿™æ ·çš„äº‹æƒ…ä¸
ä¼šå‘ç”Ÿ?</li>
    </ul>
  </li>
  <li>é€šè¿‡æµ‹è¯•å®šä½å¹¶å‘ç›¸å…³çš„é”™è¯¯ï¼Œè€ƒè™‘å› ç´ 
    <ul>
      <li>â€œå¤šçº¿ç¨‹â€æ˜¯æœ‰å¤šå°‘ä¸ªçº¿ç¨‹(3ä¸ª,4ä¸ª,è¿˜æ˜¯1024ä¸ª?)</li>
      <li>ç³»ç»Ÿä¸­æ˜¯å¦æœ‰è¶³å¤Ÿçš„å¤„ç†å™¨,èƒ½è®©æ¯ä¸ªçº¿ç¨‹è¿è¡Œåœ¨å±äºè‡ªå·±çš„å¤„ç†å™¨ä¸Š</li>
      <li>æµ‹è¯•éœ€è¦è¿è¡Œåœ¨å“ªç§å¤„ç†å™¨æ¶æ„ä¸Š</li>
      <li>åœ¨æµ‹è¯•ä¸­å¦‚ä½•å¯¹â€œåŒæ—¶â€è¿›è¡Œåˆç†çš„å®‰æ’</li>
    </ul>
  </li>
  <li>å¯æµ‹è¯•æ€§è®¾è®¡
    <ul>
      <li>æ¯ä¸ªå‡½æ•°å’Œç±»çš„å…³ç³»éƒ½å¾ˆæ¸…æ¥šã€‚</li>
      <li>å‡½æ•°çŸ­å°ç²¾æ‚ã€‚</li>
      <li>æµ‹è¯•ç”¨ä¾‹å¯ä»¥å®Œå…¨æ§åˆ¶è¢«æµ‹è¯•ä»£ç å‘¨è¾¹çš„ç¯å¢ƒã€‚</li>
      <li>æ‰§è¡Œç‰¹å®šæ“ä½œçš„ä»£ç åº”è¯¥é›†ä¸­æµ‹è¯•,è€Œéåˆ†å¸ƒå¼æµ‹è¯•ã€‚</li>
      <li>éœ€è¦åœ¨å®Œæˆç¼–å†™å,è€ƒè™‘å¦‚ä½•è¿›è¡Œæµ‹è¯•ã€‚</li>
    </ul>
  </li>
</ul>

:ET