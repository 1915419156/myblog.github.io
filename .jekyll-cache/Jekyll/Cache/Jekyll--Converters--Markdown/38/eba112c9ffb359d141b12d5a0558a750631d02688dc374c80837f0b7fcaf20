I"w–<blockquote>
  <p>2019-7-3 20:56:48</p>
</blockquote>

<h1 id="cå¹¶å‘ç¼–ç¨‹é˜…è¯»ç¬”è®°">C++å¹¶å‘ç¼–ç¨‹é˜…è¯»ç¬”è®°</h1>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<ul>
  <li><a href="https://chenxiaowei.gitbooks.io/cpp_concurrency_in_action/">C++ å¹¶å‘ç¼–ç¨‹ä¸­æ–‡ç‰ˆ</a>ï¼›</li>
  <li><a href="https://legacy.gitbook.com/book/chenxiaowei/c-concurrency-in-action-second-edition-2019">ç¬¬äºŒç‰ˆåœ¨çº¿åœ°å€</a></li>
</ul>

<h2 id="ç¬¬1ç« -ä½ å¥½cçš„å¹¶å‘ä¸–ç•Œ">ç¬¬1ç«  ä½ å¥½ï¼ŒC++çš„å¹¶å‘ä¸–ç•Œ</h2>

<h3 id="111--ä½•è°“å¹¶å‘">1.1.1  ä½•è°“å¹¶å‘</h3>

<p><strong>å¹¶å‘</strong>ï¼šCPUäº¤æ›¿ä½¿ç”¨æ—¶é’Ÿï¼Œæ¨¡æ‹Ÿå¹¶å‘</p>

<p><strong>å¹¶è¡Œ</strong>ï¼šçº¿ç¨‹çš„çœŸæ­£å¹¶è¡Œæ‰§è¡Œ</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-03 21-04-58.png" alt="å¤šçº¿ç¨‹å¹¶è¡Œæ¯”è¾ƒ" /></p>

<h4 id="112--å¹¶å‘çš„é€”å¾„">1.1.2  å¹¶å‘çš„é€”å¾„</h4>

<ul>
  <li>å¤šè¿›ç¨‹å¹¶å‘ï¼šå°†åº”ç”¨ç¨‹åºåˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„è¿›ç¨‹,å®ƒä»¬åœ¨åŒä¸€æ—¶åˆ»è¿è¡Œ,å°±åƒåŒ
æ—¶è¿›è¡Œç½‘é¡µæµè§ˆå’Œæ–‡å­—å¤„ç†ä¸€æ ·ã€‚</li>
  <li>å¤šçº¿ç¨‹å¹¶å‘ï¼šåœ¨å•ä¸ªè¿›ç¨‹ä¸­è¿è¡Œå¤šä¸ªçº¿ç¨‹ã€‚çº¿ç¨‹å¾ˆåƒè½»é‡çº§çš„è¿›ç¨‹:æ¯ä¸ªçº¿ç¨‹ç›¸äº’ç‹¬
ç«‹è¿è¡Œ,ä¸”çº¿ç¨‹å¯ä»¥åœ¨ä¸åŒçš„æŒ‡ä»¤åºåˆ—ä¸­è¿è¡Œã€‚è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å…±äº«åœ°å€ç©ºé—´,
å¹¶ä¸”æ‰€æœ‰çº¿ç¨‹è®¿é—®åˆ°å¤§éƒ¨åˆ†æ•°æ®â€”â€”â€”å…¨å±€å˜é‡ä»ç„¶æ˜¯å…¨å±€çš„,æŒ‡é’ˆã€å¯¹è±¡çš„å¼•ç”¨æˆ–æ•°æ®å¯
ä»¥åœ¨çº¿ç¨‹ä¹‹é—´ä¼ é€’ã€‚</li>
</ul>

<p><strong>æ³¨æ„ï¼šLinux ä¸€èˆ¬å…è®¸çš„æœ€å¤§å †æ ˆä¸º8-10Mï¼Œéœ€è¦è‡ªå·±è®¾ç½®æ‰©å®¹</strong></p>

<p>ç¨‹åºå¹¶å‘çš„æ–¹å¼æœ‰2ç§ï¼š</p>

<ul>
  <li>ç¨‹åºæ‰§è¡Œå¹¶è¡Œï¼šä¸åŒçš„çº¿ç¨‹æ‰§è¡Œï¼Œä¸åŒçš„è¿‡ç¨‹</li>
  <li>æ•°æ®å¹¶è¡Œï¼šä¸åŒçš„çº¿ç¨‹æ‰§è¡Œç›¸åŒçš„ç¨‹åºï¼Œå¤„ç†ä¸åŒçš„æ•°æ®ã€‚</li>
</ul>

<h3 id="14-å¼€å§‹å…¥é—¨">1.4 å¼€å§‹å…¥é—¨</h3>
<p>å¼€å§‹å¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¸€ä¸ªç®€å•ä¾‹å­ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;iostream&gt;
</span>
<span class="cp">#include &lt;thread&gt;
</span>
<span class="kt">void</span> <span class="nf">hello</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"Hello Concurrent World</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//è®¾ç½®çº¿ç¨‹åˆå§‹å‡½æ•°åç§°</span>

    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">hello</span><span class="p">);</span> 
    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="ç¬¬2ç« --çº¿ç¨‹ç®¡ç†">ç¬¬2ç«   çº¿ç¨‹ç®¡ç†</h2>

<h3 id="21-çº¿ç¨‹ç®¡ç†çš„åŸºç¡€">2.1 çº¿ç¨‹ç®¡ç†çš„åŸºç¡€</h3>

<p>main()å‡½æ•°å°±æ˜¯ä¸€ä¸ªç¨‹åºçš„ä¸»è¦çº¿ç¨‹ï¼Œå…¶å®ƒçº¿ç¨‹ä¸»è¦ç”±å‡½æ•°çš„å…¥å£æ‰€å†³å®šã€‚å½“çº¿ç¨‹æ‰§è¡Œå®Œå…¥å£å‡½æ•°åï¼Œçº¿ç¨‹ä¹Ÿä¼šé€€å‡ºã€‚</p>

<h4 id="211-å¯åŠ¨çº¿ç¨‹">2.1.1 å¯åŠ¨çº¿ç¨‹</h4>

<p><em>å‚è€ƒé“¾æ¥:</em> <a href="https://www.cnblogs.com/zhanghu52030/p/9166526.html">c++å¹¶å‘ç¼–ç¨‹</a></p>

<p>çº¿ç¨‹åœ¨<code class="language-plaintext highlighter-rouge">std::thread</code>å¯¹è±¡æ„é€ æ—¶å°±å¼€å§‹å¯åŠ¨äº†ï¼Œæ— è¿”å›å€¼æ—¶ï¼Œå¯åŠ¨åè‡ªåŠ¨ç»“æŸï¼Œå­˜åœ¨è¿”å›å€¼æ—¶ï¼Œå‚æ•°ä¼ é€’å®Œæˆåç»“æŸã€‚</p>

<p><code class="language-plaintext highlighter-rouge">std::thread</code>å…è®¸ä½¿ç”¨å¸¦æœ‰å‡½æ•°è°ƒç”¨ç¬¦ç±»å‹çš„å®ä¾‹ä¼ å…¥<code class="language-plaintext highlighter-rouge">std::thread</code>ç±»ä¸­ï¼Œæ¥æ›¿æ¢é»˜è®¤çš„æ„é€ å‡½æ•°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span> <span class="nc">background_task</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()()</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="n">do_something</span><span class="p">();</span>
        <span class="n">do_something_else</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="n">background_task</span> <span class="n">f</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">my_thread</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>


</code></pre></div></div>

<p>æ³¨æ„ï¼š å½“æŠŠå‡½æ•°å¯¹è±¡ä¼ å…¥åˆ°çº¿ç¨‹æ„é€ å‡½æ•°ä¸­æ—¶ï¼Œå¦‚æœä½ ä¼ é€’ä¸€ä¸ªä¸´æ—¶å˜é‡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå‘½åçš„å˜
é‡;C++ç¼–è¯‘å™¨ä¼šå°†å…¶è§£æä¸ºå‡½æ•°å£°æ˜,è€Œä¸æ˜¯ç±»å‹å¯¹è±¡çš„å®šä¹‰ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">my_thread</span><span class="p">(</span><span class="n">background_task</span><span class="p">());</span>

<span class="c1">// å£°æ˜äº†ä¸€ä¸ªåä¸ºmy_threadçš„å‡½æ•°ï¼Œå‡½æ•°æŒ‡é’ˆæŒ‡å‘æ²¡æœ‰å‚æ•°å¹¶è¿”å›background_taskå¯¹è±¡çš„å‡½æ•°ï¼›è¿”å›ä¸€ä¸ªstd::threadå¯¹è±¡çš„å‡½æ•°ï¼Œè€Œéå¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹</span>

<span class="c1">//ä½¿ç”¨å¤šç»„æ‹¬å·æˆ–è€…æ–°çš„ç»Ÿä¸€åˆå§‹åŒ–è¯­æ³•å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">my_thread</span><span class="p">((</span><span class="n">background_task</span><span class="p">()));</span> 
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">my_thread</span><span class="p">{</span><span class="n">background_task</span><span class="p">()};</span>

<span class="c1">//ä½¿ç”¨lambdaè¡¨è¾¾å¼ä¹Ÿèƒ½é¿å…è¿™ä¸ªé—®é¢˜</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">my_thread</span><span class="p">([]{</span>
    <span class="n">do_something</span><span class="p">();</span>
    <span class="n">do_something_else</span><span class="p">();</span>
<span class="err">}</span><span class="p">);</span>

</code></pre></div></div>
<p>å¦‚æœæ²¡æœ‰æŒ‡å®šçº¿ç¨‹çš„é”€æ¯<code class="language-plaintext highlighter-rouge">std::thread</code>å¯¹è±¡ä¼šåœ¨ææ„å‡½æ•°ä¸­è°ƒç”¨<code class="language-plaintext highlighter-rouge">std::terminate()</code>è¿›è¡Œå¯¹è±¡é”€æ¯å’Œææ„ã€‚</p>

<p>æ³¨æ„ï¼š</p>

<ul>
  <li><strong>å¦‚æœéœ€è¦è‡ªå·±æŒ‡å®šçº¿ç¨‹é”€æ¯ï¼Œå¿…é¡»åœ¨<code class="language-plaintext highlighter-rouge">std::thread</code>å¯¹è±¡é”€æ¯ä¹‹å‰å†³å®š</strong></li>
  <li><strong>å¦‚æœä¸ä¸»åŠ¨ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œå°±å¿…é¡»ä¿è¯çº¿ç¨‹ç»“æŸä¹‹å‰ï¼Œæ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œé¿å…çº¿ç¨‹è¿˜æœªç»“æŸï¼Œå‡½æ•°å·²ç»é€€å‡ºï¼Œå˜é‡æˆä¸ºé”€æ¯çš„å±€éƒ¨å˜é‡</strong></li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">func</span>
<span class="p">{</span>
    <span class="kt">int</span><span class="o">&amp;</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">func</span><span class="p">(</span><span class="kt">int</span><span class="o">&amp;</span> <span class="n">i_</span><span class="p">)</span> <span class="o">:</span><span class="n">i</span><span class="p">(</span><span class="n">i_</span><span class="p">){}</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()</span> <span class="p">()</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span>   <span class="n">j</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span>   <span class="n">j</span><span class="o">&lt;</span><span class="mi">1000000</span>   <span class="p">;</span>   <span class="o">++</span><span class="n">j</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">do_something</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
                <span class="c1">//  1.  æ½œåœ¨è®¿é—®éšæ‚£:æ‚¬ç©ºå¼•ç”¨</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="kt">void</span> <span class="nf">oops</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">some_local_state</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">func</span> <span class="n">my_func</span><span class="p">(</span><span class="n">some_local_state</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">my_thread</span><span class="p">(</span><span class="n">my_func</span><span class="p">);</span>
    <span class="n">my_thread</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
    <span class="c1">//  2.  ä¸ç­‰å¾…çº¿ç¨‹ç»“æŸ</span>

<span class="p">}</span>                                                                    <span class="c1">//  3.  æ–°çº¿ç¨‹å¯èƒ½è¿˜åœ¨è¿è¡Œ</span>


</code></pre></div></div>

<p>å¯¹äºä¸Šè¿°çš„å¤„ç†æ–¹æ³•æ˜¯å°†æ•°æ®å¤åˆ¶åˆ°çº¿ç¨‹ä¸­ï¼Œä½¿å¾—çº¿ç¨‹å‡½æ•°çš„åŠŸèƒ½é½å…¨ã€‚è€Œéå¤åˆ¶åˆ°å…±äº«æ•°æ®ä¸­ã€‚æ­¤å¤–,å¯ä»¥é€šè¿‡join()å‡½æ•°æ¥ç¡®ä¿çº¿ç¨‹åœ¨å‡½æ•°å®Œæˆå‰ç»“æŸã€‚ä½†æ˜¯join()åªæ˜¯ç®€å•ç²—æš´çš„ç­‰å¾…çº¿ç¨‹å®Œæˆæˆ–è€…ä¸ç­‰å¾…ã€‚ç­‰å¾…çº¿ç¨‹å®Œæˆçš„ä¾‹å­å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span>  <span class="nc">func</span><span class="p">;</span>   <span class="c1">//å®šä¹‰åœ¨æ¸…å•2.1ä¸­</span>

<span class="kt">void</span> <span class="nf">f</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">some_local_state</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">func</span> <span class="n">my_func</span><span class="p">(</span><span class="n">some_local_state</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">my_func</span><span class="p">);</span>
    <span class="c1">//ä½¿ç”¨å¼‚å¸¸æ•è·ï¼Œä¿è¯è®¿é—®æœ¬åœ°çŠ¶æ€çš„çº¿ç¨‹é€€å‡ºåï¼Œå‡½æ•°æ‰ç»“æŸ</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">do_something_in_current_thread</span><span class="p">();</span>
    <span class="p">}</span><span class="k">catch</span><span class="p">(...)</span>
    <span class="p">{</span>
        <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>       <span class="cm">/* ç­‰å¾…çº¿ç¨‹ç»“æŸ */</span>
        <span class="k">throw</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>       <span class="cm">/* ç­‰å¾…çº¿ç¨‹ç»“æŸ */</span>

<span class="p">}</span>

<span class="cm">/*ä½¿ç”¨â€œèµ„æºè·å–å³åˆå§‹åŒ–æ–¹å¼â€(RAII,Resource  Acquisition Is  Initialization)ç­‰å¾…çº¿ç¨‹é€€å‡º*/</span>

<span class="k">class</span> <span class="nc">thread_guard</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">thread_guard</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&amp;</span> <span class="n">t_</span><span class="p">)</span><span class="o">:</span><span class="n">t</span><span class="p">(</span><span class="n">t_</span><span class="p">)</span>
    <span class="p">{</span>

    <span class="p">}</span>
    <span class="o">~</span><span class="n">thread_guard</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//åˆ¤æ–­çº¿ç¨‹æ˜¯å¦å·²ç»å¼€å§‹åŠ å…¥</span>

        <span class="k">if</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="c1">//ææ„å‡½æ•°ä¸­ä½¿å¾—çº¿ç¨‹è¢«åŠ å…¥åˆ°åŸå§‹çº¿ç¨‹ä¸­</span>

            <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>

        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/* ç¦æ­¢ä½¿ç”¨é»˜è®¤çš„æ‹·è´æ„é€ å‡½æ•° */</span>
    <span class="n">thread_guard</span><span class="p">(</span><span class="n">thread_guard</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="cm">/* ç¦æ­¢ä½¿ç”¨èµ‹å€¼å‡½æ•° */</span>
    <span class="n">thread_guard</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">thread_guard</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">func</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">f</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">some_local_state</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">func</span> <span class="n">my_func</span><span class="p">(</span><span class="n">some_local_state</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">my_function</span><span class="p">);</span>
    <span class="n">thread_guard</span> <span class="n">g</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">thread_guard</span> <span class="n">g</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">do_something_in_current_thread</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//å‡½æ•°ç»“æŸï¼Œå±€éƒ¨å¯¹è±¡å¼€å§‹é€†åºé”€æ¯ï¼Œ</span>

</code></pre></div></div>
<h5 id="214-åå°è¿è¡Œçº¿ç¨‹">2.1.4 åå°è¿è¡Œçº¿ç¨‹</h5>

<p>ä½¿ç”¨<code class="language-plaintext highlighter-rouge">detach()</code>ä¼šè®©çº¿ç¨‹åœ¨åå°è¿è¡Œã€‚æ„å‘³ç€ä¸»çº¿ç¨‹ä¸èƒ½ä¸è¯¥çº¿ç¨‹äº§ç”Ÿç›´æ¥äº’äº¤ã€‚ä½¿å¾—çº¿ç¨‹å®ç°åˆ†ç¦»ï¼Œå¹¶ä¸”ç”±C++ç¼–è¯‘å™¨å®ç°èµ„æºçš„å›æ”¶ã€‚</p>

<p>é€šå¸¸ç§°åˆ†ç¦»çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹(daemon threads);UNIXä¸­å®ˆæŠ¤çº¿ç¨‹æ˜¯æŒ‡,æ²¡æœ‰ä»»ä½•æ˜¾å¼çš„ç”¨æˆ·æ¥
å£,å¹¶åœ¨åå°è¿è¡Œçš„çº¿ç¨‹ã€‚è¿™ç§çº¿ç¨‹çš„ç‰¹ç‚¹å°±æ˜¯é•¿æ—¶é—´è¿è¡Œ;çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå¯èƒ½ä¼šä»æŸä¸€ä¸ªåº”ç”¨èµ·å§‹åˆ°ç»“æŸ,å¯èƒ½ä¼šåœ¨åå°ç›‘è§†æ–‡ä»¶ç³»ç»Ÿ,è¿˜æœ‰å¯èƒ½å¯¹ç¼“å­˜è¿›è¡Œæ¸…ç†,äº¦æˆ–å¯¹æ•°æ®ç»“æ„è¿›è¡Œä¼˜åŒ–ã€‚å¦ä¸€æ–¹é¢,åˆ†ç¦»çº¿ç¨‹çš„å¦ä¸€æ–¹é¢åªèƒ½ç¡®å®šçº¿ç¨‹ä»€ä¹ˆæ—¶å€™ç»“æŸ,å‘åå³å¿˜(fire and forget)çš„ä»»åŠ¡å°±ä½¿ç”¨åˆ°çº¿ç¨‹çš„è¿™ç§æ–¹å¼ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">t</span><span class="p">(</span><span class="n">do_background_work</span><span class="p">);</span>
<span class="n">t</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">());</span>

<span class="c1">//çº¿ç¨‹åˆ†ç¦»ä¹‹åä¸ä¹‹å‰çš„ä¸»çº¿ç¨‹æ— å…³</span>

<span class="c1">//å¤šçº¿ç¨‹å¤„ç†æ–‡æ¡£çš„ç¤ºä¾‹ï¼š</span>

<span class="kt">void</span> <span class="nf">edit_document</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span>   <span class="k">const</span><span class="o">&amp;</span>  <span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">open_document_and_display_gui</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">done_editing</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">user_command</span>  <span class="n">cmd</span><span class="o">=</span><span class="n">get_user_input</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">type</span><span class="o">==</span><span class="n">open_new_document</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span>   <span class="n">new_name</span><span class="o">=</span><span class="n">get_filename_from_user</span><span class="p">();</span>
            <span class="c1">//å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹å¼€å§‹æ˜¾ç¤ºå’Œå¤„ç†æ–‡æ¡£</span>

            <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">edit_document</span><span class="p">,</span><span class="n">new_name</span><span class="p">);</span>
            <span class="c1">//åˆ†ç¦»çº¿ç¨‹</span>

            <span class="n">t</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">process_user_input</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h4 id="22-å‘çº¿ç¨‹å‡½æ•°ä¼ é€’å‚æ•°">2.2 å‘çº¿ç¨‹å‡½æ•°ä¼ é€’å‚æ•°</h4>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em> <a href="https://blog.csdn.net/lvdan1/article/details/54098559">C++11çš„6ç§å†…å­˜åºæ€»ç»“</a>;</p>

<p>çº¿ç¨‹è°ƒç”¨çš„é»˜è®¤å‚æ•°è¦æ‹·è´åˆ°çº¿ç¨‹ç‹¬ç«‹å†…å­˜ä¸­ï¼Œå‡ åå‚æ•°æ˜¯å¼•ç”¨çš„å½¢å¼ï¼Œä¹Ÿå¯ä»¥åœ¨æ–°çº¿ç¨‹ä¸­è¿›è¡Œè®¿é—®ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">t</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s">"hello"</span><span class="p">);</span>
</code></pre></div></div>

<p>æ³¨æ„ï¼š <strong>æŒ‡å‘åŠ¨æ€å˜é‡çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’ç»™çº¿ç¨‹çš„æƒ…å†µï¼Œå¯èƒ½åœ¨ä¼ é€’è¿‡ç¨‹ä¸­äº§ç”Ÿæœªå®šä¹‰çš„è¡Œä¸ºã€‚ä½¿å¾—ç¨‹åºå´©æºƒ</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span>  <span class="n">s</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">oops</span><span class="p">(</span><span class="kt">int</span> <span class="n">some_param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//æŒ‡é’ˆå˜é‡</span>

    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="c1">//æŒ‡é’ˆå˜é‡æŒ‡å‘è¾“å…¥å‚æ•°</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">"%i"</span><span class="p">,</span><span class="n">some_param</span><span class="p">);</span>
    <span class="c1">//åˆ›å»ºçº¿ç¨‹ï¼Œè¾“å…¥æŒ‡é’ˆå‡½æ•°</span>

    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">buffer</span><span class="p">);</span>
    <span class="cm">/* çº¿ç¨‹æ‰§è¡Œä¸ä¸»çº¿ç¨‹åˆ†ç¦» */</span>
    <span class="n">t</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//åœ¨ä»char*åˆ°std::stringç±»å‹è½¬æ¢çš„è¿‡ç¨‹ä¸­ï¼Œå‡½æ•°å¾ˆæœ‰å¯èƒ½åœ¨è½¬åŒ–æˆåŠŸä¹‹å‰å´©æºƒï¼›ä½†æ˜¯`std::thread`çš„æ„é€ å‡½æ•°ä¼šå¤åˆ¶æä¾›çš„å˜é‡ï¼Œå°±åªå¤åˆ¶äº†æ²¡æœ‰è½¬æ¢æˆæœŸæœ›ç±»å‹çš„å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œæœ€ç»ˆé€ æˆç¨‹åºå´©æºƒã€‚</span>

<span class="c1">//åªè¦èƒ½åœ¨æ„é€ å‡½æ•°ä¹‹å‰å°†å­—é¢å€¼è½¬æ¢ä¸º`string`å¯¹è±¡å°±å¯ä»¥äº†ã€‚</span>

<span class="kt">void</span> <span class="nf">f</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">not_oops</span><span class="p">(</span><span class="kt">int</span> <span class="n">some_param</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">"%i"</span><span class="p">,</span><span class="n">some_param</span><span class="p">);</span>
    <span class="c1">//ä½¿ç”¨æ˜¾ç¤ºè½¬æ¢é¿å…æŒ‡é’ˆæ‚¬å‚</span>

    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
    <span class="n">t</span><span class="p">.</span><span class="n">detach</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div></div>

<p>æ³¨æ„ï¼š</p>
<ul>
  <li>å½“æƒ³è¦åœ¨çº¿ç¨‹æ„é€ å‡½æ•°ä¸­ä¼ é€’å‚æ•°ä¸ºå¼•ç”¨å‚æ•°ï¼Œä½¿å¾—å˜é‡åœ¨çº¿ç¨‹ä¸­è¿›è¡Œæ›´æ”¹çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::ref</code>å°†å‚æ•°è½¬æ¢æˆä¸ºå¼•ç”¨çš„å½¢å¼ï¼Œé¿å…å…¶åœ¨æ„é€ çš„è¿‡ç¨‹ä¸­ä½¿ç”¨é»˜è®¤æ‹·è´ã€‚å¦‚<code class="language-plaintext highlighter-rouge">std::thread t(update_data_for_widget,w,std::ref(data));</code>;è¿™æ ·dataå°±åœ¨çº¿ç¨‹å‰åå‘ç”Ÿäº†æ”¹å˜ã€‚</li>
  <li>å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::move</code>å°†ä¸€ä¸ªå‚æ•°ï¼Œç§»åŠ¨åˆ°çº¿ç¨‹ä¸­å»ã€‚</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è¾“å¦‚å‚æ•°æ˜¯ä¸€ä¸ªåªå…è®¸ä¸€ä¸ªä½¿ç”¨çš„æŒ‡é’ˆ</span>

<span class="kt">void</span> <span class="nf">process_big_object</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">big_object</span><span class="o">&gt;</span><span class="p">);</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">big_object</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="n">big_object</span><span class="p">);</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">prepare_data</span><span class="p">(</span><span class="mi">42</span><span class="p">);</span>
<span class="c1">//ä½¿ç”¨moveå‡½æ•°ï¼Œè¿›è¡Œç§»åŠ¨è¯­ä¹‰ï¼Œå³å€¼å¼•ç”¨ï¼›å°†æŒ‡é’ˆçš„æ‰€æœ‰æƒï¼Œäº¤ç»™çº¿ç¨‹å†…éƒ¨çš„å‡½æ•°åº“</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">t</span><span class="p">(</span><span class="n">process_big_object</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>

</code></pre></div></div>

<h4 id="23-è½¬ç§»çº¿ç¨‹æ‰€æœ‰æƒ">2.3 è½¬ç§»çº¿ç¨‹æ‰€æœ‰æƒ</h4>
<p>ä¸ºäº†ä¿è¯çº¿ç¨‹æ§åˆ¶å¥æŸ„çš„æœ‰æ•ˆæ€§ï¼Œ<code class="language-plaintext highlighter-rouge">std::thread</code>æ”¯æŒä½¿ç”¨<code class="language-plaintext highlighter-rouge">std:move()</code>å‡½æ•°å®ç°å‡½æ•°çš„è½¬ç§»ï¼Œ<strong>ä½†æ˜¯çº¿ç¨‹çš„æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œç¬¦å†³å®šäº†ï¼Œå®ƒåœ¨è¿›è¡Œå¤åˆ¶æ—¶ä¼šå…ˆä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::terminate()</code>å¼ºåˆ¶ç»“æŸåŸæ¥å·²æœ‰çš„çº¿ç¨‹ï¼Œå†æ¥å—æ–°å¥æŸ„ï¼›å³è¯´æ˜ï¼šä¸èƒ½é€šè¿‡èµ‹ä¸€ä¸ªæ–°å€¼ç»™std::thread å¯¹è±¡çš„æ–¹å¼æ¥â€œä¸¢å¼ƒâ€ä¸€ä¸ªçº¿ç¨‹</strong>ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">some_function</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">some_other_function</span><span class="p">();</span>
<span class="c1">//ç›´æ¥æ„é€ çº¿ç¨‹å¯¹è±¡</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="nf">t1</span><span class="p">(</span><span class="n">some_function</span><span class="p">);</span> 
<span class="c1">//ç§»åŠ¨çº¿ç¨‹å¥æŸ„åˆ°t2ï¼Œä¹‹åt1æ— ç”¨</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºæ‹·è´çš„æ—¶å€™ï¼Œé»˜è®¤éšå¼è°ƒç”¨std::move()å‡½æ•°</span>

<span class="n">t1</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">some_other_function</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºçº¿ç¨‹å¯¹è±¡</span>

<span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t3</span><span class="p">;</span>
<span class="c1">//t2çº¿ç¨‹å¥æŸ„ï¼Œäº¤ç»™t3 </span>

<span class="n">t3</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">t2</span><span class="p">);</span>
<span class="c1">//t1æ‰§è¡Œstd::terminate()ç»ˆæ­¢ç¨‹åºç»§ç»­è¿è¡Œï¼Œä¿è¯ä¸std::threadçš„ææ„å‡½æ•°è¡Œä¸ºä¸€è‡´ï¼Œéœ€è¦åœ¨</span>

<span class="n">t1</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">t3</span><span class="p">);</span>

</code></pre></div></div>
<p>å»ºè®®çš„çº¿ç¨‹æ‹·è´ä½¿ç”¨å¦‚ä¸‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">scoped_thread</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="c1">//ç›´æ¥è·å–çº¿ç¨‹çš„å¥æŸ„å‡½æ•°</span>

    <span class="k">explicit</span> <span class="n">scoped_thread</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t_</span><span class="p">)</span><span class="o">:</span>
                <span class="n">t</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">t_</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">//çº¿ç¨‹ä»¥åŠç»“æŸè¿‡ä¸€æ¬¡å°±è¿”å›å¤±è´¥</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">.</span><span class="n">joinable</span><span class="p">())</span>
            <span class="k">throw</span>   <span class="n">std</span><span class="o">::</span><span class="n">logic_error</span><span class="p">(</span><span class="err">â€œ</span><span class="n">No</span> <span class="kr">thread</span><span class="err">â€</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//ææ„å‡½æ•°ç»“æŸçº¿ç¨‹</span>

    <span class="o">~</span><span class="n">scoped_thread</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">t</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="c1">//æ‹·è´æ„é€ å‡½æ•°</span>
    
    <span class="n">scoped_thread</span><span class="p">(</span><span class="n">scoped_thread</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="c1">//èµ‹å€¼æ“ä½œç¬¦</span>

    <span class="n">scoped_thread</span><span class="o">&amp;</span>  <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">scoped_thread</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">struct</span>  <span class="nc">func</span><span class="p">;</span>   <span class="c1">//  å®šä¹‰åœ¨æ¸…å•2.1ä¸­</span>
<span class="kt">void</span> <span class="nf">f</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">some_local_state</span><span class="p">;</span>
    <span class="c1">//æ¡ç”¨æ‹·è´æ„é€ å‡½æ•°</span>

    <span class="n">scoped_thread</span>   <span class="n">t</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">some_local_state</span><span class="p">)));</span>
    <span class="c1">//æ‰§è¡Œç¨‹åº</span>

    <span class="n">do_something_in_current_thread</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">do_work</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">id</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">f1</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">20</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//äº§ç”Ÿçº¿ç¨‹</span>

            <span class="n">threads</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="n">do_work</span><span class="p">,</span><span class="n">i</span><span class="p">));</span>  
        <span class="p">}</span>
        <span class="c1">//å¯¹æ¯ä¸ªçº¿ç¨‹è°ƒç”¨join()ï¼›æ³¨æ„è¿™é‡Œçš„mem_fnç›´æ¥è·å–å¯¹è±¡çš„å‡½æ•°æŒ‡é’ˆ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">threads</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">threads</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">std</span><span class="o">::</span><span class="n">mem_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">join</span><span class="p">));</span>  
<span class="p">}</span>

</code></pre></div></div>

<h3 id="24-è¿è¡Œæ—¶å†³å®šçº¿ç¨‹æ•°é‡">2.4 è¿è¡Œæ—¶å†³å®šçº¿ç¨‹æ•°é‡</h3>

<p><code class="language-plaintext highlighter-rouge">std::accumulate</code>å¯ä»¥ç”¨æ¥è®¡ç®—å®¹å™¨ä¸­å…ƒç´ çš„å’Œï¼Œæ€»ä½“æ€è·¯æ˜¯åˆ©ç”¨<code class="language-plaintext highlighter-rouge">std::thread::hardware_concurrency()</code>è¿”å›å¹¶å‘åœ¨ä¸€ä¸ªç¨‹åºä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œç”±æ­¤æ¥å†³å®šæœ€ç»ˆçš„çº¿ç¨‹æ•°ç›®ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="c1">//å®šä¹‰å°å—è®¡ç®—çš„ç±»</span>

<span class="k">struct</span> <span class="nc">accumulate_block</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Iterator</span> <span class="n">frist</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ä½¿ç”¨è®¡ç®—ç»“æœ</span>

        <span class="n">result</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="c1">//å®šä¹‰å¹¶è¡Œè®¡ç®—çš„æ¨¡æ¿å‡½æ•°</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Iterator</span><span class="p">,</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>

<span class="n">T</span> <span class="nf">parallel_accumulate</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Iterator</span> <span class="n">last</span><span class="p">,</span><span class="n">T</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è®¡ç®—å…ƒç´ çš„æ€»æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">length</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">distance</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="c1">//é•¿åº¦ä¸º0ç›´æ¥è¿”å›åˆå§‹å€¼</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">length</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">init</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//æœ€å°çº¿ç¨‹æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">min_per_thread</span><span class="o">=</span><span class="mi">25</span><span class="p">;</span>
    <span class="c1">//æœ€å¤§çº¿ç¨‹æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">max_threads</span><span class="o">=</span><span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="n">min_per_thread</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">min_per_thread</span><span class="p">;</span>
    <span class="c1">//è®¡ç®—æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">hardware_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
    <span class="c1">//è®¡ç®—çœŸæ­£çš„çº¿ç¨‹æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">num_threads</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">hardware_threads</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span><span class="n">hardware_threads</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="n">max_threads</span><span class="p">);</span>
    <span class="c1">//è®¡ç®—åˆ†å—è¿è¡Œçš„æ•°é‡</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">block_size</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">num_threads</span><span class="p">;</span>
    <span class="c1">//å‡†å¤‡ç»“æœæ•°æ®</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">results</span><span class="p">(</span><span class="n">num_threads</span><span class="p">);</span>
    <span class="c1">//å‡†å¤‡çº¿ç¨‹</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span> <span class="n">threads</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="c1">//éå†åˆå§‹åŒ–æ•°æ®</span>
    <span class="n">Iterator</span> <span class="n">block_start</span><span class="o">=</span><span class="n">frist</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ä¸´æ—¶åˆ†å—çš„ç»ˆç‚¹</span>

        <span class="n">Iterator</span> <span class="n">block_end</span><span class="o">=</span><span class="n">block_start</span><span class="p">;</span>
        <span class="c1">//ç§»åŠ¨è¿­ä»£å™¨å°†å…¶æŒ‡å‘æœ«å°¾</span>

        <span class="n">std</span><span class="o">::</span><span class="n">advance</span><span class="p">(</span><span class="n">block_end</span><span class="p">,</span><span class="n">block_size</span><span class="p">);</span>
        <span class="c1">//åˆå§‹åŒ–çº¿ç¨‹</span>

        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span>
            <span class="n">accumulate_block</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(),</span>
            <span class="n">block_start</span><span class="p">,</span>
            <span class="n">block_end</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">ref</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="p">);</span>
        <span class="c1">//æ›´æ–°è¿­ä»£å™¨ä½ç½®</span>

        <span class="n">block_start</span><span class="o">=</span><span class="n">block_end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//å°†å‰©ä½™çš„æ•°å…¨éƒ¨åˆ†åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹å—</span>

    <span class="n">accumulate_block</span><span class="o">&lt;</span><span class="n">Iterator</span><span class="p">,</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()(</span>
        <span class="n">block_start</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">results</span><span class="p">[</span><span class="n">num_threads</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">);</span>
    <span class="c1">//ç­‰å¾…åˆ›å»ºçº¿ç¨‹çš„å®Œæˆ</span>
    
    <span class="n">std</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">threads</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
        <span class="n">threads</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
        <span class="n">std</span><span class="o">::</span><span class="n">mem_fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">join</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="c1">//è®¡ç®—æ±‚å’Œ</span>

    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">results</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">results</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">init</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//æ³¨æ„ï¼šè¿™é‡Œçš„è¿­ä»£å™¨éƒ½å¿…é¡»æ˜¯å‰å‘è¿­ä»£å™¨ï¼Œå¹¶ä¸”å¿…é¡»ä¿è¯Tå­˜åœ¨é»˜è®¤çš„æ„é€ å‡½æ•°</span>

</code></pre></div></div>

<h3 id="25-è¯†åˆ«çº¿ç¨‹">2.5 è¯†åˆ«çº¿ç¨‹</h3>

<p>çº¿ç¨‹æ ‡ç¤ºç±»å‹æ˜¯<code class="language-plaintext highlighter-rouge">std::thread::id</code>ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è¿›è¡Œæ£€ç´¢ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">std::thread::get_id()</code>å‡½æ•°ç›´æ¥æ¥è·å–ã€‚å½“æ²¡æœ‰ç»‘å®šçº¿ç¨‹æ—¶ï¼Œå‡½æ•°è¿”å›<code class="language-plaintext highlighter-rouge">std::thread::type</code></li>
  <li>åœ¨å½“å‰çº¿ç¨‹ä¸­è°ƒç”¨<code class="language-plaintext highlighter-rouge">std::this_thread::get_id()</code>è·å–å½“å‰çš„çº¿ç¨‹æ ‡è¯†ç¬¦</li>
</ul>

<h2 id="ç¬¬3ç« -çº¿ç¨‹é—´å…±äº«æ•°æ®">ç¬¬3ç«  çº¿ç¨‹é—´å…±äº«æ•°æ®</h2>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em> <a href="https://blog.csdn.net/qq_37303711/article/details/78576671">C++å¹¶å‘ç¼–ç¨‹å­¦ä¹ â€”â€”3.åœ¨çº¿ç¨‹é—´å…±äº«æ•°æ®</a>;<a href="https://www.jianshu.com/p/c342d65c951c">çº¿ç¨‹é—´å…±äº«æ•°æ®</a>;</p>

<h3 id="31-å…±äº«æ•°æ®å¸¦æ¥çš„é—®é¢˜">3.1 å…±äº«æ•°æ®å¸¦æ¥çš„é—®é¢˜</h3>

<p>å¯¹äºåªè¯»çš„æ•°æ®æ˜¯ä¸å­˜åœ¨æ“ä½œä¹‹é—´çš„å…±äº«æ•°æ®é—®é¢˜çš„ï¼Œä½†æ˜¯å¯¹äºè¯»å†™æ“ä½œæˆ–è€…åˆ é™¤æ“ä½œï¼Œéœ€è¦æ·»åŠ è€Œé”å®ç°ï¼Œæ•°æ®çš„äº’æ–¥å’Œå…±äº«ã€‚æ³¨æ„ä½¿ç”¨æ¡ä»¶ç«äº‰æ“ä½œï¼Œé¿å…æ¶æ€§æ¡ä»¶ç«äº‰ã€‚</p>

<p>é¿å…æ€è·¯ï¼š</p>

<ul>
  <li>å¯¹æ•°æ®ç»“æ„é‡‡å–æŸç§ä¿æŠ¤æœºåˆ¶ï¼Œç¡®ä¿åªæœ‰è¿›è¡Œä¿®æ”¹çš„çº¿ç¨‹æ‰èƒ½çœ‹åˆ°ä¸å˜é‡è¢«ç ´åæ—¶çš„ä¸­é—´çŠ¶æ€ã€‚</li>
  <li>å¯¹æ•°æ®ç»“æ„å’Œä¸å˜é‡çš„è®¾è®¡è¿›è¡Œä¿®æ”¹ï¼Œä¿®æ”¹å®Œæˆçš„ç»“æ„å¿…é¡»èƒ½å®Œæˆä¸€ç³»åˆ—ä¸å¯åˆ†å‰²çš„å˜åŒ–ã€‚å³ <strong>æ— é”ç¼–ç¨‹</strong>ã€‚</li>
  <li>,ä½¿ç”¨äº‹åŠ¡çš„æ–¹å¼å»å¤„ç†æ•°æ®ç»“æ„çš„æ›´æ–°(è¿™é‡Œçš„â€å¤„ç†â€å°±å¦‚åŒå¯¹æ•°æ®åº“è¿›è¡Œæ›´æ–°ä¸€æ ·)ã€‚æ‰€éœ€çš„ä¸€äº›æ•°æ®å’Œè¯»å–éƒ½å­˜å‚¨åœ¨äº‹åŠ¡æ—¥å¿—ä¸­,ç„¶åå°†ä¹‹å‰çš„æ“ä½œåˆä¸ºä¸€æ­¥,å†è¿›è¡Œæäº¤ã€‚åœ¨è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹åï¼Œæäº¤å°±æ— æ³•è¿›è¡Œã€‚è¿™æˆä¸ºâ€œè½¯ä»¶äº‹åŠ¡å†…å­˜â€ã€‚ä½†æ˜¯C+++ä¸­æ²¡æœ‰å¯¹<code class="language-plaintext highlighter-rouge">STM</code>è¿›è¡Œæ”¯æŒã€‚</li>
</ul>

<p>C++ä¸­ä¿æŠ¤å…±äº«æ•°æ®çš„æœ€åŸºæœ¬æ–¹å¼æ˜¯ä½¿ç”¨ C++æ ‡å‡†åº“æä¾›çš„äº’æ–¥é‡</p>

<h3 id="32-ä½¿ç”¨äº’æ–¥ä¸¤ä¿æŠ¤å…±äº«æ•°æ®">3.2 ä½¿ç”¨äº’æ–¥ä¸¤ä¿æŠ¤å…±äº«æ•°æ®</h3>

<h4 id="321-cä¸­ä½¿ç”¨äº’æ–¥é‡">3.2.1 C++ä¸­ä½¿ç”¨äº’æ–¥é‡</h4>

<p>c++ä¸­é€šè¿‡ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::mutex</code>åˆ›å»ºäº’æ–¥é‡ï¼Œé€šè¿‡è°ƒç”¨æˆå‘˜å‡½æ•°<code class="language-plaintext highlighter-rouge">lock()/unlock()</code>è¿›è¡Œä¸Šé”/è§£é”ã€‚åŒæ—¶å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::lock_guard()</code>ï¼Œåœ¨æ„é€ çš„æ—¶å€™æä¾›å·²é”çš„äº’æ–¥ï¼Œå¹¶åœ¨ææ„çš„æ—¶å€™è¿›è¡Œè§£é”ï¼Œä»è€Œä¿è¯æ€»æ˜¯ä¼šè¢«æ­£ç¡®çš„è§£é”ã€‚
ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;list&gt;
</span>
<span class="cp">#include &lt;mutex&gt;
</span>
<span class="cp">#include &lt;algorithm&gt;
</span>
<span class="c1">//åˆ›å»ºå…¨å±€çš„äº’æ–¥ä¿æŠ¤å˜é‡</span>

<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">some_list</span><span class="p">;</span>  
<span class="c1">//äº’æ–¥ä¿¡å·å˜é‡</span>

<span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">some_mutex</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">add_to_list</span><span class="p">(</span><span class="kt">int</span> <span class="n">new_value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//ä½¿ç”¨std::lock_guardäº’æ–¥è®¿é—®æ•°æ®</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">some_mutex</span><span class="p">);</span>
    <span class="c1">//æ·»åŠ æ•°æ®</span>

    <span class="n">some_param</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">new_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">list_contains</span><span class="p">(</span><span class="kt">int</span> <span class="n">value_to_find</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//äº’æ–¥è®¿é—®æ•°æ®ï¼Œä¸ºä¿¡å·å˜é‡åŠ é”</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">guard</span><span class="p">(</span><span class="n">some_mutex</span><span class="p">);</span>
    <span class="c1">//æŸ¥æ‰¾å¯¹åº”çš„å˜é‡</span>

    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">find</span><span class="p">(</span><span class="n">some_list</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="n">some_list</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">value_to_find</span><span class="p">)</span><span class="o">!=</span><span class="n">some_list</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œäº’æ–¥å˜é‡ä¼šç›´æ¥å®šä¹‰åœ¨åŒä¸€ä¸ªç±»ä¸­ï¼Œè€Œä¸æ˜¯å®šä¹‰æˆå…¨å±€å˜é‡ã€‚äº’æ–¥é‡ å’Œè¦ä¿æŠ¤çš„æ•°æ®éƒ½å¿…é¡»å®šä¹‰ä¸ºpriavteæˆå‘˜ã€‚</span>

<span class="c1">//æ³¨æ„ï¼šå‡½æ•°è¿”å›çš„æ˜¯è¢«ä¿æŠ¤æ•°æ®æˆ–è€…æˆå‘˜çš„æŒ‡é’ˆæ—¶</span>


</code></pre></div></div>

<h4 id="322-ç²¾å¿ƒç»„ç»‡ä»£ç æ¥ä¿æŠ¤å…±äº«æ•°æ®">3.2.2 ç²¾å¿ƒç»„ç»‡ä»£ç æ¥ä¿æŠ¤å…±äº«æ•°æ®</h4>
<p>é’ˆå¯¹è¿”å›æŒ‡é’ˆæˆ–è€…å¼•ç”¨ä¼šä½¿å¾—æˆå‘˜å˜é‡å¤±å»ä¿æŠ¤ã€‚è¿™æ ·äº’æ–¥å˜é‡å½¢åŒè™šè®¾ã€‚ä½†æ˜¯è¿™äº›åªè¦ä½ ç¡®ä¿æ²¡æœ‰åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æ˜¾å¼è°ƒç”¨å°±æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯æ›´å±é™©çš„æ˜¯ <strong>å°†ä¸€ä¸ªä¿æŠ¤æ•°æ®ä½œä¸ºè¿è¡Œæ—¶å‚æ•°</strong> ä¾‹å¦‚ä¸‹é¢ï¼Œæ— æ„ä¸­ä½¿ç”¨äº†ä¿æŠ¤æ•°æ®çš„å¼•ç”¨</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">some_data</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">b</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">do_something</span><span class="p">();</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">data_warpper</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="n">some_data</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Function</span><span class="p">&gt;</span>
    <span class="kt">void</span> <span class="n">process_data</span><span class="p">(</span><span class="n">Function</span> <span class="n">func</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="mi">1</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="c1">//åœ¨è¿™é‡Œä¼ é€’ä¿æŠ¤æ•°æ®ç»™ç”¨æˆ·å‡½æ•°</span>

        <span class="n">func</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//éä¿æŠ¤æ•°æ®</span>

<span class="n">some_data</span><span class="o">*</span> <span class="n">unprotected</span><span class="p">;</span>
<span class="c1">//æ¶æ„æ‹·è´æ•°æ®</span>

<span class="kt">void</span> <span class="nf">malicious_function</span><span class="p">(</span><span class="n">some_data</span><span class="o">&amp;</span> <span class="n">protected_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">unprotected</span><span class="o">=&amp;</span><span class="n">protected_data</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//æ•°æ®æŒ‡é’ˆ</span>

<span class="n">data_wrapper</span> <span class="n">x</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//ä¼ é€’ä¸€ä¸ªæ¶æ„å€¼ï¼Œå°†ç±»ä¸­çš„ä¿æŠ¤æˆå‘˜èµ‹å€¼ç»™å¤–éƒ¨çš„éä¿æŠ¤å˜é‡</span>

    <span class="n">x</span><span class="p">.</span><span class="n">process_data</span><span class="p">(</span><span class="n">malicious_function</span><span class="p">);</span>
    <span class="c1">//æ‰§è¡Œæ“ä½œï¼Œæ›´æ”¹ å†…éƒ¨çš„dataå€¼</span>

    <span class="n">nprotected</span><span class="o">-&gt;</span><span class="n">do_something</span><span class="p">();</span>
<span class="p">}</span>



</code></pre></div></div>
<h4 id="323-å‘ç°æ¥å£å†…åœ¨çš„æ¡ä»¶ç«äº‰">3.2.3 å‘ç°æ¥å£å†…åœ¨çš„æ¡ä»¶ç«äº‰</h4>

<p>é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œæ¯”è¾ƒå¥½çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†æ–¹æ³•å’Œæ¥å£å°è£…å¥½ï¼Œé¿å…åœ¨å¤–éƒ¨è°ƒç”¨ä½¿å¾—æ–¹æ³•æ“ä½œçš„å®‰å…¨æ€§ã€‚ä¾‹å¦‚ä¸‹é¢ä¸€ä¸ªstackçš„å®ç°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®šä¹‰æ¨¡æ¿ç±»å’Œæ–¹æ³•</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">T</span><span class="p">,</span><span class="k">typename</span>  <span class="nc">Container</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="o">&gt;</span>
<span class="k">class</span>   <span class="nc">stack</span>
<span class="p">{</span>
<span class="nl">public:</span>
        <span class="k">explicit</span>    <span class="n">stack</span><span class="p">(</span><span class="k">const</span> <span class="n">Container</span><span class="o">&amp;</span><span class="p">);</span>
        <span class="k">explicit</span>    <span class="n">stack</span><span class="p">(</span><span class="n">Container</span><span class="o">&amp;&amp;</span>   <span class="o">=</span>   <span class="n">Container</span><span class="p">());</span>
        <span class="k">template</span>    <span class="o">&lt;</span><span class="k">class</span>  <span class="nc">Alloc</span><span class="p">&gt;</span>  <span class="k">explicit</span>    <span class="n">stack</span><span class="p">(</span><span class="k">const</span> <span class="n">Alloc</span><span class="o">&amp;</span><span class="p">);</span>
        <span class="k">template</span>    <span class="o">&lt;</span><span class="k">class</span>  <span class="nc">Alloc</span><span class="p">&gt;</span>  <span class="n">stack</span><span class="p">(</span><span class="k">const</span> <span class="n">Container</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span>   <span class="n">Alloc</span><span class="o">&amp;</span><span class="p">);</span>
        <span class="k">template</span>    <span class="o">&lt;</span><span class="k">class</span>  <span class="nc">Alloc</span><span class="p">&gt;</span>  <span class="n">stack</span><span class="p">(</span><span class="n">Container</span><span class="o">&amp;&amp;</span><span class="p">,</span>  <span class="k">const</span>   <span class="n">Alloc</span><span class="o">&amp;</span><span class="p">);</span>
        <span class="k">template</span>    <span class="o">&lt;</span><span class="k">class</span>  <span class="nc">Alloc</span><span class="p">&gt;</span>  <span class="n">stack</span><span class="p">(</span><span class="n">stack</span><span class="o">&amp;&amp;</span><span class="p">,</span>  <span class="k">const</span>   <span class="n">Alloc</span><span class="o">&amp;</span><span class="p">);</span>
        <span class="kt">bool</span>    <span class="n">empty</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
        <span class="kt">size_t</span>  <span class="n">size</span><span class="p">()</span>  <span class="k">const</span><span class="p">;</span>
        <span class="n">T</span><span class="o">&amp;</span>  <span class="n">top</span><span class="p">();</span>
        <span class="n">T</span>   <span class="k">const</span><span class="o">&amp;</span>  <span class="n">top</span><span class="p">()</span>   <span class="k">const</span><span class="p">;</span>
        <span class="kt">void</span>    <span class="n">push</span><span class="p">(</span><span class="n">T</span>  <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>
        <span class="kt">void</span>    <span class="n">push</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span><span class="p">);</span>
        <span class="kt">void</span>    <span class="n">pop</span><span class="p">();</span>
        <span class="kt">void</span>    <span class="n">swap</span><span class="p">(</span><span class="n">stack</span><span class="o">&amp;&amp;</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>
<p>ä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹æ—¶çš„empty()å’Œsize()å‡½æ•°çš„æ“ä½œï¼Œéœ€è¦è¿›è¡Œå˜é‡çš„äº’æ–¥ä¿æŠ¤;ä¿æŠ¤çš„ä¸»è¦æ€æƒ³æ˜¯é€šè¿‡çº¿ç¨‹é”ï¼Œä½¿å¾—ä¸¤ä¸ªçº¿ç¨‹çš„å­˜å–æ“ä½œå…·æœ‰åŸå­äº‹ç‰©æ€§ï¼Œæ“ä½œçš„é¡ºåºå…ˆåå›ºå®šã€‚ä¸‹é¢æ˜¯ä¸€ç§å¯èƒ½çš„é¡ºåº</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Thread A</th>
      <th style="text-align: left">Thread B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">if (!s.empty);|</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: left">|</td>
      <td style="text-align: left">if(!s.empty);</td>
    </tr>
    <tr>
      <td style="text-align: left">int const value=s.top();|</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: left">|</td>
      <td style="text-align: left">int const value=s.top();</td>
    </tr>
    <tr>
      <td style="text-align: left">s.pop()|</td>
      <td style="text-align: left">Â </td>
    </tr>
    <tr>
      <td style="text-align: left">do_something(value);</td>
      <td style="text-align: left">s.pop()</td>
    </tr>
    <tr>
      <td style="text-align: left">|</td>
      <td style="text-align: left">do_something(value);</td>
    </tr>
  </tbody>
</table>

<p>æ ‡å‡†åº“çš„stackç±»ä½¿ç”¨å°†è¿™ä¸ªæ“ä½œåˆ†ä¸ºäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼š 1. è·å–é¡¶éƒ¨å…ƒç´ (top());2.ä»æ ˆä¸­ç§»é™¤(pop())ã€‚è¿™æ ·åœ¨ä¸å®‰å…¨çš„å°†å…ƒç´ æ‹·è´å‡ºå»çš„æƒ…å†µä¸‹ï¼Œæ ˆä¸­çš„è¿™ä¸ªæ•°æ®ä¾æ—§å­˜åœ¨ï¼Œæ²¡æœ‰ä¸¢å¤±ã€‚</p>

<p>ä¸‹é¢ä»‹ç»ä¸€äº›å…¶å®ƒçš„æ–¹æ³•ï¼š</p>

<ol>
  <li>ä¼ å…¥ä¸€ä¸ªå¼•ç”¨ï¼Œä½œä¸ºæƒ³è¦çš„å¼¹å‡ºå€¼æ¥è¿›è¡Œä½¿ç”¨ã€‚</li>
</ol>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">some_stack</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</code></pre></div></div>

<ol>
  <li>æ— å¼‚å¸¸æŠ›å‡ºçš„æ‹·è´æ„é€ å‡½æ•°æˆ–åˆ™ç§»åŠ¨æ„é€ å‡½æ•°</li>
  <li>
    <p>è¿”å›æŒ‡å‘å¼¹å‡ºå€¼çš„æŒ‡é’ˆ</p>

    <p>è¿™æ ·å¯ä»¥æ–¹ä¾¿è‡ªç”±æ‹·è´ï¼Œå¹¶ä¸”ä¸ä¼šäº§ç”Ÿå¼‚å¸¸ï¼Œç¼ºç‚¹æ˜¯è¿”å›ä¸€ä¸ªæŒ‡é’ˆéœ€è¦å¯¹å†…å­˜åˆ†é…è¿›è¡Œç®¡ç†ï¼Œå¯¹äºç®€å•æ•°æ®ç±»å‹ï¼Œå†…å­˜ç®¡ç†çš„å¼€é”€è¿œå¤§äºç›´æ¥è¿”å›å€¼ã€‚é€šå¸¸ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::shared_ptr</code>è¿›è¡Œæ“ä½œã€‚</p>
  </li>
  <li>â€œé€‰é¡¹1+é€‰é¡¹2â€æˆ–â€œé€‰é¡¹1+é€‰é¡¹3â€</li>
</ol>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å †æ ˆçš„å®šä¹‰</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;exception&gt;
</span>
<span class="cp">#include &lt;memory&gt;
</span>
<span class="cp">#include &lt;mutex&gt;
</span>
<span class="cp">#include &lt;stack&gt;
</span>
<span class="c1">// å®šä¹‰ç©ºæ ˆå‡½æ•°</span>

<span class="k">struct</span> <span class="nc">empty_stack</span><span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">exception</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">what</span><span class="p">()</span> <span class="k">const</span> <span class="k">throw</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s">"empty stack"</span><span class="p">;</span>
    <span class="p">};</span>
    
<span class="p">};</span>
<span class="c1">//å®šä¹‰æ¨¡æ¿ç±»</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">threadsafe_stack</span> <span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">//ä¿æŠ¤æˆå‘˜å˜é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">stack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
    <span class="c1">//äº’æ–¥ä¿¡å·é‡</span>

    <span class="k">mutable</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m</span><span class="p">;</span> 
<span class="nl">public:</span>
    <span class="n">threadsafe_stack</span><span class="p">()</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">satck</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">()){}</span>

    <span class="n">threadsafe_stack</span><span class="p">(</span><span class="k">const</span> <span class="n">threadsafe_stack</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
        <span class="c1">//åœ¨æ„é€ ä½“ä¸­æ‰§è¡Œæ‹·è´</span>

        <span class="n">data</span><span class="o">=</span><span class="n">other</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//ç¦ç”¨é»˜è®¤èµ‹å€¼</span>

    <span class="n">threadsafe_stack</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">threadsafe_stack</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="c1">//æ·»åŠ </span>

    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="n">data</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">new_value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="c1">//åœ¨è°ƒç”¨popå‰ï¼Œæ£€æŸ¥æ ˆæ˜¯å¦ä¸ºç©º</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">empty_stack</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">//åœ¨ä¿®æ”¹å †æ ˆä¹‹å‰ï¼Œåˆ†é…å‡ºè¿”å›å€¼</span>

        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">res</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">top</span><span class="p">()));</span>
        <span class="n">data</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="k">throw</span> <span class="n">empty_stack</span><span class="p">();</span>

        <span class="n">value</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="n">top</span><span class="p">();</span>
        <span class="n">data</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">empty</span><span class="p">()</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span>
    <span class="p">}</span>
    
<span class="p">};</span>

<span class="c1">//ä¸Šé¢çš„æ£€æŸ¥æ‹·è´æ“ä½œå…¨éƒ¨éƒ½åŠ ä¸Šäº†é”ï¼Œè™½ç„¶æ€§èƒ½æœ‰æ‰€æŸè€—ï¼Œä½†æ˜¯å®ç°äº†çº¿ç¨‹çº§å®‰å…¨ã€‚</span>

</code></pre></div></div>

<h4 id="324-æ­»é”é—®é¢˜æè¿°åŠè§£å†³æ–¹æ¡ˆ">3.2.4 æ­»é”ï¼šé—®é¢˜æè¿°åŠè§£å†³æ–¹æ¡ˆ</h4>

<p>é—®é¢˜æè¿°åœ¨æ“ä½œç³»ç»Ÿä¸­æœ‰ç€è¾ƒä¸ºè¯¦ç»†çš„å™è¿°ï¼Œå†æ¬¡ä¸åšè¿‡å¤šçš„è§£é‡Šã€‚</p>

<p>è§£å†³é—®é¢˜çš„ä¸»è¦æ€è·¯æ˜¯ï¼š</p>

<ul>
  <li>æ­»é”é¢„é˜²ï¼š
    <ul>
      <li>ç ´åäº’æ–¥æ¡ä»¶ï¼šèµ„æºäº’æ–¥ä½¿ç”¨ï¼Œæ— æ³•ç ´åäº’æ–¥æ¡ä»¶</li>
      <li>ç ´åä¸å‰¥å¤ºæ¡ä»¶ï¼šåæ¥è€…ï¼Œå¼ºåˆ¶æŠ¢å¤ºèµ„æºï¼Œä½†ä¼šå¢åŠ ç³»ç»Ÿå¼€é”€ï¼Œé™ä½ååé‡</li>
      <li>ç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼šä¸å†ä¸€ç›´è¯·æ±‚å’Œä¿æŒçŠ¶æ€ï¼›ä¼šä¸¥é‡æµªè´¹èµ„æºï¼Œè¿˜å¯èƒ½å¯¼è‡´é¥¥é¥¿ç°è±¡</li>
      <li>ç ´åå¾ªç¯æ¡ä»¶ï¼šä¼šæµªè´¹ç³»ç»Ÿèµ„æºï¼Œå¹¶é€ æˆç¼–ç¨‹ä¸ä¾¿</li>
    </ul>
  </li>
  <li>æ­»é”é¿å…ï¼š
    <ul>
      <li>å®‰å…¨çŠ¶æ€ï¼šæ‰¾åˆ°ä¸€ä¸ªåˆ†é…èµ„æºçš„åºåˆ—èƒ½è®©æ‰€æœ‰è¿›ç¨‹éƒ½é¡ºåˆ©å®Œæˆã€‚</li>
      <li>é“¶è¡Œå®¶ç®—æ³•ï¼šé‡‡ç”¨é¢„åˆ†é…ç­–ç•¥ç›‘å¯Ÿåˆ†é…å®Œæˆæ—¶ç³»ç»Ÿæ˜¯å¦å¤„åœ¨å®‰å…¨çŠ¶æ€ã€‚</li>
    </ul>
  </li>
  <li>æ­»é”æ£€æµ‹ï¼š åˆ©ç”¨æ­»é”å®šåŠ›ç®€åŒ–èµ„æºåˆ†é…å›¾ä»¥æ£€æµ‹æ­»é”çš„å­˜åœ¨ã€‚</li>
  <li>æ­»é”è§£é™¤ï¼š
    <ul>
      <li>èµ„æºå‰¥å¤ºæ³•ï¼šæŒ‚èµ·æŸäº›æ­»é”è¿›ç¨‹å¹¶æŠ¢å¤ºå®ƒçš„èµ„æºï¼Œä»¥ä¾¿è®©å…¶ä»–è¿›ç¨‹ç»§ç»­æ¨è¿›ã€‚</li>
      <li>æ’¤é”€è¿›ç¨‹æ³•ï¼šå¼ºåˆ¶æ’¤é”€éƒ¨åˆ†ã€ç”šè‡³å…¨éƒ¨æ­»é”è¿›ç¨‹å¹¶å‰¥å¤ºè¿™äº›è¿›ç¨‹çš„èµ„æºã€‚</li>
      <li>è¿›ç¨‹å›é€€æ³•ï¼šè®©è¿›ç¨‹å›é€€åˆ°è¶³ä»¥å›é¿æ­»é”çš„åœ°æ­¥ã€‚</li>
    </ul>
  </li>
</ul>

<p>å¯¹äºçº¿ç¨‹çš„å…·ä½“å®ç°æ€è·¯æ˜¯ï¼šè®©ä¸¤ä¸ªäº’æ–¥é‡ï¼Œæ€»æ˜¯ä»¥ç›¸åŒçš„é¡ºåºä¸Šé”ã€‚é¿å…å¤šçº¿ç¨‹å¯¹æ•°æ®çš„ä¿®æ”¹æ—¶çš„æ­»é”ã€‚c++æ ‡å‡†åº“ï¼Œæä¾›äº†<code class="language-plaintext highlighter-rouge">lock</code>æ–¹æ³•ï¼Œå¯ä»¥ä¸€æ¬¡é”ä½å¤šä¸ªäº’æ–¥é‡ï¼Œå¹¶æ²¡æœ‰æ­»é”é£é™©ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;mutex&gt;
</span>
<span class="k">class</span> <span class="nc">some_big_object</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="n">some_big_object</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span><span class="n">some_big_object</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">);</span>

<span class="k">class</span> <span class="nc">X</span> <span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">//ç›®æ ‡å¯¹è±¡</span>

    <span class="n">some_big_object</span> <span class="n">some_detail</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">X</span><span class="p">(</span><span class="n">some_big_object</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">sd</span><span class="p">)</span><span class="o">:</span><span class="n">some_detail</span><span class="p">(</span><span class="n">sd</span><span class="p">){};</span>
    <span class="k">friend</span> <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">X</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span><span class="n">X</span><span class="o">&amp;</span><span class="n">rhs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lhs</span><span class="o">==&amp;</span><span class="n">rhs</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="c1">//é”ä½ä¸¤ä¸ªäº’æ–¥å˜é‡</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">m</span><span class="p">,</span><span class="n">rhs</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
        <span class="c1">//è¡¨ç¤º    std::lock_guard å¯¹è±¡å¯è·å–é”ä¹‹å¤–,è¿˜å°†é”äº¤ç”±  std::lock_guard  å¯¹è±¡ç®¡ç†,è€Œä¸éœ€è¦std::lock_guard å¯¹è±¡å†å»æ„å»ºæ–°çš„é”ã€‚ä¿è¯é€€å‡ºæ—¶èƒ¡åƒä¸¤èƒ½è¢«æ­£ç¡®çš„è§£æã€‚</span>


        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock_a</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">m</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">adopt_lock</span><span class="p">);</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock_b</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">m</span><span class="p">,</span><span class="n">sth</span><span class="o">::</span><span class="n">adopt_lock</span><span class="p">);</span>

        <span class="n">swap</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">some_detail</span><span class="p">,</span><span class="n">rhs</span><span class="p">.</span><span class="n">some_detail</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>
<h4 id="325-é¿å…æ­»é”çš„è¿›é˜¶æŒ‡å¯¼">3.2.5 é¿å…æ­»é”çš„è¿›é˜¶æŒ‡å¯¼</h4>

<p>é¿å…ç›¸å…³çº¿ç¨‹å‘ç”Ÿæ­»é”çš„å»ºè®®ï¼š</p>

<ul>
  <li>é¿å…åµŒå¥—é”ï¼šå½“å‰çº¿ç¨‹å·²ç»å–å¾—é”æ—¶ï¼Œåœ¨æœªè§£é”å‰ï¼Œä¸è·å–æ–°é”ã€‚</li>
  <li>é¿å…åœ¨æŒæœ‰é”çš„æ—¶å€™è°ƒç”¨ç”¨æˆ·æä¾›çš„ä»£ç ï¼Œç”¨æˆ·è¡Œä¸ºå¾ˆå®¹æ˜“äº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚</li>
  <li>ä½¿ç”¨å›ºå®šé¡ºåºè·å–é”ï¼šå½“çº¿ç¨‹éœ€è¦å¤šä¸ªèµ„æºé…åˆå®Œæˆï¼Œè€Œä¸å¾—ä¸ä½¿ç”¨å¤šä¸ªé”æ—¶ï¼Œå°½é‡å°†é”æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œé¿å…æ­»é”ã€‚åœ¨éå†éœ€è¦è·å–å¤šä¸ªé”çš„æ—¶å€™ï¼Œå¿…é¡»æŒ‰ç…§å›ºå®šé¡ºåºå¾—åˆ°å¤šä¸ªç›¸å…³é”ã€‚æ¯ä¸ªçº¿ç¨‹çš„éå†æ¬¡åºå¿…é¡»ç›¸åŒã€‚</li>
  <li>ä½¿ç”¨é”çš„å±‚æ¬¡ç»“æ„ï¼šæä¾›å¯¹äºè¿è¡Œæ—¶é±¼ç­‰æ˜¯å¦è¢«åšæŒçš„æ£€æŸ¥ã€‚</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨å±‚æ¬¡é”æ¥é¿å…æ­»é”</span>

<span class="c1">//å±‚çº§é”ï¼Œå±‚çº§ä¸º10000</span>

<span class="n">hierarchical_mutex</span>  <span class="nf">high_level_mutex</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
<span class="c1">//å±‚çº§é”ï¼Œå±‚çº§ä¸º5000</span>

<span class="n">hierarchical_mutex</span>  <span class="nf">high_level_mutex</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">do_low_level_stuff</span><span class="p">();</span>

<span class="kt">int</span> <span class="nf">low_level_func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//å±‚çº§é”äº’æ–¥</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">hierarchical_mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">low_level_mutex</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">do_low_level_stuff</span><span class="p">();</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">high_level_stuff</span><span class="p">(</span><span class="kt">int</span> <span class="n">some_param</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">high_level_func</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//è®©hight_level_mutexä¸Šé”</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">hierarchical_mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">high_level_mutex</span><span class="p">);</span>
    <span class="c1">//è°ƒç”¨low_level_func()ä¼šå¯¹low_level_mutexä¸Šé”</span>
    
    <span class="n">high_level_stuff</span><span class="p">(</span><span class="n">low_level_func</span><span class="p">());</span>
<span class="p">}</span>
<span class="c1">//çº¿ç¨‹aéµå®ˆå±‚çº§è§„åˆ™ï¼Œæ‰€ä»¥è¿è¡Œç­æœ‰é—®é¢˜</span>

<span class="kt">void</span> <span class="nf">thread_a</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">high_level_func</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">hierarchical_mutex</span>  <span class="nf">other_mutex</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">do_other_stuff</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">other_stuff</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">high_level_func</span><span class="p">();</span>
    <span class="n">do_other_stuff</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//çº¿ç¨‹bæ— è§†å±‚çº§è§„åˆ™</span>

<span class="kt">void</span> <span class="nf">thread_b</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//å…ˆé”ä½other_mutexï¼›å®ƒçš„å±‚çº§åªæœ‰100ï¼Œæ„å‘³ç€ä½å±‚çº§å·²ç»è¢«ä¿æŠ¤ï¼Œå†ä½¿ç”¨high_level_func()ï¼Œä¼šé€ æˆæ­¤hierarchical_mutexå°†ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ã€‚å¯¼è‡´ç¨‹åºæ„å¤–ç»ˆæ­¢</span>

    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">hierarchical_mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">other_mutex</span><span class="p">);</span>
    <span class="n">other_stuff</span><span class="p">();</span>
<span class="p">}</span>


</code></pre></div></div>

<p>ç®€å•å±‚çº§çš„äº’æ–¥å®ç°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">hierarchical_mutex</span>
<span class="p">{</span>
    <span class="c1">//äº’æ–¥ä¿¡å·é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">internal_mutex</span><span class="p">;</span>
    <span class="c1">//æ¥å—çš„å±‚çº§å€¼</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="k">const</span> <span class="n">hierarchical_value</span><span class="p">;</span>
    <span class="c1">//åŸæ¥çš„å±‚çº§å€¼</span>

    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">previous_hierarchy_value</span><span class="p">;</span>
    <span class="c1">//é™æ€æŒ‡é’ˆï¼ŒæŒ‡å‘çº¿ç¨‹çš„å±‚çº§å€¼</span>

    <span class="k">static</span> <span class="k">thread_local</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">this_thread_hierarchy_value</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">check_for_hierarchy_violation</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//æ£€æŸ¥å±‚çº§å€¼ä¿æŒé€’å‡çš„åºåˆ—</span>

        <span class="k">if</span><span class="p">(</span><span class="n">this_thread_hierarchy_value</span><span class="o">&lt;=</span><span class="n">hierarchical_value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">logic_error</span><span class="p">(</span><span class="err">â€œ</span><span class="n">mutex</span>   <span class="n">hierarchy</span>   <span class="n">violated</span><span class="err">â€</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">update_hierachy_value</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//æ›´æ”¹å±‚çº§å€¼å‰ï¼Œå…ˆå°†åŸæ¥çš„å±‚çº§å€¼ä¿å­˜</span>

        <span class="n">previous_hierarchy_value</span><span class="o">=</span><span class="n">this_thread_hierarchy_value</span><span class="p">;</span>
        <span class="c1">//æ›´æ”¹å½“å‰çš„å±‚çº§å€¼</span>

        <span class="n">this_thread_hierarchy_value</span><span class="o">=</span><span class="n">hierarchical_value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">hierarchical_mutex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span><span class="o">:</span><span class="n">hierarchical_value</span><span class="p">(</span><span class="n">value</span><span class="p">),</span><span class="n">previous_hierarchy_value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{}</span>
    <span class="o">~</span><span class="n">hierarchical_mutex</span><span class="p">();</span>
    <span class="c1">//åŠ é”å‡½æ•°</span>

    <span class="kt">void</span> <span class="n">lock</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//ç¡®è®¤å½“å‰å€¼å°äºæ–°å€¼</span>

        <span class="n">check_for_hierarchy_violation</span><span class="p">();</span>
        <span class="c1">//å½“å‰çº¿ç¨‹åŠ é”</span>

        <span class="n">internal_mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
        
        <span class="n">update_hierachy_value</span><span class="p">();</span>

        <span class="n">update_hierachy_value</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">unlock</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//è¿˜åŸåŸæ¥çš„å±‚çº§å€¼</span>

        <span class="n">this_thread_hierarchy_value</span><span class="o">=</span><span class="n">previous_hierarchy_value</span><span class="p">;</span>
        <span class="n">internal_mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">try_lock</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">check_for_hierarchy_violation</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">internal_mutex</span><span class="p">.</span><span class="n">try_lock</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">update_hierachy_value</span><span class="p">();</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="c1">//ç›´æ¥å°†ä¿¡å·å˜é‡ï¼Œåˆå§‹åŒ–ä¸ºæœ€å¤§å€¼</span>

<span class="k">thread_local</span> <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">hierarchical_mutex</span><span class="o">::</span><span class="n">this_thread_hierarchy_value</span><span class="p">(</span><span class="n">ULONG_MAX</span><span class="p">);</span>

</code></pre></div></div>

<h4 id="326-stdunique_lock-çµæ´»çš„é”">3.2.6 std::unique_lockâ€“ çµæ´»çš„é”</h4>

<p><code class="language-plaintext highlighter-rouge">std::unique_lock</code>å¯ä»¥æ ¹æ®ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°çš„ä¸åŒï¼Œå¯¹ææ„å‡½æ•°è¿›è¡Œç®¡ç†ï¼Œä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::defer_lock</code>ä½œä¸ºå‚æ•°çš„æ—¶å€™ï¼Œè¡¨æ˜äº’æ–¥é‡åº”è¯¥ä¿æŒè§£é”çŠ¶æ€ï¼Œæ–¹ä¾¿è¢«å…¶å®ƒçº¿ç¨‹åŠ é”ã€‚ä½†æ˜¯   <code class="language-plaintext highlighter-rouge">std::unique_lock</code>ä¼šå ç”¨æ¯”è¾ƒå¤šçš„ç©ºé—´,å¹¶ä¸”æ¯”<code class="language-plaintext highlighter-rouge">std::lock_guard</code>ç¨æ…¢ä¸€äº›ã€‚å¹¶ä¸”<code class="language-plaintext highlighter-rouge">std::unique_lock</code>å®ä¾‹ä¸å¸¦äº’æ–¥é‡ï¼šä¿¡æ¯ä¸€å€å­˜å‚¨ï¼Œä¸”è¢«æ›´æ–°ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">std::lock()</code>å’Œ<code class="language-plaintext highlighter-rouge">std::unique_lock</code>çš„ä½¿ç”¨</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">some_big_object</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">swap</span><span class="p">(</span><span class="n">some_big_object</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span><span class="n">some_big_object</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">);</span>
<span class="k">class</span> <span class="nc">X</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="n">some_big_object</span> <span class="n">some_detail</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span>  <span class="n">m</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">X</span><span class="p">(</span><span class="n">some_big_object</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">sd</span><span class="p">)</span><span class="o">:</span><span class="n">some_detail</span><span class="p">(</span><span class="n">sd</span><span class="p">){}</span>
    <span class="k">friend</span> <span class="kt">void</span> <span class="n">swap</span><span class="p">(</span><span class="n">X</span><span class="o">&amp;</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">X</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lhs</span><span class="o">==&amp;</span><span class="n">rhs</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="c1">//std::def_lock   ç•™ä¸‹æœªä¸Šé”çš„äº’æ–¥é‡</span>

        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span>    <span class="n">lock_a</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">m</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">defer_lock</span><span class="p">);</span>  
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span>    <span class="n">lock_b</span><span class="p">(</span><span class="n">rhs</span><span class="p">.</span><span class="n">m</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">defer_lock</span><span class="p">);</span>  
        <span class="c1">// äº’æ–¥é‡åœ¨è¿™é‡Œä¸Šé”</span>
        
        <span class="n">std</span><span class="o">::</span><span class="n">lock</span><span class="p">(</span><span class="n">lock_a</span><span class="p">,</span><span class="n">lock_b</span><span class="p">);</span>
        <span class="n">swap</span><span class="p">(</span><span class="n">lhs</span><span class="p">.</span><span class="n">some_detail</span><span class="p">,</span><span class="n">rhs</span><span class="p">.</span><span class="n">some_detail</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h4 id="327-ä¸åŒåŸŸä¸­äº’æ–¥é‡æ‰€æœ‰æƒçš„ä¼ é€’">3.2.7 ä¸åŒåŸŸä¸­äº’æ–¥é‡æ‰€æœ‰æƒçš„ä¼ é€’</h4>
<p>å…è®¸ä¸€ä¸ªå‡½æ•°å»é”ä½ä¸€ä¸ªäº’æ–¥é‡,å¹¶ä¸”å°†æ‰€æœ‰æƒç§»åˆ°è°ƒç”¨è€…ä¸Š,æ‰€ä»¥è°ƒç”¨è€…å¯ä»¥åœ¨è¿™ä¸ªé”ä¿æŠ¤çš„èŒƒå›´å†…æ‰§è¡Œé¢å¤–çš„åŠ¨ä½œã€‚</p>

<p>ä¸‹é¢çš„ç¨‹åºç‰‡æ®µå±•ç¤ºäº†:å‡½æ•°get_lock()é”ä½äº†äº’æ–¥é‡,ç„¶åå‡†å¤‡æ•°æ®,è¿”å›é”çš„è°ƒç”¨å‡½æ•°:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">get_lock</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">extern</span>  <span class="n">std</span><span class="o">::</span><span class="n">mutex</span>  <span class="n">some_mutex</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span>    <span class="n">lk</span><span class="p">(</span><span class="n">some_mutex</span><span class="p">);</span>
    <span class="n">prepare_data</span><span class="p">();</span>
    <span class="c1">//å£°æ˜è‡ªåŠ¨å˜é‡ï¼Œä¸éœ€è¦è°ƒç”¨`std::move()`ç›´æ¥è¿”å›ä¿¡å·é‡çš„é”</span>

    <span class="k">return</span>  <span class="n">lk</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">process_data</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//è·å–çº¿ç¨‹çš„ä¿¡å·é‡é”è½¬ç§»std::unique_lockå®ä¾‹çš„æ‰€æœ‰æƒ</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">get_lock</span><span class="p">());</span>
    <span class="n">do_something</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>
<h4 id="328-é”çš„ç²’åº¦">3.2.8 é”çš„ç²’åº¦</h4>

<p>é”çš„ç²’åº¦é€šå¸¸ç”¨æ¥æè¿°é€šè¿‡ä¸€ä¸ªé”ä¿æŠ¤ç€çš„æ•°æ®é‡çš„å¤§å°ã€‚ç»†ç²’åº¦ä¿æŠ¤è¾ƒå°çš„æ•°æ®ï¼Œç²—ç²’åº¦ä¿æŠ¤è¾ƒå¤šçš„æ•°æ®ã€‚åœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼Œè‡ªå·±è¦æ³¨æ„é”çš„ç²’åº¦é—®é¢˜ã€‚</p>

<h3 id="33-ä¿æŠ¤å…±äº«æ•°æ®çš„æ›¿ä»£è®¾æ–½">3.3 ä¿æŠ¤å…±äº«æ•°æ®çš„æ›¿ä»£è®¾æ–½</h3>

<p>é™¤äº†äº’æ–¥é‡ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶å®ƒçš„ä¿æŠ¤å…±äº«æ•°æ®çš„æ–¹å¼ã€‚C++æä¾›äº†ä¸€ç§çº¯ç²¹ä¿æŠ¤å…±äº«æ•°æ®åˆå§‹åŒ–è¿‡ç¨‹çš„æœºåˆ¶ã€‚</p>

<p>ä½¿ç”¨ä¸€ä¸ªäº’æ–¥é‡çš„å»¶è¿Ÿåˆå§‹åŒ–(çº¿ç¨‹å®‰å…¨)è¿‡ç¨‹</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">some_resource</span><span class="o">&gt;</span>  <span class="n">resource_ptr</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">mutex</span>  <span class="n">resource_mutex</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//æ‰€æœ‰çº¿ç¨‹åœ¨æ­¤åºåˆ—åŒ–</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">resource_mutex</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">resource_ptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//åˆå§‹åŒ–èµ„æº</span>

        <span class="n">resource_ptr</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">some_resource</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">lk</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
    <span class="c1">//æ‰§è¡Œæ“ä½œ</span>

    <span class="n">resource_ptr</span><span class="o">-&gt;</span><span class="n">do_something</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div></div>

<p>c++ æä¾›äº† <code class="language-plaintext highlighter-rouge">std::once_flag</code>  å’Œ  <code class="language-plaintext highlighter-rouge">std::call_once</code> æ¥å¤„ç†å¤šçº¿ç¨‹çš„è¯»å†™åŒæ­¥é—®é¢˜ã€‚æ¯”èµ·é”ä½äº’æ–¥é‡,å¹¶æ˜¾å¼çš„æ£€æŸ¥æŒ‡é’ˆ,æ¯ä¸ªçº¿ç¨‹åªéœ€è¦ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::call_once</code>  ,åœ¨<code class="language-plaintext highlighter-rouge">std::call_once</code>çš„ç»“æŸæ—¶,å°±èƒ½å®‰å…¨çš„çŸ¥é“æŒ‡é’ˆå·²ç»è¢«å…¶ä»–çš„çº¿ç¨‹åˆå§‹åŒ–äº†ã€‚ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::call_once</code>æ¯”æ˜¾å¼ä½¿ç”¨äº’æ–¥é‡æ¶ˆè€—çš„èµ„æºæ›´å°‘,ç‰¹åˆ«æ˜¯å½“åˆå§‹åŒ–å®Œæˆåã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">some_resource</span><span class="o">&gt;</span>  <span class="n">resource_ptr</span><span class="p">;</span>

<span class="n">std</span><span class="o">::</span><span class="n">once_flag</span>  <span class="n">resource_flag</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">init_resource</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">resource_ptr</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span>  <span class="n">some_resource</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">foo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//å¯ä»¥å®Œæ•´çš„è¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–</span>

    <span class="n">std</span><span class="o">::</span><span class="n">call_once</span><span class="p">(</span><span class="n">resource_flag</span><span class="p">,</span><span class="n">init_resource</span><span class="p">);</span>
    <span class="n">resource_ptr</span><span class="o">-&gt;</span><span class="n">do_something</span><span class="p">();</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ä½¿ç”¨  std::call_once   ä½œä¸ºç±»æˆå‘˜çš„å»¶è¿Ÿåˆå§‹åŒ–(çº¿ç¨‹å®‰å…¨)</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">class</span>   <span class="nc">X</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="n">connection_info</span> <span class="n">connection_details</span><span class="p">;</span>
    <span class="n">connection_handle</span>   <span class="n">connection</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">once_flag</span>  <span class="n">connection_init_flag</span><span class="p">;</span>
    <span class="c1">//æ‰“å¼€æ•°æ®åº“</span>

    <span class="kt">void</span> <span class="n">open_connection</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">connection</span><span class="o">=</span><span class="n">connection_manager</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">connection_details</span><span class="p">);</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="n">X</span><span class="p">(</span><span class="n">connection_info</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">connection_details_</span><span class="p">)</span><span class="o">:</span><span class="n">connection_details</span><span class="p">(</span><span class="n">connection_details_</span><span class="p">)</span>
        <span class="p">{}</span>
    <span class="c1">//å®Œæˆçº¿ç¨‹çš„åˆå§‹åŒ–</span>

    <span class="kt">void</span> <span class="n">send_data</span><span class="p">(</span><span class="n">data_packet</span> <span class="k">const</span><span class="o">&amp;</span>  <span class="n">data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">call_once</span><span class="p">(</span><span class="n">connection_init_flag</span><span class="p">,</span><span class="o">&amp;</span><span class="n">X</span><span class="o">::</span><span class="n">open_connection</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>      
        <span class="n">connection</span><span class="p">.</span><span class="n">send_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//æ¥å—æ•°æ®ï¼Œè¿”å›æ•°æ®åŒ…</span>

    <span class="n">data_packet</span> <span class="n">receive_data</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//ä¼ é€’ä¸€ä¸ªé¢å¤–çš„å‚æ•°ï¼Œå®Œæˆè¿™ä¸ªæ“ä½œ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">call_once</span><span class="p">(</span><span class="n">connection_init_flag</span><span class="p">,</span><span class="o">&amp;</span><span class="n">X</span><span class="o">::</span><span class="n">open_connection</span><span class="p">,</span><span class="k">this</span><span class="p">);</span>
        <span class="k">return</span>  <span class="n">connection</span><span class="p">.</span><span class="n">receive_data</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h4 id="332--ä¿æŠ¤å¾ˆå°‘æ›´æ–°çš„æ•°æ®ç»“æ„">3.3.2  ä¿æŠ¤å¾ˆå°‘æ›´æ–°çš„æ•°æ®ç»“æ„</h4>

<p>ç±»ä¼¼äºDNSåŸŸåç¼“å­˜è¡¨ï¼Œåœ¨booståº“ä¸­ä¹Ÿå­˜åœ¨ç¼“å­˜å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œå¹¶ä¸”æ¯æ¬¡æ›´æ–°çš„éƒ½æ˜¯å°‘æ•°æ•°æ®ã€‚å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">boost::share_mutex</code>æ¥è¿›è¡ŒåŒæ­¥ã€‚</p>

<p>ä½¿ç”¨  boost::shared_mutex  å¯¹æ•°æ®ç»“æ„è¿›è¡Œä¿æŠ¤çš„ç®€å•DNSç¼“å­˜</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="cp">#include &lt;map&gt;
</span>
<span class="cp">#include &lt;string&gt;
</span>
<span class="cp">#include &lt;mutex&gt;
</span>
<span class="cp">#include &lt;boost/thread/shared_mutex.hpp&gt;
</span>
<span class="k">class</span> <span class="nc">dns_entry</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">dns_cache</span>
<span class="p">{</span>
    <span class="c1">//DNSç¼“å†²è¡¨</span>

    <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="n">dns_entry</span><span class="o">&gt;</span> <span class="n">entries</span><span class="p">;</span>
    <span class="k">mutable</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span> <span class="n">entry_mutex</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">dns_entry</span> <span class="n">find_entry</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span>  <span class="k">const</span><span class="o">&amp;</span>  <span class="n">domain</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="c1">//åˆ›å»ºå…±äº«é”</span>

        <span class="n">boost</span><span class="o">::</span><span class="n">shared_lock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">entry_mutex</span><span class="p">);</span>
        <span class="c1">//è·å–æŸ¥æ‰¾ç»“æœè¿­ä»£å™¨</span>

        <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="n">dns_entry</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="k">const</span>  <span class="n">it</span><span class="o">=</span><span class="n">entries</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">domain</span><span class="p">);</span>
        <span class="k">return</span>  <span class="p">(</span><span class="n">it</span><span class="o">==</span><span class="n">entries</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="o">?</span><span class="n">dns_entry</span><span class="p">()</span><span class="o">:</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">update_or_add_entry</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">domain</span><span class="p">,</span>
                            <span class="n">dns_entry</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">dns_details</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//çº¿ç¨‹ç‹¬å é”ï¼Œä¼šé˜»æ­¢å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®ç»“æ„è¿›è¡Œä¿®æ”¹ï¼Œå¹¶é˜»æ­¢çº¿ç¨‹è°ƒç”¨find_entry()</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">entry_mutex</span><span class="p">);</span>
        <span class="n">entries</span><span class="p">[</span><span class="n">domain</span><span class="p">]</span><span class="o">=</span><span class="n">dns_details</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<h4 id="333-åµŒå¥—é”">3.3.3 åµŒå¥—é”</h4>

<p>C++ æ ‡å‡†åº“æä¾›äº†<code class="language-plaintext highlighter-rouge">std::recursive_mutex</code>ç±»ã€‚å…¶åŠŸèƒ½ä¸<code class="language-plaintext highlighter-rouge">std::mutex</code>ç±»ä¼¼,é™¤äº†ä½ å¯ä»¥ä»åŒä¸€çº¿ç¨‹çš„å•ä¸ªå®ä¾‹ä¸Šè·å–å¤šä¸ªé”ã€‚äº’æ–¥é‡é”ä½å…¶ä»–çº¿ç¨‹å‰,ä½ å¿…é¡»é‡Šæ”¾ä½ æ‹¥æœ‰çš„æ‰€æœ‰é”,æ‰€ä»¥å½“ä½ è°ƒç”¨<code class="language-plaintext highlighter-rouge">lock()</code>ä¸‰æ¬¡æ—¶,ä½ ä¹Ÿå¿…é¡»è°ƒç”¨<code class="language-plaintext highlighter-rouge">unlock()</code>ä¸‰æ¬¡ã€‚æ­£ç¡®ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::lock_guard&lt;std::recursive_mutex&gt;</code>å’Œ<code class="language-plaintext highlighter-rouge">std::unique_lock&lt;std::recursive_mutex&gt;</code>å¯ä»¥å¸®ä½ å¤„ç†è¿™äº›é—®é¢˜ã€‚ä¸»è¦ç”¨äºæˆå‘˜å‡½æ•°åµŒå¥—è°ƒç”¨çš„æ—¶å€™çš„äº’æ–¥ã€‚</p>

<p>æ¨èçš„ä½¿ç”¨æ–¹å¼æ˜¯ï¼šæå–å¤„ä¸€ä¸ªå‡½æ•°ä½œä¸ºç±»çš„ç§æœ‰æˆå‘˜ï¼Œå¹¶ä¸”è®©å…¶å®ƒæˆå‘˜å‡½æ•°éƒ½è¿›è¡Œè°ƒç”¨ï¼Œè¿™ä¸ªç§æœ‰æˆå‘˜å‡½æ•°ä¸ä¼šå¯¹äº’æ–¥é‡è¿›è¡Œä¸Šé”ã€‚</p>

:ET