I"PË<h1 id="unixç½‘ç»œç¼–ç¨‹-å­¦ä¹ ç¬”è®°">UNIXç½‘ç»œç¼–ç¨‹ å­¦ä¹ ç¬”è®°</h1>
<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<ul>
  <li><a href="https://blog.csdn.net/zzxiaozhao/article/details/102637708">ã€ŠUnixç½‘ç»œç¼–ç¨‹ã€‹å·1 åˆçº§</a></li>
</ul>

<h1 id="unixç½‘ç»œç¼–ç¨‹-å­¦ä¹ ç¬”è®°-ä¸€ç®€ä»‹å’Œtcpip">UNIXç½‘ç»œç¼–ç¨‹ å­¦ä¹ ç¬”è®° (ä¸€)â€“ç®€ä»‹å’ŒTCP/IP</h1>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<h2 id="ç¬¬-0-ç« -ç½‘ç»œåŸºç¡€çŸ¥è¯†">ç¬¬ 0 ç«  ç½‘ç»œåŸºç¡€çŸ¥è¯†</h2>

<h2 id="ç¬¬1ç« -ç®€ä»‹">ç¬¬1ç«  ç®€ä»‹</h2>

<p>ç½‘ç»œåº”ç”¨ç³»ç»Ÿä¸»è¦æ„æˆæœ‰ä¸¤éƒ¨åˆ†ï¼šå®¢æˆ·ç«¯(client)å’ŒæœåŠ¡å™¨(server)ã€‚</p>

<p>ä¸¾ä¾‹æ¥è¯´ï¼šwebæœåŠ¡å™¨ç¨‹åºæ—¶ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„å®ˆæŠ¤ç¨‹åºï¼Œwebå®¢æˆ·ä¸æœåŠ¡å™¨ä¹‹é—´ä½¿ç”¨TCPé€šä¿¡ï¼ŒTCPè½¬è€Œä½¿ç”¨IPé€šä¿¡ï¼ŒIPé€šè¿‡ä»¥å¤ªç½‘é©±åŠ¨ç¨‹åºçš„æ•°æ®é“¾è·¯å±‚é€šä¿¡ã€‚</p>

<p><img src="https://img-blog.csdnimg.cn/20191019134039155.png#pic_enter" alt="å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä½¿ç”¨TCPåœ¨åŒä¸€ä¸ªä»¥å¤ªç½‘ä¸­é€šä¿¡" /></p>

<p>ä¸€èˆ¬æ˜¯ä½¿ç”¨çš„IPv4(32ä½ï¼Œ4å­—èŠ‚)æˆ–è€…IPv6(128ä½,16å­—èŠ‚)ï¼›</p>

<p><strong>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šå¸¸æ˜¯ç”¨æˆ·è¿›ç¨‹ï¼Œè€ŒTCPå’ŒIPåè®®é€šå¸¸æ˜¯å†…æ ¸ä¸­â€åè®®æ ˆâ€çš„ä¸€éƒ¨åˆ†ã€‚</strong></p>

<p>ç½‘ç»œåˆ†ä¸ºï¼š</p>
<ul>
  <li>LANï¼šå±€åŸŸç½‘(å†…ç½‘)</li>
  <li>WANï¼šå¹¿åŸŸç½‘(å¤–ç½‘)</li>
</ul>

<p>è·¯ç”±å™¨æ˜¯å¹¿åŸŸç½‘çš„æ¶æ„è®¾å¤‡ã€‚å½“ä¸‹æœ€å¤§çš„å¹¿åŸŸç½‘æ˜¯å› ç‰¹ç½‘internetã€‚</p>

<p><img src="https://img-blog.csdnimg.cn/20191019134242600.png#pic_center" alt="ä¸åŒå±€åŸŸç½‘çš„å®¢æˆ·æœºå’Œä¸»æœº" /></p>

<p>é¦–å…ˆè®¾ç½®UNPç›¸å…³çš„å¤´æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* unp.h */</span>
<span class="cp">#ifndef __UNP_H__
#define __UNP_H__
</span> 
<span class="cp">#include &lt;sys/types.h&gt;	    </span><span class="cm">/* basic system data types */</span><span class="cp">
#include &lt;sys/socket.h&gt;	    </span><span class="cm">/* basic socket definitions */</span><span class="cp">
#include &lt;sys/time.h&gt;	    </span><span class="cm">/* timeval{} for select() */</span><span class="cp">
#include &lt;time.h&gt;		    </span><span class="cm">/* timespec{} for pselect() */</span><span class="cp">
#include &lt;netinet/in.h&gt;	    </span><span class="cm">/* sockaddr_in{} and other Internet defns */</span><span class="cp">
#include &lt;arpa/inet.h&gt;	    </span><span class="cm">/* inet(3) functions */</span><span class="cp">
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;		    </span><span class="cm">/* for nonblocking */</span><span class="cp">
#include &lt;netdb.h&gt;
#include &lt;signal.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/stat.h&gt;	    </span><span class="cm">/* for S_xxx file mode constants */</span><span class="cp">
#include &lt;sys/uio.h&gt;		</span><span class="cm">/* for iovec{} and readv/writev */</span><span class="cp">
#include &lt;unistd.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;sys/un.h&gt;		    </span><span class="cm">/* for Unix domain sockets */</span><span class="cp">
</span> 
<span class="cp">#endif //__UNP_H__
</span></code></pre></div></div>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨å®¢æˆ·ç«¯ç¨‹åº</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* server.h */</span>
<span class="cp">#include &lt;stdio.h&gt;
#include &lt;time.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;unistd.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#define MAXLINE 4096
</span>
<span class="cp">#define LISTENQ 1024
</span>
<span class="c1">//#define SA struct sockaddr</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="n">SA</span><span class="p">;</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]){</span>
    <span class="cm">/*å®šä¹‰ç›‘å¬æ–‡ä»¶ç¬¦å’Œé“¾æ¥æ–‡ä»¶ç¬¦*/</span>
    <span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span><span class="n">connfd</span><span class="p">;</span>
    <span class="cm">/*å®šä¹‰ç½‘ç»œåœ°å€ç»“æ„ä½“*/</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
    <span class="cm">/*å®šä¹‰ç¼“å†²buffer*/</span>
    <span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
    <span class="c1">//ä½¿ç”¨è®¡æ—¶æ—¶é’Ÿ</span>
    <span class="kt">time_t</span> <span class="n">ticks</span><span class="p">;</span>
    <span class="c1">//åˆ›å»ºä¸€ä¸ªTCPçš„IPv4ç½‘ç»œé“¾æ¥;SOCK_DGRAMè¡¨ç¤ºUDP</span>
    <span class="n">listenfd</span><span class="o">=</span><span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="c1">//åˆå§‹åŒ–ç½‘ç»œåœ°å€ç»“æ„ä½“</span>
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="c1">//åˆå§‹åŒ–å‚æ•°</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span><span class="o">=</span><span class="n">AF_INET</span><span class="p">;</span><span class="cm">/* è®¾ç½®ç½‘ç»œåè®® */</span>
    <span class="cm">/* è®¾ç½®IPåœ°å€ï¼Œéœ€è¦è¿›è¡Œç½‘ç»œåºçš„è½¬æ¢ï¼ŒINADDR_ANYè¡¨ç¤º127.0.0.1 æœ¬åœ°åœ°å€ */</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="o">=</span><span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
    <span class="cm">/*è®¾ç½®ç«¯å£å·1300,æ³¨æ„å­—èŠ‚åºè½¬æ¢*/</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span><span class="o">=</span><span class="n">htons</span><span class="p">(</span><span class="mi">1300</span><span class="p">);</span>
    <span class="cm">/* bindå°†socketå’Œservaddré“¾æ¥èµ·æ¥ï¼Œè¡¨ç¤ºç›‘å¬ç«¯å£ */</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,(</span><span class="n">SA</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="cm">/* è°ƒç”¨listen å‡½æ•°å°†å¥—æ¥å­—è½¬åŒ–ä¸ºç›‘å¬å¥—æ¥å­— */</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span><span class="n">LISTENQ</span><span class="p">);</span>
    <span class="c1">// æ¥å—æœåŠ¡å™¨é“¾æ¥,å‘é€åº”ç­”</span>
     <span class="c1">//é’ˆå¯¹å®¢æˆ·ç«¯æ¥å—çš„é“¾æ¥å¥—æ¥å­—,æ³¨æ„ä¸‹é¢çš„ä»£ç åˆ°acceptä¹‹åæ‰èƒ½æ‰§è¡Œ</span>
	<span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="c1">//è·å–å½“å‰æ—¶é—´</span>
        <span class="n">ticks</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="c1">//å°†å½“å‰æ—¶é—´å†™å…¥buff</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buff</span><span class="p">),</span> <span class="s">"%.24s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ticks</span><span class="p">));</span>
        <span class="c1">//å°†buffå†™å…¥åˆ°æ–‡ä»¶è¿æ¥ç¬¦ä¸­</span>
        <span class="n">write</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buff</span><span class="p">));</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//ç¡çœ 1s</span>
	<span class="p">}</span>
    <span class="c1">//å…³é—­è¿æ¥ç¬¦</span>
	<span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>å®¢æˆ·ç«¯ç›¸å…³ä»£ç </p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* client */</span>
<span class="cp">#include "unp.h"
#define MAXLINE 1024
</span><span class="c1">//#define SA struct sockaddr</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">sockaddr</span> <span class="n">SA</span><span class="p">;</span>
 
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* åˆ›å»ºå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦ */</span>
    <span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
    <span class="cm">/* å®šä¹‰ç¼“å†²åŒº */</span>
    <span class="kt">char</span> <span class="n">recvline</span><span class="p">[</span><span class="n">MAXLINE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"usage: a.out &lt;IPaddress&gt;</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/*
    ä½¿ç”¨socketåˆ›å»ºä¸€ä¸ªç½‘é™…(AF_INET)å­—èŠ‚æµ(SOCK_STEREAM)å¥—æ¥å­—,
    è¿”å›ç±»å‹ä¸ºæ•´æ•°ç±»å‹æè¿°ç¬¦, åé¢çš„å‡½æ•°è°ƒç”¨(å¦‚ connect, readç­‰)å°±ä½¿ç”¨è¯¥æè¿°ç¬¦æ¥æ ‡è¯†æ­¤å¥—æ¥å­—
    */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"socket error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/*
     æŠŠIPå’ŒPortå¡«å…¥ä¸€ä¸ªç½‘é™…å¥—æ¥å­—åœ°å€ç»“æ„(åä¸º servaddrå’Œsockaddr_inçš„ç»“æ„å˜é‡)
    */</span>
    <span class="cm">/* 1. ä½¿ç”¨bzeroå°†ç»“æ„ä½“æ¸…ç©º */</span> 
    <span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="cm">/* 2. ç½®åœ°å€æ—ä¸º AF_INET */</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>  
    <span class="cm">/* 3. ç½®ä½ç«¯å£ */</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span>   <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">1300</span><span class="p">);</span>
    <span class="cm">/* 4. ç½®ä½IP */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"inet_pton error for %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="cm">/* å»ºç«‹å’ŒæœåŠ¡å™¨çš„é“¾æ¥ */</span>
    <span class="k">if</span><span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"connect error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="cm">/* è¯»å…¥å¹¶è¾“å‡ºæœåŠ¡å™¨åº”ç­” */</span>
    <span class="cm">/* ä½¿ç”¨readå‡½æ•°è¯»å–æœåŠ¡å™¨åº”ç­”,ä½¿ç”¨æ ‡å‡†è¾“å‡º fputsè¾“å‡ºç»“æ„ */</span>
    <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">recvline</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* null terminate */</span>
        <span class="n">recvline</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">fputs</span><span class="p">(</span><span class="n">recvline</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
            <span class="n">printf</span> <span class="p">(</span><span class="s">"fputs error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">printf</span> <span class="p">(</span><span class="s">"read error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">//å…³é—­socketè¿æ¥</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sockfd</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>æ³¨æ„ï¼š</p>

<ul>
  <li><strong>è°ƒç”¨sprintfæ— æ³•æ£€æŸ¥ç›®çš„ç¼“å†²åŒºæ˜¯å¦æº¢å‡ºï¼Œç›¸åï¼Œsnprintfè¦æ±‚å…¶ç¬¬äºŒä¸ªå‚æ•°æŒ‡å®šç›®çš„ç¼“å†²åŒºçš„å¤§å°ï¼Œå› æ­¤å¯ä»¥ç¡®ä¿è¯¥ç¼“å†²åŒºä¸æº¢å‡ºã€‚</strong></li>
  <li>è®¸å¤šç½‘ç»œå…¥ä¾µæ˜¯ç”±é»‘å®¢é€šè¿‡å‘é€æ•°æ®ï¼Œå¯¼è‡´æœåŠ¡å™¨å¯¹sprintfçš„è°ƒç”¨ä½¿å…¶ç¼“å†²åŒºæº¢å‡ºè€Œå‘ç”Ÿçš„ï¼Œ<strong>å¿…é¡»å°å¿ƒä½¿ç”¨çš„å‡½æ•°è¿˜æœ‰gets/strcat/strcpy</strong>ï¼Œé€šå¸¸åº”åˆ†åˆ«æ”¹ä¸ºè°ƒç”¨fgets/strncat/strncpyï¼Œæ›´å¥½çš„æ›¿ä»£å‡½æ•°è¿˜æœ‰strlcat/strlcpyå¯ä»¥ç¡®ä¿ç»“æœæ˜¯æ­£ç¡®ç»ˆæ­¢çš„å­—ç¬¦ä¸²ã€‚</li>
</ul>

<p>OSIæ¨¡å‹ open systems interconnection(å…¨ç§°ï¼šè®¡ç®—æœºé€šä¿¡å¼€æ”¾ç³»ç»Ÿäº’è¿æ¨¡å‹ã€‚)</p>
<ul>
  <li>åˆ†å±‚ï¼š
    <ul>
      <li>ç‰©ç†å±‚/æ•°æ®é“¾è·¯å±‚ï¼šä¸»è¦æ˜¯è®¾å¤‡é©±åŠ¨å’Œç½‘ç»œç¡¬ä»¶ï¼Œé€šå¸¸æˆ‘ä»¬ä¸å¿…å…³å¿ƒã€‚</li>
      <li>ç½‘ç»œå±‚ï¼šç”±IPv4å’ŒIPv6è¿™ä¸¤ä¸ªåè®®å¤„ç†ã€‚è¯¦ç»†åœ¨é™„å½•Aä¸­ã€‚</li>
      <li>ä¼ è¾“å±‚ï¼šå³æœ¬ä¹¦æ‰€è®²çš„å¥—æ¥å­—ç¼–ç¨‹æ¥å£ï¼Œä»åº”ç”¨å±‚(ä¸Š3å±‚)è¿›å…¥ä¼ è¾“å±‚çš„æ¥å£ã€‚</li>
      <li>åº”ç”¨å±‚/ä¼šè¯å±‚/è¡¨ç¤ºå±‚ï¼šç»Ÿç§°ä¸ºåº”ç”¨å±‚ï¼Œå¦‚webå®¢æˆ·ç«¯(æµè§ˆå™¨)ã€telnetå®¢æˆ·ç«¯ã€webæœåŠ¡å™¨ã€FTPæœåŠ¡å™¨ç­‰ã€‚</li>
    </ul>
  </li>
  <li>ç»“æ„å›¾</li>
</ul>

<p><img src="https://img-blog.csdnimg.cn/20191019140405326.png#pic_center" alt="ç»“æ„å›¾" /></p>

<h3 id="12-ç½‘ç»œç›¸å…³è°ƒè¯•å‘½ä»¤">1.2 ç½‘ç»œç›¸å…³è°ƒè¯•å‘½ä»¤</h3>

<h4 id="121-ç½‘ç»œç»†èŠ‚çš„ä¸‰ä¸ªåŸºæœ¬å‘½ä»¤netstarifconfigping">1.2.1 ç½‘ç»œç»†èŠ‚çš„ä¸‰ä¸ªåŸºæœ¬å‘½ä»¤ï¼š<code class="language-plaintext highlighter-rouge">netstar/ifconfig/ping</code></h4>

<ul>
  <li>netstat
    <ul>
      <li>netstat -ni // æä¾›ç½‘ç»œæ¥å£ä¿¡æ¯ï¼Œ-nè¾“å‡ºæ•°å€¼åœ°å€è€Œä¸æ˜¯åå‘è§£æä¸ºåå­—</li>
      <li>$ netstat -ni</li>
    </ul>
  </li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Kernel Interface table
Iface   MTU Met   RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
eth0       1500 0     15459      0      0 0         10444      0      0      0 BMRU
lo        16436 0       138      0      0 0           138      0      0      0 LRU
// lo ç¯å›æ¥å£
// eth0 ä»¥å¤ªç½‘æ¥å£
</code></pre></div></div>
<ul>
  <li>netstat -nr // å±•ç¤ºè·¯ç”±è¡¨ä¿¡æ¯ï¼Œå¦ä¸€ç§ç¡®å®šæ¥å£çš„æ–¹æ³•</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å†…æ ¸ IP è·¯ç”±è¡¨
Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface
0.0.0.0         192.168.31.1    0.0.0.0         UG        0 0          0 eth0
169.254.0.0     0.0.0.0         255.255.0.0     U         0 0          0 eth0
192.168.31.0    0.0.0.0         255.255.255.0   U         0 0          0 eth0

</code></pre></div></div>

<ul>
  <li>ifconfig
    <ul>
      <li>ifconfig eth0 // è·å¾—eth0ä»¥å¤ªç½‘æ¥å£çš„è¯¦ç»†ä¿¡</li>
    </ul>
  </li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ifconfig eth0

eth0      Link encap:ä»¥å¤ªç½‘  ç¡¬ä»¶åœ°å€ 00:0c:29:55:a0:99
          inet åœ°å€:192.168.31.205  å¹¿æ’­:192.168.31.255  æ©ç :255.255.255.0
          inet6 åœ°å€: fe80::20c:29ff:fe55:a099/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  è·ƒç‚¹æ•°:1
          æ¥æ”¶æ•°æ®åŒ…:15624 é”™è¯¯:0 ä¸¢å¼ƒ:0 è¿‡è½½:0 å¸§æ•°:0
          å‘é€æ•°æ®åŒ…:10571 é”™è¯¯:0 ä¸¢å¼ƒ:0 è¿‡è½½:0 è½½æ³¢:0
          ç¢°æ’:0 å‘é€é˜Ÿåˆ—é•¿åº¦:1000
          æ¥æ”¶å­—èŠ‚:1468669 <span class="o">(</span>1.4 MB<span class="o">)</span>  å‘é€å­—èŠ‚:1070042 <span class="o">(</span>1.0 MB<span class="o">)</span>
          ä¸­æ–­:19 åŸºæœ¬åœ°å€:0x2000
// MULTICAST æ ‡å¿—é€šå¸¸æŒ‡æ˜è¯¥æ¥å£æ‰€åœ¨ä¸»æœºæ”¯æŒå¤šæ’­ã€‚
</code></pre></div></div>

<ul>
  <li>ping // æµ‹è¯•ipåœ°å€æ˜¯å¦è”é€šå½“å‰ä»¥å¤ªç½‘ç»œ</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ping <span class="nt">-b</span> 192.168.31.255

PING 192.168.31.255 <span class="o">(</span>192.168.31.255<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 192.168.31.255: <span class="nv">icmp_req</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.253 ms
64 bytes from 192.168.31.255: <span class="nv">icmp_req</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.022 ms
64 bytes from 192.168.31.255: <span class="nv">icmp_req</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.029 ms
</code></pre></div></div>

<p>æ³¨æ„ï¼š64ä½ä½“ç³»ç»“æ„çš„è¶‹åŠ¿åŸå› ä¹‹ä¸€æ˜¯ï¼šåœ¨æ¯ä¸ªè¿›ç¨‹å†…éƒ¨å¯ä»¥ç”±æ­¤ä½¿ç”¨æ›´é•¿çš„ç¼–å€é•¿åº¦(å³64ä½æŒ‡é’ˆ)ï¼Œä»è€Œå¯ä»¥å¯»å€æ›´å¤§çš„å†…å­˜ç©ºé—´(è¶…è¿‡2^32å­—èŠ‚)ã€‚</p>

<h2 id="ä¼ è¾“å±‚tcpudpå’Œsctp">ä¼ è¾“å±‚ï¼šTCPã€UDPå’ŒSCTP</h2>

<p>ä¸‹é¢æ˜¯TCP/IPåè®®æ—çš„æ¦‚å†µ</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-21-16-02-21.png" alt="TCP/IPåè®®æ—çš„æ¦‚å†µ" /></p>

<p>ç›¸å…³åè®®:</p>
<ul>
  <li>TCPï¼šä¼ è¾“æ§åˆ¶åè®®ï¼Œé¢ç›¸è¿æ¥ï¼Œå…¨åŒå·¥å­—èŠ‚æµã€‚æµå¥—æ¥å­—ã€‚å…³å¿ƒï¼šç¡®è®¤ã€è¶…æ—¶ã€é‡ä¼ ç­‰ç»†èŠ‚ã€‚</li>
  <li>UDPï¼šç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼Œæ— è¿æ¥åè®®ã€‚æ•°æ®æŠ¥å¥—æ¥å­—ã€‚ä¸ä¿è¯æœ€ç»ˆè¾¾åˆ°ç›®çš„åœ°ã€‚</li>
  <li>ICMPï¼šç½‘é™…æ§åˆ¶æ¶ˆæ¯åè®®ï¼Œå¤„ç†è·¯ç”±å™¨å’Œä¸»æœºä¹‹é—´æµé€šçš„é”™è¯¯å’Œæ§åˆ¶æ¶ˆæ¯ã€‚</li>
  <li>ARPï¼šåœ°å€è§£æåè®®ï¼ŒæŠŠIPv4åœ°å€æ˜ å°„æˆä¸€ä¸ªç¡¬ä»¶åœ°å€(æ•°æ®é“¾è·¯å±‚)ã€‚</li>
  <li>RARPï¼šååœ°å€è§£æåè®®ï¼ŒæŠŠä¸€ä¸ªç¡¬ä»¶åœ°å€æ˜ å°„æˆä¸€ä¸ªIPv4åœ°å€(æ•°æ®é“¾è·¯å±‚)ã€‚</li>
  <li>SCTPï¼šæµæ§åˆ¶ä¼ è¾“åè®®ï¼Œæä¾›å¯é çš„å…¨åŒå·¥å…³è”çš„é¢å‘é“¾æ¥çš„åè®®ã€‚</li>
  <li>ICMP:ç½‘é™…æ§åˆ¶æ¶ˆæ¯åè®®ã€‚ä¸»è¦å¤„ç†è·¯ç”±å™¨å’Œä¸»æœºä¹‹é—´çš„æµé€šçš„é”™è¯¯å’Œæ§åˆ¶æ¶ˆæ¯ã€‚</li>
  <li>IGMP:ç½‘é™…ç»„ç®¡ç†åè®®ã€‚ä¸»è¦ç”¨äºå¤šæ’­ã€‚</li>
</ul>

<h3 id="26-tcpçš„å»ºç«‹å’Œç»ˆæ­¢">2.6 TCPçš„å»ºç«‹å’Œç»ˆæ­¢</h3>

<h4 id="261-ä¸‰æ¬¡æ¡æ‰‹">2.6.1 ä¸‰æ¬¡æ¡æ‰‹</h4>

<ol>
  <li>æœåŠ¡å™¨å‡†å¤‡å¥½æ¥å—å¤–æ¥çš„è¿æ¥â€“socketã€bindå’Œlistenè¿™ä¸‰ä¸ªå‡½æ•°æ¥å®Œæˆï¼Œå³è¢«åŠ¨æ‰“å¼€ã€‚</li>
  <li>å®¢æˆ·ç«¯è°ƒç”¨connectå‘èµ·ä¸»åŠ¨æ‰“å¼€(active open).å®¢æˆ·ç«¯å‘é€SYN(åŒæ­¥)åˆ†èŠ‚ã€‚SYNé€šå¸¸ä¸æºå¸¦æ•°æ®ï¼Œå…¶æ‰€åœ¨IPæ•°æ®æŠ¥åªå«æœ‰ä¸€ä¸ªIPé¦–éƒ¨ã€ä¸€ä¸ªTCPé¦–éƒ¨ä»¥åŠå¯èƒ½æœ‰çš„TCPé€‰é¡¹</li>
  <li>æœåŠ¡å™¨ç¡®è®¤(ACK)å®¢æˆ·ç«¯çš„SYN,åŒæ—¶è‡ªå·±å‘é€ä¸€ä¸ªSYNåˆ†èŠ‚ï¼Œå«æœ‰æœåŠ¡å™¨å°†åœ¨åŒä¸€è¿æ¥ä¸­å‘é€çš„æ•°æ®çš„åˆå§‹åºåˆ—å¥½ã€‚æœåŠ¡å™¨åœ¨å•ä¸ªåˆ†èŠ‚ä¸­å‘é€SYNå’Œå¯¹å®¢æˆ·ç«¯SYNçš„ACK(ç¡®è®¤)</li>
  <li>å®¢æˆ·ç«¯å¿…é¡»ç¡®è®¤æœåŠ¡å™¨çš„SYN</li>
</ol>

<p><img src="https://wangpengcheng.github.io/img/2019-11-20-20-11-32.png" alt="TCPä¸‰æ¬¡æ¡æ‰‹" /></p>

<p>ä¸‹é¢æ˜¯TCPçš„å››æ¬¡æŒ¥æ‰‹</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-21-22-07-01.png" alt="TCPå››æ¬¡æŒ¥æ‰‹" /></p>

<p>TCPé“¾æ¥ç›¸å…³çŠ¶æ€å›¾å¦‚ä¸‹;</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-17-06-18.png" alt="TCPçŠ¶æ€è½¬æ¢å›¾" /></p>

<p><strong>TCPçš„åˆ†ç»„äº¤æ¢</strong></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-17-08-08.png" alt="TCPçš„åˆ†ç»„äº¤æ¢" /></p>

<h3 id="28-sctpå…³è”çš„å»ºç«‹å’Œç»ˆæ­¢">2.8 SCTPå…³è”çš„å»ºç«‹å’Œç»ˆæ­¢</h3>

<p>SCTPå› ä¸ºæ˜¯éåŒå…¨å·¥é€šä¿¡ï¼Œå› æ­¤ä¸éœ€è¦åƒTCPä¸€æ ·ï¼Œéœ€è¦è¿›è¡Œå››æ¬¡æŒ¥æ‰‹(æ²¡ä¸¤æ¬¡æŒ¥æ‰‹ï¼Œå…³é—­ä¸€è¾¹çš„é€šé“)ã€‚ä½†æ˜¯ï¼Œé‡‡ç”¨äº†ç‹¬ç‰¹çš„æ ¡éªŒæœºåˆ¶ï¼Œéœ€è¦åœ¨å¼€å§‹é“¾æ¥æ—¶ï¼Œè¿›è¡Œå››æ¬¡æ¡æ‰‹ï¼Œäº’ç›¸äº¤æ¢ç¡®è®¤å·ã€‚å…³è”è¿‡ç¨‹å¦‚ä¸‹:</p>

<ol>
  <li>æœåŠ¡å™¨å‡†å¤‡å¥½æ¥å—å¤–æ¥çš„å…³è”</li>
  <li>å®¢æˆ·é€šè¿‡connectæˆ–è€…å‘é€ä¸€ä¸ªéšå¼æ‰“å¼€å…³è”çš„æ¶ˆæ¯è¿›è¡Œä¸»åŠ¨æ‰“å¼€ã€‚å‘é€ä¸€ä¸ªINITæ¶ˆæ¯(åˆå§‹åŒ–)ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯çš„IPåœ°å€æ¸…å•ï¼Œåˆå§‹åºåˆ—å¥½å’Œç›¸å…³åˆ†ç»„çš„èµ·å§‹æ ‡è®°ã€å®¢æˆ·è¯·æ±‚çš„å¤–å‡ºæµçš„æ•°ç›®ä»¥åŠå®¢æˆ·èƒ½å¤Ÿæ”¯æŒçš„å¤–æ¥æµçš„æ•°ç›®ã€‚</li>
  <li>æœåŠ¡å™¨å‘é€INIT ACKæ¶ˆæ¯æ¥ç¡®è®¤å®¢æˆ·ç«¯çš„INITæ¶ˆæ¯ï¼Œå…¶ä¸­è¿˜æœ‰æœåŠ¡å™¨çš„IPåœ°å€æ¸…å•ã€åˆå§‹åºåˆ—å·ã€èµ·å§‹æ ‡è®°ã€‚åŒæ—¶ä¼šæ¿€åŠ±ä¸€ä¸ªçŠ¶æ€çš„cookieï¼Œç”¨äºç¡®ä¿¡æœ¬å…³è”æœ‰æ•ˆæ‰€éœ€è¦çš„æ‰€æœ‰çŠ¶æ€ã€‚</li>
  <li>å®¢æˆ·ç«¯ç»“æ„æœåŠ¡å™¨æ¶ˆæ¯ï¼Œå¹¶ä»¥ä¸€ä¸ªCOOKIE ECHOæ¶ˆæ¯å›å°„æœåŠ¡å™¨çš„çŠ¶æ€cookie.åŒæ—¶åœ¨åˆ†ç»„ä¸­æ†ç»‘äº†ç”¨æˆ·æ•°æ®</li>
  <li>æœåŠ¡å™¨ä»¥ä¸€ä¸ªCOOKIE ACKæ¶ˆæ¯ç¡®è®¤å®¢æˆ·å›å°„çš„cookieæ˜¯æ­£ç¡®çš„ï¼Œæœ¬å…³è”äºæ˜¯å»ºç«‹ã€‚è¯¥æ¶ˆæ¯ä¹Ÿå¯èƒ½åœ¨åŒä¸€ä¸ªåˆ†ç»„ä¸­è¿˜æ†ç»‘äº†ç”¨æˆ·æ•°æ®ã€‚</li>
</ol>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-20-10-05.png" alt="SCTPå››è·¯æ¡æ‰‹" /></p>

<p>æ³¨æ„ï¼š<strong>SCTPä½¿ç”¨å››è·¯æ¡æ‰‹ï¼Œæ˜¯ä¸ºäº†é¿å…æ‹’ç»æœåŠ¡å…±è®¡</strong>ã€‚SCTPä¸­cookieçŠ¶æ€æä¾›äº†ä¸€ä¸ªä»»æ„é•¿åº¦çš„å­—æ®µï¼Œå¹¶ä¸”è¦æ±‚å®æ–½åŸºäºåŠ å¯†çš„å®‰å…¨æ€§ä»¥é˜²æŠ¤æ”»å‡»ï¼ŒTCPä¸­cookieç¼–ç åªæœ‰32ä½é•¿çš„åˆå§‹åºåˆ—å·ä¸­ã€‚</p>

<h4 id="282-å…³è”ç»ˆæ­¢">2.8.2 å…³è”ç»ˆæ­¢</h4>

<p>å› ä¸ºSCTPæ²¡æœ‰ç±»ä¼¼ä¸TCPçš„TIME_WAITçŠ¶æ€ï¼Œè€Œæ˜¯ä½¿ç”¨äº†éªŒè¯æ ‡è®°ï¼Œæ‰€æœ‰åç»­å—éƒ½åœ¨æ†ç»‘å®ƒä»¬çš„SCTPåˆ†ç»„çš„å…¬å…±é¦–éƒ¨æ ‡è®°äº†åˆå§‹çš„INITå—å’ŒINIT ACKå—ä¸­ä½œä¸ºèµ·å§‹æ ‡è®°äº¤æ¢çš„ç ”ç©¶è¡¨ç¤ºï¼Œç”±æ¥è‡ªæ—§é“¾æ¥çš„å—é€šè¿‡æ‰€åœ¨SCTPåˆ†ç»„çš„å…¬å…±é¦–éƒ¨é—´æ¥æºå¸¦çš„éªŒè¯æ ‡è®°å¯¹äºæ–°è¿æ¥æ¥è¯´æ˜¯ä¸æ­£ç¡®çš„ã€‚å› æ­¤ï¼Œé¿å…äº†ä½¿ç”¨TIME_WAITçŠ¶æ€æ¥ä¿æŒæ•´ä¸ªè¿æ¥çš„åšæ³•ã€‚</p>

<p>å…¶çŠ¶æ€è½¬æ¢å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-20-17-44.png" alt="SCTPçŠ¶æ€è½¬æ¢å›¾" /></p>

<p>åˆ†ç»„è¿æ¥çŠ¶æ€å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-20-19-13.png" alt="SCTPåˆ†ç»„è¿æ¥" /></p>

<p>å½“å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥æœåŠ¡å™¨çš„ç›¸åŒç«¯å£æ—¶ï¼Œä¼šäº§ç”Ÿå¤šä¸ªå¥—æ¥å­—</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-20-22-37.png" alt="å¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥" /></p>

<h3 id="211-ç¼“å†²åŒºå¤§å°åŠé™åˆ¶">2.11 ç¼“å†²åŒºå¤§å°åŠé™åˆ¶</h3>

<ul>
  <li>IPv4:æœ€å¤§å¤§å°æ˜¯65535å­—èŠ‚ï¼ŒåŒ…æ‹¬IPv4é¦–éƒ¨ï¼›å› ä¸ºæ€»é•¿åº¦å­—æ®µï¼Œåªæœ‰16ä½ã€‚
<img src="https://wangpengcheng.github.io/img/2019-11-22-20-25-58.png" alt="IPv4é¦–éƒ¨" /></li>
  <li>IPv6:æ˜¯65575å­—èŠ‚ï¼ŒåŒ…æ‹¬40å­—èŠ‚çš„IPv6é¦–éƒ¨ã€‚å‡€è·é•¿åº¦å æ®16ä½(ä¸åŒ…æ‹¬IPv6é¦–éƒ¨)ã€‚ç‰¹å¤§å‡€è·å¯ä»¥å°†å‡€è·å­—æ®µæ‰©å±•åˆ°32ä½ï¼Œä½†æ˜¯éœ€è¦MTU(æœ€å¤§ä¼ è¾“å•å…ƒ)è¶…è¿‡65535çš„æ•°æ®é“¾è·¯æä¾›æ”¯æŒã€‚
<img src="https://wangpengcheng.github.io/img/2019-11-22-20-26-42.png" alt="IPv6é¦–éƒ¨" /></li>
  <li>MTU:ç½‘ç»œç¡¬ä»¶è§„å®šï¼Œä»¥å¤ªç½‘çš„MTUæ˜¯1500å­—èŠ‚ã€‚IPv4æœ€å°ä¸º68å­—èŠ‚ï¼ŒIPv6æœ€å°ä¸º1280å­—èŠ‚ã€‚</li>
  <li>æœ€å°é‡ç»„ç¼“å†²åŒºï¼šIPv4æˆ–IPv6çš„ä»»ä½•å®ç°éƒ½å¿…é¡»ä¿è¯æ”¯æŒçš„æœ€å°æ•°æ®æŠ¥å¤§å°ï¼›IPv4-576;IPv6-1500å­—èŠ‚ã€‚</li>
  <li>MSS(æœ€å¤§åˆ†èŠ‚å¤§å°):TCPä¸­é€šå‘Šå¯¹ç«¯åœ¨æ¯ä¸ªåˆ†èŠ‚ä¸­èƒ½å‘é€çš„æœ€å¤§TCPæ•°æ®é‡ï¼›ä»è€Œé¿å…åˆ†ç‰‡ï¼›å…¶ç»å¸¸è®¾ç½®ä¸ºMTUå‡å»IPå’ŒTCPé¦–éƒ¨çš„å›ºå®šé•¿åº¦ã€‚MSSå€¼æ˜¯ä¸€ä¸ª16ä½çš„å­—æ®µï¼Œé™å®š å…¶æœ€å¤§å€¼ä¸º65535.ä½†æ˜¯åœ¨IPv6ä¸­MSSåŸºæœ¬æ— æ•ˆã€‚</li>
  <li>SCTPåˆ°å¯¹ç«¯æ‰€æœ‰åœ°å€å‘ç°çš„æœ€å°è·¯å¾„MTUä¿æŒä¸€ä¸ªåˆ†ç‰‡ç‚¹ã€‚è¿™ä¸ªæœ€å°MTUå¤§å°ç”¨äºæŠŠè¾ƒå¤§çš„ç”¨æˆ·æ¶ˆæ¯åˆ†å‰²æˆè¾ƒå°çš„èƒ½å¤Ÿä»¥æŒ‰ä¸ªIPæ•°æ®æŠ¥å‘é€çš„è‹¥å¹²ç‰‡æ®µã€‚</li>
</ul>

<p>TCPè¾“å‡ºæ­¥å¥å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-01-47.png" alt="TCPå¥—æ¥å­—æ­¥å¥" /></p>

<p>UDPè¾“å‡ºæ­¥å¥å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-02-50.png" alt="UDPè¾“å‡ºæ­¥å¥" /></p>

<p>SCTPè¾“å‡ºå¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-03-31.png" alt="SCTPè¾“å‡º" /></p>

<h3 id="213-å¸¸è§çš„å› ç‰¹ç½‘åº”ç”¨çš„åè®®ä½¿ç”¨">2.13 å¸¸è§çš„å› ç‰¹ç½‘åº”ç”¨çš„åè®®ä½¿ç”¨</h3>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-05-11.png" alt="å¸¸è§ç½‘ç»œåè®®" /></p>

<h1 id="ç¬¬äºŒéƒ¨åˆ†-åŸºæœ¬å¥—æ¥å­—">ç¬¬äºŒéƒ¨åˆ† åŸºæœ¬å¥—æ¥å­—</h1>

<h2 id="ç¬¬ä¸‰ç« -å¥—æ¥å­—ç¼–ç¨‹ç®€ä»‹">ç¬¬ä¸‰ç«  å¥—æ¥å­—ç¼–ç¨‹ç®€ä»‹</h2>

<p>å‡ ä¹æ¯ä¸€ä¸ªä¾‹å­éƒ½ç”¨åˆ°äº†å¥—æ¥å­—åœ°å€ç»“æ„. è¿™äº›ç»“æ„å¯ä»¥åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šä¼ é€’: ä» è¿›ç¨‹åˆ°å†…æ ¸ å’Œ å†…æ ¸åˆ°è¿›ç¨‹ .</p>

<p>åœ°å€è½¬æ¢å‡½æ•°åœ¨<strong>åœ°å€çš„æ–‡æœ¬è¡¨è¾¾</strong> å’Œä»–ä»¬å­˜æ”¾åœ¨<strong>å¥—æ¥å­—åœ°å€ç»“æ„ä¸­çš„äºŒè¿›åˆ¶ä¹‹é—´</strong>è¿›è¡Œè½¬æ¢</p>
<ul>
  <li>inet_addr/inet_ntoa é€‚ç”¨äºIPv4</li>
  <li>inet_npton/inet_ntop é€‚ç”¨äºIPv4/IPv6</li>
</ul>

<h3 id="32-å¥—æ¥å­—çš„åœ°å€ç»“æ„">3.2 å¥—æ¥å­—çš„åœ°å€ç»“æ„</h3>

<p>å¥—æ¥å­—åœ°å€ç»“æ„åœ¨ç»™å®šä¸»æœºä¸Šä½¿ç”¨:<strong>è™½ç„¶å…¶å®šä¹‰äº†æŸäº›å­—æ®µç”¨äºä¸åŒä¸»æœºé—´è¿›è¡Œé€šä¿¡,ä½†æ˜¯ç»“æ„ä½“æœ¬èº«å¹¶ä¸åœ¨ä¸»æœºé—´è¿›è¡Œä¼ é€’</strong></p>

<h4 id="321-ipv4å¥—æ¥å­—åœ°å€ç»“æ„">3.2.1 IPv4å¥—æ¥å­—åœ°å€ç»“æ„</h4>

<p>å…¶åœ°å€ç»“æ„åœ¨<code class="language-plaintext highlighter-rouge">&lt;netinet/in.h&gt;</code>ä¸­å®šä¹‰å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IPv4å¥—æ¥å­—åœ°å€ç»“æ„ï¼šsockaddr_in</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="k">struct</span> <span class="n">in_addr</span> <span class="p">{</span>
    <span class="n">in_addr_t</span>       <span class="n">s_addr</span><span class="p">;</span>         <span class="cm">/* 32bit IPv4 address. */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
    <span class="kt">uint8_t</span>         <span class="n">sin_len</span><span class="p">;</span>        <span class="cm">/* length of structure (16) */</span>
    <span class="n">sa_family_t</span>     <span class="n">sin_family</span><span class="p">;</span>     <span class="cm">/* AF_INET */</span>
    <span class="n">in_port_t</span>       <span class="n">sin_port</span><span class="p">;</span>       <span class="cm">/* 16bit TCP/UDP port number */</span>
    <span class="k">struct</span> <span class="n">in_addr</span>  <span class="n">sin_addr</span><span class="p">;</span>       <span class="cm">/* 32bit IPv4 address */</span>
    <span class="kt">char</span>            <span class="n">sin_zero</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>    <span class="cm">/* unused */</span> 
<span class="p">};</span>

</code></pre></div></div>
<p><strong>æ³¨æ„ï¼šin_zero æœªä½¿ç”¨,æˆ‘ä»¬åº”è¯¥æŠŠå®ƒç½®ä½0,æŒ‰ç…§æƒ¯ä¾‹æˆ‘ä»¬åº”è¯¥å…ˆæŠŠç»“æ„ä½“ç½®ä½0,è€Œä¸æ˜¯å•å•æŠŠsin_zeroç½®ä½0</strong></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-17-20.png" alt="POSIXè§„èŒƒ" /></p>

<h4 id="322-pv6å¥—æ¥å­—åœ°å€ç»“æ„-sockaddr_in6">3.2.2 Pv6å¥—æ¥å­—åœ°å€ç»“æ„: <code class="language-plaintext highlighter-rouge">sockaddr_in6</code></h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//IPv6å¥—æ¥å­—åœ°å€ç»“æ„ï¼šsockaddr_in6</span>
<span class="cp">#include &lt;netinet/in.h&gt;
</span>
<span class="k">struct</span> <span class="n">in6_addr</span> <span class="p">{</span>
    <span class="kt">uint8_t</span>         <span class="n">s6_addr</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>    <span class="cm">/* 128bit IPv6 address */</span>
<span class="p">};</span>

<span class="cp">#define SIN6_LEN
</span><span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="p">{</span>
    <span class="kt">uint8_t</span>         <span class="n">sin6_len</span><span class="p">;</span>       <span class="cm">/* length of structure (28) */</span>
    <span class="n">sa_family_t</span>     <span class="n">sin6_family</span><span class="p">;</span>    <span class="cm">/* AF_INET6 */</span>
    <span class="n">in_port_t</span>       <span class="n">sin6_port</span><span class="p">;</span>      <span class="cm">/* transport layer port */</span>
    <span class="kt">uint32_t</span>        <span class="n">sin6_flowinfo</span><span class="p">;</span>  <span class="cm">/* flow information, undefined */</span>
    <span class="k">struct</span> <span class="n">in6_addr</span> <span class="n">sin6_addr</span><span class="p">;</span>      <span class="cm">/* IPv6 address */</span>
    <span class="kt">uint32_t</span>        <span class="n">sin6_scope_id</span><span class="p">;</span>  <span class="cm">/* set of interfaces for a scope */</span>
<span class="p">};</span>

</code></pre></div></div>
<ul>
  <li>sin6_flowinfoå­—æ®µåˆ†ä¸º:
    <ul>
      <li>ä½åº20ä½æ˜¯æµæ ‡(flow label)</li>
      <li>é«˜åº12ä½ä¿ç•™</li>
    </ul>
  </li>
</ul>

<h4 id="323-é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„sockaddr">3.2.3 é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„<code class="language-plaintext highlighter-rouge">sockaddr</code></h4>

<p>ä½¿ç”¨é€šç”¨ç»“æ„ï¼Œé™ä½IPv4å’ŒIPv6æ“ä½œæ–¹æ³•çš„è€¦åˆã€‚å¥—æ¥å­—å‡½æ•°è¢«å®šä¹‰ä¸ºä»¥æŒ‡å‘æŸä¸ª<strong>é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„</strong>çš„æŒ‡é’ˆä½œä¸ºå…¶å‚æ•°ä¹‹ä¸€,ä¾‹å¦‚bindå‡½æ•°ï¼š<code class="language-plaintext highlighter-rouge">int bind(int, struct sockaddr*, socklen_t)</code>(æ³¨æ„ç¬¬äºŒä¸ªå‚æ•°ä¸ºé€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„)</p>

<p>å› æ­¤å¯¹è¿™äº›å‡½æ•°çš„è°ƒç”¨éƒ½å¿…é¡»æŠŠæŒ‡å‘ç‰¹å®šåè®®çš„åœ°å€ç»“æ„è¿›è¡Œå¼ºåˆ¶è½¬æ¢ã€‚å¦‚ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">bind</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">serv</span><span class="p">,</span> <span class="n">sizeif</span><span class="p">(</span><span class="n">serv</span><span class="p">));</span>
</code></pre></div></div>
<p>é€šç”¨ç»“æ„ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„ï¼šsockaddr</span>
<span class="cp">#include &lt;sys/socket.h&gt;
</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="p">{</span>
	<span class="kt">uint8_t</span>         <span class="n">sa_len</span><span class="p">;</span>         <span class="cm">/* length of structure */</span>
	<span class="n">sa_family_t</span>     <span class="n">sa_family</span><span class="p">;</span>      <span class="cm">/* address family: AF_XXXX value */</span>
	<span class="kt">char</span>            <span class="n">sa_data</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>    <span class="cm">/* protocol-specific address */</span>
<span class="p">};</span>
</code></pre></div></div>
<ul>
  <li>æ–°çš„é€šç”¨å¥—æ¥å­—åœ°å€ç»“æ„: <code class="language-plaintext highlighter-rouge">sockaddr_storage</code>
    <ul>
      <li>ç‰¹ç‚¹:
        <ul>
          <li>æ‰€è¿‡ç³»ç»Ÿæ”¯æŒå¾—ä»»ä½•å¥—æ¥å­—åœ°å€ç»“æ„æœ‰å¯¹é½éœ€æ±‚,é‚£<code class="language-plaintext highlighter-rouge">sockaddr_storage</code>æ»¡è¶³æœ€ä¸¥æ ¼å¾—å¯¹é½éœ€æ±‚</li>
          <li><code class="language-plaintext highlighter-rouge">sockaddr_storage</code>è¶³å¤Ÿå¤§,æ³¨æ„å®¹çº³ç³»ç»Ÿæ”¯æŒå¾—ä»»ä½•å¥—æ¥å­—åœ°å€ç»“æ„</li>
          <li>å‡ºäº†<code class="language-plaintext highlighter-rouge">ss_familly</code>å’Œ<code class="language-plaintext highlighter-rouge">ss_len</code>å¤–<code class="language-plaintext highlighter-rouge">sockaddr_storage</code>ç»“æ„ä¸­å¾—å…¶ä»–å­—æ®µå¯¹ç”¨æˆ·éƒ½æ˜¯é€æ˜å¾—</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>å…¶åœ°å€ç»“æ„å¦‚ä¸‹</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netinet/in.h&gt;
</span><span class="k">struct</span> <span class="n">sockaddr_strorage</span> <span class="p">{</span>
    <span class="kt">uint8_t</span>         <span class="n">ss_len</span><span class="p">;</span>         <span class="cm">/* length of structure */</span>
    <span class="n">sa_family_t</span>     <span class="n">ss_family</span><span class="p">;</span>      <span class="cm">/* address family: AF_XXXX value */</span>
<span class="p">};</span>
</code></pre></div></div>
<p>ç›¸å…³å¥—æ¥å­—æ¯”è¾ƒå‚æ•°å¦‚ä¸‹ï¼š
<img src="https://img-blog.csdnimg.cn/20191019144530405.png#pic_center" alt="å¥—æ¥å­—ç»“æ„æ¯”è¾ƒ" /></p>

<h3 id="33-å€¼ç»“æœå‚æ•°">3.3 å€¼ç»“æœå‚æ•°</h3>

<p>å†…æ ¸å’Œè¿›ç¨‹ä¹‹é—´çš„ç›¸äº’å¤åˆ¶</p>

<ul>
  <li>ä»è¿›ç¨‹åˆ°å†…æ ¸ä¼ é€’å¥—æ¥å­—åœ°å€ç»“æ„çš„å‡½æ•°æœ‰3ä¸ª:bind,connect, sendto,è¿™äº›å‡½æ•°çš„å‚æ•°æ˜¯æŒ‡å‘æŸä¸ªå¥—æ¥å­—åœ°å€ç»“æ„çš„æŒ‡é’ˆ,å¦ä¸€ä¸ªå‚æ•°æ˜¯è¯¥ç»“æ„çš„æ•´æ•°å¤§å°,æ—¢ç„¶æŒ‡é’ˆå’ŒæŒ‡é’ˆæ‰€æŒ‡çš„å†…å®¹çš„å¤§å°éƒ½ä¼ é€’ç»™äº†å†…æ ¸,äºæ˜¯å†…æ ¸çŸ¥é“éœ€è¦ä»è¿›ç¨‹å¤åˆ¶å¤šå°‘æ•°æ®</li>
  <li>ä»å†…æ ¸åˆ°è¿›ç¨‹ä¼ é€’å¥—æ¥å­—åœ°å€ç»“æ„çš„å‡½æ•°æœ‰4ä¸ª:<code class="language-plaintext highlighter-rouge">accept</code>,<code class="language-plaintext highlighter-rouge">recvfrom</code>,<code class="language-plaintext highlighter-rouge">getsockname</code>,<code class="language-plaintext highlighter-rouge">getpeername</code>,è¿™å››ä¸ªå‡½æ•°çš„å…¶ä¸­ä¸¤ä¸ªå‚æ•°æ˜¯æŒ‡å‘æŸå¥—æ¥å­—åœ°å€ç»“æ„çš„æŒ‡é’ˆ,å’ŒæŒ‡å‘è¯¥å¥—æ¥å­—åœ°å€ç»“æ„çš„å†…å®¹çš„å¤§å°(<strong>æ˜¯ä¸¤ä¸ªæŒ‡é’ˆ,åˆ†åˆ«æŒ‡å‘å¥—æ¥å­—åœ°å€ç»“æ„å’Œå¥—æ¥å­—åœ°å€ç»“æ„çš„å¤§å°</strong>)</li>
</ul>

<p>å½“å‡½æ•°è¢«è°ƒç”¨æ—¶,ç»“æ„å¤§å°æ˜¯ä¸€ä¸ªå€¼(æ­¤å€¼å‘Šè¯‰å†…æ ¸è¯¥ç»“æ„çš„å¤§å°,ä½¿å†…æ ¸åœ¨å†™æ­¤ç»“æ„æ—¶ä¸è‡³äºè¶Šç•Œ),å½“å‡½æ•°è¿”å›æ—¶,ç»“æ„å¤§å°åˆæ˜¯ä¸€ä¸ªç»“æœ(å®ƒå‘Šè¯‰è¿›ç¨‹å†…æ ¸åœ¨æ­¤ç»“æ„ä¸­ç¡®åˆ‡å­˜å‚¨äº†å¤šå°‘ä¿¡æ¯),è¿™ç§å‚æ•°ç±»å‹å«å€¼ç»“æœå‚æ•°ã€‚</p>

<p><img src="https://img-blog.csdnimg.cn/20191021134248765.png#pic_center" alt="å†…æ ¸åˆ°è¿›ç¨‹çš„å¥—æ¥å­—åœ°å€ä¼ é€’" /></p>

<h3 id="34-å­—èŠ‚æ’åºå‡½æ•°">3.4 å­—èŠ‚æ’åºå‡½æ•°</h3>

<p>å…³äºå¤§å°ç«¯ï¼š</p>

<ul>
  <li>å¤§ç«¯ï¼šé«˜å­—èŠ‚æ”¾ä½åœ°å€ï¼Œå¦‚0x0102,å†…å­˜ä¸­æ”¾çš„æ˜¯0x0102</li>
  <li>å°ç«¯ï¼šé«˜å­—èŠ‚æ”¾é«˜åœ°å€ï¼Œä½å­—èŠ‚æ”¾ä½åœ°å€å¦‚0x0102,å†…å­˜ä¸­æ”¾çš„æ˜¯0x0201</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-33-36.png" alt="å¤§ç«¯å­—èŠ‚åº" /></p>

<p><strong>ç½‘é™…åè®®ä½¿ç”¨å¤§ç«¯å­—èŠ‚åºä¼ é€å¤šå­—èŠ‚æ•´æ•°</strong>ï¼›ç½‘ç»œåè®®ä¸­çš„å­—èŠ‚åºå‡½æ•°å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;netinet/in h&gt;
</span><span class="kt">uint16_t</span> <span class="nf">htons</span> <span class="p">(</span><span class="n">uint16t</span> <span class="n">host16bitvalue</span><span class="p">)</span><span class="o">:</span> <span class="c1">//h:host  ä¸»æœºå­—èŠ‚åº</span>
<span class="kt">uint32_t</span> <span class="n">htonl</span> <span class="p">(</span><span class="n">uint32t</span> <span class="n">host32bitvalue</span><span class="p">);</span> <span class="c1">//n:network ç½‘ç»œå­—èŠ‚åº</span>
<span class="kt">uint16_t</span> <span class="nf">ntohs</span> <span class="p">(</span><span class="n">uint16t</span> <span class="n">net16bitvalue</span><span class="p">);</span>  <span class="c1">//s:short</span>
<span class="kt">uint32_t</span> <span class="nf">ntohl</span> <span class="p">(</span><span class="n">uint32t</span> <span class="n">net32bitvalue</span><span class="p">);</span>  <span class="c1">//l:long</span>
</code></pre></div></div>
<h3 id="35-å­—èŠ‚æ“çºµå‡½æ•°">3.5 å­—èŠ‚æ“çºµå‡½æ•°</h3>

<p>æ“ä½œå‡½æ•°æœ‰ä¸‹åˆ—ä¸¤ç§ï¼š</p>

<ul>
  <li>strå¼€å¤´ï¼šå¤„ç†Cå­—ç¬¦ä¸²(å³ä»¥\0ç»“å°¾)</li>
  <li>bå¼€å¤´ï¼šèµ·æºä¸4.2BSD,è¿™é‡Œç»™å‡ºæºè‡ªBerkeleyçš„å‡½æ•°ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">void bzero(void *dest, size_t nbytes)</code>ï¼šæŠŠç›®æ ‡å­—èŠ‚ä¸²ä¸­æŒ‡å®šæ•°ç›®çš„å­—èŠ‚ç½®ä¸º0</li>
      <li><code class="language-plaintext highlighter-rouge">void bcopy(const void *src, void *dest, size_t nbytes)</code>ï¼šå°†æŒ‡å®šæ•°ç›®çš„å­—èŠ‚ä»æºå­—èŠ‚ä¸²ç§»åˆ°ç›®æ ‡å­—èŠ‚ä¸²</li>
      <li><code class="language-plaintext highlighter-rouge">int bcmp(const void *ptrl, const void *ptr2, size_t nbytes)</code>ï¼šæ¯”è¾ƒä¸¤ä¸ªä»»æ„çš„å­—èŠ‚ä¸²ï¼Œè‹¥ç›¸åŒè¿”å›0ï¼Œä¸åŒè¿”å›é0
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;strings.h&gt;
</span><span class="kt">void</span> <span class="nf">bzero</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">bcopy</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">bcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptrl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>mç³»åˆ—ï¼šä»¥memå¼€å¤´ï¼Œæ˜¯ANSI Cæ ‡å‡†ä¸­çš„å­—èŠ‚æ“ä½œå‡½æ•°ï¼Œcä¸­éƒ½ä½¿ç”¨ï¼š
    <ul>
      <li><code class="language-plaintext highlighter-rouge">void *memset(void *dest, int c, size_t len)</code>:æŠŠç›®æ ‡å­—ç¬¦ä¸²æŒ‡å®šæ•°ç›®çš„å­—èŠ‚ç½®ä¸ºc</li>
      <li><code class="language-plaintext highlighter-rouge">void *memcpy(void *dest, const void *src, size_t nbytes)</code>:ç±»ä¼¼bcopyï¼Œä¸è¿‡ä¸¤ä¸ªæŒ‡é’ˆå‚æ•°çš„é¡ºåºç›¸åã€‚<strong>å½“æºå­—èŠ‚ä¸²ä¸ç›®æ ‡å­—èŠ‚ä¸²é‡å æ—¶ï¼Œbcopyèƒ½å¤Ÿæ­£ç¡®å¤„ç†ï¼Œä½†æ˜¯memcpyçš„æ“ä½œç»“æœå´ä¸å¯çŸ¥</strong>ã€‚è¿™ç§æƒ…å½¢ä¸‹å¿…é¡»è¯¥ç”¨ANSI Cçš„memmoveå‡½æ•°ã€‚</li>
      <li><code class="language-plaintext highlighter-rouge">int memcmp(const void *ptr1, const void *ptr2, size_t nbytes)</code>ï¼šæ¯”è¾ƒä¸¤ä¸ªä»»æ„çš„å­—èŠ‚ä¸²ï¼Œè‹¥ç›¸åŒè¿”å›0ï¼Œå¦åˆ™è¿”å›ä¸€ä¸ªé0å€¼ã€‚
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;string.h&gt;
</span><span class="kt">void</span> <span class="o">*</span><span class="nf">memset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">memcpy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">memcmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr2</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">);</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<h3 id="36-inet_atonå’Œinet_addrå’Œinet_ntoaå‡½æ•°">3.6 inet_atonå’Œinet_addrå’Œinet_ntoaå‡½æ•°</h3>
<p>ä»–ä»¬éƒ½æ˜¯å°†åè¿›åˆ¶æ•°ä¸²(â€œ206.168.112.96â€)IPv4åœ°å€è½¬æ¢ä¸º32ä½ç½‘ç»œå­—èŠ‚åºäºŒè¿›åˆ¶</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;arpa/inet.h&gt;
</span><span class="cm">/* æœ‰æ•ˆè¿”å›1ï¼Œå¦åˆ™ä¸º0 */</span>
<span class="kt">int</span> <span class="nf">inet_aton</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">,</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="o">*</span><span class="n">addrptr</span><span class="p">);</span>
<span class="cm">/* è¿”å›æœ‰æ•ˆåœ°å€ï¼Œå¦åˆ™è¿”å› INADDR_NONE--å·²åºŸå¼ƒ */</span>
<span class="n">in_addr_t</span> <span class="nf">inet_addr</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">);</span>
<span class="cm">/* å°†äºŒè¿›åˆ¶åœ°å€è½¬åŒ–ä¸º10è¿›åˆ¶å­—ç¬¦ä¸² */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">inet_ntoa</span><span class="p">(</span><span class="k">struct</span> <span class="n">in_addr</span> <span class="n">inaddr</span><span class="p">);</span>
</code></pre></div></div>
<h3 id="37-inet_ptonå’Œinet_ntopå‡½æ•°æ¨èä½¿ç”¨">3.7 inet_ptonå’Œinet_ntopå‡½æ•°(æ¨èä½¿ç”¨)</h3>

<p>è¿™ä¸ªä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯å®ç°ipåœ°å€ç‚¹åˆ†åè¿›åˆ¶æ ¼å¼å’ŒäºŒè¿›åˆ¶æ ¼å¼çš„ç›¸äº’è½¬æ¢ã€‚<code class="language-plaintext highlighter-rouge">p</code>æŒ‡è¡¨è¾¾å¼, <code class="language-plaintext highlighter-rouge">n</code>æŒ‡æ•°å€¼,åœ°å€çš„è¡¨è¾¾æ ¼å¼é€šå¸¸æ˜¯ASCIIå­—ç¬¦ä¸²,è€Œåœ¨å¥—æ¥å­—åœ°å€ç»“æ„ä¸­è¿™æ˜¯äºŒè¿›åˆ¶å€¼ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">int inet_pton(int family, const char *strptr, void *addrptr)</code>: å°è¯•è½¬æ¢ç”±strptræŒ‡é’ˆæ‰€æŒ‡çš„å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡addrptræŒ‡é’ˆå­˜æ”¾äºŒè¿›åˆ¶ç»“æœã€‚
    <ul>
      <li><code class="language-plaintext highlighter-rouge">family:AF_INETæˆ–AF_INET6</code></li>
      <li>è¿”å›ï¼š1ï¼ˆæˆåŠŸï¼‰ 0ï¼ˆä¸æ˜¯æœ‰æ•ˆæ ¼å¼ï¼‰ -1ï¼ˆå‡ºé”™ï¼‰</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">onst char *inet_ntop(int family, const void *addrptr, char *strptr, size_t len)</code>ï¼š<strong>inet_ntopè¿›è¡Œç›¸åçš„è½¬æ¢ï¼Œä»æ•°å€¼æ ¼å¼ï¼ˆaddrptrï¼‰è½¬æ¢åˆ°è¡¨è¾¾æ ¼å¼ï¼ˆstrptrï¼‰ã€‚lenå‚æ•°æ˜¯ç›®æ ‡å­˜å‚¨å•å…ƒçš„å¤§å°ï¼Œä»¥å…è¯¥å‡½æ•°æº¢å‡ºå…¶è°ƒç”¨è€…çš„ç¼“å†²åŒºã€‚</strong>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">family:AF_INETæˆ–AF_INET6</code></li>
      <li>æŒ‡å®š<code class="language-plaintext highlighter-rouge">size_t</code>é˜²æ­¢æº¢å‡ºï¼š
        <ul>
          <li><code class="language-plaintext highlighter-rouge">#define INET_ADDRSTRLEN 16</code></li>
          <li><code class="language-plaintext highlighter-rouge">#define INET6_ADDRSTRLEN 46</code></li>
        </ul>
      </li>
      <li>è¿”å›ï¼šç»“æœæŒ‡é’ˆï¼ˆæˆåŠŸï¼‰ NULLï¼ˆå¤±è´¥ï¼‰
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;arpa/inet.h&gt;
</span><span class="kt">int</span> <span class="nf">inet_pton</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addrptr</span><span class="p">);</span>
<span class="c1">//è¿”å›ï¼š1ï¼ˆæˆåŠŸï¼‰ 0ï¼ˆä¸æ˜¯æœ‰æ•ˆæ ¼å¼ï¼‰ -1ï¼ˆå‡ºé”™ï¼‰</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">inet_ntop</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addrptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">);</span>
<span class="c1">//è¿”å›ï¼šç»“æœæŒ‡é’ˆï¼ˆæˆåŠŸï¼‰ NULLï¼ˆå¤±è´¥ï¼‰</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-11-22-21-54-12.png" alt="ç›¸å…³åœ°å€è½¬æ¢" /></p>

<h3 id="38-sock_notopå’Œç›¸å…³å‡½æ•°">3.8 sock_notopå’Œç›¸å…³å‡½æ•°</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// IPv4</span>
<span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">addr</span><span class="p">;</span>
<span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
<span class="c1">// IPv6</span>
<span class="k">struct</span> <span class="n">sockaddr_in6</span> <span class="n">addr6</span><span class="p">;</span>
<span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr6</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">));</span>
</code></pre></div></div>
<p>inet_ntopéœ€è¦çŸ¥é“åœ°å€æ—, åœ°å€ç»“æ„ä¸­çš„äºŒè¿›åˆ¶åœ°å€æŒ‡é’ˆ;ä»¥ä¸Šè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒç¹ççš„,ä¸ºäº†ç®€ä¾¿èµ·è§,æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">char *sock_ntop(const struct sockaddr *sockaddr, socklen_t addrlen)</code>å‡½æ•°, å®ƒçš„å‚æ•°ä¸º:</p>
<ul>
  <li><strong>å¥—æ¥å­—åœ°å€ç»“æ„æŒ‡é’ˆ</strong></li>
  <li><strong>å¥—æ¥å­—åœ°å€ç»“æ„çš„é•¿åº¦</strong></li>
</ul>

<p>å…³é”®ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* include sock_ntop */</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">sock_ntop</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">salen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span>        <span class="n">portstr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>       <span class="cm">/* Unix domain is largest */</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">sa</span><span class="o">-&gt;</span><span class="n">sa_family</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">AF_INET</span><span class="p">:</span> <span class="p">{</span>
        <span class="c1">//å°†æŒ‡é’ˆè½¬æ¢ä¸ºIPv4åœ°å€ç»“æ„</span>
        <span class="k">struct</span> <span class="n">sockaddr_in</span>  <span class="o">*</span><span class="n">sin</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="o">*</span><span class="p">)</span> <span class="n">sa</span><span class="p">;</span>
        <span class="c1">//åœ°å€è½¬æ¢ï¼šæˆåŠŸåˆ™è¿”å›cå­—ç¬¦ä¸²å½¢å¼çš„IPåœ°å€ï¼ŒstræŒ‡å®šè½¬æ¢æ ¼å¼</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inet_ntop</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_addr</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">str</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="k">return</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="c1">//å­—èŠ‚æ’åºï¼šç½‘ç»œè½¬æ¢ä¸ºä¸»æœºçš„å­—èŠ‚åº</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">portstr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">portstr</span><span class="p">),</span> <span class="s">":%d"</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">sin</span><span class="o">-&gt;</span><span class="n">sin_port</span><span class="p">));</span>
            <span class="n">strcat</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">portstr</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">(</span><span class="n">portstr</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="39-readnwritenå’Œreadline-å‡½æ•°">3.9 readnã€writenå’Œreadline å‡½æ•°</h3>

<p>å­—èŠ‚æµå¥—æ¥å­—(å¦‚TCPå¥—æ¥å­—)ä¸Šçš„readå’Œwriteå‡½æ•°æ‰€è¡¨ç°çš„è¡Œä¸ºä¸åŒäºé€šå¸¸çš„æ–‡ä»¶I/O.å­—èŠ‚æµå¥—æ¥å­—ä¸Šè°ƒç”¨çš„readå’Œwriteè¾“å…¥å’Œè¾“å‡ºçš„å­—èŠ‚æ•°å¯èƒ½æ¯”è¯·æ±‚ï¼Œçš„æ•°é‡å°‘,è¿™å¹¶ä¸æ˜¯å‡ºé”™. <strong>åŸå› æ˜¯å†…æ ¸ä¸­ç”¨äºå¥—æ¥å­—çš„ç¼“å†²åŒºå¯èƒ½å·²ç»è¾¾åˆ°æé™äº†.</strong>æ­¤æ—¶éœ€è¦è°ƒç”¨è€…å†æ¬¡è°ƒç”¨readå’Œwriteå‡½æ•°ï¼Œå¯¹å‰©ä½™çš„è¿›è¡Œæ“ä½œã€‚
ä¸ºäº†ä»¥é˜²ä¸‡ä¸€, ä¸è®©å®ç°è¿”å›ä¸è¶³çš„å­—èŠ‚,ä½¿ç”¨writenå’Œreadnæ¥æ”¹è¿›å‡½æ•°ã€‚</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">ssize_t readn(int filedes, void *buff, size_t nbytes)</code>:è¿”å›: è¯»å…¥å­—èŠ‚æ•°, å‡ºé”™è¿”å›1</li>
  <li><code class="language-plaintext highlighter-rouge">ssize_t written(int filedes, void *buff, size_t nbytes)</code>:è¿”å›: å†™å…¥å­—èŠ‚æ•°, å‡ºé”™è¿”å›1</li>
  <li><code class="language-plaintext highlighter-rouge">ssize_t readline(int filedes, void *buff, size_t maxlen)</code>:åå›,è¯»å…¥å­—èŠ‚æ•°, å‡ºé”™è¿”å›1ã€‚<strong>æ³¨æ„ï¼š<code class="language-plaintext highlighter-rouge">readline</code>éå¸¸ä½æ•ˆ,å…¶æ¯è¯»ä¸€ä¸ªå­—èŠ‚ å°±è°ƒç”¨ä¾æ¬¡ç³»ç»Ÿreadå‡½æ•°</strong></li>
</ul>

<p>readnçš„åŸºæœ¬å®ç°å¦‚ä¸‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">ssize_t</span>                     <span class="cm">/* Read "n" bytes from a descriptor. */</span>
<span class="n">readn</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">vptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span>  <span class="n">nleft</span><span class="p">;</span>
    <span class="kt">ssize_t</span> <span class="n">nread</span><span class="p">;</span>
    <span class="kt">char</span>    <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

    <span class="n">ptr</span> <span class="o">=</span> <span class="n">vptr</span><span class="p">;</span>
    <span class="n">nleft</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">nleft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//å¦‚æœè¯»å–å¤±è´¥</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">nread</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">nleft</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span> <span class="cm">/* æŸ¥æ‰¾EINTRé”™è¯¯ï¼Œè¡¨ç¤ºç³»ç»Ÿè¢«ä¸€ä¸ªæ•è·ä¿¡å·ä¸­æ–­ */</span>
                <span class="n">nread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* and call read() again */</span>
            <span class="k">else</span>
                <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="c1">//å¦‚æœè¯»æˆåŠŸäº†    </span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>              <span class="cm">/* EOF */</span>
        <span class="c1">//è®¡ç®—æ¼è¯»çš„å­—èŠ‚æ•°ï¼Œå†è¯»æ–‡ä»¶</span>
        <span class="n">nleft</span> <span class="o">-=</span> <span class="n">nread</span><span class="p">;</span>
        <span class="n">ptr</span>   <span class="o">+=</span> <span class="n">nread</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">nleft</span><span class="p">);</span>      <span class="cm">/* return &gt;= 0 */</span>
<span class="p">}</span>
<span class="cm">/* end readn */</span>
</code></pre></div></div>
<p>stdioç¼“å†²çŠ¶æ€æ˜¯ä¸å¯è§çš„ï¼Œä¸èƒ½è¢«ç”¨äºä»£æ›¿readline.åŸºäºæ–‡æœ¬è¡Œçš„ç½‘ç»œåè®®(å¦‚SMTP,HTTP,FTPæ§åˆ¶é“¾æ¥åè®®)ï¼›æ·«è¡å°½é‡ä¾ç…§ç¼“å†²åŒºè€Œä¸æ˜¯æ–‡æœ¬è¡Œçš„è¦æ±‚æ¥è€ƒè™‘ç¼–ç¨‹ã€‚ä¸‹é¢å®šä¹‰ä¸€ä¸ªç®€å•çš„readlineå‡½æ•°æ”¹è¿›;ä¸»è¦æ˜¯ä½¿ç”¨</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span><span class="cm">/* å®šä¹‰è¯»å–æ¬¡æ•° */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">read_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">read_ptr</span><span class="p">;</span>
<span class="cm">/* å®šä¹‰è¯»å–buf */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">read_buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
<span class="cm">/* è¯»å–å‡½æ•° */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">my_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">read_cnt</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">){</span>
        <span class="nl">again:</span>
            <span class="k">if</span><span class="p">((</span><span class="n">read_cnt</span><span class="o">==</span><span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="n">read_buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">read_buf</span><span class="p">)))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span><span class="cm">/* è¿›è¡Œä¸€æ¬¡è¯»å– */</span>
                <span class="k">if</span><span class="p">(</span><span class="n">errno</span><span class="o">==</span><span class="n">EINTER</span><span class="p">)</span>
                    <span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">read_cnt</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
                <span class="k">return</span> <span class="mi">0</span><span class="err">ï¼›</span>
            <span class="p">}</span>
            <span class="n">read_ptr</span><span class="o">=</span><span class="n">read_buf</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">read_cnt</span><span class="o">--</span><span class="p">;</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">=*</span><span class="n">read</span><span class="o">+</span><span class="n">ptr</span><span class="o">++</span><span class="p">;</span><span class="cm">/* é‡ç½®ç©ºæŒ‡é’ˆ */</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">ssize_t</span> <span class="nf">readline</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">vptr</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">ssize_t</span> <span class="n">n</span><span class="p">,</span><span class="n">rc</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span><span class="p">,</span><span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
    <span class="n">ptr</span><span class="o">=</span><span class="n">vptr</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">n</span><span class="o">&lt;</span><span class="n">maxlen</span><span class="p">;</span><span class="n">n</span><span class="o">++</span><span class="p">){</span>
        <span class="k">if</span><span class="p">((</span><span class="n">rc</span><span class="o">=</span><span class="n">my_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">c</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)){</span>
            <span class="o">*</span><span class="n">ptr</span><span class="o">++=</span><span class="n">c</span><span class="p">;</span><span class="cm">/*å°†å­—ç¬¦æŒ‡é’ˆæŒ‡å‘c*/</span>
            <span class="k">if</span><span class="p">(</span><span class="n">c</span><span class="o">==</span><span class="sc">'\n'</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span><span class="cm">/* æ£€æµ‹åˆ°æ–°è¡Œ */</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">rc</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span>
            <span class="o">*</span><span class="n">ptr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* è¯»å–åˆ°EOFç»“æŸç¬¦ï¼Œç›´æ¥è¿”å› */</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* è¯»å–é”™è¯¯ */</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="cm">/*é‡ç½®æŒ‡é’ˆ*/</span>
    <span class="o">*</span><span class="n">ptr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="cm">/* è¿”å›å¤§å° */</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* ä»ç¼“å†²å–ä¸­è¯»å–æ•°æ® */</span>
<span class="kt">ssize_t</span> <span class="nf">readlinebuf</span><span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="n">vptrptr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">read_cnt</span><span class="p">)</span>
        <span class="o">*</span><span class="n">vptrptr</span><span class="o">=</span><span class="n">read_ptr</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">read_cnt</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/* ç®€å•æ¥è¯´å°±æ˜¯å°†è¯»å–ä¸€ä¸ªå­—ç¬¦ï¼Œè½¬å˜ä¸ºäº†è¯»å–å¤šä¸ªå­—ç¬¦ */</span>
</code></pre></div></div>
<h3 id="ç¬¬-4-ç« -åŸºæœ¬tcpå¥—æ¥å­—ç¼–ç¨‹">ç¬¬ 4 ç«  åŸºæœ¬TCPå¥—æ¥å­—ç¼–ç¨‹</h3>

<p>TCPè¿æ¥è¿‡ç¨‹ä¸­åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-23-15-32-46.png" alt="TCPæœåŠ¡å…¶å¥—æ¥å­—è¿‡ç¨‹" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-23-20-59-19.png" alt="å¥—æ¥å­—ç±»å‹" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-23-21-00-02.png" alt="typeå€¼" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-23-21-00-39.png" alt="ç»„åˆå€¼" /></p>

<h3 id="42-socket">4.2 socket</h3>

<p><code class="language-plaintext highlighter-rouge">int socket(int framily, int type, int protocal)</code>:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">framily</code>å‚æ•°è¡¨æ˜åè®®æ—(åè®®åŸŸ),</li>
  <li><code class="language-plaintext highlighter-rouge">type</code>å‚æ•°è¡¨ç¤ºå¥—æ¥å­—ç±»å‹</li>
  <li><code class="language-plaintext highlighter-rouge">protocal</code>è¡¨ç¤ºåè®®ç±»å‹(æˆ–åˆ™è®¾ç½®ä¸º0)</li>
  <li>å¹¶ä¸æ˜¯æ‰€æœ‰çš„<code class="language-plaintext highlighter-rouge">framily</code>å’Œ<code class="language-plaintext highlighter-rouge">type</code>çš„ç»„åˆéƒ½æ˜¯æœ‰æ•ˆçš„</li>
  <li><code class="language-plaintext highlighter-rouge">AF_</code>å‰ç¼€è¡¨ç¤ºåœ°å€æ—,<code class="language-plaintext highlighter-rouge">PF_</code>å‰ç¼€è¡¨ç¤ºåè®®æ—</li>
  <li>socketå‡½æ•°çš„è¿”å›å€¼ä¸ºä¸€ä¸ªéè´Ÿæ•´æ•°(å¥—æ¥å­—æè¿°ç¬¦, sockfd),<strong>å¥—æ¥å­—æè¿°ç¬¦çŸ¥è¯†åˆ¶å®šäº†åè®®æ—å’Œå¥—æ¥å­—ç±»å‹,å¹¶æ²¡æœ‰æŒ‡å®šæœ¬åœ°åè®®æˆ–åˆ™è¿œç¨‹åè®®</strong></li>
</ul>

<h3 id="43-connect-å‡½æ•°">4.3 connect å‡½æ•°</h3>

<p><code class="language-plaintext highlighter-rouge">int connect(int sockfd, const struct sockaddr* servaddr, socklen_t addrlen);</code></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">sockfd</code>:å¥—æ¥å­—æè¿°ç¬¦</li>
  <li>ç¬¬äºŒä¸‰ä¸ªå‚æ•°è¡¨ç¤ºä¸€ä¸ªå¥—æ¥å­—åœ°å€ç»“æ„(å†…éƒ¨æœ‰æœåŠ¡å™¨IP+Port)</li>
  <li>å®¢æˆ·ç«¯åœ¨è°ƒç”¨connectå‰ä¸ä¸€å®šéœ€è¦è°ƒç”¨bindå‡½æ•°ï¼Œå› ä¸ºå¦‚æœéœ€è¦çš„è¯ï¼Œå†…æ ¸ä¼šç¡®å®šæºIPåœ°å€ï¼Œå¹¶é€‰æ‹©ä¸€ä¸ªä¸´æ—¶ç«¯å£ä½œä¸ºæºç«¯å£</li>
  <li><strong>å‡ºé”™çš„æƒ…å†µ:</strong>
    <ul>
      <li>TCPå®¢æˆ·æ²¡æœ‰æ”¶åˆ°SYNåˆ†èŠ‚çš„å“åº”ï¼Œè¿”å›<code class="language-plaintext highlighter-rouge">ETIMEOUT</code>é”™è¯¯ï¼Œå¦‚å¾€æœ¬åœ°å­ç½‘ä¸Šä¸€ä¸ªä¸å­˜åœ¨çš„IPå‘é€SYN</li>
      <li>ç¡¬é”™è¯¯ï¼šæ”¶åˆ°RST(è¡¨ç¤ºå¤ä½)ï¼Œè¯¥æœåŠ¡å™¨ä¸»æœºåœ¨æŒ‡å®šçš„ç«¯å£ä¸Šï¼Œæ²¡æœ‰è¿›ç¨‹åœ¨ç­‰å¾…ä¸ä¹‹é“¾æ¥(æœåŠ¡å™¨æ²¡æœ‰è¿è¡Œ)ã€‚å®¢æˆ·ç«¯æ”¶åˆ°RSTç«‹åˆ»è¿”å›<code class="language-plaintext highlighter-rouge">ECONNREFUSED</code>é”™è¯¯ã€‚äº§ç”ŸRSTçš„å¯èƒ½æ¡ä»¶å¦‚ä¸‹ï¼š
        <ul>
          <li>ç›®çš„åœ°ä¸ºæŸç«¯å£çš„SYNåˆ°è¾¾ï¼Œç„¶è€Œç«¯å£ä¸Šæ²¡æœ‰æ­£åœ¨ç›‘å¬çš„æœåŠ¡å™¨ï¼›</li>
          <li>TCPæƒ³å–æ¶ˆä¸€ä¸ªå·²æœ‰è¿æ¥ï¼›</li>
          <li>TCPæ¥æ”¶åˆ°ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„è¿æ¥ä¸Šçš„åˆ†èŠ‚.</li>
        </ul>
      </li>
      <li>è½¯é”™è¯¯: å‘é€SYNåˆ†èŠ‚å¼•å‘è·¯ç”±å™¨â€œdestination unreachableâ€(ç›®çš„åœ°ä¸å¯è¾¾)ï¼›ICMPé”™è¯¯ã€‚</li>
    </ul>
  </li>
</ul>

<h3 id="44-bindå‡½æ•°">4.4 bindå‡½æ•°</h3>

<p>æœ¬åœ°æ´—è¡£åœ°å€èµ‹äºˆä¸€ä¸ªå¥—æ¥å­—ï¼Œå¯¹äºç½‘é™…åè®®æ¥è¯´ï¼Œæ˜¯å°†IPåœ°å€ä¸TCPæˆ–UDPçš„ç«¯å£å·è¿›è¡Œç»„åˆã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span><span class="kt">int</span> <span class="nf">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">myaddr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
<span class="c1">//æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1</span>
</code></pre></div></div>

<ul>
  <li>æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ï¼Œè‹¥æœªç»‘å®šç«¯å£;å†…æ ¸ä¼šé€‰æ‹©ä¸€ä¸ªä¸´æ—¶çš„ç«¯å£(å®¢æˆ·ç«¯)ã€‚æœåŠ¡å™¨ä¸€èˆ¬ä¸ä¼šã€‚ä½†æ˜¯åœ¨RPCæœåŠ¡å™¨ä¸­ä¼šç›‘å¬ç«¯å£ï¼Œåˆ›å»ºè‡ªå·±çš„ä¸´æ—¶ç«¯å£ã€‚</li>
  <li>TCPå®¢æˆ·ç«¯ä¸€èˆ¬ä¸ä¼šç»‘å®šç«¯å£ï¼Œå› ä¸ºè¿™æ ·ä¼šé™å®šè¯¥å¥—æ¥å­—åªèƒ½ä»æŒ‡å®šç«¯å£å‘é€ã€‚ä¸€èˆ¬å†…æ ¸ä¼šæ ¹æ®ç›®ç¹IPåœ°å€å’Œç«¯å£ï¼Œé€‰æ‹©æºIPåœ°å€ã€‚</li>
  <li>å¸¸è§é”™è¯¯â€œaddress already in useâ€
<img src="https://wangpengcheng.github.io/img/2019-11-23-21-58-41.png" alt="æŒ‡å®šç«¯å£å…³ç³»" /></li>
</ul>

<h3 id="45-listen-å‡½æ•°">4.5 listen å‡½æ•°</h3>

<p>socketè¢«åˆ›å»ºæ—¶ï¼Œé»˜è®¤ä¸ºä¸€ä¸ªä¸»åŠ¨å¥—æ¥å­—ï¼Œä¸»è¦ä½¿ç”¨connectå‘èµ·è¿æ¥çš„å®¢æˆ·ç«¯å¥—æ¥å­—ã€‚listenå‡½æ•°æŠŠä¸€ä¸ªæœªè¿æ¥çš„å¥—æ¥å­—è½¬æ¢ä¸ºä¸€ä¸ªè¢«åŠ¨å¥—æ¥å­—ã€‚</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span><span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
<span class="c1">//æˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1</span>

</code></pre></div></div>

<p>å‡½æ•°åº”è¯¥åœ¨socketå’Œbindä¹‹åï¼Œacceptå‡½æ•°ä¹‹å‰ã€‚backlogè¡¨ç¤ºæ­£åœ¨è¿æ¥çŠ¶æ€å’Œå®Œå…¨è¿æ¥çŠ¶æ€çš„é˜Ÿåˆ—çš„æœ€å¤§æ•°ç›®å€¼ã€‚
ç›‘å¬å¥—æ¥å­—ç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼šæœªå®Œæˆè¿æ¥é˜Ÿåˆ—ï¼ˆSYN_RCVD)å’Œå·²å®Œæˆè¿æ¥é˜Ÿåˆ—(ESTABLISHED)ï¼›backlogè¦æ±‚è¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¹‹å’Œä¸è¶…è¿‡å®ƒã€‚</p>

<p><strong>å½“ä¸€ä¸ªå®¢æˆ·SYNåˆ°è¾¾æ—¶ï¼Œè‹¥è¿™äº›é˜Ÿåˆ—æ˜¯æ»¡çš„ï¼ŒTCPå°±å¿½ç•¥è¯¥åˆ†èŠ‚ï¼Œä¸å‘é€RST</strong>
<img src="https://wangpengcheng.github.io/img/2019-11-23-22-08-35.png" alt="ç›‘å¬é˜Ÿåˆ—" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-23-22-11-04.png" alt="å…³ç³»" /></p>

<h3 id="46-acceptå‡½æ•°">4.6 acceptå‡½æ•°</h3>

<p>acceptæ‹¥æœ‰ä¸¤ä¸ªå€¼-ç»“æœå‚æ•°ï¼Œcliaddrå’Œaddrlenå¯ä»¥è¿”å›peerç«¯ä¿¡æ¯ï¼Œå¦‚æœä¸å…³å¿ƒï¼Œå¯ä»¥ç½®NULLã€‚</p>

<p>acceptä¸»è¦æ˜¯ä»å·²å®Œæˆè¿æ¥é˜Ÿåˆ—å¤´è¿”å›ä¸‹ä¸€ä¸ªå·²å®Œæˆé“¾æ¥ã€‚å¦‚æœä»¥å®Œæˆä¸ºç©ºï¼Œåˆ™è¿›è¡Œç¡çœ ã€‚</p>

<p>acceptæˆåŠŸæ—¶ä¼šè¿”å›ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„å…¨æ–°æè¿°ç¬¦ï¼Œä»£è¡¨å®¢æˆ·ä¹‹é—´çš„TCPè¿æ¥ï¼Œè¾“å…¥ä¸ºç›‘å¬å¥—æ¥å­—ã€‚è¿”å›ä¸ºå·²è¿æ¥å¥—æ¥å­—</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span><span class="kt">int</span> <span class="nf">accept</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span> <span class="n">cliaddr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
<span class="c1">//æˆåŠŸè¿”å›éè´Ÿæè¿°ç¬¦å·ï¼Œå‡ºé”™è¿”å›-1</span>
</code></pre></div></div>

<h3 id="47-forkå’Œexecå‡½æ•°">4.7 forkå’Œexecå‡½æ•°</h3>

<p>forkå‡½æ•°è°ƒç”¨ä¸€æ¬¡è¿”å›ä¸¤æ¬¡ï¼Œä¸€æ¬¡è¿”å›æ–°æ´¾ç”Ÿè¿›ç¨‹(å­è¿›ç¨‹)çš„è¿›ç¨‹IDå·ï¼Œå­è¿›ç¨‹åˆè¿”å›ä¸€æ¬¡ï¼Œè¿”å›å€¼ä¸º0ï¼Œï¼Œå‘ŠçŸ¥å½“å‰è¿›ç¨‹ä¸ºå­è¿›ç¨‹ã€‚</p>

<p>çˆ¶è¿›ç¨‹ä¸­è°ƒç”¨forkä¹‹å‰æ‰“å¼€çš„æ‰€æœ‰æè¿°ç¬¦åœ¨forkè¿”å›ä¹‹åç”±å­è¿›ç¨‹åˆ†äº«ã€‚ç½‘ç»œæœåŠ¡å™¨åˆ©ç”¨äº†è¿™ä¸ªç‰¹æ€§ã€‚acceptä¹‹åè°ƒç”¨forkã€‚å·²è¿æ¥çš„å¥—æ¥å­—å°±åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«ï¼›é€šå¸¸æƒ…å†µï¼Œçˆ¶è¿›ç¨‹ä¼šå…³é—­è¿™ä¸ªå·²è¿æ¥å¥—æ¥å­—ã€‚å­è¿›ç¨‹åˆ™ç»§ç»­è¿›è¡Œã€‚</p>

<p>è¿˜å¯ä»¥ä½¿ç”¨execå‡½æ•°è¿›è¡Œé¢å¤–çš„æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ªæ“ä½œä¼šç›´æ¥å°†å½“å‰è¿›ç¨‹çš„å·¥ä½œå†…å®¹åˆ‡æ¢ï¼Œå¹¶ä¸ä¼šæœ‰è¿”å›å€¼ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-25-15-27-26.png" alt="è·å–ç›¸å…³æ“ä½œ" /></p>

<h3 id="48-å¹¶å‘æœåŠ¡å™¨">4.8 å¹¶å‘æœåŠ¡å™¨</h3>

<p>å¹¶å‘æœåŠ¡å™¨ä¸­ä½¿ç”¨forkæ“ä½œï¼Œæ¥è¿›è¡Œå¤šä¸ªå®¢æˆ·ç«¯çš„å¹¶å‘å¤„ç†ã€‚åŒæ—¶ä¹Ÿè¦æ±‚ï¼Œåœ¨ä½¿ç”¨closeæ—¶ä¸ä»…çˆ¶è¿›ç¨‹è¦å…³é—­ï¼Œå­è¿›ç¨‹ä¹Ÿè¦å…³é—­socketï¼Œå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨ä¸º0ï¼Œæ‰èƒ½çœŸæ­£ç»“æŸç½‘ç»œé“¾æ¥ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-25-15-36-57.png" alt="" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-25-15-37-28.png" alt="" /></p>

<p>æ‰€ä»¥éœ€è¦å¹¶å‘æœåŠ¡å™¨çš„ç›¸å…³æ“ä½œä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ä¼ªä»£ç  */</span>
<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
<span class="kt">int</span>   <span class="n">listenfd</span><span class="p">,</span> <span class="n">connfd</span><span class="p">;</span>
<span class="n">listenfd</span> <span class="o">=</span> <span class="n">socket</span> <span class="p">(...);</span>
<span class="n">bind</span> <span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">...);</span>
<span class="n">listen</span> <span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">LISTENQ</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span> <span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">...);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">close</span> <span class="p">(</span><span class="n">listenfd</span><span class="p">);</span> <span class="cm">/* child closes listening socket */</span>
        <span class="cm">/* do something */</span>
        <span class="n">close</span> <span class="p">(</span><span class="n">connfd</span><span class="p">);</span>   <span class="cm">/* done with this client */</span>
        <span class="n">exit</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">close</span> <span class="p">(</span><span class="n">connfd</span><span class="p">);</span>       <span class="cm">/* parent closes connected socket */</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="49-closeå‡½æ•°">4.9 close()å‡½æ•°</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">int close(sockfd);</code>ï¼šå¯ä»¥ç”¨æ¥å…³é—­å¥—æ¥å­—ï¼Œå¹¶ç»ˆæ­¢TCPè¿æ¥</li>
  <li>ç¡®å®æƒ³ç»ˆæ­¢è¿æ¥å¯ä»¥ç”¨<code class="language-plaintext highlighter-rouge">shutdown()</code>å‡½æ•°ã€‚</li>
</ul>

<h3 id="410-getsocketnameå’Œgetpeernameå‡½æ•°">4.10 getsocketnameå’Œgetpeernameå‡½æ•°</h3>

<p>ç›¸å…³å‡½æ•°æ“ä½œå¦‚ä¸‹ï¼š</p>
<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;sys/socket.h&gt;
</span><span class="kt">int</span> <span class="nf">getsockname</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">localaddr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">getpeername</span> <span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">peeraddr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">addrlen</span><span class="p">);</span>
</code></pre></div></div>
<p>ä½¿ç”¨è§£é‡Šï¼š</p>

<ul>
  <li>åœ¨ä¸€ä¸ªæ²¡æœ‰è°ƒç”¨<code class="language-plaintext highlighter-rouge">bind</code>çš„TCPå®¢æˆ·ç«¯ä¸Šï¼Œ<code class="language-plaintext highlighter-rouge">connect</code>æˆåŠŸè¿”å›åï¼Œ<code class="language-plaintext highlighter-rouge">getsockname</code>ç”¨äºè¿”å›ç”±å†…æ ¸èµ‹äºˆè¯¥è¿æ¥çš„æœ¬åœ°IPåœ°å€å’Œæœ¬åœ°ç«¯å£å·ï¼›</li>
  <li>åœ¨ä»¥ç«¯å£å·0è°ƒç”¨<code class="language-plaintext highlighter-rouge">bind</code>åï¼Œ<code class="language-plaintext highlighter-rouge">getsockname</code>ç”¨äºè¿”å›ç”±å†…æ ¸èµ‹äºˆçš„æœ¬åœ°ç«¯å£å·ï¼›</li>
  <li><code class="language-plaintext highlighter-rouge">getsockname</code>å¯ç”¨äºè·å–æŸä¸ªå¥—æ¥å­—çš„åœ°å€æ—ã€‚</li>
  <li>å½“ä¸€ä¸ªæœåŠ¡å™¨æ˜¯ç”±è°ƒç”¨è¿‡acceptçš„æŸä¸ªè¿›ç¨‹é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">exec</code>æ‰§è¡Œç¨‹åºæ—¶ï¼Œå®ƒèƒ½å¤Ÿè·å–å®¢æˆ·èº«ä»½çš„å”¯ä¸€é€”å¾„ä¾¿æ˜¯è°ƒç”¨<code class="language-plaintext highlighter-rouge">getpeername</code>ã€‚</li>
  <li>å¤§å¤šæ•°TCPæœåŠ¡å™¨æ˜¯å¹¶å‘çš„ï¼Œå¤§å¤šæ•°UDPæœåŠ¡å™¨æ˜¯è¿­ä»£çš„(UDPæ— é“¾æ¥ï¼Œæ¯ä¸ªåº”ç”¨åªéœ€è¦ä¿æŒä¸€ä¸ªçº¿ç¨‹)ã€‚</li>
</ul>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ä»£ç æ¼”ç¤ºï¼šè·å–å¥—æ¥å­—çš„åœ°å€æ— */</span>
<span class="kt">int</span> <span class="nf">sockfd_to_family</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">ss</span><span class="p">;</span>
	<span class="n">socklen_t</span>	<span class="n">len</span><span class="p">;</span>
 
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">getsockname</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">ss_family</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="ç¬¬-5-ç« -tcpå®¢æˆ·ç«¯æœåŠ¡å™¨ç¨‹åºç¤ºä¾‹">ç¬¬ 5 ç«  TCPå®¢æˆ·ç«¯/æœåŠ¡å™¨ç¨‹åºç¤ºä¾‹</h3>
<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<ul>
  <li><a href="https://blog.csdn.net/mashuiping/article/details/65628979">ã€ŠUNIXç½‘ç»œç¼–ç¨‹å·1ã€‹è¯»ä¹¦ç¬”è®°â€“ç¬¬äº”ç« TCPå®¢æˆ·/æœåŠ¡å®ä¾‹</a></li>
  <li><a href="https://blog.csdn.net/haoyuedangkong_fei/article/details/65448137">UNIXç½‘ç»œç¼–ç¨‹å·ä¸€ ç¬¬äº”ç«  TCPå®¢æˆ·/æœåŠ¡å™¨ç¨‹åºç¤ºä¾‹</a></li>
</ul>

<p>æœ¬ç« å¼€å§‹ç¼–å†™ä¸€ä¸ªå®Œæ•´çš„TCPå®¢æˆ·/æœåŠ¡å™¨ç¨‹åºå®ä¾‹ã€‚</p>
<ul>
  <li>(1) å®¢æˆ·å†²æ ‡å‡†è¾“å…¥è¯»å…¥ä¸€è¡Œæ–‡æœ¬ï¼Œå¹¶å†™ç»™æœåŠ¡å™¨</li>
  <li>(2ï¼‰æœåŠ¡å™¨ä»ç½‘ç»œè¾“å…¥è¯»å…¥è¿™è¡Œæ–‡æœ¬ï¼Œå¹¶å›å°„ç»™å®¢æˆ·</li>
  <li>(3ï¼‰å®¢æˆ·ä»ç½‘ç»œè¯»å…¥è¿™è¡Œå›å°„æ–‡æœ¬ï¼Œå¹¶æ˜¾ç¤ºåœ¨æ ‡å‡†è¾“å‡ºä¸Šã€‚</li>
</ul>

<p><img src="https://img-blog.csdnimg.cn/20191023150943597.png" alt="æœåŠ¡å™¨ç›¸å…³æ“ä½œ" /></p>

<p>ä¸€ä¸ªç®€å•çš„clientå’Œsever</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* client */</span>
<span class="cp">#include "unp.h"
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sockfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">sockaddr_inservaddr</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
	<span class="n">err_quit</span><span class="p">(</span><span class="s">"usage: tcpcli &lt;IPaddress&gt;"</span><span class="p">);</span>
	
	<span class="n">sockfd</span> <span class="o">=</span> <span class="n">Socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERV_PORT</span><span class="p">);</span>
	<span class="n">Inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span>
	
	<span class="n">Connect</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
	<span class="n">str_cli</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="n">sockfd</span><span class="p">);</span><span class="cm">/* do it all */</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">str_cli</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">sendline</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">],</span> <span class="n">recvline</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">Fgets</span><span class="p">(</span><span class="n">sendline</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Writen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">sendline</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sendline</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">Readline</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">recvline</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err_quit</span><span class="p">(</span><span class="s">"str_cli: server terminated prematurely"</span><span class="p">);</span>
		<span class="n">Fputs</span><span class="p">(</span><span class="n">recvline</span><span class="p">,</span> <span class="n">stdout</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p><strong>Sever</strong></p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include "unp.h"
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span> <span class="n">connfd</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">childpid</span><span class="p">;</span>
	<span class="n">socklen_t</span> <span class="n">clilen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="nc">sockaddr_incliaddr</span><span class="p">,</span> <span class="n">servaddr</span><span class="p">;</span>
	
	<span class="n">listenfd</span> <span class="o">=</span> <span class="n">Socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span>      <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERV_PORT</span><span class="p">);</span>
	
	<span class="n">Bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
	<span class="n">Listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">LISTENQ</span><span class="p">);</span>
	
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">clilen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
		<span class="n">connfd</span> <span class="o">=</span> <span class="n">Accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clilen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">childpid</span> <span class="o">=</span> <span class="n">Fork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* child process */</span>
			<span class="n">Close</span><span class="p">(</span><span class="n">listenfd</span><span class="p">);</span><span class="cm">/* close listening socket */</span>
			<span class="n">str_echo</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span><span class="cm">/* process the request */</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">Close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span><span class="cm">/* parent closes connected socket */</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">str_echo</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">MAXLINE</span><span class="p">];</span>
	
<span class="nl">again:</span>
	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">MAXLINE</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">Writen</span><span class="p">(</span><span class="n">sockfd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
	<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">err_sys</span><span class="p">(</span><span class="s">"str_echo: read error"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>
<p><strong>å·¥ä½œæµç¨‹</strong></p>

<ul>
  <li>æœåŠ¡ç«¯å…ˆåœ¨åå°è¿è¡Œ
    <ul>
      <li>è¿æ¥é˜¶æ®µ:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">socket</code>åˆ›å»ºå¥—æ¥å­—</li>
          <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">bind</code>è®¾ç½®æœåŠ¡çš„ç«¯å£å·ä¸º9877ï¼Œä»»æ„ä¸€ä¸ªç½‘å¡çš„IP</li>
          <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">listen</code>,å°†å¥—æ¥å­—æ”¹ä¸ºè¢«åŠ¨è¿æ¥å¥—æ¥å­—ï¼Œ</li>
          <li>ç»´æŠ¤é˜Ÿåˆ—ï¼Œè¿™ä¸€æ­¥å®Œæˆåå°±å¯ä»¥æ¥æ”¶å®¢æˆ·çš„connectäº†ï¼Œ</li>
          <li>è°ƒç”¨<code class="language-plaintext highlighter-rouge">accept</code>ï¼Œåˆæ¬¡è°ƒç”¨æ—¶å¹¶æ²¡æœ‰å·²è¿æ¥çš„å¥—æ¥å­—ï¼Œè¿›å…¥ç¡çœ .</li>
        </ul>
      </li>
      <li>å·¥ä½œé˜¶æ®µ:
        <ul>
          <li>åˆ›å»ºå­è¿›ç¨‹:
            <ul>
              <li>å°†<code class="language-plaintext highlighter-rouge">accept</code>æ”¾åœ¨ä¸€ä¸ªæ— é™å¾ªç¯ä¸­ï¼Œ</li>
              <li><code class="language-plaintext highlighter-rouge">accept</code>è¿”å›æˆåŠŸï¼Œå°±<code class="language-plaintext highlighter-rouge">fork</code>ä¸€ä¸ªå­è¿›ç¨‹</li>
              <li>åœ¨å­è¿›ç¨‹ä¸­å¤„ç†å·²å»ºç«‹è¿æ¥çš„ä»»åŠ¡ï¼Œçˆ¶è¿›ç¨‹å°±ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥ã€‚</li>
            </ul>
          </li>
          <li>å­è¿›ç¨‹å·¥ä½œ:
            <ul>
              <li>åœ¨<strong>å­è¿›ç¨‹ä¸­éœ€è¦å…³é—­socketåˆ›å»ºçš„æè¿°ç¬¦ï¼Œçˆ¶è¿›ç¨‹ä¸­å…³é—­connectè¿”å›çš„æè¿°ç¬¦</strong>
                <ul>
                  <li>å› ä¸ºforkåˆ›å»ºè¿›ç¨‹æ—¶è¿™ä¸¤ä¸ªæè¿°ç¬¦éƒ½ä¼šå¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­ï¼Œå¦‚æœä¸å…³é—­ï¼Œåœ¨å­è¿›ç¨‹é€€å‡ºæ—¶ç”±äºçˆ¶è¿›ç¨‹è¿˜æ‰“å¼€äº†connectæè¿°ç¬¦ï¼Œ<strong>å°†ä¸ä¼šå‘é€FINå­—èŠ‚</strong>ï¼Œè€Œä¸”æ¯ä¸€ä¸ªè¿æ¥éƒ½<strong>ä¼šæ¶ˆè€—ä¸€ä¸ªæè¿°ç¬¦èµ„æºæ°¸è¿œä¸ä¼šé‡Šæ”¾</strong>ã€‚</li>
                </ul>
              </li>
              <li>åœ¨<code class="language-plaintext highlighter-rouge">str_echo</code>ä¸­ï¼ŒæœåŠ¡å™¨ä»å¥—æ¥å­—ä¸­è¯»å–å†…å®¹ï¼Œè‹¥æ²¡æœ‰å†…å®¹å°±é˜»å¡ï¼Œç„¶åç›´æ¥å†™å›å¥—æ¥å­—ã€‚</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>å®¢æˆ·ç«¯ï¼š
    <ul>
      <li>é“¾æ¥é˜¶æ®µï¼š
        <ul>
          <li>åˆ›å»ºå¥—æ¥å­—</li>
          <li>è®¾ç½®æœåŠ¡å™¨IPå’Œç«¯å£å·</li>
          <li>è°ƒç”¨connectå‘èµ·è¿æ¥
            <ul>
              <li>è°ƒç”¨connectåä¼šå‘é€SYNå­—èŠ‚</li>
              <li>åœ¨æ”¶åˆ°æœåŠ¡ç«¯çš„ACKå</li>
              <li>connectå°±è¿”å›ï¼Œè¿›å…¥establishedçŠ¶æ€</li>
            </ul>
          </li>
        </ul>
      </li>
      <li>å·¥ä½œé˜¶æ®µ
        <ul>
          <li>ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€è¡Œæ–‡æœ¬</li>
          <li>å°†å®ƒå†™åˆ°å¥—æ¥å­—ä¸­</li>
          <li>ä»å¥—æ¥å­—ä¸­è¯»ä¸€è¡Œæ–‡æœ¬</li>
          <li>å†™åˆ°æ ‡å‡†è¾“å‡º</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="56-æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨">5.6 æœåŠ¡å™¨æ­£å¸¸å¯åŠ¨</h3>

<p>æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯é˜»å¡åï¼š</p>

<ul>
  <li>å®¢æˆ·ç«¯æ­£å¸¸æ˜¯é˜»å¡åœ¨<code class="language-plaintext highlighter-rouge">fgets</code>ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼›åœ¨ç”¨æˆ·è¾“å…¥<code class="language-plaintext highlighter-rouge">EOF</code>åï¼Œ<code class="language-plaintext highlighter-rouge">fgets</code>è¿”å›<code class="language-plaintext highlighter-rouge">NULL</code>ï¼Œ<code class="language-plaintext highlighter-rouge">str_cli</code>é€€å‡ºã€‚</li>
  <li>å®¢æˆ·ç«¯ç¨‹åºè°ƒç”¨<code class="language-plaintext highlighter-rouge">exit</code>ç»“æŸç¨‹åºï¼Œè¯¦ç»†æµç¨‹å¦‚ä¸‹:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">exit</code>é¦–å…ˆä¼šå…ˆå…³é—­æ‰“å¼€çš„å¥—æ¥å­—æè¿°ç¬¦ï¼Œ(å®¢æˆ·å•å¥—æ¥å­—<code class="language-plaintext highlighter-rouge">close</code>)</li>
      <li>å¼•å‘<code class="language-plaintext highlighter-rouge">FIN</code>å‘é€åˆ°å¥—æ¥å­—ä¸­ï¼Œè¿›å…¥<code class="language-plaintext highlighter-rouge">FIN_WAIT_1</code>çŠ¶æ€ï¼Œ(å®¢æˆ·ç«¯å‘é€<code class="language-plaintext highlighter-rouge">FIN</code>)</li>
      <li>æ”¶åˆ°æœåŠ¡å™¨çš„<code class="language-plaintext highlighter-rouge">ACK</code>åè¿›å…¥<code class="language-plaintext highlighter-rouge">FIN_WAIT_2</code>çŠ¶æ€ï¼Œ(æœåŠ¡å™¨å‘é€å›å¤:<code class="language-plaintext highlighter-rouge">ACK</code>)</li>
      <li>å†æ”¶åˆ°<code class="language-plaintext highlighter-rouge">FIN</code>åå‘é€<code class="language-plaintext highlighter-rouge">ACK</code>ç„¶åè¿›å…¥<code class="language-plaintext highlighter-rouge">TIME_WAIT</code>çŠ¶æ€(æœåŠ¡å™¨å‘é€:<code class="language-plaintext highlighter-rouge">FIN</code>, å®¢æˆ·ç«¯å›å¤:<code class="language-plaintext highlighter-rouge">ACK</code>)</li>
      <li>ç­‰å¾…<code class="language-plaintext highlighter-rouge">2MSL</code></li>
    </ul>
  </li>
  <li>å®¢æˆ·ç«¯ç¨‹åºè¿è¡Œæ—¶æŸ¥çœ‹å¥—æ¥å­—çŠ¶æ€
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>netstat <span class="nt">-a</span> |grep 9877
tcp        0      0 <span class="k">*</span>:9877                  <span class="k">*</span>:<span class="k">*</span>                     LISTEN     
tcp        0      0 localhost:36368         localhost:9877          ESTABLISHED
tcp        0      0 localhost:9877          localhost:36368         ESTABLISHED
</code></pre></div>    </div>
  </li>
  <li>å®¢æˆ·ç«¯ç¨‹åºç»ˆæ­¢è¿è¡ŒåæŸ¥çœ‹å¥—æ¥å­—çŠ¶æ€
    <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>netstat <span class="nt">-a</span> |grep 9877
tcp        0      0 <span class="k">*</span>:9877                  <span class="k">*</span>:<span class="k">*</span>                     LISTEN     
tcp        0      0 localhost:36368         localhost:9877          TIME_WAIT
</code></pre></div>    </div>
    <p>æ³¨æ„ï¼šæœåŠ¡å™¨çš„æ„å¤–å´©æºƒï¼Œæˆ–è€…ä¸»è¿›ç¨‹çš„ä¸»åŠ¨ç»“æŸï¼Œå¯èƒ½å­˜åœ¨å­è¿›ç¨‹çš„åƒµå°¸è¿›ç¨‹ã€‚</p>
  </li>
</ul>

<h3 id="58-é—®é¢˜åˆ†æ">5.8 é—®é¢˜åˆ†æ</h3>

<h4 id="581-åƒµå°¸è¿›ç¨‹">5.8.1 åƒµå°¸è¿›ç¨‹</h4>

<p>å½“ä¸»åŠ¨å…³é—­æœåŠ¡å™¨åï¼Œä½¿ç”¨psæŸ¥çœ‹è¿›ç¨‹çŠ¶æ€å‘ç°å­˜åœ¨åƒµå°¸è¿›ç¨‹</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ps <span class="nt">-o</span> pid,ppid,stat,args
  PID  PPID STAT COMMAND
30143 30142 Ss   <span class="nt">-bash</span>
34810 30143 S    ./tcpserv01
34812 34810 Z    <span class="o">[</span>tcpserv01] &lt;defunct&gt;
34813 30143 R+   ps <span class="nt">-o</span> pid,ppid,stat,args
</code></pre></div></div>

<p>ä¸ºäº†é¿å…äº§ç”Ÿåƒµå°¸è¿›ç¨‹ï¼Œåº”è¯¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">wait</code>æˆ–è€…<code class="language-plaintext highlighter-rouge">waitpid</code>ç­‰å¾…å­è¿›ç¨‹ç»“æŸåï¼Œå†ä½¿ç”¨ä¸»è¿›ç¨‹ç»ˆç»“ã€‚</p>

<ul>
  <li>çˆ¶è¿›ç¨‹å¦‚æœè®¾ç½®äº†ä¿¡å·å¤„ç†å‡½æ•°é‚£ä¹ˆå°±å¯ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨waitæˆ–waitpid.</li>
  <li>å¦‚æœåˆ›å»ºçš„å­è¿›ç¨‹ä¸æ­¢ä¸€ä¸ªï¼š
    <ul>
      <li>éœ€è¦åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è°ƒç”¨<code class="language-plaintext highlighter-rouge">waitpid</code>æ¥å¤„ç†ï¼Œå¹¶ä¸”è®¾ç½®<code class="language-plaintext highlighter-rouge">WNOHANG</code>å‚æ•°ã€‚</li>
      <li>å› ä¸ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">wait/waitpid</code>åªå¤„ç†ä¸€ä¸ªåƒµå°¸è¿›ç¨‹ï¼Œè€Œä¸”è°ƒç”¨<code class="language-plaintext highlighter-rouge">wait</code>æ—¶ä¼šæŒ‚èµ·ï¼Œè¿™åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­æ˜¯ä¸å¦¥çš„ã€‚</li>
      <li>å¦‚æœçˆ¶è¿›ç¨‹ä¸è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥å†çˆ¶è¿›ç¨‹é€€å‡ºæ—¶è°ƒç”¨<code class="language-plaintext highlighter-rouge">wait</code>,æˆ–<code class="language-plaintext highlighter-rouge">waitpid</code>ï¼Œé€šå¸¸è¿™ç§æƒ…å†µä¸‹çˆ¶è¿›ç¨‹éƒ½æ˜¯å¾ˆå¿«å°±é€€å‡ºï¼Œä¸ç„¶è¿˜æ˜¯ä¼šäº§ç”Ÿåƒµå°¸è¿›ç¨‹ã€‚</li>
    </ul>
  </li>
</ul>

<p><strong>è®©initè¿›ç¨‹å¤„ç†åƒµå°¸è¿›ç¨‹</strong></p>

<ul>
  <li>è¿™ç§æƒ…å†µä¸‹å­˜åœ¨äºï¼š
    <ul>
      <li>çˆ¶è¿›ç¨‹æ²¡æœ‰å¤„ç†<code class="language-plaintext highlighter-rouge">SIGCHLD</code>ä¿¡å·ï¼Œæˆ–åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­æ²¡æœ‰<code class="language-plaintext highlighter-rouge">waitpid</code></li>
      <li><strong>ä¸”</strong>çˆ¶è¿›ç¨‹å·²ç»ç»“æŸåæ‰å­˜åœ¨çš„æƒ…å†µ</li>
    </ul>
  </li>
  <li>è¿™æ—¶initå°±ä¼šæˆä¸ºåƒµå°¸è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼Œæˆ‘ä»¬å°±ä¸ç”¨ç®¡äº†ã€‚<strong>å…¶å®è¿™ä¸­æƒ…å†µå¤šåŠæ˜¯ç”±äºçˆ¶è¿›ç¨‹å¿˜è®°å¤„ç†äº†</strong>ã€‚è¿™é‡Œå°±å¯ä»¥ä¸å¤„ç†<code class="language-plaintext highlighter-rouge">SIGCHLD</code>ä¿¡å·ï¼Œå› ä¸ºè¿™ä¸ªä¿¡å·å¹¶ä¸ä¼šå¯¼è‡´ç¨‹åºç»“æŸï¼Œåªè¦åœ¨çˆ¶è¿›ç¨‹ä¸­closeç„¶åè°ƒç”¨<code class="language-plaintext highlighter-rouge">wait/waitpid</code>å°±å¥½äº†ã€‚</li>
</ul>

<h4 id="582-å¤„ç†è¢«ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨">5.8.2 å¤„ç†è¢«ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨</h4>

<p>ä¸ºäº†è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå…¶å®ä¿¡å·å¤„ç†å°±ç›¸å½“äºä¸€ä¸ªè½¯ä»¶ä¸­æ–­ï¼Œä¸­æ–­éšæ—¶éƒ½å¯èƒ½å‘ç”Ÿï¼Œå› æ­¤æˆ‘ä»¬ç¼–å†™ä»£ç è¿‡ç¨‹ä¸­éœ€è¦è€ƒè™‘ä¸­æ–­çš„æƒ…å†µã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
	<span class="kt">int</span> <span class="n">listenfd</span><span class="p">,</span> <span class="n">connfd</span><span class="p">;</span>
	<span class="n">pid_t</span> <span class="n">childpid</span><span class="p">;</span>
	<span class="n">socklen_t</span> <span class="n">clilen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr_incliaddr</span><span class="p">,</span> <span class="n">servaddr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">sig_chld</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">);</span>
	<span class="n">Sigfunc</span> <span class="o">*</span> <span class="n">Signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">,</span> <span class="n">Sigfunc</span> <span class="o">*</span><span class="n">func</span><span class="p">);</span>
	
	<span class="n">listenfd</span> <span class="o">=</span> <span class="n">Socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span>      <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
	<span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERV_PORT</span><span class="p">);</span>

	<span class="n">Bind</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
	<span class="n">Listen</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="n">LISTENQ</span><span class="p">);</span>
	<span class="n">Signal</span><span class="p">(</span><span class="n">SIGCHLD</span><span class="p">,</span> <span class="n">sig_chld</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">clilen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
		<span class="n">connfd</span> <span class="o">=</span> <span class="n">Accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clilen</span><span class="p">);</span>
		
		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">childpid</span> <span class="o">=</span> <span class="n">Fork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* child process */</span>
			<span class="n">Close</span><span class="p">(</span><span class="n">listenfd</span><span class="p">);</span><span class="cm">/* close listening socket */</span>
			<span class="n">str_echo</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span><span class="cm">/* process the request */</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">Close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span><span class="cm">/* parent closes connected socket */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sig_chld</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">){</span>
	<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"enter sig_chld</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="c1">//while( (pid = wait(NULL)) &gt; 0)</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"child %d terminated</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"quit sig_chld</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ä¸Šé¢ä¾‹å­ä¸­ä¸­æ–­å¤„ç†å‡½æ•°ä¸­è°ƒç”¨printfæ˜¯ä¸å¤ªåˆé€‚çš„ï¼Œå› ä¸ºprintfæ˜¯ä¸å¯é‡å…¥å‡½æ•°ï¼Œåœ¨ç¨‹åºè§„æ¨¡æ¯”è¾ƒå¤§ï¼Œè¿›ç¨‹å¤šæ—¶å¯èƒ½å‡ºç°å¥‡æ€ªé”™è¯¯ï¼Œè¿™é‡Œåªä¸ºäº†æŸ¥çœ‹ç¨‹åºçŠ¶æ€ã€‚</p>

<p><code class="language-plaintext highlighter-rouge">Signal</code>æ˜¯ä¸€ä¸ªä¹¦ä¸­ä½œè€…å†™çš„ä¸€ä¸ªåŒ…è£¹å‡½æ•°ï¼Œé‡‡ç”¨signationå‡½æ•°å®ç°ï¼Œå®ç°ä»£ç ä¸­å¯ä»¥è®¾ç½®æ˜¯å¦è®¾ç½®SA_RESTART, è¿™ä¸ªé…ç½®å°±è¡¨ç¤ºå½“ç³»ç»Ÿè°ƒç”¨è¢«ä¸­æ–­ä»¥åæ˜¯å¦è‡ªåŠ¨é‡æ–°å¯åŠ¨ã€‚</p>

<p>å› ä¸ºä¸åŒçš„UNIXç³»ç»Ÿå®ç°å¯èƒ½ä¸ä¸€æ ·ï¼Œæœ‰äº›ç³»ç»Ÿé»˜è®¤é‡å¯æœ‰äº›åˆ™é»˜è®¤ä¸é‡å¯ï¼Œå› æ­¤æˆ‘ä»¬è‡ªå·±é…ç½®å°±å¯ä»¥æ›´å¥½æ§åˆ¶ï¼Œå½“ç„¶ä¹Ÿä¸ºäº†ä¸ç”¨ç›´æ¥é…ç½®<code class="language-plaintext highlighter-rouge">signation</code>ï¼Œæ‰å°†å…¶åŒ…è£…èµ·æ¥ã€‚</p>

<p>å¯¹äº<code class="language-plaintext highlighter-rouge">accept</code>ã€<code class="language-plaintext highlighter-rouge">read</code>ã€<code class="language-plaintext highlighter-rouge">write</code>ã€<code class="language-plaintext highlighter-rouge">select</code>ç­‰æ…¢ç³»ç»Ÿè°ƒç”¨é€šå¸¸æˆ‘ä»¬éƒ½å¸Œæœ›ä»–ä»¬è¢«ä¸­æ–­ä¹‹åèƒ½ç»§ç»­è¿”å›ä¸­æ–­å‰çš„çŠ¶æ€ç»§ç»­æ‰§è¡Œï¼Œå› ä¸ºå¹¶ä¸ä¼šäº§ç”Ÿé”™è¯¯ï¼Œè€Œå¯¹äº<code class="language-plaintext highlighter-rouge">connect</code>åœ¨ä¸­æ–­ä¹‹åæˆ‘ä»¬åˆ™ä¸èƒ½é‡å¯ï¼Œå› ä¸ºåœ¨ä¸­æ–­ä¹‹åå…¶è¿æ¥è‚¯å®šä¼šå¤±è´¥ã€‚</p>

<h3 id="583-waitå’Œwaitpid">5.8.3 waitå’Œwaitpid</h3>

<p>waitæ¥æ”¶åˆ°ä»»æ„ä¸€ä¸ªä¿¡å·ä¹‹åï¼Œå°±ä¼šæ‰§è¡Œæ–­å¼€æ“ä½œã€‚ä½†æ˜¯ä¼šç•™ä¸‹n-1ä¸ªåƒµå°¸è¿›ç¨‹ã€‚å› ä¸ºæ‰€æœ‰çš„ä¿¡å·éƒ½åœ¨ä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œä¹‹å‰äº§ç”Ÿï¼Œä¿¡å·å¤„ç†å‡½æ•°åªæ‰§è¡Œä¸€æ¬¡ï¼Œå› ä¸ºUNIXä¿¡å·ä¸€èˆ¬æ˜¯ä¸æ’é˜Ÿçš„ï¼Œæ­£ç¡®çš„è§£å†³åŠæ³•æ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">waitpid</code>ä»£æ›¿wait</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">sig_chld</span><span class="p">(</span><span class="kt">int</span> <span class="n">signo</span><span class="p">){</span>
	<span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"enter sig_chld</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">pid</span> <span class="o">=</span> <span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="c1">//while( (pid = wait(NULL)) &gt; 0)</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"child %d terminated</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"quit sig_chld</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>æŒ‡å®šWNOHANGå‚æ•°ï¼Œä½¿å¾—pidåœ¨æœ‰å°šæœªç»ˆæ­¢çš„å­è¿›ç¨‹è¿è¡Œæ—¶ä¸è¦é˜»å¡ã€‚</p>

<h3 id="511-acceptè¿”å›å‰è¿æ¥ç»ˆæ­¢">5.11 acceptè¿”å›å‰è¿æ¥ç»ˆæ­¢</h3>

<p>ä¸‰è·¯æ¡æ‰‹å®Œæˆå»ºç«‹è¿æ¥åï¼Œå®¢æˆ·ç«¯TCPå´å‘é€äº†ä¸€ä¸ªRST(å¤ä½)ã€‚æœåŠ¡å™¨ä¸­ï¼Œè¯¥è¿æ¥å·²ç»åœ¨TCPé˜Ÿåˆ—ä¸­ã€‚ç­‰å¾…acceptæ—¶ï¼ŒRSTåˆ°è¾¾ã€‚ç›¸å½“äºï¼ŒæœåŠ¡å™¨å¼€å¯socketã€bindã€listenåè®©acceptç¡çœ ä¸€æ®µæ—¶é—´ï¼Œåœ¨æ­¤æœŸé—´å¯åŠ¨å®¢æˆ·ç«¯ï¼Œä¸€æ—¦è¿æ¥å°±å‘é€RSTã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-11-25-22-20-57.png" alt="accpt" /></p>

<p>å½“æœåŠ¡å™¨åœ¨<code class="language-plaintext highlighter-rouge">accept</code>é˜»å¡æ—¶ï¼Œå‡å¦‚è¿›ç¨‹çªç„¶å´©æºƒ</p>
<ul>
  <li>æ­¤æ—¶å­è¿›ç¨‹é€€å‡ºæ—¶:
    <ul>
      <li>å‘FINå­—èŠ‚å‘é€åˆ°å¥—æ¥å­—ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°åå›åº”ä»¥ä¸€ä¸ªACK</li>
      <li>åŒæ—¶å†…æ ¸å‘çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">SIGCHLD</code>ä¿¡å·ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨<code class="language-plaintext highlighter-rouge">sig_chil</code>å¤„ç†ï¼Œå¤„ç†å®Œæˆåè¿”å›<code class="language-plaintext highlighter-rouge">accept</code>è°ƒç”¨</li>
      <li>æ³¨æ„ï¼š<strong>å¦‚æœæ²¡æœ‰é…ç½®è‡ªåŠ¨é‡å¯æ ‡è¯†ï¼Œ<code class="language-plaintext highlighter-rouge">accept</code>è°ƒç”¨å°†å‡ºé”™ï¼Œå¹¶å°†<code class="language-plaintext highlighter-rouge">errno </code>è®¾ä¸º<code class="language-plaintext highlighter-rouge">EINTR</code></strong></li>
    </ul>
  </li>
  <li>è§£å†³æ–¹æ¡ˆ:
    <ul>
      <li>åœ¨é…ç½®ä¿¡å·å¤„ç†å‡½æ•°æ—¶ï¼Œè®¾ç½®<code class="language-plaintext highlighter-rouge">act.sa_flags |= SA_RESTART</code>;è¿™æ ·å½“acceptè¢«ä¸­æ–­è¿”å›åï¼Œèƒ½ç»§ç»­ é˜»å¡ã€‚</li>
      <li>ä¿®æ”¹acceptçš„åˆ¤æ–­æ¡ä»¶: å½“acceptè¿”å›é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­ä¸€ä¸‹æ˜¯å¦errnoä¸ºEINTRï¼Œå¦‚æœæ˜¯æˆ‘ä»¬å°±æ‰‹åŠ¨é‡å¯acceptã€‚
        <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clilen</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="n">connfd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
<span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">){</span>
    <span class="k">continue</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">err_sys</span><span class="p">(</span><span class="s">"accept error"</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>        </div>
        <p><strong>Code: æ³¨æ„è¿™é‡Œæˆ‘ä»¬è°ƒç”¨çš„æ—¶accept è€Œä¸æ˜¯ åŒ…è£¹å‡½æ•°Accept</strong></p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="512-æœåŠ¡å™¨è¿›ç¨‹æ„å¤–ç»ˆæ­¢">5.12 æœåŠ¡å™¨è¿›ç¨‹æ„å¤–ç»ˆæ­¢</h3>

<p>è¿™ä¸ªé—®é¢˜ä¹Ÿå¯ä»¥ç”¨ä¸Šé¢çš„æƒ…å½¢æµ‹è¯•ï¼Œæˆ‘ä»¬é€šè¿‡killæ‰æœåŠ¡å™¨å­è¿›ç¨‹æ¥æ¨¡æ‹Ÿã€‚</p>

<p>å¯¹äºå®¢æˆ·ç«¯:</p>

<ol>
  <li>å½“æœåŠ¡å™¨ç»ˆæ­¢åä¼šå‘é€çš„FINå­—èŠ‚(è¡¨æ˜æœåŠ¡ç«¯ä¸åœ¨å‘é€å†…å®¹)ï¼Œå®¢æˆ·ç«¯è‡ªåŠ¨ä»¥ACKå›åº”</li>
  <li>ç„¶åæœåŠ¡å™¨è¢«<strong>å¼ºè¡Œæ¯™æ‰</strong></li>
  <li>ä½†å®¢æˆ·ç«¯å¹¶ä¸çŸ¥é“æœåŠ¡å™¨è¿›ç¨‹å·²ç»è¢«æ¯™æ‰äº†(å®ƒåªæ”¶åˆ°äº†FIN,å¹¶ä¸èƒ½è¯´æ˜å®ƒè¢«æ¯™æ‰äº†)ï¼Œå› ä¸ºå®¢æˆ·ç«¯æ­¤æ—¶æ˜¯é˜»å¡äºfgetsçš„ï¼Œå¹¶ä¸ä¼šå‘é€FINå­—èŠ‚ç»™æœåŠ¡å™¨ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯è®¤ä¸ºé“¾æ¥å¹¶æ²¡æœ‰å…³é—­ï¼Œå› æ­¤ä¸€ç›´ç­‰å¾…ç”¨æˆ·ä»æ ‡å‡†è¾“å…¥è¾“å…¥å­—ç¬¦</li>
  <li>å¦‚æœç”¨æˆ·ä¸€ç›´ä¸è¾“å…¥é‚£ä¹ˆç¨‹åºæ°¸è¿œä¸çŸ¥é“æœåŠ¡å™¨å·²ç»æŒ‚äº†ã€‚</li>
  <li>å½“ç”¨æˆ·è¾“å…¥ä¸€äº›å­—ç¬¦çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨å°±ä¼šå›åº”ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">RST</code>ï¼Œå®¢æˆ·æ‰çŸ¥é“æœåŠ¡å™¨å·²ç»æŒ‚äº†</li>
  <li>å¦‚æœå®¢æˆ·ç»§ç»­å‘é€å†…å®¹å°†å¼•å‘<code class="language-plaintext highlighter-rouge">SIGPIPE</code>ä¿¡å·ï¼ˆè¿™ç§æƒ…å†µå¾ˆå¯èƒ½å‘ç”Ÿï¼Œå› ä¸ºå®¢æˆ·å‘ç»™æœåŠ¡ç«¯çš„å†…å®¹å¯èƒ½æ˜¯åˆ†å‡ æ¬¡å‘é€çš„ï¼Œç¬¬ä¸€æ¬¡å‘çš„æ—¶å€™å°±å›æ”¶åˆ°<code class="language-plaintext highlighter-rouge">RST</code>ï¼Œåœ¨æ”¶åˆ°<code class="language-plaintext highlighter-rouge">RST</code>æœŸé—´è¿˜å¯èƒ½å‘é€å¾ˆå¤šå†…å®¹ï¼‰ã€‚</li>
</ol>

<p>å¦‚ä½•è§£å†³ï¼š</p>

<p>è¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬åŸå› åœ¨äºå®¢æˆ·ç«¯ï¼Œå®ƒä¸èƒ½ä»…ä»…é˜»å¡äºfgets,å®ƒåº”è¯¥åŒæ—¶å…³æ³¨stdin å’Œ socket ,ä»»æ„ä¸€ä¸ªé€€å‡ºéƒ½åº”è¯¥åŠæ—¶çŸ¥é“ã€‚å› æ­¤å¯ä»¥ä½¿ç”¨selectæ¥ç®¡ç†è¿™2ä¸ªæè¿°ç¬¦ã€‚</p>

<h3 id="513-å‘é€æ•°æ®æ ¼å¼æœ‰é™åˆ¶">5.13 å‘é€æ•°æ®æ ¼å¼æœ‰é™åˆ¶</h3>

<p>å½“å‘é€å­—ç¬¦ä¸²æ—¶ä¸€èˆ¬æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåªè¦ä¸åŒä¸»æœºéƒ½æ”¯æŒåŒä¸€ä¸­å­—ç¬¦ç¼–ç ï¼Œä½†æ˜¯å¦‚æœå‘é€çš„æ˜¯äºŒè¿›åˆ¶å°±æœ‰å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚ä¸åŒä¸»æœºå­—èŠ‚åºå¯èƒ½ä¸åŒã€CPUä½æ•°ä¸åŒï¼Œå„ç§æ•°æ®ç±»å‹å ç”¨ç©ºé—´ä»¥åŠå¯¹é½æ ¼å¼å¯èƒ½ä¸åŒï¼Œè¿™å…¶å®ä¹Ÿæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶çš„å…¼å®¹æ€§é—®é¢˜ï¼Œå› æ­¤å…¼å®¹éš¾åº¦éå¸¸å¤§ã€‚</p>

<h3 id="514-æœåŠ¡å™¨å´©æºƒ-æˆ–è€…ç½‘ç»œä¸­æ–­">5.14 æœåŠ¡å™¨å´©æºƒ æˆ–è€…ç½‘ç»œä¸­æ–­</h3>

<p>TCPæœ‰é‡ä¼ æœºåˆ¶ï¼Œå½“ç½‘ç»œä¸é€šæ—¶ï¼Œå®¢æˆ·ç«¯å°†ä¸åœåœ°é‡ä¼ æœªæ”¶åˆ°ç¡®è®¤çš„åˆ†ç»„ï¼Œç›´åˆ°æ”¾å¼ƒã€‚ã€‚ã€‚è¿™é‡Œå¯èƒ½éœ€è¦å¾ˆä¹…çš„æ—¶é—´ï¼Œæˆ‘ä»¬å½“ç„¶å¸Œæœ›èƒ½å°½å¿«çŸ¥é“æœåŠ¡å™¨å´©æºƒçš„æ¶ˆæ¯äº†ï¼Œåˆ©ç”¨SO_KEEPALIVEå¥—æ¥å­—é€‰é¡¹å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
:ET