I"š<blockquote>
  <p>2019-08-25 08:44:23</p>
</blockquote>

<h1 id="tensorrtå­¦ä¹ ç¬”è®°">TensorRTå­¦ä¹ ç¬”è®°</h1>
<p><em>å‚è€ƒé“¾æ¥ï¼š</em></p>

<ul>
  <li><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-developer-guide/index.html">å®˜ç½‘æŒ‡å¯¼æ‰‹å†Œ</a>;</li>
  <li><a href="https://github.com/NVIDIA/TensorRT">github å¼€æºä»£ç åœ°å€</a></li>
  <li><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-api/index.html">API</a></li>
  <li><a href="https://blog.csdn.net/qq_36673141?t=1">å®˜æ–¹æ–‡ç« ç¿»è¯‘</a>
    <h2 id="1-tenosrrtçš„å®‰è£…">1 tenosrRTçš„å®‰è£…</h2>
  </li>
  <li><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-install-guide/index.html">å®˜æ–¹æŒ‡å¯¼</a></li>
</ul>

<p>è¿™é‡Œä¸»è¦æ˜¯ä½¿ç”¨Tar å®‰è£…,å‰ææ˜¯å·²ç»å®‰è£…å¥½cudnnå’Œcudaï¼›</p>

<p>ä¸‹è½½æ–‡ä»¶åæŒ‡ç›´æ¥è§£å‹</p>
<h3 id="11-åŠ¨æ€é“¾æ¥åº“å®‰è£…">1.1 åŠ¨æ€é“¾æ¥åº“å®‰è£…</h3>

<p>åœ¨~/.bashrcä¸­æ·»åŠ libç›®å½•</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#settensorrt

export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/home/wangpengcheng/TensorRT-5.1.5.0/lib

</code></pre></div></div>

<h3 id="12-pythonç¯å¢ƒå®‰è£…">1.2 pythonç¯å¢ƒå®‰è£…</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>TensorRT-5.1.x.x/python
<span class="c">#python2.7</span>
<span class="nb">sudo </span>pip2 <span class="nb">install </span>tensorrt-5.1.x.x-cp27-none-linux_x86_64.whl

<span class="c">#python3.x</span>
<span class="nb">sudo </span>pip3 <span class="nb">install </span>tensorrt-5.1.x.x-cp3x-none-linux_x86_64.whl


</code></pre></div></div>

<h3 id="13-å®‰è£…python-ufftenosrflow">1.3 å®‰è£…Python UFF(tenosrflow)</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd TensorRT-5.1.x.x/uff
#python2.7 
sudo pip2 install uff-0.6.3-py2.py3-none-any.whl
#python3.x
sudo pip3 install uff-0.6.3-py2.py3-none-any.whl


</code></pre></div></div>

<h3 id="14-å®‰è£…python-graphsurgeon">1.4 å®‰è£…Python graphsurgeon</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd </span>TensorRT-5.1.x.x/graphsurgeon

<span class="c">#Python2.7</span>
<span class="nb">sudo </span>pip2 <span class="nb">install </span>graphsurgeon-0.4.1-py2.py3-none-any.whl

<span class="c">#python3.x</span>
<span class="nb">sudo </span>pip3 <span class="nb">install </span>graphsurgeon-0.4.1-py2.py3-none-any.whl
</code></pre></div></div>

<h3 id="15-æµ‹è¯•">1.5 æµ‹è¯•</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> &lt;TensorRT root directory&gt;/samples/sampleMNIST
make 
<span class="nb">cd </span>TensorRT-5.1.5.0/bin

./sample_mnist
</code></pre></div></div>
<p>è¾“å‡ºï¼š</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[I] Building and running a GPU inference engine for MNIST
[I] Input:
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@%=#@@@@@%=%@@@@@@@@@@
@@@@@@@           %@@@@@@@@@
@@@@@@@           %@@@@@@@@@
@@@@@@@#:-#-.     %@@@@@@@@@
@@@@@@@@@@@@#    #@@@@@@@@@@
@@@@@@@@@@@@@    #@@@@@@@@@@
@@@@@@@@@@@@@:  :@@@@@@@@@@@
@@@@@@@@@%+==   *%%%%%%%%%@@
@@@@@@@@%                 -@
@@@@@@@@@#+.          .:-%@@
@@@@@@@@@@@*     :-###@@@@@@
@@@@@@@@@@@*   -%@@@@@@@@@@@
@@@@@@@@@@@*   *@@@@@@@@@@@@
@@@@@@@@@@@*   @@@@@@@@@@@@@
@@@@@@@@@@@*   #@@@@@@@@@@@@
@@@@@@@@@@@*   *@@@@@@@@@@@@
@@@@@@@@@@@*   *@@@@@@@@@@@@
@@@@@@@@@@@*   @@@@@@@@@@@@@
@@@@@@@@@@@*   @@@@@@@@@@@@@
@@@@@@@@@@@@+=#@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@@@

[I] Output:
0: 
1: 
2: 
3: 
4: 
5: 
6: 
7: **********
8: 
9: 

&amp;&amp;&amp;&amp; PASSED TensorRT.sample_mnist # ./sample_mnist

</code></pre></div></div>

<h2 id="2-tensorrtç®€ä»‹">2. tensorRTç®€ä»‹</h2>

<p>TensorRTæ˜¯é«˜æ€§èƒ½c++æ¨ç†åº“ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-08-25-11-21-13.png" alt="tensorRTæ¨ç†" />;</p>

<p>å…¶å®ç±»ä¼¼TensorRTå…·ä½“å·¥ä½œçš„æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚<a href="https://github.com/dmlc/tvm/">TVM</a>ã€<a href="https://github.com/facebookresearch/TensorComprehensions">TC(Tensor Comprehensions)</a>ï¼Œéƒ½åšäº†ä¸€äº›ç±»ä¼¼äºTensorRTçš„å·¥ä½œï¼Œå°†è®­ç»ƒå¥½çš„æ¨¡å‹è½¬åŒ–ä¸ºè¿è¡Œåœ¨ç‰¹å®šç«¯(ä¾‹å¦‚GPU)çš„è¿›è¡Œæ¨¡å‹ä¼˜åŒ–ç­‰ä¸€ç³»åˆ—æ“ä½œåçš„ä»£ç ï¼Œä»è€Œè¾¾åˆ°å¿«é€Ÿé¢„æµ‹çš„æ•ˆæœã€‚</p>

<p>æ¨ç†é¡¹ç›®çš„ä¸€èˆ¬å®ç°è¿‡ç¨‹ï¼š</p>

<ul>
  <li>æ¨¡å‹çš„è®­ç»ƒï¼šä¸»è¦æ˜¯æ•°æ®çš„é¢„å¤„ç†ï¼Œç½‘ç»œçš„è®¾è®¡ï¼Œæ¨¡å‹çš„è®­ç»ƒï¼Œ</li>
  <li>è§£å†³æ–¹æ¡ˆçš„è®¾è®¡ï¼šç®—æ³•å¹³å°çš„ç¡®å®šï¼Œç¼–ç¨‹è¯­è¨€ï¼Œç¡¬ä»¶ç¡®å®š;ç½‘ç»œçš„è¾“å…¥å’Œè¾“å‡ºç­‰</li>
  <li>è§£å†³æ–¹æ¡ˆçš„å®æ–½ï¼šä½¿ç”¨tensorRTæ¨ç†æ¡†æ¶è¿›è¡Œéƒ¨ç½²ã€‚</li>
</ul>

<h3 id="21-tensorrtçš„å·¥ä½œåŸç†">2.1 tensorRTçš„å·¥ä½œåŸç†</h3>

<ul>
  <li>ç½‘ç»œå®šä¹‰(Network Definition):</li>
  <li>å»ºç«‹(Builder):å»ºç«‹ç›¸å…³çš„ç½‘ç»œã€‚</li>
  <li>æ¨ç†å¼•æ“(Engine)ï¼š</li>
</ul>

<p>tenosrRTæä¾›å…¶ä»–çš„å·¥å…·å¯ä»¥å°†ï¼Œå…¶å®ƒçš„ç½‘ç»œæ¨¡å‹è½¬æ¢åˆ°å½“å‰çš„ç½‘ç»œæ¨¡å‹ä¸­ã€‚</p>

<ul>
  <li>Caffe Parserï¼š</li>
  <li>UFF Parse:</li>
  <li>ONNX Parser:</li>
</ul>

<h2 id="3-tensorrtçš„ä¸€èˆ¬ä½¿ç”¨">3. TensorRTçš„ä¸€èˆ¬ä½¿ç”¨</h2>

<h3 id="31-ç¨‹åºè®¾è®¡çš„ä¸€èˆ¬æµç¨‹">3.1 ç¨‹åºè®¾è®¡çš„ä¸€èˆ¬æµç¨‹ï¼š</h3>

<ol>
  <li>åˆ›å»ºç½‘ç»œ
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IBuilder</span><span class="o">*</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">createInferBuilder</span><span class="p">(</span><span class="n">gLogger</span><span class="p">);</span>
<span class="n">INetworkDefinition</span><span class="o">*</span> <span class="n">network</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">createNetwork</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>æ·»åŠ è¾“å…¥æ•°æ®
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">data</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">addInput</span><span class="p">(</span><span class="n">INPUT_BLOB_NAME</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Dims3</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">INPUT_H</span><span class="p">,</span> <span class="n">INPUT_W</span><span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li>æ·»åŠ å·ç§¯å±‚ï¼šä¼ é€’ç»™tensorRTçš„æƒé‡å­˜åœ¨åœ¨hostä¸»æœºä¸­
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">conv1</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">addConvolution</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">20</span><span class="p">,</span> <span class="n">DimsHW</span><span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span> <span class="n">weightMap</span><span class="p">[</span><span class="s">"conv1filter"</span><span class="p">],</span> <span class="n">weightMap</span><span class="p">[</span><span class="s">"conv1bias"</span><span class="p">]);</span>
<span class="n">conv1</span><span class="o">-&gt;</span><span class="n">setStride</span><span class="p">(</span><span class="n">DimsHW</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li>æ·»åŠ æ± åŒ–å±‚ï¼š
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">pool1</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">addPooling</span><span class="p">(</span><span class="o">*</span><span class="n">conv1</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">PoolingType</span><span class="o">::</span><span class="n">kMAX</span><span class="p">,</span> <span class="n">DimsHW</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">});</span>
<span class="n">pool1</span><span class="o">-&gt;</span><span class="n">setStride</span><span class="p">(</span><span class="n">DimsHW</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">});</span>
</code></pre></div>    </div>
  </li>
  <li>æ·»åŠ å…¨è¿æ¥å±‚
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">ip1</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">addFullyConnected</span><span class="p">(</span><span class="o">*</span><span class="n">pool1</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mi">500</span><span class="p">,</span> <span class="n">weightMap</span><span class="p">[</span><span class="s">"ip1filter"</span><span class="p">],</span> <span class="n">weightMap</span><span class="p">[</span><span class="s">"ip1bias"</span><span class="p">]);</span>
<span class="k">auto</span> <span class="n">relu1</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">addActivation</span><span class="p">(</span><span class="o">*</span><span class="n">ip1</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">ActivationType</span><span class="o">::</span><span class="n">kRELU</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>æ·»åŠ SotfMaxå±‚
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">addSoftMax</span><span class="p">(</span><span class="o">*</span><span class="n">relu1</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="n">prob</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">setName</span><span class="p">(</span><span class="n">OUTPUT_BLOB_NAME</span><span class="p">);</span>
</code></pre></div>    </div>
  </li>
  <li>è·å–è¾“å‡ºå±‚
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>network-&gt;markOutput(*prob-&gt;getOutput(0));
</code></pre></div>    </div>
  </li>
</ol>

<h3 id="32-å¯¼å…¥å¤–éƒ¨æ¨¡å‹">3.2 å¯¼å…¥å¤–éƒ¨æ¨¡å‹</h3>

<ol>
  <li>åˆ›å»ºbuilderå’Œç½‘ç»œ
    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">IBuilder</span><span class="o">*</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">createInferBuilder</span><span class="p">(</span><span class="n">gLogger</span><span class="p">);</span>
<span class="n">nvinfer1</span><span class="o">::</span><span class="n">INetworkDefinition</span><span class="o">*</span> <span class="n">network</span> <span class="o">=</span> <span class="n">builder</span><span class="o">-&gt;</span><span class="n">createNetwork</span><span class="p">();</span>
</code></pre></div>    </div>
  </li>
  <li>ä»å…¶ä»–ç‰¹æ®Šæ ¼å¼æ–‡ä»¶ä¸­åˆ›å»º
```c++
//è·å–ç›¸å…³ç½‘ç»œå‚æ•°</li>
</ol>

<p>//ONNX</p>

<p>auto parser = nvonnxparser::createParser(*network, gLogger);
//UFF</p>

<p>auto parser = nvuffparser::createUffParser();
//Caffe</p>

<p>auto parser = nvcaffeparser1::createCaffeParser();</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>3. è·å–å‚æ•°
```c++
parser-&gt;parse(args);
</code></pre></div></div>

<h3 id="33-å¯¼å…¥ä¸€ä¸ªcaffeæ¨¡å‹">3.3 å¯¼å…¥ä¸€ä¸ªcaffeæ¨¡å‹</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ›å»ºbuilder</span>

<span class="n">IBuilder</span><span class="o">*</span> <span class="n">builder</span><span class="o">=</span><span class="n">createInferBuilder</span><span class="p">(</span><span class="n">gLogger</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºä¸€ä¸ªæ¨ç†ç½‘ç»œ</span>

<span class="n">INetworkDefinition</span><span class="o">*</span> <span class="n">network</span><span class="o">=</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">createNetwork</span><span class="p">();</span>

<span class="c1">//åˆ›å»ºcaffeå‚æ•°</span>

<span class="n">ICaffeParser</span><span class="o">*</span> <span class="n">parser</span><span class="o">=</span><span class="n">createCaffeParser</span><span class="p">();</span>

<span class="c1">//ä»å‚æ•°ä¸­å¯¼å…¥æ¨¡å‹</span>

<span class="k">const</span> <span class="n">IBlobNameToTensor</span><span class="o">=</span><span class="n">parser</span><span class="o">-&gt;</span><span class="n">parse</span><span class="p">(</span><span class="s">"deploy_file"</span> <span class="p">,</span> <span class="s">"modelFile"</span><span class="p">,</span> <span class="o">*</span><span class="n">network</span><span class="p">,</span> <span class="n">DataType</span><span class="o">::</span><span class="n">kFLOAT</span><span class="p">);</span>

<span class="c1">//è®¾ç½®è¾“å‡ºå‚æ•°</span>

<span class="k">for</span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="n">s</span><span class="o">:</span><span class="n">outputs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">network</span><span class="o">-&gt;</span><span class="n">markOutput</span><span class="p">(</span><span class="o">*</span><span class="n">blobNameToTensor</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">c</span><span class="p">,</span><span class="n">str</span><span class="p">()));</span>
<span class="p">}</span>

</code></pre></div></div>
<h3 id="34-åˆ›å»ºä¸€ä¸ªengine">3.4 åˆ›å»ºä¸€ä¸ªEngine</h3>

<h4 id="341-ä½¿ç”¨builderå»ºç«‹ä¸€ä¸ªå¼•æ“">3.4.1 ä½¿ç”¨builderå»ºç«‹ä¸€ä¸ªå¼•æ“</h4>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">-&gt;</span><span class="n">setMaxBatchSize</span><span class="p">(</span><span class="n">maxBatchSize</span><span class="p">);</span>
<span class="n">builder</span><span class="o">-&gt;</span><span class="n">setMaxWorkspaceSize</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">);</span>
<span class="n">ICudaEngine</span><span class="o">*</span> <span class="n">engine</span><span class="o">=</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">buildCudaEngine</span><span class="p">(</span><span class="o">*</span><span class="n">network</span><span class="p">);</span>

</code></pre></div></div>

<h4 id="342-ç›¸å…³å˜é‡çš„é”€æ¯">3.4.2 ç›¸å…³å˜é‡çš„é”€æ¯</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parser</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
<span class="n">network</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
<span class="n">builder</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>

</code></pre></div></div>
<h3 id="35-åœ¨cä¸­åºåˆ—åŒ–æ¨¡å‹">3.5 åœ¨c++ä¸­åºåˆ—åŒ–æ¨¡å‹</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//æŒ‰ç…§ä¸Šæ–‡è¿›è¡Œç¦»çº¿çš„builderå»ºç«‹--å­˜å‚¨æ¨¡å‹</span>

<span class="n">IHostMemory</span> <span class="o">*</span><span class="n">serializedModel</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">serialize</span><span class="p">();</span>
<span class="c1">//å°†æ¨¡å‹å­˜å‚¨åˆ°ç£ç›˜ä¸Š</span>
<span class="p">...</span>
<span class="c1">//é”€æ¯å»ºç«‹çš„æ¨¡å‹</span>

<span class="n">serializedModel</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>

<span class="c1">//åˆ›å»ºè¦ååºåˆ—åŒ–çš„è¿è¡Œæ—¶å¯¹è±¡--åŠ è½½æ¨¡å‹</span>
<span class="n">IRuntime</span><span class="o">*</span> <span class="n">runtime</span><span class="o">=</span><span class="n">createInferRuntime</span><span class="p">(</span><span class="n">gLogger</span><span class="p">);</span>
<span class="n">ICudaEngine</span><span class="o">*</span> <span class="n">engine</span><span class="o">=</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">deserializeCudaEngine</span><span class="p">(</span><span class="n">modelData</span><span class="p">,</span> <span class="n">modelSize</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">);</span>

</code></pre></div></div>

<h3 id="36-é«˜æ€§èƒ½çš„æ¨ç†">3.6 é«˜æ€§èƒ½çš„æ¨ç†</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ›å»ºä¸€ä¸ªæ¨ç†ä¸Šä¸‹æ–‡</span>

<span class="n">IExecutionContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">createExecutionContext</span><span class="p">();</span>
<span class="c1">//æ ¹æ®è¾“å…¥å’Œè¾“å‡ºçš„åç§°ç¡®å®šè¾“å…¥è¾“å‡ºblobçš„ç´¢å¼•</span>

<span class="kt">int</span> <span class="n">inputIndex</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">getBindingIndex</span><span class="p">(</span><span class="n">INPUT_BLOB_NAME</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">outputIndex</span> <span class="o">=</span> <span class="n">engine</span><span class="o">-&gt;</span><span class="n">getBindingIndex</span><span class="p">(</span><span class="n">OUTPUT_BLOB_NAME</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºæŒ‡é’ˆï¼ŒæŒ‡å‘è¾“å…¥è¾“å‡ºbuffer</span>

<span class="kt">void</span><span class="o">*</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">buffer</span><span class="p">[</span><span class="n">inputIndex</span><span class="p">]</span><span class="o">=</span><span class="n">inputbuffer</span><span class="p">;</span>
<span class="n">buffer</span><span class="p">[</span><span class="n">outputIndex</span><span class="p">]</span><span class="o">=</span><span class="n">outputBuffer</span>
<span class="c1">//å› ä¸ºtensorrtæ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤å°†kerneksæ·»åŠ åˆ°cudaæµå½“ä¸­</span>

<span class="n">context</span><span class="o">-&gt;</span><span class="n">enqueue</span><span class="p">(</span><span class="n">batchSize</span><span class="p">,</span><span class="n">buffers</span><span class="p">,</span><span class="n">stream</span><span class="p">,</span><span class="nb">nullptr</span><span class="p">);</span>
</code></pre></div></div>
<h3 id="37-å†…å­˜ç®¡ç†å’Œå¼•æ“æ›´æ”¹">3.7 å†…å­˜ç®¡ç†å’Œå¼•æ“æ›´æ”¹</h3>

<p>é»˜è®¤çš„å†…å­˜ç®¡ç†æ˜¯åˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼š<code class="language-plaintext highlighter-rouge">IExecutionContext</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å»ºç«‹ä¸€ä¸ªå¯ä¿®æ”¹çš„æ¨ç†å¼•æ“</span>

<span class="n">builder</span><span class="o">-&gt;</span><span class="n">setRefittable</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºnetworkæ¨ç†å¼•æ“</span>

<span class="n">builder</span><span class="o">-&gt;</span><span class="n">buildCudaEngine</span><span class="p">(</span><span class="n">network</span><span class="p">);</span>
<span class="c1">//åˆ›å»ºä¸€ä¸ªå¯æ›´æ”¹çš„å¯¹è±¡</span>

<span class="n">ICudaEngine</span><span class="o">*</span> <span class="n">engine</span><span class="o">=</span><span class="p">...;</span>
<span class="n">IRefitter</span><span class="o">*</span> <span class="n">refitter</span><span class="o">=</span><span class="n">createInferRefitter</span><span class="p">(</span><span class="o">*</span><span class="n">engine</span><span class="p">,</span><span class="n">gLogger</span><span class="p">);</span>
<span class="c1">//æ›´æ–°æƒé‡,æ³¨æ„æ–°æƒé‡åº”è¯¥åœ¨å°ºå¯¸ä¸Šå’Œæ—§æƒé‡ç›¸åŒï¼Œé¿å…å†…å­˜é”™è¯¯</span>
<span class="n">Weights</span> <span class="n">newWeights</span><span class="o">=</span><span class="p">...;</span>
<span class="n">refitter</span><span class="o">-&gt;</span><span class="n">setWeights</span><span class="p">(</span><span class="s">"MyLayer"</span><span class="p">,</span><span class="n">WeightsRole</span><span class="o">::</span><span class="n">KKERNEL</span><span class="p">,</span><span class="n">newWeights</span><span class="p">);</span>
<span class="c1">//æ‰¾åˆ°å…¶å®ƒå¿…é¡»è¢«æ”¯æŒçš„ç½‘ç»œå‚æ•°</span>

<span class="k">const</span> <span class="kt">int</span> <span class="n">n</span><span class="o">=</span><span class="n">refitter</span><span class="o">-&gt;</span><span class="n">getMissing</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">nullptr</span><span class="p">,</span><span class="nb">nullptr</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span> <span class="n">layerName</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">WeightsRole</span><span class="o">&gt;</span> <span class="n">WeightsRoles</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="n">refitter</span><span class="o">-&gt;</span><span class="n">getMissing</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">layerNames</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="n">weightsRoles</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="c1">//æ”¯æŒä¸¢å¤±çš„æƒé‡</span>
<span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">){</span>
    <span class="n">refitter</span><span class="o">-&gt;</span><span class="n">setWeights</span><span class="p">(</span><span class="n">layerNames</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">weightsRoles</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">Weights</span><span class="p">{...});</span>
<span class="p">}</span>

<span class="c1">//æ›´æ–°æ•´ä¸ªæ¨ç†å¼•æ“çš„æƒé‡</span>
<span class="kt">bool</span> <span class="n">success</span><span class="o">=</span><span class="n">refitter</span><span class="o">-&gt;</span><span class="n">refitCudaEngine</span><span class="p">();</span>
<span class="n">assert</span><span class="p">(</span><span class="n">success</span><span class="p">);</span>
<span class="c1">//é”€æ¯ refitter</span>
<span class="n">refitter</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
</code></pre></div></div>

<h2 id="4-ä¼ ç»Ÿlayersçš„tensorrtæ‹“å±•">4. ä¼ ç»Ÿlayersçš„tensorRTæ‹“å±•</h2>

<p>tenosrRTä¸­å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">IPluginV2Ext</code>å’Œ<code class="language-plaintext highlighter-rouge">IPluginCreator</code>æ¥å¯¹å·²æœ‰çš„ç½‘ç»œè¿›è¡Œæ‹“å±•ã€‚</p>

<ul>
  <li><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-api/c_api/classnvinfer1_1_1_i_plugin_v2_ext.html">IPluginV2Ext</a>
    <ul>
      <li>è¿™ä¸ªç±»æ˜¯æ’ä»¶æ‰©å±•çš„åŸºç¡€ç±»ï¼Œæ”¯æŒä½¿ç”¨ä¼ ç»Ÿçš„ç‰ˆæœ¬</li>
    </ul>
  </li>
  <li><a href="https://docs.nvidia.com/deeplearning/sdk/tensorrt-api/c_api/classnvinfer1_1_1_i_plugin_creator.html">IPluginCreator</a>
    <ul>
      <li>IPluginCreatoræ˜¯è‡ªå®šä¹‰å›¾å±‚çš„åˆ›å»ºè€…ç±»ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨å®ƒæ¥è·å–æ’ä»¶åç§°ï¼Œç‰ˆæœ¬å’Œæ’ä»¶å­—æ®µå‚æ•°ã€‚ å®ƒè¿˜æä¾›äº†åœ¨ç½‘ç»œæ„å»ºé˜¶æ®µåˆ›å»ºæ’ä»¶å¯¹è±¡çš„æ–¹æ³•ï¼Œå¹¶åœ¨æ¨ç†æœŸé—´å¯¹å…¶è¿›è¡Œååºåˆ—åŒ–ã€‚</li>
    </ul>
  </li>
</ul>

<p>TensorRTè¿˜æä¾›äº†é€šè¿‡è°ƒç”¨REGISTER_TENSORRT_PLUGINï¼ˆpluginCreatorï¼‰æ¥æ³¨å†Œæ’ä»¶çš„åŠŸèƒ½ï¼Œè¯¥æ’ä»¶å°†æ’ä»¶åˆ›å»ºè€…é™æ€æ³¨å†Œåˆ°æ’ä»¶æ³¨å†Œè¡¨ã€‚åœ¨è¿è¡Œæ—¶ï¼Œå¯ä»¥ä½¿ç”¨externå‡½æ•°getPluginRegistryï¼ˆï¼‰æŸ¥è¯¢æ’ä»¶æ³¨å†Œè¡¨ã€‚æ’ä»¶æ³¨å†Œè¡¨å­˜å‚¨æŒ‡å‘æ‰€æœ‰å·²æ³¨å†Œçš„æ’ä»¶åˆ›å»ºå™¨çš„æŒ‡é’ˆï¼Œå¯ç”¨äºæ ¹æ®æ’ä»¶åç§°å’Œç‰ˆæœ¬æŸ¥æ‰¾ç‰¹å®šçš„æ’ä»¶åˆ›å»ºå™¨ã€‚TensorRTåº“åŒ…å«å¯ä»¥åŠ è½½åˆ°åº”ç”¨ç¨‹åºä¸­çš„æ’ä»¶ã€‚æ‰€æœ‰è¿™äº›æ’ä»¶çš„ç‰ˆæœ¬éƒ½è®¾ç½®ä¸º1.è¿™äº›æ’ä»¶çš„åç§°æ˜¯ï¼š</p>

<ul>
  <li>RPROI_TRT</li>
  <li>Normalize_TRT</li>
  <li>PriorBox_TRT</li>
  <li>GridAnchor_TRT</li>
  <li>NMS_TRT</li>
  <li>LReLU_TRT</li>
  <li>Reorg_TRT</li>
  <li>Region_TRT</li>
  <li>Clip_TRT</li>
</ul>

<p>æ³¨æ„ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨è¿™äº›æ’ä»¶ï¼Œ<code class="language-plaintext highlighter-rouge">libnvinfer_plugin.so</code>é“¾æ¥åº“ï¼Œå¿…é¡»è¢«åŒ…æ‹¬åœ¨é¡¹ç›®ä¸­ã€‚å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">initLibNvInferPlugins(void* logger, const char* libNamespace)</code>å‡½æ•°æ¥è¿›è¡Œåˆå§‹åŒ–ã€‚</p>

<p>ä¸€ä¸ªç®€å•çš„æ·»åŠ æ‰©å±•layerçš„ä»£ç å¦‚ä¸‹æ‰€ç¤º;</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//ä½¿ç”¨externå‡½æ•°getPluginRegistryè®¿é—®å…¨å±€TensorRTæ’ä»¶æ³¨å†Œè¡¨</span>

<span class="k">auto</span> <span class="n">creator</span> <span class="o">=</span> <span class="n">getPluginRegistry</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getPluginCreator</span><span class="p">(</span><span class="n">pluginName</span><span class="p">,</span> <span class="n">pluginVersion</span><span class="p">);</span>
<span class="k">const</span> <span class="n">PluginFieldCollection</span><span class="o">*</span> <span class="n">pluginFC</span> <span class="o">=</span> <span class="n">creator</span><span class="o">-&gt;</span><span class="n">getFieldNames</span><span class="p">();</span>
<span class="c1">//å¡«å……æ’ä»¶å±‚çš„å­—æ®µå‚æ•°ï¼ˆæ¯”å¦‚layerFieldsï¼‰</span>

<span class="n">PluginFieldCollection</span> <span class="o">*</span><span class="n">pluginData</span> <span class="o">=</span> <span class="n">parseAndFillFields</span><span class="p">(</span><span class="n">pluginFC</span><span class="p">,</span> <span class="n">layerFields</span><span class="p">);</span> 
<span class="c1">//ä½¿ç”¨layerNameå’Œæ’ä»¶å…ƒæ•°æ®åˆ›å»ºæ’ä»¶å¯¹è±¡</span>

<span class="n">IPluginV2</span> <span class="o">*</span><span class="n">pluginObj</span> <span class="o">=</span> <span class="n">creator</span><span class="o">-&gt;</span><span class="n">createPlugin</span><span class="p">(</span><span class="n">layerName</span><span class="p">,</span> <span class="n">pluginData</span><span class="p">);</span>
<span class="c1">//ä½¿ç”¨ç½‘ç»œAPIå°†æ’ä»¶æ·»åŠ åˆ°TensorRTç½‘ç»œ</span>

<span class="k">auto</span> <span class="n">layer</span> <span class="o">=</span> <span class="n">network</span><span class="p">.</span><span class="n">addPluginV2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kt">int</span><span class="p">(</span><span class="n">inputs</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span> <span class="n">pluginObj</span><span class="p">);</span>

<span class="err">â€¦</span> <span class="p">(</span><span class="n">build</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">network</span> <span class="n">and</span> <span class="n">serialize</span> <span class="n">engine</span><span class="p">)</span>
<span class="c1">//é”€æ¯æ’ä»¶å¯¹è±¡</span>

<span class="n">pluginObj</span><span class="o">-&gt;</span><span class="n">destroy</span><span class="p">();</span>
<span class="err">â€¦</span> <span class="p">(</span><span class="n">destroy</span> <span class="n">network</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>
<span class="err">â€¦</span> <span class="p">(</span><span class="n">free</span> <span class="n">allocated</span> <span class="n">pluginData</span><span class="p">)</span>

</code></pre></div></div>
<p>æ³¨æ„ï¼š</p>
<ul>
  <li>pluginDataåº”è¯¥åœ¨ä¼ é€’ç»™createPluginä¹‹å‰åœ¨å †ä¸Šåˆ†é…PluginFieldæ¡ç›®ã€‚</li>
  <li>ä¸Šé¢çš„createPluginæ–¹æ³•å°†åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„æ’ä»¶å¯¹è±¡å¹¶è¿”å›æŒ‡å‘å®ƒçš„æŒ‡é’ˆã€‚ç¡®ä¿é”€æ¯pluginObjï¼Œå¦‚ä¸Šæ‰€ç¤ºï¼Œä»¥é¿å…å†…å­˜æ³„æ¼ã€‚</li>
</ul>

<p>åœ¨åºåˆ—åŒ–æœŸé—´ï¼ŒTensorRTå¼•æ“å°†åœ¨å†…éƒ¨å­˜å‚¨æ‰€æœ‰IPluginV2ç±»å‹æ’ä»¶çš„æ’ä»¶ç±»å‹ï¼Œæ’ä»¶ç‰ˆæœ¬å’Œå‘½åç©ºé—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ã€‚åœ¨ååºåˆ—åŒ–æœŸé—´ï¼ŒTensorRTå¼•æ“ä¼šæŸ¥æ‰¾æ­¤ä¿¡æ¯ï¼Œä»¥ä¾¿ä»æ’ä»¶æ³¨å†Œè¡¨ä¸­æ‰¾åˆ°æ’ä»¶åˆ›å»ºå™¨ã€‚è¿™ä½¿TensorRTå¼•æ“èƒ½å¤Ÿåœ¨å†…éƒ¨è°ƒç”¨<code class="language-plaintext highlighter-rouge">IPluginCreator::deserializePlugin()</code>æ–¹æ³•ã€‚ ååºåˆ—åŒ–æœŸé—´åˆ›å»ºçš„æ’ä»¶å¯¹è±¡å°†ç”±TensorRTå¼•æ“é€šè¿‡è°ƒç”¨<code class="language-plaintext highlighter-rouge">IPluginV2::destroy()</code>æ–¹æ³•åœ¨å†…éƒ¨é”€æ¯ã€‚</p>

<p>åœ¨ä»¥å‰çš„TensorRTç‰ˆæœ¬ä¸­ï¼Œæ‚¨å¿…é¡»å®ç°<code class="language-plaintext highlighter-rouge">nvinfer1::IPluginFactory</code>ç±»ä»¥åœ¨ååºåˆ—åŒ–æœŸé—´è°ƒç”¨createPluginæ–¹æ³•ã€‚å¯¹äºä½¿ç”¨TensorRTæ³¨å†Œå¹¶ä½¿ç”¨addPluginV2æ·»åŠ çš„æ’ä»¶ï¼Œä¸å†éœ€è¦è¿™æ ·åšã€‚</p>

<p>åˆ›å»ºä¸€ä¸ªä¼ ç»Ÿçš„caffe layer</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//åˆ›å»ºä¸€ä¸ªæ–°çš„FooPlugin</span>

<span class="k">class</span> <span class="nc">FooPlugin</span><span class="o">:</span><span class="k">public</span> <span class="n">IPluginExt</span>
<span class="p">{</span>
    <span class="p">...</span><span class="n">implement</span> <span class="n">all</span> <span class="k">class</span> <span class="nc">methods</span> <span class="k">for</span> <span class="n">your</span> <span class="n">plugin</span>
<span class="p">};</span>
<span class="k">class</span> <span class="nc">MyPluginFactory</span> <span class="o">:</span> <span class="k">public</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IPluginFactory</span><span class="p">,</span> <span class="k">public</span> <span class="n">nvcaffeparser1</span><span class="o">::</span><span class="n">IPluginFactoryExt</span>
<span class="p">{</span>
    <span class="p">...</span><span class="n">implement</span> <span class="n">all</span> <span class="n">factory</span> <span class="n">methods</span> <span class="k">for</span> <span class="n">your</span> <span class="n">plugin</span>
<span class="p">};</span>
<span class="c1">//ä½¿ç”¨IPluginV2çš„æ’ä»¶æ³¨å†Œå™¨ï¼Œå¯ä»¥ä¸ç”¨å¯¼å…¥nvinfer1::IPluginFactoryï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨nvcaffeparser1::IPluginFactoryV2å’ŒIPluginCreatoræ¥ä»£æ›¿æ³¨å†Œå¯¼å…¥</span>

<span class="k">class</span> <span class="nc">FooPlugin</span><span class="o">:</span><span class="k">public</span> <span class="n">IPluginV2</span>
<span class="p">{</span>
    <span class="p">...</span><span class="n">implement</span> <span class="n">all</span> <span class="k">class</span> <span class="nc">methods</span> <span class="k">for</span> <span class="n">your</span> <span class="n">plugin</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">FooPluginFactory</span><span class="o">:</span><span class="k">public</span> <span class="n">nvcaffeparser1</span><span class="o">::</span><span class="n">IPluginFactoryV2</span>
<span class="p">{</span>
    <span class="k">virtual</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">IPluginV2</span><span class="o">*</span> <span class="n">createPlugin</span><span class="p">(...)</span>
    <span class="p">{</span>
        <span class="p">...</span><span class="n">create</span> <span class="n">and</span> <span class="k">return</span> <span class="n">plugin</span> <span class="n">object</span> <span class="n">of</span> <span class="n">type</span> <span class="n">FooPlugin</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">isPlugin</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span> 
    <span class="p">{</span>
        <span class="p">...</span><span class="n">check</span> <span class="k">if</span> <span class="n">layer</span> <span class="n">name</span> <span class="n">corresponds</span> <span class="n">to</span> <span class="n">plugin</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">FooPluginCreator</span><span class="o">:</span><span class="k">public</span> <span class="n">IPluginCreator</span>
<span class="p">{</span>
    <span class="p">...</span><span class="n">implement</span> <span class="n">all</span> <span class="n">creator</span> <span class="n">methods</span> <span class="n">here</span>
<span class="p">};</span>
<span class="n">REGISTER_TENSORRT_PLUGIN</span><span class="p">(</span><span class="n">FooPluginCreator</span><span class="p">);</span>

</code></pre></div></div>

<h2 id="5-ä½¿ç”¨æ··åˆç²¾åº¦">5. ä½¿ç”¨æ··åˆç²¾åº¦</h2>

<p>TensorRTæ”¯æŒ32-bitã€16-bitå’Œ8-bitçš„æ··åˆç²¾åº¦çš„è¿ç®—ã€‚ä½¿ç”¨å¦‚ä¸‹APIå¼€å¯æ··åˆç²¾åº¦</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">platformHasFastFp16</span><span class="p">())</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">};</span> 
<span class="k">if</span> <span class="p">(</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">platformHasFastInt8</span><span class="p">())</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">};</span>
</code></pre></div></div>

<p>è®¾ç½®layerçš„ç²¾åº¦</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è®¾ç½®å…è®¸çš„ç²¾åº¦</span>

<span class="n">layer</span><span class="o">-&gt;</span><span class="n">setPrecision</span><span class="p">(</span><span class="n">nvinfer1</span><span class="o">::</span><span class="n">DataType</span><span class="o">::</span><span class="n">kINT8</span><span class="p">);</span>
<span class="c1">//è®¾ç½®è¾“å‡ºç±»å‹å’Œç²¾åº¦</span>

<span class="n">layer</span><span class="o">-&gt;</span><span class="n">setOutputType</span><span class="p">(</span><span class="n">out_tensor_index</span><span class="p">,</span> <span class="n">nvinfer1</span><span class="o">::</span><span class="n">DataType</span><span class="o">::</span><span class="n">kFLOAT</span><span class="p">)</span>
<span class="c1">//ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼ï¼Œä½¿å¾—ä¸Šè¿°æ“ä½œå¼ºåˆ¶æ‰§è¡Œ</span>

<span class="n">builder</span><span class="o">-&gt;</span><span class="n">setStrictTypeConstraints</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="c1">//å…è®¸Fp16Modeæ¨ç†</span>

<span class="n">builder</span><span class="o">-&gt;</span><span class="n">setFp16Mode</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="c1">//æ­¤æ ‡å¿—å…è®¸ï¼ˆä½†ä¸ä¿è¯ï¼‰åœ¨æ„å»ºå¼•æ“æ—¶å°†ä½¿ç”¨16ä½å†…æ ¸ã€‚æ‚¨å¯ä»¥é€šè¿‡è®¾ç½®ä»¥ä¸‹æ„å»ºå™¨æ ‡å¿—æ¥é€‰æ‹©å¼ºåˆ¶16ä½ç²¾åº¦ï¼š</span>

<span class="n">builder</span><span class="o">-&gt;</span><span class="n">setStrictTypeConstraints</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</code></pre></div></div>
<h3 id="58-ä½¿ç”¨int8é‡åŒ–">5.8 ä½¿ç”¨INT8é‡åŒ–</h3>
<p><em>å‚è€ƒé“¾æ¥:</em></p>

<ul>
  <li><a href="https://zhuanlan.zhihu.com/p/58182172">Int8é‡åŒ–-ä»‹ç»</a></li>
</ul>

<p>ä½¿ç”¨INT8é‡åŒ–ä¹‹å‰éœ€è¦é¦–å…ˆè®¾ç½®æ¨ç†å…è®¸ä½¿ç”¨INT8æ¨¡å¼</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">builder</span><span class="o">-&gt;</span><span class="n">setInt8Mode</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</code></pre></div></div>

<p>æ³¨æ„ä½¿ç”¨INT8é‡åŒ–ä¹‹å‰ï¼Œéœ€è¦å¯¹32ä½çš„æ•°æ®è¿›è¡Œé‡åŒ–è£å‰ªã€‚TensorRTå¸Œæœ›ä½ ä½¿ç”¨åŠ¨æ€èŒƒå›´æŠ€æœ¯æ¥è¿›è¡Œæ¯ä¸ªçš„æ¨ç†ã€‚å¯ä»¥è®¾ç½®èŒƒå›´å¦‚ä¸‹ï¼š</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//è®¾ç½®é‡åŒ–èŒƒå›´</span>

<span class="n">ITensor</span><span class="o">*</span> <span class="n">tensor</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">getLayer</span><span class="p">(</span><span class="n">layer_index</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getOutput</span><span class="p">(</span><span class="n">output_index</span><span class="p">);</span>
<span class="n">tensor</span><span class="o">-&gt;</span><span class="n">setDynamicRange</span><span class="p">(</span><span class="n">min_float</span><span class="p">,</span> <span class="n">max_float</span><span class="p">);</span>
<span class="c1">//è®¾ç½®è¾“å…¥</span>

<span class="n">ITensor</span><span class="o">*</span> <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">network</span><span class="o">-&gt;</span><span class="n">getInput</span><span class="p">(</span><span class="n">input_index</span><span class="p">);</span>
<span class="n">input_tensor</span><span class="o">-&gt;</span><span class="n">setDynamicRange</span><span class="p">(</span><span class="n">min_float</span><span class="p">,</span> <span class="n">max_float</span><span class="p">);</span>

</code></pre></div></div>
<h4 id="581-ä½¿ç”¨cè¿›è¡Œint8æ ¡å‡†">5.8.1 ä½¿ç”¨C++è¿›è¡ŒINT8æ ¡å‡†</h4>

<p>INT8æ ¡å‡†æä¾›äº†ç”Ÿæˆæ¯ä¸ªæ¿€æ´»å¼ é‡åŠ¨æ€èŒƒå›´çš„æ›¿ä»£æ–¹æ¡ˆã€‚å¯ä»¥å°†è¯¥æ–¹æ³•å½’ç±»ä¸ºåè®­ç»ƒæŠ€æœ¯ä»¥ç”Ÿæˆé€‚å½“çš„é‡åŒ–æ¯”ä¾‹ã€‚ç¡®å®šè¿™äº›æ¯”ä¾‹å› å­çš„è¿‡ç¨‹ç§°ä¸ºæ ¡å‡†ï¼Œå¹¶è¦æ±‚åº”ç”¨ç¨‹åºä¼ é€’æ‰¹é‡çš„ç½‘ç»œä»£è¡¨æ€§è¾“å…¥ï¼ˆé€šå¸¸æ¥è‡ªè®­ç»ƒé›†çš„æ‰¹æ¬¡ï¼‰ã€‚å®éªŒè¡¨æ˜ï¼Œå¤§çº¦500ä¸ªå›¾åƒè¶³ä»¥æ ¡å‡†ImageNetåˆ†ç±»ç½‘ç»œã€‚</p>

<p>æ„å»ºINT8å¼•æ“æ—¶ï¼Œæ„å»ºå™¨æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
  <li>æ„å»ºä¸€ä¸ª32ä½å¼•æ“ï¼Œåœ¨æ ¡å‡†é›†ä¸Šè¿è¡Œå®ƒï¼Œå¹¶è®°å½•æ¿€æ´»å€¼åˆ†å¸ƒçš„æ¯ä¸ªå¼ é‡çš„ç›´æ–¹å›¾ã€‚</li>
  <li>æ ¹æ®ç›´æ–¹å›¾æ„å»ºæ ¡å‡†è¡¨ã€‚</li>
  <li>ä»æ ¡å‡†è¡¨å’Œç½‘ç»œå®šä¹‰æ„å»ºINT8å¼•æ“ã€‚</li>
</ul>

:ET