I"‚A<blockquote>
  <p>2019-7-28 19:46:53</p>
</blockquote>

<h2 id="åºåˆ—å¼å®¹å™¨">åºåˆ—å¼å®¹å™¨</h2>

<h3 id="41-å®¹å™¨çš„æ¦‚è§‚ä¸åˆ†ç±»">4.1 å®¹å™¨çš„æ¦‚è§‚ä¸åˆ†ç±»</h3>

<p>å®¹å™¨ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
  <li>åºåˆ—å¼å®¹å™¨ï¼šæ•°æ®çš„æœ‰åºå­˜æ”¾å¦‚listã€vector</li>
  <li>å…³è”å¼å®¹å™¨ï¼šæ•°æ®çš„ç›¸äº’å…³è”å¦‚mapå’Œpairç­‰</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-19-54-47.png" alt="åºåˆ—å®¹å™¨å’Œå…³è”å®¹å™¨" /></p>

<p>ç¬¬å››ç« ä¸»è¦è®²è¿°åºåˆ—å®¹å™¨</p>

<h3 id="42-vector">4.2 vector</h3>

<h4 id="421-vectoræ¦‚è¿°">4.2.1 vectoræ¦‚è¿°</h4>

<p>vectorä¸arrayéå¸¸æƒ³æ­»ï¼Œä½†æ˜¯arrayæ˜¯é™æ€ç©ºé—´ï¼Œä¸€æ—¦é…ç½®äº†å°±ä¸å«©æ”¹å˜ï¼Œvectoræ˜¯åŠ¨æ€ç©ºé—´ï¼Œå¯ä»¥è‡ªå·±åŠ¨æ€å¢é•¿ï¼›</p>

<p>vectoræœ¬è´¨è¿˜æ˜¯ä½¿ç”¨çš„allocatoræ¥è¿›è¡Œå†…å­˜ç©ºé—´çš„åˆ†é…ï¼Œå› æ­¤å®ƒçš„å†…å­˜æ¨¡å¼æ˜¯ç”±allocatoræ¥å†³å®šçš„ã€‚æ‰€ä»¥vectoræ˜¯ä¸€ä¸ªè¿ç»­çš„ç©ºé—´ï¼Œä½†æ˜¯æ¯æ¬¡åˆ†é…çš„è¿‡äºå°çš„æ—¶å€™ï¼Œä¼šé€ æˆæ•°æ®çš„æ¬ç§»ï¼Œæ¯”è¾ƒæµªè´¹æ—¶é—´ã€‚è€Œvectorçš„è¿­ä»£å™¨æ˜¯æ™®é€šçš„æŒ‡é’ˆã€‚(<a href="https://www.cnblogs.com/LLD-3/p/9664100.html">æŒ‡é’ˆå’Œå¼•ç”¨çš„åŒºåˆ«</a>;<a href="https://blog.csdn.net/qq_39539470/article/details/81273179">C++ä¸­æŒ‡é’ˆå’Œå¼•ç”¨åŒºåˆ«â€”è¯¦è§£ç‰ˆ</a>);</p>

<p><strong>æ•°æ®ç»“æ„</strong></p>

<p>vectoræ‰€é‡‡ç”¨çš„æ•°æ®ç»“æ„éå¸¸ç®€å•ï¼šçº¿æ€§è¿ç»­ç©ºé—´ã€‚å®ƒä»¥ä¸¤ä¸ªè¿­ä»£å™¨startå’Œfinishåˆ†åˆ«æŒ‡å‘é…ç½®å¾—æ¥çš„è¿ç»­ç©ºé—´ä¸­ç›®å‰å·²ç»è¢«ä½¿ç”¨çš„èŒƒå›´ï¼Œå¹¶ä»¥è¿­ä»£å™¨end_of_storageæŒ‡å‘æ•´å—è¿ç»­ç©ºé—´(å«å¤‡ç”¨ç©ºé—´)çš„å°¾ç«¯ï¼Œå¹¶ä¸”ä¸ºäº†æ–¹ä¾¿æ‰©å……ï¼Œvectorå®é™…é…ç½®çš„å¤§å°(capacity)å¯èƒ½æ¯”å®¢æˆ·ç«¯éœ€æ±‚æ›´å¤§ä¸€äº›ï¼Œä»¥å¤‡å°†æ¥å¯èƒ½çš„æ‰©å……ã€‚vectorçš„å®¹é‡æ°¸è¿œå¤§äºæˆ–ç­‰äºå…¶å¤§å°ã€‚ä¸€æ—¦å®¹é‡ç­‰äºå¤§å°ï¼Œä¾¿æ˜¯æ»¡è½½ï¼Œä¸‹æ¬¡å†æœ‰æ–°å¢å…ƒç´ ï¼Œæ•´ä¸ªvectorå°±è¦è¿›è¡Œæ¬ç§»ã€‚å³capacity&gt;sizeæ°¸è¿œæˆç«‹</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="o">=</span><span class="n">alloc</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">vector</span>
<span class="p">{</span>
    <span class="p">...</span>
<span class="nl">protected:</span>
    <span class="c1">//ç›®å‰ä½¿ç”¨çš„ç©ºé—´çš„å¤´éƒ¨</span>

    <span class="n">iterator</span> <span class="n">start</span><span class="p">;</span>
    <span class="c1">//ç›®å‰ä½¿ç”¨çš„ç©ºé—´çš„å°¾éƒ¨</span>

    <span class="n">iterator</span> <span class="n">finish</span><span class="p">;</span>
    <span class="c1">//ç›®å‰å¯ç”¨ç©ºé—´çš„å°¾éƒ¨</span>

    <span class="n">iterator</span> <span class="n">end_of_storage</span><span class="p">;</span>  

<span class="p">}</span>
</code></pre></div></div>
<p><img src="https://wangpengcheng.github.io/img/2019-07-27-20-38-53.png" alt="vectorç¤ºæ„å›¾" /></p>

<p>è¿™é‡Œå†…å­˜åˆ†é…çš„å…³é”®å‡½æ•°ä»£ç å¦‚ä¸‹</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">insert_aux</span><span class="p">(</span><span class="n">iterator</span> <span class="n">position</span><span class="p">,</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>   
    <span class="c1">//æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å¤‡ç”¨ç©ºé—´</span>

    <span class="k">if</span><span class="p">(</span><span class="n">finish</span><span class="o">!=</span><span class="n">end_of_storage</span><span class="p">){</span>
        <span class="c1">//åœ¨å¤‡ç”¨ç©ºé—´èµ·å§‹å¤„æ„é€ ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä»¥vectoræœ€åä¸€ä¸ªå…ƒç´ ä¸ºå…¶åˆå§‹å€¼</span>

        <span class="n">construct</span><span class="p">(</span><span class="n">finish</span><span class="p">,</span><span class="o">*</span><span class="p">(</span><span class="n">finish</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="c1">//ç§»åŠ¨finishæŒ‡é’ˆ</span>
        
        <span class="o">++</span><span class="n">finish</span><span class="p">;</span>
        <span class="c1">//æ‹·è´å†…å®¹</span>

        <span class="n">T</span> <span class="n">x_copy</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
        <span class="c1">//æ‰§è¡Œæ‹·è´</span>

        <span class="n">copy_backward</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">finish</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">finish</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="o">*</span><span class="n">position</span><span class="o">=</span><span class="n">x_copy</span><span class="err">ï¼›</span>
    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
        <span class="c1">//è¿›å…¥è¿™é‡Œè¡¨ç¤ºå·²ç»ä¸å­˜åœ¨å¯ç”¨ç©ºé—´</span>

        <span class="k">const</span> <span class="n">size_type</span> <span class="n">old_size</span><span class="o">=</span><span class="n">size</span><span class="p">();</span>
        <span class="c1">//å†³å®šåˆ†é…ç©ºé—´çš„å¤§å°</span>

        <span class="k">const</span> <span class="n">size_type</span> <span class="n">len</span><span class="o">=</span><span class="n">old_size</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span><span class="mi">2</span><span class="o">*</span><span class="n">old_size</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
        <span class="c1">//å®é™…åˆ†é…</span>

        <span class="n">iterator</span> <span class="n">new_start</span><span class="o">=</span><span class="n">data_allocator</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
        <span class="n">iterator</span> <span class="n">new_finish</span><span class="o">=</span><span class="n">new_start</span><span class="p">;</span>
        <span class="k">try</span><span class="p">{</span>
            <span class="c1">//æ‹·è´å…ƒç´ </span>

            <span class="n">new_finish</span><span class="o">=</span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">position</span><span class="p">,</span><span class="n">new_start</span><span class="p">);</span>
            <span class="c1">//ä¸ºæ–°å…ƒç´ è®¾å®šåˆå€¼x</span>
            
            <span class="n">construct</span><span class="p">(</span><span class="n">new_finish</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
            <span class="c1">//è°ƒæ•´æŒ‡é’ˆä½ç½®</span>

            <span class="o">++</span><span class="n">new_finish</span><span class="p">;</span>
            <span class="c1">//å°†å¤‡ç”¨ç©ºé—´ä¸­çš„å†…å®¹æ‹·è´è¿‡æ¥ï¼Œè¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ï¼Œåé¢çš„å®¹é‡æŒ‡é’ˆå’Œç›¸å…³ä¿¡æ¯</span>

            <span class="n">new_finish</span><span class="o">=</span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">finish</span><span class="p">,</span><span class="n">new_finish</span><span class="p">);</span>
        <span class="p">}</span><span class="k">catch</span><span class="p">(...){</span>
            <span class="n">destroy</span><span class="p">(</span><span class="n">new_start</span><span class="p">,</span><span class="n">new_finish</span><span class="p">);</span>
            <span class="n">data_allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">new_start</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
            <span class="k">throw</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//é‡Šæ”¾åŸæ¥çš„å†…å­˜</span>
        <span class="n">destroy</span><span class="p">(</span><span class="n">begin</span><span class="p">(),</span><span class="n">end</span><span class="p">());</span>
        <span class="n">deallocate</span><span class="p">();</span>

        <span class="c1">//è°ƒæ•´è¿­ä»£å™¨ï¼ŒæŒ‡å‘æ–°vector</span>
        <span class="n">start</span><span class="o">=</span><span class="n">new_start</span><span class="p">;</span>
        <span class="n">finish</span><span class="o">=</span><span class="n">new_finish</span><span class="p">;</span>
        <span class="n">end_of_storage</span><span class="o">=</span><span class="n">new_start</span><span class="o">+</span><span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-16-32.png" alt="å±€éƒ¨æ¸…é™¤æ“ä½œ" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-18-12.png" alt="å±€éƒ¨æ’å…¥æ“ä½œ1" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-19-32.png" alt="å±€éƒ¨æ’å…¥æ“ä½œ2" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-20-36.png" alt="å±€éƒ¨æ’å…¥æ“ä½œ3" /></p>

<p>æ³¨æ„è¿™é‡Œçš„è¿­ä»£å™¨å¤±æ•ˆã€‚</p>

<h3 id="43-list">4.3 list</h3>

<p>ç›¸è¾ƒäºvectorçš„è¿ç»­çº¿æ€§ç©ºé—´ï¼Œlistç›¸å¯¹å¤æ‚å¾ˆå¤šï¼Œä½†æ˜¯ï¼Œå®ƒçš„å¥½å¤„æ˜¯æ¯æ¬¡æ’å…¥æˆ–è€…åˆ é™¤ä¸€ä¸ªå…ƒç´ å°±é…ç½®æˆ–è€…é‡Šæ”¾ä¸€ä¸ªå…ƒç´ ç©ºé—´ï¼Œå› æ­¤listå¯¹ç©ºé—´çš„è¿ç”¨æœ‰ç»å¯¹çš„ç²¾å‡†ï¼Œä¸€ç‚¹ä¹Ÿä¸æµªè´¹ã€‚å¹¶ä¸”ä»»ä½•å…ƒç´ çš„æ’å…¥æˆ–è€…åˆ é™¤ï¼Œlistæ°¸è¿œæ˜¯å¸¸æ•°è¿è¡Œæ—¶é—´ã€‚</p>

<p>listä¸èƒ½åƒvectoré‚£æ ·ä½¿ç”¨æ™®é€šæŒ‡é’ˆä½œä¸ºè¿­ä»£å™¨ï¼Œå› ä¸ºå…¶èŠ‚ç‚¹ä¸ä¿è¯å­å•Šå­˜å‚¨ç©ºé—´ä¸­è¿ç»­å­˜åœ¨ã€‚è¿­ä»£å™¨åœ¨é€’å¢æ—¶æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€’å‡æ—¶æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>

<p>listçš„æ’å…¥å’Œæ¥åˆ(splice)éƒ½ä¸ä¼šé€ æˆåŸæœ‰çš„listè¿­ä»£å¤±æ•ˆï¼Œè¿™åœ¨vectorä¸­æ˜¯ä¸æˆç«‹çš„ã€‚ä½†æ˜¯å®ƒä¼šä½¿å¾—æ“ä½œæŒ‡å‘çš„è¿­ä»£å™¨å¤±æ•ˆã€‚</p>

<p>SGIçš„listä¸ä»…æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ªç¯çŠ¶åŒå‘é“¾è¡¨ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-31-54.png" alt="SGI" /></p>

<p><strong>listçš„æ„é€ å’Œå†…å­˜ç®¡ç†</strong></p>

<p>listä¸ºäº†æ–¹ä¾¿ç©ºé—´é…ç½®å™¨ï¼Œé¢å¤–å®šä¹‰äº†ä¸€ä¸ªlist_node_allocatorï¼Œä¸ºçš„å°±æ˜¯æ›´æ–¹ä¾¿åœ°ä»¥èŠ‚ç‚¹å¤§å°ä¸ºé…ç½®å•ä½ï¼›</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">protected:</span>
    <span class="c1">//é…ç½®ä¸€ä¸ªèŠ‚ç‚¹å¹¶ä¼ å›</span>

    <span class="n">link_type</span> <span class="nf">get_node</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">list_node_allocator</span><span class="o">::</span><span class="n">allocate</span><span class="p">();}</span>
    <span class="c1">//é‡Šæ”¾ä¸€ä¸ªèŠ‚ç‚¹</span>

    <span class="kt">void</span> <span class="nf">put_node</span><span class="p">(</span><span class="n">link_type</span> <span class="n">p</span><span class="p">){</span><span class="n">list_node_allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">p</span><span class="p">);}</span>
    <span class="c1">//äº§ç”Ÿ(é…ç½®å¹¶æ„é€ )ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¸¦æœ‰å…ƒç´ å€¼</span>

    <span class="n">link_type</span> <span class="nf">create_node</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">link_type</span> <span class="n">p</span><span class="o">=</span><span class="n">get_node</span><span class="p">();</span>
        <span class="c1">//å…¨å±€å‡½æ•°ï¼Œæ„é€ /ææ„å‡½æ•°</span>

        <span class="n">construct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//é”€æ¯ä¸€ä¸ªèŠ‚ç‚¹</span>

    <span class="kt">void</span> <span class="nf">destroy_node</span><span class="p">(</span><span class="n">link_type</span> <span class="n">p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ææ„å‡½æ•°</span>

        <span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="n">put_node</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>listæä¾›å¤šä¸ªæ„é€ å‡½æ•°ï¼Œdefault constructorå…è®¸æˆ‘ä»¬ä¸æŒ‡å®šä»»ä½•å‚æ•°åšå‡ºä¸€ä¸ªç©ºçš„listå‡ºæ¥ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-42-02.png" alt="ç©ºé“¾è¡¨ç»“æ„" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-43-26.png" alt="æ’å…¥æ“ä½œ" /></p>

<p>æ³¨æ„è¿™é‡Œçš„æ’å…¥æ˜¯å…ˆäº§ç”Ÿåœ¨æ’å…¥ï¼Œå¹¶ä¸”æ˜¯å¤´æ’æ³•ã€‚è¿™æ ·å¯ä»¥é¿å…å°¾éƒ¨è¿­ä»£å™¨çš„å˜åŠ¨ï¼Œå‡å°‘å·¥ä½œé‡ã€‚</p>

<p>listå†…éƒ¨æä¾›ä¸€ä¸ªtransferæ“ä½œï¼›å°†æŸä¸ªè¿ç»­èŒƒå›´çš„å…ƒç´ è¿ç§»åˆ°æŸä¸ªç‰¹å®šä½ç½®ä¹‹å‰ã€‚æ“ä½œæ¯”è¾ƒå¤æ‚ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//transfer</span>

<span class="c1">// typedef list_node* link_type;</span>
<span class="kt">void</span> <span class="nf">transfer</span><span class="p">(</span><span class="n">iterator</span> <span class="n">position</span><span class="p">,</span><span class="n">iterator</span> <span class="n">first</span><span class="p">,</span><span class="n">iterator</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">position</span><span class="o">!=</span><span class="n">last</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">link_type</span><span class="p">((</span><span class="o">*</span><span class="n">last</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="p">))).</span><span class="n">next</span><span class="o">=</span><span class="n">position</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">link_type</span><span class="p">((</span><span class="o">*</span><span class="n">first</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="p">))).</span><span class="n">next</span><span class="o">=</span><span class="n">last</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">link_type</span><span class="p">((</span><span class="o">*</span><span class="n">position</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="p">))).</span><span class="n">next</span><span class="o">=</span><span class="n">first</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
        <span class="n">link_type</span> <span class="n">tmp</span><span class="o">=</span><span class="n">link_type</span><span class="p">((</span><span class="o">*</span><span class="n">position</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="p">);</span>
        <span class="p">(</span><span class="o">*</span><span class="n">last</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="o">=</span><span class="p">(</span><span class="o">*</span><span class="n">first</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="p">;</span>
        <span class="p">(</span><span class="o">*</span><span class="n">first</span><span class="p">.</span><span class="n">node</span><span class="p">).</span><span class="n">prev</span><span class="o">=</span><span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-53-20.png" alt="è½¬ç§»æ“ä½œå›¾" /></p>

<p>listçš„splice()ç»“åˆå‡½æ•°ï¼Œæœ‰è®¸å¤šç‰ˆæœ¬ï¼Œä¾¿ä¾¿æŒ‡é’ˆçš„é‡æ–°é“¾æ¥ï¼›ä½†æ˜¯å› ä¸ºé“¾è¡¨çš„é“¾æ¥ç‰¹æ€§ï¼Œå› æ­¤é“¾è¡¨æ— æ³•ä½¿ç”¨sort()ç®—æ³•ï¼Œå¿…é¡»ä½¿ç”¨è‡ªå·±çš„sort()</p>

<h3 id="44-deque">4.4 deque</h3>

<p>dequeæ˜¯åŒå‘å¼€å£çš„è¿ç»­æ€§ç©ºé—´ï¼›</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-21-57-16.png" alt="dequeç»“æ„" /></p>

<p>dequeå…è®¸å¸¸æ•°æ—¶é—´å†…å¯¹ç«¯è¿›è¡ŒåŒ€é€Ÿçš„æ’å…¥æˆ–è€…ç§»é™¤æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰æ‰€è°“çš„å®¹é‡(capacity)çš„æ¦‚å¿µï¼Œå› ä¸ºä»–æ˜¯åŠ¨æ€åœ°ä»¥åˆ†æ®µè¿ç»­ç©ºé—´ç»„åˆè€Œæˆçš„ï¼Œéšæ—¶å¯ä»¥å¢åŠ ä¸€æ®µæ–°çš„ç©ºé—´å¹¶é“¾æ¥èµ·æ¥ã€‚å› æ­¤dequeçš„è¿­ä»£å™¨å¹¶ä¸æ˜¯æ™®é€šçš„æŒ‡é’ˆï¼›å› æ­¤é™¤éå¿…è¦ï¼Œæˆ‘ä»¬åº”è¯¥å°½å¯èƒ½é€‰æ‹©ä½¿ç”¨vectorè€Œédequeï¼Œä¸ºäº†æ“ä½œçš„é«˜æ•ˆï¼Œå¯å°†dequeå…ˆå®Œæ•´å¤åˆ¶åˆ°ä¸€ä¸ªvectorèº«ä¸Šï¼Œå°†vectoræ’åºåï¼Œå†å¤åˆ¶å›å»ã€‚</p>

<p>dequeé¿å¼€äº†vectorä¸­çš„åå¤å†…å­˜æ¬ç§»ï¼Œä½†æ˜¯è¿­ä»£å™¨æ¶æ„å´å¼‚å¸¸å¤æ‚ã€‚</p>

<p>dequeé‡‡ç”¨ä¸€å—æ‰€è°“çš„map(ä¸€å°å—è¿ç»­å†…å­˜ç©ºé—´)ä½œä¸ºä¸»ç©ºã€‚å…¶ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘å¦å¤–ä¸€æ®µè¾ƒå¤§çš„è¿ç»­çº¿æ€§ç©ºé—´ï¼Œç§°ä¸ºç¼“å†²åŒºï¼Œç¼“å†²åŒºæ‰æ˜¯deqeueçš„å­˜å‚¨ç©ºé—´ä¸»ä½“ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">protected:</span>
    <span class="c1">//æŒ‡å‘å…ƒç´ çš„æŒ‡é’ˆ</span>

    <span class="k">typedef</span> <span class="n">pointer</span><span class="o">*</span> <span class="n">map_pointer</span><span class="p">;</span>

<span class="k">protected</span><span class="o">:</span>
    <span class="c1">//æŒ‡å‘çš„mapèŠ‚ç‚¹æŒ‡é’ˆ</span>

    <span class="n">map_pointer</span> <span class="n">map</span><span class="p">;</span>
    <span class="c1">//mapæŒ‡é’ˆæ•°é‡</span>

    <span class="n">size_type</span> <span class="n">map_size</span><span class="p">;</span>
</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-27-22-13-47.png" alt="deqeueç»“æ„" /></p>

<p>ä¸‹é¢æ˜¯dequeä¸­çš„è¿­ä»£å™¨å…³é”®ä»£ç </p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="nc">_deque_iterator</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">__deque_iterator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="n">T</span><span class="o">&amp;</span><span class="p">,</span><span class="n">T</span><span class="o">*</span><span class="p">,</span><span class="n">BufSize</span><span class="o">&gt;</span> <span class="n">iterator</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">size_t</span> <span class="n">buffer_size</span><span class="p">(){</span><span class="k">return</span> <span class="n">__deque_buf_size</span><span class="p">(</span><span class="n">BufSize</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));}</span>
    <span class="c1">//ä¿æŒä¸å®¹å™¨çš„è”ç»“</span>
    <span class="c1">//æ­¤è¿­ä»£å™¨æ‰€æŒ‡ç¼“å†²åŒºä¸­çš„å½“å‰è¡Œ(current)å…ƒç´ </span>

    <span class="n">T</span><span class="o">*</span> <span class="n">cur</span><span class="p">;</span>
    <span class="c1">//ç¼“å†²åŒºçš„å¤´éƒ¨å…ƒç´ </span>

    <span class="n">T</span><span class="o">*</span> <span class="n">first</span><span class="p">;</span>
    <span class="c1">//ç¼“å†²åŒºçš„å°¾éƒ¨å…ƒç´ </span>

    <span class="n">T</span><span class="o">*</span> <span class="n">last</span><span class="p">;</span>
    <span class="c1">//ç¼“å†²åŒºç®¡ç†ä¸­å¿ƒ</span>

    <span class="n">map_pointer</span> <span class="n">node</span><span class="p">;</span>

    <span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">__deque_buf_size</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">sz</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">n</span><span class="o">!=</span><span class="mi">0</span><span class="o">?</span><span class="n">n</span><span class="o">:</span><span class="p">(</span><span class="n">sz</span><span class="o">&lt;</span><span class="mi">512</span><span class="o">?</span><span class="kt">size_t</span><span class="p">(</span><span class="mi">512</span><span class="o">/</span><span class="n">sz</span><span class="p">)</span><span class="o">:</span><span class="kt">size_t</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
    <span class="p">}</span>

<span class="p">};</span>

</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-10-20-39.png" alt="ç›¸äº’å…³ç³»" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-10-23-19.png" alt="æ’å…¥ç»“æœ" /></p>

<p>dequeæ•°æ®ç»“æ„</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="o">=</span><span class="n">alloc</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">BufSiz</span><span class="o">=</span><span class="mi">0</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">deque</span>
<span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">T</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">size_t</span> <span class="n">size_type</span><span class="p">;</span>
    <span class="p">...</span>
<span class="nl">protected:</span>
    <span class="c1">//å…ƒç´ çš„æŒ‡é’ˆçš„æŒ‡é’ˆ</span>

    <span class="k">typedef</span> <span class="n">pointer</span><span class="o">*</span> <span class="n">map_pointer</span><span class="p">;</span>
    <span class="c1">//ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>

    <span class="n">iterator</span> <span class="n">start</span><span class="p">;</span>
    <span class="c1">//æœ€åä¸€ä¸ªèŠ‚ç‚¹</span>

    <span class="n">iterator</span> <span class="n">finish</span><span class="p">;</span>
    <span class="c1">//æŒ‡å‘mao,maoæ˜¯è¿ç»­ç©ºé—´</span>

    <span class="n">map_pointer</span> <span class="n">map</span><span class="p">;</span>
    <span class="c1">//mapå†…æŒ‡é’ˆæ•°é‡</span>

    <span class="n">size_type</span> <span class="n">map_size</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-10-46-24.png" alt="å°¾ç«¯å…ƒç´ æ’å…¥" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-10-48-20.png" alt="å‰ç«¯å…ƒç´ æ’å…¥" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-10-49-02.png" alt="æ’å…¥åç»­" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-10-50-18.png" alt="å…ƒç´ å¯»æ‰¾" /></p>

<h3 id="45-stack">4.5 stack</h3>

<p>stackå…è®¸æ–°å¢å…ƒç´ ã€ç§»é™¤å…ƒç´ ã€å–å¾—æœ€é¡¶ç«¯å…ƒç´ ã€‚ä½†æ˜¯ä¸å…è®¸éå†è¡Œä¸ºã€‚
stackæ²¡æœ‰è¿­ä»£å™¨ï¼Œæ‰€æœ‰å…ƒç´ éƒ½æ˜¯é å­˜å–å‡½æ•°è¿›è¡Œæ“ä½œã€‚
stackä»¥listä½œä¸ºåº•å±‚å®¹å™¨ï¼Œé”®listä½œä¸ºåº•å±‚ç»“æ„å¹¶å°é—­å…¶å¤´ç«¯å£ã€‚</p>

<h3 id="46-queue">4.6 queue</h3>

<p>queueæ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºçš„æ•°æ®ç»“æ„ã€‚æœ‰ä¸¤ä¸ªå‡ºå£ï¼Œå…è®¸æ–°å¢å…ƒç´ ã€ç§»é™¤å…ƒç´ ã€ä»æœ€ä½ç«¯åŠ å…¥å…ƒç´ ã€å–å¾—æœ€é¡¶ç«¯å…ƒç´ ã€‚</p>

<p>queueä¸»è¦æ˜¯ç”¨dequeä½œä¸ºåŒå‘å¼€å£çš„æ•°æ®ç»“æ„ï¼Œä½œä¸ºç¼ºçœçš„æƒ…å†µä¸‹ä½œä¸ºqueueåº•éƒ¨ç»“æ„ã€‚</p>

<p>queueæ²¡æœ‰è¿­ä»£å™¨ï¼Œç¬¦åˆâ€œå…ˆè¿›å…ˆå‡ºâ€çš„æ¡ä»¶ï¼Œåªæœ‰queueé¡¶ç«¯çš„å…ƒç´ ï¼Œæ‰æœ‰æœºä¼šè¢«å¤–ç•Œå–ç”¨ã€‚queueä¸æä¾›éå†åŠŸèƒ½ï¼Œä¹Ÿä¸æä¾›è¿­ä»£å™¨ã€‚</p>

<h3 id="47-heapéšå¼è¡¨ç¤ºimplicit-representation">4.7 heap(éšå¼è¡¨ç¤ºï¼Œimplicit representation)</h3>

<p>å¯ä»¥ä½¿ç”¨arryçš„iè¡¨ç¤ºæŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå·¦å­èŠ‚ç‚¹å°±å¿…é¡»ä½äºarrayçš„2iå¤„ï¼Œå³å­èŠ‚ç‚¹å¿…é¡»ä½äºarrayçš„2i+1å¤„ã€‚
æ ¹æ®å…ƒç´ æ’åˆ—æ–¹å¼ï¼Œheapå¯ä»¥åˆ†ä¸ºï¼š</p>
<ul>
  <li>max-heap: æ¯ä¸ªèŠ‚ç‚¹é”®å€¼éƒ½å¤§äºæˆ–è€…ç­‰äºå…¶å­èŠ‚ç‚¹çš„é”®å€¼</li>
  <li>min-heap: æ¯ä¸ªèŠ‚ç‚¹é”®å€¼éƒ½å°äºæˆ–è€…ç­‰äºå…¶å­èŠ‚ç‚¹çš„é”®å€¼</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-13-16-29.png" alt="" /></p>

<p>ä¸‹é¢æ˜¯è¿›è¡Œæ’å…¥æ’åºçš„å…³é”®ä»£ç </p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">push_heap</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
                        <span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è°ƒç”¨æ­¤å‡½æ•°æ—¶ï¼Œæ–°å…ƒç´ åº”è¯¥å·²ç»ç½®äºåº•éƒ¨å®¹å™¨çš„æœ€å°¾ç«¯</span>

    <span class="n">__push_heap_aux</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">distance_type</span><span class="p">(</span><span class="n">first</span><span class="p">),</span><span class="n">value_type</span><span class="p">(</span><span class="n">first</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">,</span><span class="k">class</span> <span class="nc">Distance</span><span class="p">,</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__push_heap_aux</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span><span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">,</span><span class="n">Distance</span><span class="o">*</span><span class="p">,</span><span class="n">T</span><span class="o">*</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//å°†æ–°å€¼ç½®äºåº•éƒ¨å®¹å™¨çš„æœ€åº•ç«¯</span>

    <span class="n">__push_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">Distance</span><span class="p">((</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">Distance</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">T</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="mi">1</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">,</span><span class="k">class</span> <span class="nc">Distance</span><span class="p">,</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">__push_heap</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span><span class="n">Distance</span> <span class="n">holeIndex</span><span class="p">,</span><span class="n">Distance</span> <span class="n">topIndex</span><span class="p">,</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//æ‰¾åˆ°çˆ¶èŠ‚ç‚¹</span>

    <span class="n">Distance</span> <span class="n">parent</span><span class="o">=</span><span class="p">(</span><span class="n">holeIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
    <span class="c1">//è¿™é‡Œä½¿ç”¨whileå¾ªç¯ï¼Œå¾ªç¯è°ƒèŠ‚æ’å…¥çš„èŠ‚ç‚¹ä½ç½®</span>

    <span class="k">while</span><span class="p">(</span><span class="n">holeIndex</span><span class="o">&gt;</span><span class="n">topIndex</span><span class="o">&amp;&amp;</span>
        <span class="o">*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">parent</span><span class="p">)</span><span class="o">&lt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//å½“å°šæœªè¾¾åˆ°é¡¶ç«¯ï¼Œä¸”çˆ¶èŠ‚ç‚¹å°é±¼æ–°å€¼(äºæ˜¯ä¸ç¬¦åˆheapçš„æ¬¡åºç‰¹æ€§)</span>

        <span class="c1">//ä»¤å½“å‰å€¼ä¸ºçˆ¶å€¼</span>

        <span class="o">*</span><span class="err">ï¼ˆ</span><span class="n">first</span><span class="o">+</span><span class="n">holeIndex</span><span class="err">ï¼‰</span><span class="o">=*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">parent</span><span class="p">);</span>
        <span class="n">holeIndex</span><span class="o">=</span><span class="n">parent</span><span class="p">;</span>
        <span class="c1">//æ›´æ–°parent index</span>

        <span class="n">parent</span><span class="o">=</span><span class="p">(</span><span class="n">holeIndex</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//ä»¤æ´å€¼ä¸ºæ–°å€¼ï¼Œå®Œæˆæ’å…¥æ“ä½œ</span>

    <span class="o">*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">holeIndex</span><span class="p">)</span><span class="o">=</span><span class="n">value</span><span class="p">;</span>

<span class="p">}</span>
</code></pre></div></div>
<p>å¯¹äºheap_popï¼šå°†æ ¹èŠ‚ç‚¹å–èµ°åï¼Œå¡«å…¥ä¸Šè¿°å¤±å»å£°æ˜ç©ºé—´çš„å¶èŠ‚ç‚¹å€¼ï¼Œå†å°†å®ƒæ‹¿æ¥å’Œå…¶å®ƒä¸¤ä¸ªå­èŠ‚ç‚¹æ¯”è¾ƒå€¼ï¼Œå¹¶ä¸è¾ƒå¤§å­èŠ‚ç‚¹å¯¹è°ƒä½ç½®ï¼Œç›´åˆ°æ ¹èŠ‚ç‚¹çš„é”®å€¼å¤§äºå·¦å³ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œæˆ–è€…ç›´åˆ°æ”¾è‡³å¶èŠ‚ç‚¹ä¸ºæ­¢ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28-20-19-46.png" alt="pop heap" /></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">pop_heap</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
                        <span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è°ƒç”¨æ­¤å‡½æ•°æ—¶ï¼Œæ–°å…ƒç´ åº”è¯¥å·²ç»ç½®äºåº•éƒ¨å®¹å™¨çš„æœ€å°¾ç«¯</span>

    <span class="n">__pop_heap_aux</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">value_type</span><span class="p">(</span><span class="n">first</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">,</span><span class="k">class</span> <span class="nc">Distance</span><span class="p">,</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__pop_heap_aux</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span><span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">,</span><span class="n">Distance</span><span class="o">*</span><span class="p">,</span><span class="n">T</span><span class="o">*</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//popæ“ä½œåº”è¯¥ä¸ºå®¹å™¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå› æ­¤ï¼Œé¦–å…ˆè®¾å®šæ¬²è°ƒæ•´å€¼ä¸ºå°¾å€¼ï¼Œç„¶åå°†é¦–å€¼è°ƒè‡³å°¾èŠ‚ç‚¹(æ‰€ä»¥ä»¥ä¸Šå°†è¿­ä»£å™¨resultè®¾ä¸ºlast-1)ã€‚ç„¶åé‡æ•´[first,last-1)ï¼Œä½¿ä¹‹é‡æ–°å½¢æˆä¸€ä¸ªåˆæ ¼çš„heap</span>

    <span class="n">__pop_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">T</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span><span class="n">distance_type</span><span class="p">(</span><span class="n">first</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">,</span><span class="k">class</span> <span class="nc">Distance</span><span class="p">,</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">__pop_heap</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
        <span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">,</span>
        <span class="n">RandomAccessIterator</span> <span class="n">result</span><span class="p">,</span>
        <span class="n">T</span> <span class="n">value</span><span class="p">,</span>
        <span class="n">Distance</span><span class="o">*</span>
        <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//è®¾å®šå°¾å€¼ä¸ºé¦–å€¼ï¼Œäºæ˜¯å°¾å€¼å³ä¸ºæ¬²æ±‚ç»“æœï¼Œå¯ç”±å®¢æˆ·ç«¯ç¨åå†ä»¥åº•å±‚å®¹å™¨ä¹‹pop_back()å–å‡ºå°¾å€¼</span>

    <span class="o">*</span><span class="n">result</span><span class="o">=*</span><span class="n">first</span><span class="p">;</span>
    <span class="c1">//é‡æ–°è°ƒæ•´heap,æ´å·ä¸º0(äº¦å³æ ‘æ ¹å¤„)ï¼Œæ¬²è°ƒæ•´å€¼ä¸ºvalue(åŸå°¾å€¼)ï¼›</span>

    <span class="n">__adjust_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">Distance</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">Distance</span><span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="p">),</span><span class="n">value</span><span class="p">);</span>

<span class="p">}</span>
<span class="c1">//ä¸€ä¸‹è¿™ä¸ª__adjust_head()ä¸å…è®¸æŒ‡å®šâ€œå¤§å°æ¯”è¾ƒæ ‡å‡†â€</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">,</span><span class="k">class</span> <span class="nc">Distance</span><span class="p">,</span><span class="k">class</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">__adjust_heap</span><span class="p">(</span>
    <span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
    <span class="n">Distance</span> <span class="n">holeIndex</span><span class="p">,</span>
    <span class="n">Distance</span> <span class="n">len</span><span class="p">,</span>
    <span class="n">T</span> <span class="n">value</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">Distance</span> <span class="n">topIndex</span><span class="o">=</span><span class="n">holeIndex</span><span class="p">;</span>
    <span class="c1">//æ´èŠ‚ç‚¹çš„å³èŠ‚ç‚¹</span>

    <span class="n">Distance</span> <span class="n">secondchild</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">holeIndex</span><span class="o">+</span><span class="mi">2</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">secondchild</span><span class="o">&lt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//ä½¿secondchildä»£è¡¨è¾ƒå¤§èŠ‚ç‚¹</span>

        <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">secondchild</span><span class="p">)</span><span class="o">&lt;*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="p">(</span><span class="n">secondchild</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="n">secondchild</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//ä»¤è¾ƒå¤§å­å€¼ä¸ºæ´å€¼ï¼Œå†ä»¤æ´å·ä¸‹ç§»è‡³è¾ƒå¤§å­èŠ‚ç‚¹å¤„</span>

        <span class="o">*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">holeIndex</span><span class="p">)</span><span class="o">=*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">secondchild</span><span class="p">);</span>
        <span class="n">holeIndex</span><span class="o">=</span><span class="n">secondchild</span><span class="p">;</span>
        <span class="c1">//æ‰¾å‡ºæ–°æ´èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹</span>

        <span class="n">secondchild</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">secondchild</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//æ²¡æœ‰å³å­èŠ‚ç‚¹ï¼Œåªæœ‰å·¦å­èŠ‚ç‚¹</span>

    <span class="k">if</span><span class="p">(</span><span class="n">secondchild</span><span class="o">==</span><span class="n">len</span><span class="p">){</span>
        <span class="c1">//Percolate down:ä»¤å·¦å­å€¼ä¸ºæ´å€¼ï¼Œå†ä»¤æ´å·ä¸‹ç§»è‡³å·¦å­èŠ‚ç‚¹å¤„ã€‚</span>

        <span class="o">*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">holeIndex</span><span class="p">)</span><span class="o">=*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="p">(</span><span class="n">secondchild</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
        <span class="n">holeIndex</span><span class="o">=</span><span class="n">secondchild</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//å°†æ¬²è°ƒæ•´å€¼å¡«å…¥ç›®å‰çš„æ´å·å†…ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶è‚¯å®šæ»¡è¶³æ¬¡åºç‰¹æ€§</span>

    <span class="n">__push_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">holeIndex</span><span class="p">,</span><span class="n">topIndex</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>sort_heapç®—æ³•</strong></p>

<p>å¯ä»¥é€šè¿‡æ¯æ¬¡å–å¾—heapçš„æœ€å¤§å€¼æ¥è¿›è¡Œpop_heapæ“ä½œï¼Œå¯¹ï¼Œæ¯æ¬¡æ“ä½œå°†æ“ä½œèŒƒå›´ä»åå‘å‰ç¼©å‡ä¸€ä¸ªå…ƒç´ (å› ä¸ºpop_heapä¼šæŠŠé”®å€¼æœ€å¤§çš„å…ƒç´ æ”¾åœ¨åº•éƒ¨å®¹å™¨çš„æœ€å°¾ç«¯)ï¼Œå½“æ•´ä¸ªç¨‹åºæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæˆ‘ä»¬ä¾¿æœ‰äº†ä¸€ä¸ªé€’å¢åºåˆ—</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">sort_heap</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
                <span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//ä»¥ä¸‹ï¼Œæ¯æ‰§è¡Œä¸€æ¬¡pop_heap(),æå€¼(åœ¨STL heapä¸­ä¸ºæå¤§å€¼)å³è¢«æ”¾åœ¨å°¾ç«¯ã€‚è¿™æ ·ä¸€ç›´ä¸‹å»ï¼Œæœ€åå¾—åˆ°æ’åºç»“æœ</span>

    <span class="k">while</span><span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//æ¯æ‰§è¡Œpop_heap()ä¸€æ¬¡ï¼Œæ“ä½œèŒƒå›´å³é€€ç¼©ä¸€æ ¼</span>

        <span class="n">pop_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="o">--</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-28 -21-36-15.png" alt="è°ƒæ•´è¿‡ç¨‹" /></p>

<p><strong>make_heapç®—æ³•</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span><span class="p">&gt;</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">make_heap</span><span class="p">(</span>
    <span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
    <span class="n">RandomAccessIterator</span> <span class="n">last</span>
    <span class="p">)</span>
<span class="p">{</span>
    <span class="n">__make_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">last</span><span class="p">,</span><span class="n">value_type</span><span class="p">(</span><span class="n">first</span><span class="p">),</span><span class="n">distance_type</span><span class="p">(</span><span class="n">first</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">RandomAccessIterator</span> <span class="p">,</span><span class="k">class</span> <span class="nc">T</span><span class="p">,</span><span class="k">class</span> <span class="nc">Distance</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">__make_heap</span><span class="p">(</span><span class="n">RandomAccessIterator</span> <span class="n">first</span><span class="p">,</span>
                <span class="n">RandomAccessIterator</span> <span class="n">last</span><span class="p">,</span>
                <span class="n">T</span><span class="o">*</span><span class="p">,</span>
                <span class="n">Distance</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//é•¿åº¦ä¸å¤Ÿç›´æ¥è·³å‡º</span>

    <span class="k">if</span><span class="p">(</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="c1">//è·å–æ•°æ®çš„é•¿åº¦</span>

    <span class="n">Distance</span> <span class="n">len</span><span class="o">=</span><span class="n">last</span><span class="o">-</span><span class="n">first</span><span class="p">;</span>
    <span class="c1">//æ‰¾å‡ºç¬¬ä¸€ä¸ªéœ€è¦é‡æ’çš„å­æ ‘å¤´éƒ¨ï¼Œä»¥parentæ ‡å‡ºã€‚ç”±äºä»»ä½•å¶èŠ‚ç‚¹éƒ½ä¸éœ€è¦æ‰§è¡Œ perlocate down,æ‰€ä»¥æœ‰ä¸€ä¸‹è®¡ç®—ã€‚parentå‘½åä½³ï¼Œä»¥holeIndexæ›´å¥½</span>

    <span class="n">Distance</span> <span class="n">parent</span><span class="o">=</span><span class="p">(</span><span class="n">len</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//é‡æ–°æ’åˆ—ä»¥parentä¸ºé¦–çš„å­æ ‘ã€‚lenæ˜¯ä¸ºäº†è®©__adjust_heap()åˆ¤æ–­æ“ä½œèŒƒå›´</span>

        <span class="n">__adjust_heap</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">parent</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">T</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">first</span><span class="o">+</span><span class="n">parent</span><span class="p">)));</span>
        
        <span class="k">if</span><span class="p">(</span><span class="n">parent</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
        <span class="c1">//ç§»åŠ¨å¤´éƒ¨èŠ‚ç‚¹</span>

        <span class="n">parent</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>æ³¨æ„heapæ²¡æœ‰è¿­ä»£å™¨</p>

<h3 id="48-priority_queue">4.8 priority_queue</h3>

<p>priority_queueæ˜¯ä¸€ä¸ªå…·æœ‰æƒå€¼è§‚å¿µçš„queueï¼Œå®ƒå…è®¸åŠ å…¥æ–°å…ƒç´ ã€ç§»é™¤æ—§å…ƒç´ ã€å®¡è§†å…ƒç´ å€¼ç­‰åŠŸèƒ½ã€‚å…¶å†…éƒ¨çš„å‡½æ•°æ˜¯æŒ‰ç…§æƒå€¼è¿›è¡Œæ’åºçš„ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-13-37-30.png" alt="priority_queue" /></p>

<h3 id="49-slist">4.9 slist</h3>

<p>STL listæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨(double linked list)ã€‚SGI STL å¦å¤–æä¾›äº†ä¸€ä¸ªå•é¡¹é“¾è¡¨(slist)ã€‚è¿™ä¸ªå®¹å™¨å¹¶ä¸å†æ ‡å‡†è§„æ ¼ä¹‹å†…ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-15-07-53.png" alt="èŠ‚ç‚¹å’Œæ¶æ„è®¾è®¡" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-15-09-01.png" alt="èŠ‚ç‚¹å®é™…æ„é€ " /></p>

<h2 id="ç¬¬äº”ç« -å…³è”å¼associativeå®¹å™¨">ç¬¬äº”ç«  å…³è”å¼(associative)å®¹å™¨</h2>

<p>å½“å…ƒç´ è¢«æ’å…¥åˆ°å…³è”å¼å®¹å™¨ä¸­æ—¶ï¼Œå®¹å™¨å†…éƒ¨ç»“æ„(å¯èƒ½æ˜¯RB-treeæˆ–è€…hash-table)ä¾¿ä¾ç…§å…¶é”®å€¼å¤§å°ï¼Œä»¥æŸç§ç‰¹å®šè§„åˆ™å°†è¿™ä¸ªå…ƒç´ æ”¾ç½®äºåˆé€‚çš„ä½ç½®ï¼Œå…³è”å¼å®¹å™¨æ²¡æœ‰æ‰€è°“å¤´å°¾(åªæœ‰æœ€å¤§å…ƒç´ å’Œæœ€å°å…ƒç´ )ï¼›æ‰€ä»¥ä¸ä¼šæœ‰æ‰€è°“<code class="language-plaintext highlighter-rouge">push_back()</code>ã€<code class="language-plaintext highlighter-rouge">push_front()</code>ç­‰è¡Œä¸ºçš„æ“ä½œã€‚
ä¸€èˆ¬è€Œè¨€å…³è”å¼å®¹å™¨çš„å†…éƒ¨ç»“æ„æ˜¯ä¸€ä¸ªäºŒå‰å¹³è¡¡æ ‘ï¼Œä»¥ä¾¿è·å¾—è‰¯å¥½çš„æœå¯»æ•ˆç‡ã€‚äºŒå‰å¹³è¡¡æ ‘æœ‰è®¸å¤šå˜å½¢åŒ…æ‹¬ï¼šAVL-treeã€RB-treeã€AA-treeï¼›å…¶ä¸­RB-treeè¢«å¹¿æ³›åº”ç”¨äºå…³è”å¼å®¹å™¨ã€‚</p>

<h3 id="51-æ ‘çš„å¯¼è§ˆ">5.1 æ ‘çš„å¯¼è§ˆ</h3>

<p>è¿™é‡Œå¯ä»¥å»çœ‹æ•°æ®ç»“æ„ä¸ç®—æ³•ä¸­å…³äºæ ‘çš„æè¿°ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šå™è¿°ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-15-23-54.png" alt="æ ‘ç»“æ„çš„ç›¸å…³æœ¯è¯­æ•´ç†" /></p>

<h3 id="52-rb-treeçº¢é»‘æ ‘">5.2 RB-tree(çº¢é»‘æ ‘)</h3>
<p><em>å‚è€ƒé“¾æ¥ï¼š</em> <a href="https://www.cnblogs.com/skywang12345/p/3624291.html">çº¢é»‘æ ‘(å››)ä¹‹ C++çš„å®ç°</a></p>

<p>AVL-treeåŸºæœ¬è§„åˆ™ï¼š</p>

<ul>
  <li>æ¯ä¸ªèŠ‚ç‚¹ä¸æ˜¯çº¢è‰²å°±æ˜¯é»‘è‰²(å›¾ä¸­æ·±è‰²åº•çº¹ä»£è¡¨é»‘è‰²ï¼Œæµ…è‰²åº•çº¹ä»£è¡¨çº¢è‰²ï¼ŒåŒä¸‹)ã€‚</li>
  <li>æ ¹èŠ‚ç‚¹ä¸ºé»‘è‰²</li>
  <li>å¦‚æœèŠ‚ç‚¹ä¸ºçº¢ï¼Œå…¶å­èŠ‚ç‚¹å¿…é¡»ä¸ºé»‘è‰²</li>
  <li>ä»»ä¸€èŠ‚ç‚¹è‡³NULL(æ ‘å°¾ç«¯)çš„ä»»ä½•è·¯å¾„ï¼Œæ‰€å«ä¹‹é»‘èŠ‚ç‚¹æ•°æœ¨å¿…é¡»ç›¸åŒ</li>
</ul>

<p>å…³äºå®ƒçš„ç‰¹æ€§ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
  <li>ç‰¹æ€§(3)ä¸­çš„å¶å­èŠ‚ç‚¹ï¼Œæ˜¯åªä¸ºç©º(NILæˆ–null)çš„èŠ‚ç‚¹ã€‚</li>
  <li>ç‰¹æ€§(5)ï¼Œç¡®ä¿æ²¡æœ‰ä¸€æ¡è·¯å¾„ä¼šæ¯”å…¶ä»–è·¯å¾„é•¿å‡ºä¿©å€ã€‚å› è€Œï¼Œçº¢é»‘æ ‘æ˜¯ç›¸å¯¹æ˜¯æ¥è¿‘å¹³è¡¡çš„äºŒå‰æ ‘ã€‚</li>
</ul>

<p><img src="https://images0.cnblogs.com/i/497634/201403/251730074203156.jpg" alt="çº¢é»‘æ ‘ç¤ºä¾‹" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-15-32-27.png" alt="RB-treeçš„æ¡ä»¶ä¸å®ä¾‹" /></p>

<h4 id="521-æ’å…¥èŠ‚ç‚¹">5.2.1 æ’å…¥èŠ‚ç‚¹</h4>

<p>å› ä¸ºçº¢é»‘æ ‘çš„è§„åˆ™å¯¹äºä¸åŒçš„æ’å…¥å­˜åœ¨ä»¥ä¸‹å››ç§æƒ…å†µï¼š</p>

<ul>
  <li>çŠ¶å†µ1ï¼šsä¸ºé»‘è‰²xä¸ºå¤–ä¾§æ’å…¥ï¼Œå¯¹æ­¤æƒ…å†µï¼Œå…ˆå¯¹P,Gåšä¸€æ¬¡å•æ—‹è½¬ï¼Œå†æ›´æ”¹P,Gé¢œè‰²ï¼Œå³å¯é‡æ–°æ»¡è¶³çº¢é»‘æ ‘çš„è§„åˆ™3ã€‚</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-16-25-21.png" alt="çŠ¶å†µ1" /></p>

<ul>
  <li>çŠ¶å†µ2:Sä¸ºé»‘ä¸”xä¸ºå†…ä¾§æ’å…¥ï¼Œå¯¹æ­¤æƒ…å†µï¼Œæˆ‘ä»¬å¿…é¡»å…ˆå¯¹P,Xåšä¸€æ¬¡å•æ—‹è½¬å¹¶æ›´æ”¹G,Xé¢œè‰²ï¼Œå†å°†ç»“æœå¯¹Gåšä¸€æ¬¡å•æ—‹è½¬ï¼Œçº§å¯å†æ¬¡æ»¡è¶³çº¢é»‘æ ‘è§„åˆ™3.</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-16-29-18.png" alt="çŠ¶å†µ2" /></p>

<ul>
  <li>çŠ¶å†µ3:Sä¸ºçº¢è‰²ä¸”Xä¸ºå¤–ä¾§æ’å…¥ï¼Œå¯¹æ­¤æƒ…å†µï¼Œå…ˆå¯¹På’ŒGåšä¸€æ¬¡å•æ—‹è½¬ï¼Œå¹¶æ”¹å˜Xçš„é¢œè‰²ã€‚æ­¤æ—¶å¦‚æœGGä¸ºé»‘ï¼Œä¸€åˆ‡æå®šï¼Œå¦‚æœGGä¸ºçº¢ï¼Œåˆ™æ˜¯çŠ¶å†µ4</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-16-32-15.png" alt="çŠ¶å†µ3" /></p>

<ul>
  <li>çŠ¶å†µ4:Sä¸ºçº¢ä¸”Xä¸ºå¤–ä¾§æ’å…¥ã€‚å¯¹æ­¤æƒ…å†µï¼Œå…ˆå¯¹På’ŒGåšä¸€æ¬¡å•æ—‹è½¬ï¼Œå¹¶æ”¹å˜Xçš„é¢œè‰²ã€‚æ­¤æ—¶å¦‚æœGGäº¦ä¸ºçº¢ï¼Œè¿˜å¾—æŒç»­å¾€ä¸Šåšï¼Œç›´åˆ°ä¸å†æœ‰çˆ¶å­è¿ç»­ä¸ºçº¢çš„æƒ…å†µå‘ç”Ÿã€‚</li>
</ul>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-16-34-38.png" alt="çŠ¶å†µ4" /></p>

<h4 id="522-ä¸€ä¸ªç”±ä¸Šè€Œä¸‹çš„ç¨‹åº">5.2.2 ä¸€ä¸ªç”±ä¸Šè€Œä¸‹çš„ç¨‹åº</h4>

<p>ä¸€ä¸ªç”±ä¸Šè€Œä¸‹çš„ç¨‹åºï¼Œå‡è®¾æ–°å¢èŠ‚ç‚¹ä¸ºA,é‚£ä¹ˆå°±æ²¿ç€Açš„è·¯å¾„ï¼Œåªè¦çœ‹åˆ°æŸä¸ªèŠ‚ç‚¹Xçš„ä¸¤ä¸ªå­èŠ‚ç‚¹çš†ä¸ºçº¢è‰²ï¼Œå°±æŠŠXè¯¥ä¸ºçº¢è‰²ï¼Œå¹¶æŠŠä¸¤ä¸ªå­èŠ‚ç‚¹æ”¹ä¸ºé»‘è‰²ã€‚ç„¶ååœ¨è¿›è¡Œæ—‹è½¬å˜æ¢ã€‚</p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-16-47-07.png" alt="è‡ªä¸Šè€Œä¸‹çš„å˜æ¢" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-29-16-48-18.png" alt="æ’å…¥ç»“æœ" /></p>

<h4 id="523-rb-treeçš„èŠ‚ç‚¹è®¾è®¡">5.2.3 RB-treeçš„èŠ‚ç‚¹è®¾è®¡</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">bool</span> <span class="n">__rb_tree_color_type</span><span class="p">;</span>
<span class="c1">//çº¢è‰²ä¸º0</span>

<span class="k">const</span> <span class="n">__rb_tree_color_type</span> <span class="n">__rb_tree_red</span><span class="o">=</span><span class="nb">false</span><span class="p">;</span>
<span class="k">const</span> <span class="n">__rb_tree_color_type</span> <span class="n">__rb_tree_black</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">__rb_tree_node_base</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_color_type</span> <span class="n">color_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">base_ptr</span><span class="p">;</span>
    <span class="c1">//èŠ‚ç‚¹é¢œè‰²ï¼Œéçº¢å³é»‘</span>

    <span class="n">color_type</span> <span class="n">color</span><span class="p">;</span>
    <span class="c1">//èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆ</span>

    <span class="n">base_ptr</span> <span class="n">parent</span><span class="p">;</span>
    <span class="c1">//å·¦èŠ‚ç‚¹æŒ‡é’ˆ</span>

    <span class="n">base_ptr</span> <span class="n">left</span><span class="p">;</span>
    <span class="c1">//å³èŠ‚ç‚¹æŒ‡é’ˆ</span>

    <span class="n">base_ptr</span> <span class="n">right</span><span class="p">;</span>
    <span class="k">static</span> <span class="n">base_ptr</span> <span class="n">minimum</span><span class="p">(</span><span class="n">base_ptr</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">static</span> <span class="n">base_ptr</span> <span class="n">maximum</span><span class="p">(</span><span class="n">base_ptr</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Value</span><span class="p">&gt;</span>
<span class="k">struct</span>  <span class="nc">_rb_tree_node</span><span class="o">:</span><span class="k">public</span> <span class="n">__rb_tree_node_base</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_node</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;*</span> <span class="n">link_type</span><span class="p">;</span>
    <span class="c1">//èŠ‚ç‚¹å€¼</span>

    <span class="n">Value</span> <span class="n">value_field</span><span class="p">;</span>
    
<span class="p">};</span>
</code></pre></div></div>

<h4 id="524-rb-treeçš„è¿­ä»£å™¨">5.2.4 RB-treeçš„è¿­ä»£å™¨</h4>

<p><img src="https://wangpengcheng.github.io/img/2019-07-30-15-46-23.png" alt="è¿­ä»£å™¨å’ŒèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»" /></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">struct</span> <span class="nc">__rb_tree_base_iterator</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_node_base</span><span class="o">::</span><span class="n">base_ptr</span> <span class="n">base_ptr</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">bidirectional_iterator_tag</span> <span class="n">iterator_category</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">ptrdiff_t</span> <span class="n">difference_type</span><span class="p">;</span>
    <span class="c1">//ç”¨æ¥ä¸å®¹å™¨ä¹‹é—´äº§ç”Ÿä¸€ä¸ªè¿æ¥å…³ç³»</span>

    <span class="n">base_ptr</span> <span class="n">node</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">increment</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//çŠ¶å†µ1</span>

        <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//å­˜åœ¨å³èŠ‚ç‚¹ï¼Œå°±å¾€å³èŠ‚ç‚¹èµ°</span>
            
            <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
            <span class="c1">//ç„¶åä¸€ç›´å¾€å·¦å­æ ‘ï¼Œèµ°åˆ°åº•</span>

            <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//çŠ¶å†µ2</span>

        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//æ²¡æœ‰å³å­èŠ‚ç‚¹ï¼Œå…ˆæ‰¾å‡ºçˆ¶èŠ‚ç‚¹</span>

            <span class="n">base_ptr</span> <span class="n">y</span><span class="o">=</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
            <span class="c1">//å¦‚æœç°è¡ŒèŠ‚ç‚¹æœ¬èº«å°±æ˜¯ä¸ªå³å­èŠ‚ç‚¹,å°±ä¸€ç›´ä¸Šæœ”ï¼Œç›´åˆ°"ä¸ä¸ºå³å­èŠ‚ç‚¹"ä¸ºæ­¢</span>

            <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">==</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">node</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="c1">//å¦‚æœæ­¤æ—¶å³å­èŠ‚ç‚¹ä¸ç­‰äºæ¬¡åƒçš„çˆ¶èŠ‚ç‚¹çŠ¶å†µ3ï¼Œæ­¤æ—¶çš„çˆ¶èŠ‚ç‚¹å³ä¸ºè§£ç­”ï¼Œå¦åˆ™æ­¤æ—¶çš„nodeä¸ºè§£ç­”çŠ¶å†µ4</span>

            <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">!=</span><span class="n">y</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">node</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//æ³¨æ„ï¼šä»¥ä¸Šåˆ¤æ–­"è‹¥æ­¤æ—¶çš„å³å­èŠ‚ç‚¹ä¸ç­‰äºæ¬¡åƒçš„çˆ¶èŠ‚ç‚¹"ï¼Œæ˜¯ä¸ºäº†åº”ä»˜ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼š</span>
    <span class="c1">//æˆ‘ä»¬æ¬²å¯»æ‰¾æ ¹èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè€Œæ°å·§æ ¹èŠ‚ç‚¹æ— å·¦å³å­èŠ‚ç‚¹</span>
    <span class="c1">//ä»¥ä¸Šçš„ç‰¹æ®Šåšæ³•å¿…é¡»é…åˆRB-treeæ ¹èŠ‚ç‚¹ä¸ç‰¹æ®Šä¹‹headerä¹‹é—´çš„ç‰¹æ®Šå…³ç³»</span>

    <span class="c1">//ä»¥ä¸‹å¯ä»¥å®ç°äºoperator--å†…ï¼Œå› ä¸ºå†æ— ä»–å¤„ä¼šè°ƒç”¨æ­¤å‡½æ•°äº†</span>

    <span class="kt">void</span> <span class="n">decrement</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//å¦‚æœæ˜¯çº¢èŠ‚ç‚¹ï¼Œä¸”çˆ¶èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ç­‰äºè‡ªå·±,å³nodeä¸ºheadæˆ–è€…endèŠ‚ç‚¹çš„æ—¶å€™</span>

        <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">==</span><span class="n">__rb_tree_red</span><span class="o">&amp;&amp;</span>
            <span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">==</span><span class="n">node</span><span class="p">){</span>
            <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">base_ptr</span> <span class="n">y</span><span class="o">=</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
            <span class="c1">//ä¸€ç›´å‘å³å¾ªç¯æŸ¥æ‰¾ä¸‹å»ï¼Œç›´åˆ°æ²¡æœ‰å³å­èŠ‚ç‚¹</span>

            <span class="k">while</span><span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">node</span><span class="o">=</span><span class="n">y</span><span class="p">;</span> 
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//å³éæ ¹èŠ‚ç‚¹ï¼Œäº¦æ— å·¦å­èŠ‚ç‚¹</span>
            <span class="c1">//å…ˆæ‰¾åˆ°ç¬¦èŠ‚ç‚¹</span>

            <span class="n">base_ptr</span> <span class="n">y</span><span class="o">=</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
            <span class="c1">//æ‰¾å¯»çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ç›´åˆ°nodeä¸æ˜¯å·¦å­èŠ‚ç‚¹</span>

            <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">==</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//è¿™é‡Œä¸»è¦æ˜¯ä¸€ç›´ä¸Šæœ”</span>

                <span class="n">node</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
                <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">};</span>
<span class="c1">//RB-treeçš„æ­£è§„è¿­ä»£å™¨</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Value</span><span class="p">,</span><span class="k">class</span> <span class="nc">Ref</span><span class="p">,</span><span class="k">class</span> <span class="nc">Ptr</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">__rb_tree_iteraror</span><span class="o">:</span><span class="k">public</span> <span class="n">__rb_tree_base_iterator</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">Value</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">Ref</span> <span class="n">reference</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">Ptr</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_iterator</span><span class="o">&lt;</span><span class="n">Value</span><span class="p">,</span><span class="n">Value</span><span class="o">&amp;</span><span class="p">,</span><span class="n">Value</span><span class="o">*&gt;</span> <span class="n">iterator</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_iterator</span><span class="o">&lt;</span><span class="n">Value</span><span class="p">,</span><span class="k">const</span> <span class="n">Value</span><span class="o">&amp;</span><span class="p">,</span><span class="k">const</span> <span class="n">Value</span><span class="o">*&gt;</span> <span class="n">const_iterator</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_iterator</span><span class="o">&lt;</span><span class="n">Value</span><span class="p">,</span><span class="n">Ref</span><span class="p">,</span><span class="n">Ptr</span><span class="o">&gt;</span> <span class="n">self</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_node</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;*</span> <span class="n">link_type</span><span class="p">;</span>

    <span class="n">__rb_tree_iterator</span><span class="p">()</span> <span class="p">{}</span>
    <span class="n">__rb_tree_iterator</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="n">node</span><span class="o">=</span><span class="n">x</span><span class="p">;}</span>
    <span class="n">__rb_tree_iterator</span><span class="p">(</span><span class="k">const</span> <span class="n">iterator</span><span class="o">&amp;</span> <span class="n">it</span><span class="p">){</span><span class="n">node</span><span class="o">=</span><span class="n">it</span><span class="p">.</span><span class="n">node</span><span class="p">;}</span>

    <span class="n">reference</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">link_type</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">value_field</span><span class="p">;}</span>
<span class="cp">#ifndef __SGI_STL_NO_ARROW_OPERATOR
</span>    <span class="n">pointer</span> <span class="k">operator</span><span class="o">-&gt;</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="k">operator</span><span class="o">*</span><span class="p">());}</span>
<span class="cp">#endif
</span>    <span class="n">self</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span><span class="n">increment</span><span class="p">();</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;}</span>
    <span class="n">self</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">){</span>
        <span class="n">self</span> <span class="n">tmp</span><span class="o">=*</span><span class="k">this</span><span class="p">;</span>
        <span class="n">increment</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">self</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">--</span><span class="p">()</span> <span class="p">{</span><span class="n">decrement</span><span class="p">();</span><span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;}</span>
    <span class="n">self</span> <span class="k">operator</span><span class="o">--</span><span class="p">(</span><span class="kt">int</span><span class="p">){</span>
        <span class="n">self</span> <span class="n">tmp</span><span class="o">=*</span><span class="k">this</span><span class="p">;</span>
        <span class="n">decrement</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-30-21-04-00.png" alt="å‡½æ•°ä¸­æ¯”è¾ƒè´¹è§£çš„æƒ…å†µ" /></p>

<p>è¿™é‡Œä¸»è¦æ˜¯å› ä¸ºå½“çº¢é»‘æ•°ä¸­ä¸ºç©ºçš„æ—¶å€™ï¼Œheadä¸endäº’ä¸ºçˆ¶èŠ‚ç‚¹</p>

<p><strong>RB-treeçš„æ•°æ®ç»“æ„</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span><span class="k">class</span> <span class="nc">Value</span><span class="p">,</span><span class="k">class</span> <span class="nc">KeyOfValue</span><span class="p">,</span><span class="k">class</span> <span class="nc">Compare</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="o">=</span><span class="n">alloc</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">rb_tree</span><span class="p">{</span>
<span class="nl">protected:</span>
    <span class="k">typedef</span> <span class="kt">void</span><span class="o">*</span>  <span class="n">void_pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">base_ptr</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_node</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">rb_tree_node</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">simple_alloc</span><span class="o">&lt;</span><span class="n">rb_tree_node</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;</span> <span class="n">rb_tree_node_allocator</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_color_type</span> <span class="n">color_type</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">key</span> <span class="n">key_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">Value</span> <span class="n">value_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">reference</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">rb_tree_node</span><span class="o">*</span> <span class="n">link_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">size_t</span> <span class="n">size_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="kt">ptrdiff_t</span> <span class="n">difference_type</span><span class="p">;</span>
<span class="nl">protected:</span>
    <span class="n">link_type</span> <span class="n">get_node</span><span class="p">(){</span><span class="k">return</span> <span class="n">rb_tree_node_allocator</span><span class="o">::</span><span class="n">allocate</span><span class="p">();}</span>
    <span class="kt">void</span> <span class="n">put_node</span><span class="p">(</span><span class="n">link_type</span> <span class="n">p</span><span class="p">){</span><span class="n">rb_tree_node_allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">p</span><span class="p">);}</span>

    <span class="n">link_type</span> <span class="n">create_node</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">link_type</span> <span class="n">tmp</span><span class="o">=</span><span class="n">get_node</span><span class="p">();</span>
        <span class="n">__STL_TRY</span><span class="p">{</span>
            <span class="c1">//æ„é€ å†…å®¹</span>

            <span class="n">construct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">value_field</span><span class="p">,</span><span class="n">x</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">__STL_UNWIND</span><span class="p">(</span><span class="n">put_node</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//å¤åˆ¶ä¸€ä¸ªèŠ‚ç‚¹(çš„å€¼å’Œé¢œè‰²)</span>

    <span class="n">link_type</span> <span class="n">clone_node</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">link_type</span> <span class="n">tmp</span><span class="o">=</span><span class="n">create_node</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">value_field</span><span class="p">);</span>
        <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>
        <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">destroy_node</span><span class="p">(</span><span class="n">link_type</span> <span class="n">p</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ææ„å†…å®¹</span>

        <span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">value_field</span><span class="p">);</span>
        <span class="c1">//é‡Šæ”¾å†…å­˜</span>

        <span class="n">put_node</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
<span class="nl">protected:</span>
    <span class="c1">//èŠ‚ç‚¹æ•°ç›®</span>

    <span class="n">size_type</span> <span class="n">node_count</span><span class="p">;</span>
    <span class="n">link_type</span> <span class="n">header</span><span class="p">;</span>
    <span class="c1">//èŠ‚ç‚¹çš„é”®å€¼å¤§å°æ¯”è¾ƒå‡†åˆ™ï¼Œåº”è¯¥ä¼šæ˜¯ä¸€ä¸ªfunction object;</span>

    <span class="n">Compare</span> <span class="n">key_compare</span><span class="p">;</span>
    <span class="c1">//æ–¹ä¾¿çš„headeræˆå‘˜å–ç”¨</span>

    <span class="n">link_type</span><span class="o">&amp;</span> <span class="n">root</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="o">&amp;</span><span class="p">)</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;}</span>
    <span class="n">link_type</span><span class="o">&amp;</span> <span class="n">leftmost</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="o">&amp;</span><span class="p">)</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;}</span>
    <span class="n">link_type</span><span class="o">&amp;</span> <span class="n">rightmost</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="o">&amp;</span><span class="p">)</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;}</span>
    <span class="c1">//è·å–èŠ‚ç‚¹xçš„æˆå‘˜å˜é‡</span>

    <span class="k">static</span> <span class="n">link_type</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="o">&amp;</span><span class="p">)(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);}</span>
    <span class="k">static</span> <span class="n">link_type</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="o">&amp;</span><span class="p">)(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);}</span>
    <span class="k">static</span> <span class="n">link_type</span><span class="o">&amp;</span> <span class="n">parent</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="o">&amp;</span><span class="p">)(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);}</span>
    <span class="k">static</span> <span class="n">reference</span> <span class="n">value</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">value_field</span><span class="p">;}</span>
    <span class="k">static</span> <span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="n">KeyOfValue</span><span class="p">()(</span><span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">));}</span>
    <span class="k">static</span> <span class="n">color_type</span><span class="o">&amp;</span> <span class="n">color</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span><span class="k">return</span> <span class="p">(</span><span class="n">color_type</span><span class="o">&amp;</span><span class="p">)(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);}</span>
    <span class="c1">//æ±‚å–æå¤§å€¼å’Œæå°å€¼</span>
    <span class="k">static</span> <span class="n">link_type</span> <span class="n">minimum</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="p">)</span> <span class="n">__rb_tree_node_base</span><span class="o">::</span><span class="n">minimum</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">static</span> <span class="n">link_type</span> <span class="n">maximum</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">){</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">link_type</span><span class="p">)</span><span class="n">__rb_tree_node_base</span><span class="o">::</span><span class="n">maximum</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="k">typedef</span> <span class="n">__rb_tree_iterator</span><span class="o">&lt;</span><span class="n">value_type</span><span class="p">,</span><span class="n">reference</span><span class="p">,</span><span class="n">pointer</span><span class="o">&gt;</span> <span class="n">iterator</span><span class="p">;</span>
<span class="nl">private:</span>
    <span class="n">iterator</span> <span class="n">__insert</span><span class="p">(</span><span class="n">base_ptr</span> <span class="n">x</span><span class="p">,</span><span class="n">base_ptr</span> <span class="n">y</span><span class="p">,</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">);</span>
    <span class="n">link_type</span> <span class="n">__copy</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">,</span><span class="n">link_type</span> <span class="n">p</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">__erase</span><span class="p">(</span><span class="n">link_type</span> <span class="n">x</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">init</span><span class="p">(){</span>
        <span class="c1">//äº§ç”Ÿä¸€ä¸ªèŠ‚ç‚¹ç©ºé—´ï¼Œä»¤headeræŒ‡å‘å®ƒ</span>

        <span class="n">header</span><span class="o">=</span><span class="n">get_node</span><span class="p">();</span>
        <span class="c1">//ä»¤headerä¸ºçº¢è‰²ï¼Œç”¨æ¥åŒºåˆ†headerå’Œroot</span>
        
        <span class="n">color</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">=</span><span class="n">__rb_tree_red</span><span class="p">;</span>
        <span class="n">root</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="c1">//headerçš„å·¦å³å­èŠ‚ç‚¹éƒ½ä¸ºè‡ªå·±</span>

        <span class="n">leftmost</span><span class="p">()</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
        <span class="n">rightmost</span><span class="p">()</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="n">rb_tree</span><span class="p">(</span><span class="k">const</span> <span class="n">Compare</span><span class="o">&amp;</span> <span class="n">comp</span><span class="o">=</span><span class="n">Compare</span><span class="p">())</span><span class="o">:</span><span class="n">node_count</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">key_compare</span><span class="p">(</span><span class="n">comp</span><span class="p">){</span><span class="n">init</span><span class="p">();}</span>
    <span class="o">~</span><span class="n">rb_tree</span><span class="p">(){</span>
        <span class="n">clear</span><span class="p">();</span>
        <span class="n">put_node</span><span class="p">(</span><span class="n">header</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;&amp;</span> <span class="n">x</span><span class="p">);</span>
    <span class="c1">//ç›¸å…³çš„åŸºæœ¬å‡½æ•°</span>

    <span class="n">Compare</span> <span class="n">key_comp</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">key_compare</span><span class="p">;}</span>
    <span class="n">iterator</span> <span class="n">begin</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">leftmost</span><span class="p">();}</span>
    <span class="n">iterator</span> <span class="n">end</span><span class="p">()</span> <span class="p">{</span><span class="k">return</span> <span class="n">header</span><span class="p">;}</span>
    <span class="kt">bool</span> <span class="n">empty</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">node_count</span><span class="o">==</span><span class="mi">0</span><span class="p">;}</span>
    <span class="n">size_type</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">node_count</span><span class="p">;}</span>
    <span class="n">size_type</span> <span class="n">max_size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">size_type</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);}</span>
<span class="nl">public:</span>
    <span class="c1">//å°†xæ’å…¥åˆ°çº¢é»‘æ ‘ä¸­,ä¿æŒèŠ‚ç‚¹ç‹¬ä¸€æ— äºŒ</span>

    <span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">insert_unique</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
    <span class="c1">//æ’å…¥ï¼Œå…è®¸å€¼é‡å¤</span>

    <span class="n">iterator</span> <span class="n">insert_equal</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">x</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>
<p>RB-treeçš„æ„é€ æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æ‹·è´æ„é€ ï¼Œä¸€ç§æ˜¯ç©ºå€¼æ„é€ ã€‚ä¸‹é¢æ˜¯å…¶init()çš„å…³é”®å‡½æ•°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">private:</span>
    <span class="kt">void</span> <span class="nf">init</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">header</span><span class="o">=</span><span class="n">get_node</span><span class="p">();</span>
        <span class="n">color</span><span class="p">(</span><span class="n">header</span><span class="p">)</span><span class="o">=</span><span class="n">rb_tree_redl</span>

        <span class="n">root</span><span class="p">()</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="n">leftmost</span><span class="p">()</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
        <span class="n">rightmost</span><span class="p">()</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
    <span class="p">}</span>
</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-31-16-37-06.png" alt="åˆå§‹åŒ–ç»“æœ" /></p>

<p><strong>RB-treeçš„å…³é”®æ“ä½œ</strong></p>

<p><strong>å…ƒç´ æ’å…¥ insert_equal()</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span><span class="k">class</span> <span class="nc">Value</span><span class="p">,</span><span class="k">class</span> <span class="nc">KeyOfValue</span><span class="p">,</span><span class="k">class</span> <span class="nc">Compare</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="p">&gt;</span>

<span class="k">typename</span> <span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">iterator</span> 

<span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">insert_equal</span><span class="p">(</span><span class="k">const</span> <span class="n">Value</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">link_type</span> <span class="n">y</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
    <span class="n">link_type</span> <span class="n">x</span><span class="o">=</span><span class="n">root</span><span class="p">();</span>
    <span class="c1">//ä»æ ¹èŠ‚ç‚¹å¼€å§‹å‘ä¸‹å¯»æ‰¾é€‚å½“çš„ä¼ æ’­èŠ‚ç‚¹ï¼Œç›´åˆ°åˆ°æ ¹èŠ‚ç‚¹ï¼Œæ³¨æ„è¿™é‡Œyä¸ºxçš„parentèŠ‚ç‚¹</span>

    <span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
        <span class="c1">//é‡å¤§åˆ™å·¦ï¼Œé‡å°æˆ–è€…ç­‰äºå°±å³--v&lt;xå‘å·¦ï¼Œv&gt;=xå‘å³</span>

        <span class="n">x</span><span class="o">=</span><span class="n">key_compare</span><span class="p">(</span><span class="n">KeyOfValue</span><span class="p">()(</span><span class="n">v</span><span class="p">),</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">?</span><span class="n">left</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">:</span><span class="n">right</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//xä¸ºæ–°å€¼æ’å…¥ç‚¹ï¼Œyä¸ºæ’å…¥ç‚¹ä¹‹çˆ¶èŠ‚ç‚¹ï¼Œvä¸ºæ–°å€¼</span>

    <span class="k">return</span> <span class="n">__insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p><strong>å…ƒç´ æ’å…¥æ“ä½œinsert_unique()</strong></p>

<p>å…ƒç´ æ’å…¥æ“ä½œâ€“ä¸å…è®¸é‡å¤å€¼å­˜åœ¨ï¼Œå¦åˆ™æ’å…¥æ— æ•ˆ
å‡½æ•°è¿”å›çš„å…ƒç´ æ˜¯ä¸€ä¸ªpairå€¼ï¼Œç¬¬ä¸€ä¸ªä¸ªæ˜¯RB-treeè¿­ä»£å™¨ï¼ŒæŒ‡å‘æ–°å¢èŠ‚ç‚¹ï¼Œç¬¬äºŒä¸ªå…ƒç´ è¡¨ç¤ºæ˜¯å¦æ’å…¥æˆåŠŸã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span> <span class="o">&lt;</span><span class="n">Class</span> <span class="n">Key</span><span class="p">,</span><span class="k">class</span> <span class="nc">Value</span><span class="p">,</span><span class="k">class</span> <span class="nc">KeyOfValue</span><span class="p">,</span><span class="k">class</span> <span class="nc">Compare</span><span class="p">,</span> <span class="k">class</span> <span class="nc">Alloc</span><span class="p">&gt;</span>

<span class="n">pair</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span>

<span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">insert_unique</span><span class="p">(</span><span class="k">const</span> <span class="n">Value</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">link_type</span> <span class="n">y</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
    <span class="c1">//ä»æ ¹èŠ‚ç‚¹å¼€å§‹</span>

    <span class="n">link_type</span> <span class="n">x</span><span class="o">=</span><span class="n">root</span><span class="p">();</span>
    <span class="c1">//åˆ¤æ–­æ˜¯å¦ç›¸åŒ</span>

    <span class="kt">bool</span> <span class="n">comp</span><span class="o">=</span><span class="nb">true</span><span class="p">;</span>
    <span class="c1">//ä¸€ç›´éå†åˆ°æ ¹èŠ‚ç‚¹</span>

    <span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
        <span class="c1">//væ˜¯å¦å°äºç›®å‰èŠ‚ç‚¹çš„é”®å€¼</span>

        <span class="n">comp</span><span class="o">=</span><span class="n">key_compare</span><span class="p">(</span><span class="n">KeyOfValue</span><span class="p">()(</span><span class="n">v</span><span class="p">),</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
        <span class="c1">//é‡â€œå¤§â€å‘å·¦ï¼Œå¦åˆ™å‘å³</span>

        <span class="n">x</span><span class="o">=</span><span class="n">comp</span><span class="o">?</span><span class="n">left</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">:</span><span class="n">right</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//ç¦»å¼€whileå¾ªç¯ä¹‹åï¼Œå³æ’å…¥çˆ¶èŠ‚ç‚¹</span>
    <span class="c1">//ä»¤è¿­ä»£å™¨jæŒ‡å‘æ’å…¥ç‚¹çš„çˆ¶èŠ‚ç‚¹</span>

    <span class="n">iterator</span> <span class="n">j</span><span class="o">=</span><span class="n">iterator</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="c1">//å¦‚æœåœ¨å·¦è¾¹æ’å…¥</span>

    <span class="k">if</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//å¦‚æœæ’å…¥èŠ‚ç‚¹ä¸ºæœ€å·¦èŠ‚ç‚¹</span>

        <span class="k">if</span><span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">begin</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">__insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="nb">true</span><span class="p">);</span> 
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//è°ƒæ•´jå‡†å¤‡å›å¤´è¿›è¡Œæµ‹è¯•</span>

            <span class="o">--</span><span class="n">j</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//å¦‚æœå°äºæ–°å€¼ï¼Œå°†æ’å…¥å³ä¾§</span>
    <span class="c1">//æ¯”è¾ƒæ˜¯å¦å­˜åœ¨é‡å¤çš„å€¼</span>

    <span class="k">if</span><span class="p">(</span><span class="n">key_compare</span><span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">node</span><span class="p">),</span><span class="n">KeyOfValue</span><span class="p">()(</span><span class="n">v</span><span class="p">))){</span>
        <span class="k">return</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">__insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">v</span><span class="p">),</span><span class="nb">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="nb">false</span><span class="p">);</span>

<span class="p">}</span>
<span class="c1">//å…³é”®æ’å…¥ç¨‹åº</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span><span class="k">class</span> <span class="nc">Value</span><span class="p">,</span><span class="k">class</span> <span class="nc">KeyOfValue</span><span class="p">,</span><span class="k">class</span> <span class="nc">Compare</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="p">&gt;</span>
<span class="k">typename</span> <span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">iterator</span>

<span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">__insert</span><span class="p">(</span><span class="n">base_ptr</span> <span class="n">x_</span><span class="p">,</span><span class="n">base_ptr</span> <span class="n">y_</span><span class="p">,</span><span class="k">const</span> <span class="n">Value</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//å°†å€¼éšå¼è½¬æ¢ä¸ºèŠ‚ç‚¹æŒ‡é’ˆï¼Œxæ’å…¥ä½ç½®ï¼Œyæ’å…¥çˆ¶èŠ‚ç‚¹ï¼Œvæ’å…¥çš„å€¼</span>

    <span class="n">link_type</span> <span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">link_type</span><span class="p">)</span><span class="n">x_</span><span class="p">;</span>
    <span class="n">link_type</span> <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">link_type</span><span class="p">)</span><span class="n">y_</span><span class="p">;</span>
    <span class="n">link_type</span> <span class="n">z</span><span class="p">;</span>
    <span class="c1">//åˆ¤æ–­æ˜¯å¦ä¸ºé¦–èŠ‚ç‚¹</span>

    <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="n">header</span><span class="o">||</span><span class="n">x</span><span class="o">!=</span><span class="mi">0</span><span class="o">||</span><span class="n">key_compare</span><span class="p">(</span><span class="n">KeyOfValue</span><span class="p">()(</span><span class="n">v</span><span class="p">),</span><span class="n">key</span><span class="p">(</span><span class="n">y</span><span class="p">)))</span>
    <span class="p">{</span>
        <span class="c1">//äº§ç”Ÿä¸€ä¸ªæ–°èŠ‚ç‚¹</span>

        <span class="n">z</span><span class="o">=</span><span class="n">create_node</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="c1">//é‡æ–°è°ƒæ•´æœ€ç”±èŠ‚ç‚¹</span>

        <span class="n">left</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">=</span><span class="n">z</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="n">header</span><span class="p">){</span>
            <span class="n">root</span><span class="p">()</span><span class="o">=</span><span class="n">z</span><span class="p">;</span>
            <span class="n">rightmost</span><span class="p">()</span><span class="o">=</span><span class="n">z</span><span class="p">;</span>
            <span class="c1">//å¦‚æœyä¸ºæœ€å·¦èŠ‚ç‚¹</span>

        <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="n">leftmost</span><span class="p">()){</span>
            <span class="c1">//è®©æœ€å·¦èŠ‚ç‚¹æ°¸è¿œæŒ‡å‘z</span>

            <span class="n">leftmost</span><span class="p">()</span><span class="o">=</span><span class="n">z</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">//ä¸æ˜¯headèŠ‚ç‚¹æˆ–è€…ç©ºèŠ‚ç‚¹</span>

    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="c1">//äº§ç”Ÿä¸€ä¸ªæ–°èŠ‚ç‚¹</span>

        <span class="n">z</span><span class="o">=</span><span class="n">create_node</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
        <span class="c1">//ä»¤æ–°èŠ‚ç‚¹ä½œä¸ºæ’å…¥èŠ‚ç‚¹çš„å³å…„å¼ŸèŠ‚ç‚¹</span>

        <span class="n">right</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">=</span><span class="n">z</span><span class="p">;</span>
        <span class="c1">//æ›´æ–°æœ€å³æŒ‡é’ˆä½ç½®</span>

        <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">==</span><span class="n">rightmost</span><span class="p">()){</span>
            <span class="n">rightmost</span><span class="p">()</span><span class="o">=</span><span class="n">z</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//è®¾ç½®æ–°èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹,å³å­èŠ‚ç‚¹å’Œå·¦å­èŠ‚ç‚¹</span>

    <span class="n">parent</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="n">left</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">right</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="c1">//è°ƒæ•´å’Œè®¾ç½®æ–°èŠ‚ç‚¹çš„é¢œè‰²</span>

    <span class="n">__rb_tree_rebalance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
    <span class="o">++</span><span class="n">node_count</span><span class="p">;</span>
    <span class="c1">//è¿”å›æ’å…¥çš„è¿­ä»£å™¨</span>

    <span class="k">return</span> <span class="n">iterator</span><span class="p">(</span><span class="n">z</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//è°ƒæ•´rb-tree(æ—‹è½¬å’Œæ”¹å˜é¢œè‰²)ï¼ŒèŠ‚ç‚¹å’ŒèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__rb_tree_rebalance</span><span class="p">(</span><span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">x</span><span class="p">,</span><span class="n">__rb_tree_node_base</span><span class="o">*&amp;</span> <span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//æ–°èŠ‚ç‚¹æ¯•ä¸ºçº¢</span>

    <span class="n">x</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_red</span><span class="p">;</span>
    <span class="c1">//å‡è®¾çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²,æŒ‰ç…§ä¹‹å‰çš„4ç§æƒ…å†µè¿›è¡Œåˆ¤æ–­ç„¶åè°ƒæ•´</span>

    <span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">!=</span><span class="n">root</span><span class="o">&amp;&amp;</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">==</span><span class="n">__rb_tree_red</span><span class="p">){</span>
        <span class="c1">//åˆ¤æ–­çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºå·¦å­èŠ‚ç‚¹</span>

        <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">==</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">){</span>
            <span class="c1">//yæŒ‡å‘å³ä¼¯èŠ‚ç‚¹</span>

            <span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
            <span class="c1">//å¦‚æœyå­˜åœ¨å¹¶ä¸”ä¹Ÿä¸ºçº¢è‰²</span>

            <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">&amp;&amp;</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">==</span><span class="n">__rb_tree_red</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//æ›´æ”¹çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span>

                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
                <span class="c1">//æ›´æ”¹çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span>

                <span class="n">y</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
                <span class="c1">//æ›´æ”¹ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢</span>

                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_red</span><span class="p">;</span>
                <span class="c1">//xé‡æ–°æŒ‡å‘ç¥–èŠ‚ç‚¹,å†æ¬¡å¾ªç¯è¿­ä»£æ›´æ”¹</span>

                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
                <span class="c1">//æ— ä¼¯çˆ¶èŠ‚ç‚¹ï¼Œæˆ–è€…ä¼¯çˆ¶èŠ‚ç‚¹ä¸ºé»‘</span>

            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="c1">//å¦‚æœæ–°èŠ‚ç‚¹ä¸ºå³å­èŠ‚ç‚¹</span>

                <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">){</span>
                    <span class="c1">//xé‡æ–°æŒ‡å‘çˆ¶èŠ‚ç‚¹</span>

                    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
                    <span class="c1">//ç¬¬ä¸€å‚æ•°ä¸ºå·¦æ—‹ç‚¹è¿›è¡Œå·¦æ—‹</span>

                    <span class="n">__rb_tree_rotate_left</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">root</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">//æ”¹å˜é¢œè‰²</span>
                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_red</span><span class="p">;</span>
                <span class="c1">//ç¬¬ä¸€å‚æ•°ä¸ºå³æ—‹ç‚¹</span>

                <span class="n">__rb_tree_rotate_right</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span><span class="n">root</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="c1">//çˆ¶èŠ‚ç‚¹ä¸ºç¥–çˆ¶èŠ‚ç‚¹ä¹‹å³å­èŠ‚ç‚¹</span>

        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//yä¸ºå·¦ä¼¯çˆ¶èŠ‚ç‚¹</span>

            <span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
            <span class="c1">//å·¦ä¼¯çˆ¶èŠ‚ç‚¹å­˜åœ¨ä¸”ä¸ºçº¢è‰²</span>

            <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">&amp;&amp;</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">==</span><span class="n">__rb_tree_red</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">//æ›´æ”¹çˆ¶èŠ‚ç‚¹ä¸ºé»‘</span>

                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
                <span class="c1">//ä¼¯çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</span>

                <span class="n">y</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
                <span class="c1">//æ›´æ”¹ç¥–çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</span>

                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_red</span><span class="p">;</span>
                <span class="c1">//ç§»åŠ¨æŒ‡é’ˆå‡†å¤‡ç»§ç»­å‘ä¸ŠæŸ¥</span>
                
                <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
            <span class="c1">//æ— ä¼¯çˆ¶èŠ‚ç‚¹æˆ–ä¼¯çˆ¶èŠ‚ç‚¹ä¸ºé»‘</span>

            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="c1">//å¦‚æœæ–°èŠ‚ç‚¹ä¸ºçˆ¶èŠ‚ç‚¹ä¹‹å·¦å­èŠ‚ç‚¹</span>

                <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">){</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
                    <span class="c1">//ç¬¬ä¸€å‚æ•°ä¸ºå³æ—‹ç‚¹</span>

                    <span class="n">__rb_tree_rotate_right</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">root</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
                <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_red</span><span class="p">;</span>
                <span class="c1">//ç¬¬ä¸€å‚æ•°ä¸ºå·¦æ—‹ç‚¹</span>

                <span class="n">__rb_tree_rotate_left</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span><span class="n">root</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="c1">//end while</span>
    <span class="c1">//rootèŠ‚ç‚¹æ°¸è¿œä¸ºé»‘</span>

    <span class="n">root</span><span class="o">-&gt;</span><span class="n">color</span><span class="o">=</span><span class="n">__rb_tree_black</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//å·¦æ—‹å‡½æ•°ï¼Œä¸»è¦æ˜¯å°†xå’Œå®ƒçš„å³å­èŠ‚ç‚¹è¿›è¡Œäº¤æ¢</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__rb_tree_rotate_left</span><span class="p">(</span><span class="n">__rb_tree_bode_base</span><span class="o">*</span> <span class="n">x</span><span class="p">,</span><span class="n">__rb_tree_bode_base</span><span class="o">*&amp;</span> <span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//xä¸ºæ—‹è½¬ç‚¹ï¼Œyä¸ºæ—‹è½¬ç‚¹çš„å³å­èŠ‚ç‚¹</span>

    <span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
    <span class="c1">//å°†xçš„å³å­èŠ‚ç‚¹ä¸ºå…¶å³å­èŠ‚ç‚¹çš„å·¦èŠ‚ç‚¹</span>

    <span class="n">x</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">=</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
    <span class="c1">//å­˜åœ¨ä¸”ä¸ä¸º0ï¼Œåˆ™äº¤æ¢æŒ‡é’ˆä½ç½®ï¼ŒæŒ‡ç›´æ¥å°†xçš„å³å­èŠ‚ç‚¹ä¸xäº¤æ¢ä½ç½®</span>

    <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
        <span class="c1">//æ›´æ–°xæŒ‡é’ˆä½ç½®</span>

        <span class="n">y</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">y</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
    <span class="c1">//è¿™é‡Œåˆ†ç©ºèŠ‚ç‚¹å’Œå•å·¦/å³èŠ‚ç‚¹è¿›è¡Œè®¨è®º</span>

    <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">root</span><span class="p">){</span>
        <span class="n">root</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">){</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">y</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
    <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__rb_tree_rotate_right</span><span class="p">(</span><span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">x</span><span class="p">,</span><span class="n">__rb_tree_node_base</span><span class="o">*&amp;</span> <span class="n">root</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//xä¸ºæ—‹è½¬ç‚¹,yä¸ºæ—‹è½¬çš„å·¦å­èŠ‚ç‚¹</span>

    <span class="n">__rb_tree_node_base</span><span class="o">*</span> <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
    <span class="n">x</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">=</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">y</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">=</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
    <span class="c1">//ä»¤yå®Œå…¨é¡¶æ›¿xçš„åœ°ä½(å¿…é¡»å°†xå¯¹å…¶çˆ¶èŠ‚ç‚¹çš„å…³ç³»å®Œå…¨æ¥æ”¶è¿‡æ¥)</span>

    <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">root</span><span class="p">){</span>
        <span class="n">root</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">){</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">y</span><span class="o">-&gt;</span><span class="n">right</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
    <span class="n">x</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">=</span><span class="n">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//rb-treeçš„æŸ¥æ‰¾å‡½æ•°</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">Key</span><span class="p">,</span><span class="k">class</span> <span class="nc">Value</span><span class="p">,</span><span class="k">class</span> <span class="nc">KeyOfValue</span><span class="p">,</span><span class="k">class</span> <span class="nc">Compare</span><span class="p">,</span><span class="k">class</span> <span class="nc">Alloc</span><span class="p">&gt;</span>
<span class="k">typename</span> <span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">iterator</span>

<span class="n">rb_tree</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="p">,</span><span class="n">KeyOfValue</span><span class="p">,</span><span class="n">Compare</span><span class="p">,</span><span class="n">Alloc</span><span class="o">&gt;::</span><span class="n">find</span><span class="p">(</span><span class="k">const</span> <span class="n">Key</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">){</span>
    <span class="c1">//rbæ ‘çš„å¤´éƒ¨</span>

    <span class="n">link_type</span> <span class="n">y</span><span class="o">=</span><span class="n">header</span><span class="p">;</span>
    <span class="n">link_type</span> <span class="n">x</span><span class="o">=</span><span class="n">root</span><span class="p">();</span>

    <span class="k">while</span><span class="p">(</span><span class="n">x</span><span class="o">!=</span><span class="mi">0</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">key_compare</span><span class="p">(</span><span class="n">key</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">k</span><span class="p">)){</span>
            <span class="c1">//xå¤§äºkå‘å·¦èµ°</span>

            <span class="n">y</span><span class="o">=</span><span class="n">x</span><span class="p">;</span>
            <span class="n">x</span><span class="o">=</span><span class="n">left</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//xå°äºk,é‡åˆ°å°å€¼å°±å‘å³èµ°</span>

            <span class="n">x</span><span class="o">=</span><span class="n">right</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">iterator</span> <span class="n">j</span><span class="o">=</span><span class="n">iterator</span><span class="p">(</span><span class="n">y</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="n">end</span><span class="p">()</span><span class="o">||</span> <span class="n">key_compare</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">key</span><span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">node</span><span class="p">)))</span><span class="o">?</span><span class="n">end</span><span class="p">()</span><span class="o">:</span><span class="n">j</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p><img src="https://wangpengcheng.github.io/img/2019-07-31-21-14-15.png" alt="æ’å…¥æ“ä½œ1" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-31-21-16-48.png" alt="æ’å…¥æ“ä½œ2" /></p>

<p><img src="https://wangpengcheng.github.io/img/2019-07-31-21-17-58.png" alt="æ’å…¥æ“ä½œ3" /></p>

<h3 id="53-set">5.3 set</h3>

<p>setä¸­æ‰€æœ‰å…ƒç´ éƒ½ä¼šæ ¹æ®å…ƒç´ çš„é”®å€¼è‡ªåŠ¨è¢«æ’åºã€‚setçš„å…ƒç´ ä¸åƒmapé‚£æ ·å¯ä»¥åŒæ—¶æ‹¥æœ‰keyå’Œvalue,setçš„é”®å€¼å°±æ˜¯å®å€¼ã€‚å¹¶ä¸”setä¸å…è®¸ä¸¤ä¸ªå…ƒç´ æ‹¥æœ‰ç›¸åŒçš„å€¼ã€‚</p>

<p>setä¸listæ‹¥æœ‰ç›¸åŒçš„æŸäº›æ€§è´¨ï¼šæ“ä½œè¿‡ç¨‹ä¸­ï¼Œé™¤äº†åˆ é™¤å…ƒç´ çš„è¿­ä»£å™¨å¤–ï¼Œå…¶å®ƒè¿­ä»£å™¨ä¸ä¼šå¤±æ•ˆã€‚</p>

<p>setçš„compareé»˜è®¤æƒ…å†µä¸‹æ˜¯ä½¿ç”¨<code class="language-plaintext highlighter-rouge">less&lt;Key&gt;</code>ç¼ºçœæƒ…å†µä¸‹é‡‡ç”¨é€’å¢æ’åºã€‚</p>

<p>seté‡‡ç”¨çº¢é»‘æ ‘æ¥è¿›è¡Œæ’åºå’Œæ•°æ®å­˜å‚¨ã€‚</p>

<h3 id="54-map">5.4 map</h3>

<p>mapçš„ç‰¹æ€§æ˜¯ï¼Œæ‰€æœ‰å…ƒç´ éƒ½ä¼šæ ¹æ®å…ƒç´ çš„é”®å€¼è‡ªåŠ¨è¢«æ’åºã€‚mapçš„æ‰€æœ‰å…ƒç´ éƒ½æ˜¯pairï¼ŒåŒæ—¶æ‹¥æœ‰å®å€¼(value)å’Œé”®å€¼(key)ã€‚pairçš„ç¬¬ä¸€å…ƒç´ è¢«è§†ä¸ºé”®å€¼ï¼Œç¬¬äºŒå…ƒç´ è¢«è§†ä¸ºå®å€¼ã€‚mapä¸å…è®¸ä¸¤ä¸ªå…ƒç´ æ‹¥æœ‰ç›¸åŒçš„é”®å€¼ã€‚</p>

<p>ä¸‹é¢æ˜¯<std_pair.h>ä¸­çš„pairå®šä¹‰</std_pair.h></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">class</span> <span class="nc">T1</span><span class="p">,</span><span class="k">class</span> <span class="nc">T2</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">pair</span>
<span class="p">{</span>
    <span class="k">typedef</span> <span class="n">T1</span> <span class="n">first_type</span><span class="p">;</span>
    <span class="k">typedef</span> <span class="n">T2</span> <span class="n">second_type</span><span class="p">;</span>
    <span class="n">T1</span> <span class="n">first</span><span class="p">;</span>
    <span class="n">T2</span> <span class="n">second</span><span class="p">;</span>
    <span class="n">pair</span><span class="p">()</span><span class="o">:</span><span class="n">first</span><span class="p">(</span><span class="n">T1</span><span class="p">()),</span><span class="n">second</span><span class="p">(</span><span class="n">T2</span><span class="p">()){}</span>
    <span class="n">pair</span><span class="p">(</span><span class="k">const</span> <span class="n">T1</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">,</span><span class="k">const</span> <span class="n">T2</span><span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span><span class="o">:</span><span class="n">first</span><span class="p">(</span><span class="n">a</span><span class="p">),</span><span class="n">second</span><span class="p">(</span><span class="n">b</span><span class="p">){}</span>    
<span class="p">};</span>

</code></pre></div></div>
<p><img src="https://wangpengcheng.github.io/img/2019-08-01-20-41-43.png" alt="STL map" /></p>

<h3 id="55-multiset">5.5 multiset</h3>

<p>multisetçš„ç‰¹æ€§ä»¥åŠç”¨æ³•å’Œsetå®Œå…¨ç›¸åŒï¼Œå”¯ä¸€çš„å·®åˆ«åœ¨äºå®ƒå…è®¸é”®å€¼é‡å¤ã€‚å®ƒçš„åº•å±‚æœºåˆ¶æ˜¯ä½¿ç”¨RB-treeçš„insert_equal()è€Œéinsert_unique()ï¼›</p>

<h3 id="56-multimap">5.6 multimap</h3>

<p>ä¸mapçš„ç”¨æ³•å®Œå…¨ç›¸åŒï¼Œå”¯ä¸€çš„å·®åˆ«åœ¨äºï¼Œå®ƒå…è®¸é”®å€¼é‡å¤ã€‚</p>

<h3 id="57-hashtable">5.7 hashtable</h3>
<p>hashtableçš„åŸç†å’Œæ›¿æ¢ç®—æ³•å‚è€ƒåŸç‹é“æ•°æ®ç»“æ„ä¸å†è¿‡å¤šå™è¿°</p>

<p>äºŒå‰æœç´¢æ ‘å…·æœ‰å¯¹æ•°æ—¶é—´å¹³å‡çš„è¡¨ç°ï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯å»ºç«‹åœ¨æ•°æ®è¾“å…¥æœ‰è¶³å¤Ÿçš„éšæœºæ€§è¿™ä¸ªåŸºç¡€ä¹‹ä¸Šçš„ã€‚hash_tableå°±æ˜¯è¿™ç§ã€‚</p>

<h4 id="571-hashtable-æ¦‚è¿°">5.7.1 hashtable æ¦‚è¿°</h4>

<p>ç¢°æ’é—®é¢˜è§£å†³åŠæ³•</p>

<ul>
  <li>çº¿æ€§æ¢æµ‹</li>
  <li>å¤å¼æ•£åˆ—(double hashing):</li>
  <li>å¼€é“¾ï¼šåœ¨æ¯ä¸ªè¡¨æ ¼å…ƒç´ ä¸­ç»´æŠ¤ä¸€ä¸ªlist;hash function ä¸ºæˆ‘ä»¬åˆ†é…æŸä¸€ä¸ªlist,ç„¶åæˆ‘ä»¬åœ¨é‚£ä¸ªlistä¸Šæ‰§è¡Œå…ƒç´ çš„ç›¸å…³æ“ä½œã€‚SGI STLçš„hash tableå°±æ˜¯è¿™ç§åšæ³•</li>
</ul>

<h4 id="572-hashtaleçš„æ¡¶å­bucketsä¸èŠ‚ç‚¹nodes">5.7.2 hashtaleçš„æ¡¶å­(buckets)ä¸èŠ‚ç‚¹(nodes)</h4>

<p><img src="https://wangpengcheng.github.io/img/2019-08-02-10-04-57.png" alt="å¼€é“¾æ³•çš„hash table" /></p>

<p>æ³¨æ„ï¼š</p>

<ul>
  <li>hashtable çš„è¿­ä»£å™¨æ²¡æœ‰åé€€æ“ä½œï¼Œä¹Ÿæ²¡æœ‰æ‰€è°“çš„åå‘è¿­ä»£å™¨ã€‚</li>
  <li>hash tble æ²¡æœ‰ä¾›åº”default constructor</li>
</ul>

<p>hash_tableçš„å…³é”®æ•°æ®ç»“æ„</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">node</span><span class="o">*</span> <span class="nf">new_node</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">node</span><span class="o">*</span> <span class="n">n</span><span class="o">=</span><span class="n">node_allocator</span><span class="o">::</span><span class="n">allocate</span><span class="p">();</span>
    <span class="n">n</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="n">__STL_TRY</span><span class="p">{</span>
        <span class="n">construct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span><span class="n">obj</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">__STL_UNWIND</span><span class="p">(</span><span class="n">node_allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">delete_node</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
    <span class="n">node_allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">hashtable</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">HashFcn</span><span class="o">&amp;</span> <span class="n">hf</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">EqualKey</span><span class="o">&amp;</span> <span class="n">eql</span><span class="p">)</span>
    <span class="o">:</span><span class="n">hash</span><span class="p">(</span><span class="n">hf</span><span class="p">),</span><span class="n">equals</span><span class="p">(</span><span class="n">eql</span><span class="p">),</span><span class="n">get_key</span><span class="p">(</span><span class="n">ExtractKey</span><span class="p">()),</span><span class="n">num_elements</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">initialize_buckets</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initialize_buckets</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="n">size_type</span> <span class="n">n_buckets</span><span class="o">=</span><span class="n">next_size</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
    <span class="n">buckets</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">n_buckets</span><span class="p">);</span>
    <span class="n">buckets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">buckets</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="n">n_buckets</span><span class="p">,(</span><span class="n">node</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">num_elements</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//è¿”å›æ¥è¿‘nå¹¶å¤§äºnçš„è´¨æ•°</span>

<span class="n">size_type</span> <span class="nf">next_size</span><span class="p">(</span><span class="n">size_type</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">__stl_next_prime</span><span class="p">(</span><span class="n">n</span><span class="p">);</span><span class="err">}</span>

<span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">insert_unique</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//æ˜¯å¦éœ€è¦é‡å»ºè¡¨æ ¼</span>

    <span class="n">resize</span><span class="p">(</span><span class="n">num_elements</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">insert_unique_noresize</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">V</span><span class="p">,</span><span class="k">class</span> <span class="nc">K</span><span class="p">,</span><span class="k">class</span> <span class="nc">HF</span><span class="p">,</span><span class="k">class</span> <span class="nc">Ex</span><span class="p">,</span><span class="k">class</span> <span class="nc">Eq</span><span class="p">,</span><span class="k">class</span> <span class="nc">A</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">hashtable</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">HF</span><span class="p">,</span><span class="n">Ex</span><span class="p">,</span><span class="n">Eq</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;::</span><span class="n">resize</span><span class="p">(</span><span class="n">size_type</span> <span class="n">num_elements_hint</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//å°†å…ƒç´ ä¸ªæ•°(æ–°å¢å…ƒç´ è®¡å…¥å)ä¸bucket vectorçš„å¤§å°æ¯”è¾ƒã€‚å¦‚æœå¤§äºå°±é‡å»ºè¡¨æ ¼</span>

    <span class="c1">//è¿™é‡Œçš„bucketsæ˜¯ vector&lt;node*,Alloc&gt; buckets</span>

    <span class="k">const</span> <span class="n">size_type</span> <span class="n">old_n</span><span class="o">=</span><span class="n">buckets</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="c1">//æ˜¯å¦é‡æ–°é…ç½®å…ƒç´ </span>

    <span class="k">if</span><span class="p">(</span><span class="n">num_elements_hint</span><span class="o">&gt;</span><span class="n">old_n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//æ‰¾å‡ºä¸‹ä¸€ä¸ªè´¨æ•°</span>

        <span class="k">const</span> <span class="n">size_type</span> <span class="n">n</span><span class="o">=</span><span class="n">next_size</span><span class="p">(</span><span class="n">num_elements_hint</span><span class="p">);</span>
        <span class="c1">//ç¡®å®šä¸‹ä¸€ä¸ªè´¨æ•°æ˜¯å¦è¶Šç•Œ</span>

        <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">&gt;</span><span class="n">old_n</span><span class="p">){</span>
            <span class="c1">//è®¾ç«‹æ–°çš„æ¡¶</span>

            <span class="n">vector</span><span class="o">&lt;</span><span class="n">node</span><span class="o">*</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">tmp</span><span class="p">(</span><span class="n">n</span><span class="p">,(</span><span class="n">node</span><span class="o">*</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
            <span class="n">__STL_TRY</span><span class="p">{</span>
                <span class="c1">//å¤„ç†æ¯ä¸€ä¸ªæ—§çš„bucket</span>

                <span class="k">for</span><span class="p">(</span><span class="n">size_type</span> <span class="n">buckets</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">buckets</span><span class="o">&lt;</span><span class="n">old_n</span><span class="p">;</span><span class="o">++</span><span class="n">buckets</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//æŒ‡å‘èŠ‚ç‚¹æ‰€å¯¹åº”ä¸²è¡Œçš„èµ·å§‹èŠ‚ç‚¹</span>

                    <span class="n">node</span><span class="o">*</span> <span class="n">first</span><span class="o">=</span><span class="n">buckets</span><span class="p">[</span><span class="n">buckets</span><span class="p">];</span>
                    <span class="c1">//ä»¥ä¸‹å¤„ç†æ¯ä¸ªå°±bucketæ‰€å«(ä¸²è¡Œ)çš„æ¯ä¸ªèŠ‚ç‚¹</span>
                    <span class="c1">//éå†ä¸²è¡Œ</span>

                    <span class="k">while</span><span class="p">(</span><span class="n">first</span><span class="p">){</span>
                        <span class="c1">//æ‰¾å‡ºèŠ‚ç‚¹è½åœ¨é‚£ä¸ªæ–°bucketå†…</span>

                        <span class="n">size_type</span> <span class="n">new_bucket</span><span class="o">=</span><span class="n">bkt_num</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
                        <span class="c1">//ä»¤æ—§bucketæŒ‡å‘å…¶æ‰€å¯¹åº”ä¸²è¡Œçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹(ä»¥ä¾¿è¿­ä»£å¤„ç†)</span>

                        <span class="n">buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span><span class="o">=</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
                        <span class="c1">//å°†å½“å‰èŠ‚ç‚¹æ’å…¥åˆ°æ–°bucketå†…ï¼Œæˆä¸ºå¯¹åº”ä¸²è¡Œçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>

                        <span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">tmp</span><span class="p">[</span><span class="n">new_bucket</span><span class="p">];</span>
                        <span class="c1">//å›åˆ°æ—§bucketæ‰€æŒ‡çš„å¾…å¤„ç†ä¸²è¡Œï¼Œå‡†å¤‡å¤„ç†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span>

                        <span class="n">first</span><span class="o">=</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">];</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="c1">//å¯¹è°ƒä¸¤ä¸ªæ–°æ—§æ¡¶</span>

                <span class="n">buckets</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
                <span class="c1">//æ³¨æ„ï¼Œå¯¹è°ƒä¸¤æ–¹ï¼Œå¦‚æœå¤§å°ä¸åŒï¼Œå¤§çš„ä¼šå˜å°ï¼Œå°çš„ä¼šå˜å¤§</span>
                <span class="c1">//ç¦»å¼€æ—¶é‡Šæ”¾local tmpçš„å†…å­˜</span>

            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//æ’å…¥èŠ‚ç‚¹çš„å…³é”®å‡½æ•°</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">V</span><span class="p">,</span><span class="k">class</span> <span class="nc">K</span><span class="p">,</span><span class="k">class</span> <span class="nc">HF</span><span class="p">,</span><span class="k">class</span> <span class="nc">Ex</span><span class="p">,</span><span class="k">class</span> <span class="nc">Eq</span><span class="p">,</span><span class="k">class</span> <span class="nc">A</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">hashtable</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span><span class="n">K</span><span class="p">,</span><span class="n">HF</span><span class="p">,</span><span class="n">Ex</span><span class="p">,</span><span class="n">Eq</span><span class="p">,</span><span class="n">A</span><span class="o">&gt;::</span><span class="n">insert_unique_noresize</span><span class="p">(</span><span class="k">const</span> <span class="n">value_type</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//å†³å®šobjçš„æ¡¶ä½ç½®</span>

    <span class="k">const</span> <span class="n">size_type</span> <span class="n">n</span><span class="o">=</span><span class="n">bkt_num</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="c1">//firstæŒ‡å‘bucketå¯¹åº”ä¹‹ä¸²è¡Œå¤´éƒ¨</span>

    <span class="n">node</span><span class="o">*</span> <span class="n">first</span><span class="o">=</span><span class="n">buckets</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
    <span class="c1">//å¦‚æœä½ç½®å·²ç»è¢«å ç”¨ï¼Œå³first!=0;å¾ªç¯éå†æŸ¥æ‰¾æ–°ä½ç½®</span>

    <span class="k">for</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">cur</span><span class="o">=</span><span class="n">first</span><span class="p">;</span><span class="n">cur</span><span class="p">;</span><span class="n">cur</span><span class="o">=</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">equals</span><span class="p">(</span><span class="n">get_key</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">),</span><span class="n">get_key</span><span class="p">(</span><span class="n">obj</span><span class="p">))){</span>
            <span class="k">return</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iterator</span><span class="p">(</span><span class="n">cur</span><span class="p">,</span><span class="k">this</span><span class="p">),</span><span class="nb">false</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//ç¦»å¼€ä»¥ä¸Šå¾ªç¯ï¼ŒfirstæŒ‡å‘bucketæ‰€å€¼é“¾è¡¨çš„å¤´éƒ¨èŠ‚ç‚¹</span>
    <span class="c1">//äº§ç”Ÿæ–°èŠ‚ç‚¹</span>

    <span class="n">node</span><span class="o">*</span> <span class="n">tmp</span><span class="o">=</span><span class="n">new_node</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">first</span><span class="p">;</span>
    <span class="c1">//ä»¤èŠ‚ç‚¹æˆä¸ºé“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</span>

    <span class="n">buckets</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">;</span>
    <span class="c1">//èŠ‚ç‚¹ä¸ªæ•°ç´¯åŠ 1</span>

    <span class="o">++</span><span class="n">num_elements</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">pair</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iterator</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="k">this</span><span class="p">),</span><span class="nb">true</span><span class="p">);</span>

<span class="p">}</span>

</code></pre></div></div>
<p><img src="https://wangpengcheng.github.io/img/2019-08-02-16-02-48.png" alt="è¡¨æ ¼é‡å»ºæ“ä½œåˆ†è§£" /></p>

<p>hash_tableçš„å…³é”®ç›¸å…³å‡½æ•°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">size_type</span> <span class="n">bkt_num_key</span><span class="p">(</span><span class="k">const</span> <span class="n">key_type</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
    <span class="c1">//è¿™é‡Œçš„hashå‡½æ•°åœ¨å®ä¾‹è¯æ¨¡æ¿çš„æ—¶å€™å†³å®š</span>

    <span class="k">return</span> <span class="n">hash</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">%</span><span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>æ³¨æ„hash_tableçš„ä¸­çš„æ•°ç›®çš„æ’åºæ˜¯æ— åºçš„ã€‚</p>

<h3 id="58-hash_set">5.8 hash_set</h3>

<p>hash_setä»¥hashtableä¸ºåº•å±‚æœºåˆ¶ã€‚ç”±äºhash_setæ‰€ä¾›åº”çš„æ“ä½œæ¥å£ã€‚
æ³¨æ„ï¼šhash_tableä¸­æ²¡æœ‰è‡ªåŠ¨æ’åºåŠŸèƒ½</p>

<h3 id="hash_maphash_multisethash_multimap">hash_mapã€hash_multisetã€hash_multimap</h3>

<p>åŸºæœ¬éƒ½ä¸å¯¹åº”çš„ç±»å‹ç›¸åŒï¼Œåªæ˜¯åº•å±‚æœºåˆ¶ç”±hash_tableæ¥è¿›è¡Œå®ç°ã€‚</p>
:ET