I"ù©<blockquote>
  <p>2019-07-11 20:09:48</p>
</blockquote>

<h2 id="ç¬¬6ç« --åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„è®¾è®¡">ç¬¬6ç«   åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„è®¾è®¡</h2>

<h3 id="61-å¹¶å‘è®¾è®¡çš„æ„ä¹‰">6.1 å¹¶å‘è®¾è®¡çš„æ„ä¹‰</h3>

<p>åŒè¿‡åˆç†è®¾è®¡äº’æ–¥é‡ï¼Œè®©å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘çš„è®¿é—®è¿™ä¸ªæ•°æ®ï¼Œçº¿ç¨‹å¯ä»¥å¯¹è¿™ä¸ªæ•°æ®ç»“æ„åšç›¸åŒæˆ–è€…ä¸åŒçš„æ“ä½œã€‚</p>

<p><strong>åºåˆ—åŒ–(serialzation)</strong>:çº¿ç¨‹è½®æµè®¿é—®è¢«ä¿æŠ¤çš„æ•°æ®ã€‚è¿™å…¶å®æ˜¯å¯¹æ•°æ®è¿›è¡Œä¸²è¡Œçš„è®¿é—®,è€Œéå¹¶å‘ã€‚</p>

<p>ä¸€èˆ¬è¿›è¡Œå¹¶å‘æ•°æ®ç»“æ„è®¾è®¡çš„æ€è·¯éƒ½æ˜¯ï¼šå‡å°‘ä¿æŠ¤åŒºåŸŸ,å‡å°‘åºåˆ—åŒ–æ“ä½œ,å°±èƒ½æå‡å¹¶å‘è®¿é—®çš„æ½œåŠ›ã€‚</p>

<h4 id="611--æ•°æ®ç»“æ„å¹¶å‘è®¾è®¡çš„æŒ‡å¯¼ä¸å»ºè®®æŒ‡å—">6.1.1  æ•°æ®ç»“æ„å¹¶å‘è®¾è®¡çš„æŒ‡å¯¼ä¸å»ºè®®(æŒ‡å—)</h4>

<p>æ•°æ®ç»“æ„çº¿ç¨‹å®‰å…¨æ¡ä»¶:</p>

<ul>
  <li>ç¡®ä¿æ— çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°,æ•°æ®ç»“æ„çš„â€œä¸å˜é‡â€ç ´åæ—¶çš„çŠ¶æ€ã€‚</li>
  <li>å°å¿ƒé‚£äº›ä¼šå¼•èµ·æ¡ä»¶ç«äº‰çš„æ¥å£,æä¾›å®Œæ•´æ“ä½œçš„å‡½æ•°,è€Œéæ“ä½œæ­¥éª¤ã€‚</li>
  <li>æ³¨æ„æ•°æ®ç»“æ„çš„è¡Œä¸ºæ˜¯å¦ä¼šäº§ç”Ÿå¼‚å¸¸,ä»è€Œç¡®ä¿â€œä¸å˜é‡â€çš„çŠ¶æ€ç¨³å®šã€‚</li>
  <li>å°†æ­»é”çš„æ¦‚ç‡é™åˆ°æœ€ä½ã€‚ä½¿ç”¨æ•°æ®ç»“æ„æ—¶,éœ€è¦é™åˆ¶é”çš„èŒƒå›´,ä¸”é¿å…åµŒå¥—é”çš„å­˜åœ¨ã€‚</li>
</ul>

<p>éœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼š</p>

<ul>
  <li>é”çš„èŒƒå›´ä¸­çš„æ“ä½œ,æ˜¯å¦å…è®¸åœ¨é”å¤–æ‰§è¡Œ?</li>
  <li>æ•°æ®ç»“æ„ä¸­ä¸åŒçš„åŒºåŸŸæ˜¯å¦èƒ½è¢«ä¸åŒçš„äº’æ–¥é‡æ‰€ä¿æŠ¤?</li>
  <li>æ‰€æœ‰æ“ä½œéƒ½éœ€è¦åŒçº§äº’æ–¥é‡ä¿æŠ¤å—?</li>
  <li>èƒ½å¦å¯¹æ•°æ®ç»“æ„è¿›è¡Œç®€å•çš„ä¿®æ”¹,ä»¥å¢åŠ å¹¶å‘è®¿é—®çš„æ¦‚ç‡,ä¸”ä¸å½±å“æ“ä½œè¯­ä¹‰?</li>
</ul>

<h3 id="62-åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„">6.2 åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„</h3>

<p>åŸºäºé”çš„å¹¶å‘æ•°æ®ç»“æ„è®¾è®¡,æ ¸å¿ƒåœ¨äº <strong>ä¿è¯ç¨‹åºå®‰å…¨çš„æƒ…å†µä¸‹ï¼Œä¿è¯çº¿ç¨‹æŒæœ‰é”çš„æ—¶é—´æœ€çŸ­</strong>ã€‚</p>

<p>çº¿ç¨‹å®‰å…¨çš„<code class="language-plaintext highlighter-rouge">stack</code>å’Œ<code class="language-plaintext highlighter-rouge">queue</code>ç¤ºä¾‹ï¼Œç¬¬ä¸‰ã€å››ç« ä¸­ï¼Œåœ¨æ­¤ä¸åšè¿‡å¤šå™è¿°</p>

<h4 id="623--çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ä½¿ç”¨ç»†ç²’åº¦é”å’Œæ¡ä»¶å˜é‡">6.2.3  çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—â€”â€”ä½¿ç”¨ç»†ç²’åº¦é”å’Œæ¡ä»¶å˜é‡</h4>

<p>é¦–å…ˆå…ˆçœ‹ä¸€ä¸ªå•çº¿ç¨‹çš„é˜Ÿåˆ—ï¼š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">T</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">;</span>

        <span class="n">node</span><span class="p">(</span><span class="n">T</span> <span class="n">data_</span><span class="p">);</span>
        <span class="n">data_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">data_</span><span class="p">))</span>
        <span class="p">{}</span>
    <span class="p">};</span>
    <span class="c1">//å¤´éƒ¨æŒ‡é’ˆ</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">head</span><span class="p">;</span>
    <span class="c1">//é˜Ÿå°¾éƒ¨æŒ‡é’ˆ</span>

    <span class="n">node</span><span class="o">*</span> <span class="n">tail</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">queue</span><span class="p">(){}</span>
    <span class="n">queue</span><span class="p">(</span><span class="k">const</span> <span class="n">queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">queue</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">try_pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">){</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">res</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)));</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">old_head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
        <span class="c1">//å°†headæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ª</span>

        <span class="n">head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
<span class="c1">//å°¾éƒ¨æ’å…¥</span>

    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_value</span><span class="p">)));</span>
        <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">new_tail</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">tail</span><span class="o">=</span><span class="n">new_tail</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå•çº¿ç¨‹æƒ…å†µä¸‹ï¼ŒåŸºæœ¬ä½¿ç”¨è‰¯å¥½ï¼Œä½†æ˜¯å¯¹äºå¤šçº¿ç¨‹è€Œè¨€ï¼Œåœ¨pushå’Œpopä¸­æ²¡æœ‰å¯¹å¤´å°¾æŒ‡é’ˆæ·»åŠ ä¿æŠ¤é”ï¼ŒåŒæ—¶ï¼Œä¸ºäº†é˜²æ­¢åœ¨é˜Ÿåˆ—åªæœ‰ä¸€ä¸ªå…ƒç´ æ—¶çš„æ—¶å€™ï¼Œhead==tailï¼›æ‰€ä»¥pushå’Œtry_popé—´æ¥è®¿é—®äº†è¿™ä¸ªå¤´å°¾æŒ‡é’ˆï¼Œå› æ­¤éœ€è¦å¯¹tailæ·»åŠ ä¿æŠ¤é”ã€‚
ä¸è¿‡è¿™é‡Œä½¿ç”¨æ›´ç®€ä¾¿çš„æ–¹æ³•ï¼Œå‡å°‘é”çš„ä½¿ç”¨ï¼šé¢„åˆ†é…ä¸€ä¸ªç©ºèŠ‚ç‚¹ï¼Œæ°¸è¿œæŒ‡å‘é˜Ÿåˆ—å°¾éƒ¨ï¼Œè¿™æ ·é¿å…äº†å¤´å°¾æŒ‡é’ˆèƒ½å¤Ÿè¢«é—´æ¥è®¿é—®ã€‚ä½†æ˜¯ä½¿ç”¨äº†ä¸€ä¸ªé—´æ¥å±‚æ¬¡çš„æŒ‡é’ˆæ•°æ®ä½œä¸ºè™šæ‹ŸèŠ‚ç‚¹ã€‚</p>

<p>æ›´æ”¹å®Œæˆæ—¶å€™ï¼Œåœ¨pushæ“ä½œä¸­åªç”¨è€ƒè™‘å°¾éƒ¨æŒ‡é’ˆtailåœ¨popå‡½æ•°ä¸­è™½ç„¶å¯ä»¥è®¿é—®tailä½†æ˜¯tailåªåœ¨æœ€åˆé˜¶æ®µè¿›è¡Œæ¯”è¾ƒï¼Œæ›´å¤šéœ€è¦è€ƒè™‘headã€‚åŒæ—¶ï¼Œæ·»åŠ è™šæ‹ŸèŠ‚ç‚¹æ„å‘³ç€popå’Œpushä¸èƒ½åŒæ—¶å¯¹åŒä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œæ“ä½œã€‚</p>

<p>æœ€ç»ˆï¼Œé™¤äº†æ“ä½œçš„å…ƒç´ å¤–éœ€è¦ä¸Šé”å¤–ï¼Œpushåªå¯¹tailä¸Šé”ï¼Œtry_pop,å…ˆå¯¹headä¸Šé”ï¼Œä¸€æ—¦è¢«æ”¹å˜ä¹‹åå°±ä¸å†åŠ é”ã€‚</p>

<p>æœ€ç»ˆç»“æœï¼š</p>

<p>çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—â€“ç»†ç²’åº¦é”ç‰ˆ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">threadsafe_queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">;</span>
        
    <span class="p">};</span>
    <span class="c1">//å¤´éƒ¨èŠ‚ç‚¹</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">head</span><span class="p">;</span>
    <span class="c1">//å°¾éƒ¨èŠ‚ç‚¹</span>
    <span class="n">node</span><span class="o">*</span> <span class="n">tail</span><span class="p">;</span>
    <span class="c1">//å¤´éƒ¨äº’æ–¥ä¿æŠ¤</span>

    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">head_mutex</span><span class="p">;</span>
    <span class="c1">//å°¾éƒ¨ä¿¡å·é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">tail_mutex</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">threadsafe_queue</span><span class="p">()</span><span class="o">:</span><span class="n">head</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">),</span><span class="n">tail</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">){}</span>
    <span class="o">~</span><span class="n">threadsafe_queue</span><span class="p">();</span>
    <span class="n">threadsafe_queue</span><span class="p">(</span><span class="k">const</span> <span class="n">threadsafe_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">threadsafe_queue</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">threadsafe_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>


    <span class="n">node</span><span class="o">*</span> <span class="n">get_tail</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">tail_lock</span><span class="p">(</span><span class="n">tail_mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">tail</span><span class="p">;</span>
    <span class="p">}</span> 
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">pop_head</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">head_mutex</span><span class="p">);</span>
        <span class="c1">//ä½¿ç”¨git_tail ä¿æŠ¤å°¾éƒ¨æŒ‡é’ˆä¸€æ¬¡</span>

        <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">get_tail</span><span class="p">()){</span>
            <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">old_head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
        <span class="n">head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">old_head</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">new_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_value</span><span class="p">)));</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">);</span>
        <span class="k">const</span><span class="o">*</span> <span class="k">const</span> <span class="n">new_tail</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
        <span class="c1">//tail åŠ é”</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">tail_lock</span><span class="p">(</span><span class="n">tail_mutex</span><span class="p">);</span>
        <span class="n">tail</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">=</span><span class="n">new_value</span><span class="p">;</span>
        <span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="n">tail</span><span class="o">=</span><span class="n">new_tail</span><span class="p">;</span> 
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">try_pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">old_head</span><span class="o">=</span><span class="n">pop_head</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">old_head</span><span class="o">?</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">:</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">};</span>

</code></pre></div></div>

<p>åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šæ·»åŠ ï¼Œå¯ä¸Šé”å’Œç­‰å¾…çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼›ä½†æ˜¯ç”±äºwait_and_popç­‰æ“ä½œä¼šé™ä½ç¨‹åºçš„æ€§èƒ½ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">threadsafe_queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span>  <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">head_mutex</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">head</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">mutex</span>  <span class="n">tail_mutex</span><span class="p">;</span>
    <span class="n">node</span><span class="o">*</span> <span class="n">tail</span><span class="p">;</span>
    <span class="c1">//ç¯å¢ƒä¿¡å·å˜é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span> <span class="n">data_cond</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">threadsafe_queue</span><span class="p">()</span><span class="o">:</span><span class="n">head</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">),</span><span class="n">tail</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">()){}</span>
    <span class="n">threadsafe_queue</span><span class="p">(</span><span class="k">const</span> <span class="n">threadsafe_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">threadsafe_queue</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">threadsafe_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">node</span><span class="o">*</span> <span class="n">get_tail</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">tail_lock</span><span class="p">(</span><span class="n">tail_mutex</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">tail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">pop_head</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">old_head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
        <span class="n">head</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">old_head</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//æ•°æ®ç­‰å¾…çº¿ç¨‹é”</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">wait_for_data</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">head_mutex</span><span class="p">);</span>
        <span class="c1">//ç­‰å¾…ç¯å¢ƒå”¤é†’</span>

        <span class="n">data_cond</span><span class="p">.</span><span class="n">wait</span><span class="p">(</span><span class="n">head_lock</span><span class="p">,[</span><span class="o">&amp;</span><span class="p">]{</span><span class="k">return</span> <span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">!=</span><span class="n">get_tail</span><span class="p">();});</span>
        <span class="c1">//å°†é”çš„å®ä¾‹ï¼Œè¿”å›ç»™è°ƒç”¨è€…</span>

        <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">head_lock</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">wait_pop_head</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//æ·»åŠ æ•°æ®ç­‰å¾…çº¿ç¨‹é”</span>

        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">wait_for_data</span><span class="p">());</span>

        <span class="k">return</span> <span class="n">pop_head</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">wait_pop_head</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">wait_for_data</span><span class="p">());</span>
        <span class="c1">//è·å–å¤´éƒ¨æ•°æ®</span>

        <span class="n">value</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">pop_head</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">wait_and_pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">old_head</span><span class="o">=</span><span class="n">wait_pop_head</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">//è¯•ç€æ‹¿å‡ºå¤´éƒ¨</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">try_pop_head</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">head_mutex</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">get_tail</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">pop_head</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">try_pop_head</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">head_mutex</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">get_tail</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="n">value</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">pop_head</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="n">try_pop</span><span class="p">();</span>
    <span class="kt">bool</span> <span class="n">try_pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">wait_and_pop</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">wait_and_pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span>  <span class="n">new_value</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">empty</span><span class="p">();</span>
<span class="p">};</span>

<span class="c1">//æ¨å…¥æ–°èŠ‚ç‚¹</span>

<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">threadsafe_queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span> <span class="n">new_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_value</span><span class="p">)));</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">p</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">);</span>
    <span class="p">{</span>
        <span class="c1">//å°¾éƒ¨åŠ é”</span>

        <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">tail_lock</span><span class="p">(</span><span class="n">tail_mutex</span><span class="p">);</span>
        <span class="n">tail</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">=</span><span class="n">new_data</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">new_tail</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
        <span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="n">tail</span><span class="o">=</span><span class="n">new_tail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//å‘å°„ç¯å¢ƒä¿¡å·</span>

    <span class="n">data_cond</span><span class="p">.</span><span class="n">notify_one</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—</span>

<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">threadsafe_queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">wait_and_pop</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">old_head</span><span class="o">=</span><span class="n">wait_pop_head</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="n">threadsafe_queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">wait_and_pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//ä¼ é€’å€¼ï¼Œç„¶åè¿”å›å–å‡ºçš„å¤´éƒ¨</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">old_head</span><span class="o">=</span><span class="n">wait_pop_head</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span> <span class="n">threadsafe_queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">try_pop</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">old_head</span><span class="o">=</span><span class="n">try_pop_head</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">old_head</span><span class="o">?</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">:</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="kt">bool</span> <span class="n">threadsafe_queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">try_pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">old_head</span><span class="o">=</span><span class="n">try_pop_head</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">old_head</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
<span class="kt">bool</span> <span class="nf">empty</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">head_lock</span><span class="p">(</span><span class="n">head_mutex</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">get</span><span class="p">()</span><span class="o">==</span><span class="n">get_tail</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="63-åŸºäºé”è®¾è®¡æ›´åŠ å¤æ‚çš„æ•°æ®ç»“æ„">6.3 åŸºäºé”è®¾è®¡æ›´åŠ å¤æ‚çš„æ•°æ®ç»“æ„</h3>

<p>è¿™é‡Œä¸»è¦ä»¥å®šä¹‰ä¸€ä¸ªç®€å•çš„çº¿ç¨‹å®‰å…¨æŸ¥è¯¢è¡¨å’Œé“¾è¡¨ä¸ºä¾‹ï¼Œè¿›è¡Œå·¥ä½œ</p>

<h4 id="631-ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æŸ¥è¯¢è¡¨">6.3.1 ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„æŸ¥è¯¢è¡¨</h4>

<p>é¦–å…ˆæ˜ç¡®æŸ¥è¯¢è¡¨çš„åŸºæœ¬æ“ä½œæœ‰ï¼š</p>

<ul>
  <li>æ·»åŠ ä¸€é˜Ÿâ€œé”®å€¼-æ•°æ®â€</li>
  <li>ä¿®æ”¹æŒ‡å®šé”®å€¼æ‰€å¯¹åº”çš„æ•°æ®</li>
  <li>åˆ é™¤ä¸€ç»„å€¼</li>
  <li>é€šè¿‡ç»™å®šé”®å€¼ï¼Œè·å–å¯¹åº”æ•°æ®</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">std::map</code>æ¤é—´ç›˜ç¾å¥½å¸¸è§çš„å…³è”å®¹å™¨å’Œæ¯”è¾ƒ</p>

<ul>
  <li>äºŒå‰æ ‘ï¼›æ¯”å¦‚ï¼šçº¢é»‘æ ‘ï¼šå¹¶ä¸ä¼šæé«˜å¯¹é«˜å¹¶å‘çš„è®¿é—®ï¼Œæ¯ä¸€ä¸ªéƒ½è¦è®¿é—®æ ¹èŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹éœ€è¦æ—¶å¸¸ä¸Šé”</li>
  <li>æœ‰åºæ•°ç»„ï¼šæ˜¯æœ€åçš„é€‰æ‹©ï¼Œæ— æ³•æå‰æ„ŸçŸ¥é‚£ä¸ªæœ‰åº</li>
  <li>å“ˆå¸Œè¡¨ï¼šç»“åˆæ¡¶ï¼Œå¯¹æ¯ä¸ªæ¡¶è¿›è¡Œäº’æ–¥åŠ é”ï¼Œæé«˜å¹¶å‘æ€§èƒ½ã€‚</li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®šä¹‰æ¨¡æ¿ï¼šå…³é”®å­—ã€å€¼ã€hashæ˜ å°„</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Key</span><span class="p">,</span><span class="k">typename</span> <span class="nc">Value</span><span class="p">,</span><span class="k">typename</span> <span class="nc">Hash</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">hash</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">&gt;</span> <span class="o">&gt;</span>



<span class="k">class</span> <span class="nc">threadsafe_lookup_table</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">//å®šä¹‰æ¡¶çš„åŸºæœ¬ç±»å‹</span>

    <span class="k">class</span> <span class="nc">bucket_type</span>
    <span class="p">{</span>
    <span class="nl">private:</span>
        <span class="c1">//è®¾ç½®é”®å€¼å¯¹åŸºæœ¬ç±»å‹</span>

        <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="n">Value</span><span class="o">&gt;</span>    <span class="n">bucket_value</span><span class="p">;</span>
        <span class="c1">//è®¾ç½®é”®å€¼é˜Ÿåˆ—è¡¨</span>

        <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">bucket_value</span><span class="o">&gt;</span> <span class="n">bucket_data</span><span class="p">;</span>
        <span class="c1">//å®šä¹‰åˆ—è¡¨è¿­ä»£å™¨</span>

        <span class="k">typedef</span> <span class="k">typename</span> <span class="n">bucket_data</span><span class="o">::</span><span class="n">iterator</span> <span class="n">bucket_iterator</span><span class="p">;</span>
        <span class="c1">//å®šä¹‰æ¡¶ä¸­çš„æ•°æ®åˆ—è¡¨</span>

        <span class="n">bucket_data</span> <span class="n">data</span><span class="p">;</span>
        <span class="c1">//æ¡¶çš„äº’æ–¥ä¿¡å·å˜é‡</span>

        <span class="k">mutable</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span> <span class="n">mutex</span><span class="p">;</span>
        <span class="c1">//é€šè¿‡å…³é”®å­—æŸ¥æ‰¾è¿­ä»£å™¨</span>

        <span class="n">bucket_iterator</span> <span class="n">find_entry_for</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="k">const</span>
        <span class="p">{</span>
            <span class="k">return</span>  <span class="n">std</span><span class="o">::</span><span class="n">find_if</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                <span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
                <span class="p">[</span><span class="o">&amp;</span><span class="p">](</span><span class="n">bucket_value</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">item</span><span class="p">){</span><span class="k">return</span> <span class="n">item</span><span class="p">.</span><span class="n">first</span><span class="o">==</span><span class="n">key</span><span class="p">;}</span>
                <span class="p">);</span>
        <span class="p">}</span>
    <span class="nl">public:</span>
        <span class="c1">//é€šè¿‡å¼•å…¥çš„æ–¹å¼ï¼ŒæŸ¥æ‰¾æ•°æ®</span>

        <span class="n">Value</span> <span class="n">value_for</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span><span class="n">Value</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">default_value</span><span class="p">)</span> <span class="k">const</span>
        <span class="p">{</span>
            <span class="n">boost</span><span class="o">::</span><span class="n">shared_lock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
            <span class="n">bucket_iterator</span> <span class="k">const</span> <span class="n">found_entry</span><span class="o">=</span><span class="n">find_entry_for</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="c1">//è¿”å›æŸ¥æ‰¾çš„å…³é”®å€¼</span>

            <span class="k">return</span> <span class="p">(</span><span class="n">found_entry</span><span class="o">==</span><span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="o">?</span><span class="n">default_value</span><span class="o">:</span><span class="n">found_entry</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//æ›´æ–°é”®å€¼å¯¹</span>

        <span class="kt">void</span> <span class="n">add_or_update_mapping</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span><span class="n">Value</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
            <span class="n">bucket_iterator</span> <span class="k">const</span> <span class="n">found_entry</span><span class="o">=</span><span class="n">find_entry_for</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">found_entry</span><span class="o">==</span><span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">data</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">bucket_value</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">));</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">found_entry</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">=</span><span class="n">value</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//ç§»é™¤å…³é”®å­—</span>

        <span class="kt">void</span> <span class="n">remove_mapping</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">shared_mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
            <span class="n">bucket_iterator</span> <span class="k">const</span> <span class="n">found_entry</span><span class="o">=</span><span class="n">find_entry_for</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="n">found_entry</span><span class="o">!=</span><span class="n">data</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
            <span class="p">{</span>
               <span class="n">data</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">found_entry</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>
    <span class="c1">//end define bucket_type</span>

    <span class="c1">//å®šä¹‰æŸ¥è¯¢çš„åŸºæœ¬æ¡¶å‘é‡å®¹å™¨</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">bucket_type</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">buckets</span><span class="p">;</span>
    <span class="c1">//hashæ˜ å°„è¡¨</span>

    <span class="n">Hash</span> <span class="n">hasher</span><span class="p">;</span>
    <span class="c1">//æ ¹æ®å…³é”®å­—æŸ¥æ‰¾æ¡¶</span>

    <span class="n">bucket_type</span><span class="o">&amp;</span> <span class="n">get_bucket</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="k">const</span> <span class="n">bucket_index</span><span class="o">=</span><span class="n">hasher</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">%</span><span class="n">buckets</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="k">return</span> <span class="o">*</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket_index</span><span class="p">];</span>
    <span class="p">}</span>
<span class="c1">//å…¬å…±çš„ç±»æ¥å£</span>

<span class="nl">public:</span>
    <span class="c1">//å®šä¹‰å…³é”®å­—ç±»å‹</span>

    <span class="k">typedef</span> <span class="n">Key</span> <span class="n">key_type</span><span class="p">;</span>
    <span class="c1">//å®šä¹‰æ˜ å°„çš„å€¼</span>

    <span class="k">typedef</span> <span class="n">Value</span> <span class="n">mapped_type</span><span class="p">;</span>
    <span class="c1">//å®šä¹‰hashå‡½æ•°</span>

    <span class="k">typedef</span> <span class="n">Hash</span> <span class="n">hash_type</span><span class="p">;</span>
    <span class="c1">//åŸºæœ¬çš„æ„é€ å‡½æ•°</span>

    <span class="n">threadsafe_lookup_table</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">num_buckets</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span>
                            <span class="n">Hash</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">hasher_</span><span class="o">=</span><span class="n">Hash</span><span class="p">())</span><span class="o">:</span>
                            <span class="n">buckets</span><span class="p">(</span><span class="n">num_buckets</span><span class="p">),</span>
                            <span class="n">hasher</span><span class="p">(</span><span class="n">hasher_</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">num_buckets</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">buckets</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">bucket_type</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">threadsafe_lookup_table</span><span class="p">(</span><span class="n">threadsafe_lookup_table</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">threadsafe_lookup_table</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">threadsafe_lookup_table</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="c1">//æ ¹æ®å…³é”®å­—æŸ¥æ‰¾å€¼</span>

    <span class="n">Value</span> <span class="n">value_for</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span>
                    <span class="n">Value</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">default_value</span><span class="o">=</span><span class="n">Value</span><span class="p">())</span> <span class="k">const</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="n">value_for</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">default_value</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kt">void</span> <span class="n">add_or_update_mapping</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span><span class="n">Value</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="n">add_or_update_mapping</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">remove_mapping</span><span class="p">(</span><span class="n">Key</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">get_bucket</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="n">remove_mapping</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h4 id="632--ç¼–å†™ä¸€ä¸ªä½¿ç”¨é”çš„çº¿ç¨‹å®‰å…¨é“¾è¡¨">6.3.2  ç¼–å†™ä¸€ä¸ªä½¿ç”¨é”çš„çº¿ç¨‹å®‰å…¨é“¾è¡¨</h4>

<p>é“¾è¡¨çš„åŸºæœ¬åŠŸèƒ½ï¼š</p>

<p>é“¾è¡¨çš„åŸºæœ¬æ“ä½œ</p>

<ul>
  <li>å‘åˆ—è¡¨æ·»åŠ ä¸€ä¸ªå…ƒç´ </li>
  <li>å½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶,å°±ä»é“¾è¡¨ä¸­åˆ é™¤æŸä¸ªå…ƒç´ </li>
  <li>å½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶,ä»é“¾è¡¨ä¸­æŸ¥æ‰¾æŸä¸ªå…ƒç´ </li>
  <li>å½“æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶,æ›´æ–°é“¾è¡¨ä¸­çš„æŸä¸ªå…ƒç´ </li>
  <li>å°†å½“å‰å®¹å™¨ä¸­é“¾è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ ,å¤åˆ¶åˆ°å¦ä¸€ä¸ªå®¹å™¨ä¸­</li>
</ul>

<p>çº¿ç¨‹å®‰å…¨çš„è¿­ä»£å™¨</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//å®šä¹‰æ¨¡æ¿ç±»</span>


<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">threadsafe_list</span>
<span class="p">{</span>
    <span class="c1">//é“¾è¡¨æ•°æ®èŠ‚ç‚¹</span>

    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">m</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">;</span>
        <span class="c1">//æ„é€ å‡½æ•°</span>

        <span class="n">node</span><span class="p">()</span><span class="o">:</span><span class="n">next</span><span class="p">(){}</span>
        <span class="c1">//æ•°å€¼æ„é€ å‡½æ•°</span>

        <span class="n">node</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)){}</span>
    <span class="p">};</span>
    <span class="c1">//å®šä¹‰å¤´éƒ¨èŠ‚ç‚¹</span>

    <span class="n">node</span> <span class="n">head</span><span class="p">;</span>
<span class="nl">public:</span>
        <span class="n">threadsafe_list</span><span class="p">(){}</span>
        <span class="o">~</span><span class="n">threadsafe_list</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">remove_if</span><span class="p">([](</span><span class="n">node</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">){</span><span class="k">return</span> <span class="nb">true</span><span class="p">;});</span>
        <span class="p">}</span>
        <span class="n">threadsafe_list</span><span class="p">(</span><span class="n">threadsafe_list</span> <span class="k">const</span><span class="o">&amp;</span>  <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
        <span class="n">threadsafe_list</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">threadsafe_list</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
        <span class="c1">//ä»å¤´éƒ¨æ’å…¥</span>

        <span class="kt">void</span> <span class="n">push_front</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//åˆ›å»ºæ–°èŠ‚ç‚¹</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">new_node</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
            <span class="c1">//å¤´éƒ¨èŠ‚ç‚¹åŠ é”</span>

            <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
            <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
            <span class="n">head</span><span class="p">.</span><span class="n">next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_node</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">//å®šä¹‰è¿­ä»£å‡½æ•°</span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Function</span><span class="p">&gt;</span>
        <span class="kt">void</span> <span class="n">for_each</span><span class="p">(</span><span class="n">Function</span> <span class="n">f</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">node</span><span class="o">*</span> <span class="n">current</span><span class="o">=&amp;</span><span class="n">head</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
            <span class="c1">//ä¾¿åˆ©é“¾è¡¨</span>

            <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">next</span><span class="o">=</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="c1">//ä¿æŠ¤ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ•°æ®</span>

                <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">next_lk</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
                <span class="c1">//ä¸Šä¸€ä¸ªèŠ‚ç‚¹è§£é”</span>

                <span class="n">lk</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="c1">//æ‰§è¡Œå‡½æ•°</span>

                <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
                <span class="c1">//æ›´æ”¹å½“å‰æŒ‡é’ˆ</span>

                <span class="n">current</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
                <span class="c1">//ç§»åŠ¨å¯¹è±¡</span>

                <span class="n">lk</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">next_lk</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//æŸ¥æ‰¾ä¸€ä¸ªæ¡ä»¶çš„å…ƒç´ </span>
        <span class="c1">//å®šä¹‰æŸ¥æ‰¾å…³é”®å‡½æ•°æ¨¡æ¿</span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Predicate</span><span class="p">&gt;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">find_first_if</span><span class="p">(</span><span class="n">Predicate</span> <span class="n">p</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">node</span><span class="o">*</span> <span class="n">current</span><span class="o">=&amp;</span><span class="n">head</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
            <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="k">const</span>   <span class="n">next</span><span class="o">=</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
            <span class="p">{</span>

                <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">next_lk</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
                <span class="n">lk</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="k">return</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">current</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
                <span class="n">lk</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">next_lk</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">//æŒ‰ç…§æ¡ä»¶åˆ é™¤å…ƒç´ </span>

        <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Predicate</span><span class="p">&gt;</span>
        <span class="kt">void</span> <span class="n">remove_if</span><span class="p">(</span><span class="n">Predicate</span> <span class="n">p</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">node</span><span class="o">*</span> <span class="n">current</span><span class="o">=&amp;</span><span class="n">head</span><span class="p">;</span>
            <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lk</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
            <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">next</span><span class="o">=</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">unique_lock</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">next_lk</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
                <span class="c1">//æ˜¯å¦ç¬¦åˆæŸ¥æ‰¾æ¡ä»¶</span>

                <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="o">*</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">node</span><span class="o">&gt;</span> <span class="n">old_next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
                    <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
                    <span class="n">next_lk</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="c1">//è§£é”ä¸‹ä¸€ä¸ª</span>

                    <span class="n">lk</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>
                    <span class="c1">//ç§»åŠ¨å½“å‰æŒ‡é’ˆ</span>

                    <span class="n">current</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
                    <span class="c1">//ç§»åŠ¨ä¸‹ä¸€ä¸ªé”</span>

                    <span class="n">lk</span><span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">next_lk</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h2 id="ç¬¬7ç« --æ— é”å¹¶å‘æ•°æ®ç»“æ„è®¾è®¡">ç¬¬7ç«   æ— é”å¹¶å‘æ•°æ®ç»“æ„è®¾è®¡</h2>

<h3 id="71-å®šä¹‰å’Œæ„ä¹‰">7.1 å®šä¹‰å’Œæ„ä¹‰</h3>

<p>ä½¿ç”¨äº’æ–¥é‡ã€æ¡ä»¶å˜é‡,ä»¥åŠâ€œæœŸæœ›â€æ¥åŒæ­¥é˜»å¡æ•°æ®çš„ç®—æ³•å’Œæ•°æ®ç»“æ„ã€‚</p>

<p><strong>æ— é”æ•°æ®ç»“æ„</strong>ï¼šä½œä¸ºæ— é”ç»“æ„,å°±æ„å‘³ç€çº¿ç¨‹å¯ä»¥å¹¶å‘çš„è®¿é—®è¿™ä¸ªæ•°æ®ç»“æ„ã€‚ä½†æ˜¯ä¸€èˆ¬ï¼Œè¿™æ ·çš„çº¿ç¨‹ä¸èƒ½åšç›¸åŒçš„æ“ä½œï¼Œå¹¶ä¸”åœ¨æ— é”ç®—æ³•ä¸­çš„å¾ªç¯ä¼šè®©ä¸€äº›çº¿ç¨‹å¤„äºâ€é¥¥é¥¿â€çŠ¶æ€ã€‚
<strong>æ— ç­‰å¾…æ•°æ®ç»“æ„</strong>ï¼šé¦–å…ˆ,æ˜¯æ— é”æ•°æ®ç»“æ„;å¹¶ä¸”,æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½åœ¨æœ‰é™çš„æ­¥æ•°å†…å®Œæˆæ“ä½œ,æš‚ä¸”ä¸ç®¡å…¶ä»–çº¿ç¨‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<p><strong>æ´»é”</strong>ï¼šæ´»é”çš„äº§ç”Ÿæ˜¯,ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å°è¯•ä¿®æ”¹æ•°æ®ç»“æ„,ä½†æ¯ä¸ªçº¿ç¨‹æ‰€åšçš„ä¿®æ”¹æ“ä½œéƒ½ä¼šè®©å¦ä¸€ä¸ªçº¿ç¨‹é‡å¯,æ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹å°±ä¼šé™·å…¥å¾ªç¯,å¤šæ¬¡çš„å°è¯•å®Œæˆè‡ªå·±çš„æ“ä½œã€‚</p>

<p>è¿™å°±æ˜¯â€œæ— é”-æ— ç­‰å¾…â€ä»£ç çš„ç¼ºç‚¹:è™½ç„¶æé«˜äº†å¹¶å‘è®¿é—®çš„èƒ½åŠ›,å‡å°‘äº†å•ä¸ªçº¿ç¨‹çš„ç­‰å¾…æ—¶é—´,ä½†æ˜¯å…¶å¯èƒ½ä¼šå°†æ•´ä½“æ€§èƒ½æ‹‰ä½ã€‚</p>

<h3 id="72-æ— é”æ•°æ®ç»“æ„çš„ä¾‹å­">7.2 æ— é”æ•°æ®ç»“æ„çš„ä¾‹å­</h3>

<p>ä¸€ä¸ªç®€å•çš„çº¿ç¨‹å®‰å…¨æ ˆç»“æ„</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">lock_free_stack</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="c1">//è·å–æŒ‡é’ˆæ•°æ®</span>

        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">node</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data_</span><span class="p">)</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data_</span><span class="p">)){}</span>

    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">node</span><span class="o">*&gt;</span> <span class="n">head</span><span class="p">;</span>

<span class="nl">public:</span>
    <span class="n">lock_free_stack</span><span class="p">();</span>
    <span class="o">~</span><span class="n">lock_free_stack</span><span class="p">();</span>
    <span class="c1">//pushå‡½æ•°</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">new_node</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="c1">//åŠ è½½æ•°æ®</span>

        <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="c1">//ç”¨åŸå­æ“ä½œæ›¿æ¢èŠ‚ç‚¹</span>

        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">new_node</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">result</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="c1">//ä½¿ç”¨åŸå­æ“ä½œæ›¿æ¢èŠ‚ç‚¹</span>

        <span class="k">while</span><span class="p">(</span><span class="n">old_head</span><span class="o">&amp;&amp;!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">old_head</span><span class="p">,</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
        <span class="c1">//è¿”å›æŒ‡é’ˆå€¼</span>

        <span class="k">return</span> <span class="n">old_head</span><span class="o">?</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">:</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="p">}</span>
    
<span class="p">};</span>

</code></pre></div></div>

<h4 id="722-åœæ­¢å†…å­˜æ³„éœ²ä½¿ç”¨æ— é”æ•°æ®ç»“æ„ç®¡ç†å†…å­˜">7.2.2 åœæ­¢å†…å­˜æ³„éœ²ï¼šä½¿ç”¨æ— é”æ•°æ®ç»“æ„ç®¡ç†å†…å­˜</h4>

<p>å¯ä»¥æ·»åŠ åŸå­å˜é‡è®©æ ˆå˜ä¸ºçº¿ç¨‹å®‰å…¨çš„æ ˆ,åŒæ—¶æ·»åŠ å¼•ç”¨è®¡æ•°ï¼Œå¸®åŠ©</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">lock_free_stack</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">//åŸå­å˜é‡</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span> <span class="n">threads_in_pop</span><span class="p">;</span>
    <span class="kt">void</span> <span class="n">try_reclaim</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">old_head</span><span class="p">);</span>
<span class="nl">public:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//åœ¨åšäº‹ä¹‹å‰,è®¡æ•°å€¼åŠ 1</span>

        <span class="o">++</span><span class="n">threads_in_pop</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="k">while</span><span class="p">(</span><span class="n">old_head</span><span class="o">&amp;&amp;!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">old_head</span><span class="p">,</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="n">res</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">old_head</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//å›æ”¶åˆ é™¤çš„èŠ‚ç‚¹</span>

            <span class="n">res</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>       
        <span class="p">}</span>
        <span class="c1">//ä»èŠ‚ç‚¹ä¸­ç›´æ¥æå–æ•°æ®,è€Œéæ‹·è´æŒ‡é’ˆ</span>

        <span class="n">try_reclaim</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
        <span class="k">return</span>  <span class="n">res</span><span class="p">;</span>
        <span class="p">}</span>

<span class="p">}</span>

</code></pre></div></div>

<p><strong>é‡‡ç”¨å¼•ç”¨è®¡æ•°çš„å›æ”¶æœºåˆ¶</strong></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">lock_free_stack</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="c1">//å³å°†è¢«åˆ é™¤çš„æ•°</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">node</span><span class="o">*&gt;</span>  <span class="n">to_be_deleted</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">void</span> <span class="n">delete_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">*</span>  <span class="n">nodes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="o">=</span><span class="n">nodes</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="k">delete</span> <span class="n">nodes</span><span class="p">;</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="c1">//åˆ é™¤å¤´éƒ¨èŠ‚ç‚¹</span>

    <span class="kt">void</span> <span class="n">try_reclaim</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">old_head</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//æ˜¯å¦ä¸ºç¬¬ä¸€æ¬¡åˆ é™¤</span>

        <span class="k">if</span><span class="p">(</span><span class="n">threads_in_pop</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">//å£°æ˜ â€œå¯åˆ é™¤â€åˆ—è¡¨</span>

            <span class="n">node</span><span class="o">*</span> <span class="n">nodes_to_delete</span><span class="o">=</span><span class="n">to_be_deleted</span><span class="p">.</span><span class="n">exchange</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
            <span class="c1">//æ˜¯å¦åªæœ‰ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨pop</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!--</span><span class="n">threads_in_pop</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">delete_nodes</span><span class="p">(</span><span class="n">nodes_to_delete</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">nodes_to_delete</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">chain_pending_nodes</span><span class="p">(</span><span class="n">nodes_to_delete</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="c1">//åˆ é™¤èŠ‚ç‚¹</span>

            <span class="k">delete</span> <span class="n">old_head</span><span class="p">;</span>

        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">chain_pending_nodes</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
            <span class="o">--</span><span class="n">threads_in_pop</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">chain_pending_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">nodes</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">last</span><span class="o">=</span><span class="n">nodes</span><span class="p">;</span>
        <span class="c1">//è®©nextæŒ‡é’ˆæŒ‡å‘é“¾è¡¨çš„æœ«å°¾</span>

        <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">next</span><span class="o">=</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">last</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">chain_pending_nodes</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span><span class="n">last</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">chain_pending_nodes</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">first</span><span class="p">,</span><span class="n">node</span><span class="o">*</span> <span class="n">last</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//lastæ ‡è®°ä¸ºå³å°†åˆ é™¤</span>

        <span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">to_be_deleted</span><span class="p">;</span>
        <span class="c1">//ç”¨å¾ªç¯æ¥ä¿è¯last-&gt;nextçš„æ­£ç¡®æ€§</span>

        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">to_be_deleted</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">first</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">chain_pending_node</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">n</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">chain_pending_nodes</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>

<h3 id="723-æ£€æµ‹ä½¿ç”¨é£é™©æŒ‡é’ˆä¸å¯å›æ”¶çš„èŠ‚ç‚¹">7.2.3 æ£€æµ‹ä½¿ç”¨é£é™©æŒ‡é’ˆ(ä¸å¯å›æ”¶)çš„èŠ‚ç‚¹</h3>

<p><strong>é£é™©æŒ‡é’ˆ</strong> :å½“æœ‰çº¿ç¨‹å»è®¿é—®è¦è¢«(å…¶ä»–çº¿ç¨‹)åˆ é™¤çš„å¯¹è±¡æ—¶,ä¼šå…ˆè®¾ç½®å¯¹è¿™ä¸ªå¯¹è±¡è®¾ç½®ä¸€ä¸ªé£é™©æŒ‡é’ˆ,è€Œåé€šçŸ¥å…¶ä»–çº¿ç¨‹,åˆ é™¤è¿™ä¸ªæŒ‡é’ˆæ˜¯ä¸€ä¸ªå±é™©çš„è¡Œä¸ºã€‚ä¸€æ—¦è¿™ä¸ªå¯¹è±¡ä¸å†è¢«éœ€è¦,é‚£ä¹ˆå°±å¯ä»¥æ¸…é™¤é£é™©æŒ‡é’ˆäº†ã€‚</p>

<p>åˆ©ç”¨é£é™©æŒ‡é’ˆå®ç°popæ“ä½œ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//è·å–é£é™©æŒ‡é’ˆ</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;&amp;</span> <span class="n">hp</span><span class="o">=</span><span class="n">get_hazard_pointer_for_current_thread</span><span class="p">();</span>
    <span class="n">node</span><span class="o">*</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
    <span class="c1">//æ¯”è¾ƒäº¤æ¢æ“ä½œå¤±è´¥ï¼Œåˆ™é‡ç½®æ“ä½œ1</span>

    <span class="k">do</span>
    <span class="p">{</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">temp</span><span class="p">;</span>
        <span class="c1">//  1   ç›´åˆ°å°†é£é™©æŒ‡é’ˆè®¾ä¸ºheadæŒ‡é’ˆ</span>

        <span class="k">do</span>
        <span class="p">{</span>
            <span class="n">temp</span><span class="o">=</span><span class="n">old_head</span><span class="p">;</span>
            <span class="n">hp</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
            <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">old_head</span><span class="o">!=</span><span class="n">temp</span><span class="p">);</span>
    <span class="c1">//æ£€æŸ¥head==old_head?head=old_head-&gt;next:head=old_head;</span>

    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">old_head</span><span class="o">&amp;&amp;!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">old_head</span><span class="p">,</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">));</span>
    <span class="c1">//  2   å½“å£°æ˜å®Œæˆ,æ¸…é™¤é£é™©æŒ‡é’ˆ</span>

    <span class="n">hp</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">old_head</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">res</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="c1">//  3   åœ¨åˆ é™¤ä¹‹å‰å¯¹é£é™©æŒ‡é’ˆå¼•ç”¨çš„èŠ‚ç‚¹è¿›è¡Œæ£€æŸ¥</span>

        <span class="k">if</span><span class="p">(</span><span class="n">outstanding_hazard_pointers_for</span><span class="p">(</span><span class="n">old_head</span><span class="p">))</span>       
        <span class="p">{</span>
            <span class="c1">//å°†å…¶æ”¾åœ¨é“¾è¡¨ä¸­ï¼Œä¹‹åè¿›è¡Œå›æ”¶</span>

            <span class="n">reclaim_later</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">delete</span>  <span class="n">old_head</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//æ£€æŸ¥å¹¶åˆ é™¤é£é™©èŠ‚ç‚¹</span>

        <span class="n">delete_nodes_with_no_hazards</span><span class="p">();</span>
    <span class="p">}</span>
        <span class="k">return</span>  <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


</code></pre></div></div>

<p>get_hazard_pointer_for_current_thread()å‡½æ•°çš„ç®€å•å®ç°</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">unsigned</span> <span class="k">const</span> <span class="n">max_hazard_pointers</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span>

<span class="k">struct</span> <span class="nc">hazard_pointer</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span> <span class="n">pointer</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">//å¼‚å¸¸èŠ‚ç‚¹æ•°ç»„</span>

<span class="n">hazard_pointer</span> <span class="n">hazard_pointers</span><span class="p">[</span><span class="n">max_hazard_pointers</span><span class="p">];</span>

<span class="k">class</span> <span class="nc">hp_owner</span>
<span class="p">{</span>
    <span class="n">hazard_pointer</span><span class="o">*</span> <span class="n">hp</span><span class="p">;</span>
<span class="nl">public:</span>
    <span class="n">hp_owner</span><span class="p">(</span><span class="n">hp_owner</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">hp_owner</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">hp_owner</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">hp_owner</span><span class="p">()</span><span class="o">:</span><span class="n">hp</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">max_hazard_pointers</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span> <span class="n">old_id</span><span class="p">;</span>
            <span class="c1">//æ£€æŸ¥old_idæ˜¯å¦å«æœ‰hazard_pointersä¸­çš„å¼‚å¸¸æŒ‡é’ˆ</span>

            <span class="k">if</span><span class="p">(</span><span class="n">hazard_pointers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">old_id</span><span class="p">.</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">get_id</span><span class="p">()))</span>
            <span class="p">{</span>
                <span class="c1">//å¦‚æœå«æœ‰åˆ™hpæŒ‡å‘è¯¥å¼‚å¸¸æŒ‡é’ˆï¼Œ</span>

                <span class="n">hp</span><span class="o">=&amp;</span><span class="n">hazard_pointers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">//å¦‚æœä¸å«æœ‰é£é™©æŒ‡é’ˆå°±æŠ›å‡ºå¼‚å¸¸</span>
        
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">"No hazard pointer available"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">void</span> <span class="o">*&gt;&amp;</span><span class="n">get_pointer</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">~</span><span class="n">hp_owner</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">hp</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
        <span class="n">hp</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span><span class="p">());</span>
    <span class="p">}</span>

<span class="p">};</span>
<span class="c1">//è·å–å½“å‰çš„é£é™©æŒ‡é’ˆ</span>

<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">void</span> <span class="o">*&gt;&amp;</span> <span class="n">get_hazard_pointer_for_current_thread</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„é£é™©æŒ‡é’ˆ</span>

    <span class="k">thread_local</span> <span class="k">static</span> <span class="n">hp_owner</span> <span class="n">hazard</span><span class="p">;</span>
    <span class="c1">//è·å–æŒ‡é’ˆæ•°ç›®</span>

    <span class="k">return</span> <span class="n">hazard</span><span class="p">.</span><span class="n">get_pointer</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">//æœç´¢é£é™©è¡¨ï¼ŒæŸ¥æ‰¾å¯¹åº”è®°å½•</span>

<span class="kt">bool</span> <span class="nf">outstanding_hazard_pointers_for</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">max_hazard_pointers</span><span class="p">;</span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">hazard_pointers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pointer</span><span class="p">.</span><span class="n">load</span><span class="p">()</span><span class="o">==</span><span class="n">p</span><span class="p">){</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="c1">//é£é™©æŒ‡é’ˆçš„å›æ”¶å‡½æ•°</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">do_delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">delete</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//åˆ é™¤ç¼“å†²é˜Ÿåˆ—</span>

<span class="k">struct</span> <span class="nc">data_to_reclaim</span>
<span class="p">{</span>
    <span class="kt">void</span><span class="o">*</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">Function</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="p">)</span><span class="o">&gt;</span> <span class="n">deleter</span><span class="p">;</span>
    <span class="n">data_to_reclaim</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
    <span class="c1">//åˆ é™¤ç¼“å†²é“¾ä¸­å…ƒç´ </span>

    <span class="n">data_to_reclaim</span><span class="p">(</span><span class="n">T</span><span class="o">*</span> <span class="n">p</span><span class="p">)</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="n">deleter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">do_delete</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">),</span><span class="n">next</span><span class="p">(</span><span class="mi">0</span><span class="p">){}</span>
    <span class="o">~</span><span class="n">data_to_reclaim</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">deleter</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>
<span class="c1">//å®šä¹‰é‡Šæ”¾èŠ‚ç‚¹</span>

<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">data_to_reclaim</span><span class="o">*&gt;</span> <span class="n">nodes_to_reclaim</span><span class="p">;</span>
<span class="c1">//å¤´æ’æ³•å°†æ•°æ®æ’å…¥</span>

<span class="kt">void</span> <span class="nf">add_to_reclaim_list</span><span class="p">(</span><span class="n">data_to_reclaim</span><span class="o">*</span> <span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//æŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ª</span>

    <span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">nodes_to_reclaim</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
    <span class="c1">//å°†æ•°æ®èŠ‚ç‚¹ä¸headç›¸äº¤æ¢ï¼Œå› æ­¤æœ€ç»ˆæ’å…¥åˆ°å¤´ç»“ç‚¹ä¹‹å</span>

    <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">nodes_to_reclaim</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">node</span><span class="p">));</span>   
<span class="p">}</span>
<span class="c1">//åˆ›å»ºç›¸å…³å®ä¾‹ï¼Œå°†æ•°æ®æ·»åŠ åˆ°å¾…åˆ é™¤é˜Ÿåˆ—</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">reclaim_later</span><span class="p">(</span><span class="n">T</span><span class="o">*</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">add_to_reclaim_list</span><span class="p">(</span><span class="k">new</span> <span class="n">data_to_reclaim</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">//åˆ é™¤ç›¸å…³æŒ‡é’ˆï¼Œå°†å·²ç»å£°æ˜çš„é“¾è¡¨èŠ‚ç‚¹è¿›è¡Œå›æ”¶</span>

<span class="kt">void</span> <span class="nf">delete_nodes_with_no_hazards</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">data_to_reclaim</span><span class="o">*</span> <span class="n">current</span><span class="o">=</span><span class="n">nodes_to_reclaim</span><span class="p">.</span><span class="n">exchange</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
    <span class="c1">//å½“èŠ‚ç‚¹ä¸ä¸ºç©ºçš„æ—¶å€™</span>

    <span class="k">while</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">data_to_reclaim</span><span class="o">*</span> <span class="k">const</span> <span class="n">next</span><span class="o">=</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
        <span class="c1">//åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦å±äºé£é™©æŒ‡é’ˆ</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">outstanding_hazard_pointers_for</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">//æ²¡æœ‰æŒ‡é’ˆå°±å®‰å…¨åˆ é™¤</span>

            <span class="k">delete</span> <span class="n">current</span><span class="p">;</span>

        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="c1">//æ˜¯é£é™©æŒ‡é’ˆå°±æŠŠèŠ‚ç‚¹æ·»åŠ åˆ°é“¾è¡¨çš„åé¢ï¼Œå†ç»Ÿä¸€åˆ é™¤</span>

            <span class="n">add_to_reclaim_list</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">current</span><span class="o">=</span><span class="n">next</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">}</span>


</code></pre></div></div>

<h4 id="724-æ£€æµ‹ä½¿ç”¨å¼•ç”¨è®¡æ•°çš„èŠ‚ç‚¹">7.2.4 æ£€æµ‹ä½¿ç”¨å¼•ç”¨è®¡æ•°çš„èŠ‚ç‚¹</h4>

<p>é€šè¿‡å¢åŠ å¤–éƒ¨å¼•ç”¨è®¡æ•°,ä¿è¯æŒ‡é’ˆåœ¨è®¿é—®æœŸé—´çš„åˆæ³•æ€§ã€‚</p>

<p>åˆ†ç¦»è®¡æ•°æ–¹å¼çš„æ— é”æ ˆ</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">lock_free_stack</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span><span class="p">;</span>
    <span class="c1">//æŒ‡å‘ä¸‹ä¸€ä¸ªæŒ‡é’ˆçš„èŠ‚ç‚¹</span>

    <span class="k">struct</span> <span class="nc">counted_node_ptr</span>
    <span class="p">{</span>
        <span class="c1">//å¤–éƒ¨å¼•ç”¨è®¡æ•°</span>

        <span class="kt">int</span> <span class="n">external_count</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="c1">//èŠ‚ç‚¹çš„å†…éƒ¨å¼•ç”¨è®¡æ•°</span>

        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">internal_count</span><span class="p">;</span>
        <span class="c1">//ä¸‹ä¸€ä¸ªæŒ‡é’ˆèŠ‚ç‚¹</span>

        <span class="n">counted_node_ptr</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">node</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span><span class="o">:</span><span class="n">data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data_</span><span class="p">)),</span><span class="n">internal_count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>

        <span class="p">}</span>
    <span class="p">};</span>
    <span class="c1">//å¤´éƒ¨èŠ‚ç‚¹ï¼Œå®ƒåªæœ‰å¼•ç”¨æŒ‡é’ˆå’Œè®¡æ•°ï¼Œæ•°æ®ç›´æ¥æ˜¯node</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">counted_node_ptr</span><span class="o">&gt;</span> <span class="n">head</span><span class="p">;</span>
    <span class="c1">//å¢åŠ å¤´éƒ¨çš„å¼•ç”¨è®¡æ•°</span>

    <span class="kt">void</span> <span class="n">increase_head_count</span><span class="p">(</span><span class="n">counted_node_ptr</span><span class="o">&amp;</span> <span class="n">old_counter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//åˆ›å»ºæ–°çš„è®¡æ•°æŒ‡é’ˆ</span>

        <span class="n">counted_node_ptr</span> <span class="n">new_counter</span><span class="p">;</span>
        <span class="k">do</span><span class="p">{</span>
            <span class="c1">//new_counteræŒ‡å‘æ–°çš„æŒ‡é’ˆ</span>

            <span class="n">new_counter</span><span class="o">=</span><span class="n">old_counter</span><span class="p">;</span>
            <span class="c1">//å¢åŠ å¤–éƒ¨å¼•ç”¨è®¡æ•°</span>

            <span class="o">++</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_count</span><span class="p">;</span>
            <span class="c1">//å¾ªç¯ç›´åˆ°ï¼Œold_counteræŒ‡å‘å¤´éƒ¨ï¼ŒheadæŒ‡å‘new_counter;</span>

        <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">old_counter</span><span class="p">,</span><span class="n">new_counter</span><span class="p">));</span>
        <span class="c1">//ä¿®æ”¹æŒ‡é’ˆçš„å¤–éƒ¨å¼•ç”¨æ¬¡æ•°ï¼Œæ¯è¢«å¼•ç”¨ä¸€æ¬¡ï¼Œè®¡æ•°+1</span>

        <span class="n">old_counter</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_count</span><span class="p">;</span>

    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="o">~</span><span class="n">lock_free_stack</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">pop</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="c1">//æ·»åŠ å‡½æ•°</span>

    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//æ–°çš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆ</span>

        <span class="n">counted_node_ptr</span> <span class="n">new_node</span><span class="p">;</span>
        <span class="n">new_node</span><span class="p">.</span><span class="n">ptr</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="n">new_node</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="c1">//æ–°èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘,old head</span>

        <span class="n">new_node</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="c1">//ä¾¿åˆ©æŒ‡é’ˆï¼Œç›´åˆ°new_node.ptrçš„ä¸‹ä¸€ä¸ªæŒ‡é’ˆæ˜¯head;å³ç°åœ¨æœ€å‰é¢çš„æŒ‡é’ˆæ˜¯new_node,å°†headæŒ‡é’ˆæŒ‡å‘new_node;</span>

        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">new_node</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">new_node</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="c1">//popå¼¹å‡ºå‡½æ•°</span>

    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">counted_node_ptr</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">increase_head_count</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
            <span class="c1">//è·å–å¤´éƒ¨æ•°æ®æŒ‡é’ˆ</span>

            <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">ptr</span><span class="o">=</span><span class="n">old_head</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
            <span class="c1">//å¦‚æœæ˜¯ä¸€ä¸ªç©ºæŒ‡é’ˆ</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="c1">//å°†headæŒ‡é’ˆåç§»</span>

            <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">old_head</span><span class="p">,</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">//è¿”å›æŒ‡é’ˆæ•°æ®</span>

                <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">;</span>

                <span class="n">res</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
                <span class="c1">//å–å‡ºèŠ‚ç‚¹åï¼Œå¤´éƒ¨èŠ‚ç‚¹çš„å¼•ç”¨è®¡æ•°-2</span>

                <span class="kt">int</span> <span class="k">const</span> <span class="n">count_increase</span><span class="o">=</span><span class="n">old_head</span><span class="p">.</span><span class="n">external_count</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
                <span class="c1">//å¦‚æœç°åœ¨çš„å†…éƒ¨å¼•ç”¨è®¡æ•°ä¸º0</span>

                <span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">internal_count</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="n">count_increase</span><span class="p">)</span><span class="o">==-</span><span class="n">count_increase</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="c1">//ç›´æ¥åˆ é™¤æŒ‡é’ˆ</span>

                    <span class="k">delete</span> <span class="n">ptr</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
                <span class="c1">//å¦‚æœæŒ‡é’ˆçš„å†…éƒ¨å¼•ç”¨è®¡æ•°ä¸º2</span>

            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">internal_count</span><span class="p">.</span><span class="n">fetch_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">){</span>
                <span class="c1">//åˆ é™¤æŒ‡é’ˆ</span>

                <span class="k">delete</span> <span class="n">ptr</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="p">};</span>

</code></pre></div></div>

<h4 id="725-åº”ç”¨äºæ— é”æ ˆä¸Šçš„å†…å­˜æ¨¡å‹">7.2.5 åº”ç”¨äºæ— é”æ ˆä¸Šçš„å†…å­˜æ¨¡å‹</h4>

<p>å¯¹äºä¸åŒçš„å¤šçº¿ç¨‹ç›¸äº’æ•°æ®ï¼Œåœ¨ä¿®æ”¹å†…å­˜ä¹‹å‰ï¼Œéœ€è¦æ£€æŸ¥ä¸€ä¸‹æ“ä½œä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ç„¶åå†å»ç¡®å®šé€‚åˆè¿™ç§éœ€æ±‚å…³ç³»çš„æœ€å°å†…å­˜ã€‚</p>

<p>å¯¹äºpushæ“ä½œï¼Œæ¥å—æ•°æ®ä¹‹åï¼Œå…ˆæ„é€ èŠ‚ç‚¹ï¼Œå†æ’å…¥é˜Ÿåˆ—â€“è®¾ç½®head,å› æ­¤pushä¸­çš„å”¯ä¸€åŸå­æ“ä½œå°±æ˜¯<code class="language-plaintext highlighter-rouge">compare_exchange_weak()</code>å‡½æ•°ï¼Œå¯¹äºåŒpush()æ“ä½œæ²¡æœ‰å¿…è¦è€ƒè™‘ï¼Œå®ƒéœ€è¦å’Œpop()ä¹‹ä¸­çš„<code class="language-plaintext highlighter-rouge">head.compare_exchange_strong</code>æœ‰ä¸¥æ ¼çš„å†…å­˜é¡ºåºã€‚</p>

<p>å¯¹äºpop()æ“ä½œï¼Œå¿…é¡»åœ¨è®¿é—®<code class="language-plaintext highlighter-rouge">next</code>å€¼ä¹‹å‰ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::memory_order_acquire</code>æˆ–è€…æ›´åŠ ä¸¥æ ¼çš„å†…å­˜æ“ä½œé¡ºåºï¼Œä¿è¯<code class="language-plaintext highlighter-rouge">next</code>æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¸è¢«æ”¹å˜ã€‚å› ä¸ºåœ¨<code class="language-plaintext highlighter-rouge">increase_head_count()</code>ä¸­ä½¿ç”¨<code class="language-plaintext highlighter-rouge">compare_exchange_strong()</code>å°±è·å–<code class="language-plaintext highlighter-rouge">next</code>æŒ‡é’ˆæŒ‡å‘çš„æ—§å€¼ã€‚å› æ­¤åœ¨äº¤æ¢æˆåŠŸçš„æ—¶å€™å¿…é¡»ä½¿ç”¨ä¸¥æ ¼å†…å­˜åºï¼Œä½†æ˜¯å½“äº¤æ¢å¤±è´¥æ—¶ï¼Œå› ä¸ºåªæ¶‰åŠåˆ°å†…éƒ¨æ“ä½œï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨æ¾æ•£å†…å­˜åºã€‚ç„¶åå¾ªç¯ç›´åˆ°äº¤æ¢æˆåŠŸã€‚</p>

<p>åŸºäºå¼•ç”¨è®¡æ•°å’Œæ¾æ•£åŸå­æ“ä½œçš„æ— é”çº¿ç¨‹</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">lock_free_stack</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span><span class="p">;</span>
    <span class="k">struct</span> <span class="nc">counted_node_ptr</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">external_count</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span>   <span class="n">ptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">struct</span>  <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">node</span><span class="p">(</span><span class="n">T</span>  <span class="k">const</span><span class="o">&amp;</span>  <span class="n">data_</span><span class="p">)</span><span class="o">:</span>
        <span class="n">data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data_</span><span class="p">)),</span>
                        <span class="n">internal_count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="p">{}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="n">data</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span>    <span class="n">internal_count</span><span class="p">;</span>
        <span class="n">counted_node_ptr</span>    <span class="n">next</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">counted_node_ptr</span><span class="o">&gt;</span>   <span class="n">head</span><span class="p">;</span>

    <span class="kt">void</span> <span class="n">increase_head_count</span><span class="p">(</span><span class="n">counted_node_ptr</span><span class="o">&amp;</span> <span class="n">old_counter</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">counted_node_ptr</span> <span class="n">new_counter</span><span class="p">;</span>
        <span class="k">do</span>
        <span class="p">{</span>
            <span class="n">new_counter</span><span class="o">=</span><span class="n">old_counter</span><span class="p">;</span>
            <span class="o">++</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_count</span><span class="p">;</span>
        <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
            <span class="n">old_counter</span><span class="p">,</span>
            <span class="n">new_counter</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span>
            <span class="p">));</span>
        <span class="n">old_counter</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_count</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="o">~</span><span class="n">lock_free_stack</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">pop</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">counted_node_ptr</span> <span class="n">new_node</span><span class="p">;</span>
        <span class="n">new_node</span><span class="p">.</span><span class="n">ptr</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
        <span class="n">new_node</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="c1">//åŠ è½½headæ•°æ®</span>

        <span class="n">new_node</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">)</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span>
            <span class="n">new_node</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span>
            <span class="n">new_node</span><span class="p">,</span>
            <span class="c1">//è¿™é‡Œå¿…é¡»è¦å’Œincrease_head_countçš„compare_exchange_strongä¸­æˆåŠŸæ—¶æœ‰åº</span>

            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span>
            <span class="p">));</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//åŠ è½½å¤´éƒ¨æŒ‡é’ˆï¼Œå› ä¸ºè¿™é‡Œçš„è½½å…¥æ²¡æœ‰å¼ºåˆ¶çš„ç«äº‰è¡Œä¸ºï¼Œæ‰€ä»¥å¯ä»¥æ˜¯relaxedçš„</span>

        <span class="n">counted_node_ptr</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="n">increase_head_count</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
            <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">ptr</span><span class="o">=</span><span class="n">old_head</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">old_head</span><span class="p">,</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">res</span><span class="p">;</span>
                <span class="n">res</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
                <span class="kt">int</span> <span class="k">const</span> <span class="n">count_increase</span><span class="o">=</span><span class="n">old_head</span><span class="p">.</span><span class="n">external_count</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">internal_count</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="n">count_increase</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">)</span><span class="o">==-</span><span class="n">count_increase</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">delete</span> <span class="n">ptr</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span>
                <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">internal_count</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">internal_count</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">);</span>
                <span class="k">delete</span> <span class="n">ptr</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>

<span class="p">};</span>

</code></pre></div></div>

<h4 id="726-å†™ä¸€ä¸ªæ— é”çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—">7.2.6 å†™ä¸€ä¸ªæ— é”çš„çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—</h4>

<p>å…ˆçœ‹ä¸€ä¸ªç®€å•çš„ç”Ÿäº§è€…/å•æ¶ˆè´¹è€…æ¨¡å‹ä¸‹çš„æ— é”é˜Ÿåˆ—</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span>   <span class="nc">lock_free_queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="n">data</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">node</span><span class="p">()</span><span class="o">:</span><span class="n">next</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)</span>
        <span class="p">{}</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">node</span><span class="o">*&gt;</span>  <span class="n">head</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">node</span><span class="o">*&gt;</span>  <span class="n">tail</span><span class="p">;</span>
    <span class="n">node</span><span class="o">*</span> <span class="n">pop_head</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="n">old_head</span><span class="o">==</span><span class="n">tail</span><span class="p">.</span><span class="n">load</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="k">return</span>  <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">head</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
        <span class="k">return</span>  <span class="n">old_head</span><span class="p">;</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="n">lock_free_queue</span><span class="p">()</span><span class="o">:</span><span class="n">head</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="p">),</span><span class="n">tail</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">())</span>
    <span class="p">{}</span>
    <span class="n">lock_free_queue</span><span class="p">(</span><span class="k">const</span> <span class="n">lock_free_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="n">lock_free_queue</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">lock_free_queue</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span><span class="o">=</span><span class="k">delete</span><span class="p">;</span>
    <span class="o">~</span><span class="n">lock_free_queue</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">while</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">head</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
            <span class="k">delete</span>  <span class="n">old_head</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//è·å–å¤´èŠ‚ç‚¹</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">old_head</span><span class="o">=</span><span class="n">pop_head</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">old_head</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span>  <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="c1">//è·å–å¤´éƒ¨æ•°æ®</span>

        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="k">const</span> <span class="n">res</span><span class="p">(</span><span class="n">old_head</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="k">delete</span> <span class="n">old_head</span><span class="p">;</span>
        <span class="c1">//è¿”å›å¤´éƒ¨æ•°æ®</span>

        <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>  <span class="n">new_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">new_value</span><span class="p">));</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">p</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">;</span>
        <span class="c1">//è·å–å°¾éƒ¨èŠ‚ç‚¹</span>

        <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">old_tail</span><span class="o">=</span><span class="n">tail</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="c1">//å°†å°¾éƒ¨æ•°æ®å’Œæ–°æŒ‡é’ˆäº¤æ¢</span>

        <span class="n">old_tail</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">swap</span><span class="p">(</span><span class="n">new_data</span><span class="p">);</span>
        <span class="c1">//æ›´æ¢å°¾éƒ¨æ•°æ®</span>
        <span class="n">old_tail</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>
        <span class="c1">//å°¾æŒ‡é’ˆå­˜å‚¨p</span>

        <span class="n">tail</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<p>å¯¹äºçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—è€Œè¨€ï¼Œéœ€è¦æ³¨æ„çš„åœ°æ–¹æ˜¯åœ¨å°¾éƒ¨èŠ‚ç‚¹æ’å…¥çš„åœ°æ–¹å’Œå¤´éƒ¨èŠ‚ç‚¹åˆ é™¤çš„åœ°æ–¹ï¼Œå¯ä»¥å€Ÿé‰´å†…å¤–éƒ¨çš„å¼•ç”¨è®¡æ•°çš„æ–¹æ³•ï¼Œåœ¨åˆ é™¤å’Œæ·»åŠ æ“ä½œä¸­ï¼Œä½¿ç”¨åŸå­æ“ä½œï¼Œé¿å…çº¿ç¨‹ä¹‹é—´çš„ç›¸äº’ç«äº‰ã€‚</p>

<p>çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—çš„å®Œå…¨ä»£ç ,è¿™é‡Œå…¨éƒ¨å†™å‡ºæ¥ï¼Œæ³¨æ„çœ‹ä»£ç çš„æ³¨é‡Š</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">lock_free_queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span><span class="p">;</span>
    <span class="c1">//èŠ‚ç‚¹ä¹‹é—´çš„é“¾æ¥ç±»</span>

    <span class="k">struct</span> <span class="nc">counted_node_ptr</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">external_count</span><span class="p">;</span>
        <span class="n">node</span><span class="o">*</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1">//å¤´æŒ‡é’ˆ</span>
    
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">counted_node_ptr</span><span class="o">&gt;</span> <span class="n">head</span><span class="p">;</span>
    <span class="c1">//å°¾éƒ¨æŒ‡é’ˆ</span>

    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">counted_node_ptr</span><span class="o">&gt;</span> <span class="n">tail</span><span class="p">;</span>
    <span class="c1">//å¼•ç”¨è®¡æ•°å™¨</span>

    <span class="k">struct</span> <span class="nc">node_counter</span>
    <span class="p">{</span>
        <span class="c1">//å†…éƒ¨å¼•ç”¨è®¡æ•°,å¤§å°ä¸º30bit </span>

        <span class="kt">unsigned</span> <span class="n">internal_count</span><span class="o">:</span><span class="mi">30</span><span class="p">;</span>
        <span class="c1">//å¤–éƒ¨å¼•ç”¨è®¡æ•°,å¤§å°ä¸º2bit å³0-3</span>

        <span class="kt">unsigned</span> <span class="n">external_counters</span><span class="err">ï¼š</span><span class="mi">2</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="c1">//å®šä¹‰å…ƒç´ èŠ‚ç‚¹</span>

    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="c1">//åŸºæœ¬æ„é€ å‡½æ•°</span>
        <span class="n">node</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">node_counter</span> <span class="n">new_count</span><span class="p">;</span>
            <span class="n">new_count</span><span class="p">.</span><span class="n">internal_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
            <span class="c1">//å½“æ–°èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—ä¸­æ—¶,éƒ½ä¼šè¢«tailå’Œä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„nextæŒ‡é’ˆæ‰€æŒ‡å‘</span>

            <span class="n">new_count</span><span class="p">.</span><span class="n">external_counts</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
            <span class="c1">//å­˜å‚¨æ–°å€¼</span>

            <span class="n">count</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">new_count</span><span class="p">);</span>
            <span class="c1">//ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆä¸ºç©ºæŒ‡é’ˆ</span>

            <span class="n">next</span><span class="p">.</span><span class="n">ptr</span><span class="o">=</span><span class="nb">nullptr</span><span class="p">;</span>
            <span class="c1">//ä¸‹ä¸€ä¸ªæŒ‡é’ˆçš„å¤–éƒ¨å¼•ç”¨è®¡æ•°ä¸º0</span>

            <span class="n">next</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">//é‡Šæ”¾ä¸€ä¸ªèŠ‚ç‚¹å¼•ç”¨</span>

        <span class="kt">void</span> <span class="n">release_ref</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">//è·å–è®¡æ•°å™¨æŒ‡é’ˆ</span>

            <span class="n">node_counter</span> <span class="n">old_counter</span><span class="o">=</span><span class="n">count</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
            <span class="n">node_counter</span> <span class="n">new_counter</span><span class="p">;</span>
            <span class="k">do</span>
            <span class="p">{</span>
                <span class="c1">//å°†æ—§è®¡æ•°å™¨ï¼Œå­˜å…¥æ–°çš„ä¸´æ—¶å˜é‡ä¸­</span>

                <span class="n">new_counter</span><span class="o">=</span><span class="n">old_counter</span><span class="p">;</span>
                <span class="c1">//å¤–éƒ¨å¼•ç”¨è®¡æ•°--</span>

                <span class="o">--</span><span class="n">new_counter</span><span class="p">.</span><span class="n">internal_count</span><span class="p">;</span>
                <span class="c1">//å½“countä¸old_countç›¸åŒæ—¶ç»“æŸå¾ªç¯</span>

            <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
                <span class="n">old_counter</span><span class="p">,</span>
                <span class="n">new_counter</span><span class="p">,</span>
                <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">,</span>
                <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span>
                <span class="p">));</span>
            <span class="c1">//å½“å†…å¤–éƒ¨å¼•ç”¨éƒ½ä¸ºç©ºçš„æ—¶å€™ï¼Œåˆ é™¤æŒ‡é’ˆ</span>

            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">new_counter</span><span class="p">.</span><span class="n">internal_count</span><span class="o">&amp;&amp;</span>
                <span class="o">!</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_counters</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">delete</span> <span class="k">this</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span>

        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="c1">//èŠ‚ç‚¹è®¡æ•°å™¨ï¼Œè®°å½•å†…å¤–éƒ¨å¼•ç”¨æ¬¡æ•°</span>

        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">node_counter</span><span class="o">&gt;</span> <span class="n">count</span><span class="p">;</span>
        <span class="c1">//é“¾æ¥å…³ç³»ç±»ï¼ŒnextæŒ‡é’ˆ</span>

        <span class="n">counted_node_ptr</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="c1">//å¢åŠ ä¸€ä¸ªå¤–éƒ¨èŠ‚ç‚¹çš„å¼•ç”¨</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="n">increase_external_count</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">counted_node_ptr</span><span class="o">&gt;&amp;</span> <span class="n">counter</span><span class="p">,</span>
        <span class="n">counted_node_ptr</span><span class="o">&amp;</span> <span class="n">old_counter</span>
        <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//ä¸´æ—¶è®°å½•å˜é‡</span>

        <span class="n">counted_node_ptr</span> <span class="n">new_counter</span><span class="p">;</span>
        <span class="k">do</span>
        <span class="p">{</span>
            <span class="c1">//æš‚å­˜æ—§è®¡æ•°å™¨</span>

            <span class="n">new_counter</span><span class="o">=</span><span class="n">old_counter</span><span class="p">;</span>
            <span class="c1">//å¢åŠ å¤–éƒ¨å¼•ç”¨</span>

            <span class="o">++</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_count</span><span class="p">;</span>
            <span class="c1">//å½“counterå’Œold_counteræŒ‡å‘ç›¸åŒæ—¶ï¼Œè·³å‡ºå¾ªç¯</span>

        <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">counter</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
            <span class="n">old_counter</span><span class="p">,</span>
            <span class="n">new_counter</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span>
            <span class="p">));</span>
        <span class="c1">//è®¡ç®—ç»“æ„å­˜å…¥old_counterä¸­</span>

        <span class="n">old_counter</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_count</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//åˆ é™¤å¤–éƒ¨èŠ‚ç‚¹çš„å¼•ç”¨</span>

    <span class="k">static</span> <span class="kt">void</span> <span class="n">free_external_counter</span><span class="p">(</span><span class="n">counted_node_ptr</span><span class="o">&amp;</span> <span class="n">old_node_ptr</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//è·å–æ—§æŒ‡é’ˆçš„ä¸´æ—¶å˜é‡</span>

        <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">ptr</span><span class="o">=</span><span class="n">old_node_ptr</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="c1">//å’Œæ·»åŠ æ—¶ç›¸åï¼Œå‡å°‘ä¸¤ä¸ªå¤–éƒ¨å¼•ç”¨</span>

        <span class="kt">int</span> <span class="k">const</span> <span class="n">count_increase</span><span class="o">=</span><span class="n">old_node_ptr</span><span class="p">.</span><span class="n">external_count</span><span class="o">-</span><span class="mi">2</span><span class="p">;</span>
        <span class="c1">//è·å–è®¡æ•°å™¨</span>

        <span class="n">node_counter</span> <span class="n">old_counter</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="c1">//åˆ›å»ºæ–°è®¡æ•°å™¨</span>

        <span class="n">node_counter</span> <span class="n">new_counter</span><span class="p">;</span>

        <span class="k">do</span>
        <span class="p">{</span>
            <span class="n">new_counter</span><span class="o">=</span><span class="n">old_counter</span><span class="p">;</span>
            <span class="c1">//å¤–éƒ¨è®¡æ•°å™¨--</span>

            <span class="o">--</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_counters</span><span class="p">;</span>
            <span class="c1">//æ‹·è´å¼•ç”¨æ•°ç›®</span>

            <span class="n">new_counter</span><span class="p">.</span><span class="n">internal_count</span><span class="o">+=</span><span class="n">count_increase</span><span class="p">;</span>
        <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
            <span class="n">old_counter</span><span class="p">,</span>
            <span class="n">new_counter</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">,</span>
            <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span>
            <span class="p">));</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">new_counter</span><span class="p">.</span><span class="n">internal_count</span><span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">new_counter</span><span class="p">.</span><span class="n">external_counters</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">delete</span> <span class="n">ptr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="n">lock_free_queue</span><span class="p">();</span>
    <span class="o">~</span><span class="n">lock_free_queue</span><span class="p">();</span>
    <span class="c1">//æ·»åŠ æ–°å…ƒç´ å‡½æ•°</span>

    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//åˆ›å»ºæ™ºèƒ½æŒ‡é’ˆ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">new_data</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">(</span><span class="n">new_value</span><span class="p">));</span>
        <span class="c1">//ä¸‹ä¸€ä¸ªæŒ‡å‘é“¾æ¥</span>

        <span class="n">counted_node_ptr</span> <span class="n">new_next</span><span class="p">;</span>
        <span class="n">new_next</span><span class="p">.</span><span class="n">ptr</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">;</span>
        <span class="n">new_next</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="c1">//æš‚å­˜æ—§çš„å°¾éƒ¨æŒ‡é’ˆ</span>

        <span class="n">counted_node_ptr</span> <span class="n">old_tail</span><span class="o">=</span><span class="n">tail</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="c1">//å¢åŠ ç°æœ‰æŒ‡é’ˆå’Œå°¾éƒ¨æŒ‡é’ˆçš„å¤–éƒ¨å¼•ç”¨è®¡æ•°</span>

            <span class="n">increase_external_count</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span><span class="n">old_tail</span><span class="p">);</span>
            <span class="n">T</span><span class="o">*</span> <span class="n">old_data</span><span class="o">=</span><span class="nb">nullptr</span><span class="p">;</span>
            <span class="c1">//å°†å°¾éƒ¨æŒ‡é’ˆçš„æ•°æ®æ›´æ¢ä¸ºæ–°æ•°æ®ï¼Œå°†tailæŒ‡é’ˆæŒ‡å‘æ–°å°¾éƒ¨</span>

            <span class="k">if</span><span class="p">(</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
                <span class="n">old_data</span><span class="p">,</span>
                <span class="n">new_data</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
                <span class="p">))</span>
                <span class="c1">//å½“old_data=old_tail.ptr-&gt;dataæ—¶æˆç«‹</span>

            <span class="p">{</span>
                <span class="c1">//æ›´æ–°å°¾æŒ‡é’ˆæŒ‡å‘</span>

                <span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">=</span><span class="n">new_next</span><span class="p">;</span>
                <span class="c1">//å°†æ—§æŒ‡é’ˆç§»åŠ¨åˆ°old_tail</span>

                <span class="n">old_tail</span><span class="o">=</span><span class="n">tail</span><span class="p">.</span><span class="n">exchange</span><span class="p">(</span><span class="n">new_next</span><span class="p">);</span>
                <span class="c1">//é‡Šæ”¾å¤–éƒ¨è®¡æ•°æŒ‡é’ˆ</span>

                <span class="n">free_external_counter</span><span class="p">(</span><span class="n">old_tail</span><span class="p">);</span>
                <span class="c1">//é‡Šæ”¾æŒ‡é’ˆæ‰€æœ‰æƒ</span>

                <span class="n">new_data</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
                <span class="c1">//è·³å‡ºå¾ªç¯</span>

                <span class="k">break</span><span class="p">;</span>

            <span class="p">}</span>
            <span class="c1">//é‡Šæ”¾æŒ‡é’ˆæ‰€æœ‰æƒ</span>

            <span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">release_ref</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//å‡ºé˜Ÿåˆ—ç›¸å…³å‡½æ•°</span>

    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pop</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">//åŠ è½½å¤´èŠ‚ç‚¹</span>

        <span class="n">counted_node_ptr</span> <span class="n">old_head</span><span class="o">=</span><span class="n">head</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="c1">//å¢åŠ å¤–éƒ¨è®¡æ•°å™¨</span>

            <span class="n">increase_external_count</span><span class="p">(</span><span class="n">head</span><span class="p">,</span><span class="n">old_head</span><span class="p">);</span>
            <span class="c1">//è·å–ä¸´æ—¶å¤´èŠ‚ç‚¹ä¸­çš„nodeæŒ‡é’ˆ</span>

            <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">ptr</span><span class="o">=</span><span class="n">old_head</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
            <span class="c1">//é¦–å°¾èŠ‚ç‚¹æŒ‡å‘ä¸€å¤„ï¼Œå³é˜Ÿåˆ—ä¸ºç©º</span>

            <span class="k">if</span><span class="p">(</span><span class="n">ptr</span><span class="o">==</span><span class="n">tail</span><span class="p">.</span><span class="n">load</span><span class="p">().</span><span class="n">ptr</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">release_ref</span><span class="p">();</span>
                <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="c1">//å°†headæŒ‡é’ˆï¼ŒæŒ‡å‘old_headæ—§æŒ‡é’ˆæŒ‡å‘çš„èŠ‚ç‚¹</span>

            <span class="k">if</span><span class="p">(</span><span class="n">head</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">old_head</span><span class="p">,</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">//è·å–å·¦å€¼</span>

                <span class="n">T</span><span class="o">*</span> <span class="k">const</span> <span class="n">res</span><span class="o">=</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">exchange</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">);</span>
                <span class="c1">//é‡Šæ”¾å¤–éƒ¨å¼•ç”¨è®¡æ•°</span>

                <span class="n">free_external_counter</span><span class="p">(</span><span class="n">old_head</span><span class="p">);</span>
                <span class="c1">//è¿”å›è·å–çš„æŒ‡é’ˆ</span>

                <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="c1">//é‡Šæ”¾æ—§èŠ‚ç‚¹</span>

            <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">release_ref</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h5 id="æ— é”é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹é—´äº’åŠ©">æ— é”é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹é—´äº’åŠ©</h5>

<p>é€šè¿‡åœ¨nodeèŠ‚ç‚¹ä¸­è®¾ç½®nextæŒ‡é’ˆå¯ä»¥åœ¨pop()å‡½æ•°ä¸­é€šè¿‡å¯¹<code class="language-plaintext highlighter-rouge">next</code>æŒ‡é’ˆçš„è¯»å–æ–¹ä¾¿å¿«é€Ÿçš„ä½¿ç”¨compare_exchange_strong,è¿›è¡Œå¤´æŒ‡é’ˆç§»åŠ¨ï¼›å¯¹äºpushçš„å®ç°ç¨å¾®å¤æ‚ä¸€ç‚¹</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span>   <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">lock_free_queue</span>
<span class="p">{</span>
<span class="nl">private:</span>
    <span class="k">struct</span> <span class="nc">node</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span> <span class="n">data</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">node_counter</span><span class="o">&gt;</span> <span class="n">count</span><span class="p">;</span>
        <span class="c1">//ä¸‹ä¸€ä¸ªæŒ‡é’ˆ</span>

        <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">counted_node_ptr</span><span class="o">&gt;</span> <span class="n">next</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="n">set_new_tail</span><span class="p">(</span>
    <span class="n">counted_node_ptr</span> <span class="o">&amp;</span><span class="n">old_tail</span><span class="p">,</span>
    <span class="n">counted_node_ptr</span> <span class="k">const</span> <span class="o">&amp;</span><span class="n">new_tail</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//è·å–æ—§å°¾æŒ‡é’ˆ</span>

        <span class="n">node</span><span class="o">*</span> <span class="k">const</span> <span class="n">current_tail_ptr</span><span class="o">=</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">tail</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">old_tail</span><span class="p">,</span><span class="n">new_tail</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">==</span><span class="n">current_tail_ptr</span><span class="p">);</span>
        <span class="c1">//å½“å‰å°¾éƒ¨æŒ‡é’ˆä¸æ—§æŒ‡é’ˆç›¸åŒ</span>

        <span class="k">if</span><span class="p">(</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">==</span><span class="n">current_tail_ptr</span><span class="p">)</span>
            <span class="c1">//é‡Šæ”¾å¤–éƒ¨è®¡æ•°</span>

            <span class="n">free_external_counter</span><span class="p">(</span><span class="n">old_tail</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="c1">//å¦åˆ™é‡Šæ”¾å½“å‰æŒ‡é’ˆ</span>

            <span class="n">current_tail_ptr</span><span class="o">-&gt;</span><span class="n">release_ref</span><span class="p">();</span>
    <span class="p">}</span>
<span class="nl">public:</span>
    <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">T</span> <span class="n">new_value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//æ–°æ•°æ®</span>

        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">new_data</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">(</span><span class="n">new_value</span><span class="p">));</span>
        <span class="c1">//æ–°èŠ‚ç‚¹</span>

        <span class="n">counted_node_ptr</span> <span class="n">new_next</span><span class="p">;</span>
        <span class="n">new_next</span><span class="p">.</span><span class="n">ptr</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">;</span>
        <span class="c1">//å¤–éƒ¨å¼•ç”¨è®¾ç½®ä¸º1</span>

        <span class="n">new_next</span><span class="p">.</span><span class="n">external_count</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">counted_node_ptr</span> <span class="n">old_tail</span><span class="o">=</span><span class="n">tail</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(;;)</span>
        <span class="p">{</span>
            <span class="c1">//å¢åŠ å¤–éƒ¨å¼•ç”¨</span>

            <span class="n">increase_external_count</span><span class="p">(</span><span class="n">tail</span><span class="p">,</span><span class="n">old_tail</span><span class="p">);</span>
            <span class="c1">//è·å–æ—§æ•°æ®</span>

            <span class="n">T</span><span class="o">*</span> <span class="n">old_data</span><span class="o">=</span><span class="nb">nullptr</span><span class="p">;</span>
            <span class="c1">//æ—§å°¾æŒ‡é’ˆæ•°æ®ä¸old_dataç›¸åŒ</span>

            <span class="k">if</span><span class="p">(</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
                                    <span class="n">old_data</span><span class="p">,</span>
                                    <span class="n">new_data</span><span class="p">.</span><span class="n">get</span><span class="p">()</span>
                                    <span class="p">))</span>
            <span class="p">{</span>
                <span class="c1">//åˆå§‹åŒ–nextæŒ‡é’ˆï¼Œå‡†å¤‡äº¤æ¢æ•°æ®</span>
                <span class="n">counted_node_ptr</span> <span class="n">old_next</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
                <span class="c1">//å½“å°¾æŒ‡é’ˆæŒ‡å‘æ–°èŠ‚ç‚¹æ—¶</span>

                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
                                            <span class="n">old_next</span><span class="p">,</span>
                                            <span class="n">new_next</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">{</span>

                    <span class="c1">//åˆ é™¤æ–°èŠ‚ç‚¹</span>

                    <span class="k">delete</span> <span class="n">new_next</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
                    <span class="c1">//æ–°nextæŒ‡é’ˆæŒ‡å‘åŸæŒ‡é’ˆæŒ‡å‘</span>

                    <span class="n">new_next</span><span class="o">=</span><span class="n">old_next</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">set_new_tail</span><span class="p">(</span><span class="n">old_tail</span><span class="p">,</span><span class="n">new_next</span><span class="p">);</span>
                <span class="n">new_data</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="c1">//åˆå§‹åŒ–æ–°çš„å°¾æŒ‡é’ˆ</span>
                <span class="n">counted_node_ptr</span> <span class="n">old_next</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
                <span class="c1">//å¦‚æœæ—§å°¾æŒ‡é’ˆnextæŒ‡å‘ä¸ºold_next,å°†nextæŒ‡é’ˆæŒ‡å‘æ–°next</span>

                <span class="k">if</span><span class="p">(</span><span class="n">old_tail</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span>
                                            <span class="n">old_next</span><span class="p">,</span><span class="n">new_next</span><span class="p">))</span>
                <span class="p">{</span>
                        <span class="n">old_next</span><span class="o">=</span><span class="n">new_next</span><span class="p">;</span>
                        <span class="n">new_next</span><span class="p">.</span><span class="n">ptr</span><span class="o">=</span><span class="k">new</span> <span class="n">node</span><span class="p">;</span>
                <span class="p">}</span>
                    <span class="n">set_new_tail</span><span class="p">(</span><span class="n">old_tail</span><span class="p">,</span><span class="n">old_next</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>

</code></pre></div></div>

<h3 id="73-å¯¹äºè®¾è®¡æ— é”æ•°æ®ç»“æ„çš„æŒ‡å¯¼å»ºè®®">7.3 å¯¹äºè®¾è®¡æ— é”æ•°æ®ç»“æ„çš„æŒ‡å¯¼å»ºè®®</h3>

<p><em>å‚è€ƒé“¾æ¥ï¼š</em> <a href="https://blog.csdn.net/weixin_36145588/article/details/78873917">c++11 å†…å­˜æ¨¡å‹è§£è¯»</a></p>

<p><img src="http://images2015.cnblogs.com/blog/416650/201704/416650-20170406205142128-2029792592.png" alt="å‡ ç§å†…å­˜æ¨¡å‹å›é¡¾" /></p>

<p>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬æŠŠatomicæˆå‘˜å‡½æ•°å¯ä½¿ç”¨memory_orderå€¼åˆ†ä¸ºä»¥ä¸‹3ç»„:</p>

<ul>
  <li>åŸå­å­˜å‚¨æ“ä½œ(store)å¯ä½¿ç”¨:memory_order_relaxedã€memory_order_releaseã€memory_order_seq_cst</li>
  <li>åŸå­è¯»å–æ“ä½œ(load)å¯ä½¿ç”¨:memory_order_relaxedã€memory_order_consumeã€memory_order_acquireã€memory_order_seq_cst</li>
  <li>RMWæ“ä½œ(read-modify-write)å³åŒæ—¶è¯»å†™çš„æ“ä½œ,å¦‚atomic_flag.test_and_set()æ“ä½œ,atomic.atomic_compare_exchange()ç­‰éƒ½æ˜¯éœ€è¦åŒæ—¶è¯»å†™çš„ã€‚å¯ä½¿ç”¨:memory_order_relaxedã€memory_order_consumeã€memory_order_acquireã€memory_order_releaseã€memory_order_acq_relã€memory_order_seq_cst</li>
</ul>

<p>æ ¹æ®memory_orderä½¿ç”¨æƒ…å†µ,æˆ‘ä»¬å¯ä»¥å°†å…¶ä¸º 3 ç±»:</p>

<ul>
  <li>é¡ºåºä¸€è‡´æ€§æ¨¡å‹:std::memory_order_seq_cst;æœ€ç¨³å®šï¼Œä»£ä»·æœ€é«˜ï¼›åŸå­æ“ä½œé»˜è®¤çš„æ¨¡å‹,åœ¨C++11ä¸­çš„åŸå­ç±»å‹çš„å˜é‡åœ¨çº¿ç¨‹ä¸­æ€»æ˜¯ä¿æŒç€é¡ºåºæ‰§è¡Œçš„ç‰¹æ€§ã€‚</li>
  <li>Acquire-Release æ¨¡å‹:std::memory_order_consume, std::memory_order_acquire, std::memory_order_release, std::memory_order_acq_relï¼›è‹¥çº¿ç¨‹Aä¸­çš„ä¸€ä¸ªåŸå­storeå¸¦memory_order_releaseæ ‡ç­¾ï¼Œè€Œçº¿ç¨‹Bä¸­æ¥è‡ªåŒä¸€å˜é‡çš„åŸå­loadå¸¦memory_order_acquireæ ‡ç­¾ï¼Œä»çº¿ç¨‹Açš„è§†è§’å‘ç”Ÿå…ˆäºåŸå­storeçš„æ‰€æœ‰å†…å­˜å†™å…¥(non-atomic and relaxed atomic)ï¼Œåœ¨çº¿ç¨‹Bä¸­æˆä¸ºå¯è§å‰¯ä½œç”¨ï¼Œä¸€æ—¦çº¿ç¨‹Bä¸­çš„åŸå­åŠ è½½å®Œæˆï¼Œåˆ™ä¿è¯çº¿ç¨‹Bèƒ½è§‚å¯Ÿåˆ°çº¿ç¨‹Aå†™å…¥å†…å­˜çš„æ‰€æœ‰å†…å®¹ã€‚</li>
</ul>

<p>æ³¨æ„ï¼šåŒæ­¥ä»…å»ºç«‹åœ¨releaseå’ŒacquireåŒä¸€åŸå­å¯¹è±¡çš„çº¿ç¨‹ä¹‹é—´ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½çœ‹åˆ°ä¸è¢«åŒæ­¥çº¿ç¨‹çš„ä¸€è€…æˆ–ä¸¤è€…ç›¸å¼‚çš„å†…å­˜è®¿é—®é¡ºåºã€‚</p>

<ul>
  <li>Relax æ¨¡å‹:std::memory_order_relaxedï¼›æœ€ä¸ç¨³å®šï¼Œä»£ä»·æœ€ä½</li>
</ul>

<h4 id="731-ä½¿ç”¨stdmemory_order_seq_cstçš„åŸå‹">7.3.1 ä½¿ç”¨<code class="language-plaintext highlighter-rouge">std::memory_order_seq_cst</code>çš„åŸå‹</h4>

<p>std::memory_order_seq_cstæ¯”èµ·å…¶ä»–å†…å­˜åºè¦ç®€å•çš„å¤šï¼Œå› ä¸ºæ‰€æœ‰æ“ä½œéƒ½å°†å…¶ä½œä¸ºæ€»åºã€‚æœ¬ç« çš„æ‰€æœ‰ä¾‹å­,éƒ½æ˜¯ä»std::memory_order_seq_cstå¼€å§‹,åªæœ‰å½“åŸºæœ¬æ“ä½œæ­£å¸¸å·¥ä½œçš„æ—¶å€™,æ‰æ”¾å®½å†…å­˜åºçš„é€‰æ‹©ã€‚</p>

<h4 id="732-å¯¹æ— é”å†…å­˜çš„å›æ”¶ç­–ç•¥">7.3.2 å¯¹æ— é”å†…å­˜çš„å›æ”¶ç­–ç•¥</h4>

<p>å½“æœ‰å…¶ä»–çº¿ç¨‹å¯¹èŠ‚ç‚¹è¿›è¡Œè®¿é—®çš„æ—¶å€™,èŠ‚ç‚¹æ— æ³•è¢«ä»»ä¸€çº¿ç¨‹åˆ é™¤;ä¸ºé¿å…è¿‡å¤šçš„å†…å­˜ä½¿ç”¨,è¿˜æ˜¯å¸Œæœ›è¿™ä¸ªèŠ‚ç‚¹åœ¨èƒ½åˆ é™¤çš„æ—¶å€™å°½å¿«åˆ é™¤ã€‚æœ¬ç« ä¸­ä»‹ç»äº†ä¸‰ç§æŠ€æœ¯æ¥ä¿è¯å†…å­˜å¯ä»¥è¢«å®‰å…¨çš„å›æ”¶:</p>

<ul>
  <li>ç­‰å¾…æ— çº¿ç¨‹å¯¹æ•°æ®ç»“æ„è¿›è¡Œè®¿é—®æ—¶,åˆ é™¤æ‰€æœ‰ç­‰å¾…åˆ é™¤çš„å¯¹è±¡ã€‚</li>
  <li>ä½¿ç”¨é£é™©æŒ‡é’ˆæ¥æ ‡è¯†æ­£åœ¨è¢«çº¿ç¨‹è®¿é—®çš„å¯¹è±¡ã€‚</li>
  <li>å¯¹å¯¹è±¡è¿›è¡Œå¼•ç”¨è®¡æ•°,å½“æ²¡æœ‰çº¿ç¨‹å¯¹å¯¹è±¡è¿›è¡Œå¼•ç”¨æ—¶,å°†å…¶åˆ é™¤ã€‚</li>
</ul>

<h4 id="733--æŒ‡å¯¼å»ºè®®å°å¿ƒabaé—®é¢˜">7.3.3  æŒ‡å¯¼å»ºè®®:å°å¿ƒABAé—®é¢˜</h4>

<p>åœ¨â€œåŸºäºæ¯”è¾ƒ/äº¤æ¢â€çš„ç®—æ³•ä¸­è¦æ ¼å¤–å°å¿ƒâ€œABAé—®é¢˜â€ã€‚å…¶æµç¨‹æ˜¯:</p>

<ol>
  <li>çº¿ç¨‹1è¯»å–åŸå­å˜é‡x,å¹¶ä¸”å‘ç°å…¶å€¼æ˜¯Aã€‚</li>
  <li>çº¿ç¨‹1å¯¹è¿™ä¸ªå€¼è¿›è¡Œä¸€äº›æ“ä½œ,æ¯”å¦‚,è§£å¼•ç”¨(å½“å…¶æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„æ—¶å€™),æˆ–åšæŸ¥è¯¢,æˆ–å…¶ä»–æ“ä½œã€‚</li>
  <li>æ“ä½œç³»ç»Ÿå°†çº¿ç¨‹1æŒ‚èµ·ã€‚</li>
  <li>å…¶ä»–çº¿ç¨‹å¯¹xæ‰§è¡Œä¸€äº›æ“ä½œ,å¹¶ä¸”å°†å…¶å€¼æ”¹ä¸ºBã€‚</li>
  <li>å¦ä¸€ä¸ªçº¿ç¨‹å¯¹Aç›¸å…³çš„æ•°æ®è¿›è¡Œä¿®æ”¹(çº¿ç¨‹1æŒæœ‰),è®©å…¶ä¸å†åˆæ³•ã€‚å¯èƒ½ä¼šåœ¨é‡Šæ”¾æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜æ—¶,ä»£ç äº§ç”Ÿå‰§çƒˆçš„ååº”(å¤§é—®é¢˜);æˆ–è€…åªæ˜¯ä¿®æ”¹äº†ç›¸å…³å€¼è€Œå·²(å°é—®é¢˜)ã€‚</li>
  <li>å†æ¥ä¸€ä¸ªçº¿ç¨‹å°†xçš„å€¼æ”¹å›ä¸ºAã€‚å¦‚æœAæ˜¯ä¸€ä¸ªæŒ‡é’ˆ,é‚£ä¹ˆå…¶å¯èƒ½æŒ‡å‘ä¸€ä¸ªæ–°çš„å¯¹è±¡,åªæ˜¯ä¸æ—§å¯¹è±¡å…±äº«åŒä¸€ä¸ªåœ°å€è€Œå·²ã€‚</li>
  <li>çº¿ç¨‹1ç»§ç»­è¿è¡Œ,å¹¶ä¸”å¯¹xæ‰§è¡Œâ€œæ¯”è¾ƒ/äº¤æ¢â€æ“ä½œ,å°†Aè¿›è¡Œå¯¹æ¯”ã€‚è¿™é‡Œ,â€œæ¯”è¾ƒ/äº¤æ¢â€æˆåŠŸ
(å› ä¸ºå…¶å€¼è¿˜æ˜¯A),ä¸è¿‡è¿™æ˜¯ä¸€ä¸ªé”™è¯¯çš„A(the wrong A value)ã€‚ä»ç¬¬2æ­¥ä¸­è¯»å–çš„æ•°æ®ä¸å†åˆæ³•,ä½†æ˜¯çº¿ç¨‹1æ— æ³•è¨€æ˜è¿™ä¸ªé—®é¢˜,å¹¶ä¸”ä¹‹åçš„æ“ä½œå°†ä¼šæŸåæ•°æ®ç»“æ„ã€‚</li>
</ol>

<p>è§£å†³æ–¹æ¡ˆï¼šè§£å†³è¿™ä¸ªé—®é¢˜çš„ä¸€èˆ¬æ–¹æ³•æ˜¯,è®©å˜é‡xä¸­åŒ…å«ä¸€ä¸ªABAè®¡æ•°å™¨ã€‚â€œæ¯”è¾ƒ/äº¤æ¢â€ä¼šå¯¹åŠ å…¥è®¡æ•°å™¨çš„xè¿›è¡Œæ“ä½œã€‚æ¯æ¬¡çš„å€¼éƒ½ä¸ä¸€æ ·,è®¡æ•°éšä¹‹å¢é•¿,æ‰€ä»¥åœ¨xè¿˜æ˜¯åŸå€¼çš„å‰æä¸‹,å³ä½¿æœ‰çº¿ç¨‹å¯¹xè¿›è¡Œä¿®æ”¹,â€œæ¯”è¾ƒ/äº¤æ¢â€è¿˜æ˜¯ä¼šå¤±è´¥ã€‚</p>

<h4 id="734--æŒ‡å¯¼å»ºè®®è¯†åˆ«å¿™ç­‰å¾…å¾ªç¯å’Œå¸®åŠ©å…¶ä»–çº¿ç¨‹">7.3.4  æŒ‡å¯¼å»ºè®®:è¯†åˆ«å¿™ç­‰å¾…å¾ªç¯å’Œå¸®åŠ©å…¶ä»–çº¿ç¨‹</h4>

<p>åœ¨æœ€ç»ˆé˜Ÿåˆ—çš„ä¾‹å­ä¸­,å·²ç»è§è¯†åˆ°çº¿ç¨‹åœ¨æ‰§è¡Œpushæ“ä½œæ—¶,å¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªpushæ“ä½œæµç¨‹çš„å®Œæˆã€‚ç­‰å¾…çº¿ç¨‹å°±ä¼šè¢«å­¤ç«‹,å°†ä¼šé™·å…¥åˆ°å¿™ç­‰å¾…å¾ªç¯ä¸­,å½“çº¿ç¨‹å°è¯•å¤±è´¥çš„æ—¶å€™,ä¼šç»§ç»­å¾ªç¯,è¿™æ ·å°±ä¼šæµªè´¹CPUçš„è®¡ç®—å‘¨æœŸã€‚å½“å¿™ç­‰å¾…å¾ªç¯ç»“æŸæ—¶,å°±åƒä¸€ä¸ªé˜»å¡æ“ä½œè§£é™¤,å’Œä½¿ç”¨äº’æ–¥é”çš„è¡Œä¸ºä¸€æ ·ã€‚é€šè¿‡å¯¹ç®—æ³•çš„ä¿®æ”¹,å½“ä¹‹å‰çš„çº¿ç¨‹è¿˜æ²¡æœ‰å®Œæˆæ“ä½œå‰,è®©ç­‰å¾…çº¿ç¨‹æ‰§è¡Œæœªå®Œæˆçš„æ­¥éª¤,å°±èƒ½è®©å¿™ç­‰å¾…çš„çº¿ç¨‹ä¸å†è¢«é˜»å¡(<strong>å‡å°é”çš„ç²’åº¦</strong>)ã€‚åœ¨é˜Ÿåˆ—ä¾‹ä¸­,éœ€è¦å°†ä¸€ä¸ªæ•°æ®æˆå‘˜è½¬æ¢ä¸ºä¸€ä¸ªåŸå­å˜é‡,è€Œä¸æ˜¯ä½¿ç”¨éåŸå­å˜é‡å’Œä½¿ç”¨â€œæ¯”è¾ƒ/äº¤æ¢â€æ“ä½œæ¥åšè¿™ä»¶äº‹;è¦æ˜¯åœ¨æ›´åŠ å¤æ‚çš„æ•°æ®ç»“æ„ä¸­,è¿™å°†éœ€è¦æ›´åŠ å¤šçš„å˜åŒ–æ¥æ»¡è¶³éœ€æ±‚ã€‚</p>

:ET